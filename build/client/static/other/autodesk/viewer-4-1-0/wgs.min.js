var WGS=function(e,t){"use strict";function n(e,t){return t={exports:{}},e(t,t.exports),t.exports}function r(e){return isFinite(e=+e)&&0!=e?e<0?-r(-e):Math.log(e+Math.sqrt(e*e+1)):e}function a(e,t,n,r){var a=n?"_v3":"",i=n?"vec3 ":"",o=n?t+" = average("+t+a+");":"",s=r?t+a+" = SRGBToLinear("+t+a+");":"";return["#if defined( USE_"+e.toUpperCase()+"_MAP )","vec2 uv_"+e+"_map = ("+e+"_map_texMatrix * vec3(uv, 1.0)).xy;",e.toUpperCase()+"_CLAMP_TEST;",i+t+a+" = texture2D("+e+"_map, uv_"+e+"_map).xyz;",s,"if("+e+"_map_invert) "+t+a+" = vec3(1.0) - "+t+a+";",o,"#else",t+" = "+e+";","#endif"].join("\n")}function i(e){var t=e+"_texMatrix",n=e+"_invert";return["#if defined( "+("USE_"+e).toUpperCase()+" )","uniform sampler2D "+e+";","uniform mat3 "+t+";","uniform bool "+n+";","#endif"].join("\n")}function o(e,t){function n(e,t){var n=0|e.x*s,r=0|e.y*s,i=0|e.z*s,o=a[n];o||(a[n]=o={});var l=o[r];l||(o[r]=l={});var u=l[i];return void 0===u&&(l[i]=u=t),u}var r=[],a={},i=1;if(e.boundingBox||t){var o=(new Ou).copy(e.boundingBox||t).size();i=Math.max(o.x,Math.max(o.y,o.z))}var s=65536/i;return Hu(e,function(e,t){var a=n(e,t);r[t]=a}),r}function s(e,t){var n=new Float32Array(3*Gu(e));return Hu(e,function(e,t){n[3*t]=e.x,n[3*t+1]=e.y,n[3*t+2]=e.z},t),n}function l(){Uu||(Uu=new t.Matrix4,Fu=new t.Ray,Vu=new t.Vector3,Bu=new t.Vector3,zu=new t.Vector3)}function u(e,n,r){l();var a=e.geometry;if(a){var i=e.material,o=i?i.side:t.FrontSide;Uu.getInverse(e.matrixWorld),Fu.copy(n.ray).applyMatrix4(Uu);var s,u,f=n.precision;Du.enumMeshTriangles(a,function(a,i,l,d,c,p){null!==(s=o===t.BackSide?Fu.intersectTriangle(l,i,a,!0):Fu.intersectTriangle(a,i,l,o!==t.DoubleSide))&&(s.applyMatrix4(e.matrixWorld),(u=n.ray.origin.distanceTo(s))<f||u<n.near||u>n.far||r.push({distance:u,point:s,face:new t.Face3(d,c,p,t.Triangle.normal(a,i,l)),faceIndex:null,fragId:e.fragId,dbId:e.dbId}))})}}function f(e,n,r){l();var a=e.geometry;if(a){var i=n.linePrecision;e.isWideLine&&e.geometry.lineWidth&&(i=e.geometry.lineWidth);var o=i*i;Uu.getInverse(e.matrixWorld),Fu.copy(n.ray).applyMatrix4(Uu);var s=new t.Vector3,u=new t.Vector3;a instanceof t.BufferGeometry&&Du.enumMeshLines(a,function(t,a){var i;Fu.distanceSqToSegment(t,a,u,s),s.applyMatrix4(e.matrixWorld),u.applyMatrix4(e.matrixWorld),s.distanceToSquared(u)>o||(i=n.ray.origin.distanceTo(s))<n.near||i>n.far||r.push({distance:i,point:s,face:null,faceIndex:null,fragId:e.fragId,dbId:e.dbId})})}}function d(e,n,r){l();var a=e.geometry;if(a){Uu.getInverse(e.matrixWorld),Fu.copy(n.ray).applyMatrix4(Uu);var i=n.precision,o=n.params.PointCloud.threshold;o||(o=1),o*=Math.max(3,a.pointSize),o/=4,a instanceof t.BufferGeometry&&Du.enumMeshVertices(a,function(t){if(!(Fu.distanceToPoint(t)>o)){var a=Fu.closestPointToPoint(t);if(null!==a){a.applyMatrix4(e.matrixWorld);var s=n.ray.origin.distanceTo(a);s<i||s<n.near||s>n.far||r.push({distance:s,point:t,face:null,faceIndex:null,fragId:e.fragId,dbId:e.dbId})}}})}}function c(e,t,n){e.isLine||e.isWideLine?f(e,t,n):e.isPoint?d(e,t,n):u(e,t,n)}function p(e,n,r,a){if(e instanceof t.Mesh?c(e,n,r):e.raycast(n,r),!0===a)for(var i=e.children,o=0,s=i.length;o<s;o++)p(i[o],n,r,!0)}function h(e,t,n){this.geoms=[null],this.numGeomsInMemory=0,this.geomMemory=0,this.gpuMeshMemory=0,this.gpuNumMeshes=0,this.geomPolyCount=0,this.instancePolyCount=0,this.is2d=t,this.geomBoxes=new Float32Array(6*Math.max(1,e+1)),this.disableStreaming=!!n}function m(){Ku||(Ku=new t.Box3)}function _(e,n,r,a){this.frags=e,this.indices=n,this.start=r,this.count=a,this.lastItem=r,this.overrideMaterial=null,this.sortDone=!1,this.numAdded=0,this.avgFrameTime=void 0,this.nodeIndex=void 0,this.boundingBox=new t.Box3,this.boundingBoxHidden=new t.Box3,this.sortObjects=!1,this.sortDone=!1,this.sortByShaderDone=!1,this.depths=null,this.indicesView=null,this.frustumCulled=!0,this.forceVisible=!1,this.renderImmediate=!e.useThreeMesh,this.renderImportance=0,m()}function v(e,t,n,r){var a=!1;return n.getWorldBounds(r,Ku),e&&!t.intersectsBox(Ku)&&(a=!0),a}function g(e,n,r){var a;if(n.array)a=new t.BufferAttribute(n.array,n.itemSize);else{var i=e+"|"+n.bytesPerItem+"|"+n.normalize+"|"+n.isPattern+"|"+n.divisor+"|"+n.offset;if(a=$u[i])return a;a=new t.BufferAttribute(void 0,n.itemSize),$u[i]=a}return a.bytesPerItem=n.bytesPerItem,a.normalize=n.normalize,a.isPattern=n.isPattern,r&&(a.divisor=n.divisor),n.array||(n.hasOwnProperty("offset")?a.itemOffset=n.offset:t.warn("VB attribute is neither interleaved nor separate. Something is wrong with the buffer specificaiton.")),a}function y(e){var t="";for(var n in e.attributes)t+=n+"|";var r=ef[t];return r||(r=Object.keys(e.attributes),ef[t]=r,r)}function x(){(Zu=new t.BufferAttribute(void 0,1)).bytesPerItem=2,(Qu=new t.BufferAttribute(void 0,1)).bytesPerItem=4,(Ju=function(){this.uuid=null,this.name=null,this.id=tf++,this.attributes={},this.attributesKeys=[],this.drawcalls=[],this.offsets=this.drawcalls,this.boundingBox=null,this.boundingSphere=null,this.numInstances=void 0,this.streamingDraw=!1,this.streamingIndex=!1,this.svfid=void 0,this.vb=null,this.vbbuffer=void 0,this.ib=null,this.ibbuffer=void 0,this.iblines=null,this.iblinesbuffer=void 0,this.vaos=void 0,this.vbNeedsUpdate=!1,this.vbstride=0,this.byteSize=0,this.attributesKeys=void 0,this.__webglInit=void 0}).prototype=Object.create(t.BufferGeometry.prototype),Ju.prototype.constructor=Ju}function b(){return Ju||x(),new Ju}function w(n){var r=n.mesh,a=b();Jl()&&(a.packId=n.packId,a.meshIndex=n.meshIndex),a.byteSize=0,a.vb=r.vb,a.vbbuffer=void 0,a.vbNeedsUpdate=!0,a.byteSize+=r.vb.byteLength,a.hash=n.hash,a.vbstride=r.vbstride,r.isLines&&(a.isLines=r.isLines),r.isWideLines&&(a.isWideLines=!0,a.lineWidth=r.lineWidth),r.isPoints&&(a.isPoints=r.isPoints,a.pointSize=r.pointSize),n.is2d&&(a.is2d=!0),a.numInstances=r.numInstances;for(var i in r.vblayout){var o=r.vblayout[i];a.attributes[i]=g(i,o,a.numInstances)}if(e.memoryOptimizedLoading)a.attributes.index=r.indices instanceof Uint32Array?Qu:Zu,a.ib=r.indices,a.ibbuffer=void 0,r.iblines&&(a.attributes.indexlines=r.iblines instanceof Uint32Array?Qu:Zu,a.iblines=r.iblines,a.iblinesbuffer=void 0);else{var s=new t.BufferAttribute(r.indices,1);s.bytesPerItem=r.indices instanceof Uint32Array?4:2,a.addAttribute("index",s)}a.attributesKeys=y(a),a.byteSize+=r.indices.byteLength,a.boundingBox=(new t.Box3).copy(r.boundingBox),a.boundingSphere=(new t.Sphere).copy(r.boundingSphere),a.drawcalls=null,a.offsets=null,n.geometry=a,n.mesh=null}function M(){return rf++}function S(){this.vb=null,this.vbstride=0,this.posOffset=0,this.normalOffset=0,this.matrices=null,this.ranges=null,this.dbIds=null,this.id=M()}function T(e){e.x=.5*(1+Math.atan2(e.y,e.x)/Math.PI),e.y=.5*(1+e.z),e.z=0}function A(e){var t=2*e.x-1,n=2*e.y-1,r=Math.sin(t*Math.PI),a=Math.cos(t*Math.PI),i=Math.sqrt(1-n*n),o=n;e.x=a*i,e.y=r*i,e.z=o}function E(e,t,n){t[n++]=255&e,t[n++]=e>>8&255,t[n++]=e>>16&255,t[n]=0}function R(e,t){return t.copy(e),t[12]=0,t[13]=0,t[14]=0,t.getInverse(t).transpose()}function L(e,t,n){for(var r=16*e,a=0;a<16;a++)n.elements[a]=t[a+r]}function P(e){for(var t=new Uint16Array(e.length+1),n=0,r=0;r<e.length;r++)t[r]=n,n+=of(e[r]);return t[r]=n,t}function I(e,t,n,r){var a=P(e),i=new S;return i.vb=t.vb,i.vbstride=t.vbstride,i.posOffset=t.attributes.position.itemOffset,i.normalOffset=t.attributes.normal?t.attributes.normal.itemOffset:-1,i.matrices=n,i.ranges=a,i.dbIds=r,i}function C(e,t){t.vb=e.vb,t.attributes.id.array=e.vertexIds,t.needsUpdate=!0}function D(e){var n=e+"_texMatrix",r=e+"_invert",a={};return a[e]={type:"t",value:null},a[n]={type:"m3",value:new t.Matrix3},a[r]={type:"i",value:0},a}function N(e){var n=e+"_texMatrix",r=e+"_bumpScale",a=e+"_bumpmapType",i={};return i[e]={type:"t",value:null},i[n]={type:"m3",value:new t.Matrix3},i[r]={type:"v2",value:new t.Vector2(1,1)},i[a]={type:"i",value:0},i}function O(){this.distance=mf,this.dot=1}function U(e,t){return e.x*t.y-e.y*t.x}function F(e,n,r){n=n,r=r;var a=e.length();return 0===a?n?new t.Vector2(0,r?0:1):new t.Vector2(0,-(r?0:1)):n?new t.Vector2(-e.y/a,e.x/a):new t.Vector2(e.y/a,-e.x/a)}function V(e,t,n){this.p=[],this.p[0]=e.clone(),this.p[1]=t.clone(),this.color=n}function B(e,t){return(t.x-e.x)*(e.y+t.y)}function z(e){return e>0?1:e<0?-1:0}function G(){this.edges=[]}function k(e,t,n){return e.dot(t)<=0||Math.abs(U(e,t))>n}function H(e,t){return W(e,t,_f)}function W(e,t,n){var r=e&n;if(r==vf||r==gf||r==xf)return e=r^Mf,[e,t];if(e==_f||e==Mf)return e=[wf,bf,yf][t%3],t=Math.floor(t/3),[e,t];var a=e<<1+(1&t);return e=(a|a>>3)&Mf,t>>=1,[e,t]}function q(){this.minDistance=new O,this.nearEdge=null,this.nearParam=0}function j(e,t,n){return Math.max(Math.min(e,t),Math.min(Math.max(e,t),n))}function X(e,t){var n=t.point(0),r=t.point(1),a=e,i=e.clone().sub(n),o=r.clone().sub(n),s=i.dot(o)/o.dot(o);return s<0?i.length():s>1?a.clone().sub(r).length():Math.abs(F(o,!1,!1).dot(i))}function Y(){this.contours=[],this.windings=[],this.inverseYAxis=!1}function K(e,n,r){if(!e||!e.colors)return new t.Color(1,0,0);var a=e.colors[n];if(!a)return new t.Color(0,0,0);var i=a.values;if(!i||!i.length)return new t.Color(1,0,0);var o=i[0];return new t.Color(o.r,o.g,o.b)}function Z(e,t,n){if(!e||!e.scalars)return n;var r=e.scalars[t];return r?r.values[0]:n}function Q(e,t,n){if(!e||!e.booleans)return n;var r=e.booleans[t];return void 0===r?n:r}function J(e,t,n,r){if(!e||!e[t])return r;var a=e[t][n];return a?a.values[0]:r}function $(e,n,r){var a={bands:0,weights:new t.Vector4(1,1,1,1),frequencies:new t.Vector4(1,1,1,1)};if(!e||!e[n])return a;var i=e[n][r];if(!(i&&i.values&&i.values instanceof Array))return a;var o=i.values;a.bands=o.length/2;for(var s=0;s<a.bands;++s)a.frequencies.setComponent(s,1/o[2*s]),a.weights.setComponent(s,o[2*s+1]);return a}function ee(e,t,n,r){if(!e||!e.scalars)return r;var a=e.scalars[t];return a?ae(a.values[0],a.units,n):r}function te(e,t,n,r){if(!e||!e[t])return r;var a=e[t][n];return a&&a.connections?a.connections[0]:r}function ne(e){var t=e;return t<=.04045?t/=12.92:t=Math.pow((t+.055)/1.055,2.4),t}function re(e){var n,r,a;return n=ne(e.r),r=ne(e.g),a=ne(e.b),new t.Color(n,r,a)}function ae(e,n,r){var a=Af[r];a||(a=1,t.warn("Unsupported unit: "+r));var i=Af[n];return i||(i=1,t.warn("Unsupported unit: "+n)),e*a/i}function ie(e,n,r){if(0===n){var a=ee(e,"bumpmap_Depth",r,0),i=1,o=1;return null!=J(e,"scalars","texture_RealWorldScale")?i=o=ee(e,"texture_RealWorldScale",r,1):(i=ee(e,"texture_RealWorldScaleX",r,1),o=ee(e,"texture_RealWorldScaleY",r,1)),i=0===i?1:1/i,o=0===o?1:1/o,new t.Vector2(i*a,o*a)}var s=J(e,"scalars","bumpmap_NormalScale",1);return new t.Vector2(s,s)}function oe(e,t){var n=ee(e,"texture_RealWorldOffsetX",t,0),r=ee(e,"texture_RealWorldOffsetY",t,0),a=J(e,"scalars","texture_UOffset",0),i=J(e,"scalars","texture_VOffset",0),o=1,s=1;null!=J(e,"scalars","texture_RealWorldScale")?o=s=ee(e,"texture_RealWorldScale",t,1):(o=ee(e,"texture_RealWorldScaleX",t,1),s=ee(e,"texture_RealWorldScaleY",t,1)),o=0===o?1:o,s=0===s?1:s;var l=J(e,"scalars","texture_UScale",1),u=J(e,"scalars","texture_VScale",1),f=J(e,"scalars","texture_WAngle",1);f*=Math.PI/180;var d=Math.cos(f),c=Math.sin(f),p=l/o,h=u/s;return{elements:[d*p,c*p,0,-c*h,d*h,0,-d*p*n+c*h*r+a,-c*p*n-d*h*r+i,1]}}function se(){var e=[0,128,64,191,32,160,96,223,16,143,80,207,48,175,112,239,8,135,72,199,40,167,103,231,25,151,88,215,56,183,120,250],n=new Uint8Array(e),r=new t.DataTexture(n,32,1,t.LuminanceFormat,t.UnsignedByteType,t.UVMapping,t.RepeatWrapping,t.RepeatWrapping,t.NearestFilter,t.NearestFilter,0);r.generateMipmaps=!1,r.flipY=!1,r.needsUpdate=!0;for(var a,i,o=function(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))},s=new Uint8Array(16384),l=0;l<128;++l)for(var u=0;u<128;++u){a=l/128*2-1,i=u/128*2-1;var f=(a=Math.min(Math.max(1/128-1,a),1-1/128))-1/128,d=a+1/128,c=(i=Math.min(Math.max(1/128-1,i),1-1/128))-1/128,p=i+1/128,h=o(d,p)-o(f,p)-o(d,c)+o(f,c);s[128*l+u]=1e6*h}var m=new t.DataTexture(s,128,128,t.LuminanceFormat,t.UnsignedByteType,t.UVMapping,t.RepeatWrapping,t.RepeatWrapping,t.NearestFilter,t.NearestFilter,0);m.generateMipmaps=!1,m.flipY=!1,m.needsUpdate=!0,Sf={randomNum:r,solidAngle:m}}function le(){var e=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],n=new Uint8Array(e),r=new t.DataTexture(n,256,1,t.LuminanceFormat,t.UnsignedByteType,t.UVMapping,t.RepeatWrapping,t.RepeatWrapping,t.NearestFilter,t.NearestFilter,0);r.generateMipmaps=!1,r.flipY=!1,r.needsUpdate=!0;var a=[225,39,122,231,29,173,15,159,75,88,233,19,179,79,72,94,54,73,151,161,171,113,221,144,127,83,168,19,88,122,62,225,109,128,246,247,172,101,61,139,211,168,64,210,224,82,87,97,119,250,201,44,242,239,154,99,126,13,44,70,246,170,100,52,135,28,187,22,207,119,199,1,235,187,55,131,190,124,222,249,236,53,225,231,71,30,173,185,153,47,79,133,225,10,140,62,17,99,100,29,137,95,142,244,76,5,83,124,38,216,253,195,44,210,148,185,188,39,78,195,132,30,60,73,92,223,133,80,230,56,118,207,79,15,251,211,111,21,79,23,240,146,150,207,3,61,103,27,148,6,31,127,235,58,173,244,116,81,34,120,192,213,188,226,97,23,16,161,106,80,242,148,35,37,91,117,51,216,97,193,126,222,39,38,133,217,215,23,237,57,205,42,222,165,126,133,33,8,227,154,27,18,56,11,192,120,80,92,236,38,210,207,128,31,135,39,123,5,49,127,107,200,34,14,153,239,134,19,248,162,58,201,159,198,243,158,72,5,138,184,222,200,34,141,233,40,195,238,191,122,171,32,66,254,229,197],i=new Uint8Array(a),o=new t.DataTexture(i,256,1,t.LuminanceFormat,t.UnsignedByteType,t.UVMapping,t.RepeatWrapping,t.RepeatWrapping,t.NearestFilter,t.NearestFilter,0);o.generateMipmaps=!1,o.flipY=!1,o.needsUpdate=!0;for(var s,l,u,f,d,c,p,h,m=function(t){return e[t%256]},_=new Array(262144),v=0;v<256;++v)for(h=0;h<256;++h)l=m(s=m(h)+v),u=m(s+1),d=m(f=m(h+1)+v),c=m(f+1),_[p=4*(256*v+h)]=l,_[p+1]=u,_[p+2]=d,_[p+3]=c;var g=new Uint8Array(_),y=new t.DataTexture(g,256,256,t.RGBAFormat,t.UnsignedByteType,t.UVMapping,t.RepeatWrapping,t.RepeatWrapping,t.NearestFilter,t.NearestFilter,0);y.generateMipmaps=!1,y.flipY=!1,y.needsUpdate=!0;var x=[1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1,1,1,0,0,-1,1,-1,1,0,0,-1,-1],b=new Array(1024);for(h=0;h<256;++h){var w=e[h]%16;b[4*h]=127*x[3*w]+128,b[4*h+1]=127*x[3*w+1]+128,b[4*h+2]=127*x[3*w+2]+128,b[4*h+3]=0}var M=new Uint8Array(b),S=new t.DataTexture(M,256,1,t.RGBAFormat,t.UnsignedByteType,t.UVMapping,t.RepeatWrapping,t.RepeatWrapping,t.NearestFilter,t.NearestFilter,0);S.generateMipmaps=!1,S.flipY=!1,S.needsUpdate=!0,Tf={permutation:r,gradient:o,perm2D:y,permGrad:S}}function ue(e,t,n){e[n+"_enable"]=J(t,"booleans",n+"_enable",0);var r=$(t,"scalars",n+"_prof");e[n+"_bands"]=r.bands,e[n+"_weights"]=r.weights,e[n+"_frequencies"]=r.frequencies}function fe(e,n,r,a){e.scale(a);var i=new t.Vector3(Math.sin(r.x),Math.sin(r.y),Math.sin(r.z)),o=new t.Vector3(Math.cos(r.x),Math.cos(r.y),Math.cos(r.z)),s=i.y*i.x,l=i.y*o.x,u=new t.Matrix4;u.set(o.z*o.y,i.z*o.y,-i.y,0,o.z*s-i.z*o.x,i.z*s+o.z*o.x,o.y*i.x,0,o.z*l+i.z*i.x,i.z*l-o.z*i.x,o.y*o.x,0,0,0,0,1),u.multiply(e),e.makeTranslation(n.x,n.y,n.z),e.multiply(u)}function de(e){var n=Math.sin(e),r=Math.cos(e),a=new t.Matrix4;return a.set(r,-n,0,0,n,r,0,0,0,0,1,0,0,0,0,1),a}function ce(e){var n=["opaque_albedo_map","opaque_f0_map","layered_diffuse_map","layered_bottom_f0_map","surface_roughness_map","surface_normal_map","surface_albedo_map","surface_anisotropy_map","surface_cutout_map"];if(void 0!==e.textureMaps)for(var r=0;r<n.length;++r)if(void 0!==e.textureMaps[n[r]]&&void 0!==e.textureMaps[n[r]].textureObj&&void 0!==e.textureMaps[n[r]].textureObj.matrix){var a=e.textureMaps[n[r]].textureObj.matrix.elements,i=new t.Matrix4;return i.set(a[0],a[1],0,a[2],a[3],a[4],0,a[5],0,0,1,0,a[6],a[7],0,a[8]),i}return new t.Matrix4}function pe(e,n){var r=new t.Matrix4;r.makeScale(n.x,n.y,1);var a=new t.Matrix4;return a.makeTranslation(-e.x,-e.y,0),r.multiply(a),r}function he(e,n){if(0!==n.randomOffsetMode){e.tilingRandomAxisS=new t.Vector2,e.tilingRandomAxisT=new t.Vector2,e.tilingRandomAlignmentOffset=new t.Vector2;var r=e.tilingRandomAxisS;r.set(1,0);var a=e.tilingRandomAxisT;a.set(0,1);var i=e.tilingRandomAlignmentOffset;i.set(0,0);var o=new t.Matrix4,s=new t.Matrix4,l=ce(e),u=pe(new t.Vector2(0,1),new t.Vector2(1,-1));u.multiply(l),l.copy(u),o.multiplyMatrices(l,e.tilingUVTransform),s.getInverse(o);var f=new t.Vector4(1,0,0,0).applyMatrix4(s);r.set(f.x,f.y),f=new t.Vector4(0,1,0,0).applyMatrix4(s),a.set(f.x,f.y);for(var d=new t.Vector2,c=new t.Box2,p=n.alignedVertices,h=0;h<p.length;h++)f.set(p[h].x,p[h].y,0,1),f.applyMatrix4(o),d.set(f.x,f.y),c.expandByPoint(d);f.set(-c.min.x,-c.min.y,0,0),f.applyMatrix4(s),i.set(f.x,f.y);var m=c.size(),_=1===n.randomOffsetMode?new t.Vector2(m.x,m.y):new t.Vector2(0,0);r.multiplyScalar(1-_.x),a.multiplyScalar(1-_.y)}}function me(e,n){var r=new t.Box2;r.expandByPoint(new t.Vector2(0,0)),r.expandByPoint(e.offsetVectorA),r.expandByPoint(e.offsetVectorB);var a=new t.Vector2(e.offsetVectorA.x,e.offsetVectorA.y);a.add(e.offsetVectorB),r.expandByPoint(a);var i=void 0,o=void 0;for(i=0,o=n.length;i<o;i++){var s=n[i];s.material.tilingRepeatRange=[],Ae(e,s,s.material.tilingRepeatRange),s.bbox=new t.Box2;for(var l=0;l<s.vertices.length;++l)s.bbox.expandByPoint(s.vertices[l]);Pe(e,s),e.hasRoundCorner&&xe(e,s),s.material.useRandomOffset&&Te(s,i),s.alignedVertices=[];for(var u=0;u<s.vertices.length;++u){var f=new t.Vector2(s.vertices[u].x,s.vertices[u].y);f.sub(s.bbox.min),s.alignedVertices.push(f)}s.material.tileAlignOffset=new t.Vector2(-s.bbox.min.x,-s.bbox.min.y)}}function _e(e,n){e.normalToEdges=[];for(var r=e.vertices.length,a=Math.cos(n),i=Math.sin(n),o=0;o<r;++o){var s=o,l=o==r-1?0:o+1,u=new t.Vector2(e.vertices[l].x,e.vertices[l].y);u.sub(e.vertices[s]),u.normalize();var f=new t.Vector3(u.y*i,-u.x*i,a);e.normalToEdges.push(f)}e.cornerRoundingAngle=n}function ve(e,n,r){var a=new t.Vector2(r.x,r.y).sub(n),i=new t.Vector2(e.x,e.y).sub(n),o=a.dot(i);if(o<=0)return i.length();var s=a.dot(a);return o>=s?new t.Vector2(e).sub(r).length():Math.sqrt(Math.max(i.dot(i)-o*o/s,0))}function ge(e,t){for(var n=1e11,r=n,a=-1,i=0;i<e.vertices.length;i++){var o=i==e.vertices.length-1?0:i+1;(r=ve(t,e.vertices[i],e.vertices[o]))<n&&(n=r,a=i)}return[n,a]}function ye(e,t,n){for(var r=e.length,a=r-1,i=!1,o=0;o<r;++o)(e[o].y<n&&e[a].y>=n||e[a].y<n&&e[o].y>=n)&&e[o].x+(n-e[o].y)/(e[a].y-e[o].y)*(e[a].x-e[o].x)<t&&(i=!i),a=o;return i}function xe(e,n){var r=n.bbox.size(),a=2*e.cornerRoundingSize*.7071/3,i=Re(Math.ceil(r.x/a)+2,128,1024),o=Re(Math.ceil(r.y/a)+2,128,1024);i-=2,o-=2,r.x<r.y?o=Math.floor(i*r.y/r.x):i=Math.floor(o*r.x/r.y),i+=2,o+=2,_e(n,e.cornerRoundingAngle);for(var s=new Uint8Array(i*o*4),l=new t.Vector2(r.x/(i-2),r.y/(o-2)),u=new t.Vector2,f=new t.Vector3,d=new t.Vector3(0,0,1),c=0,p=0;p<o;p++){u.y=(o-p-1.5)*l.y+n.bbox.min.y;for(var h=0;h<i;h++){u.x=(h-.5)*l.x+n.bbox.min.x;var m=ge(n,u),_=m[0],v=m[1];_<e.cornerRoundingSize+e.insetSize?(ye(n.vertices,u.x,u.y)||(_=-_),f.copy(n.normalToEdges[v]),f.lerp(d,(_-e.insetSize)/e.cornerRoundingSize),f.normalize(),s[c++]=255*Re(.5*(f.x+1),0,1),s[c++]=255*Re(.5*(f.y+1),0,1),s[c++]=255*Re(.5*(f.z+1),0,1),s[c++]=255):(s[c++]=127,s[c++]=127,s[c++]=255,s[c++]=255)}}n.material.TilingNormalMap=new t.DataTexture(s,i,o,t.RGBAFormat,t.UnsignedByteType,t.UVMapping,t.ClampToEdgeWrapping,t.ClampToEdgeWrapping,t.LinearFilter,t.LinearFilter),n.material.TilingNormalMap.needsUpdate=!0;var g=new t.Vector2(-n.bbox.min.x,-n.bbox.min.y);n.material.TilingNormalMap_texMatrix=new t.Matrix3,n.material.TilingNormalMap_texMatrix.set(1/r.x*(i-2)/i,0,0,0,1/r.y*(o-2)/o,0,g.x/r.x*(i-2)/i+1/i,g.y/r.y*(o-2)/o+1/o,1),n.material.TilingNormalMap_texMatrix.transpose()}function be(e,t){return e<<t|e>>>32-t}function we(e,t,n){var r=4294967296;return n^=t,n=(n-be(t,14)+r)%r,e^=n,e=(e-be(n,11)+r)%r,t^=e,t=(t-be(e,25)+r)%r,n^=t,n=(n-be(t,16)+r)%r,e^=n,e=(e-be(n,4)+r)%r,t^=e,t=(t-be(e,14)+r)%r,n^=t,n=(n-be(t,24)+r)%r}function Me(e,t){var n=void 0,r=void 0,a=void 0;return n=r=a=3735928567+t,r+=e.y,n+=e.x,we(n,r,a)}function Se(e,t){var n=Me(e,33);t.x=(65535&n)>>>8,t.y=n>>>16>>>8}function Te(e,n){for(var r=new Uint8Array(1048576),a=new t.Vector2,i=new t.Vector2(107021*n,n),o=new t.Vector2,s=new t.Vector2,l=0,u=0;u<512;u++){a.y=Math.floor(-(u+1-256));for(var f=0;f<512;f++)a.x=Math.floor(f-256),o.copy(a),o.add(i),Se(o,s),r[l++]=0,r[l++]=0,r[l++]=s.x,r[l++]=s.y}e.material.TilingRandomMap=new t.DataTexture(r,512,512,t.RGBAFormat,t.UnsignedByteType,t.UVMapping,t.RepeatWrapping,t.RepeatWrapping,t.NearestFilter,t.NearestFilter),e.material.TilingRandomMap.needsUpdate=!0;new t.Vector2(-e.bbox.min.x,-e.bbox.min.y);e.material.TilingRandomMap_texMatrix=new t.Matrix3,e.material.TilingRandomMap_texMatrix.set(1/512,0,0,0,1/512,0,.5,.5,1),e.material.TilingRandomMap_texMatrix.transpose()}function Ae(e,n,r){var a=[];a[0]=new t.Vector2(e.offsetVectorA.x,e.offsetVectorB.x),a[1]=new t.Vector2(e.offsetVectorA.y,e.offsetVectorB.y);for(var i=Ee(a),o=new t.Box2,s=new t.Vector2,l=0;l<n.vertices.length;++l)s.x=n.vertices[l].dot(i[0]),s.y=n.vertices[l].dot(i[1]),o.expandByPoint(s);r[0]=Math.floor(o.min.x-1),r[2]=Math.ceil(o.max.x),r[1]=Math.floor(o.min.y-1),r[3]=Math.ceil(o.max.y)}function Ee(e){var n=e[0].x*e[1].y-e[0].y*e[1].x,r=[];return r[0]=new t.Vector2(e[1].y/n,-e[0].y/n),r[1]=new t.Vector2(-e[1].x/n,e[0].x/n),r}function Re(e,t,n){return e>n?n:e<t?t:e}function Le(e,n){for(var r=e.addBlankContour(),a=new t.Vector2,i=new t.Vector2,o=0;o<n.vertices.length;++o){var s=o,l=(o+1)%n.vertices.length;a=n.vertices[s],i=n.vertices[l],r.addEdge(new V(a,i,Mf))}e.initialize(),e.edgeColoringSimple(3,0)}function Pe(e,n){var r=new Y;Le(r,n);for(var a=n.bbox.size(),i=.7071*r.minSameColoredEdgeDistance()*.5,o=Re(Math.ceil(a.x/i)+2,16,512),s=Re(Math.ceil(a.y/i)+2,16,512),l=new Uint8Array(o*s*4),u=new t.Vector2(a.x/(o-2),a.y/(s-2)),f=(new t.Vector2(u.x*o,u.y*s),.5/(u.x+u.y)),d=new t.Vector2,c=new t.Vector3,p=0,h=0;h<s;h++){d.y=(s-h-1.5)*u.y+n.bbox.min.y;for(var m=0;m<o;m++)d.x=(m-.5)*u.x+n.bbox.min.x,c=(c=r.calculateMSDFValue(d)).add(new t.Vector3(e.insetSize,e.insetSize,e.insetSize)),l[p++]=255*Re(c.x*f+.5,0,1),l[p++]=255*Re(c.y*f+.5,0,1),l[p++]=255*Re(c.z*f+.5,0,1),l[p++]=0}n.material.TilingMap=new t.DataTexture(l,o,s,t.RGBAFormat,t.UnsignedByteType,t.UVMapping,t.ClampToEdgeWrapping,t.ClampToEdgeWrapping,t.LinearFilter,t.LinearFilter),n.material.TilingMap.needsUpdate=!0;var _=new t.Vector2(-n.bbox.min.x,-n.bbox.min.y);n.material.TilingMap_texMatrix=new t.Matrix3,n.material.TilingMap_texMatrix.set(1/a.x*(o-2)/o,0,0,0,1/a.y*(s-2)/s,0,_.x/a.x*(o-2)/o+1/o,_.y/a.y*(s-2)/s+1/s,1),n.material.TilingMap_texMatrix.transpose()}function Ie(e,n,r){var a=e.properties;n.clampS=!J(a,"booleans","texture_URepeat",!1),n.clampT=!J(a,"booleans","texture_VRepeat",!1),n.wrapS=n.clampS?t.ClampToEdgeWrapping:t.RepeatWrapping,n.wrapT=n.clampT?t.ClampToEdgeWrapping:t.RepeatWrapping,n.matrix=e.matrix||(e.matrix=oe(a,r)),"UnifiedBitmap"==e.definition&&(n.invert=J(a,"booleans","unifiedbitmap_Invert",!1)),"BumpMap"==e.definition&&(n.bumpmapType=J(a,"choicelists","bumpmap_Type",0),n.bumpScale=ie(a,n.bumpmapType,r))}function Ce(e){var t=Z(e,"texture_UScale",1),n=Z(e,"texture_VScale",1),r=Z(e,"texture_UOffset",0),a=Z(e,"texture_VOffset",0),i=Z(e,"texture_WAngle",0);return{elements:[Math.cos(i)*t,Math.sin(i)*n,0,-Math.sin(i)*t,Math.cos(i)*n,0,r,a,1]}}function De(e,n){if(e){var r=e.properties;n.invert=Q(r,"unifiedbitmap_Invert"),n.clampS=!Q(r,"texture_URepeat",!0),n.clampT=!Q(r,"texture_VRepeat",!0),n.wrapS=n.clampS?t.ClampToEdgeWrapping:t.RepeatWrapping,n.wrapT=n.clampT?t.ClampToEdgeWrapping:t.RepeatWrapping,n.matrix=e.matrix||(e.matrix=Ce(r))}}function Ne(e,t,n){return e.matrix||(e.matrix=t?oe(e.properties,n):Ce(e.properties)),e.matrix}function Oe(e){var t=e.materials,n=t[e.userassets[0]];if(n){var r=n.definition;return"TilingPattern"===r&&(n=t[n.properties.references.grout_material.connections[0]])&&(r=n.definition),"PrismLayered"==r||"PrismMetal"==r||"PrismOpaque"==r||"PrismTransparent"==r||"PrismGlazing"==r||"PrismWood"==r}return!1}function Ue(e){return.299*e.r+.587*e.g+.114*e.b}function Fe(e,t,n){var r=e.slots[n];r?-1==r.indexOf(t)&&r.push(t):e.slots[n]=[t]}function Ve(e,t,n){var r=e.slots[n];0==(r=r.filter(function(e){return e!=t})).length?delete e.slots[n]:e.slots[n]=r}function Be(e){return e.isLines?Of.LINES:e.isPoints?Of.POINTS:e.isWideLines?Of.WIDE_LINES:Of.TRIANGLES}function ze(e,t){switch(!0===e.isLines&&(e.isLines=void 0),!0===e.isWideLines&&(e.isWideLines=void 0),!0===e.isPoints&&(e.isPoints=void 0),t){case Of.LINES:e.isLines=!0;break;case Of.WIDE_LINES:e.isWideLines=!0;break;case Of.POINTS:e.isPoints=!0}}function Ge(e){this.geoms=[],this.matrices=[],this.vertexCount=0,this.material=e,this.fragIds=[],this.worldBox=new t.Box3}function ke(e,n){e.vb&&e.vbstride||t.warn("copyVertexFormat() supports only interleaved buffers");for(var r in e.attributes)n.attributes[r]=e.attributes[r];n.attributesKeys=e.attributesKeys.slice(0),n.vbstride=e.vbstride}function He(e,t){ze(t,Be(e)),t.lineWidth=e.lineWidth,t.pointSize=e.pointSize}function We(e){for(var n=e[0].vbstride,r=0,a=0,i=0,o=0;o<e.length;o++){var s=e[o];r+=e[o].ib.length,a+=If(s),e[o].iblines&&(i+=e[o].iblines.length)}var l=b();l.vb=new Float32Array(a*n),l.ib=new Uint16Array(r),i&&(l.iblines=new Uint16Array(i)),l.byteSize=l.vb.byteLength+l.ib.byteLength,l.iblines&&(l.byteSize+=l.iblines.byteLength),He(e[0],l),ke(e[0],l);var u=new t.BufferAttribute(null,3);u.normalize=!0,u.bytesPerItem=1,l.addAttribute("id",u);var f=e[0];return ze(l,Be(f)),f.isPoints&&(l=f.pointSize),f.isWideLines&&(l=f.lineWidth),l}function qe(e,t){for(var n=0,r=0,a=0,i=0,o=0;o<e.length;o++){for(var s=e[o],l=If(s),u=0;u<s.ib.length;u++)t.ib[a+u]=s.ib[u]+r;if(s.iblines){for(u=0;u<s.iblines.length;u++)t.iblines[i+u]=s.iblines[u]+r;i+=s.iblines.length}t.vb.set(s.vb,n),n+=s.vb.length,r+=l,a+=s.ib.length}}function je(e,t,n,r,a){var i=We(e);return i.boundingBox=r.clone(),qe(e,i),a?a.addMergeTask(e,i,t,n):Cf(e,i,t,n),i}function Xe(e,t){if(e.vbstride!=t.vbstride)return!1;if(Be(e)!==Be(t))return!1;if(e.isPoints&&e.pointSize!==t.pointSize)return!1;if(e.isWideLines&&e.lineWidth!==t.lineWidth)return!1;if(e.attributesKeys.length!=t.attributesKeys.length)return!1;for(var n=0,r=e.attributesKeys.length;n<r;n++){var a=e.attributesKeys[n],i=e.attributes[a],o=t.attributes[a];if(!o)return!1;if(i===o)return!0;if(i.itemOffset!==o.itemOffset||i.normalize!==o.normalize||i.itemSize!==o.itemSize||i.bytesPerItem!==o.bytesPerItem||i.isPattern!==o.isPattern)return!1}return!0}function Ye(e){this.meshes=[],this.fragId2MeshIndex=new Int32Array(e);for(var t=0;t<this.fragId2MeshIndex.length;t++)this.fragId2MeshIndex[t]=-1;this.byteSize=0,this.consolidationMap=null}function Ke(){this.buckets={},this.bucketCount=0,this.costs=0}function Ze(e,t){this.fragOrder=new Uint32Array(e),this.ranges=new Uint32Array(t),this.boxes=new Array(t),this.numConsolidated=-1}function Qe(e){Df.createWorker=e}function Je(){return!!Df.createWorker}function $e(e,n){function r(e,t,n,r){l.compose(t,n,r);for(var a=e.elements,i=l.elements,o=0;o<16;o++){var s=a[o],u=i[o];if(Math.abs(u-s)>1e-5)return!1}return!0}var a=b();a.ib=e.ib,a.vb=e.vb,a.iblines=e.iblines,ke(e,a),He(e,a);this.offsets=new Float32Array(3*n),this.rotations=new Float32Array(4*n),this.scalings=new Float32Array(3*n),this.ids=new Uint8Array(3*n);var i=new t.Vector3,o=new t.Quaternion,s=new t.Vector3,l=new t.Matrix4,u=0,f=n;this.addInstance=function(e,n){return u>=f?(t.warn("Instance buffer is already full."),!1):(e.decompose(i,o,s),!!r(e,i,o,s)&&(this.offsets[3*u]=i.x,this.offsets[3*u+1]=i.y,this.offsets[3*u+2]=i.z,this.rotations[4*u]=o.x,this.rotations[4*u+1]=o.y,this.rotations[4*u+2]=o.z,this.rotations[4*u+3]=o.w,this.scalings[3*u]=s.x,this.scalings[3*u+1]=s.y,this.scalings[3*u+2]=s.z,E(n,this.ids,3*u),u++,!0))},this.finish=function(){if(0==u)return null;u<f&&(this.offsets=new Float32Array(this.offsets.buffer,0,3*u),this.rotations=new Float32Array(this.rotations.buffer,0,4*u),this.scalings=new Float32Array(this.scalings.buffer,0,3*u),this.ids=new Uint8Array(this.ids.buffer,0,3*u));var e=new t.BufferAttribute(this.offsets,3),n=new t.BufferAttribute(this.rotations,4),r=new t.BufferAttribute(this.scalings,3),i=new t.BufferAttribute(this.ids,3);return i.normalize=!0,i.bytesPerItem=1,e.divisor=1,n.divisor=1,r.divisor=1,i.divisor=1,a.addAttribute("instOffset",e),a.addAttribute("instRotation",n),a.addAttribute("instScaling",r),a.addAttribute("id",i),a.numInstances=u,a.byteSize=a.vb.byteLength+a.ib.byteLength+this.offsets.byteLength+this.rotations.byteLength+this.scalings.byteLength,a}}function et(e){var n=new t.PlaneBufferGeometry(1,1);if(n.attributes.index.array.reverse)n.attributes.index.array.reverse();else for(var r,a=n.attributes.index.array,i=Math.floor(a.length/2),o=0,s=a.length;o<i;++o)r=a[o],a[o]=a[s-1-o],a[s-1-o]=r;return new t.Mesh(n,e)}function tt(){this.shadowMap=void 0,this.shadowMapSize=void 0,this.shadowMatrix=void 0,this.shadowLightDir=void 0,this.init=function(e){this.shadowMap=e,this.shadowMapSize=new t.Vector2(e.width,e.height),this.shadowMatrix=new t.Matrix4,this.shadowLightDir=new t.Vector3},this.apply=function(e){e.shadowMap=this.shadowMap,e.shadowMatrix=this.shadowMatrix,e.shadowLightDir=this.shadowLightDir,this.shadowMap?(Gl.setMacro(e,"USE_SHADOWMAP"),$f.UseHardShadows&&Gl.setMacro(e,"USE_HARD_SHADOWS")):(Gl.removeMacro(e,"USE_SHADOWMAP"),Gl.removeMacro(e,"USE_HARD_SHADOWS"))}}function nt(e){function n(e,t){e.forEach(function(e){t.apply(e)})}function r(e){var n=new t.WebGLRenderTarget(e,e,{minFilter:t.LinearFilter,magFilter:t.LinearFilter,format:t.RGBAFormat,type:t.FloatType,stencilBuffer:!1,generateMipmaps:!1});return n.generateMipmaps=!1,n}function a(e){p.setRenderTarget(e),p.setClearColor(c,1),p.clear()}function i(e){var t=l.shadowMap;l.shadowMap=y,n(e,l),l.apply(h),l.shadowMap=t}function o(e){e.uniforms.shadowMapRangeMin.value=f.near,e.uniforms.shadowMapRangeSize.value=f.far-f.near,e.uniforms.shadowESMConstant.value=$f.ShadowESMConstant,e.uniforms.shadowMinOpacity.value=$f.ShadowMinOpacity}function s(e,n,r){var a=r||new t.Vector3;return a.x=1&n?e.max.x:e.min.x,a.y=2&n?e.max.y:e.min.y,a.z=4&n?e.max.z:e.min.z,a}var l=null,u=null,f=new t.OrthographicCamera,d=Math.exp($f.ShadowESMConstant),c=$f.UseHardShadows?new t.Color(1,1,1):new t.Color(d,1,1),p=e,h=null,m=null,_=null,v=Gl.createShaderMaterial(Zf),g=new Jf;v.getCustomOverrideMaterial=g.getCustomOverrideMaterial;var y=null,x=function(){var e=new t.Matrix4,n=new t.Matrix4,r=new t.Vector3(0,0,0),a=new t.Box3,i=new t.Vector3,o=new t.Vector3;return function(t,s,l){t.position.copy(l),t.lookAt(r),e.makeRotationFromQuaternion(t.quaternion),n.getInverse(e),a.copy(s).applyMatrix4(n),o=a.center(o),i.set(o.x,o.y,a.max.z),i.applyMatrix4(e),t.position.copy(i),o=a.size(o),t.left=-.5*o.x,t.right=.5*o.x,t.bottom=-.5*o.y,t.top=.5*o.y,t.near=0,t.far=o.z,t.updateMatrixWorld(),t.matrixWorldInverse.getInverse(t.matrixWorld),t.updateProjectionMatrix()}}();this.init=function(){(l=new tt).init(r($f.ShadowMapSize)),u=$f.BlurShadowMap?new Wl($f.ShadowMapSize,$f.ShadowMapSize,$f.ShadowMapBlurRadius,1,{type:l.shadowMap.type,format:l.shadowMap.format}):void 0,(h=Gl.createShaderMaterial(Qf)).depthWrite=!1,h.transparent=!0,m=Kf.createGroundShape(h),(_=new t.Scene).add(m),this.groundShapeBox=new t.Box3,a(y=r(1))},this.init(),this.state=ed,this.startUpdate=function(e,t,n,r,a){var i=e.getVisibleBounds(!0);return this.beginShadowMapUpdate(n,i,r),e.reset(f,3,!0),this.state=td,t=this.continueUpdate(e,t,a)},this.continueUpdate=function(e,t,n){return t=e.renderSome(this.renderSceneIntoShadowMap,t),e.isDone()?(this.state=nd,this.finishShadowMapUpdate(n)):i(n),t},this.beginShadowMapUpdate=function(e,t,n){x(f,t,n),o(v),g.forEachMaterial(o),$f.UseHardShadows&&(Gl.setMacro(v,"USE_HARD_SHADOWS"),g.forEachMaterial(function(e){Gl.setMacro(e,"USE_HARD_SHADOWS")})),a(l.shadowMap),this.renderSceneIntoShadowMap(_)},this.renderSceneIntoShadowMap=function(e){e.overrideMaterial=v,p.render(e,f,l.shadowMap),e.overrideMaterial=null},this.finishShadowMapUpdate=function(e){u&&!$f.UseHardShadows&&u.render(p,l.shadowMap,l.shadowMap),l.shadowMatrix.multiplyMatrices(f.projectionMatrix,f.matrixWorldInverse),l.shadowMapRangeMin=f.near,l.shadowMapRangeSize=f.far-f.near,l.shadowLightDir.copy(f.position).normalize(),n(e,l),l.apply(h),this.isValid=!0},this.cleanup=function(e){u&&u.cleanup(),l.shadowMap&&l.shadowMap.dispose(),n(e,rd),v.dispose(),g.dispose(),h.dispose(),m.geometry.dispose()},this.setGroundShadowTransform=function(e,t,n,r){Kf.setGroundShapeTransform(m,e,t,n,r),this.groundShapeBox.setFromObject(m)},this.renderGroundShadow=function(e,t){p.render(_,e,t,!1)},this.expandByGroundShadow=function(){var e=new t.Plane,n=new t.Ray,r=new t.Vector3,a=new t.Vector3,i=new t.Box3;return function(t,o){e.normal.set(0,1,0),e.constant=-t.min.y,n.direction.copy(o).negate().normalize();var l=t.center(r),u=100*l.distanceToSquared(t.min)*100;i.makeEmpty();for(var f=0;f<8;f++){n.origin=s(t,f);var d=n.intersectPlane(e,a);d&&(d.distanceToSquared(l)>=u||i.expandByPoint(d))}t.union(i)}}(),this.getShadowParams=function(){return l},this.getShadowCamera=function(){return f}}function rt(e,t,n,r){_.call(this,e,t,n,r),this.visibleStats=0}function at(e){return e.matrix.elements[2]+e.matrix.elements[12]}function it(e,n,r,a){for(var i=new t.Box3,o=new Ke,s=0;s<r.length&&!(o.costs>=a);s++){var l=r[s];e.getWorldBounds(l,i);var u=e.getGeometry(l),f=e.getMaterial(l);o.addGeom(u,f,i,l)}return o.createConsolidationMap(r,s)}function ot(e,t,n,r,a){if(!(r>=n.length)){for(var i=r,o=-1,s=-1,l=r;l<n.length;l++){var u=n[l],f=e.getGeometryId(u),d=e.getMaterialId(u);f==o&&d==s||(l!=r&&yd(e,t,n,i,l,a),i=l,o=f,s=d)}yd(e,t,n,i,n.length,a)}}function st(e){for(var t=e.getCount(),n=[],r=0;r<t;r++){var a=e.getGeometryId(r),i=0|n[a];n[a]=i+1}return n}function lt(e,t){function n(n,r){var a=e.getGeometry(n),i=e.getGeometry(r),o=t[a.id],s=t[i.id],l=o*a.byteSize,u=s*i.byteSize;return l!=u?l-u:a.id!=i.id?a.id-i.id:e.getMaterialId(n)-e.getMaterialId(r)}for(var r=0,a=e.getCount(),i=new Int32Array(a),o=0;o<a;o++)e.getGeometry(o)&&(i[r]=o,r++);if(r<a&&(i=new Int32Array(i.buffer,i.byteOffset,r)),i.sort)i.sort(n);else{var s=new Array(a);for(o=0;o<a;o++)s[o]=i[o];for(s.sort(n),o=0;o<i.length;o++)i[o]=s[o]}return i}function ut(e,t,n,r){for(var a=e.geoms,i=[],o=0,s=0,l=0;l<t.meshes.length;l++){var u=t.meshes[l],f=u.geometry;f.byteSize||(f.byteSize=(f.vb.byteLength||0)+(f.ib.byteLength||0));var d=Number.isInteger(u.fragId);a.chooseMemoryType(f,f.numInstances,o,s),f.streamingDraw||(s+=f.byteSize,o+=1,d||(f.discardAfterUpload=!0)),d&&(i[f.id]=!0)}for(l=1;l<a.geoms.length;l++)if((f=a.geoms[l])&&!i[l]){var c=n[l];a.chooseMemoryType(f,c,o,s),f.streamingDraw&&r.deallocateGeometry(f),f.streamingDraw||(s+=f.byteSize,o+=1)}}function ft(e,t,n,r,a){var i=r.supportsInstancedArrays();n=n||100<<20;var o=st(e);a||(a=it(e,t,lt(e,o),n));var s=a.buildConsolidation(e,t,e.model),l=a.fragOrder,u=a.numConsolidated;if(i)ot(e,t,l,u,s);else for(var f=u;f<l.length;f++){var d=l[f];s.addSingleFragment(e,d)}ut(e,s,o,r);var c=e.model.getModelId();for(f=0;f<s.meshes.length;f++)s.meshes[f].modelId=c;return s}function dt(e,n){function r(e){f[e]||(f[e]=new t.Scene);var n=f[e];return n.children.length=0,n}function a(e){return e.numInstances?p.Instanced:e.attributes.id?p.Merged:p.Original}function i(e){if(u)return p.Original;var t=s.fragId2MeshIndex[e];return a(s.meshes[t].geometry)}var o=e,s=n,l=[],u=!1,f=[],d=new t.Matrix4,c=new t.Box3;this.getConsolidation=function(){return s},this.reset=function(){l.length=null;var e=o.getCount();u=!1;for(var t=o.db2ThemingColor.length>0,n=0;n<e;n++){var r=o.vizflags[n],a=0==(r&fu),i=0!=(r&cu),s=0!=(r&pu),f=!1;if(t){var d=o.fragments.fragId2dbId[n];f=!!o.db2ThemingColor[d]}if(a||i||f||s){u=!0;break}}},this.dispose=function(){for(var e=0;e<s.meshes.length;e++){var t=s.meshes[e].geometry;t&&(t.dispose(),t.needsUpdate=!0)}},this.consolidateNextBatch=function(e,n){var a=e.nodeIndex;if(u||void 0===a)return e;if(s.inProgress)return e;for(var i=r(a),f=e.start;f<e.lastItem;f++){var d=e.indices?e.indices[f]:f,p=s.fragId2MeshIndex[d],h=null;if(-1===p){if(!o.getGeometry(d))continue;return t.warn("Warning: Missing fragment in consolidation. Consolidation disabled."),e}l[p]||(o.getWorldBounds(d,c),n.intersectsBox(c)&&(h=s.meshes[p],l[p]=!0,i.children.push(h)))}return i.boundingBox=e.boundingBox,i.renderImportance=e.renderImportance,i.sortObjects=e.sortObjects,i};var p={Merged:1,Instanced:2,Original:3};this.updateRenderProxy=function(e,t){if(e.geometry&&e.geometry.attributes){var n=i(t);if(a(e.geometry)!=n){var r=o.getGeometry(t),l=s.fragId2MeshIndex[t],u=s.meshes[l];if(n===p.Original)e.geometry=r,e.material=o.getMaterial(t),o.getWorldMatrix(t,e.matrix);else if(n===p.Instanced){o.getWorldMatrix(t,d);var f=o.fragments.fragId2dbId[t],h=new $e(r,1);h.addInstance(d,f),e.geometry=h.finish(),e.material=u.material,e.matrix.identity()}else o.getWorldMatrix(t,d),o.getWorldBounds(t,c),f=o.fragments.fragId2dbId[t],e.geometry=je([r],d.elements,[f],c),e.material=u.material,e.matrix.identity();e.dispatchEvent({type:"removed"})}}}}function ct(){function e(e){var t=c[e],n=i;if(p)for(;n>a&&c[d[n-1]]>t;)d[n]=d[n-1],n--;else for(;n>a&&c[d[n-1]]<t;)d[n]=d[n-1],n--;d[n]=e,i++}function n(e){var t=s.getLeftChild(e);-1!==t&&(n(t),n(t+1)),g.makeEmpty(),-1!==t&&(s.getBoxThree(t,y),g.union(y),s.getBoxThree(t+1,y),g.union(y)),s.getPrimCount(e)&&(g.union(u[e].boundingBox),g.union(u[e].boundingBoxHidden)),s.setBoxThree(e,g)}var r,a,i,o,s=null,l=null,u=null,f=null,d=null,c=null,p=1,h=!0,m=!1,v=!1,g=new t.Box3,y=new t.Box3,x=!1,b=!0;this.initialize=function(e,t,n,a){r=e.getFragmentList(),a&&a.hasOwnProperty("prioritize_screen_size")&&(h=a.prioritize_screen_size),l=n,u=new Array(t.nodeCount),f=new Int8Array(t.nodeCount),s=t,d=new Int32Array(t.nodeCount+1),c=new Float32Array(t.nodeCount);for(var i=r.onDemandLoadingEnabled()?rt:_,o=0;o<t.nodeCount;o++){var p=t.getPrimCount(o);p&&(u[o]=new i(r,l,t.getPrimStart(o),p),u[o].lastItem=u[o].start+p,u[o].numAdded=p,u[o].nodeIndex=o,8&t.getFlags(o)&&(u[o].sortObjects=!0),t.getBoxThree(o,u[o].boundingBox))}},this.addFragment=function(e,t){},this.reset=function(e){if(o=e,a=0,i=0,f[0]=f[1]=Yu.CONTAINMENT_UNKNOWN,d[i++]=0,m=!1,v=!1,x=!1,b){for(var t=u,n=t.length,r=0;r<n;++r){var s=t[r];s&&s.resetVisStatus&&s.resetVisStatus()}b=!1}},this.nextBatch=function(){for(v||m||a!==i||(d[i++]=1,m=!0);a!==i;){var t=p||m?d[--i]:d[a++],n=f[t];if(n!==Yu.CONTAINS&&(s.getBoxThree(t,g),n=o.intersectsBox(g)),n!==Yu.OUTSIDE){var r,l,_=s.getLeftChild(t);if(-1!==_){var y=s.getFlags(t),b=o.viewDir[3&y]<0?1:0,w=y>>2&1,M=y>>3&1,S=p||m?1:0,T=0,A=0;h&&!m?(r=_+w,l=_+1-w,s.getBoxThree(r,g),c[r]=T=o.projectedBoxArea(g,n===Yu.CONTAINS),s.getBoxThree(l,g),c[l]=A=o.projectedBoxArea(g,n===Yu.CONTAINS),f[r]=f[l]=n,T>0&&e(r),A>0&&e(l)):(b^S^M&&(w=1-w),r=_+w,l=_+1-w,d[i++]=r,c[r]=-1,d[i++]=l,c[l]=-1,f[r]=f[l]=n)}if(0!==s.getPrimCount(t)){var E=u[t];return E.renderImportance=o.projectedBoxArea(E.boundingBox,n===Yu.CONTAINS),E}}m||v||a!==i||(d[i++]=1,m=!0)}return x=!0,null},this.skipOpaqueShapes=function(){m||v||(a=0,i=0,d[i++]=1,v=!0)},this.getVisibleBounds=function(e,t){for(var r=0;r<u.length;r++){var a=u[r];a&&(a.calculateBounds(),e.union(a.boundingBox),t.union(a.boundingBox),t.union(a.boundingBoxHidden))}n(0),n(1)},this.rayCast=function(e,n,r){for(var a=[1,0],i=new t.Vector3;a.length;){var o=a.pop();if(s.getBoxThree(o,g),g.expandByScalar(.5),null!==e.ray.intersectBox(g,i)){var l=s.getLeftChild(o);-1!==l&&(a.push(l),a.push(l+1)),0!==s.getPrimCount(o)&&u[o].raycast(e,n,r)}}},this.getSceneCount=function(){return u.length},this.getGeomScenes=function(){return u},this.resetVisStatus=function(){b=!0},this.done=function(){return x}}function pt(t,n){this.model=t,this.fragments=t.getData().fragments,this.geoms=t.getGeometryList(),this.pagingProxy=n,this.isFixedSize=this.fragments.length>0,this.isFixedSize?(this.boxes=this.fragments.boxes,this.transforms=this.fragments.transforms,this.useThreeMesh=!e.memoryOptimizedLoading):(this.boxes=null,this.transforms=null,this.useThreeMesh=!n||!n.onDemandLoadingEnabled());var r=this.fragments.length;this.vizflags=new Uint16Array(r),this.useThreeMesh&&(this.vizmeshes=new Array(r)),this.geomids=new Int32Array(r),this.materialids=new Int32Array(r),this.materialmap={},this.db2ThemingColor=[],this.originalColors=[],this.themingOrGhostingNeedsUpdate=[],this.dbIdIsHidden=[],this.dbIdIsGhosted=[],this.reachLimit=!1,this.animxforms=null;for(var a=0;a<r;a++)this.vizflags[a]=1,this.geomids[a]=-1;this.fragments.visibilityFlags&&(this.vizflags.set(this.fragments.visibilityFlags),delete this.fragments.visibilityFlags),this.allVisible=!0,this.allVisibleDirty=!0,this.nextAvailableFragID=r,this.boxTransform=[],this.boxCount=0}function ht(e){var t=e.r;return e.r=e.b,e.b=t,e}function mt(e,t){var n=e.originalColors[t];if(e.themingOrGhostingNeedsUpdate[t]){var r=e.getGeometry(t),a=r?r.attributes:null,i=a?a.color4b:null,o=a?a.dbId4b:null,s=a?a.layerVp4b:null,l=a?a.flags4b:null;if(i&&o&&r.vb&&s&&l){for(var u=new Uint32Array(r.vb.buffer),f=r.vbstride,d=u.length/r.vbstride,c=!1,p=i.itemOffset,h=o.itemOffset,m=s.itemOffset,_=l.itemOffset,v=0;v<d;v++){var g=u[v*f+h],y=n?n[v]:u[v*f+p],x=u[v*f+m],b=-1==(g=g<<8>>8)&&0==(x&parseInt("FFFF",16)),w=e.db2ThemingColor[g],M=e.dbIdIsHidden[g];if(w||M){if(!n){n=new Uint32Array(d);for(var S=0;S<d;S++)n[S]=u[S*f+p];e.originalColors[t]=n}y=M?0:bd(y,w),c=!0}else n&&(y=n[v]);u[v*f+p]=y;var T=e.dbIdIsGhosted[g]&&!b,A=u[v*f+_];T?A|=255<<24:A&=16777215,u[v*f+_]=A}c||(e.originalColors[t]=null),r.vbNeedsUpdate=!0,e.themingOrGhostingNeedsUpdate[t]=!1}}}function _t(e,t){if(e.model.is2d()){var n=e.fragments.dbId2fragId[t];if(Array.isArray(n))for(var r=0;r<n.length;r++)e.themingOrGhostingNeedsUpdate[n[r]]=!0;else"number"==typeof n&&(e.themingOrGhostingNeedsUpdate[n]=!0)}}function vt(e,t){this.frags=e,this.fragId=t,this.scale=null,this.quaternion=null,this.position=null}function gt(e,t,n){this.level=e,this.x=t,this.y=n}function yt(){this.offsetX=0,this.offsetY=0,this.scaleX=1,this.scaleY=1}function xt(){function e(e,n){var r=n||a,i=[];i.push(new t.Vector2(r.offsetX,r.offsetY)),i.push(new t.Vector2(r.offsetX+r.scaleX,r.offsetY)),i.push(new t.Vector2(r.offsetX+r.scaleX,r.offsetY+r.scaleY)),i.push(new t.Vector2(r.offsetX,r.offsetY+r.scaleY)),e.faceVertexUvs[0].length=0,e.faceVertexUvs[0].push([i[0],i[1],i[2]]),e.faceVertexUvs[0].push([i[0],i[2],i[3]]),e.uvTransform=r,e.uvsNeedUpdate=!0}var n=[],r=0,a=new yt;this.acquireQuadGeom=function(t){var a=n[r];return a?e(a,t):(a=this.createQuadGeom(t),n[r]=a),r++,a},this.createQuadGeom=function(n){var r=new t.Geometry;return r.vertices.push(new t.Vector3(0,0,0),new t.Vector3(1,0,0),new t.Vector3(1,1,0),new t.Vector3(0,1,0)),r.faces.push(new t.Face3(0,1,2)),r.faces.push(new t.Face3(0,2,3)),e(r,n),r.computeFaceNormals(),r},this.reset=function(){r=0},this.dispose=function(){for(var e=0;e<n.length;e++){var t=n[e];t&&(t.dispose(),t.needsUpdate=!0)}}}function bt(e,t,n){var r=e.clone();return r.max(t),r.min(n),r.distanceToSquared(e)}function wt(e,t,n,r){var a=e.clone();return a.max(n),a.min(r),a.sub(e).dot(t)}function Mt(){function e(e,t,n){var r=Math.ceil(Math.log2(e)),a=Math.ceil(Math.log2(t));return Math.max(r,a)-Math.log2(n)}function n(e,t,n){var r=t-n;r>0&&(e.texWidth>>=r,e.texHeight>>=r,e.maxLevel=n)}this.urlPattern=null,this.tileSize=null,this.maxLevel=null,this.textureLoader=null,this.texWidth=0,this.texHeight=0,this.maxActiveTiles=Yl()?0:400,this.cacheSize=Yl()?0:150,this.onRootLoaded=null,this.levelOffset=0,this.pixelRatio=1,this.getRootTileSize=function(){return 1*(this.tileSize<<this.maxLevel)},this.getQuadWidth=function(){return 1*this.texWidth/this.getRootTileSize()},this.getQuadHeight=function(){return 1*this.texHeight/this.getRootTileSize()},this.getPageToModelTransform=function(e,t){var n=e/this.getQuadWidth(),r=t/this.getQuadHeight();return new Ad(!0).set(n,0,0,0,0,r,0,0,0,0,1,0,0,0,0,1)},this.getBBox=function(){var e=this.getQuadWidth(),n=1-this.getQuadHeight();return new t.Box3(new t.Vector3(0,n,0),new t.Vector3(e,1,0))},this.valid=function(){return"string"==typeof this.urlPattern&&this.urlPattern.length>0&&"number"==typeof this.tileSize&&this.tileSize>0&&"number"==typeof this.maxLevel&&this.maxLevel>0&&"number"==typeof this.texWidth&&this.texWidth>0&&"number"==typeof this.texHeight&&this.texHeight>0},this.initForSimpleImage=function(e,t){this.urlPattern=decodeURIComponent(e),this.maxLevel=0,this.levelOffset=0,this.tileSize=-1,this.texWidth=-1,this.texHeight=-1,this.onRootLoaded=t},this.initFromLoadOptions=function(t,r,a){this.urlPattern=decodeURIComponent(t),this.textureLoader=a,r&&(this.tileSize=r.tileSize,this.maxLevel=e(r.texWidth,r.texHeight,r.tileSize),this.texWidth=r.texWidth,this.texHeight=r.texHeight,this.levelOffset=r.levelOffset,"number"==typeof r.maxLevel&&n(this,this.maxLevel,r.maxLevel),this.maxActiveTiles=r.maxActiveTiles||this.maxActiveTiles,this.cacheSize=r.cacheSize||this.cacheSize,this.zips=r.zips)}}function St(e,n){function r(e){var t=A.maxLevel-e;return A.texWidth>>t}function a(e){var t=A.maxLevel-e;return A.texHeight>>t}function i(e){var t=r(e.level),n=a(e.level),i=e.x*A.tileSize,o=e.y*A.tileSize;return i>=t||o>=n}function o(e){var n=r(e.level),i=a(e.level),o=e.x*A.tileSize,s=e.y*A.tileSize,l=Math.max(0,Math.min(A.tileSize,n-o)),u=Math.max(0,Math.min(A.tileSize,i-s)),f=1*A.tileSize;return new t.Vector2(l/f,u/f)}function s(e){return 1/(1<<e)}function l(e,t){var n=1<<e.level-t.level,r=1/n,a=r,i=o(t);r/=i.x,a/=i.y;var s=t.x*n,l=t.y*n,u=e.x-s,f=e.y-l,d=o(e);u*=r,f=1-(f*=a)-a*d.y;var c=new yt;return c.offsetX=u,c.offsetY=f,c.scaleX=r*d.x,c.scaleY=a*d.y,c}function u(e){return s(e.level)*e.x}function f(e){return s(e.level)*((1<<e.level)-1-e.y)}function d(e){return I[Ed.tile2Index(e)]}function c(e){var t=d(e);return t instanceof Id&&t.state==Pd}function p(e,t){for(var n=e.getParent();n;){var r=d(n),a=r&&r.state==Pd;if(a&&t&&r.mesh.material.map.needsUpdate&&n.level>0&&(a=!1),a)break;n=n.getParent()}return n}function h(e,n,r){var a;if(n)V||(V=z.createQuadGeom()),a=V;else{var i=p(e);n=v(i).material;var d=l(e,i);a=z.acquireQuadGeom(d)}var c=new t.Mesh(a,n);c.tile=e;var h=s(e.level),m=o(e),_=(1-m.y)*h,g=u(e),y=f(e);return c.position.set(g,y+_,0),c.scale.set(h*m.x,h*m.y,1),c}function m(e){var t=A.levelOffset?A.levelOffset:0;return A.urlPattern.replace("{x}",e.x).replace("{y}",e.y).replace("{z}",e.level+t)}function _(n){var r=Ed.tile2Index(n),a=I[r];if(!a||a.state==Rd){a||(a=new Id(C),I[r]=a),a.state=Ld;var i=m(n),o=function(r){if(G&&r){0==A.maxLevel&&(-1==A.texWidth&&(A.texWidth=r.image.width),-1==A.texHeight&&(A.texHeight=r.image.height),-1==A.tileSize&&(A.tileSize=Math.max(r.image.width,r.image.height)),E=e.getBBox()),r.minFilter=t.LinearFilter,r.magFilter=t.LinearFilter;var o=new t.MeshBasicMaterial({color:4294967295});o.map=r,o.name=i,o.tile=n,o.disableEnvMap=!0,i.toLowerCase().indexOf(".png")&&(o.transparent=!0,o.alphaTest=.01),L.addMaterial(o.name,o,!0);var s=h(n,o);a.mesh=s,a.state=Pd,O--,U=!0;var l=r&&r.image?r.image.src:null;l&&t.Cache&&t.Cache.get(l)&&t.Cache.remove(l),0==n.level&&A.onRootLoaded&&A.onRootLoaded()}};O++,A.textureLoader(i,function(e){o(e)},function(e){console.error(e)})}}function v(e){var t=Ed.tile2Index(e),n=I[t];return n&&n.state==Pd?n.mesh:null}function g(e,t){var n=u(e),r=f(e);t.set(n,r,0)}function y(e,t){var n=s(e.level),r=u(e)+n,a=f(e)+n;t.set(r,a,0)}function x(e,t){this.tile=e,this.prio=t}function b(e,t){return e.prio>t.prio}function w(e){var t=I[Ed.tile2Index(e)];t&&t.timeStamp!=C&&(t.timeStamp=C,D++)}function M(e,t,n){e.sort(function(e,r){var a=H(e,t,n);return H(r,t,n)-a});for(var r=0,a=0;a<e.length;a++){var i=d(e[a]);if(!i||i.state!=Ld){if(O>=N)break;_(e[a]),r++}}return r}function S(e){if(e&&e.mesh&&e.mesh.material){var t=e.mesh.material;L.removeMaterial(t.name),t.map.dispose(),t.map.needsUpdate=!0;var n={type:"dispose"};t.dispatchEvent(n),t.needsUpdate=!0}}function T(e,t,n){var r=Object.keys(I),a=r.length,i=e-(A.cacheSize-a);if(!(i<=0)){r.sort(function(e,r){var a=I[e].timeStamp,i=I[r].timeStamp;if(a!=i)return a-i;var o=Ed.index2Tile(e),s=Ed.index2Tile(r);return H(o,t,n)-H(s,t,n)});for(var o=Math.min(i,r.length),s=0;s<o;s++){var l=r[s];if(0!==Ed.index2Tile(l).level&&I[l].state==Pd){if(I[l].timeStamp==C)break;S(I[l]),delete I[l]}}}}var A=e,E=e.getBBox(),R=new t.Scene,L=n,P=!0,I=[],C=0,D=0,N=5,O=0,U=!1,F=[],V=null,B=!1,z=new xt;this.setAggressivePrefetching=function(e){B=e},this.getScene=function(){return R},this.nextBatch=function(){return P?null:(P=!0,R)},this.getSceneCount=function(){return 1},this.done=function(){return P},this.rayCast=function(e,t){return null},this.getVisibleBounds=function(e,t){e&&e.copy(E),t&&t.copy(E)};var G=this;_(new Ed.TileCoords(0,0,0));var k=function(){var e=new t.Vector3,n=new t.Vector3,r=new t.Box3;return function(t,a){return g(t,e),y(t,n),r.set(e,n),a.intersectsBox(r)>0}}(),H=function(){var e=new t.Vector3,n=new t.Vector3;return function(t,r,a){var i=s(t.level);g(t,e),y(t,n);var o=bt(a,e,n);return(k(t,r)?100:1)*(i*i)/(o=Math.max(o,1e-4))}}(),W=function(){var e=new t.Vector3,n=new t.Vector3;return function(r,a,i,o,s){g(r,e),y(r,n);var l=wt(a,i,e,n);return.5*((n.x-e.x)/(Math.tan(t.Math.degToRad(o/2))*l))*s}}();this.dispose=function(){var e;for(e in I)S(I[e]);V&&(V.dispose(),V.needsUpdate=!0),z.dispose()},this.dtor=function(){this.dispose(),G=null,L=null},this.reset=function(e,t){var n,r;for(n=0;n<R.children.length;n++)R.children[n].dispatchEvent({type:"removed"});if(R.children.length=0,C++,D=0,z.reset(),!c(new Ed.TileCoords(0,0,0)))return P=!0,!1;var a=new xd(b),o=new Ed.TileCoords(0,0,0),s=H(o,e,t.position);a.add(new x(o,s));for(var l=t.getWorldDirection(),u=0|t.clientHeight*A.pixelRatio,f=[],d=[],p=[];a.size()>0;)if(r=a.get(0).tile,a.removeAt(0),!i(r)){var m=!0;r.level==A.maxLevel&&(m=!1),W(r,t.position,l,t.fov,u)<A.tileSize&&(m=!1);var _=k(r,e);if(_&&(c(r)||p.push(r),w(r)),!_&&f.length+d.length>A.maxActiveTiles&&(m=!1),m)for(V=0;V<4;V++){var g=r.getChild(V);s=H(g,e,t.position),a.add(new x(g,s))}else _?f.push(r):d.push(r)}var y=0;U=!1;var S=!0;for(n=0;n<f.length;++n){var E=v(r=f[n]);E&&E.material.map.needsUpdate&&!B&&(y<5?y++:(E=h(r,null,!0),U=!0,S=!1)),E||(E=h(r,null),S=!1),R.add(E)}P=!1;var L=M(p,e,t.position);D+=O;var I=[];for(n=0;n<d.length&&!(D>=A.maxActiveTiles);n++)if(r=d[n],c(r))for(var N=0;N<=r.level&&(w(r.getParentAtLevel(N)),!(D>A.maxActiveTiles));N++);else I.push(r),D++;if(L+=M(I,e,t.position),B){for(I=[],n=0;n<f.length;++n)if((r=f[n]).level!=A.maxLevel)for(var V=0;V<4;V++)!i(g=r.getChild(V))&&k(g,e)&&(c(g)||(I.push(g),D++));L+=M(I,e,t.position)}if(T(L,e,t.position),S&&F.length>0){var G=F.splice(0,F.length);setTimeout(function(){for(var e=0;e<G.length;e++)G[e]()},1)}return S},this.callWhenRefined=function(e){F.push(e)},this.update=function(){return U}}function Tt(e,t,n){return!(e&&e-3*t*2<=au&&n<iu)}function At(e){function n(e){var t=r.getFragmentList().fragments.packIds[e];u.pagingProxy&&u.pagingProxy.addGeomPackMissingLastFrame(t)}var r=this,a=new t.Box3,i=new t.Box3,o=new t.Box3;this.visibleBoundsDirty=!1,this.enforceBvh=!1,this.isvizCacheEnabled=!1;var s=0;this.id=Nd++;var l=null,u=null,f=null,d=null,c=null,p=null,m=null,v=null,g=null,y=0,x=null,b=uu,w=Od[uu],M=!1,S=lu;this.getData=function(){return e},this.getGeometryList=function(){return l},this.getFragmentList=function(){return u},this.getModelId=function(){return this.id},this.initialize=function(e){var t=this.getData(),n=t.numGeoms||0,r=!Tt(t.packFileTotalSize,t.primitiveCount,n);l=new h(n,this.is2d(),r),u=new pt(this,e);var o=this.getBoundingBox();o&&(a.copy(o),i.copy(o)),m=c=f=new _d(this),p=new vd(this)},this.getIterator=function(){return c},this.initFromCustomIterator=function(e){m=c=e,this.visibleBoundsDirty=!0},this.dtor=function(e){u&&u.dispose(e),c&&c.dtor&&c.dtor(),v&&v.dispose()},this.activateFragment=function(e,t,n){u&&(u.setMesh(e,t,n),c.addFragment(e),u.getWorldBounds(e,o),a.union(o),i.union(o))},this.setFragment=function(e,t){return void 0===e&&(e=this.getFragmentList().getNextAvailableFragmentId()),u.setMesh(e,t,!0),f&&f.addFragment(e),d&&!u.fragmentsHaveBeenAdded()&&d.addFragment(e),u.getWorldBounds(e,o),a.union(o),i.union(o),e},this.setBVH=function(e,t,n){m=c=d=new ct,c.initialize(this,e,t,n)},this.resetIterator=function(e,t,n,r,a){return r=r||vu,u&&u.pagingProxy&&u.pagingProxy.resetIterator(e,r),r!=vu&&(r>=gu&&u&&u.onDemandLoadingEnabled()&&(u.setFlagGlobal(hu,!1),c.resetVisStatus(),p&&p.resetVisStatus()),r>=yu&&u&&u.pageOutGeometryEnabled()&&(S=lu,u.pagingProxy&&u.pagingProxy.reset())),M=!1,d&&!u.fragmentsHaveBeenAdded()&&(M=!0),this.isvizCacheEnabled&&(M=!1),M?c=d:f&&(c=f),m=a&&p.getSceneCount()<Dd?p:c,y=0,b=n,w=n<Od.length?Od[n]:Od[uu],x=t,m.reset(t,e),u&&u.resetBoxRun(),v&&v.reset(),m},this.nextBatch=function(){for(;;){var e=m.nextBatch();if(y++,!e)return null;if(v&&e instanceof _&&(e=v.consolidateNextBatch(e,x)),e instanceof t.Scene)return e;if(e.visibleStats&w)r=!(e.visibleStats&w<<16);else{var r=e.applyVisibility(b,x,this.getFragmentList().fragments.packIds?n:function(){});void 0!==e.visibleStats&&(e.visibleStats|=w,r||(e.visibleStats|=w<<16)),r||this.is2d()||(e.sortObjects&&!this.getFragmentList().useThreeMesh?e.sortByDepth(x):e.sortDone||e.sortByMaterial())}if(!r)return e}},this.getVisibleBounds=function(e){return this.visibleBoundsDirty&&(a.makeEmpty(),i.makeEmpty(),c.getVisibleBounds(a,i,e),this.visibleBoundsDirty=!1),e?i:a},this.rayIntersect=function(e,n,r,a){this.visibleBoundsDirty&&this.getVisibleBounds();var i,o=[];if(r&&r.length>0){var s=this.getFragmentMap(),l=[];if(s)for(i=0;i<r.length;i++)s.enumNodeFragments(r[i],function(e){l.push(e)},!0);else l=r;if(l.length>2)c.rayCast(e,o,r);else for(i=0;i<l.length;i++){var f=u.getVizmesh(l[i]);if(f){var d=ju.rayCast(f,e,o);d&&o.push(d)}}}else c.rayCast(e,o);if(!o.length)return null;o.sort(function(e,t){return e.distance-t.distance});var p=!!a;for(a=a||[],i=0;i<o.length;i++){var h=o[i].fragId;if(!this.is2d()&&this.isFragVisible(h)){var m=u.getMaterial(h);if(n&&m.transparent)continue;var _=o[i],v=!1,g=_.point;if(m&&m.cutplanes)for(var y=0;y<m.cutplanes.length;y++)v=v||m.cutplanes[y].dot(new t.Vector4(g.x,g.y,g.z,1))>1e-6;if(v||a.push(_),_.model=this,!p&&a.length>0)break}}var x=a[0]||null;return x&&(x.model=this),x},this.setHighlighted=function(e,t){if(!u)return!1;var n=u.setFlagFragment(e,du,t);return n&&(t?(p.addFragment(e),s++):(p.removeFragment(e),s--)),n},this.setVisibility=function(e,t){u&&(u.setVisibility(e,t),this.visibleBoundsDirty=!0)},this.setAllVisibility=function(e){u&&(u.setAllVisibility(e),this.visibleBoundsDirty=!0)},this.hideLines=function(e){u&&u.hideLines(e)},this.hidePoints=function(e){u&&u.hidePoints(e)},this.hasHighlighted=function(){return!!s},this.isFragVisible=function(e){return u.isFragVisible(e)},this.areAllVisible=function(){return!u||u.areAllVisible()},this.getGeomScenes=function(){return c.getGeomScenes()},this.getRenderProgress=function(){var e=y/m.getSceneCount();return e>1?1:e},this.pageOutIfNeeded=function(e,t,n){return u.pagingProxy?u.pagingProxy.pageOut(e,t,n):lu},this.frameUpdatePaging=function(e,t){return u&&u.pageOutGeometryEnabled()?(S=this.pageOutIfNeeded(!1,!1,t),m.done()&&(S=this.pageOutIfNeeded(!0,!1,t))==su&&(S=this.pageOutIfNeeded(!0,!0,t)),S):S},this.geomPacksMissingLastFrame=function(){return u&&u.pagingProxy?u.pagingProxy.geomPacksMissingLastFrame():[]},this.addGeomPackMissingLastFrame=function(e){return!u||!u.pagingProxy||u.pagingProxy.addGeomPackMissingLastFrame(e)},this.needResumeNextFrame=function(){return!(!u||!u.pagingProxy)&&u.pagingProxy.needResumeNextFrame()},this.update=function(e){return!(!c||!c.update)&&c.update(e)},this.setThemingColor=function(e,n){u?u.setThemingColor(e,n):t.warn("Theming colors are not supported by this model type.")},this.clearThemingColors=function(){u&&u.clearThemingColors()},this.getLeaflet=function(){return c instanceof St?c:null},this.consolidate=function(e,t,n){var r=ft(u,e,t,n,g);v=new dt(u,r),g=r.consolidationMap},this.unconsolidate=function(){v&&(v.dispose(),v=null)},this.isConsolidated=function(){return!!v},this.getConsolidation=function(){return v?v.getConsolidation():null},this.getInstanceTree=function(){return e?e.instanceTree:null},this.getFragmentMap=function(){return e?e.instanceTree||e.fragmentMap:null},this.getBoundingBox=function(){return e?e.bbox:null},this.is2d=function(){return!(!e||!e.is2d)},this.isOTG=function(){return e&&!!e.isOTG},this.updateRenderProxy=function(e,t){v&&v.updateRenderProxy(e,t)},this.skipOpaqueShapes=function(){c&&c.skipOpaqueShapes&&c.skipOpaqueShapes()},this.getMemoryInfo=function(){return u&&u.getMemoryInfo()}}function Et(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1/0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1/0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1/0;this.l=e,this.b=t,this.r=n,this.t=r}function Rt(){function e(e){r[e]=[],a[e]=0}function n(e){e&&(e.dispose(),e.needsUpdate=!0)}var r={},a={};this.acquireShaderMaterial=function(n,i){r[i]||e(i);var o=r[i][a[i]];if(o){o.defines={};for(var s in n)o.uniforms[s].value=n[s].value}else o=new t.ShaderMaterial({uniforms:n,vertexShader:Zd,fragmentShader:Kd}),r[i][a[i]]=o;return a[i]++,o},this.reset=function(){for(var e in a)a[e]=0},this.dispose=function(){for(var e in r)for(var t=0;t<r[e].length;t++)n(r[e][t])}}function Lt(e,t,n){this.nodeAccess=e,this.maxDepth=n,this.objectCount=t,this.numHidden=0,this.numOff=0}function Pt(e){this.numOffs=0,this.numHidden=0;var t,n={};!function(e){function r(t){for(var n=0,r=e.length;n<r;n++){var a=e[n];Array.isArray(a)||(o[0]=a,a=o);for(var i=0;i<a.length;i++)t(n,a[i])}}var a=0,i=[],o=[0];r(function(e,t){var r=n[t];void 0===r&&(n[t]=r=i.length,i.push(0),i.push(0)),++i[r],++a}),(t=new Uint32Array(a+i.length/2)).fill(0);var s,l,u=0;for(s in n){l=n[s];var f=i[l],d=u+f+1;t[u]=f,i[l]=i[l+1]=u,u=d}var c=!1;r(function(e,r){var a=n[r],o=i[a+1]+1;o>t.length||t[o]?c||(console.error("DbidFragmentMap.buildMap: Internal error fragment overlap"),c=!0):(t[o]=e,i[a+1]=o)}),c=!1;for(s in n){l=n[s];var p=i[l+1]+1;p<t.length&&!t[p]&&(c||(console.error("DbidFragmentMap.buildMap: Internal error fragment underfilled"),c=!0))}for(s in n)l=n[s],n[s]=i[l]}(e),this.setFlagNode=function(e,r,a){if(!n.hasOwnProperty(e))return!1;var i=n[e];return!!(t[i]&r)!=a&&(a?t[i]|=r:t[i]&=~r,!0)},this.setNodeOff=function(e,t){var n=this.setFlagNode(e,$d,t);return n&&(t?this.numOff++:this.numOff--),n},this.isNodeOff=function(e){var r=n[e];return!!(t[r]&$d)},this.setNodeHidden=function(e,t){var n=this.setFlagNode(e,ec,t);return n&&(t?this.numHidden++:this.numHidden--),n},this.isNodeHidden=function(e){var r=n[e];return!!(t[r]&ec)},this.getRootId=function(){return nc},this.enumNodeFragments=function(e,r){var a;"number"==typeof e?a=e:e&&(a=e.dbId);for(var i=n[a],o=(t[i]&tc)+i+1;++i<o;)r(t[i],a)},this.enumNodeChildren=function(e,t,r){if(r&&t(e),e==nc)for(var a in n)t(Number(a))}}function It(e,t){this.nodes=[],this.nextNode=0,this.children=[],this.nextChild=0,this.dbIdToIndex={},this.names=[],this.s2i={},this.strings=[],this.nameSuffixes=[],this.getIndex(0)}function Ct(e){var t=new Int32Array(e.length);return t.set(e),t}function Dt(e,t,n){this.nodes=e.nodes,this.children=e.children,this.dbIdToIndex=e.dbIdToIndex,this.names=e.names,this.nameSuffixes=e.nameSuffixes,this.strings=e.strings,this.rootId=t,this.numNodes=this.nodes.length/rc,this.visibleIds=null,this.nodeBoxes=n||new Float32Array(6*this.numNodes)}function Nt(e,t){this.bytes_per_node=t?32:36;var n,r;e instanceof ArrayBuffer?(n=e.byteLength/this.bytes_per_node,r=e,this.nodeCount=n):(n=0|e,r=new ArrayBuffer(this.bytes_per_node*n),this.nodeCount=0),this.nodeCapacity=n,this.nodesRaw=r,this.is_lean_node=t,this.node_stride=this.bytes_per_node/4,this.node_stride_short=this.bytes_per_node/2,this.nodesF=new Float32Array(this.nodesRaw),this.nodesI=new Int32Array(this.nodesRaw),this.nodesS=new Uint16Array(this.nodesRaw)}function Ot(e,t){this.boxes=e.boxes,this.polygonCounts=e.polygonCounts,this.hasPolygonCounts=!!this.polygonCounts,this.materials=e.materials,this.materialDefs=t,this.count=e.length,this.boxStride=6}function Ut(e,t,n){this.finfo=n||new Ot(e,t),this.prim_count=this.finfo.getCount(),this.frags_per_leaf_node=-1,this.frags_per_inner_node=-1,this.nodes=null,this.work_buf=new ArrayBuffer(4*this.prim_count),this.sort_prims=new Int32Array(this.work_buf),this.primitives=new Int32Array(this.prim_count),this.centroids=new Float32Array(ac*this.prim_count),this.boxv_o=new Float32Array(6),this.boxc_o=new Float32Array(6),this.boxv_t=new Float32Array(6),this.boxc_t=new Float32Array(6),this.recursion_stack=[]}function Ft(e){return"ErrorCode:"+e+"."}function Vt(e,t,n){var r,a,i,o,s,l,u,f;for(r="",s=[],i=n,l=0,a=0;a<i;){switch((o=e[t+a++])>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:s.push(String.fromCharCode(o));break;case 12:case 13:u=e[t+a++],s.push(String.fromCharCode((31&o)<<6|63&u));break;case 14:u=e[t+a++],f=e[t+a++],s.push(String.fromCharCode((15&o)<<12|(63&u)<<6|(63&f)<<0))}(++l>=32768||a>=i)&&(r+=s.join(""),s.length=0,l=0)}return r}function Bt(e,t,n){if(void 0===t&&(t=0),void 0===n&&(n=e.length),dc)return Vt(e,t,n);for(var r="",a=t,i=t+n;a<i;a++)r+=String.fromCharCode(e[a]);return decodeURIComponent(escape(r))}function zt(e){var t=Bt(e,0,e.length);return JSON.parse(t)}function Gt(e){var t=e.split("/");if(0==t.length)return e;for(var n=[],r=0;r<t.length;++r){var a=t[r];"."!==a&&(".."===a&&n.length?n.pop():n.push(a))}return 0==n.length?"":n.join("/")}function kt(e,t){for(var n=e.length-t,r=new ArrayBuffer(n),a=new Uint8Array(r,0),i=0,o=t;i<n;i++,o++)a[i]=255&e.charCodeAt(o);return a}function Ht(e,t){return-1===t.indexOf("file://")&&(-1!==t.indexOf("://")||(!!e||void 0))}function Wt(t,n){n.hasOwnProperty("asynchronous")?n.asynchronous||e.logger.warn("LMV: Sync XHR used. Performance warning."):n.asynchronous=!0,n.hasOwnProperty("responseType")||(n.responseType="arraybuffer"),n.hasOwnProperty("withCredentials")||(n.withCredentials=!!t.auth),n.headers=t.headers,n.queryParams=t.queryParams,n.endpoint=t.endpoint}function qt(t){var n=t.data;if(n&&n.debug)e.logger.debug(n.message);else if(n.cbId){var r=Sc[n.cbId];n&&n.error?r[1]&&r[1](n.error):r[0]&&r[0](n.result),delete Sc[n.cbId]}}function jt(e,t){var n=Mc++;return Sc[n]=[e,t],n}function Xt(e,t){var n=255*t[2]+t[3],r=Math.pow(2,(n-127)/2),a=r/t[1],i=t[0]*a,o=Ac[0]*i+Ac[3]*r+Ac[6]*a,s=Ac[1]*i+Ac[4]*r+Ac[7]*a,l=Ac[2]*i+Ac[5]*r+Ac[8]*a;o<0&&(o=0),s<0&&(s=0),l<0&&(l=0),e[0]=o,e[1]=s,e[2]=l}function Yt(e,t,n){var r=.0625*Math.sqrt(t[0]*n),a=.0625*Math.sqrt(t[1]*n),i=.0625*Math.sqrt(t[2]*n),o=Math.max(Math.max(r,a),Math.max(i,1e-6));o>1&&(o=1);var s=Math.ceil(255*o)/255;r>1&&(r=1),a>1&&(a=1),i>1&&(i=1),e[3]=s;var l=1/s;e[0]=r*l,e[1]=a*l,e[2]=i*l}function Kt(e,t,n){var r=Math.sqrt(t[0]*n),a=Math.sqrt(t[1]*n),i=Math.sqrt(t[2]*n);r>65504&&(r=65504),a>65504&&(a=65504),i>65504&&(i=65504),e[0]=r,e[1]=a,e[2]=i}function Zt(e){for(var t=[],n=Array.isArray(e.image)?e.image:[e.image],r=0;r<n.length;r++)for(var a=n[r],i=0;i<a.mipmaps.length;i++){var o=a.mipmaps[i];t.push(o.data.buffer)}return t}function Qt(e){var t=e.width,n=e.height,r=void 0,a=void 0;if(0==(t&t-1)&&0==(n&n-1)){if(t*n<=Fc)return e;r=t,a=n}else{for(r=1;2*r<t;)r*=2;for(a=1;2*a<n;)a*=2}for(;r*a>Fc;)r=Math.max(r/2,1),a=Math.max(a/2,1);var i=document.createElement("canvas"),o=i.getContext("2d");return i.width=r,i.height=a,i.wasNPOT=!0,o.drawImage(e,0,0,r,a),i}function Jt(e){return e.format===t.AlphaFormat||e.format===t.RGBAFormat}function $t(e){return e.clampS||e.clampT}function en(e){return e.minFilter!==t.NearestFilter&&e.minFilter!==t.LinearFilter}function tn(e){!0===e.image.wasNPOT&&Jt(e)&&$t(e)&&en(e)&&Kl()&&Ql()&&(e.minFilter=t.LinearFilter,e.generateMipmaps=!1,e.needsUpdate=!0)}function nn(e){for(var t="",n=new Uint8Array(e),r=n.byteLength,a=0;a<r;a++)t+=String.fromCharCode(n[a]);return"data:image/jpeg;base64,"+window.btoa(t)}function rn(n,r,a,i,o){function s(t){o&&o.extractImage&&(t=o.extractImage(t));var n=new Image;l.image=n,tn(l),n.onload=function(){l.needsUpdate=!0,i&&i(l)},n.onerror=function(t){e.logger.error(t,Ft(e.ErrorCodes.UNKNOWN_FAILURE)),i&&i(null)},n.src=nn(t)}var l=new t.Texture(void 0,a);return o&&o.rawData?s(o.rawData):mc.getItem(n,r,s,function(t,n){var r="Error: "+t+" ("+n+")";e.logger.error(r,Ft(e.ErrorCodes.NETWORK_SERVER_ERROR)),i&&i(null)}),l}function an(n,r,a,i,o){var s=new t.DataTexture(void 0,a);return mc.getItem(n,r,function(e){o&&o.extractImage&&(e=o.extractImage(e)),s.image={data:e,width:void 0,height:void 0},s.needsUpdate=!0,i&&i(s)},function(t,n){var r="Error: "+t+" ("+n+")";e.logger.error(r,Ft(e.ErrorCodes.NETWORK_SERVER_ERROR)),i&&i(null)}),s}function on(e,t,n,r){var a=n.textureMaps;if(!a)return!1;var i=a[r];if(!i)return!1;if(t.clearTextureFromMaterial(e,n,i,r),i.tex){var o=n.defines;o&&delete o[r],n.needsUpdate=!0,n[r]=null,i.tex=null}return!0}function sn(){return Nc+Dc.length}function ln(e,t,n,r){mc.getItem(e,t,r,e.onFailureCallback,{asynchronous:!0,responseType:n||"arraybuffer"})}function un(e,t){this.min.x=e[t],this.min.y=e[t+1],this.min.z=e[t+2],this.max.x=e[t+3],this.max.y=e[t+4],this.max.z=e[t+5]}function fn(e,t){e[t]=this.min.x,e[t+1]=this.min.y,e[t+2]=this.min.z,e[t+3]=this.max.x,e[t+4]=this.max.y,e[t+5]=this.max.z}function dn(e,t,n,r){var a=e[1]<<16|e[0];if(a||(a=28),this.boxStride=a/4,this.count=e.byteLength/a-1,this.count){this.boxes=new Float32Array(e.buffer,a),this.flags=new Int32Array(e.buffer,a);var i=this.boxes;if(n)for(var o=new Ou,s=0,l=0;l<this.count;l++,s+=this.boxStride)un.call(o,i,s),o.applyMatrix4(t),fn.call(o,i,s);else if(r&&(r.x||r.y||r.z))for(var s=0,l=0;l<this.count;l++,s+=this.boxStride)i[s]-=r.x,i[s+1]-=r.y,i[s+2]-=r.z,i[s+3]-=r.x,i[s+4]-=r.y,i[s+5]-=r.z}this.hasPolygonCounts=!0,this.wantSort=!1}function cn(e){switch(e){case"meter":case"meters":case"m":return 1;case"feet and inches":case"foot":case"feet":case"ft":return.3048;case"inch":case"inches":case"in":return.0254;case"centimeter":case"centimeters":case"cm":return.01;case"millimeter":case"millimeters":case"mm":return.001;default:return 1}}function pn(e){for(var t=e.elements,n=0;n<4;n++)for(var r=0;r<4;r++)if(n===r){if(1!==t[4*n+r])return!1}else if(0!==t[4*n+r])return!1;return!0}function hn(e,t){if(e.placementTransform=t.placementTransform,t.applyScaling){var n="m";e.metadata["distance unit"]&&(n=e.metadata["distance unit"].value),e.scalingUnit=n,"object"===od(t.applyScaling)?(t.applyScaling.from&&(n=t.applyScaling.from),t.applyScaling.to&&(e.scalingUnit=t.applyScaling.to)):e.scalingUnit=t.applyScaling;var r=cn(n)/cn(e.scalingUnit);if(1!=r){var a=new Ad(!0),i=new Ad(!0);i.elements[0]=r,i.elements[5]=r,i.elements[10]=r,t.placementTransform&&a.copy(t.placementTransform),e.placementTransform=t.placementTransform=a.multiply(i)}}var o=e.metadata&&e.metadata["custom values"]&&e.metadata["custom values"].refPointTransform;if(o)e.refPointTransform=new Ad(!0),(f=e.refPointTransform.elements)[0]=o[0],f[1]=o[1],f[2]=o[2],f[4]=o[3],f[5]=o[4],f[6]=o[5],f[8]=o[6],f[9]=o[7],f[10]=o[8],f[12]=o[9],f[13]=o[10],f[14]=o[11];else{var s=e.metadata&&e.metadata.georeference&&e.metadata.georeference.refPointLMV,l=e.metadata&&e.metadata["custom values"]&&e.metadata["custom values"].angleToTrueNorth,u=l?Math.PI/180*l:0;if(s||u){e.refPointTransform=new Ad(!0);var f=e.refPointTransform.elements;u&&(f[0]=f[5]=Math.cos(u),f[1]=-Math.sin(u),f[4]=Math.sin(u)),s&&(f[12]=s[0],f[13]=s[1],f[14]=s[2])}}if(t.applyRefPoint&&e.refPointTransform){var d=new Ad(!0);t.placementTransform&&d.copy(t.placementTransform),d.multiply(e.refPointTransform),e.placementTransform=t.placementTransform=d}return e.placementTransform&&pn(e.placementTransform)&&(e.placementTransform=null),e.placementTransform}function mn(e,t){if(e.metadata){var n=e.metadata["world bounding box"],r=new Nu(n.minXYZ[0],n.minXYZ[1],n.minXYZ[2]),a=new Nu(n.maxXYZ[0],n.maxXYZ[1],n.maxXYZ[2]);e.bbox=new Ou(r,a),e.globalOffset=t.globalOffset||{x:.5*(r.x+a.x),y:.5*(r.y+a.y),z:.5*(r.z+a.z)};var i=hn(e,t),o=e.globalOffset;if(o.x||o.y||o.z){if(i){var s=new Ad(!0);s.copy(i),(i=s).elements[12]-=o.x,i.elements[13]-=o.y,i.elements[14]-=o.z}else(i=new Ad(!0)).makeTranslation(-o.x,-o.y,-o.z);e.placementWithOffset=i}else e.placementWithOffset=i;i&&e.bbox.applyMatrix4(i),e.metadata.hasOwnProperty("double sided geometry")&&e.metadata["double sided geometry"].value&&(e.doubleSided=!0)}}function _n(e,t){e[0]-=t.x,e[1]-=t.y,e[2]-=t.z}function vn(e){if(e.animations){var t=e.animations.animations;if(t)for(var n=e.globalOffset,r=(new Ad).makeTranslation(n.x,n.y,n.z),a=(new Ad).makeTranslation(-n.x,-n.y,-n.z),i=new Ad,o=new Ad,s=0;s<t.length;s++){var l=t[s];if(l.hierarchy)for(var u=0;u<l.hierarchy.length;u++){var f=l.hierarchy[u].keys;if(f)for(var d=0;d<f.length;d++){var c=f[d].pos;if(c){var p=n,h=f[d].rot;h&&(i.makeRotationFromQuaternion({x:h[0],y:h[1],z:h[2],w:h[3]}),o.multiplyMatrices(r,i).multiply(a),p={x:o.elements[12],y:o.elements[13],z:o.elements[14]}),_n(c,p)}var m=f[d].target;m&&_n(m,n);var _=f[d].points;if(_)for(var v=0;v<_.length;v++)_n(_[v],n)}}}}}function gn(t,n){function r(t){var r=new Uint8Array(4);if("string"==typeof t)for(u=0;u<4;u++)r[u]=t.charCodeAt(u);else for(var u=0;u<4;u++)r[u]=t[u];(a=r[1]<<8|r[0])||(a=n||0),a||e.logger.error("Unknwon byte stride."),a%4&&e.logger.error("Expected byte size to be multiple of 4, but got "+a),i=r[3]<<8|r[2],o=new Uint8Array(a),s=new Float32Array(o.buffer),l=new Uint32Array(o.buffer)}var a,i,o,s,l,u=0;this.onData=function(e,n){for(var i="string"==typeof e;;){if(!u&&e.length>=4)r(e),u++;else if(e.length<4)return!1;var s=u*a,l=s+a;if(e.length<l)return n;if(i)for(f=0;f<a;f++)o[f]=255&e.charCodeAt(f+s);else for(var f=0;f<a;f++)o[f]=e[f+s];if(!t(u-1))return!1;u++}},this.onEnd=function(e){this.onData(e,!0)||(this.rawData=e)},this.flush=function(){this.rawData&&(this.onData(this.rawData,!0)||e.logger.warn("Unexpected data stream termination."),this.rawData=null)},this.idata=function(){return l},this.fdata=function(){return s},this.bdata=function(){return o},this.version=function(){return i},this.byteStride=function(){return a}}function yn(e){this.materials=null,this.fragments=null,this.geompacks=[],this.propertydb={attrs:[],avs:[],ids:[],values:[],offsets:[]},this.bbox=null,this.animations=null,this.pendingRequests=0,this.globalOffset={x:0,y:0,z:0},this.pendingRequests=0,this.initialLoadProgress=0,this.materialIdToHash=[],this.geomIdToHash=[],this.aborted=!1}function xn(e,t,n){for(var r=[],a=0;a<n;a++){var i=e[t+a],o=ep[i];r.push(o)}return r.join("")}function bn(e,t){return 0===t.indexOf("urn:adsk.fluent:fs.file:")?t:0!==t.indexOf("https://")&&0!==t.indexOf("http://")?e.basePath+t:t}function wn(e){var t=e.max.x-e.min.x,n=e.max.y-e.min.y,r=e.max.z-e.min.z;return 2*(t*n+n*r+r*t)}function Mn(e,t){return e.importance-t.importance}function Sn(e,t){return t.importance-e.importance}function Tn(e,t,n){var r=6*t;return n.min.y=e[r+1],n.min.z=e[r+2],n.min.x=e[r+0],n.max.x=e[r+3],n.max.y=e[r+4],n.max.z=e[r+5],n}function An(t,n){function r(){A=!1}function a(e){if(!d||!e)return 0|Math.random()*h;var t,n=0,r=d.length-1;do{var a=0|(n+r)/2;if((t=d[a]).geomStart>e)r=a-1;else{if(!(t.geomEnd<=e))break;n=a+1}}while(n<=r);return t.geomStart<=e&&t.geomEnd>e?t.workerId:(console.error("Range not found",e),-1)}function i(){var e=g*h-v;if(0!==e){S.updateRequestPriorities()||(e=Math.min(e,10*h));for(var t=[],n=0,r=0;r<x.length&&n<e;){var o=x[r++],s=a(o.geomIdx);(u=t[s])?(u.urls.push(o.url),u.hashes.push(o.hash),u.geomIds.push(o.geomIdx),u.sampleWorldMatrices.push(o.sampleWorldMatrix)):(u={operation:"LOAD_GEOMETRY_OTG",urls:[o.url],isCDN:o.isCDN,hashes:[o.hash],geomIds:[o.geomIdx],sampleWorldMatrices:[o.sampleWorldMatrix],queryParams:o.queryParams},t[s]=u),n++}x.splice(0,r);for(var l=0;l<t.length;l++){var u=t[l];u&&(m[l].doOperation(f.initLoadContext(u)),v+=u.urls.length)}y=void 0}else y=setTimeout(i,30)}function o(e,t,n){return Math.abs(e.x-t.x)<n&&Math.abs(e.y-t.y)<n&&Math.abs(e.z-t.z)<n}function s(e,t){return(!o(E,e,.01)||!o(R,t,.01))&&(E.copy(e),R.copy(t),!0)}function l(){var e=f.renderScene.getModels(),t=!1;e.length!=L.length&&(L.length=e.length,t=!0);for(var n=0;n<e.length;n++){var r=L[n],a=e[n].id;r!==a&&(L[n]=a,t=!0)}return t}function u(){var e=n(),t=s(e.position,e.target),r=l();if(t||r)for(var a=0;a<x.length;a++)x[a].importanceNeedsUpdate=!0}t.eventTarget&&t.workerScript&&t.renderScene||e.logger.error("OtgGeomCache: Construction filed because of incomplete delegate");var f={};Object.assign(f,t),f.initLoadContext||(f.initLoadContext=gc.simpleInitLoadContext);for(var d,c={},p={},h=6,m=[],_=0;_<h;_++)m.push(f.workerScript.createWorkerWithIntercept());this.byteSize=0;var v=0,g=100,y=void 0,x=[],b=0,M=!1,S=this,T=0,A=!1,E=new Nu,R=new Nu,L=[];f.eventTarget.addEventListener(nu,r),this.dtor=function(){f.eventTarget.removeEventListener(nu,r),f=null};for(_=0;_<h;_++)m[_].addEventListenerWithIntercept(function(e){if(e.data){if(e.data.error){var t=e.data.error;(o=t.args?t.args.hash:void 0)&&(c[o]=t,S.dispatchEvent({type:ap,error:t})),delete p[t.hash],v--}else for(var n=e.data,r=0;r<n.length;r++){var a=n[r];if(a.hash&&a.mesh){w(a);var o=a.hash,s=a.geometry;c[o]=s,S.byteSize+=s.byteSize,S.cleanup(),S.dispatchEvent({type:rp,geom:s}),delete p[a.hash]}v--}x.length&&!y&&(y=setTimeout(i,0))}});this.initWorker=function(e,t,n,r){d=[];for(var a=n,i=0;i<a.length-2;i+=2){var o={geomStart:a[i],geomEnd:a[i+2],min:a[i+1],max:a[i+3],data:null,workerId:i/2%h};d.push(o)}for(i=0;i<h;i++){var s={operation:"INIT_GEOMPACK_OTG",url:e,urlOffsets:t,queryParams:r,ranges:d.filter(function(e){return e.workerId===i}),workerId:i};m[i].doOperation(f.initLoadContext(s))}},this.requestGeometry=function(e,t,n,r,a,o){var s=c[n];if(s&&s.args)this.dispatchEvent({type:ap,error:s});else if(s)this.dispatchEvent({type:rp,geom:s});else{var l=p[n];if(l&&l.refcount)return l.importanceNeedsUpdate=!0,void l.refcount++;var u=null;o&&(u=Array.from(o.elements));var f={operation:"LOAD_GEOMETRY_OTG",url:e,isCDN:t,hash:n,geomIdx:r,queryParams:a,importance:0,sampleWorldMatrix:u,importanceNeedsUpdate:!0,refcount:1};x.push(f),p[n]=f,y||(y=setTimeout(i,0))}},this.cancelRequests=function(e){for(var t in e){var n=p[t];n&&n.refcount--}for(var r=[],a=0;a<x.length;a++){var i=x[a];p[i.hash].refcount?r.push(i):delete p[i.hash]}x=r},this.updateGeomImportance=function(){var e=new Ou;return function(t,n){var r=t.getFragmentList(),a=r.getGeometry(n);if(r.getWorldBounds(n,e),a){var i=a.importance||0,o=wn(e);a.importance=Math.max(i,o)}}}(),this.cleanup=function(){var e=[];return function(){if(!(this.byteSize<104857600)){var t=f.renderScene.getModels().concat(f.renderScene.getHiddenModels());if(!A){T++;for(s=0;s<t.length;s++){var n=t[s],r=n.getData();if(n.isOTG())for(var a=r.geomMetadata.hashes.length/r.geomMetadata.byteStride,i=1;i<a;i++){o=r.getGeometryHash(i);(l=c[o])&&(l.timeStamp=T)}}e.length>0&&console.warn("OtgGeomCache.cleanup(): array must be empty");for(var o in c)(l=c[o]).timeStamp!==T&&e.push(l);e.sort(Mn);for(var s=0;s<e.length&&this.byteSize>=52428800;s++){var l=e[s];delete c[l.hash],this.byteSize-=l.byteSize,l.dispose()}s===e.length&&(A=!0),e.length=0}}}}(),this.updateRequestPriorities=function(){var e=performance.now();u();var t=f.renderScene.frustum(),r=f.renderScene.getModels();t.reset(n());var a=!1,i=0===b||x.length-b>3e3||!M;M=!i,b=x.length;for(var o=0;o<x.length;o++){var s=x[o];if(s.importanceNeedsUpdate){if(o%10==0&&performance.now()-e>10){a=!0;break}s.importanceNeedsUpdate=!1,s.importance=0;for(var l=0,d=s.hash,c=0;c<r.length;c++){var p=r[c];if(p.isOTG()){var h=p.getData(),m=h.fragments,_=m.boxes,v=h.geomMetadata.hashToIndex[d];if(v){var g=m.mesh2frag[v];if("number"==typeof g)l+=S=op(g,_,t);else if(Array.isArray(g))for(var y=0;y<g.length;y++){var w=g[y],S=op(w,_,t);l+=S}}}}if(s.importance=l,!i){for(c=o;c>0&&l>x[c-1].importance;)x[c]=x[c-1],c--;x[c]=s}}}return i&&!a&&(x.sort(Sn),M=!0),!a}}function En(e){return Math.floor(100*e.fragsLoaded/e.metadata.stats.num_fragments)}function Rn(e,t,n){throw new Error(n+" Key: "+e+" Value: "+JSON.stringify(t))}function Ln(e){return dp.indexOf(e)>=0}function Pn(e,t,n){return"bumpmap_Bitmap"===e||"unifiedbitmap_Bitmap"===e||"image"===e?n.innerMats.hasOwnProperty(t)?Fn(n.innerMats[t],n.getURL):{IMAGE_MARKER:"REMOVE",urn:t}:"surface_cutout"===e||"wood_curly_distortion_map"===e?[n.innerMats.hasOwnProperty(t)?Fn(n.innerMats[t],n.getURL):{REFERENCE_MARKER:"REMOVE",urn:t}]:{texture:[n.innerMats.hasOwnProperty(t)?Fn(n.innerMats[t],n.getURL):{REFERENCE_MARKER:"REMOVE",urn:t}]}}function In(e,t,n){if(t.hasOwnProperty("connections")){var r=t.connections;if(1===r.length)return Pn(e,r[0],n);(r.length>1||0===r.length)&&Rn(e,r,"Invalid connection.")}}function Cn(e,t){if(t.hasOwnProperty("units")){var n=t.units;if(fp.hasOwnProperty(n)&&(n=fp[n]),"cd/m^2"===n||"Lux_I"===n||""===n)return;return up.find(function(e){return e===n})||Rn(e,t,"Value contains an illegal unit."),n}}function Dn(e,t){if(t&&t.hasOwnProperty("values"))return t.values;Rn(e,t,"Missing values in key.")}function Nn(e,t){var n=Dn(e,t);if(Array.isArray(n))return n;Rn(e,t,"Expected an array value.")}function On(e,t){var n=Nn(e,t);if(1===n.length)return n[0];Rn(n,e,"Expected a single value.")}function Un(e,t){var n={};return Object.keys(e).forEach(function(r){if(hp.hasOwnProperty(r)){var a=e[r],i=hp[r];Object.keys(a).forEach(function(e){var r=e;r in _p&&(r=_p[r]),Ln(r)||(n[r]=i(e,a[e],t))})}}),n}function Fn(e,t){var n={options:{},files:{}};if(n.options.data=Un(e.properties,{innerMats:{},getURL:t,unitsProps:mp,scalarValues:!0}),e.properties.uris){var r="BumpMap"==n.options.data.protein_type?"bumpmap_Bitmap":"unifiedbitmap_Bitmap",a=On(r,e.properties.uris[r]);a&&(n.files[r]={properties:t(a),options:{title:a,description:a,name:a,uri:a}})}return n}function Vn(e,t){if(!Ef.isPrismMaterial(e))return null;if(e.userassets.length>1||0===e.userassets.length)throw new Error("Illegal asset definition. Correct number of userassets: ["+e.userassets+"]");var n=e.userassets[0];if(!e.materials||!e.materials.hasOwnProperty(n))throw new Error("Illegal asset definition. Missing user definition: ["+n+"]");var r=e.materials[n],a={type:r.definition,options:{}},i=Un(r.properties,{innerMats:e.materials,getURL:t});return i.protein_type=r.definition,i.private_tags=[r.tag,r.tag,r.tag,r.tag,r.tag],i.bumpmap_Type&&(i.bumpmap_NormalScale=i.bumpmap_NormalScale||1),"PrismWood"===a.type&&(i.hasOwnProperty("wood_curly_distortion_enable")||(i.wood_curly_distortion_enable=!1,i.wood_curly_distortion_scale=.15)),"PrismIBL"===a.type&&i.hasOwnProperty("center_angle")&&(i.center_angle.unit="radian"),a.options.data=i,a.options.tags=r.categories,a}function Bn(e){var n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new t.Color(1,1,1);if((e=(e||{}).value||{}).srgb24bit&&e.srgb24bit.length>=3){var a=e.srgb24bit.slice(0,3).map(function(e){return e/255}),i=cd(a,3),o=i[0],s=i[1],l=i[2];if(n){var u=[o,s,l].map(zn),f=cd(u,3);o=f[0],s=f[1],l=f[2]}r.setRGB(o,s,l)}else if(e.linearFloat&&e.linearFloat.length>=3){var d=e.linearFloat.slice(0,3),c=cd(d,3),p=c[0],h=c[1],m=c[2];if(!n){var _=[p,h,m].map(Gn),v=cd(_,3);p=v[0],h=v[1],m=v[2]}r.setRGB(p,h,m)}return r}function zn(e){return e<=.04045?e/12.92:Math.pow((e+.055)/1.055,2.4)}function Gn(e){return e<=.0031308?12.92*e:1.055*Math.pow(e,1/2.4)}function kn(e){return e&&e.length?e[0]:void 0}function Hn(e){return e&&e.texture?e.texture[0]:void 0}function Wn(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return e?"object"===(void 0===e?"undefined":od(e))?void 0===e.value?t:e.value:e:t}function qn(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"inch",r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=(e=e||{}).unit||n;return(e.value||r)*(yp[t]||1)/(yp[a]||1)}function jn(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=(e=e||{}).unit||"degree",a=e.value||n;return t?"degree"===r?a:180*a/Math.PI:"degree"===r?a*Math.PI/180:a}function Xn(){var e=[0,128,64,191,32,160,96,223,16,143,80,207,48,175,112,239,8,135,72,199,40,167,103,231,25,151,88,215,56,183,120,250],n=new Uint8Array(e),r=new t.DataTexture(n,32,1,t.LuminanceFormat,t.UnsignedByteType,t.UVMapping,t.RepeatWrapping,t.RepeatWrapping,t.NearestFilter,t.NearestFilter,0);r.generateMipmaps=!1,r.flipY=!1,r.needsUpdate=!0;for(var a=function(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))},i=new Uint8Array(16384),o=0;o<128;++o)for(var s=0;s<128;++s){var l=o/128*2-1,u=s/128*2-1,f=(l=Math.min(Math.max(1/128-1,l),1-1/128))-1/128,d=l+1/128,c=(u=Math.min(Math.max(1/128-1,u),1-1/128))-1/128,p=u+1/128,h=a(d,p)-a(f,p)-a(d,c)+a(f,c);i[128*o+s]=1e6*h}var m=new t.DataTexture(i,128,128,t.LuminanceFormat,t.UnsignedByteType,t.UVMapping,t.RepeatWrapping,t.RepeatWrapping,t.NearestFilter,t.NearestFilter,0);m.generateMipmaps=!1,m.flipY=!1,m.needsUpdate=!0,xp={randomNum:r,solidAngle:m}}function Yn(){var e=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],n=new Uint8Array(e),r=new t.DataTexture(n,256,1,t.LuminanceFormat,t.UnsignedByteType,t.UVMapping,t.RepeatWrapping,t.RepeatWrapping,t.NearestFilter,t.NearestFilter,0);r.generateMipmaps=!1,r.flipY=!1,r.needsUpdate=!0;var a=[225,39,122,231,29,173,15,159,75,88,233,19,179,79,72,94,54,73,151,161,171,113,221,144,127,83,168,19,88,122,62,225,109,128,246,247,172,101,61,139,211,168,64,210,224,82,87,97,119,250,201,44,242,239,154,99,126,13,44,70,246,170,100,52,135,28,187,22,207,119,199,1,235,187,55,131,190,124,222,249,236,53,225,231,71,30,173,185,153,47,79,133,225,10,140,62,17,99,100,29,137,95,142,244,76,5,83,124,38,216,253,195,44,210,148,185,188,39,78,195,132,30,60,73,92,223,133,80,230,56,118,207,79,15,251,211,111,21,79,23,240,146,150,207,3,61,103,27,148,6,31,127,235,58,173,244,116,81,34,120,192,213,188,226,97,23,16,161,106,80,242,148,35,37,91,117,51,216,97,193,126,222,39,38,133,217,215,23,237,57,205,42,222,165,126,133,33,8,227,154,27,18,56,11,192,120,80,92,236,38,210,207,128,31,135,39,123,5,49,127,107,200,34,14,153,239,134,19,248,162,58,201,159,198,243,158,72,5,138,184,222,200,34,141,233,40,195,238,191,122,171,32,66,254,229,197],i=new Uint8Array(a),o=new t.DataTexture(i,256,1,t.LuminanceFormat,t.UnsignedByteType,t.UVMapping,t.RepeatWrapping,t.RepeatWrapping,t.NearestFilter,t.NearestFilter,0);o.generateMipmaps=!1,o.flipY=!1,o.needsUpdate=!0;for(var s=function(t){return e[t%256]},l=new Array(262144),u=0;u<256;u++)for(var f=0;f<256;f++){var d=s(f)+u,c=s(d),p=s(d+1),h=s(f+1)+u,m=s(h),_=s(h+1),v=4*(256*u+f);l[v]=c,l[v+1]=p,l[v+2]=m,l[v+3]=_}var g=new Uint8Array(l),y=new t.DataTexture(g,256,256,t.RGBAFormat,t.UnsignedByteType,t.UVMapping,t.RepeatWrapping,t.RepeatWrapping,t.NearestFilter,t.NearestFilter,0);y.generateMipmaps=!1,y.flipY=!1,y.needsUpdate=!0;for(var x=[1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1,1,1,0,0,-1,1,-1,1,0,0,-1,-1],b=new Array(1024),w=0;w<256;++w){var M=e[w]%16;b[4*w]=127*x[3*M]+128,b[4*w+1]=127*x[3*M+1]+128,b[4*w+2]=127*x[3*M+2]+128,b[4*w+3]=0}var S=new Uint8Array(b),T=new t.DataTexture(S,256,1,t.RGBAFormat,t.UnsignedByteType,t.UVMapping,t.RepeatWrapping,t.RepeatWrapping,t.NearestFilter,t.NearestFilter,0);T.generateMipmaps=!1,T.flipY=!1,T.needsUpdate=!0,bp={permutation:r,gradient:o,perm2d:y,permGrad:T}}function Kn(e,n,r){var a=0,i=new t.Vector4(1,1,1,1),o=new t.Vector4(1,1,1,1),s=n.options.data["wood_"+r+"_prof"];if(s&&s.length>0){a=s.length/2;for(var l=0;l<a;l++)o.setComponent(l,1/s[2*l]),i.setComponent(l,s[2*l+1])}e["wood_"+r+"_enable"]=Wn(n.options.data["wood_"+r+"_enable"]),e["wood_"+r+"_bands"]=a,e["wood_"+r+"_weights"]=i,e["wood_"+r+"_frequencies"]=o}var Zn={name:"@adsk/wgs.js",version:"0.0.17",description:"Collection of components for three.js",license:"UNLICENSED",repository:{type:"git",url:"https://git.autodesk.com/WGS/wgs.js.git"},main:"dist/wgs.js",module:"dist/wgs.module.js",scripts:{build:"gulp",dev:"gulp develop",serve:"gulp serve",watch:"gulp watch",clean:"gulp clean",touch:"gulp touch",docs:"typedoc --out docs/ src/",test:"typings install && mocha -r ts-node/register ./tests/unittests/test*.ts",eslint:"eslint src --ext=.ts",postpublish:"gulp deploy",rollup:"node --max-old-space-size=4096 node_modules/rollup/bin/rollup"},dependencies:{"@types/three":"0.84.8","core-js":"2.5.0",xhr2:"0.1.4"},peerDependencies:{three:"0.71.0"},devDependencies:{"@types/chai":"4.0.0","@types/mocha":"2.2.41","babel-core":"6.25.0","babel-plugin-external-helpers":"6.22.0","babel-preset-es2015":"6.24.1","browser-sync":"2.18.12",chai:"4.0.2",del:"3.0.0",eslint:"3.19.0","eslint-plugin-import":"2.3.0",gulp:"3.9.1","gulp-file":"0.3.0","gulp-mirror":"1.0.0","gulp-rename":"1.2.2","gulp-replace":"0.6.1","gulp-s3-upload":"1.6.4","gulp-uglify":"3.0.0",mocha:"3.4.2",rollup:"0.50.0","rollup-plugin-babel":"2.7.1","rollup-plugin-commonjs":"8.0.2","rollup-plugin-includepaths":"0.2.2","rollup-plugin-json":"2.3.0","rollup-plugin-node-resolve":"3.0.0","rollup-plugin-typescript2":"0.8.0","run-sequence":"2.0.0",typedoc:"0.7.1",typings:"2.1.1","uglify-js":"3.0.26"},publishConfig:{registry:"https://art-bobcat.autodesk.com/artifactory/api/npm/autodesk-npm",access:"public"}},Qn=n(function(e){var t=e.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=t)}),Jn={}.hasOwnProperty,$n=function(e,t){return Jn.call(e,t)},er=function(e){try{return!!e()}catch(e){return!0}},tr=!er(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a}),nr=n(function(e){var t=e.exports={version:"2.5.0"};"number"==typeof __e&&(__e=t)}),rr=function(e){return"object"==typeof e?null!==e:"function"==typeof e},ar=function(e){if(!rr(e))throw TypeError(e+" is not an object!");return e},ir=Qn.document,or=rr(ir)&&rr(ir.createElement),sr=function(e){return or?ir.createElement(e):{}},lr=!tr&&!er(function(){return 7!=Object.defineProperty(sr("div"),"a",{get:function(){return 7}}).a}),ur=function(e,t){if(!rr(e))return e;var n,r;if(t&&"function"==typeof(n=e.toString)&&!rr(r=n.call(e)))return r;if("function"==typeof(n=e.valueOf)&&!rr(r=n.call(e)))return r;if(!t&&"function"==typeof(n=e.toString)&&!rr(r=n.call(e)))return r;throw TypeError("Can't convert object to primitive value")},fr=Object.defineProperty,dr={f:tr?Object.defineProperty:function(e,t,n){if(ar(e),t=ur(t,!0),ar(n),lr)try{return fr(e,t,n)}catch(e){}if("get"in n||"set"in n)throw TypeError("Accessors not supported!");return"value"in n&&(e[t]=n.value),e}},cr=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},pr=tr?function(e,t,n){return dr.f(e,t,cr(1,n))}:function(e,t,n){return e[t]=n,e},hr=0,mr=Math.random(),_r=function(e){return"Symbol(".concat(void 0===e?"":e,")_",(++hr+mr).toString(36))},vr=n(function(e){var t=_r("src"),n=Function.toString,r=(""+n).split("toString");nr.inspectSource=function(e){return n.call(e)},(e.exports=function(e,n,a,i){var o="function"==typeof a;o&&($n(a,"name")||pr(a,"name",n)),e[n]!==a&&(o&&($n(a,t)||pr(a,t,e[n]?""+e[n]:r.join(String(n)))),e===Qn?e[n]=a:i?e[n]?e[n]=a:pr(e,n,a):(delete e[n],pr(e,n,a)))})(Function.prototype,"toString",function(){return"function"==typeof this&&this[t]||n.call(this)})}),gr=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e},yr=function(e,t,n){if(gr(e),void 0===t)return e;switch(n){case 1:return function(n){return e.call(t,n)};case 2:return function(n,r){return e.call(t,n,r)};case 3:return function(n,r,a){return e.call(t,n,r,a)}}return function(){return e.apply(t,arguments)}},xr=function(e,t,n){var r,a,i,o,s=e&xr.F,l=e&xr.G,u=e&xr.S,f=e&xr.P,d=e&xr.B,c=l?Qn:u?Qn[t]||(Qn[t]={}):(Qn[t]||{}).prototype,p=l?nr:nr[t]||(nr[t]={}),h=p.prototype||(p.prototype={});l&&(n=t);for(r in n)i=((a=!s&&c&&void 0!==c[r])?c:n)[r],o=d&&a?yr(i,Qn):f&&"function"==typeof i?yr(Function.call,i):i,c&&vr(c,r,i,e&xr.U),p[r]!=i&&pr(p,r,o),f&&h[r]!=i&&(h[r]=i)};Qn.core=nr,xr.F=1,xr.G=2,xr.S=4,xr.P=8,xr.B=16,xr.W=32,xr.U=64,xr.R=128;var br=xr,wr=n(function(e){var t=_r("meta"),n=dr.f,r=0,a=Object.isExtensible||function(){return!0},i=!er(function(){return a(Object.preventExtensions({}))}),o=function(e){n(e,t,{value:{i:"O"+ ++r,w:{}}})},s=e.exports={KEY:t,NEED:!1,fastKey:function(e,n){if(!rr(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!$n(e,t)){if(!a(e))return"F";if(!n)return"E";o(e)}return e[t].i},getWeak:function(e,n){if(!$n(e,t)){if(!a(e))return!0;if(!n)return!1;o(e)}return e[t].w},onFreeze:function(e){return i&&s.NEED&&a(e)&&!$n(e,t)&&o(e),e}}}),Mr=Qn["__core-js_shared__"]||(Qn["__core-js_shared__"]={}),Sr=function(e){return Mr[e]||(Mr[e]={})},Tr=n(function(e){var t=Sr("wks"),n=Qn.Symbol,r="function"==typeof n;(e.exports=function(e){return t[e]||(t[e]=r&&n[e]||(r?n:_r)("Symbol."+e))}).store=t}),Ar=dr.f,Er=Tr("toStringTag"),Rr=function(e,t,n){e&&!$n(e=n?e:e.prototype,Er)&&Ar(e,Er,{configurable:!0,value:t})},Lr={f:Tr},Pr=dr.f,Ir={}.toString,Cr=function(e){return Ir.call(e).slice(8,-1)},Dr=Object("z").propertyIsEnumerable(0)?Object:function(e){return"String"==Cr(e)?e.split(""):Object(e)},Nr=function(e){if(void 0==e)throw TypeError("Can't call method on  "+e);return e},Or=function(e){return Dr(Nr(e))},Ur=Math.ceil,Fr=Math.floor,Vr=function(e){return isNaN(e=+e)?0:(e>0?Fr:Ur)(e)},Br=Math.min,zr=function(e){return e>0?Br(Vr(e),9007199254740991):0},Gr=Math.max,kr=Math.min,Hr=function(e,t){return(e=Vr(e))<0?Gr(e+t,0):kr(e,t)},Wr=function(e){return function(t,n,r){var a,i=Or(t),o=zr(i.length),s=Hr(r,o);if(e&&n!=n){for(;o>s;)if((a=i[s++])!=a)return!0}else for(;o>s;s++)if((e||s in i)&&i[s]===n)return e||s||0;return!e&&-1}},qr=Sr("keys"),jr=function(e){return qr[e]||(qr[e]=_r(e))},Xr=Wr(!1),Yr=jr("IE_PROTO"),Kr=function(e,t){var n,r=Or(e),a=0,i=[];for(n in r)n!=Yr&&$n(r,n)&&i.push(n);for(;t.length>a;)$n(r,n=t[a++])&&(~Xr(i,n)||i.push(n));return i},Zr="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(","),Qr=Object.keys||function(e){return Kr(e,Zr)},Jr=function(e,t){for(var n,r=Or(e),a=Qr(r),i=a.length,o=0;i>o;)if(r[n=a[o++]]===t)return n},$r={f:Object.getOwnPropertySymbols},ea={f:{}.propertyIsEnumerable},ta=function(e){var t=Qr(e),n=$r.f;if(n)for(var r,a=n(e),i=ea.f,o=0;a.length>o;)i.call(e,r=a[o++])&&t.push(r);return t},na=Array.isArray||function(e){return"Array"==Cr(e)},ra=tr?Object.defineProperties:function(e,t){ar(e);for(var n,r=Qr(t),a=r.length,i=0;a>i;)dr.f(e,n=r[i++],t[n]);return e},aa=Qn.document,ia=aa&&aa.documentElement,oa=jr("IE_PROTO"),sa=function(){},la=function(){var e,t=sr("iframe"),n=Zr.length;for(t.style.display="none",ia.appendChild(t),t.src="javascript:",(e=t.contentWindow.document).open(),e.write("<script>document.F=Object<\/script>"),e.close(),la=e.F;n--;)delete la.prototype[Zr[n]];return la()},ua=Object.create||function(e,t){var n;return null!==e?(sa.prototype=ar(e),n=new sa,sa.prototype=null,n[oa]=e):n=la(),void 0===t?n:ra(n,t)},fa=Zr.concat("length","prototype"),da={f:Object.getOwnPropertyNames||function(e){return Kr(e,fa)}},ca=da.f,pa={}.toString,ha="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],ma=function(e){try{return ca(e)}catch(e){return ha.slice()}},_a={f:function(e){return ha&&"[object Window]"==pa.call(e)?ma(e):ca(Or(e))}},va=Object.getOwnPropertyDescriptor,ga={f:tr?va:function(e,t){if(e=Or(e),t=ur(t,!0),lr)try{return va(e,t)}catch(e){}if($n(e,t))return cr(!ea.f.call(e,t),e[t])}},ya=wr.KEY,xa=ga.f,ba=dr.f,wa=_a.f,Ma=Qn.Symbol,Sa=Qn.JSON,Ta=Sa&&Sa.stringify,Aa=Tr("_hidden"),Ea=Tr("toPrimitive"),Ra={}.propertyIsEnumerable,La=Sr("symbol-registry"),Pa=Sr("symbols"),Ia=Sr("op-symbols"),Ca=Object.prototype,Da="function"==typeof Ma,Na=Qn.QObject,Oa=!Na||!Na.prototype||!Na.prototype.findChild,Ua=tr&&er(function(){return 7!=ua(ba({},"a",{get:function(){return ba(this,"a",{value:7}).a}})).a})?function(e,t,n){var r=xa(Ca,t);r&&delete Ca[t],ba(e,t,n),r&&e!==Ca&&ba(Ca,t,r)}:ba,Fa=function(e){var t=Pa[e]=ua(Ma.prototype);return t._k=e,t},Va=Da&&"symbol"==typeof Ma.iterator?function(e){return"symbol"==typeof e}:function(e){return e instanceof Ma},Ba=function(e,t,n){return e===Ca&&Ba(Ia,t,n),ar(e),t=ur(t,!0),ar(n),$n(Pa,t)?(n.enumerable?($n(e,Aa)&&e[Aa][t]&&(e[Aa][t]=!1),n=ua(n,{enumerable:cr(0,!1)})):($n(e,Aa)||ba(e,Aa,cr(1,{})),e[Aa][t]=!0),Ua(e,t,n)):ba(e,t,n)},za=function(e,t){ar(e);for(var n,r=ta(t=Or(t)),a=0,i=r.length;i>a;)Ba(e,n=r[a++],t[n]);return e},Ga=function(e){var t=Ra.call(this,e=ur(e,!0));return!(this===Ca&&$n(Pa,e)&&!$n(Ia,e))&&(!(t||!$n(this,e)||!$n(Pa,e)||$n(this,Aa)&&this[Aa][e])||t)},ka=function(e,t){if(e=Or(e),t=ur(t,!0),e!==Ca||!$n(Pa,t)||$n(Ia,t)){var n=xa(e,t);return!n||!$n(Pa,t)||$n(e,Aa)&&e[Aa][t]||(n.enumerable=!0),n}},Ha=function(e){for(var t,n=wa(Or(e)),r=[],a=0;n.length>a;)$n(Pa,t=n[a++])||t==Aa||t==ya||r.push(t);return r},Wa=function(e){for(var t,n=e===Ca,r=wa(n?Ia:Or(e)),a=[],i=0;r.length>i;)!$n(Pa,t=r[i++])||n&&!$n(Ca,t)||a.push(Pa[t]);return a};Da||(vr((Ma=function(){if(this instanceof Ma)throw TypeError("Symbol is not a constructor!");var e=_r(arguments.length>0?arguments[0]:void 0),t=function(n){this===Ca&&t.call(Ia,n),$n(this,Aa)&&$n(this[Aa],e)&&(this[Aa][e]=!1),Ua(this,e,cr(1,n))};return tr&&Oa&&Ua(Ca,e,{configurable:!0,set:t}),Fa(e)}).prototype,"toString",function(){return this._k}),ga.f=ka,dr.f=Ba,da.f=_a.f=Ha,ea.f=Ga,$r.f=Wa,tr&&vr(Ca,"propertyIsEnumerable",Ga,!0),Lr.f=function(e){return Fa(Tr(e))}),br(br.G+br.W+br.F*!Da,{Symbol:Ma});for(var qa="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),ja=0;qa.length>ja;)Tr(qa[ja++]);for(var Xa=Qr(Tr.store),Ya=0;Xa.length>Ya;)!function(e){var t=nr.Symbol||(nr.Symbol=Qn.Symbol||{});"_"==e.charAt(0)||e in t||Pr(t,e,{value:Lr.f(e)})}(Xa[Ya++]);br(br.S+br.F*!Da,"Symbol",{for:function(e){return $n(La,e+="")?La[e]:La[e]=Ma(e)},keyFor:function(e){if(Va(e))return Jr(La,e);throw TypeError(e+" is not a symbol!")},useSetter:function(){Oa=!0},useSimple:function(){Oa=!1}}),br(br.S+br.F*!Da,"Object",{create:function(e,t){return void 0===t?ua(e):za(ua(e),t)},defineProperty:Ba,defineProperties:za,getOwnPropertyDescriptor:ka,getOwnPropertyNames:Ha,getOwnPropertySymbols:Wa}),Sa&&br(br.S+br.F*(!Da||er(function(){var e=Ma();return"[null]"!=Ta([e])||"{}"!=Ta({a:e})||"{}"!=Ta(Object(e))})),"JSON",{stringify:function(e){if(void 0!==e&&!Va(e)){for(var t,n,r=[e],a=1;arguments.length>a;)r.push(arguments[a++]);return"function"==typeof(t=r[1])&&(n=t),!n&&na(t)||(t=function(e,t){if(n&&(t=n.call(this,e,t)),!Va(t))return t}),r[1]=t,Ta.apply(Sa,r)}}}),Ma.prototype[Ea]||pr(Ma.prototype,Ea,Ma.prototype.valueOf),Rr(Ma,"Symbol"),Rr(Math,"Math",!0),Rr(Qn.JSON,"JSON",!0);var Ka=Tr("toStringTag"),Za="Arguments"==Cr(function(){return arguments}()),Qa=function(e,t){try{return e[t]}catch(e){}},Ja=function(e){var t,n,r;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(n=Qa(t=Object(e),Ka))?n:Za?Cr(t):"Object"==(r=Cr(t))&&"function"==typeof t.callee?"Arguments":r},$a={};$a[Tr("toStringTag")]="z",$a+""!="[object z]"&&vr(Object.prototype,"toString",function(){return"[object "+Ja(this)+"]"},!0);var ei={},ti={};pr(ti,Tr("iterator"),function(){return this});var ni=function(e,t,n){e.prototype=ua(ti,{next:cr(1,n)}),Rr(e,t+" Iterator")},ri=function(e){return Object(Nr(e))},ai=jr("IE_PROTO"),ii=Object.prototype,oi=Object.getPrototypeOf||function(e){return e=ri(e),$n(e,ai)?e[ai]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?ii:null},si=Tr("iterator"),li=!([].keys&&"next"in[].keys()),ui=function(){return this},fi=function(e,t,n,r,a,i,o){ni(n,t,r);var s,l,u,f=function(e){if(!li&&e in h)return h[e];switch(e){case"keys":case"values":return function(){return new n(this,e)}}return function(){return new n(this,e)}},d=t+" Iterator",c="values"==a,p=!1,h=e.prototype,m=h[si]||h["@@iterator"]||a&&h[a],_=m||f(a),v=a?c?f("entries"):_:void 0,g="Array"==t?h.entries||m:m;if(g&&(u=oi(g.call(new e)))!==Object.prototype&&u.next&&(Rr(u,d,!0),$n(u,si)||pr(u,si,ui)),c&&m&&"values"!==m.name&&(p=!0,_=function(){return m.call(this)}),(li||p||!h[si])&&pr(h,si,_),ei[t]=_,ei[d]=ui,a)if(s={values:c?_:f("values"),keys:i?_:f("keys"),entries:v},o)for(l in s)l in h||vr(h,l,s[l]);else br(br.P+br.F*(li||p),t,s);return s},di=function(e){return function(t,n){var r,a,i=String(Nr(t)),o=Vr(n),s=i.length;return o<0||o>=s?e?"":void 0:(r=i.charCodeAt(o))<55296||r>56319||o+1===s||(a=i.charCodeAt(o+1))<56320||a>57343?e?i.charAt(o):r:e?i.slice(o,o+2):a-56320+(r-55296<<10)+65536}}(!0);fi(String,"String",function(e){this._t=String(e),this._i=0},function(){var e,t=this._t,n=this._i;return n>=t.length?{value:void 0,done:!0}:(e=di(t,n),this._i+=e.length,{value:e,done:!1})}),br(br.S,"Array",{isArray:na});var ci=function(e,t,n,r){try{return r?t(ar(n)[0],n[1]):t(n)}catch(t){var a=e.return;throw void 0!==a&&ar(a.call(e)),t}},pi=Tr("iterator"),hi=Array.prototype,mi=function(e){return void 0!==e&&(ei.Array===e||hi[pi]===e)},_i=function(e,t,n){t in e?dr.f(e,t,cr(0,n)):e[t]=n},vi=Tr("iterator"),gi=nr.getIteratorMethod=function(e){if(void 0!=e)return e[vi]||e["@@iterator"]||ei[Ja(e)]},yi=Tr("iterator"),xi=!1;try{[7][yi]().return=function(){xi=!0}}catch(e){}var bi=function(e,t){if(!t&&!xi)return!1;var n=!1;try{var r=[7],a=r[yi]();a.next=function(){return{done:n=!0}},r[yi]=function(){return a},e(r)}catch(e){}return n};br(br.S+br.F*!bi(function(e){}),"Array",{from:function(e){var t,n,r,a,i=ri(e),o="function"==typeof this?this:Array,s=arguments.length,l=s>1?arguments[1]:void 0,u=void 0!==l,f=0,d=gi(i);if(u&&(l=yr(l,s>2?arguments[2]:void 0,2)),void 0==d||o==Array&&mi(d))for(n=new o(t=zr(i.length));t>f;f++)_i(n,f,u?l(i[f],f):i[f]);else for(a=d.call(i),n=new o;!(r=a.next()).done;f++)_i(n,f,u?ci(a,l,[r.value,f],!0):r.value);return n.length=f,n}}),br(br.S+br.F*er(function(){function e(){}return!(Array.of.call(e)instanceof e)}),"Array",{of:function(){for(var e=0,t=arguments.length,n=new("function"==typeof this?this:Array)(t);t>e;)_i(n,e,arguments[e++]);return n.length=t,n}});var wi=function(e,t){return!!e&&er(function(){t?e.call(null,function(){},1):e.call(null)})},Mi=[].join;br(br.P+br.F*(Dr!=Object||!wi(Mi)),"Array",{join:function(e){return Mi.call(Or(this),void 0===e?",":e)}});var Si=[].slice;br(br.P+br.F*er(function(){ia&&Si.call(ia)}),"Array",{slice:function(e,t){var n=zr(this.length),r=Cr(this);if(t=void 0===t?n:t,"Array"==r)return Si.call(this,e,t);for(var a=Hr(e,n),i=Hr(t,n),o=zr(i-a),s=Array(o),l=0;l<o;l++)s[l]="String"==r?this.charAt(a+l):this[a+l];return s}});var Ti=[].sort,Ai=[1,2,3];br(br.P+br.F*(er(function(){Ai.sort(void 0)})||!er(function(){Ai.sort(null)})||!wi(Ti)),"Array",{sort:function(e){return void 0===e?Ti.call(ri(this)):Ti.call(ri(this),gr(e))}});var Ei=Tr("species"),Ri=function(e){var t;return na(e)&&("function"!=typeof(t=e.constructor)||t!==Array&&!na(t.prototype)||(t=void 0),rr(t)&&null===(t=t[Ei])&&(t=void 0)),void 0===t?Array:t},Li=function(e,t){return new(Ri(e))(t)},Pi=function(e,t){var n=1==e,r=2==e,a=3==e,i=4==e,o=6==e,s=5==e||o,l=t||Li;return function(t,u,f){for(var d,c,p=ri(t),h=Dr(p),m=yr(u,f,3),_=zr(h.length),v=0,g=n?l(t,_):r?l(t,0):void 0;_>v;v++)if((s||v in h)&&(d=h[v],c=m(d,v,p),e))if(n)g[v]=c;else if(c)switch(e){case 3:return!0;case 5:return d;case 6:return v;case 2:g.push(d)}else if(i)return!1;return o?-1:a||i?i:g}},Ii=Pi(0),Ci=wi([].forEach,!0);br(br.P+br.F*!Ci,"Array",{forEach:function(e){return Ii(this,e,arguments[1])}});var Di=Pi(1);br(br.P+br.F*!wi([].map,!0),"Array",{map:function(e){return Di(this,e,arguments[1])}});var Ni=Pi(2);br(br.P+br.F*!wi([].filter,!0),"Array",{filter:function(e){return Ni(this,e,arguments[1])}});var Oi=Pi(3);br(br.P+br.F*!wi([].some,!0),"Array",{some:function(e){return Oi(this,e,arguments[1])}});var Ui=Pi(4);br(br.P+br.F*!wi([].every,!0),"Array",{every:function(e){return Ui(this,e,arguments[1])}});var Fi=function(e,t,n,r,a){gr(t);var i=ri(e),o=Dr(i),s=zr(i.length),l=a?s-1:0,u=a?-1:1;if(n<2)for(;;){if(l in o){r=o[l],l+=u;break}if(l+=u,a?l<0:s<=l)throw TypeError("Reduce of empty array with no initial value")}for(;a?l>=0:s>l;l+=u)l in o&&(r=t(r,o[l],l,i));return r};br(br.P+br.F*!wi([].reduce,!0),"Array",{reduce:function(e){return Fi(this,e,arguments.length,arguments[1],!1)}}),br(br.P+br.F*!wi([].reduceRight,!0),"Array",{reduceRight:function(e){return Fi(this,e,arguments.length,arguments[1],!0)}});var Vi=Wr(!1),Bi=[].indexOf,zi=!!Bi&&1/[1].indexOf(1,-0)<0;br(br.P+br.F*(zi||!wi(Bi)),"Array",{indexOf:function(e){return zi?Bi.apply(this,arguments)||0:Vi(this,e,arguments[1])}});var Gi=[].lastIndexOf,ki=!!Gi&&1/[1].lastIndexOf(1,-0)<0;br(br.P+br.F*(ki||!wi(Gi)),"Array",{lastIndexOf:function(e){if(ki)return Gi.apply(this,arguments)||0;var t=Or(this),n=zr(t.length),r=n-1;for(arguments.length>1&&(r=Math.min(r,Vr(arguments[1]))),r<0&&(r=n+r);r>=0;r--)if(r in t&&t[r]===e)return r||0;return-1}});var Hi=[].copyWithin||function(e,t){var n=ri(this),r=zr(n.length),a=Hr(e,r),i=Hr(t,r),o=arguments.length>2?arguments[2]:void 0,s=Math.min((void 0===o?r:Hr(o,r))-i,r-a),l=1;for(i<a&&a<i+s&&(l=-1,i+=s-1,a+=s-1);s-- >0;)i in n?n[a]=n[i]:delete n[a],a+=l,i+=l;return n},Wi=Tr("unscopables"),qi=Array.prototype;void 0==qi[Wi]&&pr(qi,Wi,{});var ji=function(e){qi[Wi][e]=!0};br(br.P,"Array",{copyWithin:Hi}),ji("copyWithin");var Xi=function(e){for(var t=ri(this),n=zr(t.length),r=arguments.length,a=Hr(r>1?arguments[1]:void 0,n),i=r>2?arguments[2]:void 0,o=void 0===i?n:Hr(i,n);o>a;)t[a++]=e;return t};br(br.P,"Array",{fill:Xi}),ji("fill");var Yi=Pi(5),Ki=!0;"find"in[]&&Array(1).find(function(){Ki=!1}),br(br.P+br.F*Ki,"Array",{find:function(e){return Yi(this,e,arguments.length>1?arguments[1]:void 0)}}),ji("find");var Zi=Pi(6),Qi=!0;"findIndex"in[]&&Array(1).findIndex(function(){Qi=!1}),br(br.P+br.F*Qi,"Array",{findIndex:function(e){return Zi(this,e,arguments.length>1?arguments[1]:void 0)}}),ji("findIndex");var Ji=Tr("species"),$i=function(e){var t=Qn[e];tr&&t&&!t[Ji]&&dr.f(t,Ji,{configurable:!0,get:function(){return this}})};$i("Array");var eo=function(e,t){return{value:t,done:!!e}},to=fi(Array,"Array",function(e,t){this._t=Or(e),this._i=0,this._k=t},function(){var e=this._t,t=this._k,n=this._i++;return!e||n>=e.length?(this._t=void 0,eo(1)):"keys"==t?eo(0,n):"values"==t?eo(0,e[n]):eo(0,[n,e[n]])},"values");ei.Arguments=ei.Array,ji("keys"),ji("values"),ji("entries");for(var no,ro=_r("typed_array"),ao=_r("view"),io=!(!Qn.ArrayBuffer||!Qn.DataView),oo=io,so=0,lo="Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array".split(",");so<9;)(no=Qn[lo[so++]])?(pr(no.prototype,ro,!0),pr(no.prototype,ao,!0)):oo=!1;var uo={ABV:io,CONSTR:oo,TYPED:ro,VIEW:ao},fo=function(e,t,n){for(var r in t)vr(e,r,t[r],n);return e},co=function(e,t,n,r){if(!(e instanceof t)||void 0!==r&&r in e)throw TypeError(n+": incorrect invocation!");return e},po=function(e){if(void 0===e)return 0;var t=Vr(e),n=zr(t);if(t!==n)throw RangeError("Wrong length!");return n},ho=n(function(e,t){function n(e,t,n){var r,a,i,o=Array(n),s=8*n-t-1,l=(1<<s)-1,u=l>>1,f=23===t?S(2,-24)-S(2,-77):0,d=0,c=e<0||0===e&&1/e<0?1:0;for((e=M(e))!=e||e===b?(a=e!=e?1:0,r=l):(r=T(A(e)/E),e*(i=S(2,-r))<1&&(r--,i*=2),(e+=r+u>=1?f/i:f*S(2,1-u))*i>=2&&(r++,i/=2),r+u>=l?(a=0,r=l):r+u>=1?(a=(e*i-1)*S(2,t),r+=u):(a=e*S(2,u-1)*S(2,t),r=0));t>=8;o[d++]=255&a,a/=256,t-=8);for(r=r<<t|a,s+=t;s>0;o[d++]=255&r,r/=256,s-=8);return o[--d]|=128*c,o}function r(e,t,n){var r,a=8*n-t-1,i=(1<<a)-1,o=i>>1,s=a-7,l=n-1,u=e[l--],f=127&u;for(u>>=7;s>0;f=256*f+e[l],l--,s-=8);for(r=f&(1<<-s)-1,f>>=-s,s+=t;s>0;r=256*r+e[l],l--,s-=8);if(0===f)f=1-o;else{if(f===i)return r?NaN:u?-b:b;r+=S(2,t),f-=o}return(u?-1:1)*r*S(2,f-t)}function a(e){return e[3]<<24|e[2]<<16|e[1]<<8|e[0]}function i(e){return[255&e]}function o(e){return[255&e,e>>8&255]}function s(e){return[255&e,e>>8&255,e>>16&255,e>>24&255]}function l(e){return n(e,52,8)}function u(e){return n(e,23,4)}function f(e,t,n){h(e[m],t,{get:function(){return this[n]}})}function d(e,t,n,r){var a=po(+n);if(a+t>e[L])throw x(_);var i=e[R]._b,o=a+e[P],s=i.slice(o,o+t);return r?s:s.reverse()}function c(e,t,n,r,a,i){var o=po(+n);if(o+t>e[L])throw x(_);for(var s=e[R]._b,l=o+e[P],u=r(+a),f=0;f<t;f++)s[l+f]=u[i?f:t-f-1]}var p=da.f,h=dr.f,m="prototype",_="Wrong index!",v=Qn.ArrayBuffer,g=Qn.DataView,y=Qn.Math,x=Qn.RangeError,b=Qn.Infinity,w=v,M=y.abs,S=y.pow,T=y.floor,A=y.log,E=y.LN2,R=tr?"_b":"buffer",L=tr?"_l":"byteLength",P=tr?"_o":"byteOffset";if(uo.ABV){if(!er(function(){v(1)})||!er(function(){new v(-1)})||er(function(){return new v,new v(1.5),new v(NaN),"ArrayBuffer"!=v.name})){for(var I,C=(v=function(e){return co(this,v),new w(po(e))})[m]=w[m],D=p(w),N=0;D.length>N;)(I=D[N++])in v||pr(v,I,w[I]);C.constructor=v}var O=new g(new v(2)),U=g[m].setInt8;O.setInt8(0,2147483648),O.setInt8(1,2147483649),!O.getInt8(0)&&O.getInt8(1)||fo(g[m],{setInt8:function(e,t){U.call(this,e,t<<24>>24)},setUint8:function(e,t){U.call(this,e,t<<24>>24)}},!0)}else v=function(e){co(this,v,"ArrayBuffer");var t=po(e);this._b=Xi.call(Array(t),0),this[L]=t},g=function(e,t,n){co(this,g,"DataView"),co(e,v,"DataView");var r=e[L],a=Vr(t);if(a<0||a>r)throw x("Wrong offset!");if(n=void 0===n?r-a:zr(n),a+n>r)throw x("Wrong length!");this[R]=e,this[P]=a,this[L]=n},tr&&(f(v,"byteLength","_l"),f(g,"buffer","_b"),f(g,"byteLength","_l"),f(g,"byteOffset","_o")),fo(g[m],{getInt8:function(e){return d(this,1,e)[0]<<24>>24},getUint8:function(e){return d(this,1,e)[0]},getInt16:function(e){var t=d(this,2,e,arguments[1]);return(t[1]<<8|t[0])<<16>>16},getUint16:function(e){var t=d(this,2,e,arguments[1]);return t[1]<<8|t[0]},getInt32:function(e){return a(d(this,4,e,arguments[1]))},getUint32:function(e){return a(d(this,4,e,arguments[1]))>>>0},getFloat32:function(e){return r(d(this,4,e,arguments[1]),23,4)},getFloat64:function(e){return r(d(this,8,e,arguments[1]),52,8)},setInt8:function(e,t){c(this,1,e,i,t)},setUint8:function(e,t){c(this,1,e,i,t)},setInt16:function(e,t){c(this,2,e,o,t,arguments[2])},setUint16:function(e,t){c(this,2,e,o,t,arguments[2])},setInt32:function(e,t){c(this,4,e,s,t,arguments[2])},setUint32:function(e,t){c(this,4,e,s,t,arguments[2])},setFloat32:function(e,t){c(this,4,e,u,t,arguments[2])},setFloat64:function(e,t){c(this,8,e,l,t,arguments[2])}});Rr(v,"ArrayBuffer"),Rr(g,"DataView"),pr(g[m],uo.VIEW,!0),t.ArrayBuffer=v,t.DataView=g}),mo=Tr("species"),_o=function(e,t){var n,r=ar(e).constructor;return void 0===r||void 0==(n=ar(r)[mo])?t:gr(n)},vo=Qn.ArrayBuffer,go=ho.ArrayBuffer,yo=ho.DataView,xo=uo.ABV&&vo.isView,bo=go.prototype.slice,wo=uo.VIEW;br(br.G+br.W+br.F*(vo!==go),{ArrayBuffer:go}),br(br.S+br.F*!uo.CONSTR,"ArrayBuffer",{isView:function(e){return xo&&xo(e)||rr(e)&&wo in e}}),br(br.P+br.U+br.F*er(function(){return!new go(2).slice(1,void 0).byteLength}),"ArrayBuffer",{slice:function(e,t){if(void 0!==bo&&void 0===t)return bo.call(ar(this),e);for(var n=ar(this).byteLength,r=Hr(e,n),a=Hr(void 0===t?n:t,n),i=new(_o(this,go))(zr(a-r)),o=new yo(this),s=new yo(i),l=0;r<a;)s.setUint8(l++,o.getUint8(r++));return i}}),$i("ArrayBuffer"),br(br.G+br.W+br.F*!uo.ABV,{DataView:ho.DataView});var Mo=n(function(e){if(tr){var t=Qn,n=er,r=br,a=uo,i=ho,o=yr,s=co,l=cr,u=pr,f=fo,d=Vr,c=zr,p=po,h=Hr,m=ur,_=$n,v=Ja,g=rr,y=ri,x=mi,b=ua,w=oi,M=da.f,S=gi,T=_r,A=Tr,E=Pi,R=Wr,L=_o,P=to,I=ei,C=bi,D=$i,N=Xi,O=Hi,U=dr,F=ga,V=U.f,B=F.f,z=t.RangeError,G=t.TypeError,k=t.Uint8Array,H=Array.prototype,W=i.ArrayBuffer,q=i.DataView,j=E(0),X=E(2),Y=E(3),K=E(4),Z=E(5),Q=E(6),J=R(!0),$=R(!1),ee=P.values,te=P.keys,ne=P.entries,re=H.lastIndexOf,ae=H.reduce,ie=H.reduceRight,oe=H.join,se=H.sort,le=H.slice,ue=H.toString,fe=H.toLocaleString,de=A("iterator"),ce=A("toStringTag"),pe=T("typed_constructor"),he=T("def_constructor"),me=a.CONSTR,_e=a.TYPED,ve=a.VIEW,ge=E(1,function(e,t){return Me(L(e,e[he]),t)}),ye=n(function(){return 1===new k(new Uint16Array([1]).buffer)[0]}),xe=!!k&&!!k.prototype.set&&n(function(){new k(1).set({})}),be=function(e,t){var n=d(e);if(n<0||n%t)throw z("Wrong offset!");return n},we=function(e){if(g(e)&&_e in e)return e;throw G(e+" is not a typed array!")},Me=function(e,t){if(!(g(e)&&pe in e))throw G("It is not a typed array constructor!");return new e(t)},Se=function(e,t){return Te(L(e,e[he]),t)},Te=function(e,t){for(var n=0,r=t.length,a=Me(e,r);r>n;)a[n]=t[n++];return a},Ae=function(e,t,n){V(e,t,{get:function(){return this._d[n]}})},Ee=function(e){var t,n,r,a,i,s,l=y(e),u=arguments.length,f=u>1?arguments[1]:void 0,d=void 0!==f,p=S(l);if(void 0!=p&&!x(p)){for(s=p.call(l),r=[],t=0;!(i=s.next()).done;t++)r.push(i.value);l=r}for(d&&u>2&&(f=o(f,arguments[2],2)),t=0,n=c(l.length),a=Me(this,n);n>t;t++)a[t]=d?f(l[t],t):l[t];return a},Re=function(){for(var e=0,t=arguments.length,n=Me(this,t);t>e;)n[e]=arguments[e++];return n},Le=!!k&&n(function(){fe.call(new k(1))}),Pe=function(){return fe.apply(Le?le.call(we(this)):we(this),arguments)},Ie={copyWithin:function(e,t){return O.call(we(this),e,t,arguments.length>2?arguments[2]:void 0)},every:function(e){return K(we(this),e,arguments.length>1?arguments[1]:void 0)},fill:function(e){return N.apply(we(this),arguments)},filter:function(e){return Se(this,X(we(this),e,arguments.length>1?arguments[1]:void 0))},find:function(e){return Z(we(this),e,arguments.length>1?arguments[1]:void 0)},findIndex:function(e){return Q(we(this),e,arguments.length>1?arguments[1]:void 0)},forEach:function(e){j(we(this),e,arguments.length>1?arguments[1]:void 0)},indexOf:function(e){return $(we(this),e,arguments.length>1?arguments[1]:void 0)},includes:function(e){return J(we(this),e,arguments.length>1?arguments[1]:void 0)},join:function(e){return oe.apply(we(this),arguments)},lastIndexOf:function(e){return re.apply(we(this),arguments)},map:function(e){return ge(we(this),e,arguments.length>1?arguments[1]:void 0)},reduce:function(e){return ae.apply(we(this),arguments)},reduceRight:function(e){return ie.apply(we(this),arguments)},reverse:function(){for(var e,t=this,n=we(t).length,r=Math.floor(n/2),a=0;a<r;)e=t[a],t[a++]=t[--n],t[n]=e;return t},some:function(e){return Y(we(this),e,arguments.length>1?arguments[1]:void 0)},sort:function(e){return se.call(we(this),e)},subarray:function(e,t){var n=we(this),r=n.length,a=h(e,r);return new(L(n,n[he]))(n.buffer,n.byteOffset+a*n.BYTES_PER_ELEMENT,c((void 0===t?r:h(t,r))-a))}},Ce=function(e,t){return Se(this,le.call(we(this),e,t))},De=function(e){we(this);var t=be(arguments[1],1),n=this.length,r=y(e),a=c(r.length),i=0;if(a+t>n)throw z("Wrong length!");for(;i<a;)this[t+i]=r[i++]},Ne={entries:function(){return ne.call(we(this))},keys:function(){return te.call(we(this))},values:function(){return ee.call(we(this))}},Oe=function(e,t){return g(e)&&e[_e]&&"symbol"!=typeof t&&t in e&&String(+t)==String(t)},Ue=function(e,t){return Oe(e,t=m(t,!0))?l(2,e[t]):B(e,t)},Fe=function(e,t,n){return!(Oe(e,t=m(t,!0))&&g(n)&&_(n,"value"))||_(n,"get")||_(n,"set")||n.configurable||_(n,"writable")&&!n.writable||_(n,"enumerable")&&!n.enumerable?V(e,t,n):(e[t]=n.value,e)};me||(F.f=Ue,U.f=Fe),r(r.S+r.F*!me,"Object",{getOwnPropertyDescriptor:Ue,defineProperty:Fe}),n(function(){ue.call({})})&&(ue=fe=function(){return oe.call(this)});var Ve=f({},Ie);f(Ve,Ne),u(Ve,de,Ne.values),f(Ve,{slice:Ce,set:De,constructor:function(){},toString:ue,toLocaleString:Pe}),Ae(Ve,"buffer","b"),Ae(Ve,"byteOffset","o"),Ae(Ve,"byteLength","l"),Ae(Ve,"length","e"),V(Ve,ce,{get:function(){return this[_e]}}),e.exports=function(e,i,o,l){var f=e+((l=!!l)?"Clamped":"")+"Array",d="get"+e,h="set"+e,m=t[f],_=m||{},y=m&&w(m),x=!m||!a.ABV,S={},T=m&&m.prototype,A=function(e,t){var n=e._d;return n.v[d](t*i+n.o,ye)},E=function(e,t,n){var r=e._d;l&&(n=(n=Math.round(n))<0?0:n>255?255:255&n),r.v[h](t*i+r.o,n,ye)},R=function(e,t){V(e,t,{get:function(){return A(this,t)},set:function(e){return E(this,t,e)},enumerable:!0})};x?(m=o(function(e,t,n,r){s(e,m,f,"_d");var a,o,l,d,h=0,_=0;if(g(t)){if(!(t instanceof W||"ArrayBuffer"==(d=v(t))||"SharedArrayBuffer"==d))return _e in t?Te(m,t):Ee.call(m,t);a=t,_=be(n,i);var y=t.byteLength;if(void 0===r){if(y%i)throw z("Wrong length!");if((o=y-_)<0)throw z("Wrong length!")}else if((o=c(r)*i)+_>y)throw z("Wrong length!");l=o/i}else l=p(t),a=new W(o=l*i);for(u(e,"_d",{b:a,o:_,l:o,e:l,v:new q(a)});h<l;)R(e,h++)}),T=m.prototype=b(Ve),u(T,"constructor",m)):n(function(){m(1)})&&n(function(){new m(-1)})&&C(function(e){new m,new m(null),new m(1.5),new m(e)},!0)||(m=o(function(e,t,n,r){s(e,m,f);var a;return g(t)?t instanceof W||"ArrayBuffer"==(a=v(t))||"SharedArrayBuffer"==a?void 0!==r?new _(t,be(n,i),r):void 0!==n?new _(t,be(n,i)):new _(t):_e in t?Te(m,t):Ee.call(m,t):new _(p(t))}),j(y!==Function.prototype?M(_).concat(M(y)):M(_),function(e){e in m||u(m,e,_[e])}),m.prototype=T,T.constructor=m);var L=T[de],P=!!L&&("values"==L.name||void 0==L.name),N=Ne.values;u(m,pe,!0),u(T,_e,f),u(T,ve,!0),u(T,he,m),(l?new m(1)[ce]==f:ce in T)||V(T,ce,{get:function(){return f}}),S[f]=m,r(r.G+r.W+r.F*(m!=_),S),r(r.S,f,{BYTES_PER_ELEMENT:i}),r(r.S+r.F*n(function(){_.of.call(m,1)}),f,{from:Ee,of:Re}),"BYTES_PER_ELEMENT"in T||u(T,"BYTES_PER_ELEMENT",i),r(r.P,f,Ie),D(f),r(r.P+r.F*xe,f,{set:De}),r(r.P+r.F*!P,f,Ne),T.toString!=ue&&(T.toString=ue),r(r.P+r.F*n(function(){new m(1).slice()}),f,{slice:Ce}),r(r.P+r.F*(n(function(){return[1,2].toLocaleString()!=new m([1,2]).toLocaleString()})||!n(function(){T.toLocaleString.call([1,2])})),f,{toLocaleString:Pe}),I[f]=P?L:N,P||u(T,de,N)}}else e.exports=function(){}});Mo("Int8",1,function(e){return function(t,n,r){return e(this,t,n,r)}}),Mo("Uint8",1,function(e){return function(t,n,r){return e(this,t,n,r)}}),Mo("Uint8",1,function(e){return function(t,n,r){return e(this,t,n,r)}},!0),Mo("Int16",2,function(e){return function(t,n,r){return e(this,t,n,r)}}),Mo("Uint16",2,function(e){return function(t,n,r){return e(this,t,n,r)}}),Mo("Int32",4,function(e){return function(t,n,r){return e(this,t,n,r)}}),Mo("Uint32",4,function(e){return function(t,n,r){return e(this,t,n,r)}}),Mo("Float32",4,function(e){return function(t,n,r){return e(this,t,n,r)}}),Mo("Float64",8,function(e){return function(t,n,r){return e(this,t,n,r)}});var So=Math.log1p||function(e){return(e=+e)>-1e-8&&e<1e-8?e-e*e/2:Math.log(1+e)},To=Math.sqrt,Ao=Math.acosh;br(br.S+br.F*!(Ao&&710==Math.floor(Ao(Number.MAX_VALUE))&&Ao(1/0)==1/0),"Math",{acosh:function(e){return(e=+e)<1?NaN:e>94906265.62425156?Math.log(e)+Math.LN2:So(e-1+To(e-1)*To(e+1))}});var Eo=Math.asinh;br(br.S+br.F*!(Eo&&1/Eo(0)>0),"Math",{asinh:r});var Ro=Math.atanh;br(br.S+br.F*!(Ro&&1/Ro(-0)<0),"Math",{atanh:function(e){return 0==(e=+e)?e:Math.log((1+e)/(1-e))/2}});var Lo=Math.sign||function(e){return 0==(e=+e)||e!=e?e:e<0?-1:1};br(br.S,"Math",{cbrt:function(e){return Lo(e=+e)*Math.pow(Math.abs(e),1/3)}}),br(br.S,"Math",{clz32:function(e){return(e>>>=0)?31-Math.floor(Math.log(e+.5)*Math.LOG2E):32}});var Po=Math.exp;br(br.S,"Math",{cosh:function(e){return(Po(e=+e)+Po(-e))/2}});var Io=Math.expm1,Co=!Io||Io(10)>22025.465794806718||Io(10)<22025.465794806718||-2e-17!=Io(-2e-17)?function(e){return 0==(e=+e)?e:e>-1e-6&&e<1e-6?e+e*e/2:Math.exp(e)-1}:Io;br(br.S+br.F*(Co!=Math.expm1),"Math",{expm1:Co});var Do=Math.pow,No=Do(2,-52),Oo=Do(2,-23),Uo=Do(2,127)*(2-Oo),Fo=Do(2,-126),Vo=function(e){return e+1/No-1/No},Bo=Math.fround||function(e){var t,n,r=Math.abs(e),a=Lo(e);return r<Fo?a*Vo(r/Fo/Oo)*Fo*Oo:(t=(1+Oo/No)*r,(n=t-(t-r))>Uo||n!=n?a*(1/0):a*n)};br(br.S,"Math",{fround:Bo});var zo=Math.abs;br(br.S,"Math",{hypot:function(e,t){for(var n,r,a=0,i=0,o=arguments.length,s=0;i<o;)s<(n=zo(arguments[i++]))?(a=a*(r=s/n)*r+1,s=n):a+=n>0?(r=n/s)*r:n;return s===1/0?1/0:s*Math.sqrt(a)}});var Go=Math.imul;br(br.S+br.F*er(function(){return-5!=Go(4294967295,5)||2!=Go.length}),"Math",{imul:function(e,t){var n=+e,r=+t,a=65535&n,i=65535&r;return 0|a*i+((65535&n>>>16)*i+a*(65535&r>>>16)<<16>>>0)}}),br(br.S,"Math",{log10:function(e){return Math.log(e)*Math.LOG10E}}),br(br.S,"Math",{log1p:So}),br(br.S,"Math",{log2:function(e){return Math.log(e)/Math.LN2}}),br(br.S,"Math",{sign:Lo});var ko=Math.exp;br(br.S+br.F*er(function(){return-2e-17!=!Math.sinh(-2e-17)}),"Math",{sinh:function(e){return Math.abs(e=+e)<1?(Co(e)-Co(-e))/2:(ko(e-1)-ko(-e-1))*(Math.E/2)}});var Ho=Math.exp;br(br.S,"Math",{tanh:function(e){var t=Co(e=+e),n=Co(-e);return t==1/0?1:n==1/0?-1:(t-n)/(Ho(e)+Ho(-e))}}),br(br.S,"Math",{trunc:function(e){return(e>0?Math.floor:Math.ceil)(e)}});var Wo=function(e,t){if(ar(e),!rr(t)&&null!==t)throw TypeError(t+": can't set as prototype!")},qo={set:Object.setPrototypeOf||("__proto__"in{}?function(e,t,n){try{(n=yr(Function.call,ga.f(Object.prototype,"__proto__").set,2))(e,[]),t=!(e instanceof Array)}catch(e){t=!0}return function(e,r){return Wo(e,r),t?e.__proto__=r:n(e,r),e}}({},!1):void 0),check:Wo}.set,jo=function(e,t,n){var r,a=t.constructor;return a!==n&&"function"==typeof a&&(r=a.prototype)!==n.prototype&&rr(r)&&qo&&qo(e,r),e},Xo="\t\n\v\f\r \u2028\u2029\ufeff",Yo="["+Xo+"]",Ko=RegExp("^"+Yo+Yo+"*"),Zo=RegExp(Yo+Yo+"*$"),Qo=function(e,t,n){var r={},a=er(function(){return!!Xo[e]()||""!=""[e]()}),i=r[e]=a?t(Jo):Xo[e];n&&(r[n]=i),br(br.P+br.F*a,"String",r)},Jo=Qo.trim=function(e,t){return e=String(Nr(e)),1&t&&(e=e.replace(Ko,"")),2&t&&(e=e.replace(Zo,"")),e},$o=Qo,es=da.f,ts=ga.f,ns=dr.f,rs=$o.trim,as=Qn.Number,is=as,os=as.prototype,ss="Number"==Cr(ua(os)),ls="trim"in String.prototype,us=function(e){var t=ur(e,!1);if("string"==typeof t&&t.length>2){var n,r,a,i=(t=ls?t.trim():rs(t,3)).charCodeAt(0);if(43===i||45===i){if(88===(n=t.charCodeAt(2))||120===n)return NaN}else if(48===i){switch(t.charCodeAt(1)){case 66:case 98:r=2,a=49;break;case 79:case 111:r=8,a=55;break;default:return+t}for(var o,s=t.slice(2),l=0,u=s.length;l<u;l++)if((o=s.charCodeAt(l))<48||o>a)return NaN;return parseInt(s,r)}}return+t};if(!as(" 0o1")||!as("0b1")||as("+0x1")){as=function(e){var t=arguments.length<1?0:e,n=this;return n instanceof as&&(ss?er(function(){os.valueOf.call(n)}):"Number"!=Cr(n))?jo(new is(us(t)),n,as):us(t)};for(var fs,ds=tr?es(is):"MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger".split(","),cs=0;ds.length>cs;cs++)$n(is,fs=ds[cs])&&!$n(as,fs)&&ns(as,fs,ts(is,fs));as.prototype=os,os.constructor=as,vr(Qn,"Number",as)}var ps=function(e,t){if("number"!=typeof e&&"Number"!=Cr(e))throw TypeError(t);return+e},hs=function(e){var t=String(Nr(this)),n="",r=Vr(e);if(r<0||r==1/0)throw RangeError("Count can't be negative");for(;r>0;(r>>>=1)&&(t+=t))1&r&&(n+=t);return n},ms=1..toFixed,_s=Math.floor,vs=[0,0,0,0,0,0],gs="Number.toFixed: incorrect invocation!",ys=function(e,t){for(var n=-1,r=t;++n<6;)r+=e*vs[n],vs[n]=r%1e7,r=_s(r/1e7)},xs=function(e){for(var t=6,n=0;--t>=0;)n+=vs[t],vs[t]=_s(n/e),n=n%e*1e7},bs=function(){for(var e=6,t="";--e>=0;)if(""!==t||0===e||0!==vs[e]){var n=String(vs[e]);t=""===t?n:t+hs.call("0",7-n.length)+n}return t},ws=function(e,t,n){return 0===t?n:t%2==1?ws(e,t-1,n*e):ws(e*e,t/2,n)},Ms=function(e){for(var t=0,n=e;n>=4096;)t+=12,n/=4096;for(;n>=2;)t+=1,n/=2;return t};br(br.P+br.F*(!!ms&&("0.000"!==8e-5.toFixed(3)||"1"!==.9.toFixed(0)||"1.25"!==1.255.toFixed(2)||"1000000000000000128"!==(0xde0b6b3a7640080).toFixed(0))||!er(function(){ms.call({})})),"Number",{toFixed:function(e){var t,n,r,a,i=ps(this,gs),o=Vr(e),s="",l="0";if(o<0||o>20)throw RangeError(gs);if(i!=i)return"NaN";if(i<=-1e21||i>=1e21)return String(i);if(i<0&&(s="-",i=-i),i>1e-21)if(t=Ms(i*ws(2,69,1))-69,n=t<0?i*ws(2,-t,1):i/ws(2,t,1),n*=4503599627370496,(t=52-t)>0){for(ys(0,n),r=o;r>=7;)ys(1e7,0),r-=7;for(ys(ws(10,r,1),0),r=t-1;r>=23;)xs(1<<23),r-=23;xs(1<<r),ys(1,1),xs(2),l=bs()}else ys(0,n),ys(1<<-t,0),l=bs()+hs.call("0",o);return l=o>0?s+((a=l.length)<=o?"0."+hs.call("0",o-a)+l:l.slice(0,a-o)+"."+l.slice(a-o)):s+l}});var Ss=1..toPrecision;br(br.P+br.F*(er(function(){return"1"!==Ss.call(1,void 0)})||!er(function(){Ss.call({})})),"Number",{toPrecision:function(e){var t=ps(this,"Number#toPrecision: incorrect invocation!");return void 0===e?Ss.call(t):Ss.call(t,e)}}),br(br.S,"Number",{EPSILON:Math.pow(2,-52)});var Ts=Qn.isFinite;br(br.S,"Number",{isFinite:function(e){return"number"==typeof e&&Ts(e)}});var As=Math.floor,Es=function(e){return!rr(e)&&isFinite(e)&&As(e)===e};br(br.S,"Number",{isInteger:Es}),br(br.S,"Number",{isNaN:function(e){return e!=e}});var Rs=Math.abs;br(br.S,"Number",{isSafeInteger:function(e){return Es(e)&&Rs(e)<=9007199254740991}}),br(br.S,"Number",{MAX_SAFE_INTEGER:9007199254740991}),br(br.S,"Number",{MIN_SAFE_INTEGER:-9007199254740991});var Ls=Qn.parseFloat,Ps=$o.trim,Is=1/Ls(Xo+"-0")!=-1/0?function(e){var t=Ps(String(e),3),n=Ls(t);return 0===n&&"-"==t.charAt(0)?-0:n}:Ls;br(br.S+br.F*(Number.parseFloat!=Is),"Number",{parseFloat:Is});var Cs=Qn.parseInt,Ds=$o.trim,Ns=/^[-+]?0[xX]/,Os=8!==Cs(Xo+"08")||22!==Cs(Xo+"0x16")?function(e,t){var n=Ds(String(e),3);return Cs(n,t>>>0||(Ns.test(n)?16:10))}:Cs;br(br.S+br.F*(Number.parseInt!=Os),"Number",{parseInt:Os});var Us=Object.assign,Fs=!Us||er(function(){var e={},t={},n=Symbol(),r="abcdefghijklmnopqrst";return e[n]=7,r.split("").forEach(function(e){t[e]=e}),7!=Us({},e)[n]||Object.keys(Us({},t)).join("")!=r})?function(e,t){for(var n=ri(e),r=arguments.length,a=1,i=$r.f,o=ea.f;r>a;)for(var s,l=Dr(arguments[a++]),u=i?Qr(l).concat(i(l)):Qr(l),f=u.length,d=0;f>d;)o.call(l,s=u[d++])&&(n[s]=l[s]);return n}:Us;br(br.S+br.F,"Object",{assign:Fs});var Vs={uniforms:{color1:{type:"v3",value:new t.Vector3(41/255,76/255,120/255)},color2:{type:"v3",value:new t.Vector3(1/255,2/255,3/255)},envMap:{type:"t",value:null},envRotationSin:{type:"f",value:0},envRotationCos:{type:"f",value:1},exposureBias:{type:"f",value:1},envMapExposure:{type:"f",value:1},uCamDir:{type:"v3",value:new t.Vector3},uCamUp:{type:"v3",value:new t.Vector3},uResolution:{type:"v2",value:new t.Vector2(600,400)},uHalfFovTan:{type:"f",value:.5},envMapBackground:{type:"i",value:0}},vertexShader:"uniform vec3 color1;\nuniform vec3 color2;\nvarying vec2 vUv;\nvarying vec3 vColor;\nvoid main() {\n    if (uv.y == 0.0)\n        vColor = color2;\n    else\n        vColor = color1;\n    vUv = uv;\n    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}\n",fragmentShader:"varying vec3 vColor;\nvarying vec2 vUv;\nuniform samplerCube envMap;\nuniform vec3 uCamDir;\nuniform vec3 uCamUp;\nuniform vec2 uResolution;\nuniform float uHalfFovTan;\nuniform bool envMapBackground;\n#include<env_sample>\nconst int bloomRange = 4;\n#include<ordered_dither>\nuniform float envMapExposure;\n#if TONEMAP_OUTPUT > 0\nuniform float exposureBias;\n#include<tonemap>\n#endif\nvec3 rayDir(in vec2 vUv) {\n    vec3 A = (uResolution.x/uResolution.y)*normalize(cross(uCamDir,uCamUp)) * (uHalfFovTan * 2.0);\n    vec3 B = normalize(uCamUp) * (uHalfFovTan * 2.0);\n    vec3 C = normalize(uCamDir);\n    vec3 ray = normalize( C + (2.0*vUv.x-1.0)*A + (2.0*vUv.y-1.0)*B );\n    return ray;\n}\nvec3 getColor(in vec3 rd) {\n    return RGBMDecode(textureCube(envMap, adjustLookupVector(rd)), envMapExposure);\n}\nvoid main() {\n    vec3 rd = rayDir(vUv);\n    vec3 outColor;\n    if (envMapBackground) {\n        outColor = getColor(rd);\n#if TONEMAP_OUTPUT == 1\n        outColor = toneMapCanonOGS_WithGamma_WithColorPerserving(exposureBias * outColor);\n#elif TONEMAP_OUTPUT == 2\n        outColor = toneMapCanonFilmic_WithGamma(exposureBias * outColor);\n#endif\n    }\n    else {\n        outColor = vColor;\n    }\n    gl_FragColor = vec4(orderedDithering(outColor), 1.0);\n}\n"},Bs="#if defined( PRISMWOOD )\n#define ONE 0.00390625\nfloat GetIndexedValue(vec4 array, int index)\n{\n    if (index == 0)\n        return array[0];\n    else if (index == 1)\n        return array[1];\n    else if (index == 2)\n        return array[2];\n    else if (index == 3)\n        return array[3];\n    else\n        return 0.0;\n}\nint GetIndexedValue(ivec2 array, int index)\n{\n    if (index == 0)\n        return array[0];\n    else if (index == 1)\n        return array[1];\n    else\n        return 0;\n}\n#if defined( USE_WOOD_CURLY_DISTORTION_MAP )\nfloat SampleCurlyPattern(vec2 uv)\n{\n    vec2 uv_wood_curly_distortion_map = (wood_curly_distortion_map_texMatrix * vec3(uv, 1.0)).xy;\n    WOOD_CURLY_DISTORTION_CLAMP_TEST;\n    vec3 curlyDistortion = texture2D(wood_curly_distortion_map, uv_wood_curly_distortion_map).xyz;\n    if(wood_curly_distortion_map_invert) curlyDistortion = vec3(1.0) - curlyDistortion;\n    return curlyDistortion.r;\n}\nvec3 DistortCurly(vec3 p)\n{\n    if (!wood_curly_distortion_enable) return p;\n    float r = length(p.xy);\n    if (r < 0.00001) return p;\n    const float INV_ANGLE_INTERVAL = 1.27323954;\n    const float NUM_INTERVAL = 8.0;\n    float theta = atan(p.y, p.x);\n    if (theta < 0.0)\n        theta += PI2;\n    float intIdx = theta * INV_ANGLE_INTERVAL;\n    int idx0 = int(mod(floor(intIdx), NUM_INTERVAL));\n    int idx1 = int(mod(ceil(intIdx), NUM_INTERVAL));\n    const vec4 HASH_TABLE1 = vec4(0.450572,0.114598, 0.886043, 0.315119);\n    const vec4 HASH_TABLE2 = vec4(0.216133,0.306264, 0.685616, 0.317907);\n    float offset0 = idx0 < 4 ? GetIndexedValue(HASH_TABLE1, idx0) : GetIndexedValue(HASH_TABLE2, idx0-4);\n    float offset1 = idx1 < 4 ? GetIndexedValue(HASH_TABLE1, idx1) : GetIndexedValue(HASH_TABLE2, idx1-4);\n    const float maxOffset = 100.0;\n    offset0 = (offset0 - 0.5) * maxOffset;\n    offset1 = (offset1 - 0.5) * maxOffset;\n    vec2 uv0 = vec2(p.z + offset0, r);\n    float shiftWeight0 =  SampleCurlyPattern(uv0);\n    vec2 uv1 = vec2(p.z + offset1, r);\n    float shiftWeight1 =  SampleCurlyPattern(uv1);\n    float interpWeight = fract(intIdx);\n    float shiftWeight = mix(shiftWeight0, shiftWeight1, interpWeight);\n    const float INV_MIN_RADIUS = 2.0;\n    float shiftWeightAdjust = smoothstep(0.0, 1.0, r * INV_MIN_RADIUS);\n    r -= wood_curly_distortion_scale * (shiftWeight * shiftWeightAdjust);\n    float thetaNew = atan(p.y, p.x);\n    vec3 pNew = p;\n    pNew.x = r * cos(thetaNew);\n    pNew.y = r * sin(thetaNew);\n    return pNew;\n}\n#endif\nvec3 un2sn(vec3 range)\n{\n    return range * 2.0 - 1.0;\n}\nfloat inoise(vec3 p)\n{\n    vec3 modp = mod(floor(p), 256.0);\n    modp.xy = modp.xy * ONE;\n    vec4 AA = texture2D(perm2DMap, vec2(modp.x, modp.y), 0.0) * 255.0;\n    AA = AA + modp.z;\n    AA = mod(floor(AA), 256.0);\n    AA *= ONE;\n    vec3 gradx1 = un2sn(texture2D(permGradMap,vec2(AA.x,0.0),0.0).xyz);\n    vec3 grady1 = un2sn(texture2D(permGradMap,vec2(AA.y,0.0),0.0).xyz);\n    vec3 gradz1 = un2sn(texture2D(permGradMap,vec2(AA.z,0.0),0.0).xyz);\n    vec3 gradw1 = un2sn(texture2D(permGradMap,vec2(AA.w,0.0),0.0).xyz);\n    vec3 gradx2 = un2sn(texture2D(permGradMap,vec2(AA.x + ONE,0.0),0.0).xyz);\n    vec3 grady2 = un2sn(texture2D(permGradMap,vec2(AA.y + ONE,0.0),0.0).xyz);\n    vec3 gradz2 = un2sn(texture2D(permGradMap,vec2(AA.z + ONE,0.0),0.0).xyz);\n    vec3 gradw2 = un2sn(texture2D(permGradMap,vec2(AA.w + ONE,0.0),0.0).xyz);\n    p -= floor(p);\n    vec3 fadep = p * p * p * (p * (p * 6.0 - 15.0) + 10.0);\n    return mix( mix( mix( dot(gradx1, p ),\n                          dot(gradz1, p + vec3(-1.0, 0.0, 0.0)), fadep.x),\n                     mix( dot(grady1, p + vec3(0.0, -1.0, 0.0)),\n                          dot(gradw1, p + vec3(-1.0, -1.0, 0.0)), fadep.x), fadep.y),\n                mix( mix( dot(gradx2, p + vec3(0.0, 0.0, -1.0)),\n                          dot(gradz2, p + vec3(-1.0, 0.0, -1.0)), fadep.x),\n                     mix( dot(grady2, p + vec3(0.0, -1.0, -1.0)),\n                          dot(gradw2, p + vec3(-1.0, -1.0, -1.0)), fadep.x), fadep.y), fadep.z);\n}\nfloat inoise(float p)\n{\n    float modp = mod(floor(p), 256.0);\n    modp = (modp + 256.0) * ONE;\n    float permx = texture2D(permutationMap, vec2(modp, 0.0), 0.0).r;\n    float gradx = texture2D(gradientMap, vec2(permx, 0.0), 0.0).r*2.0-1.0;\n    float permy = texture2D(permutationMap, vec2(modp + ONE, 0.0), 0.0).r;\n    float grady = texture2D(gradientMap, vec2(permy, 0.0), 0.0).r*2.0-1.0;\n    p -= floor(p);\n    float fadep = p * p * p * (p * (p * 6.0 - 15.0) + 10.0);\n    return mix(gradx * p, grady * (p - 1.0), fadep);\n}\nfloat multiband_inoise(vec3 p, int bands, vec4 w, vec4 f)\n{\n    float noise = 0.0;\n    for(int i = 0; i < 4; ++i)\n    {\n        if (i >= bands) break;\n        noise += GetIndexedValue(w, i) * inoise(p * GetIndexedValue(f, i));\n    }\n    return noise;\n}\nfloat multiband_inoise(float p, int bands, vec4 w, vec4 f)\n{\n    float noise = 0.0;\n    for(int i = 0; i < 4; ++i)\n    {\n        if (i >= bands) break;\n        noise += GetIndexedValue(w, i) * inoise(p * GetIndexedValue(f, i));\n    }\n    return noise;\n}\nvec3 Distort3DCosineRadialDir(vec3 p)\n{\n    float radius = length(p.xy);\n    if (radius < 0.00001) return p;\n    vec2 theta = p.xy / radius;\n    float radiusShift = 0.0;\n    for (int i = 0; i < 4; ++i)\n    {\n        if (i >= wood_fiber_cosine_bands) break;\n        radiusShift += GetIndexedValue(wood_fiber_cosine_weights, i) * cos(p.z * RECIPROCAL_PI2 * GetIndexedValue(wood_fiber_cosine_frequencies, i));\n    }\n    const float MIN_RADIUS = 1.5;\n    float weight = clamp(radius / MIN_RADIUS, 0.0, 1.0);\n    if(weight >= 0.5)\n        weight = weight * weight * (3.0 - (weight + weight));\n    p.xy += theta * radiusShift * weight;\n    return p;\n}\nvec3 Distort3DPerlin(vec3 p)\n{\n    vec3 pAniso = vec3(p.xy, p.z * wood_fiber_perlin_scale_z);\n    p.xy += multiband_inoise(pAniso, wood_fiber_perlin_bands, wood_fiber_perlin_weights, wood_fiber_perlin_frequencies);\n    return p;\n}\nvec3 Distort(vec3 p)\n{\n    if(wood_fiber_cosine_enable)\n        p = Distort3DCosineRadialDir(p);\n    if(wood_fiber_perlin_enable)\n        p = Distort3DPerlin(p);\n    return p;\n}\nfloat DistortRadiusLength(float radiusLength)\n{\n    radiusLength += multiband_inoise(radiusLength, wood_growth_perlin_bands, wood_growth_perlin_weights, wood_growth_perlin_frequencies);\n    if (radiusLength < 0.0) radiusLength = 0.0;\n    return radiusLength;\n}\nfloat ComputeEarlyWoodRatio(float radiusLength)\n{\n    float fraction = mod(radiusLength, wood_ring_thickness) / wood_ring_thickness;\n    if (fraction <= wood_ring_fraction.y)\n       return 1.0;\n    else if(fraction <= wood_ring_fraction.x)\n       return (1.0 - (fraction - wood_ring_fraction.y) / wood_fall_rise.x);\n    else if(fraction <= wood_ring_fraction.w)\n       return 0.0;\n    else\n       return ((fraction - wood_ring_fraction.w) / wood_fall_rise.y);\n}\nvec3 DistortEarlyColor(vec3 earlyColor, float radiusLength)\n{\n    float expValue = 1.0 + multiband_inoise(radiusLength,wood_earlycolor_perlin_bands,wood_earlycolor_perlin_weights,wood_earlycolor_perlin_frequencies);\n    earlyColor = pow(abs(earlyColor), vec3(expValue));\n    return earlyColor;\n}\nvec3 DistortLateColor(vec3 lateColor, float radiusLength)\n{\n    float expValue = 1.0 + multiband_inoise(radiusLength,wood_latecolor_perlin_bands,wood_latecolor_perlin_weights,wood_latecolor_perlin_frequencies);\n    lateColor = pow(abs(lateColor), vec3(expValue));\n    return lateColor;\n}\nvec3 DistortDiffuseColor(vec3 diffAlbedo, vec3 p)\n{\n    p.z *= wood_diffuse_perlin_scale_z;\n    float expValue = 1.0 + multiband_inoise(p, wood_diffuse_perlin_bands, wood_diffuse_perlin_weights, wood_diffuse_perlin_frequencies);\n    diffAlbedo = pow(abs(diffAlbedo), vec3(expValue));\n    return diffAlbedo;\n}\nfloat LayerRoughnessVar(float roughness, float earlyWoodRatio)\n{\n    return earlyWoodRatio * wood_groove_roughness + (1.0 - earlyWoodRatio) * roughness;\n}\nfloat hashword(vec2 k)\n{\n    k = mod(k, vec2(256.0)) * ONE;\n    float a = texture2D(permutationMap, vec2(k.x, 0.0)).x + k.y ;\n    a = texture2D(permutationMap, vec2(a, 0.0)).x ;\n    return a*255.0;\n}\nfloat wyvillsq(float rsq)\n{\n    if (rsq >= 1.0) return 0.0;\n    float tmp = 1.0 - rsq;\n    return tmp*tmp*tmp;\n}\nfloat Weight2DNeighborImpulses(vec3 p, float woodWeight)\n{\n    if(woodWeight <= 0.0) return 0.0;\n    float poreRadius = wood_pore_radius * woodWeight;\n    vec2 left = floor((p.xy - poreRadius) / wood_pore_cell_dim);\n    vec2 right = floor((p.xy + poreRadius) / wood_pore_cell_dim);\n    float weight = 0.0;\n    float invRsq = 1.0 / (poreRadius * poreRadius);\n    const float norm =  1.0 / 15.0;\n    for (int j = 0; j <= 4; j++)\n    {\n        if (j > int(right.y - left.y)) continue;\n        for (int i = 0; i <= 4; i++)\n        {\n            if (i > int(right.x - left.x)) continue;\n            vec2 pij = vec2(float(i) + left.x,float(j) + left.y);\n            float hRNum = hashword(pij);\n            float impPosX = mod(hRNum, 16.0) * norm;\n            float impPosY = floor(hRNum / 16.0) * norm;\n            impPosX = (pij.x + impPosX)* wood_pore_cell_dim;\n            impPosY = (pij.y + impPosY)* wood_pore_cell_dim;\n            float dsq = (p.x - impPosX) * (p.x - impPosX) + (p.y - impPosY) * (p.y - impPosY);\n            weight += wyvillsq(dsq * invRsq);\n        }\n    }\n    return weight;\n}\nfloat Weight3DRayImpulses(vec3 p)\n{\n    int segIdx = int(floor(p.z / wood_ray_seg_length_z));\n    float factor = p.z / wood_ray_seg_length_z - float(segIdx);\n    int segIdx1 = segIdx - 1;\n    if ( factor > 0.5 )\n        segIdx1 = segIdx + 1;\n    float theta = atan(p.y, p.x);\n    float sliceIdx = floor(((theta + PI) * RECIPROCAL_PI2) * wood_ray_num_slices);\n    if ( sliceIdx == wood_ray_num_slices)\n        sliceIdx-=1.0;\n    ivec2 arrSegs = ivec2(segIdx, segIdx1);\n    float weight = 0.0;\n    const float norm =  1.0 / 15.0;\n    float radialOffset = 5.0;\n    float radialLength = length(p.xy);\n    for (int seg = 0; seg < 2; seg++)\n    {\n        float hRNum = hashword(vec2(sliceIdx, GetIndexedValue(arrSegs, seg)));\n        float rn1 = mod(hRNum,16.0) * norm;\n        if (radialLength < radialOffset * rn1)\n            continue;\n        float rayTheta = rn1;\n        rayTheta = ( ( sliceIdx + rayTheta ) / wood_ray_num_slices ) * ( 2.0 * PI ) - PI;\n        float rayPosZ = (hRNum/16.0)* norm;\n        rayPosZ = ( float(GetIndexedValue(arrSegs, seg)) + rayPosZ ) * wood_ray_seg_length_z;\n        vec3 pt1 = vec3(0.0);\n        vec3 pt2 = vec3(cos(rayTheta), sin(rayTheta), 0.0);\n        vec3 p1 = p;\n        p1.z -= rayPosZ;\n        p1.z /=  wood_ray_ellipse_z2x;\n        vec3 v1 = pt2 - pt1;\n        vec3 v2 = pt1 - p1;\n        v2 = cross(v1, v2);\n        float dist = length(v2) / length(v1);\n        float invRsq = 1.0 / ( wood_ray_ellipse_radius_x * wood_ray_ellipse_radius_x);\n        weight += wyvillsq( (dist * dist) * invRsq );\n    }\n    return weight;\n}\nvec3 DarkenColorWithPores(vec3 p, vec3 diffColor, float woodWeight)\n{\n    float poresWeight = Weight2DNeighborImpulses(p, woodWeight);\n    float a = wood_pore_color_power - 1.0;\n    float b = 1.0;\n    float y = a * poresWeight + b;\n    return pow(abs(diffColor), vec3(y));\n}\nvec3 DarkenColorWithRays(vec3 p, vec3 diffColor)\n{\n    float raysWeight = Weight3DRayImpulses(p);\n    float a = wood_ray_color_power - 1.0;\n    float b = 1.0;\n    float y = a * raysWeight + b;\n    return pow(abs(diffColor), vec3(y));\n}\nfloat ComputeWoodWeight(float earlyWoodRatio)\n{\n    float woodWeight = 0.0;\n    if (wood_pore_type == 0)\n        woodWeight = 1.0;\n    else if (wood_pore_type == 1)\n        woodWeight = earlyWoodRatio;\n    else if (wood_pore_type == 2)\n        woodWeight = 1.0 - earlyWoodRatio;\n    else\n        woodWeight = -1.0;\n    return woodWeight;\n}\n#if defined( PRISMWOODBUMP )\nfloat ComputeEarlyWoodRatioAA(float radiusLength, float invUnitExt)\n{\n    float transPixels = min(wood_fall_rise.x, wood_fall_rise.y) * wood_ring_thickness * invUnitExt;\n    float samplesf = clamp(4.0 / transPixels, 1.0, 4.0);\n    int samples = int(samplesf);\n    float inverseSamples = 1.0 / float(samples);\n    vec2 rdelta = vec2(dFdx(radiusLength), dFdy(radiusLength)) * inverseSamples;\n    float earlywoodRatio = 0.0;\n    for (int i = 0; i < 4; ++i)\n    {\n        if (i >= samples) break;\n        for (int j = 0; j < 4; ++j)\n        {\n            if (j >= samples) break;\n            float r = radiusLength + dot(vec2(i, j), rdelta);\n            earlywoodRatio += ComputeEarlyWoodRatio(r);\n        }\n    }\n    return earlywoodRatio * (inverseSamples * inverseSamples);\n}\nfloat LatewoodDepthVariation(float invUnitExt)\n{\n    float transPixels = min(wood_fall_rise.x, wood_fall_rise.y) * wood_ring_thickness * invUnitExt;\n    return clamp(transPixels * 0.5, 0.0, 1.0);\n}\nfloat LatewoodHeightVariation(float earlyWoodRatio, float latewoodBumpDepth,\n                              float depthVar)\n{\n    return ( 1.0 - earlyWoodRatio ) * latewoodBumpDepth * depthVar;\n}\nfloat PoreDepthVariation(float woodWeight, float invUnitExt)\n{\n    float porePixels = woodWeight * wood_pore_radius * invUnitExt;\n    return clamp(porePixels, 0.0, 1.0);\n}\nfloat PoreHeightVariation(float earlyWoodRatio, float poresWeight, float poreDepth,\n                          float depthVar)\n{\n    return poresWeight * (-1.0 * poreDepth) * depthVar;\n}\nvoid ComputeTangents(vec3 normal, out vec3 u, out vec3 v)\n{\n    float scale = normal.z < 0.0 ? -1.0 : 1.0;\n    vec3 temp = scale * normal;\n    float e    = temp.z;\n    float h    = 1.0/(1.0 + e);\n    float hvx  = h   *  temp.y;\n    float hvxy = hvx * -temp.x;\n    u = vec3(e + hvx * temp.y, hvxy,                -temp.x);\n    v = vec3(hvxy,             e + h * temp.x * temp.x, -temp.y);\n    u *= scale;\n    v *= scale;\n}\nvec3 WoodBumpHeight(float heightLeft, float heightRight, float heightBack, float heightFront)\n{\n    const float epsilon = 0.001;\n    float heightDeltaX = heightRight - heightLeft;\n    vec3 Tu = vec3(2.0 * epsilon, 0.0, heightDeltaX);\n    float heightDeltaY = heightFront - heightBack;\n    vec3 Tv = vec3(0.0, 2.0 * epsilon, heightDeltaY);\n    return cross(Tu, Tv);\n}\nvec3 SelectNormal(vec3 N, vec3 bumpN, vec3 V)\n{\n    float bumpNdotV = dot(bumpN, V);\n    if(bumpNdotV > 0.0)\n        return bumpN;\n    else return N;\n}\nfloat MinInverseUnitExtent(vec3 p)\n{\n    return 1.0 / max(max(length(dFdx(p.xy)), length(dFdy(p.xy))), 0.000001);\n}\nfloat HeightVariation(vec3 pos)\n{\n    vec3 p = Distort(pos);\n    float radiusLength = length(p.xy);\n    if (wood_growth_perlin_enable)\n        radiusLength = DistortRadiusLength(radiusLength);\n    float invUnitExt = MinInverseUnitExtent(p);\n    float earlyWoodRatio = ComputeEarlyWoodRatioAA(radiusLength, invUnitExt);\n    float woodWeight = ComputeWoodWeight(earlyWoodRatio);\n    float poresWeight = Weight2DNeighborImpulses(p, woodWeight);\n    float depthVar = PoreDepthVariation(woodWeight, invUnitExt);\n    float poreHeightVariation = -1.0 * poresWeight * wood_pore_depth * depthVar;\n    float latewoodHeightVariation = 0.0;\n    if (wood_use_latewood_bump)\n    {\n        float latewoodDepthVar = LatewoodDepthVariation(invUnitExt);\n        latewoodHeightVariation = (1.0 - earlyWoodRatio) * wood_latewood_bump_depth * latewoodDepthVar;\n    }\n    float sumHeightVariation = poreHeightVariation + latewoodHeightVariation;\n    return sumHeightVariation;\n}\n#endif\nvec3 NoiseWood(vec3 p, inout float roughness)\n{\n    p = Distort(p);\n    float radiusLength = length(p.xy);\n    if(wood_growth_perlin_enable)\n        radiusLength = DistortRadiusLength(radiusLength);\n#if defined( PRISMWOODBUMP )\n    float invUnitExt = MinInverseUnitExtent( p );\n    float earlyWoodRatio = ComputeEarlyWoodRatioAA(radiusLength, invUnitExt);\n#else\n    float earlyWoodRatio = ComputeEarlyWoodRatio(radiusLength);\n#endif\n    vec3 earlyColor = wood_early_color;\n    if (wood_earlycolor_perlin_enable)\n        earlyColor = DistortEarlyColor(earlyColor, radiusLength);\n    vec3 lateColor;\n    if (wood_use_manual_late_color)\n        lateColor = wood_manual_late_color;\n    else\n        lateColor = pow(abs(earlyColor), vec3(wood_late_color_power));\n    if(wood_latecolor_perlin_enable)\n        lateColor = DistortLateColor(lateColor, radiusLength);\n    vec3 diffAlbedo = earlyWoodRatio * earlyColor + (1.0 - earlyWoodRatio) * lateColor;\n    if(wood_diffuse_perlin_enable)\n        diffAlbedo = DistortDiffuseColor(diffAlbedo, p);\n    if (wood_use_pores)\n    {\n        float woodWeight = ComputeWoodWeight(earlyWoodRatio);\n        diffAlbedo = DarkenColorWithPores(p, diffAlbedo, woodWeight);\n    }\n    if (wood_use_rays)\n        diffAlbedo = DarkenColorWithRays(p, diffAlbedo);\n    if(wood_use_groove_roughness)\n        roughness = LayerRoughnessVar(roughness, earlyWoodRatio);\n    return clamp(diffAlbedo, vec3(0.0), vec3(1.0));\n}\n#if defined(PRISMWOODBUMP)\nvoid getFinalWoodContext(\n    inout vec3 N, vec3 V, inout vec3 Tu, inout vec3 Tv, vec3 p,\n    vec3 geoNormal, vec3 tNormal, mat3 normalMatrix\n) {\n    vec3 offsetTuLeft = p - 0.001 * Tu;\n    vec3 offsetTuRight = p + 0.001 * Tu;\n    vec3 offsetTvLeft = p - 0.001 * Tv;\n    vec3 offsetTvRight = p + 0.001 * Tv;\n    float heightVariationTuLeft = HeightVariation(offsetTuLeft);\n    float heightVariationTuRight = HeightVariation(offsetTuRight);\n    float heightVariationTvLeft = HeightVariation(offsetTvLeft);\n    float heightVariationTvRight = HeightVariation(offsetTvRight);\n    vec3 bumpHeight = WoodBumpHeight(heightVariationTuLeft, heightVariationTuRight, heightVariationTvLeft, heightVariationTvRight);\n    vec3 newNormal = normalize(bumpHeight.x * Tu + bumpHeight.y * Tv + bumpHeight.z * vtNormal);\n    vec3 newNormalView = normalize(vNormalMatrix * newNormal);\n    vec3 selectedNormal = SelectNormal(geoNormal, newNormalView, V);\n    ComputeTangents(selectedNormal, Tu, Tv);\n    Tu = normalize(Tu);\n    Tv = normalize(Tv);\n    N = faceforward(selectedNormal, -V, selectedNormal);\n}\n#endif\n#endif\n",zs="void applyPrismTransparency(\n    inout vec4 color,\n    vec3 transparentColor,\n    float transparentIor\n) {\n    float fsLevel = max(max(color.r, color.g), color.b);\n    color = vec4(color.rgb/fsLevel, fsLevel);\n    float transLevel = min(min(transparentColor.r, transparentColor.g), transparentColor.b);\n    transLevel = min( (1.0 - surface_roughness), transLevel );\n    float transAlpha = (1.0 - transLevel) * 0.4 + surface_roughness * 0.55;\n    vec3 tr_g_color = sqrt(transparentColor);\n    vec4 transColor = vec4(0.5 * vec3(tr_g_color), transAlpha);\n    float strength = 1.0 - (1.0 - fsLevel) * (1.0 - fsLevel);\n    color = mix(transColor, color, strength);\n    color.a = max(color.a, 0.05);\n    if (transparentIor == 1.0 && tr_g_color == vec3(1.0)) {\n        color.a = 0.0;\n    }\n}",Gs="#if defined(USE_SURFACE_NORMAL_MAP) || defined( USE_LAYERED_NORMAL_MAP ) || defined( USE_TILING_NORMAL )\nvoid heightMapTransform(\n    sampler2D bumpTexture,\n    vec2 uv,\n    mat3 transform,\n    vec2 bumpScale,\n    inout vec3 T,\n    inout vec3 B,\n    inout vec3 N\n) {\n    vec2 st = (transform * vec3(uv, 1.0)).xy;\n    mat3 mtxTangent = mat3(T, B, N);\n    T = normalize(mtxTangent * (transform * vec3(1.0, 0.0, 0.0)));\n    B = normalize(mtxTangent * (transform * vec3(0.0, 1.0, 0.0)));\n    const float oneThird = 1.0 / 3.0;\n    vec3 avg = vec3(oneThird, oneThird, oneThird);\n    vec2 offset = fwidth(st);\n    float h0 = dot(texture2D(bumpTexture, st).xyz, avg);\n    float hx = dot(texture2D(bumpTexture, st + vec2(offset.x, 0.0)).xyz, avg);\n    float hy = dot(texture2D(bumpTexture, st + vec2(0.0, offset.y)).xyz, avg);\n    vec2 diff = vec2(h0 - hx, h0 - hy) / offset;\n    N = normalize(\n        N + (\n            diff.x * T * bumpScale.x +\n            diff.y * B * bumpScale.y\n        )\n    );\n}\nvoid normalMapTransform(\n    sampler2D bumpTexture,\n    vec2 uv,\n    mat3 transform,\n    vec2 bumpScale,\n    inout vec3 T,\n    inout vec3 B,\n    inout vec3 N\n) {\n    vec2 st = (transform * vec3(uv, 1.0)).xy;\n    vec3 mapN =  2.0 * texture2D(bumpTexture, st).xyz - 1.0;\n    mapN.xy *= bumpScale.x;\n    mapN.z *= bumpScale.y;\n    vec3 v = vec3(mapN.y, -mapN.x, 0.0);\n    float c = -mapN.z;\n    mat3 skewV = mat3(\n        0.0, v.z, -v.y,\n        -v.z, 0.0, v.x,\n        v.y, -v.x, 0.0\n    );\n    mat3 rot = mat3(1.0) + skewV + skewV*skewV * 1.0/(1.0-c);\n    N *= rot;\n    T *= rot;\n    B *= rot;\n}\n#endif\n",ks={cutplanes:{type:"v4v",value:[]},hatchParams:{type:"v2",value:new t.Vector2(1,10)},hatchTintColor:{type:"c",value:new t.Color(16777215)},hatchTintIntensity:{type:"f",value:1}},Hs={dbId:{type:"v3",value:new t.Vector3(0,0,0)},modelId:{type:"v3",value:new t.Vector3(0,0,0)}},Ws={themingColor:{type:"v4",value:new t.Vector4(0,0,0,0)}},qs={shadowESMConstant:{type:"f",value:0}},js=t.UniformsUtils.merge([{shadowMap:{type:"t",value:null},shadowMapSize:{type:"v2",value:new t.Vector2(0,0)},shadowBias:{type:"f",value:0},shadowDarkness:{type:"f",value:0},shadowMatrix:{type:"m4",value:new t.Matrix4},shadowLightDir:{type:"v3",value:new t.Vector3}},qs]),Xs={point_size:{type:"f",value:1}},Ys={view_size:{type:"v2",value:new t.Vector2(640,480)}},Ks={tDepth:{type:"t",value:null},projInfo:{type:"v4",value:new t.Vector4},isOrtho:{type:"f",value:0},worldMatrix_mainPass:{type:"m4",value:new t.Matrix4}},Zs={};for(var Qs in t.ShaderChunk)Zs[Qs]=t.ShaderChunk[Qs];Zs.pack_depth="\nvec4 packDepth( const in float depth ) {\n    vec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n    enc = fract(enc);\n    enc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n    return enc;\n}\nfloat unpackDepth( const in vec4 rgba_depth ) {\n    return dot( rgba_depth, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );\n}\n",Zs.depth_texture="\nuniform sampler2D tDepth;\nuniform vec4 projInfo;\nuniform float isOrtho;\nuniform mat4 worldMatrix_mainPass;\nvec3 reconstructCSPosition(vec2 fragCoords, float z) {\n    return vec3((fragCoords * projInfo.xy + projInfo.zw) * mix(z, -1.0, isOrtho), z);\n}\nvec3 reconstructWorldPosition(vec2 fragCoords, vec2 screenUv) {\n    float zCam = texture2D(tDepth, screenUv).z;\n    vec3 csPos = reconstructCSPosition(fragCoords, zCam);\n    return (worldMatrix_mainPass * vec4(csPos, 1.0)).xyz;\n}\n",Zs.tonemap="\nfloat luminance_post(vec3 rgb) {\n    return dot(rgb, vec3(0.299, 0.587, 0.114));\n}\nfloat luminance_pre(vec3 rgb) {\n    return dot(rgb, vec3(0.212671, 0.715160, 0.072169));\n}\nvec3 xyz2rgb(vec3 xyz) {\n    vec3 R = vec3( 3.240479, -1.537150, -0.498535);\n    vec3 G = vec3(-0.969256,  1.875992,  0.041556);\n    vec3 B = vec3( 0.055648, -0.204043,  1.057311);\n    vec3 rgb;\n    rgb.b = dot(xyz, B);\n    rgb.g = dot(xyz, G);\n    rgb.r = dot(xyz, R);\n    return rgb;\n}\nvec3 rgb2xyz(vec3 rgb) {\n    vec3 X = vec3(0.412453, 0.35758, 0.180423);\n    vec3 Y = vec3(0.212671, 0.71516, 0.0721688);\n    vec3 Z = vec3(0.0193338, 0.119194, 0.950227);\n    vec3 xyz;\n    xyz.x = dot(rgb, X);\n    xyz.y = dot(rgb, Y);\n    xyz.z = dot(rgb, Z);\n    return xyz;\n}\nvec3 xyz2xyY(vec3 xyz) {\n    float sum = xyz.x + xyz.y + xyz.z;\n    sum = 1.0 / sum;\n    vec3 xyY;\n    xyY.z = xyz.y;\n    xyY.x = xyz.x * sum;\n    xyY.y = xyz.y * sum;\n    return xyY;\n}\nvec3 xyY2xyz(vec3 xyY) {\n    float x = xyY.x;\n    float y = xyY.y;\n    float Y = xyY.z;\n    vec3 xyz;\n    xyz.y = Y;\n    xyz.x = x * (Y / y);\n    xyz.z = (1.0 - x - y) * (Y / y);\n    return xyz;\n}\nfloat toneMapCanon_T(float x)\n{\n    float xpow = pow(x, 1.60525727);\n    float tmp = ((1.05542877*4.68037409)*xpow) / (4.68037409*xpow + 1.0);\n    return clamp(tmp, 0.0, 1.0);\n}\nconst float Shift = 1.0 / 0.18;\nfloat toneMapCanonFilmic_NoGamma(float x) {\n    x *= Shift;\n    const float A = 0.2;\n    const float B = 0.34;\n    const float C = 0.002;\n    const float D = 1.68;\n    const float E = 0.0005;\n    const float F = 0.252;\n    const float scale = 1.0/0.833837;\n    return (((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F) * scale;\n}\nvec3 toneMapCanonFilmic_WithGamma(vec3 x) {\n    x *= Shift;\n    const float A = 0.27;\n    const float B = 0.29;\n    const float C = 0.052;\n    const float D = 0.2;\n    const float F = 0.18;\n    const float scale = 1.0/0.897105;\n    return (((x*(A*x+C*B))/(x*(A*x+B)+D*F))) * scale;\n}\nvec3 toneMapCanonOGS_WithGamma_WithColorPerserving(vec3 x) {\n    vec3 outColor = x.rgb;\n    outColor = min(outColor, vec3(3.0));\n    float inLum = luminance_pre(outColor);\n    if (inLum > 0.0) {\n        float outLum = toneMapCanon_T(inLum);\n        outColor = outColor * (outLum / inLum);\n        outColor = clamp(outColor, vec3(0.0), vec3(1.0));\n    }\n    float gamma = 1.0/2.2;\n    outColor = pow(outColor, vec3(gamma));\n    return outColor;\n}\n",Zs.ordered_dither="vec3 orderedDithering(vec3 col) {\n    const vec4 m0 = vec4( 1.0, 13.0,  4.0, 16.0);\n    const vec4 m1 = vec4( 9.0,  5.0, 12.0,  8.0);\n    const vec4 m2 = vec4( 3.0, 15.0,  2.0, 14.0);\n    const vec4 m3 = vec4(11.0,  7.0, 10.0,  6.0);\n    int i = int(mod(float(gl_FragCoord.x), 4.0));\n    int j = int(mod(float(gl_FragCoord.y), 4.0));\n    vec4 biasRow;\n    if      (i==0) biasRow = m0;\n    else if (i==1) biasRow = m1;\n    else if (i==2) biasRow = m2;\n    else           biasRow = m3;\n    float bias;\n    if      (j==0) bias = biasRow.x;\n    else if (j==1) bias = biasRow.y;\n    else if (j==2) bias = biasRow.z;\n    else           bias = biasRow.w;\n    return col + bias / 17.0 / 256.0;\n}\n",Zs.cutplanes="#if NUM_CUTPLANES > 0\nuniform vec4 cutplanes[NUM_CUTPLANES];\nvoid checkCutPlanes(vec3 worldPosition) {\n    for (int i=0; i<NUM_CUTPLANES; i++) {\n        if (dot(vec4(worldPosition, 1.0), cutplanes[i]) > 0.0) {\n            discard;\n        }\n    }\n}\n#endif\n",Zs.pack_normals="\n#define kPI 3.14159265358979\nvec2 encodeNormal (vec3 n) {\n    return (vec2(atan(n.y,n.x)/kPI, n.z)+1.0)*0.5;\n}\nvec3 decodeNormal (vec2 enc) {\n    vec2 ang = enc * 2.0 - 1.0;\n    vec2 scth = vec2(sin(ang.x * kPI), cos(ang.x * kPI));\n    vec2 scphi = vec2(sqrt(1.0 - ang.y * ang.y), ang.y);\n    return vec3(scth.y * scphi.x, scth.x * scphi.x, scphi.y);\n}\n",Zs.hatch_pattern="#ifdef HATCH_PATTERN\nuniform vec2 hatchParams;\nuniform vec3 hatchTintColor;\nuniform float hatchTintIntensity;\nfloat curveGaussian(float r, float invWidth) {\n    float amt = clamp(r * invWidth, 0.0, 1.0);\n    float exponent = amt * 3.5;\n    return exp(-exponent*exponent);\n}\nvec4 calculateHatchPattern(vec2 hatchParams, vec2 coord, vec4 fragColor, vec3 hatchTintColor, float hatchTintIntensity ) {\n    float hatchSlope = hatchParams.x;\n    float hatchPeriod = hatchParams.y;\n    if (abs(hatchSlope) <= 1.0) {\n        float hatchPhase = coord.y - hatchSlope * coord.x;\n        float dist = abs(mod((hatchPhase), (hatchPeriod)));\n        if (dist < 1.0) {\n            fragColor = vec4(0.0,0.0,0.0,1.0);\n        } else {\n            fragColor.xyz = mix(fragColor.xyz, hatchTintColor, hatchTintIntensity);\n        }\n    } else {\n        float hatchPhase = - coord.y / hatchSlope + coord.x;\n        float dist = abs(mod((hatchPhase), (hatchPeriod)));\n        if (dist < 1.0) {\n            fragColor = vec4(0.0,0.0,0.0,1.0);\n        } else {\n            fragColor.xyz = mix(fragColor.xyz, hatchTintColor, hatchTintIntensity);\n        }\n    }\n    return fragColor;\n}\n#endif\n",Zs.env_sample="\nuniform float envRotationSin;\nuniform float envRotationCos;\nvec3 adjustLookupVector(in vec3 lookup) {\n    return vec3(\n            envRotationCos * lookup.x - envRotationSin * lookup.z,\n            lookup.y,\n            envRotationSin * lookup.x + envRotationCos * lookup.z);\n}\nvec3 RGBMDecode(in vec4 vRGBM, in float exposure) {\n    vec3 ret = vRGBM.rgb * (vRGBM.a * 16.0);\n    ret *= ret;\n    ret *= exposure;\n    return ret;\n}\nvec3 GammaDecode(in vec4 vRGBA, in float exposure) {\n    return vRGBA.xyz * vRGBA.xyz * exposure;\n}\nvec3 sampleIrradianceMap(vec3 dirWorld, samplerCube irrMap, float exposure) {\n    vec4 cubeColor4 = textureCube(irrMap, adjustLookupVector(dirWorld));\n#ifdef IRR_GAMMA\n    vec3 indirectDiffuse = GammaDecode(cubeColor4, exposure);\n#elif defined(IRR_RGBM)\n    vec3 indirectDiffuse = RGBMDecode(cubeColor4, exposure);\n#else\n    vec3 indirectDiffuse = cubeColor4.xyz;\n#ifdef GAMMA_INPUT\n    indirectDiffuse.xyz *= indirectDiffuse.xyz;\n#endif\n#endif\n    return indirectDiffuse;\n}\n",Zs.id_decl_vert="#ifdef USE_VERTEX_ID\nattribute vec3 id;\nvarying   vec3 vId;\n#endif\n",Zs.id_vert="\n#ifdef USE_VERTEX_ID\nvId = id;\n#endif\n",Zs.id_decl_frag="#if defined(MRT_NORMALS) || defined(MRT_ID_BUFFER)\nvarying highp float depth;\n#define gl_FragColor gl_FragData[0]\n#endif\n#if defined(MRT_ID_BUFFER) || defined(ID_COLOR)\n#ifdef USE_VERTEX_ID\nvarying vec3 vId;\n#else\nuniform vec3 dbId;\n#endif\n#endif\n#if defined(MRT_ID_BUFFER) || defined(MODEL_COLOR)\nuniform vec3 modelId;\n#endif\n",Zs.id_frag="\n#if defined(USE_VERTEX_ID) && (defined(MRT_ID_BUFFER) || defined(ID_COLOR))\nvec3 dbId = vId;\n#endif\n#ifdef MRT_ID_BUFFER\n#ifdef MRT_NORMALS\nconst int index = 2;\n#else\nconst int index = 1;\n#endif\n#ifndef ENABLE_ID_DISCARD\nconst float writeId = 1.0;\n#endif\ngl_FragData[index] = vec4(dbId.rgb, writeId);\n#ifdef MODEL_COLOR\ngl_FragData[index+1] = vec4(modelId.rgb, writeId);\n#endif\n#elif defined(ID_COLOR)\n#ifdef ENABLE_ID_DISCARD\nif (writeId==0.0) {\n    discard;\n}\n#endif\ngl_FragColor = vec4(dbId.rgb, 1.0);\n#elif defined(MODEL_COLOR)\n#ifdef ENABLE_ID_DISCARD\nif (writeId==0.0) {\n    discard;\n}\n#endif\ngl_FragColor = vec4(modelId.rgb, 1.0);\n#endif\n",Zs.final_frag="#ifdef HATCH_PATTERN\ngl_FragColor = calculateHatchPattern(hatchParams, gl_FragCoord.xy, gl_FragColor, hatchTintColor, hatchTintIntensity);\n#endif\n#if defined(USE_LOGDEPTHBUF) && defined(USE_LOGDEPTHBUF_EXT)\ngl_FragDepthEXT = log2(vFragDepth) * logDepthBufFC * 0.5;\n#endif\n#ifdef MRT_NORMALS\ngl_FragData[1] = vec4(normal.x, normal.y, depth, gl_FragColor.a < 1.0 ? 0.0 : 1.0);\n#endif\n#include<id_frag>\n",Zs.theming_decl_frag="uniform vec4 themingColor;\n",Zs.theming_frag="gl_FragColor.rgb = mix(gl_FragColor.rgb, themingColor.rgb, themingColor.a);\n",Zs.instancing_decl_vert="\n#ifdef USE_INSTANCING\nattribute vec3 instOffset;\nattribute vec4 instRotation;\nattribute vec3 instScaling;\nvec3 applyQuaternion(vec3 p, vec4 q) {\n    return p + 2.0 * cross(q.xyz, cross(q.xyz, p) + q.w * p);\n}\nvec3 getInstancePos(vec3 pos) {\n    return instOffset + applyQuaternion(instScaling * pos, instRotation);\n}\nvec3 getInstanceNormal(vec3 normal) {\n    return applyQuaternion(normal/instScaling, instRotation);\n}\n#else\nvec3 getInstancePos(vec3 pos)       { return pos;    }\nvec3 getInstanceNormal(vec3 normal) { return normal; }\n#endif\n",Zs.shadowmap_decl_common="\nuniform float shadowESMConstant;\nuniform float shadowMapRangeMin;\nuniform float shadowMapRangeSize;\n",Zs.shadowmap_decl_vert="\n#ifdef USE_SHADOWMAP\nvarying vec4 vShadowCoord;\nuniform mat4 shadowMatrix;\n#endif\n",Zs.shadowmap_vert="\n#ifdef USE_SHADOWMAP\n{\n    vec4 worldPosition = modelMatrix * vec4( position, 1.0 );\n    vShadowCoord = shadowMatrix * worldPosition;\n}\n#endif\n",Zs.shadowmap_decl_frag="\n#ifdef USE_SHADOWMAP\nuniform sampler2D shadowMap;\nuniform vec2      shadowMapSize;\nuniform float     shadowDarkness;\nuniform float     shadowBias;\nuniform vec3      shadowLightDir;\nvarying vec4 vShadowCoord;\n#include<shadowmap_decl_common>\nfloat getShadowValue() {\n    float fDepth;\n    vec3 shadowColor = vec3( 1.0 );\n    vec3 shadowCoord = vShadowCoord.xyz / vShadowCoord.w;\n    shadowCoord.xyz = 0.5 * (shadowCoord.xyz + vec3(1.0, 1.0, 1.0));\n    bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\n    bool inFrustum = all( inFrustumVec );\n    float shadowValue = 1.0;\n    if (inFrustum) {\n        shadowCoord.z = min(0.999, shadowCoord.z);\n        shadowCoord.z -= shadowBias;\n#ifdef USE_HARD_SHADOWS\n        vec4 rgbaDepth = texture2D( shadowMap, shadowCoord.xy );\n        float fDepth = rgbaDepth.r;\n        if ( fDepth < shadowCoord.z ) {\n            shadowValue = 1.0 - shadowDarkness;\n        }\n#else\n        vec4 rgbaDepth = texture2D( shadowMap, shadowCoord.xy );\n        float shadowMapValue = rgbaDepth.r;\n        shadowValue = exp(-shadowESMConstant * shadowCoord.z) * shadowMapValue;\n        shadowValue = min(shadowValue, 1.0);\n        shadowValue = mix(1.0 - shadowDarkness, 1.0, shadowValue);\n#endif\n    }\n    return shadowValue;\n}\n#else\nfloat getShadowValue() { return 1.0; }\n#endif\nvec3 applyEnvShadow(vec3 colorWithoutShadow, vec3 worldNormal) {\n#if defined(USE_SHADOWMAP)\n    float dp  = dot(shadowLightDir, worldNormal);\n    float dpValue = (dp + 1.0) / 2.0;\n    dpValue = min(1.0, dpValue * 1.5);\n    float sv = getShadowValue();\n    vec3 result = colorWithoutShadow * min(sv, dpValue);\n    return result;\n#else\n    return colorWithoutShadow;\n#endif\n}\n",Zs.float3_average="float averageOfFloat3(in vec3 value) { \n    const float oneThird = 1.0 / 3.0; \n    return dot(value, vec3(oneThird, oneThird, oneThird)); \n} \n",Zs.line_decl_common="\n#define TAU     6.28318530718\n#define PI      3.14159265358979\n#define HALF_PI 1.57079632679\n#define PI_0_5  HALF_PI\n#define PI_1_5  4.71238898038\n#define ENABLE_ID_DISCARD\n#define VBB_GT_TRIANGLE_INDEXED  0.0\n#define VBB_GT_LINE_SEGMENT      1.0\n#define VBB_GT_ARC_CIRCULAR      2.0\n#define VBB_GT_ARC_ELLIPTICAL    3.0\n#define VBB_GT_TEX_QUAD          4.0\n#define VBB_GT_ONE_TRIANGLE      5.0\n#define VBB_INSTANCED_FLAG   0.0\n#define VBB_SEG_START_RIGHT  0.0\n#define VBB_SEG_START_LEFT   1.0\n#define VBB_SEG_END_RIGHT    2.0\n#define VBB_SEG_END_LEFT     3.0\nvarying vec4 fsColor;\nvarying vec4 dbId;\nvarying vec2 fsOffsetDirection;\nvarying vec4 fsMultipurpose;\nvarying float fsHalfWidth;\nvarying vec2 fsVpTC;\nvarying float fsGhosting;\n",Zs.prism_wood=Bs,Zs.prism_glazing="\nvec3 TransmitAdjust(vec3 transmission, vec3 f0) \n{ \n   vec3 limit = max(1.0 - f0, 0.00001); \n   return clamp(transmission, vec3(0.0, 0.0, 0.0), limit) / limit; \n} \nfloat ColorToIlluminance(in vec3 color) \n{ \n   const vec3 rgb2grey = vec3(0.299, 0.587, 0.114); \n   float illuminance = dot(rgb2grey, color); \n   return illuminance; \n} \nvoid applyPrismGlazingOpacity(\n    inout vec4 color,\n    vec3 transmissionF,\n    float transmissionAlpha,\n    float NdotV,\n    float glazingIlluminace) \n{\n    const float third = 1.0/3.0; \n    float transSurface = exp(-(transmissionAlpha + (transmissionAlpha < 0.0025 ? 0.0 : 0.25)) * NdotV * PI); \n    float opacity = 1.0- dot((1.0 - transmissionF), vec3(third,third,third)) * transSurface * glazingIlluminace; \n    opacity = clamp(opacity, 0.01, 0.99);\n    color.a *= opacity;\n} \n",Zs.prism_transparency=zs,Zs.normal_map=Gs,Zs.decl_point_size="uniform float point_size;",Zs.point_size="gl_PointSize = point_size;",Zs.wide_lines_decl="\n#ifdef WIDE_LINES\nattribute vec3 prev;\nattribute vec3 next;\nattribute float side;\nuniform vec2 view_size;\nvec2 to2d(vec4 i) {\n  return i.xy / i.w;\n}\n#endif\n",Zs.wide_lines_vert="\n#ifdef WIDE_LINES\nvec4 mvpPosition = projectionMatrix * mvPosition; \nmat3 vectorMatrix = mat3(modelViewMatrix);\nvec2 _pos = to2d(mvpPosition) * view_size;\nvec2 _prev = to2d(projectionMatrix * vec4(mvPosition.xyz + vectorMatrix * (prev * 0.01), 1.0)) * view_size;\nvec2 _next = to2d(projectionMatrix * vec4(mvPosition.xyz - vectorMatrix * (next * 0.01), 1.0)) * view_size;\nvec2 dir1 = _pos - _next;\nvec2 dir2 = _prev - _pos;\ndir2 = (length(dir2) > 0.0000001) ? normalize(dir2) : vec2(0.0, 0.0);\ndir1 = (length(dir1) > 0.0000001) ? normalize(dir1) : dir2;\nvec2 dir_sharp = normalize(dir1 + dir2);\nvec2 dir = normalize(dir1 + dir_sharp);\nvec2 offset = vec2(-dir.y, dir.x);\nfloat len = 1.0 / cross(vec3(offset, 0), vec3(dir1, 0)).z;\noffset *= len;\noffset /= view_size;\noffset *= side;\noffset *= mvpPosition.w;\nmvpPosition.xy += offset;\ngl_Position = mvpPosition;\n#endif\n",Zs.hsv="vec3 rgb2hsv(vec3 color)\n{\n    float delta;\n    float colorMax, colorMin;\n    float h,s,v;\n    vec3 hsv;\n    colorMax = max(color.r,color.g);\n    colorMax = max(colorMax,color.b);\n    colorMin = min(color.r,color.g);\n    colorMin = min(colorMin,color.b);\n    v = colorMax;\n    if(colorMax != 0.0)\n    {\n        s = (colorMax - colorMin)/colorMax;\n    }\n    else\n    {\n        s = 0.0;\n    }\n    if(s != 0.0)\n    {\n        delta = colorMax-colorMin;\n        if (color.r == colorMax)\n        {\n            h = (color.g-color.b)/delta;\n        }\n        else if (color.g == colorMax)\n        {\n            h = 2.0 + (color.b-color.r) / delta;\n        }\n        else\n        {\n            h = 4.0 + (color.r-color.g)/delta;\n        }\n        h /= 6.0;\n        if( h < 0.0)\n        {\n            h +=1.0;\n        }\n    }\n    else\n    {\n        h = 0.0;\n    }\n    hsv = vec3(h,s,v);\n    return hsv;\n}\nvec3 hsv2rgb(vec3 hsv)\n{\n    vec3 color;\n    float f,p,q,t;\n    float h,s,v;\n    float i,hi;\n    {\n        h = hsv.x*6.0;\n        s = hsv.y;\n        v = hsv.z;\n        i = floor(h);\n        f = h-i;\n        p = v * (1.0 - s);\n        q = v * (1.0 - (s * f));\n        t = v * (1.0 - (s * (1.0 - f)));\n        float r,g,b;\n        if (i == 0.0)\n        {\n            r = v;\n            g = t;\n            b = p;\n        }\n        else if (i == 1.0)\n        {\n            r = q;\n            g = v;\n            b = p;\n        }\n        else if (i == 2.0)\n        {\n            r = p;\n            g = v;\n            b = t;\n        }\n        else if (i == 3.0)\n        {\n            r = p;\n            g = q;\n            b = v;\n        }\n        else if (i == 4.0)\n        {\n            r = t;\n            g = p;\n            b = v;\n        }\n        else\n        {\n            r = v;\n            g = p;\n            b = q;\n        }\n        color = vec3(r,g,b);\n    }\n    return color;\n}";var Js={};Js.prism_check=function(e){return["#if defined( USE_SURFACE_ALBEDO_MAP ) || defined( USE_SURFACE_ROUGHNESS_MAP ) || defined( USE_SURFACE_CUTOUT_MAP ) || defined( USE_SURFACE_ANISOTROPY_MAP ) || defined( USE_SURFACE_ROTATION_MAP ) || defined( USE_OPAQUE_ALBEDO_MAP ) || defined( USE_OPAQUE_F0_MAP ) || defined( USE_OPAQUE_LUMINANCE_MODIFIER_MAP ) || defined( USE_LAYERED_BOTTOM_F0_MAP ) || defined( USE_LAYERED_F0_MAP ) || defined( USE_LAYERED_DIFFUSE_MAP ) || defined( USE_LAYERED_FRACTION_MAP ) || defined( USE_LAYERED_ROUGHNESS_MAP ) || defined( USE_LAYERED_ANISOTROPY_MAP ) || defined( USE_LAYERED_ROTATION_MAP ) || defined( USE_METAL_F0_MAP ) || defined( USE_SURFACE_NORMAL_MAP ) || defined( USE_LAYERED_NORMAL_MAP )","#define "+e,"#endif"].join("\n")},Js.prism_sample_texture=function(e,t,n,r){return a(e,t,"true"===n,"true"===r)},Js.prism_uniforms=i,Js.prism_bump_uniforms=function(e){var t=e+"_texMatrix",n=e+"_bumpScale",r=e+"_bumpmapType";return["#if defined( "+("USE_"+e).toUpperCase()+" )","uniform sampler2D "+e+";","uniform mat3 "+t+";","uniform vec2 "+n+";","uniform int "+r+";","#endif"].join("\n")};var $s={};for(Qs in Js)$s[Qs]=new RegExp("#"+Qs+" *<([\\w\\d., ]*)>","g");var el=function e(t){for(var n in Js){var r=$s[n];t=t.replace(r,function(e,t){var r=t.split(",").map(function(e){return e.trim()});return Js[n].apply(null,r)})}var a=/#include *<([\w\d.]+)>/g;return t.replace(a,function(t,n){if(!Zs[n])throw new Error("Cannot resolve #include<"+n+">");return e(Zs[n])})},tl=Zs.pack_depth,nl=Zs.tonemap,rl=Zs.ordered_dither,al=Zs.cutplanes,il=Zs.pack_normals,ol=Zs.hatch_pattern,sl=Zs.env_sample,ll=Zs.id_decl_vert,ul=Zs.id_vert,fl=Zs.id_decl_frag,dl=Zs.id_frag,cl=Zs.final_frag,pl=Zs.theming_decl_frag,hl=Zs.theming_frag,ml=Zs.instancing_decl_vert,_l=Zs.shadowmap_decl_common,vl=Zs.shadowmap_decl_vert,gl=Zs.shadowmap_vert,yl=Zs.shadowmap_decl_frag,xl=Zs.decl_point_size,bl=Zs.point_size,wl={IdUniforms:Hs,ThemingUniform:Ws,CutPlanesUniforms:ks,ShadowMapCommonUniforms:qs,ShadowMapUniforms:js,PointSizeUniforms:Xs,WideLinesUniforms:Ys,DepthTextureUniforms:Ks,PackDepthShaderChunk:tl,TonemapShaderChunk:nl,OrderedDitheringShaderChunk:rl,CutPlanesShaderChunk:al,PackNormalsShaderChunk:il,HatchPatternShaderChunk:ol,EnvSamplingShaderChunk:sl,IdVertexDeclaration:ll,IdVertexShaderChunk:ul,IdFragmentDeclaration:fl,IdOutputShaderChunk:dl,FinalOutputShaderChunk:cl,ThemingFragmentDeclaration:pl,ThemingFragmentShaderChunk:hl,InstancingVertexDeclaration:ml,ShadowMapDeclareCommonUniforms:_l,ShadowMapVertexDeclaration:vl,ShadowMapVertexShaderChunk:gl,ShadowMapFragmentDeclaration:yl,PointSizeDeclaration:xl,PointSizeShaderChunk:bl,GetPrismMapSampleChunk:a,GetPrismMapUniformChunk:i,resolve:el},Ml={uniforms:t.UniformsUtils.merge([t.UniformsLib.common,t.UniformsLib.fog,t.UniformsLib.shadowmap,wl.CutPlanesUniforms,wl.IdUniforms,wl.ThemingUniform,wl.PointSizeUniforms,wl.WideLinesUniforms]),vertexShader:"#include<id_decl_vert>\n#include<decl_point_size>\n#include<common>\n#include<map_pars_vertex>\n#include<lightmap_pars_vertex>\n#include<envmap_pars_vertex>\n#include<color_pars_vertex>\n#include<morphtarget_pars_vertex>\n#include<skinning_pars_vertex>\n#include<logdepthbuf_pars_vertex>\n#include<wide_lines_decl>\n#if NUM_CUTPLANES > 0\nvarying vec3 vWorldPosition;\n#endif\nvoid main() {\n#include<map_vertex>\n#include<lightmap_vertex>\n#include<color_vertex>\n#include<skinbase_vertex>\n#ifdef USE_ENVMAP\n#include<morphnormal_vertex>\n#include<skinnormal_vertex>\n#include<defaultnormal_vertex>\n#endif\n#include<morphtarget_vertex>\n#include<skinning_vertex>\n#include<default_vertex>\n#include<wide_lines_vert>\n#include<logdepthbuf_vertex>\n#include<worldpos_vertex>\n#if NUM_CUTPLANES > 0\n    vec4 _worldPosition = modelMatrix * vec4( position, 1.0 );\n    vWorldPosition = _worldPosition.xyz;\n#endif\n#include<envmap_vertex>\n#include<id_vert>\n#include<point_size>\n}\n",fragmentShader:"uniform vec3 diffuse;\nuniform float opacity;\n#include<common>\n#include<color_pars_fragment>\n#include<map_pars_fragment>\n#include<alphamap_pars_fragment>\n#include<lightmap_pars_fragment>\n#include<envmap_pars_fragment>\n#include<fog_pars_fragment>\n#include<specularmap_pars_fragment>\n#include<logdepthbuf_pars_fragment>\n#if NUM_CUTPLANES > 0\nvarying highp vec3 vWorldPosition;\n#endif\n#include<cutplanes>\n#include<id_decl_frag>\n#include<theming_decl_frag>\nvoid main() {\n#if NUM_CUTPLANES > 0\n    checkCutPlanes(vWorldPosition);\n#endif\n    vec3 outgoingLight = vec3( 0.0 );\n    vec4 diffuseColor = vec4( diffuse, opacity );\n#include<logdepthbuf_fragment>\n#include<map_fragment>\n#include<color_fragment>\n#include<alphamap_fragment>\n#include<alphatest_fragment>\n#include<specularmap_fragment>\n    outgoingLight = diffuseColor.rgb;\n#include<lightmap_fragment>\n#include<envmap_fragment>\n#include<linear_to_gamma_fragment>\n#include<fog_fragment>\n    gl_FragColor = vec4( outgoingLight, diffuseColor.a );\n#include<theming_frag>\n#include<final_frag>\n}\n"};t.ShaderLib.firefly_basic=Ml;var Sl="varying vec2 vUv;\nvoid main() {\n    vUv = uv;\n    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}\n",Tl={uniforms:{tDiffuse:{type:"t",value:null},tAO:{type:"t",value:null},useAO:{type:"i",value:0},aoOpacity:{type:"f",value:1},tOverlay:{type:"t",value:null},useOverlay:{type:"i",value:0},tID:{type:"t",value:null},objID:{type:"i",value:0},objIDv4:{type:"v4",value:new t.Vector4(0,0,0,0)},tID2:{type:"t",value:null},modelIDv2:{type:"v2",value:new t.Vector2(0,0)},highlightIntensity:{type:"f",value:1},selectionColor:{type:"c",value:new t.Color(0,0,0)},expand2dSelection:{type:"f",value:.5},resolution:{type:"v2",value:new t.Vector2(1/1024,1/512)},highlightRange:{type:"i",value:0},objIDStart:{type:"i",value:0},objIDEnd:{type:"i",value:0}},vertexShader:Sl,fragmentShader:"uniform sampler2D tDiffuse;\nuniform sampler2D tAO;\nuniform int useAO;\nuniform float aoOpacity;\nuniform sampler2D tOverlay;\nuniform int useOverlay;\nuniform vec2 resolution;\nuniform int objID;\nuniform vec4 objIDv4;\nuniform sampler2D tID;\n#if defined(USE_MODEL_ID)\nuniform vec2 modelIDv2;\nuniform sampler2D tID2;\n#endif\nuniform float highlightIntensity;\nuniform vec3 selectionColor;\nuniform int highlightRange;\nuniform int objIDStart;\nuniform int objIDEnd;\n#ifdef IS_2D\nuniform float expand2dSelection;\n#endif\nvarying vec2 vUv;\n#include<tonemap>\nbool isSelected(vec3 C) {\n    float minS = min(selectionColor.r, min(selectionColor.g, selectionColor.b));\n    float maxS = max(selectionColor.r, max(selectionColor.g, selectionColor.b));\n    float satS = maxS - minS;\n    float minC = min(C.r, min(C.g, C.b));\n    float maxC = max(C.r, max(C.g, C.b));\n    float satC = maxC - minC;\n    if (satC < .01 || satS < .01)\n        return false;\n    vec3 S = (selectionColor - minS) / satS;\n    vec3 H = (C - minC) / satC;\n    vec3 D = H - S;\n    float eps = .15;\n    return (abs(D.r) + abs(D.g) + abs(D.b) < eps)\n        || (maxC >= (1.0 - eps) && D.r >= -eps && D.g >= -eps && D.b >= -eps);\n}\nvec4 overlayEdgeDetect(vec2 vUv) {\n#define IS_SELECTION(C) isSelected((C).rgb)\n#ifdef IS_2D\n#define MAX_ALPHA(c)\n#define SUM_ALPHA(c, w) sumAlpha += c.a * w; sumWeight += w;\n#else\n#define MAX_ALPHA(c) maxAlpha = max(maxAlpha, c.a);\n#define SUM_ALPHA(c, w) \n#endif\n#define CHECK_EDGE_ALPHA(I, J, W)     { vec4 c = texture2D( tOverlay, vUv+resolution*vec2((I),(J)) ); MAX_ALPHA(c) if (c.a > 0.0 && IS_SELECTION(c)) { hasEdge++; SUM_ALPHA(c, W) selectionPixel = c; } }\n#ifndef IS_2D\n#define CHECK_EDGE_SELECTION(I, J) { vec4 c = texture2D( tOverlay, vUv+resolution*vec2((I),(J)) ); MAX_ALPHA(c) if (c.a <= 0.0) hasEdge++; }\n#endif\n    int hasEdge = 0;\n    vec4 center = texture2D(tOverlay, vUv);\n    vec4 selectionPixel = vec4(0.0);\n#ifdef IS_2D\n    float sumAlpha = 0.0, sumWeight = 0.0;\n#else\n    float maxAlpha = 0.0;\n    bool paintOutline = false;\n#endif\n    if (center.a <= 0.0) {\n        CHECK_EDGE_ALPHA(-1.0,-1.0, 1.0);\n        CHECK_EDGE_ALPHA( 0.0,-1.0, 2.0);\n        CHECK_EDGE_ALPHA( 1.0,-1.0, 1.0);\n        CHECK_EDGE_ALPHA(-1.0, 0.0, 2.0);\n        CHECK_EDGE_ALPHA( 1.0, 0.0, 2.0);\n        CHECK_EDGE_ALPHA(-1.0, 1.0, 1.0);\n        CHECK_EDGE_ALPHA( 0.0, 1.0, 2.0);\n        CHECK_EDGE_ALPHA( 1.0, 1.0, 1.0);\n        if (hasEdge != 0) {\n#ifdef IS_2D\n            center.a = -clamp(expand2dSelection - 1.0 + sumAlpha / sumWeight, 0.0, 1.0);\n            center.rgb = center.a < 0.0 ? selectionPixel.rgb : center.rgb;\n#else\n            center = selectionPixel;\n            paintOutline = true;\n#endif\n        }\n    }\n    else if (center.a > 0.0 && IS_SELECTION(center)) {\n#ifdef IS_2D\n        center.a = -clamp(center.a + expand2dSelection, 0.0, 1.0);\n#else\n        CHECK_EDGE_SELECTION(-1.0,-1.0);\n        CHECK_EDGE_SELECTION( 0.0,-1.0);\n        CHECK_EDGE_SELECTION( 1.0,-1.0);\n        CHECK_EDGE_SELECTION(-1.0, 0.0);\n        CHECK_EDGE_SELECTION( 1.0, 0.0);\n        CHECK_EDGE_SELECTION(-1.0, 1.0);\n        CHECK_EDGE_SELECTION( 0.0, 1.0);\n        CHECK_EDGE_SELECTION( 1.0, 1.0);\n        if (hasEdge != 0)\n            paintOutline = true;\n        else\n            center.a = -center.a;\n#endif\n    }\n#ifndef IS_2D\n    if (paintOutline) {\n        float maxComponent = max(center.r, max(center.g, center.b));\n        center.rgb /= maxComponent;\n        center.rgb = sqrt(center.rgb);\n        center.a = 0.5 + 0.5 * maxAlpha * 0.125 * float(hasEdge);\n    }\n#endif\n    return center;\n}\nvec4 sampleColor() {\n    return texture2D( tDiffuse, vUv );\n}\nfloat sampleAO() {\n    return (useAO != 0) ? sqrt(texture2D(tAO, vUv).r) : 1.0;\n}\nvoid applyHighlighting(inout vec3 rgb) {\n#ifdef IS_2D\n    rgb = mix(rgb, vec3(1.0,1.0,0.0), highlightIntensity * 0.25);\n#else\n    rgb += highlightIntensity * 0.20;\n#endif\n}\nvoid main() {\n    vec4 texel = sampleColor();\n    float ao = sampleAO();\n    ao = 1.0 - (1.0 - ao) * aoOpacity;\n    texel.rgb *= ao;\n    if (useOverlay != 0) {\n        vec4 overlay = overlayEdgeDetect(vUv);\n        if (overlay.a < 0.0) {\n            overlay.a = -overlay.a;\n#ifdef IS_2D\n            overlay.a *= 0.75;\n#else\n            if (overlay.a >= 0.99) {\n                overlay.a = 0.75;\n                texel.rgb = vec3(luminance_post(texel.rgb));\n            }\n#endif\n        }\n        texel.rgb = mix(texel.rgb, sqrt(overlay.rgb), overlay.a);\n    }\n    if (highlightRange == 0) {\n        if (objID != 0) {\n            vec4 idAtPixel = texture2D(tID, vUv);\n#if defined(USE_MODEL_ID)\n            vec4 modelAtPixel = texture2D(tID2, vUv);\n            idAtPixel.a = modelAtPixel.b;\n            vec4 idDelta = abs(idAtPixel.rgba - objIDv4.rgba);\n            vec2 modelDelta = abs(modelAtPixel.rg - modelIDv2.rg);\n#else\n            vec4 idDelta = vec4(abs(idAtPixel.rgb - objIDv4.rgb), 0.0);\n            vec2 modelDelta = vec2(0.0, 0.0);\n#endif\n            if (max(max(modelDelta.r, modelDelta.g), max(max(idDelta.r, idDelta.g), max(idDelta.b, idDelta.a))) < 1e-3) {\n                applyHighlighting(texel.rgb);\n            }\n        }\n    } else {\n        vec4 idAtPixel = texture2D(tID, vUv);\n        int dbId = int(idAtPixel.r * 255.0 + idAtPixel.g * 255.0 * 256.0 + idAtPixel.b * 255.0 * 256.0 * 256.0);\n        if (dbId >= objIDStart && dbId <= objIDEnd) {\n            applyHighlighting(texel.rgb);\n        }\n    }\n    gl_FragColor = texel;\n}\n"},Al={uniforms:t.UniformsUtils.merge([wl.DepthTextureUniforms,{tDiffuse:{type:"t",value:null},tID:{type:"t",value:null},resolution:{type:"v2",value:new t.Vector2(1/1024,1/512)},cameraNear:{type:"f",value:1},cameraFar:{type:"f",value:100},tFill:{type:"t",value:null},tPaper:{type:"t",value:null},style:{type:"i",value:0},idEdges:{type:"i",value:1},normalEdges:{type:"i",value:1},depthEdges:{type:"i",value:1},brightness:{type:"f",value:0},contrast:{type:"f",value:0},grayscale:{type:"i",value:0},preserveColor:{type:"i",value:0},levels:{type:"f",value:6},repeats:{type:"f",value:3},rotation:{type:"f",value:0},tGraphite1:{type:"t",value:null},tGraphite2:{type:"t",value:null},tGraphite3:{type:"t",value:null},tGraphite4:{type:"t",value:null},tGraphite5:{type:"t",value:null},tGraphite6:{type:"t",value:null},tGraphite7:{type:"t",value:null},tGraphite8:{type:"t",value:null}}]),vertexShader:Sl,fragmentShader:"#extension GL_OES_standard_derivatives : enable\n#include<depth_texture>\nuniform sampler2D tDiffuse;\nuniform sampler2D tID;\nuniform vec2 resolution;\nuniform float cameraNear;\nuniform float cameraFar;\nuniform sampler2D tFill;\nuniform sampler2D tPaper;\nuniform int style;\nuniform int idEdges;\nuniform int normalEdges;\nuniform int depthEdges;\nuniform float brightness;\nuniform float contrast;\nuniform int grayscale;\nuniform int preserveColor;\nuniform float levels;\nuniform float repeats;\nuniform float rotation;\nuniform sampler2D tGraphite1;\nuniform sampler2D tGraphite2;\nuniform sampler2D tGraphite3;\nuniform sampler2D tGraphite4;\nuniform sampler2D tGraphite5;\nuniform sampler2D tGraphite6;\nuniform sampler2D tGraphite7;\nuniform sampler2D tGraphite8;\nvarying vec2 vUv;\nvec4 recoverNZ(vec4 nrmz) {\n    float z = sqrt(1.0 - dot(nrmz.xy, nrmz.xy));\n    nrmz.w = -(nrmz.z + cameraNear) / (cameraFar - cameraNear);\n    nrmz.z = z;\n    return nrmz;\n}\n#include<tonemap>\n#include<hsv>\nvec3 quantize(vec3 c) {\n    float L = max(c.r, max(c.g, c.b));\n    c *= floor(L * (levels-1.0) + 0.5) / (L * (levels-1.0));\n    return c;\n}\nvec3 quantizeRGB(vec3 c) {\n    c *= c;\n    c *= floor(c * levels * 0.9999) / (levels-1.0);\n    return sqrt(c);\n}\nvec3 clampHue(vec3 c, float hues, float sats, float vals) {\n    vec3 hsv = rgb2hsv(c);\n    hsv.x = floor(hsv.x * hues + 0.5) / hues;\n    hsv.y = floor(hsv.y * sats + 0.5) / sats;\n    hsv.z = floor(hsv.z * vals + 0.5) / vals;\n    vec3 col = hsv2rgb(hsv);\n    return col;\n}\nvec3 reconstructCSFaceNormal(vec3 C) {\n    return normalize(cross(dFdy(C), dFdx(C)));\n}\nvec3 getPosition(ivec2 ssP, float depth) {\n    vec3 P;\n    P = reconstructCSPosition(vec2(ssP) + vec2(0.5), depth);\n    return P;\n}\nint isObjectEdge() {\n    vec4 MM = texture2D(tID, vUv);\n    vec4 LL = texture2D(tID, vUv + vec2(-1.0, -1.0) * resolution);\n    if (MM != LL) return 1;\n    vec4 LM = texture2D(tID, vUv + vec2( 0.0, -1.0) * resolution);\n    if (MM != LM) return 1;\n    vec4 LR = texture2D(tID, vUv + vec2( 1.0, -1.0) * resolution);\n    if (MM != LR) return 1;\n    vec4 ML = texture2D(tID, vUv + vec2(-1.0,  0.0) * resolution);\n    if (MM != ML) return 1;\n    vec4 MR = texture2D(tID, vUv + vec2( 1.0,  0.0) * resolution);\n    if (MM != MR) return 1;\n    vec4 UL = texture2D(tID, vUv + vec2(-1.0,  1.0) * resolution);\n    if (MM != UL) return 1;\n    vec4 UM = texture2D(tID, vUv + vec2( 0.0,  1.0) * resolution);\n    if (MM != UM) return 1;\n    vec4 UR = texture2D(tID, vUv + vec2( 1.0,  1.0) * resolution);\n    if (MM != UR) return 1;\n    return (MM.x + MM.y + MM.z + MM.w) >= 4.0 ? 0 : -1;\n}\nconst float r = 1.0;\nfloat normalDiff(vec3 n1, vec3 n2) {\n    float d = dot(n1.xyz, n2.xyz);\n    return acos(clamp(d, -1.0, 1.0));\n}\nint isNormalDepthEdge() {\n    ivec2 ssC = ivec2(gl_FragCoord.xy);\n    vec4 MM = texture2D(tDepth, vUv);\n    vec4 LL = texture2D(tDepth, vUv + vec2(-r, -r) * resolution);\n    vec4 LM = texture2D(tDepth, vUv + vec2( 0.0, -r) * resolution);\n    vec4 LR = texture2D(tDepth, vUv + vec2( r, -r) * resolution);\n    vec4 ML = texture2D(tDepth, vUv + vec2(-r,  0.0) * resolution);\n    vec4 MR = texture2D(tDepth, vUv + vec2( r,  0.0) * resolution);\n    vec4 UL = texture2D(tDepth, vUv + vec2(-r, r) * resolution);\n    vec4 UM = texture2D(tDepth, vUv + vec2( 0.0,  r) * resolution);\n    vec4 UR = texture2D(tDepth, vUv + vec2( r,  r) * resolution);\n    LL = recoverNZ(LL);\n    LM = recoverNZ(LM);\n    LR = recoverNZ(LR);\n    ML = recoverNZ(ML);\n    MM = recoverNZ(MM);\n    MR = recoverNZ(MR);\n    UL = recoverNZ(UL);\n    UM = recoverNZ(UM);\n    UR = recoverNZ(UR);\n    float dd = 0.0;\n    if ( depthEdges == 1 ) {\n        float G = (abs(UL.w - MM.w) + 2.0 * abs(UM.w - MM.w) + abs(UR.w - MM.w) + 2.0 * abs(ML.w - MM.w) + 2.0 * abs(MR.w - MM.w) + abs(LL.w - MM.w) + 2.0 * abs(LM.w - MM.w) + abs(LR.w - MM.w));\n        dd = abs(dFdx(G)) + abs(dFdy(G));\n    }\n    float Gn = 0.0;\n    if ( normalEdges == 1 ) {\n        float pLL = normalDiff(LL.xyz, MM.xyz);\n        float pLM = normalDiff(LM.xyz, MM.xyz);\n        float pLR = normalDiff(LR.xyz, MM.xyz);\n        float pML = normalDiff(ML.xyz, MM.xyz);\n        float pMM = normalDiff(MM.xyz, MM.xyz);\n        float pMR = normalDiff(MR.xyz, MM.xyz);\n        float pUL = normalDiff(UL.xyz, MM.xyz);\n        float pUM = normalDiff(UM.xyz, MM.xyz);\n        float pUR = normalDiff(UR.xyz, MM.xyz);\n        Gn = (abs(pUL - pMM) + 2.0 * abs(pUM - pMM) + abs(pUR - pMM) + 2.0 * abs(pML - pMM) + 2.0 * abs(pMR - pMM) + abs(pLL - pMM) + 2.0 * abs(pLM - pMM) + abs(pLR - pMM));\n    }\n    \n    return (dd > 0.004 || Gn > 2.0) ? 1 : 0;\n}\nvec3 computeGraphite( vec3 color, vec2 loc ) {\n    float lum = 0.299 * color.r + 0.587 * color.g + 0.114 * color.b;\n    float offset;\n    vec3 col1, col2;\n    if ( lum > 6.0/7.0 ) {\n        col1 = texture2D(tGraphite1, loc ).xyz;\n        col2 = texture2D(tGraphite2, loc ).xyz;\n        offset = 6.0/7.0;\n    } else if ( lum > 5.0/7.0 ) {\n        col1 = texture2D(tGraphite2, loc ).xyz;\n        col2 = texture2D(tGraphite3, loc ).xyz;\n        offset = 5.0/7.0;\n    } else if ( lum > 4.0/7.0 ) {\n        col1 = texture2D(tGraphite3, loc ).xyz;\n        col2 = texture2D(tGraphite4, loc ).xyz;\n        offset = 4.0/7.0;\n    } else if ( lum > 3.0/7.0 ) {\n        col1 = texture2D(tGraphite4, loc ).xyz;\n        col2 = texture2D(tGraphite5, loc ).xyz;\n        offset = 3.0/7.0;\n    } else if ( lum > 2.0/7.0 ) {\n        col1 = texture2D(tGraphite5, loc ).xyz;\n        col2 = texture2D(tGraphite6, loc ).xyz;\n        offset = 2.0/7.0;\n    } else if ( lum > 1.0/7.0 ) {\n        col1 = texture2D(tGraphite6, loc ).xyz;\n        col2 = texture2D(tGraphite7, loc ).xyz;\n        offset = 1.0/7.0;\n    } else {\n        col1 = texture2D(tGraphite7, loc ).xyz;\n        col2 = texture2D(tGraphite8, loc ).xyz;\n        offset = 0.0;\n    }\n    if ( col1.r == 0.0 && col2.r == 0.0 ) {\n        return vec3(lum,lum,lum);\n    }\n    float t = (lum-offset)*7.0;\n    return (col1 * t + col2 * (1.0 - t));\n}\nvec3 colorWithAdjustments() {\n    vec3 sceneRGB = texture2D(tDiffuse, vUv).xyz;\n    if ( brightness != 0.0 || contrast != 0.0) {\n        if ( brightness < 0.0 )\n        {\n            sceneRGB = sceneRGB * (1.0 + brightness);\n        }\n        else\n        {\n            sceneRGB = sceneRGB + ((1.0 - sceneRGB) * brightness);\n        }\n        float slant = tan(( clamp(contrast,-1.0,1.0) + 1.0) * 3.141592/4.001);\n        sceneRGB = (sceneRGB - 0.5) * slant + 0.5;\n        if ( preserveColor == 1 )\n        {\n            float maxval = max( sceneRGB.r, sceneRGB.g );\n            maxval = max( maxval, sceneRGB.b );\n            if ( maxval > 1.0 )\n            {\n                sceneRGB /= maxval;\n            }\n        }\n        sceneRGB = clamp(sceneRGB,0.0,1.0);\n    }\n    if ( grayscale == 1 ) {\n        sceneRGB.rgb = vec3(luminance_post(sceneRGB.rgb));\n    }\n    return sceneRGB;\n}\nvoid main() {\n    int foundEdge = 0;\n    foundEdge = ( idEdges == 1 && isObjectEdge() == 1 ) ? 1 : 0;\n    if ( foundEdge == 0 && (normalEdges == 1 || depthEdges == 1) ) {\n        foundEdge = isNormalDepthEdge();\n    }\n    vec2 loc = vec2((vUv.x-0.5)*(resolution.y/resolution.x),vUv.y-0.5)*repeats;\n    if ( style > 2 && rotation != 0.0 ) {\n        float rot = 3.14159*rotation;\n        float sinr = sin(rot);\n        float cosr = cos(rot);\n        loc = vec2(loc.x*cosr + -loc.y*sinr, loc.x*sinr + loc.y*cosr);\n    }\n    loc += vec2(0.5,0.5);\n    vec3 color;\n    if ( style == 2 ) {\n        if ( foundEdge == 1 ) {\n            gl_FragColor = vec4(0.0,0.0,0.0,1.0);\n        } else {\n            gl_FragColor = vec4(quantize(colorWithAdjustments()),1.0);\n        }\n    } else if ( style == 3 ) {\n        color = colorWithAdjustments();\n        vec3 graphColor = computeGraphite( color, loc );\n        if ( foundEdge == 1 ) {\n            gl_FragColor = vec4(0.16,0.16,0.16,1.0) + vec4(0.18 * graphColor,0.0);\n        } else {\n            gl_FragColor = vec4(graphColor,1.0);\n        }\n        return;\n    } else if ( style == 4 ) {\n        float fill = texture2D(tFill, loc ).r;\n        float paperStrength = 0.3;\n        vec3 paper = texture2D(tPaper, loc ).rgb;\n        paper = paperStrength * paper + (1.0-paperStrength)*vec3(1.0,1.0,1.0);\n        if ( foundEdge == 1 ) {\n            gl_FragColor = 0.75 * vec4(paper * fill, 1.0);\n        } else {\n            fill = pow(fill,1.6);\n            gl_FragColor = vec4(colorWithAdjustments() * (1.0 - fill) + paper * fill, 1.0);\n        }\n    } else {\n        if ( foundEdge == 1 ) {\n            gl_FragColor = vec4(0.0,0.0,0.0,1.0);\n        } else {\n            gl_FragColor = vec4(colorWithAdjustments(),1.0);\n        }\n        return;        \n    }\n}\n"},El={uniforms:{tDiffuse:{type:"t",value:null}},vertexShader:Sl,fragmentShader:"uniform sampler2D tDiffuse;\nvarying vec2 vUv;\nvoid main() {\n    gl_FragColor = texture2D(tDiffuse, vUv);\n}\n"},Rl={uniforms:{color:{type:"v4",value:new t.Vector4(0,0,0,0)}},vertexShader:Sl,fragmentShader:"uniform vec4 color;\nvoid main() {\n    gl_FragColor = color;\n}\n"},Ll={uniforms:{tHighlight0:{type:"t",value:null},tHighlight1:{type:"t",value:null},edgeColor:{type:"v4",value:new t.Vector4(1,1,1,1)}},vertexShader:Sl,fragmentShader:"\nuniform sampler2D tHighlight1;\nuniform sampler2D tHighlight0;\nuniform vec4 edgeColor;\nvarying vec2 vUv;\nvoid main() {\n    vec4 top = texture2D(tHighlight0, vUv);\n    vec4 base = texture2D(tHighlight1, vUv);\n    gl_FragColor = all(lessThan(abs(base - edgeColor), vec4(1.0e-2))) ?  base : (base * (1.0 - top.a) + top);\n}\n"},Pl={uniforms:{tDiffuse:{type:"t",value:null},uResolution:{type:"v2",value:new t.Vector2(1/1024,1/512)}},vertexShader:"uniform vec2 uResolution;\nvarying vec2 vPos;\nvarying vec4 vPosPos;\nvoid main() {\n    vPos = uv;\n    vPosPos.xy = uv + vec2(-0.5, -0.5) * uResolution;\n    vPosPos.zw = uv + vec2( 0.5,  0.5) * uResolution;\n    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}\n",fragmentShader:"#define FXAA_EDGE_SHARPNESS (8.0)\n#define FXAA_EDGE_THRESHOLD (0.125)\n#define FXAA_EDGE_THRESHOLD_MIN (0.05)\n#define FXAA_RCP_FRAME_OPT (0.50)\n#define FXAA_RCP_FRAME_OPT2 (2.0)\nuniform sampler2D tDiffuse;\nuniform highp vec2 uResolution;\nvarying vec2 vPos;\nvarying vec4 vPosPos;\nfloat FxaaLuma(vec3 rgb) {\n    return dot(rgb, vec3(0.299, 0.587, 0.114));\n}\nvoid main() {\n    float lumaNw = FxaaLuma(texture2D(tDiffuse, vPosPos.xy).rgb);\n    float lumaSw = FxaaLuma(texture2D(tDiffuse, vPosPos.xw).rgb);\n    float lumaNe = FxaaLuma(texture2D(tDiffuse, vPosPos.zy).rgb) + 1.0/384.0;\n    float lumaSe = FxaaLuma(texture2D(tDiffuse, vPosPos.zw).rgb);\n    vec3 rgbM = texture2D(tDiffuse, vPos.xy).rgb;\n    float lumaM = FxaaLuma(rgbM.rgb);\n    float lumaMax = max(max(lumaNe, lumaSe), max(lumaNw, lumaSw));\n    float lumaMin = min(min(lumaNe, lumaSe), min(lumaNw, lumaSw));\n    float lumaMaxSubMinM = max(lumaMax, lumaM) - min(lumaMin, lumaM);\n    float lumaMaxScaledClamped = max(FXAA_EDGE_THRESHOLD_MIN, lumaMax * FXAA_EDGE_THRESHOLD);\n    if (lumaMaxSubMinM < lumaMaxScaledClamped) {\n        gl_FragColor = vec4(rgbM, 1.0);\n        return;\n    }\n    float dirSwMinusNe = lumaSw - lumaNe;\n    float dirSeMinusNw = lumaSe - lumaNw;\n    vec2 dir1 = normalize(vec2(dirSwMinusNe + dirSeMinusNw, dirSwMinusNe - dirSeMinusNw));\n    vec3 rgbN1 = texture2D(tDiffuse, vPos.xy - dir1 * FXAA_RCP_FRAME_OPT*uResolution).rgb;\n    vec3 rgbP1 = texture2D(tDiffuse, vPos.xy + dir1 * FXAA_RCP_FRAME_OPT*uResolution).rgb;\n    float dirAbsMinTimesC = min(abs(dir1.x), abs(dir1.y)) * FXAA_EDGE_SHARPNESS;\n    vec2 dir2 = clamp(dir1.xy / dirAbsMinTimesC, -2.0, 2.0);\n    vec3 rgbN2 = texture2D(tDiffuse, vPos.xy - dir2 * FXAA_RCP_FRAME_OPT2*uResolution).rgb;\n    vec3 rgbP2 = texture2D(tDiffuse, vPos.xy + dir2 * FXAA_RCP_FRAME_OPT2*uResolution).rgb;\n    vec3 rgbA = rgbN1 + rgbP1;\n    vec3 rgbB = ((rgbN2 + rgbP2) * 0.25) + (rgbA * 0.25);\n    float lumaB = FxaaLuma(rgbB);\n    if ((lumaB < lumaMin) || (lumaB > lumaMax))\n        gl_FragColor = vec4(rgbA * 0.5, 1.0);\n    else\n        gl_FragColor = vec4(rgbB, 1.0);\n}\n"},Il={uniforms:{tDiffuse:{type:"t",value:null},size:{type:"v2",value:new t.Vector2(512,512)},resolution:{type:"v2",value:new t.Vector2(1/512,1/512)},axis:{type:"v2",value:new t.Vector2(1,0)},radius:{type:"f",value:50}},vertexShader:Sl,fragmentShader:"\n#define EDGE_SHARPNESS     (3.0)\n#define SCALE               (2)\n#define R                   (4)\n#define VALUE_TYPE        float\n#define VALUE_COMPONENTS   r\n#define VALUE_IS_KEY       0\n#define KEY_COMPONENTS     gb\n#if __VERSION__ >= 330\nconst float gaussian[R + 1] =\nfloat[](0.153170, 0.144893, 0.122649, 0.092902, 0.062970);\n#endif\nuniform sampler2D   tDiffuse;\nuniform vec2 size;\nuniform vec2 resolution;\nuniform vec2       axis;\nuniform float radius;\n#define  result         gl_FragColor.VALUE_COMPONENTS\n#define  keyPassThrough gl_FragColor.KEY_COMPONENTS\nfloat unpackKey(vec2 p) {\n    return p.x + p.y * (1.0 / 255.0);\n}\nvarying vec2 vUv;\nvoid main() {\n#   if __VERSION__ < 330\n    float gaussian[R + 1];\n#       if R == 3\n    gaussian[0] = 0.153170; gaussian[1] = 0.144893; gaussian[2] = 0.122649; gaussian[3] = 0.092902;\n#       elif R == 4\n    gaussian[0] = 0.153170; gaussian[1] = 0.144893; gaussian[2] = 0.122649; gaussian[3] = 0.092902; gaussian[4] = 0.062970;\n#       elif R == 6\n    gaussian[0] = 0.111220; gaussian[1] = 0.107798; gaussian[2] = 0.098151; gaussian[3] = 0.083953; gaussian[4] = 0.067458; gaussian[5] = 0.050920; gaussian[6] = 0.036108;\n#       endif\n#   endif\n    ivec2 axisi = ivec2(axis);\n    ivec2 ssC = ivec2(gl_FragCoord.xy);\n    vec4 temp = texture2D(tDiffuse, vUv);\n    gl_FragColor.gb = temp.KEY_COMPONENTS;\n    gl_FragColor.a = temp.a;\n    VALUE_TYPE sum = temp.VALUE_COMPONENTS;\n    if (temp.a == 0.0) {\n        result = sum;\n        return;\n    }\n    float key = unpackKey(keyPassThrough);\n    float BASE = gaussian[0];\n    float totalWeight = BASE;\n    sum *= totalWeight;\n    float scale = 1.5 / radius;\n    int r = -4; {\n        vec2 ssUV = vec2(ssC + axisi * (r * SCALE))*resolution;\n        temp = texture2D(tDiffuse, ssUV);\n        float      tapKey = unpackKey(temp.KEY_COMPONENTS);\n        VALUE_TYPE value  = temp.VALUE_COMPONENTS;\n        float weight = 0.3 + gaussian[4];\n        float dz = tapKey - key;\n        weight *= max(0.0, 1.0 - (EDGE_SHARPNESS * 2000.0) * abs(dz) * scale);\n        sum += value * weight;\n        totalWeight += weight;\n    }\n    r = -3; {\n        vec2 ssUV = vec2(ssC + axisi * (r * SCALE))*resolution;\n        temp = texture2D(tDiffuse, ssUV);\n        float      tapKey = unpackKey(temp.KEY_COMPONENTS);\n        VALUE_TYPE value  = temp.VALUE_COMPONENTS;\n        float weight = 0.3 + gaussian[3];\n        float dz = tapKey - key;\n        weight *= max(0.0, 1.0 - (EDGE_SHARPNESS * 2000.0) * abs(dz) * scale);\n        sum += value * weight;\n        totalWeight += weight;\n    }\n    r = -2; {\n        vec2 ssUV = vec2(ssC + axisi * (r * SCALE))*resolution;\n        temp = texture2D(tDiffuse, ssUV);\n        float      tapKey = unpackKey(temp.KEY_COMPONENTS);\n        VALUE_TYPE value  = temp.VALUE_COMPONENTS;\n        float weight = 0.3 + gaussian[2];\n        float dz = tapKey - key;\n        weight *= max(0.0, 1.0 - (EDGE_SHARPNESS * 2000.0) * abs(dz) * scale);\n        sum += value * weight;\n        totalWeight += weight;\n    }\n    r=-1; {\n        vec2 ssUV = vec2(ssC + axisi * (r * SCALE))*resolution;\n        temp = texture2D(tDiffuse, ssUV);\n        float      tapKey = unpackKey(temp.KEY_COMPONENTS);\n        VALUE_TYPE value  = temp.VALUE_COMPONENTS;\n        float weight = 0.3 + gaussian[1];\n        float dz = tapKey - key;\n        weight *= max(0.0, 1.0 - (EDGE_SHARPNESS * 2000.0) * abs(dz) * scale);\n        sum += value * weight;\n        totalWeight += weight;\n    }\n    r = 1; {\n        vec2 ssUV = vec2(ssC + axisi * (r * SCALE))*resolution;\n        temp = texture2D(tDiffuse, ssUV);\n        float      tapKey = unpackKey(temp.KEY_COMPONENTS);\n        VALUE_TYPE value  = temp.VALUE_COMPONENTS;\n        float weight = 0.3 + gaussian[1];\n        float dz = tapKey - key;\n        weight *= max(0.0, 1.0 - (EDGE_SHARPNESS * 2000.0) * abs(dz) * scale);\n        sum += value * weight;\n        totalWeight += weight;\n    }\n    r = 2; {\n        vec2 ssUV = vec2(ssC + axisi * (r * SCALE))*resolution;\n        temp = texture2D(tDiffuse, ssUV);\n        float      tapKey = unpackKey(temp.KEY_COMPONENTS);\n        VALUE_TYPE value  = temp.VALUE_COMPONENTS;\n        float weight = 0.3 + gaussian[2];\n        float dz = tapKey - key;\n        weight *= max(0.0, 1.0 - (EDGE_SHARPNESS * 2000.0) * abs(dz) * scale);\n        sum += value * weight;\n        totalWeight += weight;\n    }\n    r = 3; {\n        vec2 ssUV = vec2(ssC + axisi * (r * SCALE))*resolution;\n        temp = texture2D(tDiffuse, ssUV);\n        float      tapKey = unpackKey(temp.KEY_COMPONENTS);\n        VALUE_TYPE value  = temp.VALUE_COMPONENTS;\n        float weight = 0.3 + gaussian[3];\n        float dz = tapKey - key;\n        weight *= max(0.0, 1.0 - (EDGE_SHARPNESS * 2000.0) * abs(dz) * scale);\n        sum += value * weight;\n        totalWeight += weight;\n    }\n    r = 4; {\n        vec2 ssUV = vec2(ssC + axisi * (r * SCALE))*resolution;\n        temp = texture2D(tDiffuse, ssUV);\n        float      tapKey = unpackKey(temp.KEY_COMPONENTS);\n        VALUE_TYPE value  = temp.VALUE_COMPONENTS;\n        float weight = 0.3 + gaussian[4];\n        float dz = tapKey - key;\n        weight *= max(0.0, 1.0 - (EDGE_SHARPNESS * 2000.0) * abs(dz) * scale);\n        sum += value * weight;\n        totalWeight += weight;\n    }\n    const float epsilon = 0.0001;\n    result = sum / (totalWeight + epsilon);\n}\n"},Cl="\n#include <depth_texture>\n#define USE_MIPMAP 1\nuniform float cameraNear;\nuniform float cameraFar;\nuniform vec2 size;\nuniform vec2 resolution;\nuniform float lumInfluence;\nvarying vec2 vUv;\n#define NUM_SAMPLES (17)\n#define LOG_MAX_OFFSET (3)\n#define MAX_MIP_LEVEL (5)\n#define NUM_SPIRAL_TURNS (5)\n#define MIN_RADIUS (3.0)\nuniform float           projScale;\n#ifdef USE_MIPMAP\nuniform sampler2D tDepth_mip1;\nuniform sampler2D tDepth_mip2;\nuniform sampler2D tDepth_mip3;\nuniform sampler2D tDepth_mip4;\nuniform sampler2D tDepth_mip5;\n#endif\nuniform float radius;\nuniform float bias;\nuniform float intensity;\nvec2 tapLocation(int sampleNumber, float spinAngle, out float ssR){\n    float alpha = float(float(sampleNumber) + 0.5) * (1.0 / float(NUM_SAMPLES));\n    float angle = alpha * (float(NUM_SPIRAL_TURNS) * 6.28) + spinAngle;\n    ssR = alpha;\n    return vec2(cos(angle), sin(angle));\n}\nfloat CSZToKey(float z) {\n    return clamp( (z+cameraNear) / (cameraNear-cameraFar), 0.0, 1.0);\n}\nvoid packKey(float key, out vec2 p) {\n    float temp = floor(key * 255.0);\n    p.x = temp * (1.0 / 255.0);\n    p.y = key * 255.0 - temp;\n}\n#include <pack_depth>\nfloat unpackDepthNearFar( const in vec4 rgba_depth ) {\n    float depth = unpackDepth( rgba_depth );\n    if (depth == 0.0)\n        return -cameraFar * 1.0e10;\n    return depth * (cameraNear - cameraFar) - cameraNear;\n}\nvec3 reconstructCSFaceNormal(vec3 C) {\n    return normalize(cross(dFdy(C), dFdx(C)));\n}\nvec3 reconstructNonUnitCSFaceNormal(vec3 C) {\n    return cross(dFdy(C), dFdx(C));\n}\nvec3 getPosition(ivec2 ssP, float depth) {\n    vec3 P;\n    P = reconstructCSPosition(vec2(ssP) + vec2(0.5), depth);\n    return P;\n}\nvec3 getOffsetPosition(ivec2 ssC, vec2 unitOffset, float ssR) {\n    ivec2 ssP = ivec2(ssR * unitOffset) + ssC;\n    vec3 P;\n    vec2 screenUV = (vec2(ssP) + vec2(0.5)) * resolution;\n#ifdef USE_MIPMAP\n    int mipLevel = int(max(0.0, min(floor(log2(ssR)) - float(LOG_MAX_OFFSET), float(MAX_MIP_LEVEL))));\n    if (mipLevel == 0) {\n        P.z = texture2D(tDepth, screenUV).z;\n        if (P.z == 0.0) P.z = -cameraFar * 1.0e10;\n    }\n    else if (mipLevel == 1)\n        P.z = unpackDepthNearFar(texture2D(tDepth_mip1, screenUV));\n    else if (mipLevel == 2)\n        P.z = unpackDepthNearFar(texture2D(tDepth_mip2, screenUV));\n    else if (mipLevel == 3)\n        P.z = unpackDepthNearFar(texture2D(tDepth_mip3, screenUV));\n    else if (mipLevel == 4)\n        P.z = unpackDepthNearFar(texture2D(tDepth_mip4, screenUV));\n    else if (mipLevel == 5)\n        P.z = unpackDepthNearFar(texture2D(tDepth_mip5, screenUV));\n#else\n    P.z = texture2D(tDepth, screenUV).z;\n    if (P.z == 0.0) P.z = -cameraFar * 1.0e10;\n#endif\n    P = reconstructCSPosition(vec2(ssP) + vec2(0.5), P.z);\n    return P;\n}\nfloat sampleAO(in ivec2 ssC, in vec3 C, in vec3 n_C, in float ssDiskRadius, in int tapIndex, in float randomPatternRotationAngle) {\n    float ssR;\n    vec2 unitOffset = tapLocation(tapIndex, randomPatternRotationAngle, ssR);\n    ssR = max(0.75, ssR * ssDiskRadius);\n    vec3 Q = getOffsetPosition(ssC, unitOffset, ssR);\n    vec3 v = Q - C;\n    float vv = dot(v, v);\n    float vn = dot(v, n_C);\n    const float epsilon = 0.001;\n    float angAdjust = mix(1.0, max(0.0, 1.5 * n_C.z), 0.35);\n#define HIGH_QUALITY\n#ifdef HIGH_QUALITY\n    float f = max(1.0 - vv / (radius * radius), 0.0); return angAdjust * f * max((vn - bias) / sqrt(epsilon + vv), 0.0);\n#else\n    float f = max(radius * radius - vv, 0.0); return angAdjust * f * f * f * max((vn - bias) / (epsilon + vv), 0.0);\n#endif\n}\nconst bool useNoise = true;\nfloat getRandomAngle(vec2 pos) {\n    float dt= dot(pos ,vec2(12.9898,78.233));\n    return 6.28318 * fract(sin(mod(dt,3.14)) * 43758.5453);\n}\nvoid main() {\n    ivec2 ssC = ivec2(gl_FragCoord.xy);\n    vec4 nrmz = texture2D(tDepth, vUv);\n    if (nrmz.z == 0.0) {\n        gl_FragColor.r = 1.0;\n        gl_FragColor.a = 0.0;\n        packKey(1.0, gl_FragColor.gb);\n        return;\n    }\n    vec3 C = getPosition(ssC, nrmz.z);\n    packKey(CSZToKey(C.z), gl_FragColor.gb);\n    float ssDiskRadius = -projScale * radius / mix(C.z, -1.0, isOrtho);\n    float A;\n    if (ssDiskRadius <= MIN_RADIUS) {\n        A = 1.0;\n    } else {\n        float sum = 0.0;\n        float randomPatternRotationAngle = getRandomAngle(vUv);\n        vec3 n_C = vec3(nrmz.x, nrmz.y, sqrt(1.0 - dot(nrmz.xy, nrmz.xy)));\n        sum += sampleAO(ssC, C, n_C, ssDiskRadius, 0, randomPatternRotationAngle);\n        sum += sampleAO(ssC, C, n_C, ssDiskRadius, 1, randomPatternRotationAngle);\n        sum += sampleAO(ssC, C, n_C, ssDiskRadius, 2, randomPatternRotationAngle);\n        sum += sampleAO(ssC, C, n_C, ssDiskRadius, 3, randomPatternRotationAngle);\n        sum += sampleAO(ssC, C, n_C, ssDiskRadius, 4, randomPatternRotationAngle);\n        sum += sampleAO(ssC, C, n_C, ssDiskRadius, 5, randomPatternRotationAngle);\n        sum += sampleAO(ssC, C, n_C, ssDiskRadius, 6, randomPatternRotationAngle);\n        sum += sampleAO(ssC, C, n_C, ssDiskRadius, 7, randomPatternRotationAngle);\n        sum += sampleAO(ssC, C, n_C, ssDiskRadius, 8, randomPatternRotationAngle);\n        sum += sampleAO(ssC, C, n_C, ssDiskRadius, 9, randomPatternRotationAngle);\n        sum += sampleAO(ssC, C, n_C, ssDiskRadius, 10, randomPatternRotationAngle);\n        sum += sampleAO(ssC, C, n_C, ssDiskRadius, 11, randomPatternRotationAngle);\n        sum += sampleAO(ssC, C, n_C, ssDiskRadius, 12, randomPatternRotationAngle);\n        sum += sampleAO(ssC, C, n_C, ssDiskRadius, 13, randomPatternRotationAngle);\n        sum += sampleAO(ssC, C, n_C, ssDiskRadius, 14, randomPatternRotationAngle);\n        sum += sampleAO(ssC, C, n_C, ssDiskRadius, 15, randomPatternRotationAngle);\n        sum += sampleAO(ssC, C, n_C, ssDiskRadius, 16, randomPatternRotationAngle);\n        float intensityDivR6 = intensity / pow(radius, 6.0);\n#ifdef HIGH_QUALITY\n        A = pow(max(0.0, 1.0 - sqrt(sum * (3.0 / float(NUM_SAMPLES)))), intensity);\n#else\n        A = max(0.0, 1.0 - sum * intensityDivR6 * (5.0 / float(NUM_SAMPLES)));\n        A = (pow(A, 0.2) + 1.2 * A*A*A*A) / 2.2;\n#endif\n        if (abs(dFdx(C.z)) < 0.02) {\n            A -= dFdx(A) * (mod(float(ssC.x), 2.0) - 0.5);\n        }\n        if (abs(dFdy(C.z)) < 0.02) {\n            A -= dFdy(A) * (mod(float(ssC.y), 2.0) - 0.5);\n        }\n        A = mix(1.0, A, clamp(ssDiskRadius - MIN_RADIUS,0.0,1.0));\n    }\n    gl_FragColor.r = A;\n    gl_FragColor.a = 1.0;\n}\n",Dl={uniforms:t.UniformsUtils.merge([wl.DepthTextureUniforms,{size:{type:"v2",value:new t.Vector2(512,512)},resolution:{type:"v2",value:new t.Vector2(1/512,1/512)},cameraNear:{type:"f",value:1},cameraFar:{type:"f",value:100},radius:{type:"f",value:10},bias:{type:"f",value:.1},projScale:{type:"f",value:500},intensity:{type:"f",value:.4},tDepth_mip1:{type:"t",value:null},tDepth_mip2:{type:"t",value:null},tDepth_mip3:{type:"t",value:null},tDepth_mip4:{type:"t",value:null},tDepth_mip5:{type:"t",value:null}}]),vertexShader:Sl,fragmentShader:Cl},Nl={uniforms:{cutplanes:{type:"v4v",value:[]}},vertexShader:"varying vec3 vNormal;\nvarying float depth;\n#if NUM_CUTPLANES > 0\nvarying vec3 vWorldPosition;\n#endif\n#include<pack_normals>\n#include<instancing_decl_vert>\nvoid main() {\n#ifdef UNPACK_NORMALS\n    vec3 objectNormal = decodeNormal(normal);\n#else\n    vec3 objectNormal = normal;\n#endif\n#ifdef FLIP_SIDED\n    objectNormal = -objectNormal;\n#endif\n    objectNormal = getInstanceNormal(objectNormal);\n    vec3 instPos = getInstancePos(position);\n    vec3 transformedNormal = normalMatrix * objectNormal;\n    vNormal = normalize( transformedNormal );\n#if NUM_CUTPLANES > 0\n    vec4 worldPosition = modelMatrix * vec4( instPos, 1.0 );\n    vWorldPosition = worldPosition.xyz;\n#endif\n    vec4 mvPosition = modelViewMatrix * vec4( instPos, 1.0 );\n    depth = mvPosition.z;\n    vec4 p_Position = projectionMatrix * mvPosition;\n    gl_Position = p_Position;\n}\n",fragmentShader:"varying highp vec3 vNormal;\nvarying highp float depth;\n#if NUM_CUTPLANES > 0\nvarying vec3 vWorldPosition;\n#endif\n#include<cutplanes>\nvoid main() {\n#if NUM_CUTPLANES > 0\n    checkCutPlanes(vWorldPosition);\n#endif\n    vec3 n = vNormal;\n    n = n * ( -1.0 + 2.0 * float( gl_FrontFacing ) );\n    n = normalize( n );\n    gl_FragColor = vec4(n.x, n.y, depth, 1.0);\n}\n"},Ol={uniforms:{color:{type:"v4",value:new t.Vector4(0,0,0,.3)},cutplanes:{type:"v4v",value:[]}},vertexShader:"\n#if NUM_CUTPLANES > 0\nvarying vec3 vWorldPosition;\n#endif\n#include<instancing_decl_vert>\nvoid main() {\n    vec3 instPos = getInstancePos(position);\n#if NUM_CUTPLANES > 0\n    vec4 worldPosition = modelMatrix * vec4( instPos, 1.0 );\n    vWorldPosition = worldPosition.xyz;\n#endif\n    vec4 mvPosition = modelViewMatrix * vec4( instPos, 1.0 );\n    vec4 p_Position = projectionMatrix * mvPosition;\n    gl_Position = p_Position;\n}",fragmentShader:"\n#if NUM_CUTPLANES > 0\nvarying vec3 vWorldPosition;\n#endif\n#include<cutplanes>\nuniform vec4 color;\nvoid main() {\n#if NUM_CUTPLANES > 0\n    checkCutPlanes(vWorldPosition);\n#endif\n    gl_FragColor = color;\n}"},Ul={uniforms:{pixelsPerUnit:{type:"f",value:1},aaRange:{type:"f",value:.5},tLayerMask:{type:"t",value:null},tLineStyle:{type:"t",value:null},vLineStyleTexSize:{type:"v2",value:new t.Vector2(13,70)},tRaster:{type:"t",value:null},tSelectionTexture:{type:"t",value:null},vSelTexSize:{type:"v2",value:new t.Vector2(4096,1)},displayPixelRatio:{type:"f",value:1},opacity:{type:"f",value:1},selectionColor:{type:"v4",value:new t.Vector4(0,0,1,1)},modelId:{type:"v3",value:new t.Vector3(0,0,0)},viewportId:{type:"f",value:0},swap:{type:"f",value:0}},attributes:{fields1:0,fields2:0,color4b:0,dbId4b:0,flags4b:0,layerVp4b:0,extraParams:0,instFlags4b:0},defines:{},vertexShader:"\n#include<line_decl_common>\nattribute vec3 fields1;\nattribute vec3 fields2;\nattribute vec4 color4b;\nattribute vec4 dbId4b;\nattribute vec4 flags4b;\nattribute vec4 layerVp4b;\n#ifdef HAS_ELLIPTICALS\nattribute vec3 extraParams;\n#endif\n#ifdef USE_INSTANCING\nattribute vec4 instFlags4b;\n#endif\nuniform mat4 mvpMatrix;\nuniform float pixelsPerUnit;\nuniform float aaRange;\nuniform float viewportId;\nuniform float swap;\n#ifdef HAS_LAYERS\nuniform sampler2D tLayerMask;\n#endif\n#ifdef SELECTION_RENDERER\nuniform sampler2D tSelectionTexture;\nuniform vec2 vSelTexSize;\n#endif\n#ifdef SELECTION_RENDERER\nuniform vec4 selectionColor;\n#endif\nvec2 centralVertex;\nvec2 offsetPosition;\nvec2 cos_sin(const float angle) { return vec2(cos(angle), sin(angle)); }\nvoid min_max(inout vec2 minPt, inout vec2 maxPt, const vec2 p) {\n    minPt = min(minPt, p);\n    maxPt = max(maxPt, p);\n}\n#if defined(USE_INSTANCING)\nfloat getVertexId() { return instFlags4b.x; }\n#else\nfloat getVertexId() { return flags4b.x; }\n#endif\nbool isStartVertex() { return (getVertexId() < VBB_SEG_END_RIGHT); }\nbool isLeftVertex()  { float id = getVertexId(); return ((id == VBB_SEG_END_LEFT || id == VBB_SEG_START_LEFT)); }\nstruct SegmentData { float angle, distAlong, distTotal, lineWidthHalf, lineType; };\nvoid decodeSegmentData(out SegmentData seg) {\n    seg.angle         = fields1.z;\n    seg.distAlong     = fields2.x;\n    seg.distTotal     = fields2.z;\n    seg.lineWidthHalf = fields2.y;\n    seg.lineType      = flags4b.z;\n}\nvoid strokeLineSegment() {\n    SegmentData seg; decodeSegmentData(seg);\n    float isStartCapVertex = isStartVertex() ? -1.0 :  1.0;\n    float isLeftSide       = isLeftVertex( ) ?  1.0 : -1.0;\n    float angleTransverse = seg.angle + isLeftSide * HALF_PI;\n    float lwAdjustment = fsHalfWidth + aaRange;\n    vec2 transverseOffset = cos_sin(angleTransverse) * lwAdjustment;\n    offsetPosition.xy += transverseOffset;\n    float distanceFromStart = max(isStartCapVertex, 0.0) * seg.distAlong;\n    vec2 along = distanceFromStart * cos_sin(seg.angle);\n    offsetPosition.xy += along;\n    centralVertex.xy  += along;\n    vec2 moveOffset = isStartCapVertex * isLeftSide * vec2(-transverseOffset.y, transverseOffset.x);\n    offsetPosition.xy -= moveOffset;\n    centralVertex.xy  -= moveOffset;\n    fsMultipurpose.x = (isStartCapVertex * lwAdjustment) + distanceFromStart;\n    fsMultipurpose.y = seg.distAlong;\n    fsMultipurpose.z = seg.distTotal;\n    fsMultipurpose.w = seg.lineType;\n    if (seg.lineWidthHalf < 0.0)\n        fsHalfWidth = -fsHalfWidth;\n}\n#ifdef HAS_TRIANGLE_GEOMS\nstruct TriangleData { vec2 p0, p1, p2; };\nvoid decodeTriangleData(out TriangleData tri) {\n    tri.p1 = vec2(fields1.z, fields2.x);\n    tri.p2 = fields2.yz;\n}\nvoid strokeOneTriangle() {\n    TriangleData tri; decodeTriangleData(tri);\n    fsHalfWidth = 0.0;\n    fsMultipurpose.z = 0.0;\n    float vertexId = getVertexId();\n    if (vertexId == VBB_SEG_END_RIGHT)\n        offsetPosition.xy = tri.p1;\n    else if (vertexId == VBB_SEG_END_LEFT)\n        offsetPosition.xy = tri.p2;\n}\n#endif\n#ifdef HAS_RASTER_QUADS\nstruct TexQuadData { float angle; vec2 size; };\nvoid decodeTexQuadData(out TexQuadData quad) {\n    quad.angle     = fields1.z;\n    quad.size   = fields2.xy;\n}\nvoid strokeTexQuad() {\n    TexQuadData quad; decodeTexQuadData(quad);\n    vec2 corner = vec2(isLeftVertex() ? -1.0 : 1.0, isStartVertex() ? -1.0 : 1.0);\n    vec2 p      = 0.5 * corner * quad.size;\n    vec2 rot    = cos_sin(quad.angle);\n    vec2 offset = vec2(p.x * rot.x - p.y * rot.y, p.x * rot.y + p.y * rot.x);\n    offsetPosition.xy += offset;\n    fsMultipurpose.xy = max(vec2(0.0), corner);\n    fsMultipurpose.z = 1.0;\n    fsHalfWidth = 0.0;\n}\n#endif\n#if defined(HAS_CIRCLES) || defined(HAS_ELLIPTICALS)\nstruct ArcData { vec2 c; float start, end, major, minor, tilt; };\nvoid decodeArcData(out ArcData arc) {\n    arc.c     = fields1.xy;\n    arc.start = fields1.z;\n    arc.end   = fields2.x;\n    arc.major = fields2.z;\n#if defined(HAS_ELLIPTICALS)\n    arc.minor = extraParams.x;\n    arc.tilt  = extraParams.y;\n#endif\n}\nvoid strokeArc(const ArcData arc) {\n    float isStart = isStartVertex() ? -1.0 : 1.0;\n    float isLeft  = isLeftVertex()  ? -1.0 : 1.0;\n    vec2 minPt;\n    vec2 maxPt;\n    vec2 angles = vec2(arc.start, arc.end);\n    vec2 endsX = vec2(arc.c.x) + arc.major * cos(angles);\n    vec2 endsY = vec2(arc.c.y) + arc.minor * sin(angles);\n    minPt = maxPt = vec2(endsX.x, endsY.x);\n    min_max(minPt, maxPt, vec2(endsX.y, endsY.y));\n    if (arc.end > arc.start) {\n        if (arc.start < PI_0_5 && arc.end > PI_0_5) {\n            min_max(minPt, maxPt, vec2(arc.c.x, arc.c.y + arc.minor));\n        }\n        if (arc.start < PI && arc.end > PI) {\n            min_max(minPt, maxPt, vec2(arc.c.x - arc.major, arc.c.y));\n        }\n        if (arc.start < PI_1_5 && arc.end > PI_1_5) {\n            min_max(minPt, maxPt, vec2(arc.c.x, arc.c.y - arc.minor));\n        }\n    } else {\n        min_max(minPt, maxPt, vec2(arc.c.x + arc.major, arc.c.y));\n        if (arc.start < PI_0_5 || arc.end > PI_0_5) {\n            min_max(minPt, maxPt, vec2(arc.c.x, arc.c.y + arc.minor));\n        }\n        if (arc.start < PI || arc.end > PI) {\n            min_max(minPt, maxPt, vec2(arc.c.x - arc.major, arc.c.y));\n        }\n        if (arc.start < PI_1_5 || arc.end > PI_1_5) {\n            min_max(minPt, maxPt, vec2(arc.c.x, arc.c.y - arc.minor));\n        }\n    }\n    minPt -= fsHalfWidth + aaRange;\n    maxPt += fsHalfWidth + aaRange;\n    offsetPosition.x = (isStart < 0.0) ? minPt.x : maxPt.x;\n    offsetPosition.y = (isLeft < 0.0)  ? minPt.y : maxPt.y;\n    fsMultipurpose.x = arc.start;\n    fsMultipurpose.y = -arc.major;\n    fsMultipurpose.z = arc.end;\n    fsMultipurpose.w = arc.minor;\n}\n#endif\n#if defined(HAS_CIRCLES)\nvoid strokeCircularArc() {\n    ArcData arc; decodeArcData(arc);\n    float r = arc.major;\n    if (r * pixelsPerUnit < 0.125)\n        r = 0.25 * aaRange;\n    arc.major = arc.minor = r;\n    strokeArc(arc);\n}\n#endif\n#if defined(HAS_ELLIPTICALS)\nvoid strokeEllipticalArc() {\n    ArcData arc; decodeArcData(arc);\n    strokeArc(arc);\n}\n#endif\nstruct CommonAttribs { vec2 pos; vec4 color; vec2 layerTC, vpTC; float lineWidthHalf, geomType, ghosting; };\nvoid decodeCommonAttribs(out CommonAttribs attribs) {\n    attribs.pos           = fields1.xy;\n    attribs.color         = color4b;\n    attribs.geomType      = flags4b.y;\n    attribs.layerTC       = layerVp4b.xy / 255.0;\n    attribs.vpTC          = layerVp4b.zw / 255.0;\n    attribs.lineWidthHalf = fields2.y;\n    attribs.ghosting      = flags4b.w;\n}\nvoid strokeIndexedTriangle() {\n    fsHalfWidth = 0.0;\n    fsMultipurpose.z = 0.0;\n}\n#ifdef SELECTION_RENDERER\nbool isSelected(const CommonAttribs attribs) {\n    vec3 oid = dbId4b.rgb;\n    float id01 = oid.r + oid.g * 256.0;\n    float t = (id01 + 0.5) * (1.0 / 4096.0);\n    float flrt = floor(t);\n    float texU = t - flrt;\n    float id23 = oid.b * (65536.0 / 4096.0) + flrt;\n    t = (id23 + 0.5) / vSelTexSize.y;\n    float texV = fract(t);\n    vec4 selBit = texture2D(tSelectionTexture, vec2(texU, texV));\n    return selBit.r == 1.0;\n}\n#endif\nbool isLayerOff(const CommonAttribs attribs) {\n#ifdef HAS_LAYERS\n    vec4 layerBit = texture2D(tLayerMask, attribs.layerTC);\n    return (layerBit.r == 0.0);\n#else\n    return false;\n#endif\n}\nvec4 getColor(const CommonAttribs attribs) {\n    if (isLayerOff(attribs)) { return vec4(0.0); }\n#ifdef SELECTION_RENDERER\n    if (isSelected(attribs)) { return selectionColor; }\n    return vec4(0.0);\n#else\n    return attribs.color;\n#endif\n}\nvoid main() {\n    CommonAttribs attribs; decodeCommonAttribs(attribs);\n    fsColor = getColor(attribs);\n    if (swap != 0.0 ) {\n        if ( fsColor.r == 0.0 && fsColor.g == 0.0 && fsColor.b == 0.0 )\n            fsColor.rgb = vec3(1.0,1.0,1.0);\n        else if ( fsColor.r == 1.0 && fsColor.g == 1.0 && fsColor.b == 1.0 )\n            fsColor.rgb = vec3(0.0,0.0,0.0);\n    }\n    centralVertex = offsetPosition = attribs.pos;\n    float lineWeight = attribs.lineWidthHalf;\n    if (lineWeight > 0.0) {\n        if(lineWeight < 0.5 / pixelsPerUnit) {\n            lineWeight = 0.5 / pixelsPerUnit;\n        }\n    }\n    else {\n        lineWeight = abs(lineWeight) / pixelsPerUnit;\n    }\n    fsHalfWidth = lineWeight;\n    dbId = dbId4b / 255.0;\n    fsVpTC     = attribs.vpTC;\n    fsGhosting = attribs.ghosting;\n    if      (attribs.geomType == VBB_GT_LINE_SEGMENT)     strokeLineSegment();\n#ifdef HAS_CIRCLES\n    else if (attribs.geomType == VBB_GT_ARC_CIRCULAR)     strokeCircularArc();\n#endif\n#ifdef HAS_ELLIPTICALS\n    else if (attribs.geomType == VBB_GT_ARC_ELLIPTICAL)   strokeEllipticalArc();\n#endif\n#ifdef HAS_RASTER_QUADS\n    else if (attribs.geomType == VBB_GT_TEX_QUAD)         strokeTexQuad();\n#endif\n#ifdef HAS_TRIANGLE_GEOMS\n    else if (attribs.geomType == VBB_GT_ONE_TRIANGLE)     strokeOneTriangle();\n#endif\n    else if (attribs.geomType == VBB_GT_TRIANGLE_INDEXED) strokeIndexedTriangle();\n    fsOffsetDirection = offsetPosition - centralVertex;\n    gl_Position = mvpMatrix * modelMatrix * vec4( offsetPosition.xy, 0.0, 1.0 );\n}\n",fragmentShader:"\n#include<line_decl_common>\nuniform highp float pixelsPerUnit;\nuniform highp float aaRange;\nuniform float opacity;\nuniform highp float viewportId;\nuniform highp float swap;\n#ifdef HAS_RASTER_QUADS\nuniform sampler2D tRaster;\n#endif\n#ifdef HAS_LINESTYLES\nuniform sampler2D tLineStyle;\nuniform vec2 vLineStyleTexSize;\n#endif\n#if defined(MRT_ID_BUFFER) || defined(MODEL_COLOR)\nuniform vec3 modelId;\n#endif\nfloat curveGaussian(float r, float invWidth) {\n    float amt = clamp(r * invWidth, 0.0, 1.0);\n    float exponent = amt * 2.0;\n    return exp(-exponent*exponent);\n}\n#ifdef HAS_LINESTYLES\nfloat getLinePatternPixel(int i, int j) {\n    return texture2D(tLineStyle, (vec2(i, j) + 0.5) / vLineStyleTexSize).x * 255.0;\n}\nfloat getPatternLength(int whichPattern) {\n    float p1 = getLinePatternPixel(0, whichPattern);\n    float p2 = getLinePatternPixel(1, whichPattern);\n    return (p2 * 256.0 + p1);\n}\n#endif\nvoid fillLineSegment() {\n    float radius = abs(fsHalfWidth);\n    float parametricDistance = fsMultipurpose.x;\n    float segmentLength      = fsMultipurpose.y;\n    float totalDistance      = fsMultipurpose.z;\n#ifdef HAS_LINESTYLES\n    int whichPattern         = int(fsMultipurpose.w);\n    if (whichPattern > 0) {\n        const float TEX_TO_UNIT = 1.0 / 96.0;\n        float LTSCALE = 1.0;\n        float patternScale;\n        if (fsHalfWidth < 0.0) {\n            patternScale = LTSCALE;\n        } else {\n            patternScale = LTSCALE * TEX_TO_UNIT * pixelsPerUnit;\n        }\n        float patLen = patternScale * getPatternLength(whichPattern);\n        float phase = mod((totalDistance + parametricDistance) * pixelsPerUnit, patLen);\n        bool onPixel = true;\n        float radiusPixels = radius * pixelsPerUnit;\n        for (int i=2; i<MAX_LINESTYLE_LENGTH; i+=2) {\n            float on = getLinePatternPixel(i, whichPattern);\n            if (on == 1.0) on = 0.0;\n            on *= patternScale;\n            onPixel = true;\n            phase -= on;\n            if (phase < 0.0) {\n                break;\n            }\n            else if (phase <= radiusPixels) {\n                onPixel = false;\n                break;\n            }\n            float off = getLinePatternPixel(i+1, whichPattern);\n            if (off <= 1.0) off = 0.0;\n            off *= patternScale;\n            onPixel = false;\n            phase -= off;\n            if (phase < -radiusPixels)\n                discard;\n            if (phase <= 0.0)\n                break;\n        }\n        if (!onPixel && (abs(phase) <= radiusPixels)) {\n            segmentLength = 0.0;\n            parametricDistance = phase / pixelsPerUnit;\n        }\n    }\n#endif\n    float dist;\n    float offsetLength2 = dot(fsOffsetDirection, fsOffsetDirection);\n    float ltz = max(0.0, sign(-parametricDistance));\n    float gtsl = max(0.0, sign(parametricDistance - segmentLength));\n    float d = (ltz + gtsl) * (parametricDistance - gtsl * segmentLength);\n    dist = sqrt(max(0.0, offsetLength2 + d*d));\n    float range =  dist - radius;\n    if (range > aaRange) {\n        discard;\n    }\n    gl_FragColor = fsColor;\n    gl_FragColor.a *= curveGaussian(range+aaRange, pixelsPerUnit);\n}\n#ifdef HAS_CIRCLES\nvoid fillCircularArc() {\n    float dist   = length(fsOffsetDirection);\n    vec2 angles  = fsMultipurpose.xz;\n    float radius = abs(fsMultipurpose.y);\n    float range  =  abs(dist - radius);\n    range -= fsHalfWidth;\n    if (range > aaRange) {\n        discard;\n    }\n    vec2 direction = fsOffsetDirection;\n    float angle = atan(direction.y, direction.x);\n    if (angles.x > angles.y) {\n        if (angle > angles.x && angle < PI) {\n            angle -= TAU;\n        }\n        angles.x -= TAU;\n        if (angle < angles.x ) {\n            angle += TAU;\n        }\n    }\n    else if (angle < 0.0)\n        angle += TAU;\n    if (angle > angles.x && angle < angles.y) {\n        gl_FragColor = fsColor;\n        gl_FragColor.a *= curveGaussian(range+aaRange, pixelsPerUnit);\n    }\n    else {\n        discard;\n    }\n}\n#endif\n#ifdef HAS_ELLIPTICALS\nfloat EllipticalApprox(\n        const int iters,\n        inout float t0, inout float t1,\n        const vec2 y,   out   vec2 x,\n        const vec2 e,   const vec2 ey, const vec2 esqr\n        ) {\n    vec2 r;\n    for (int i = 0; i < 10; ++i) {\n        if(i >= iters) break;\n        float t = mix(t0, t1, 0.5);\n        r = ey / (vec2(t) + esqr);\n        vec2 rsq = r * r;\n        float f = rsq.x + rsq.y - 1.0;\n        if(f > 0.0) { t0 = t; } else { t1 = t; }\n    }\n    x = e * r;\n    return distance(x, y);\n}\nfloat DistancePointEllipseSpecial (vec2 e, vec2 y, out vec2 x, float width, float aaRange) {\n    float dist;\n    vec2 esqr = e * e;\n    vec2 ey   = e * y;\n    float t0 = -esqr[1] + ey[1];\n    float t1 = -esqr[1] + length(ey);\n    dist = EllipticalApprox(6, t0, t1, y, x, e, ey, esqr);\n    if (dist > max(2.0 * (width + aaRange), e[0] * 0.05))\n        return dist;\n    dist = EllipticalApprox(6, t0, t1, y, x, e, ey, esqr);\n    float ecc = 1.0 +  0.1 * e[0] / e[1];\n    if (dist > max(ecc * (width + aaRange), e[0] * 0.001))\n        return dist;\n    if (dist < (width - aaRange) / ecc)\n        return dist;\n    dist = EllipticalApprox(10, t0, t1, y, x, e, ey, esqr);\n    return dist;\n}\nfloat DistancePointEllipse(vec2 e, vec2 y, out vec2 locX, float width, float aaRange) {\n    vec2 locE, locY;\n    float diff = sign(e[0] - e[1]);\n    vec2 swizzle = vec2(max(diff, 0.0), -min(diff, 0.0));\n    locE.x = dot(e, swizzle.xy);\n    locE.y = dot(e, swizzle.yx);\n    locY.x = dot(y, swizzle.xy);\n    locY.y = dot(y, swizzle.yx);\n    vec2 refl = sign(locY);\n    locY *= refl;\n    vec2 x;\n    float distance = DistancePointEllipseSpecial(locE, locY, x, width, aaRange);\n    x *= refl;\n    locX.x = dot(x, swizzle.xy);\n    locX.y = dot(x, swizzle.yx);\n    return distance;\n}\nvoid fillEllipticalArc() {\n    vec2 angles = fsMultipurpose.xz;\n    vec2 radii  = abs(fsMultipurpose.yw);\n    vec2 dir    = fsOffsetDirection;\n    vec2 pos;\n    float range = DistancePointEllipse(radii, dir, pos, fsHalfWidth, aaRange);\n    range -= fsHalfWidth;\n    if (range > aaRange)\n        discard;\n    float ar = radii[0] / radii[1];\n    float angle = atan(ar * pos.y, pos.x);\n    if (angles.x > angles.y) {\n        if (angle > angles.x && angle < PI) {\n            angle -= TAU;\n        }\n        angles.x -= TAU;\n        if (angle < angles.x ) {\n            angle += TAU;\n        }\n    }\n    else if (angle < 0.0)\n        angle += TAU;\n    if (angle > angles.x && angle < angles.y) {\n        gl_FragColor = fsColor;\n        gl_FragColor.a *= curveGaussian(range+aaRange, pixelsPerUnit);\n    }\n    else {\n        discard;\n    }\n}\n#endif\n#ifdef HAS_RASTER_QUADS\nvoid fillTexQuad() { gl_FragColor = texture2D(tRaster, fsMultipurpose.xy); }\n#endif\nvoid fillTriangle() { gl_FragColor = fsColor; }\nvoid main() {\n    if (fsColor == vec4(0.0)) {\n        discard;\n    }\n    if (fsHalfWidth == 0.0) {\n#ifdef HAS_RASTER_QUADS\n        if (fsMultipurpose.z != 0.0)\n            fillTexQuad();\n        else\n#endif\n            fillTriangle();\n    }\n    else if (fsMultipurpose.y < 0.0) {\n#ifdef HAS_CIRCLES\n#ifdef HAS_ELLIPTICALS\n        if (abs(fsMultipurpose.y) == fsMultipurpose.w)\n#endif\n            fillCircularArc();\n#endif\n#ifdef HAS_ELLIPTICALS\n#ifdef HAS_CIRCLES\n        else\n#endif\n            fillEllipticalArc();\n#endif\n    }\n    else\n        fillLineSegment();\n#ifdef MRT_NORMALS\n    gl_FragData[1] = vec4(0.0);\n#endif\n    float writeId = 1.0;\n    if (fsGhosting != 0.0 || \n            ((viewportId != 0.0) && (abs(fsVpTC.x * 255.0 + fsVpTC.y) >= 0.5 && abs(fsVpTC.x * 255.0 + fsVpTC.y - viewportId) >= 0.5))) {\n        writeId = 0.0;\n        gl_FragColor.a *= opacity * ((swap == 1.0) ? 0.21 : 0.1);\n    } else {\n        gl_FragColor.a *= opacity;\n    }\n#include<id_frag>\n}\n"},Fl={uniforms:{color:{type:"v3",value:new t.Vector3(0,0,0)},opacity:{type:"f",value:1}},rawShader:!0,vertexShader:"\n#include<instancing_decl_vert>\nvarying vec4 finalColor;\nuniform vec3 color;\nuniform float opacity;\nvoid main() {\n    gl_Position = projectionMatrix * (viewMatrix * vec4(getInstancePos(position), 1.0));\n    finalColor = vec4(color, opacity);\n}\n",fragmentShader:"precision lowp float;\nvarying vec4 finalColor;\nvoid main() {\n    gl_FragColor = finalColor;\n}\n"},Vl=function(e){var n={vertexShader:e.vertexShader,fragmentShader:e.fragmentShader};return e.uniforms&&(n.uniforms=t.UniformsUtils.clone(e.uniforms)),e.defines&&(n.defines=Object.assign({},e.defines)),e.extensions&&(n.extensions=Object.assign({},e.extensions)),e.attributes&&(n.attributes=e.attributes),new t.ShaderMaterial(n)},Bl=function(e,t,n){n=n||"",e.defines||(e.defines={}),e.defines[t]!=n&&(e.defines[t]=n,e.needsUpdate=!0)},zl=function(e,t){(e.defines||e.defines[t])&&(delete e.defines[t],e.needsUpdate=!0)},Gl={createShaderMaterial:Vl,setMacro:Bl,removeMacro:zl},kl=function(e,n){this.textureID=void 0!==n?n:"tDiffuse",this.material=Gl.createShaderMaterial(e),this.uniforms=this.material.uniforms,this.renderToScreen=!1,this.enabled=!0,this.clear=!1,this.camera=new t.OrthographicCamera(-1,1,1,-1,0,1);var r=new t.BufferGeometry,a=new Float32Array(9);a[0]=-1,a[1]=-1,a[2]=0,a[3]=3,a[4]=-1,a[5]=0,a[6]=-1,a[7]=3,a[8]=0;var i=new Float32Array(6);i[0]=0,i[1]=0,i[2]=2,i[3]=0,i[4]=0,i[5]=2;var o=new Float32Array(9);o[0]=0,o[1]=0,o[2]=1,o[3]=0,o[4]=0,o[5]=1,o[6]=0,o[7]=0,o[8]=1,r.addAttribute("position",new t.BufferAttribute(a,3)),r.addAttribute("normal",new t.BufferAttribute(o,3)),r.addAttribute("uv",new t.BufferAttribute(i,2)),this.quad=new t.Mesh(r,this.material),this.scene=new t.Scene,this.scene.add(this.quad)};kl.prototype={render:function(e,t,n,r){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=n.texture||n),this.renderToScreen||!t?e.render(this.scene,this.camera):e.render(this.scene,this.camera,t,this.clear)}};var Hl={uniforms:{tDiffuse:{type:"t",value:null},uColor:{type:"v4",value:new t.Vector4(1,1,1,1)}},vertexShader:"varying vec2 vUv;\nvoid main() {\n#if defined(HORIZONTAL) && defined(FLIP_UV)\n    vUv = vec2(uv.x, 1.0-uv.y);\n#else\n    vUv = vec2(uv.x, uv.y);\n#endif\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}\n",fragmentShader:"uniform sampler2D tDiffuse;\nuniform vec4 uColor;\nvarying vec2 vUv;\n#ifdef HORIZONTAL\n#define GET_UV(X) vec2(vUv.x + KERNEL_SCALE_H*(X), vUv.y)\n#else\n#define GET_UV(Y) vec2(vUv.x, vUv.y + KERNEL_SCALE_V*(Y))\n#endif\n#define PI 3.14159265358979\n#define SIGMA ((KERNEL_RADIUS+KERNEL_RADIUS+1.0) / 6.0)\n#define SIGMASQ2 (2.0 * SIGMA * SIGMA)\n#define GAUSSIAN(X) ( (1.0 / sqrt(PI * SIGMASQ2)) * exp(-(X)*(X)/SIGMASQ2) )\nvoid main() {\n    vec4 texColSum = vec4(0.0);\n    float gaussSum = 0.0;\n    for (float x=-KERNEL_RADIUS; x<=KERNEL_RADIUS; x+=1.0) {\n        float gauss = GAUSSIAN(x);\n        vec4 texCol = texture2D(tDiffuse, GET_UV(x));\n#ifdef HAS_ALPHA\n        texCol.rgb *= texCol.a;\n#endif\n        texColSum += texCol * gauss;\n        gaussSum += gauss;\n    }\n#ifdef HAS_ALPHA\n    texColSum.rgb /= (texColSum.a == 0.0 ? 0.0001 : texColSum.a);\n#endif\n#ifdef HORIZONTAL\n    gl_FragColor = texColSum/gaussSum;\n#else\n    gl_FragColor = texColSum/gaussSum * uColor;\n#endif\n}\n"},Wl=function(e,n,r,a,i){var o,s,l,u=e,f=n,d=r||3,c=a||1,p={hasAlpha:i.hasAlpha||!1,blending:i.blending||!1,flipUV:i.flipUV||!1};this.render=function(e,t,n){o.render(e,l,n),s.render(e,t,l)},this.setSize=function(e,n){this.cleanup(),u=e,f=n,(l=new t.WebGLRenderTarget(e,n,{minFilter:t.LinearFilter,magFilter:t.LinearFilter,format:void 0!==i.format?i.format:t.RGBAFormat,type:void 0!==i.type?i.type:t.UnsignedByteType,stencilBuffer:!1})).generateMipmaps=!1,o.material.defines.KERNEL_SCALE_H=s.material.defines.KERNEL_SCALE_H=(c/u).toFixed(4),o.material.defines.KERNEL_SCALE_V=s.material.defines.KERNEL_SCALE_V=(c/f).toFixed(4),o.material.needsUpdate=s.material.needsUpdate=!0},this.cleanup=function(){l&&l.dispose()},this.setColor=function(e){s.material.uniforms.uColor.value.x=e.r,s.material.uniforms.uColor.value.y=e.g,s.material.uniforms.uColor.value.z=e.b},this.setAlpha=function(e){s.material.uniforms.uColor.value.w=e},o=new kl(Hl),s=new kl(Hl),this.setSize(e,n),o.material.blending=s.material.blending=t.NoBlending,o.material.depthWrite=s.material.depthWrite=!1,o.material.depthTest=s.material.depthTest=!1,o.material.defines.HORIZONTAL=1,o.material.defines.KERNEL_RADIUS=s.material.defines.KERNEL_RADIUS=d.toFixed(1),p.blending&&(s.material.transparent=!0,s.material.blending=t.NormalBlending),p.hasAlpha&&(o.material.defines.HAS_ALPHA=s.material.defines.HAS_ALPHA=""),p.flipUV&&(o.material.defines.FLIP_UV="")},ql="undefined"!=typeof navigator?navigator.userAgent.toLowerCase():"",jl=function(){return ql.match(/ip(ad|hone|od)/)},Xl=function(){return-1!==ql.indexOf("android")},Yl=function(){return jl()||Xl()},Kl=function(){return-1!==ql.indexOf("chrome")},Zl=function(){return-1!==ql.indexOf("safari")&&-1===ql.indexOf("chrome")},Ql=function(){return-1!==ql.indexOf("win32")||-1!==ql.indexOf("windows")},Jl=function(){return"undefined"==typeof navigator},$l=Zl()?function(e){if(!window.Polymer)return e;for(var t in e)if(-1!==t.indexOf("__impl"))return e[t];return e}:function(e){return e},eu=function(e){if(-1!==e.indexOf("://")||0===e.indexOf("urn:"))return e;if("undefined"==typeof window)return e;var t=window.location.pathname,n=t.lastIndexOf("/");return t=t.substr(0,n+1),window.location.protocol+"//"+window.location.host+t+e};e.assets=[];var tu=function(){e.assets=null},nu="modelUnloaded";e.memoryOptimizedLoading=!0;var ru=function(t){e.memoryOptimizedLoading=t},au=1024*(Yl()?64:256)*1024,iu=Yl()?2500:1e4,ou=1,su=1,lu=2,uu=0,fu=1,du=2,cu=4,pu=16,hu=32,mu=64,_u=128,vu=0,gu=1,yu=2,xu={uniforms:{tDiffuse:{type:"t",value:null}},vertexShader:Sl,fragmentShader:"uniform sampler2D tDiffuse;\nvarying vec2 vUv;\nvoid main() {\n    vec4 texel = texture2D( tDiffuse, vUv );\n    gl_FragColor = texel;\n}\n"},bu=function(e,t,n){var r=e.createShader(t);return e.shaderSource(r,n),e.compileShader(r),r},wu={uniforms:t.UniformsUtils.merge([t.UniformsLib.common,t.UniformsLib.bump,t.UniformsLib.normalmap,t.UniformsLib.lights,t.UniformsLib.fog,wl.CutPlanesUniforms,wl.IdUniforms,wl.ThemingUniform,wl.ShadowMapUniforms,wl.WideLinesUniforms,{emissive:{type:"c",value:new t.Color(0)},specular:{type:"c",value:new t.Color(1118481)},shininess:{type:"f",value:30},reflMipIndex:{type:"f",value:0},texMatrix:{type:"m3",value:new t.Matrix3},texMatrixBump:{type:"m3",value:new t.Matrix3},texMatrixAlpha:{type:"m3",value:new t.Matrix3},irradianceMap:{type:"t",value:null},exposureBias:{type:"f",value:1},envMapExposure:{type:"f",value:1},envRotationSin:{type:"f",value:0},envRotationCos:{type:"f",value:1}}]),vertexShader:"varying vec3 vViewPosition;\n#ifndef FLAT_SHADED\nvarying vec3 vNormal;\n#endif\n#if defined( USE_MAP ) || defined( USE_SPECULARMAP )\nvarying vec2 vUv;\nuniform mat3 texMatrix;\n#endif\n#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\nvarying vec2 vUvBump;\nuniform mat3 texMatrixBump;\n#endif\n#if defined( USE_ALPHAMAP )\nvarying vec2 vUvAlpha;\nuniform mat3 texMatrixAlpha;\n#endif\n#if defined( USE_ENVMAP )\n#if ! defined( USE_BUMPMAP ) && ! defined( USE_NORMALMAP )\nuniform float refractionRatio;\n#endif\n#endif\n#if MAX_SPOT_LIGHTS > 0 || NUM_CUTPLANES > 0\nvarying vec3 vWorldPosition;\n#endif\n#ifdef USE_COLOR\nvarying vec3 vColor;\n#endif\n#ifdef USE_LOGDEPTHBUF\n#ifdef USE_LOGDEPTHBUF_EXT\nvarying float vFragDepth;\n#endif\nuniform float logDepthBufFC;\n#endif\n#ifdef MRT_NORMALS\nvarying float depth;\n#endif\n#include<pack_normals>\n#include<instancing_decl_vert>\n#include<id_decl_vert>\n#include<wide_lines_decl>\n#include<shadowmap_decl_vert>\nvoid main() {\n#if defined( USE_MAP ) || defined( USE_SPECULARMAP )\n    vUv = (texMatrix * vec3(uv, 1.0)).xy;\n#endif\n#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n    vUvBump = (texMatrixBump * vec3(uv, 1.0)).xy;\n#endif\n#if defined( USE_ALPHAMAP )\n    vUvAlpha = (texMatrixAlpha * vec3(uv, 1.0)).xy;\n#endif\n#ifdef USE_COLOR\n#ifdef GAMMA_INPUT\n    vColor = color * color;\n#else\n    vColor = color;\n#endif\n#endif\n#ifdef UNPACK_NORMALS\n    vec3 objectNormal = decodeNormal(normal);\n#else\n    vec3 objectNormal = normal;\n#endif\n#ifdef FLIP_SIDED\n    objectNormal = -objectNormal;\n#endif\n    objectNormal = getInstanceNormal(objectNormal);\n    vec3 instPos = getInstancePos(position);\n    vec3 transformedNormal = normalMatrix * objectNormal;\n#ifndef FLAT_SHADED\n    vNormal = normalize( transformedNormal );\n#endif\n    vec4 mvPosition = modelViewMatrix * vec4( instPos, 1.0 );\n    gl_Position = projectionMatrix * mvPosition;\n#include<wide_lines_vert>\n    vViewPosition = -mvPosition.xyz;\n#if MAX_SPOT_LIGHTS > 0 || NUM_CUTPLANES > 0\n    vec4 worldPosition = modelMatrix * vec4( instPos, 1.0 );\n    vWorldPosition = worldPosition.xyz;\n#endif\n#ifdef USE_LOGDEPTHBUF\n    if (projectionMatrix[3][3] == 0.0) {\n        gl_Position.z = log2(max(1.0e-6, gl_Position.w + 1.0)) * logDepthBufFC;\n#ifdef USE_LOGDEPTHBUF_EXT\n        vFragDepth = 1.0 + gl_Position.w;\n#else\n        gl_Position.z = (gl_Position.z - 1.0) * gl_Position.w;\n#endif\n    } else {\n#ifdef USE_LOGDEPTHBUF_EXT\n        vFragDepth = 1.0 + vViewPosition.z;\n#else\n#endif\n    }\n#endif\n#ifdef MRT_NORMALS\n    depth = mvPosition.z;\n#endif\n#include<shadowmap_vert>\n#include<id_vert>\n}\n",fragmentShader:"uniform vec3 diffuse;\nuniform float opacity;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\n#include<env_sample>\n#ifdef USE_COLOR\nvarying vec3 vColor;\n#endif\n#ifdef GAMMA_INPUT\nvec3 InputToLinear(vec3 c) {\n    return c * c;\n}\nfloat InputToLinear(float c) {\n    return c * c;\n}\n#else\nvec3 InputToLinear(vec3 c) {\n    return c;\n}\nfloat InputToLinear(float c) {\n    return c;\n}\n#endif\n#if defined( USE_MAP ) || defined( USE_SPECULARMAP )\nvarying vec2 vUv;\n#endif\n#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\nvarying vec2 vUvBump;\n#endif\n#if defined( USE_ALPHAMAP )\nvarying vec2 vUvAlpha;\n#endif\n#ifdef USE_MAP\nuniform sampler2D map;\n#endif\n#if TONEMAP_OUTPUT > 0\nuniform float exposureBias;\n#include<tonemap>\n#endif\n#if defined(IRR_RGBM) || defined(ENV_RGBM) || defined(ENV_GAMMA) || defined(IRR_GAMMA)\nuniform float envMapExposure;\n#endif\n#ifdef USE_FOG\nuniform vec3 fogColor;\nuniform float fogNear;\nuniform float fogFar;\n#endif\n#include<id_decl_frag>\n#include<theming_decl_frag>\n#include<shadowmap_decl_frag>\n#ifdef USE_ENVMAP\nuniform float reflMipIndex;\nuniform float reflectivity;\nuniform samplerCube envMap;\n#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\nuniform float refractionRatio;\n#endif\nvec3 sampleReflection(vec3 dir, float mipIndex) {\n    vec3 adjDir = adjustLookupVector(dir);\n#ifdef ENV_GAMMA\n#ifdef HAVE_TEXTURE_LOD\n    vec4 envTexColor = textureCubeLodEXT( envMap, adjDir, mipIndex );\n#else\n    vec4 envTexColor = textureCube( envMap, adjDir, mipIndex );\n#endif\n    return GammaDecode(envTexColor, envMapExposure);\n#elif defined(ENV_RGBM)\n#ifdef HAVE_TEXTURE_LOD\n    vec4 envTexColor = textureCubeLodEXT( envMap, adjDir, mipIndex );\n#else\n    vec4 envTexColor = textureCube( envMap, adjDir, mipIndex );\n#endif\n    return RGBMDecode(envTexColor, envMapExposure);\n#else\n    vec4 envTexColor = textureCube( envMap, adjDir );\n    vec3 cubeColor = envTexColor.xyz;\n#ifdef GAMMA_INPUT\n    cubeColor *= cubeColor;\n#endif\n    return cubeColor;\n#endif\n}\n#endif\nuniform vec3 ambientLightColor;\n#if MAX_DIR_LIGHTS > 0\nuniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];\nuniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];\n#endif\n#if MAX_POINT_LIGHTS > 0\nuniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];\nuniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];\nuniform float pointLightDistance[ MAX_POINT_LIGHTS ];\n#endif\n#if MAX_SPOT_LIGHTS > 0\nuniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];\nuniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];\nuniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];\nuniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];\nuniform float spotLightExponent[ MAX_SPOT_LIGHTS ];\nuniform float spotLightDistance[ MAX_SPOT_LIGHTS ];\n#endif\n#ifdef USE_IRRADIANCEMAP\nuniform samplerCube irradianceMap;\n#endif\n#if MAX_SPOT_LIGHTS > 0 || NUM_CUTPLANES > 0\nvarying highp vec3 vWorldPosition;\n#endif\nvarying highp vec3 vViewPosition;\n#ifndef FLAT_SHADED\nvarying highp vec3 vNormal;\n#endif\n#ifdef USE_BUMPMAP\nuniform sampler2D bumpMap;\nuniform float bumpScale;\nvec2 dHdxy_fwd() {\n    vec2 dSTdx = dFdx( vUvBump );\n    vec2 dSTdy = dFdy( vUvBump );\n    float Hll = bumpScale * GET_BUMPMAP(vUvBump).x;\n    float dBx = bumpScale * GET_BUMPMAP(vUvBump + dSTdx).x - Hll;\n    float dBy = bumpScale * GET_BUMPMAP(vUvBump + dSTdy).x - Hll;\n    return vec2( dBx, dBy );\n}\nvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {\n    vec3 vSigmaX = dFdx( surf_pos );\n    vec3 vSigmaY = dFdy( surf_pos );\n    vec3 vN = surf_norm;\n    vec3 R1 = cross( vSigmaY, vN );\n    vec3 R2 = cross( vN, vSigmaX );\n    float fDet = dot( vSigmaX, R1 );\n    vec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n    return normalize( abs( fDet ) * surf_norm - vGrad );\n}\n#endif\n#ifdef USE_NORMALMAP\nuniform sampler2D normalMap;\nuniform vec2 normalScale;\nvec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm ) {\n    vec3 q0 = dFdx( eye_pos.xyz );\n    vec3 q1 = dFdy( eye_pos.xyz );\n    vec2 st0 = dFdx( vUvBump.st );\n    vec2 st1 = dFdy( vUvBump.st );\n    vec3 S = normalize(  q0 * st1.t - q1 * st0.t );\n    vec3 T = normalize( -q0 * st1.s + q1 * st0.s );\n    vec3 N = normalize( surf_norm );\n    vec3 mapN = GET_NORMALMAP(vUvBump).xyz * 2.0 - 1.0;\n    mapN.xy = normalScale * mapN.xy;\n    mat3 tsn = mat3( S, T, N );\n    return normalize( tsn * mapN );\n}\n#endif\n#ifdef USE_SPECULARMAP\nuniform sampler2D specularMap;\n#endif\n#ifdef USE_ALPHAMAP\nuniform sampler2D alphaMap;\n#endif\n#include<hatch_pattern>\n#ifdef USE_LOGDEPTHBUF\nuniform float logDepthBufFC;\n#ifdef USE_LOGDEPTHBUF_EXT\n#extension GL_EXT_frag_depth : enable\nvarying highp float vFragDepth;\n#endif\n#endif\nvec3 Schlick_v3(vec3 v, float cosHV) {\n    float facing = max(1.0 - cosHV, 0.0);\n    float facing2 = facing * facing;\n    return v + (1.0 - v) * facing * facing2 * facing2;\n}\nfloat Schlick_f(float v, float cosHV) {\n    float facing = max(1.0 - cosHV, 0.0);\n    float facing2 = facing * facing;\n    return v + ( 1.0 - v ) * facing2 * facing2 * facing;\n}\n#include<cutplanes>\nvoid main() {\n#if NUM_CUTPLANES > 0\n    checkCutPlanes(vWorldPosition);\n#endif\n    gl_FragColor = vec4( vec3 ( 1.0 ), opacity );\n#ifdef USE_MAP\n    vec4 texelColor = GET_MAP(vUv);\n#ifdef MAP_INVERT\n    texelColor.xyz = 1.0-texelColor.xyz;\n#endif\n#ifdef GAMMA_INPUT\n    texelColor.xyz *= texelColor.xyz;\n#endif\n    gl_FragColor = gl_FragColor * texelColor;\n#endif\n#ifdef USE_ALPHAMAP\n    vec4 texelAlpha = GET_ALPHAMAP(vUvAlpha);\n    gl_FragColor.a *= texelAlpha.r;\n#endif\n#ifdef ALPHATEST\n    if ( gl_FragColor.a < ALPHATEST ) discard;\n#endif\n    float specularStrength;\n#ifdef USE_SPECULARMAP\n    vec4 texelSpecular = GET_SPECULARMAP(vUv);\n    specularStrength = texelSpecular.r;\n#else\n    specularStrength = 1.0;\n#endif\n#ifndef FLAT_SHADED\n    vec3 normal = normalize( vNormal );\n#ifdef DOUBLE_SIDED\n    normal = normal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );\n#endif\n#else\n    vec3 fdx = dFdx( vViewPosition );\n    vec3 fdy = dFdy( vViewPosition );\n    vec3 normal = normalize( cross( fdx, fdy ) );\n#endif\n    vec3 geomNormal = normal;\n#ifdef USE_NORMALMAP\n    normal = perturbNormal2Arb( -vViewPosition, normal );\n#elif defined( USE_BUMPMAP )\n    normal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );\n#endif\n    vec3 viewDirection;\n    if (projectionMatrix[3][3] == 0.0) {\n        viewDirection = normalize( vViewPosition );\n    } else {\n        viewDirection = vec3(0.0, 0.0, 1.0);\n    }\n    vec3 totalDiffuse = vec3( 0.0 );\n    vec3 totalSpecular = vec3( 0.0 );\n    float shininessB = shininess * 4.0;\n#if MAX_POINT_LIGHTS > 0\n    vec3 pointDiffuse  = vec3( 0.0 );\n    vec3 pointSpecular = vec3( 0.0 );\n    for ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {\n        vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );\n        vec3 lVector = lPosition.xyz + vViewPosition.xyz;\n        float lDistance = 1.0;\n        if ( pointLightDistance[ i ] > 0.0 )\n            lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );\n        lVector = normalize( lVector );\n        float dotProduct = dot( normal, lVector );\n        float pointDiffuseWeight = max( dotProduct, 0.0 );\n        pointDiffuse  += InputToLinear(diffuse) * InputToLinear(pointLightColor[ i ]) * pointDiffuseWeight * lDistance;\n        vec3 pointHalfVector = normalize( lVector + viewDirection );\n        float pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );\n        float pointSpecularWeight = specularStrength * max( pow( pointDotNormalHalf, shininessB ), 0.0 );\n        float specularNormalization = shininessB * 0.125 + 0.25;\n        vec3 schlick = Schlick_v3(InputToLinear(specular), dot( lVector, pointHalfVector ) );\n        pointSpecular += schlick * InputToLinear(pointLightColor[ i ]) * pointSpecularWeight * pointDiffuseWeight * lDistance * specularNormalization ;\n    }\n    totalDiffuse += pointDiffuse;\n    totalSpecular += pointSpecular;\n#endif\n#if MAX_SPOT_LIGHTS > 0\n    vec3 spotDiffuse  = vec3( 0.0 );\n    vec3 spotSpecular = vec3( 0.0 );\n    for ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {\n        vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );\n        vec3 lVector = lPosition.xyz + vViewPosition.xyz;\n        float lDistance = 1.0;\n        if ( spotLightDistance[ i ] > 0.0 )\n            lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );\n        lVector = normalize( lVector );\n        float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - vWorldPosition ) );\n        if ( spotEffect > spotLightAngleCos[ i ] ) {\n            spotEffect = max( pow( spotEffect, spotLightExponent[ i ] ), 0.0 );\n            float dotProduct = dot( normal, lVector );\n            float spotDiffuseWeight = max( dotProduct, 0.0 );\n            spotDiffuse += InputToLinear(diffuse) * InputToLinear(spotLightColor[ i ]) * spotDiffuseWeight * lDistance * spotEffect;\n            vec3 spotHalfVector = normalize( lVector + viewDirection );\n            float spotDotNormalHalf = max( dot( normal, spotHalfVector ), 0.0 );\n            float spotSpecularWeight = specularStrength * max( pow( spotDotNormalHalf, shininessB ), 0.0 );\n            float specularNormalization = shininessB * 0.125 + 0.25;\n            vec3 schlick = Schlick_v3(InputToLinear(specular), dot( lVector, spotHalfVector ) );\n            spotSpecular += schlick * InputToLinear(spotLightColor[ i ]) * spotSpecularWeight * spotDiffuseWeight * lDistance * specularNormalization * spotEffect;\n        }\n    }\n    totalDiffuse += spotDiffuse;\n    totalSpecular += spotSpecular;\n#endif\n#if MAX_DIR_LIGHTS > 0\n    vec3 dirDiffuse  = vec3( 0.0 );\n    vec3 dirSpecular = vec3( 0.0 );\n    for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {\n        vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );\n        vec3 dirVector = normalize( lDirection.xyz );\n        float dotProduct = dot( normal, dirVector );\n        float dirDiffuseWeight = max( dotProduct, 0.0 );\n        dirDiffuse  += InputToLinear(diffuse) * InputToLinear(directionalLightColor[ i ]) * dirDiffuseWeight;\n        vec3 dirHalfVector = normalize( dirVector + viewDirection );\n        float dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );\n        float dirSpecularWeight = specularStrength * max( pow( dirDotNormalHalf, shininessB ), 0.0 );\n        float specularNormalization = shininessB * 0.125 + 0.25;\n        vec3 schlick = Schlick_v3(InputToLinear(specular), dot( dirVector, dirHalfVector ));\n        dirSpecular += schlick * InputToLinear(directionalLightColor[ i ]) * dirSpecularWeight * dirDiffuseWeight * specularNormalization;\n    }\n    totalDiffuse += dirDiffuse;\n    totalSpecular += dirSpecular;\n#endif\n#ifdef USE_IRRADIANCEMAP\n    vec3 worldNormal = mat3(viewMatrixInverse) * normal;\n    vec3 indirectDiffuse = sampleIrradianceMap(worldNormal, irradianceMap, envMapExposure);\n    indirectDiffuse = applyEnvShadow(indirectDiffuse, worldNormal);\n    totalDiffuse += InputToLinear(diffuse) * indirectDiffuse;\n#endif\n#ifdef METAL\n    gl_FragColor.xyz = gl_FragColor.xyz * ( InputToLinear(emissive) + totalDiffuse + ambientLightColor * InputToLinear(diffuse) + totalSpecular );\n#else\n    gl_FragColor.xyz = gl_FragColor.xyz * ( InputToLinear(emissive) + totalDiffuse + ambientLightColor * InputToLinear(diffuse) ) + totalSpecular;\n#endif\n#ifdef USE_COLOR\n    gl_FragColor = gl_FragColor * vec4( vColor, 1.0 );\n#endif\n#if defined(USE_ENVMAP)\n    vec3 reflectVec;\n#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n#ifdef ENVMAP_MODE_REFLECTION\n    reflectVec = reflect( -viewDirection, normal );\n#else \n    reflectVec = refract( -viewDirection, normal, refractionRatio );\n#endif\n#else\n    reflectVec = reflect( -viewDirection, normal );\n#endif\n    reflectVec = mat3(viewMatrixInverse) * reflectVec;\n    float reflectScale = 1.0;\n    vec3 cubeColor = sampleReflection(reflectVec, reflMipIndex);\n    cubeColor *= reflectScale;\n    float facing = dot( viewDirection, geomNormal );\n    if (facing < -1e-2)\n        facing = 1.0;\n    else\n        facing = max(1e-6, facing);\n    vec3 schlickRefl;\n#ifdef METAL\n    schlickRefl = InputToLinear(specular);\n#else\n    schlickRefl = Schlick_v3(InputToLinear(specular), facing);\n    gl_FragColor.a = mix(gl_FragColor.a, Schlick_f(gl_FragColor.a, facing), reflectivity);\n    float invSchlick = (1.0 - facing * 0.5);\n    float invSchlick2 = invSchlick * invSchlick;\n    float norm_factor = 1.0 - invSchlick * invSchlick2 * invSchlick2;\n    norm_factor = (28.0 / 23.0) * norm_factor;\n    gl_FragColor.xyz *= norm_factor * (1.0 - InputToLinear(specular));\n#endif\n    gl_FragColor.xyz += cubeColor.xyz * specularStrength * schlickRefl.xyz;\n#ifdef CLEARCOAT\n    vec3 reflectVecClearcoat = reflect( -viewDirection, geomNormal );\n    reflectVecClearcoat = mat3(viewMatrixInverse) * reflectVecClearcoat;\n    vec3 cubeColorClearcoat = sampleReflection(reflectVecClearcoat, 0.0);\n    float schlickClearcoat = Schlick_f(InputToLinear(reflectivity), facing);\n    gl_FragColor.xyz = mix(gl_FragColor.xyz, cubeColorClearcoat * schlickClearcoat, 0.5);\n#endif\n#endif\n#if TONEMAP_OUTPUT == 1\n    gl_FragColor.xyz = toneMapCanonOGS_WithGamma_WithColorPerserving(exposureBias * gl_FragColor.xyz);\n#elif TONEMAP_OUTPUT == 2\n    gl_FragColor.xyz = toneMapCanonFilmic_WithGamma( exposureBias * gl_FragColor.xyz );\n#endif\n#ifdef USE_FOG\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = smoothstep( fogNear, fogFar, depth );\n    gl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );\n#endif\n#include<theming_frag>\n#include<final_frag>\n}\n"};t.ShaderLib.firefly_phong=wu;var Mu,Su,Tu,Au,Eu,Ru,Lu,Pu,Iu,Cu="undefined"!=typeof self&&self.LmvVector3?self.LmvVector3:t.Vector3,Du={getVertexCount:function(e){return e.vb?e.vb.length/e.vbstride:e.attributes.positions?e.attributes.positions.count:0},enumMeshVertices:function(e,t,n){var r,a=e.attributes,i=e.vb||a.position.array,o=e.vb?e.vbstride:3;if(e.vblayout){if(!e.vblayout.position)return;r=e.vblayout.position.offset}else{if(!a.position)return;r=a.position.itemOffset||0}var s=i.length/o;Mu||(Mu=new Cu);for(var l=r,u=0;u<s;u++,l+=o)Mu.set(i[l],i[l+1],i[l+2]),n&&Mu.applyMatrix4(n),t(Mu,u)},enumMeshTriangles:function(e,t){var n,r,a,i=e.attributes;Su||(Su=new Cu,Tu=new Cu,Au=new Cu,Eu=new Cu,Ru=new Cu,Lu=new Cu);var o,s=e.vb||i.position.array,l=e.vb||i.normal&&i.normal.array,u=e.vb?e.vbstride:3;if(e.vblayout){if(!e.vblayout.position)return;o=e.vblayout.position.offset}else{if(!i.position)return;o=i.position.itemOffset||0}var f=0,d=e.vblayout?e.vblayout.normal:i.normal||null;d?f=d.offset||d.itemOffset:l=null,!d||3===d.itemSize&&4===d.bytesPerItem||(l=null);var c=e.ib||e.indices||(i.index?i.index.array:null);if(c){var p=e.offsets;p&&0!==p.length||(p=[{start:0,count:c.length,index:0}]);for(var h=0,m=p.length;h<m;++h)for(var _=p[h].start,v=p[h].count,g=p[h].index,y=_,x=_+v;y<x;y+=3){var b=(n=g+c[y])*u+o,w=(r=g+c[y+1])*u+o,M=(a=g+c[y+2])*u+o;if(Su.x=s[b],Su.y=s[b+1],Su.z=s[b+2],Tu.x=s[w],Tu.y=s[w+1],Tu.z=s[w+2],Au.x=s[M],Au.y=s[M+1],Au.z=s[M+2],l){var S=n*u+f,T=r*u+f,A=a*u+f;Eu.x=l[S],Eu.y=l[S+1],Eu.z=l[S+2],Ru.x=l[T],Ru.y=l[T+1],Ru.z=l[T+2],Lu.x=l[A],Lu.y=l[A+1],Lu.z=l[A+2],t(Su,Tu,Au,n,r,a,Eu,Ru,Lu)}else t(Su,Tu,Au,n,r,a)}}else for(var E=e.vb?e.vb.length/e.vbstride:s.length/3,R=0;R<E;R++){var b=(n=3*R)*u+o,w=(r=3*R+1)*u+o,M=(a=3*R+2)*u+o;if(Su.x=s[b],Su.y=s[b+1],Su.z=s[b+2],Tu.x=s[w],Tu.y=s[w+1],Tu.z=s[w+2],Au.x=s[M],Au.y=s[M+1],Au.z=s[M+2],l){var S=n*u+f,T=r*u+f,A=a*u+f;Eu.x=l[S],Eu.y=l[S+1],Eu.z=l[S+2],Ru.x=l[T],Ru.y=l[T+1],Ru.z=l[T+2],Lu.x=l[A],Lu.y=l[A+1],Lu.z=l[A+2],t(Su,Tu,Au,n,r,a,Eu,Ru,Lu)}else t(Su,Tu,Au,n,r,a)}},enumMeshLines:function(e,t){var n,r,a=e.attributes;Pu||(Pu=new Cu,Iu=new Cu);var i=2;e.lineWidth&&(i=6);var o=e.ib||e.indices||(a.index?a.index.array:null);if(o){var s=e.vb?e.vb:a.position.array,l=e.vb?e.vbstride:3,u=e.offsets;u&&0!==u.length||(u=[{start:0,count:o.length,index:0}]);for(var f=0,d=u.length;f<d;++f)for(var c=u[f].start,p=u[f].count,h=u[f].index,m=c,_=c+p;m<_;m+=i)n=h+o[m],r=h+o[m+1],Pu.x=s[n*l],Pu.y=s[n*l+1],Pu.z=s[n*l+2],Iu.x=s[r*l],Iu.y=s[r*l+1],Iu.z=s[r*l+2],t(Pu,Iu,n,r)}else for(var s=e.vb?e.vb:a.position.array,l=e.vb?e.vbstride:3,v=0,g=s.length;v<g;v+=i)n=v,r=v+1,Pu.x=s[n*l],Pu.y=s[n*l+1],Pu.z=s[n*l+2],Iu.x=s[r*l],Iu.y=s[r*l+1],Iu.z=s[r*l+2],t(Pu,Iu,n,r)}},Nu=function(e,t,n){this.x=e||0,this.y=t||0,this.z=n||0};Nu.prototype={constructor:Nu,set:function(e,t,n){return this.x=e,this.y=t,this.z=n,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y,this.z)},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},add:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this)},addScalar:function(e){return this.x+=e,this.y+=e,this.z+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this},addScaledVector:function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this},sub:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this)},subScalar:function(e){return this.x-=e,this.y-=e,this.z-=e,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this},multiply:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(e,t)):(this.x*=e.x,this.y*=e.y,this.z*=e.z,this)},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this},multiplyVectors:function(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this},applyMatrix3:function(e){var t=this.x,n=this.y,r=this.z,a=e.elements;return this.x=a[0]*t+a[3]*n+a[6]*r,this.y=a[1]*t+a[4]*n+a[7]*r,this.z=a[2]*t+a[5]*n+a[8]*r,this},applyMatrix4:function(e){var t=this.x,n=this.y,r=this.z,a=e.elements;return this.x=a[0]*t+a[4]*n+a[8]*r+a[12],this.y=a[1]*t+a[5]*n+a[9]*r+a[13],this.z=a[2]*t+a[6]*n+a[10]*r+a[14],this},applyProjection:function(e){var t=this.x,n=this.y,r=this.z,a=e.elements,i=1/(a[3]*t+a[7]*n+a[11]*r+a[15]);return this.x=(a[0]*t+a[4]*n+a[8]*r+a[12])*i,this.y=(a[1]*t+a[5]*n+a[9]*r+a[13])*i,this.z=(a[2]*t+a[6]*n+a[10]*r+a[14])*i,this},applyQuaternion:function(e){var t=this.x,n=this.y,r=this.z,a=e.x,i=e.y,o=e.z,s=e.w,l=s*t+i*r-o*n,u=s*n+o*t-a*r,f=s*r+a*n-i*t,d=-a*t-i*n-o*r;return this.x=l*s+d*-a+u*-o-f*-i,this.y=u*s+d*-i+f*-a-l*-o,this.z=f*s+d*-o+l*-i-u*-a,this},transformDirection:function(e){var t=this.x,n=this.y,r=this.z,a=e.elements;return this.x=a[0]*t+a[4]*n+a[8]*r,this.y=a[1]*t+a[5]*n+a[9]*r,this.z=a[2]*t+a[6]*n+a[10]*r,this.normalize(),this},divide:function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},divideScalar:function(e){if(0!==e){var t=1/e;this.x*=t,this.y*=t,this.z*=t}else this.x=0,this.y=0,this.z=0;return this},min:function(e){return this.x>e.x&&(this.x=e.x),this.y>e.y&&(this.y=e.y),this.z>e.z&&(this.z=e.z),this},max:function(e){return this.x<e.x&&(this.x=e.x),this.y<e.y&&(this.y=e.y),this.z<e.z&&(this.z=e.z),this},clamp:function(e,t){return this.x<e.x?this.x=e.x:this.x>t.x&&(this.x=t.x),this.y<e.y?this.y=e.y:this.y>t.y&&(this.y=t.y),this.z<e.z?this.z=e.z:this.z>t.z&&(this.z=t.z),this},clampScalar:function(){var e,t;return function(n,r){return void 0===e&&(e=new Nu,t=new Nu),e.set(n,n,n),t.set(r,r,r),this.clamp(e,t)}}(),floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length())},setLength:function(e){var t=this.length();return 0!==t&&e!==t&&this.multiplyScalar(e/t),this},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this},lerpVectors:function(e,t,n){return this.subVectors(t,e).multiplyScalar(n).add(e),this},cross:function(e,t){if(void 0!==t)return console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(e,t);var n=this.x,r=this.y,a=this.z;return this.x=r*e.z-a*e.y,this.y=a*e.x-n*e.z,this.z=n*e.y-r*e.x,this},crossVectors:function(e,t){var n=e.x,r=e.y,a=e.z,i=t.x,o=t.y,s=t.z;return this.x=r*s-a*o,this.y=a*i-n*s,this.z=n*o-r*i,this},projectOnVector:function(){var e,t;return function(n){return void 0===e&&(e=new Nu),e.copy(n).normalize(),t=this.dot(e),this.copy(e).multiplyScalar(t)}}(),projectOnPlane:function(){var e;return function(t){return void 0===e&&(e=new Nu),e.copy(this).projectOnVector(t),this.sub(e)}}(),reflect:function(){var e;return function(t){return void 0===e&&(e=new Nu),this.sub(e.copy(t).multiplyScalar(2*this.dot(t)))}}(),distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x,n=this.y-e.y,r=this.z-e.z;return t*t+n*n+r*r},setEulerFromRotationMatrix:function(e,t){console.error("THREE.Vector3: .setEulerFromRotationMatrix() has been removed. Use Euler.setFromRotationMatrix() instead.")},setEulerFromQuaternion:function(e,t){console.error("THREE.Vector3: .setEulerFromQuaternion() has been removed. Use Euler.setFromQuaternion() instead.")},getPositionFromMatrix:function(e){return console.warn("THREE.Vector3: .getPositionFromMatrix() has been renamed to .setFromMatrixPosition()."),this.setFromMatrixPosition(e)},getScaleFromMatrix:function(e){return console.warn("THREE.Vector3: .getScaleFromMatrix() has been renamed to .setFromMatrixScale()."),this.setFromMatrixScale(e)},getColumnFromMatrix:function(e,t){return console.warn("THREE.Vector3: .getColumnFromMatrix() has been renamed to .setFromMatrixColumn()."),this.setFromMatrixColumn(e,t)},setFromMatrixPosition:function(e){return this.x=e.elements[12],this.y=e.elements[13],this.z=e.elements[14],this},setFromMatrixScale:function(e){var t=this.set(e.elements[0],e.elements[1],e.elements[2]).length(),n=this.set(e.elements[4],e.elements[5],e.elements[6]).length(),r=this.set(e.elements[8],e.elements[9],e.elements[10]).length();return this.x=t,this.y=n,this.z=r,this},setFromMatrixColumn:function(e,t){var n=4*e,r=t.elements;return this.x=r[n],this.y=r[n+1],this.z=r[n+2],this},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e},fromAttribute:function(e,t,n){return void 0===n&&(n=0),t=t*e.itemSize+n,this.x=e.array[t],this.y=e.array[t+1],this.z=e.array[t+2],this}};var Ou=function(e,t){this.min=void 0!==e?e:new Nu(1/0,1/0,1/0),this.max=void 0!==t?t:new Nu(-1/0,-1/0,-1/0)};Ou.prototype={constructor:Ou,set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setFromPoints:function(e){this.makeEmpty();for(var t=0,n=e.length;t<n;t++)this.expandByPoint(e[t]);return this},setFromArray:function(e,t){return this.min.x=e[t],this.min.y=e[t+1],this.min.z=e[t+2],this.max.x=e[t+3],this.max.y=e[t+4],this.max.z=e[t+5],this},copyToArray:function(e,t){e[t]=this.min.x,e[t+1]=this.min.y,e[t+2]=this.min.z,e[t+3]=this.max.x,e[t+4]=this.max.y,e[t+5]=this.max.z},setFromCenterAndSize:function(){var e=new Nu;return function(t,n){var r=e.copy(n).multiplyScalar(.5);return this.min.copy(t).sub(r),this.max.copy(t).add(r),this}}(),clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this},empty:function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},center:function(e){return(e||new Nu).addVectors(this.min,this.max).multiplyScalar(.5)},size:function(e){return(e||new Nu).subVectors(this.max,this.min)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},containsPoint:function(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z)},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z},getParameter:function(e,t){return(t||new Nu).set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))},isIntersectionBox:function(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)},clampPoint:function(e,t){return(t||new Nu).copy(e).clamp(this.min,this.max)},distanceToPoint:function(){var e=new Nu;return function(t){return e.copy(t).clamp(this.min,this.max).sub(t).length()}}(),intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},applyMatrix4:function(){var e=[new Nu,new Nu,new Nu,new Nu,new Nu,new Nu,new Nu,new Nu];return function(t){return e[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(t),e[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(t),e[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(t),e[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(t),e[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(t),e[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(t),e[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(t),e[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(t),this.makeEmpty(),this.setFromPoints(e),this}}(),translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)}};var Uu,Fu,Vu,Bu,zu,Gu=Du.getVertexCount,ku=Du.enumMeshTriangles,Hu=Du.enumMeshVertices,Wu={createWireframe:function(e,t,n,r){function a(e,t){t.x=f[3*e],t.y=f[3*e+1],t.z=f[3*e+2]}function i(e,t,n,r){a(e,p),a(t,h),a(n,m),h.sub(p),m.sub(p),h.cross(m),r.copy(h).normalize()}function l(e,t,n){var a=u[e],o=u[t],s=u[n];if(a!==o&&a!==s&&o!==s){var l=!1;if(a>o){var f=a;a=o,o=f,l=!0}var p=d[a];if(p){var h=p[o];if(void 0===h)p[o]=l?-n-1:n;else{if(r)c.push(e),c.push(t);else{i(e,t,n,_),h<0?i(o,a,u[-h-1],v):i(a,o,u[h],v);var m=_.dot(v);Math.abs(m)<.25&&(c.push(e),c.push(t))}delete p[o]}}else d[a]={},d[a][o]=n}}if(!e.isLines&&!e.iblines){var u=o(e,n),f=s(e,t),d={},c=[],p=new Nu,h=new Nu,m=new Nu,_=new Nu,v=new Nu;ku(e,function(e,t,n,r,a,i){l(r,a,i),l(a,i,r),l(i,r,a)});for(var g in d)for(var y in d[g])c.push(parseInt(g)),c.push(parseInt(y));c.length>1&&(e.iblines=new Uint16Array(c.length),e.iblines.set(c))}}},qu=function(e,t){return e.distance-t.distance},ju={meshRayCast:u,lineRayCast:f,rayCast:c,intersectObject:function(e,t,n,r){p(e,t,n,r),n.sort(qu)}};h.prototype.getGeometry=function(e){return this.geoms[e]},h.prototype.chooseMemoryType=function(e,t,n,r){var a=au,i=2*a,o=iu;if(this.isf2d&&(i*=2),this.disableStreaming||r<a&&n<o)e.streamingDraw=!1,e.streamingIndex=!1;else if(r>=i)e.streamingDraw=!0,e.streamingIndex=!0;else{(this.is2d?100001:e.byteSize*(t||1))<1e5&&(e.streamingDraw=!0,e.streamingIndex=!0)}},h.prototype.addGeometry=function(n,r,a){this.chooseMemoryType(n,r,this.gpuNumMeshes,this.gpuMeshMemory);var i=n.byteSize+464;n.streamingDraw||(Yl()&&(i+=n.byteSize),this.gpuMeshMemory+=n.byteSize,this.gpuNumMeshes+=1),this.numGeomsInMemory++,(void 0===a||a<=0)&&(a=this.geoms.length),this.geoms[a]=n;var o=this.geomBoxes.length/6|0;if(o<this.geoms.length){var s=3*this.geoms.length/2|0,l=new Float32Array(6*s);l.set(this.geomBoxes);var u=new t.Box3;for(u.makeEmpty();o<s;)l[6*o]=u.min.x,l[6*o+1]=u.min.y,l[6*o+2]=u.min.z,l[6*o+3]=u.max.x,l[6*o+4]=u.max.y,l[6*o+++5]=u.max.z;this.geomBoxes=l}var f=n.boundingBox;f?(this.geomBoxes[6*a]=f.min.x,this.geomBoxes[6*a+1]=f.min.y,this.geomBoxes[6*a+2]=f.min.z,this.geomBoxes[6*a+3]=f.max.x,this.geomBoxes[6*a+4]=f.max.y,this.geomBoxes[6*a+5]=f.max.z):(n.hash||console.error("Mesh without bbox and without hash should not be."),this.geomBoxes[6*a]=-.5,this.geomBoxes[6*a+1]=-.5,this.geomBoxes[6*a+2]=-.5,this.geomBoxes[6*a+3]=.5,this.geomBoxes[6*a+4]=.5,this.geomBoxes[6*a+5]=.5),e.memoryOptimizedLoading&&!this.is2d&&(n.boundingBox=null,n.boundingSphere=null),this.geomMemory+=i;var d=n.attributes.index.array||n.ib,c=n.isLines?d.length/2:d.length/3;return this.geomPolyCount+=c,this.instancePolyCount+=c*(r||1),n.polyCount=c,n.instanceCount=r||1,n.svfid=a,n.lockCount=0,a},h.prototype.removeGeometry=function(e,t){var n=this.getGeometry(e);if(!n||n.lockCount>0)return 0;var r=n.byteSize+464;return t&&t.deallocateGeometry(n),n.streamingDraw||(Yl()&&(r+=n.byteSize),this.gpuMeshMemory-=n.byteSize,this.gpuNumMeshes-=1),this.geoms[e]=null,this.geomMemory-=r,this.numGeomsInMemory--,this.geomPolyCount-=n.polyCount,this.instancePolyCount-=n.instanceCount*n.polyCount,r},h.prototype.lockGeometry=function(e){var t=this.getGeometry(e);return!!t&&(++t.lockCount,!0)},h.prototype.unlockGeometry=function(e){var t=this.getGeometry(e);return!(!t||t.lockCount<=0)&&(--t.lockCount,!0)},h.prototype.getLockCount=function(e){var t=this.getGeometry(e);return t?t.lockCount:-1},h.prototype.getModelBox=function(e,t){if(this.geomBoxes.length/6<=e)t.makeEmpty();else{var n=6*e,r=this.geomBoxes;t.min.x=r[n],t.min.y=r[n+1],t.min.z=r[n+2],t.max.x=r[n+3],t.max.y=r[n+4],t.max.z=r[n+5]}},h.prototype.dispose=function(e){if(e)for(var t=0,n=this.geoms.length;t<n;t++)this.geoms[t]&&e.deallocateGeometry(this.geoms[t])},h.prototype.printStats=function(){t.log("Total geometry size: "+this.geomMemory/1048576+" MB"),t.log("Number of meshes: "+this.geoms.length),t.log("Num Meshes on GPU: "+this.gpuNumMeshes),t.log("Net GPU geom memory used: "+this.gpuMeshMemory)};var Xu=[[1,5,4,7,3,2,6],[0,3,2,1,5,4,6],[0,3,2,6,5,4,6],[0,4,7,3,2,1,6],[0,3,2,1,-1,-1,4],[0,3,2,6,5,1,6],[0,4,7,6,2,1,6],[0,3,7,6,2,1,6],[0,3,7,6,5,1,6],[0,1,5,4,7,3,6],[0,1,5,4,-1,-1,4],[0,1,2,6,5,4,6],[0,4,7,3,-1,-1,4],[-1,-1,-1,-1,-1,-1,0],[1,2,6,5,-1,-1,4],[0,4,7,6,2,3,6],[2,3,7,6,-1,-1,4],[1,2,3,7,6,5,6],[0,1,5,6,7,3,6],[0,1,5,6,7,4,6],[0,1,2,6,7,4,6],[0,4,5,6,7,3,6],[4,5,6,7,-1,-1,4],[1,2,6,7,4,5,6],[0,4,5,6,2,3,6],[2,3,7,4,5,6,6],[1,2,3,7,4,5,6]],Yu=function(){this.frustum=new t.Frustum,this.viewProj=new t.Matrix4,this.viewDir=[0,0,1],this.ar=1,this.viewport=new t.Vector3(1,1,1),this.areaConv=1,this.areaCullThreshold=1,this.eye=new t.Vector3};Object.defineProperty(Yu,"OUTSIDE",{value:0}),Object.defineProperty(Yu,"INTERSECTS",{value:1}),Object.defineProperty(Yu,"CONTAINS",{value:2}),Object.defineProperty(Yu,"CONTAINMENT_UNKNOWN",{value:-1}),Yu.prototype.reset=function(e){this.viewProj.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),this.frustum.setFromMatrix(this.viewProj);var t=e.matrixWorldInverse.elements;this.ar=e.aspect,this.viewDir[0]=-t[2],this.viewDir[1]=-t[6],this.viewDir[2]=-t[10],this.eye.x=e.position.x,this.eye.y=e.position.y,this.eye.z=e.position.z,this.areaConv=e.clientWidth*e.clientHeight/4},Yu.prototype.projectedArea=function(){function e(){r||(r=[new t.Vector3,new t.Vector3,new t.Vector3,new t.Vector3,new t.Vector3,new t.Vector3,new t.Vector3,new t.Vector3],a=new t.Box2)}function n(e,t){var n=e.x,r=e.y,a=e.z,i=t.elements,o=i[3]*n+i[7]*r+i[11]*a+i[15];o<0&&(o=-o);var s=1/o;e.x=(i[0]*n+i[4]*r+i[8]*a+i[12])*s,e.y=(i[1]*n+i[5]*r+i[9]*a+i[13])*s}var r,a;return function(t){if(t.empty())return 0;e();var i=this.viewProj;r[0].set(t.min.x,t.min.y,t.min.z),r[1].set(t.min.x,t.min.y,t.max.z),r[2].set(t.min.x,t.max.y,t.min.z),r[3].set(t.min.x,t.max.y,t.max.z),r[4].set(t.max.x,t.min.y,t.min.z),r[5].set(t.max.x,t.min.y,t.max.z),r[6].set(t.max.x,t.max.y,t.min.z),r[7].set(t.max.x,t.max.y,t.max.z);for(var o=0;o<8;o++)n(r[o],i);return a.makeEmpty(),a.setFromPoints(r),a.min.x<-1&&(a.min.x=-1),a.min.x>1&&(a.min.x=1),a.min.y<-1&&(a.min.y=-1),a.min.y>1&&(a.min.y=1),a.max.x>1&&(a.max.x=1),a.max.x<-1&&(a.max.x=-1),a.max.y>1&&(a.max.y=1),a.max.y<-1&&(a.max.y=-1),(a.max.x-a.min.x)*(a.max.y-a.min.y)}}(),Yu.prototype.projectedBoxArea=function(){function e(){if(!a){a=[],i=[];for(var e=0;e<10;e++)a.push(new t.Vector3),i.push(new t.Vector3)}}function n(e,t){var n=e.x,r=e.y,a=e.z,i=t.elements,o=i[3]*n+i[7]*r+i[11]*a+i[15];o<0&&(o=-o);var s=1/o;e.x=(i[0]*n+i[4]*r+i[8]*a+i[12])*s,e.y=(i[1]*n+i[5]*r+i[9]*a+i[13])*s}function r(e,t){var n,r,a,s,l,u,f,d,c=e,p=i,h=function(e){switch(f){case 0:return e.x>=-1;case 1:return e.x<=1;case 2:return e.y>=-1;case 3:return e.y<=1}},m=function(e){p[d].x=e.x,p[d++].y=e.y},_=function(){var e,t;switch(f){case 0:e=-1,t=r.y+(a.y-r.y)*(e-r.x)/(a.x-r.x);break;case 1:e=1,t=r.y+(a.y-r.y)*(e-r.x)/(a.x-r.x);break;case 2:t=-1,e=r.x+(a.x-r.x)*(t-r.y)/(a.y-r.y);break;case 3:t=1,e=r.x+(a.x-r.x)*(t-r.y)/(a.y-r.y)}p[d].x=e,p[d++].y=t};for(f=0;f<4&&t>2;f++){for(d=0,s=h(r=c[t-1]),u=0;u<t;u++)l=h(a=c[u]),s?l?m(a):_():l&&(_(),m(a)),r=a,s=l;t=d,n=c,c=p,p=n}return o=t,c}var a,i,o;return function(t,i){if(t.empty())return 0;e();var s,l=this.viewProj;if(s=this.eye.x>=t.min.x?this.eye.x>t.max.x?2:1:0,this.eye.y>=t.min.y&&(s+=this.eye.y>t.max.y?6:3),this.eye.z>=t.min.z&&(s+=this.eye.z>t.max.z?18:9),13===s)return 4;var u,f=Xu[s][6];for(u=0;u<f;u++){var d=Xu[s][u];a[u].set((d+1)%4<2?t.min.x:t.max.x,d%4<2?t.min.y:t.max.y,d<4?t.min.z:t.max.z),n(a[u],l)}var c=0;if(i)for(c=(a[f-1].x-a[0].x)*(a[f-1].y+a[0].y),u=0;u<f-1;u++)c+=(a[u].x-a[u+1].x)*(a[u].y+a[u+1].y);else{var p=r(a,f);if(o>=3)for(c=(p[o-1].x-p[0].x)*(p[o-1].y+p[0].y),u=0;u<o-1;u++)c+=(p[u].x-p[u+1].x)*(p[u].y+p[u+1].y)}return Math.abs(.5*c)}}(),Yu.prototype.estimateDepth=function(e){var t=this.viewProj.elements,n=(e.min.x+e.max.x)/2,r=(e.min.y+e.max.y)/2,a=(e.min.z+e.max.z)/2,i=1/(t[3]*n+t[7]*r+t[11]*a+t[15]);return(t[2]*n+t[6]*r+t[10]*a+t[14])*i},Yu.prototype.intersectsBox=function(){function e(){n||(n=new t.Vector3,r=new t.Vector3)}var n,r;return function(t){e();for(var a=this.frustum.planes,i=0,o=0;o<6;o++){var s=a[o];n.x=s.normal.x>0?t.min.x:t.max.x,r.x=s.normal.x>0?t.max.x:t.min.x,n.y=s.normal.y>0?t.min.y:t.max.y,r.y=s.normal.y>0?t.max.y:t.min.y,n.z=s.normal.z>0?t.min.z:t.max.z,r.z=s.normal.z>0?t.max.z:t.min.z;var l=s.distanceToPoint(n),u=s.distanceToPoint(r);if(l<0&&u<0)return Yu.OUTSIDE;l>0&&u>0&&i++}return 6==i?Yu.CONTAINS:Yu.INTERSECTS}}(),Object.defineProperty(Yu,"OUTSIDE",{value:0}),Object.defineProperty(Yu,"INTERSECTS",{value:1}),Object.defineProperty(Yu,"CONTAINS",{value:2}),Object.defineProperty(Yu,"CONTAINMENT_UNKNOWN",{value:-1});var Ku;_.prototype.getIndices=function(){return Array.isArray(this.indices)?this.indices[0]:this.indices},_.prototype.sortByMaterial=function(){if(!(this.numAdded<this.count)){var e=this.frags,n=this.getIndices();if(n){var r=n.subarray(this.start,this.start+this.count);Array.prototype.sort.call(r,function(t,n){var r=e.getMaterialId(t),a=e.getMaterialId(n);return void 0===r?a?1:0:void 0===a?-1:r-a}),this.numAdded=0,this.sortDone=!0}else t.warn("Only indexed RenderSubsets can be sorted.")}},_.prototype.sortByShader=function(){if(this.sortDone&&!this.sortByShaderDone){var e=this.frags,t=this.getIndices().subarray(this.start,this.start+this.count);Array.prototype.sort.call(t,function(t,n){var r=e.getMaterial(t),a=e.getMaterial(n),i=r.program.id-a.program.id;return i||r.id-a.id}),this.numAdded=0,this.sortByShaderDone=!0}},_.prototype.sortByDepth=function(){function e(e,t){n.getGeometry(e)?(n.getWorldBounds(e,i),o[t]=a.estimateDepth(i)):o[t]=-1/0}var n,r,a,i,o;return function(s){if(n=this.frags,r=this.getIndices(),a=s,i=Ku,r){(!this.indicesView||this.indicesView.length<this.count)&&(this.indicesView=r.subarray(this.start,this.start+this.count)),(!this.depths||this.depths.length<this.count)&&(this.depths=new Float32Array(this.count)),o=this.depths,this.forEachNoMesh(e);for(var l,u,f=1;f<o.length;f++)for(var d=f;d>0&&o[d-1]<o[d];)l=o[d-1],o[d-1]=o[d],o[d]=l,u=this.indicesView[d-1],this.indicesView[d-1]=this.indicesView[d],this.indicesView[d]=u,d--}else t.warn("Only indexed RenderSubsets can be sorted.")}}(),_.prototype.onFragmentAdded=function(e){this.frags.getWorldBounds(e,Ku),this.boundingBox.union(Ku),this.sortDone=!1,this.lastItem<=e&&(this.lastItem=e+1,void 0!==this.visibleStats&&(this.visibleStats=0),this.numAdded++)},_.prototype.forEach=function(e,t,n){var r,a,i,o=this.getIndices(),s=this.frags,l=!this.sortByShaderDone;if(t||n||l)for(r=t==_u&&this.hasOwnProperty("drawStart")?this.drawStart:this.start,a=this.lastItem;r<a;r++){i=o?o[r]:r;var u=s.getVizmesh(i,this.renderImportance);!l||u&&u.material&&u.material.program&&!u.geometry_proxy||(l=!1),!(n||u&&u.geometry)||t&&!s.isFlagSet(i,t)||e(u,i)}else for(r=this.start,a=this.lastItem;r<a;r++)i=o?o[r]:r,(u=s.getVizmesh(i,this.renderImportance))&&u.geometry&&e(u,i);l&&this.sortByShader()},_.prototype.forEachNoMesh=function(e,t,n){for(var r=this.getIndices(),a=this.frags,i=this.start,o=this.lastItem;i<o;i++){var s,l=r?r[i]:i;if(a.useThreeMesh){var u=a.getVizmesh(l);u&&(s=u.geometry)}else s=a.getGeometry(l);!n&&!s||t&&!a.isFlagSet(l,t)||e(l,i-this.start)}},_.prototype.raycast=function(e,t,n){if(!1!==e.ray.isIntersectionBox(this.boundingBox)){var r=this,a=Ku;this.forEach(function(i,o){if(!r.frags.isFlagSet(o,cu)){if(n&&n.length){var s=0|r.frags.getDbIds(o);if(-1===n.indexOf(s))return}r.frags.getWorldBounds(o,a),a.expandByScalar(.5),e.ray.isIntersectionBox(a)&&ju.rayCast(i,e,t)}},fu)}},_.prototype.calculateBounds=function(){function e(e){a.getWorldBounds(e,i),1&t[e]?n.union(i):r.union(i)}var t,n,r,a,i;return function(){this.boundingBox.makeEmpty(),this.boundingBoxHidden.makeEmpty(),t=this.frags.vizflags,n=this.boundingBox,r=this.boundingBoxHidden,a=this.frags,i=Ku,this.forEachNoMesh(e,0,this.frags.onDemandLoadingEnabled())}}(),_.prototype.evalVisbility=function(e,t,n){var r,a=t[n]&~_u;switch(e){case 3:r=!(a&fu);break;case 1:case 2:r=a&du;break;default:r=1==(a&(fu|du|cu))}return t[n]=a|(r?_u:0),r},_.prototype.applyVisibility=function(){function e(e,n){if(!e&&r.useThreeMesh||!e.geometry)s&&s(n);else{if(v(l,i,r,n))return e?e.visible=!1:t.warn("Unexpected null mesh"),void(a[n]=a[n]&~_u);var f=this.evalVisbility(o,a,n);e&&(e.visible=!!f),u=u&&!f}}function n(e){if(r.getGeometryId(e))if(v(l,i,r,e))a[e]=a[e]&~_u;else{var t=this.evalVisbility(o,a,e);u=u&&!t}else s&&s(e)}var r,a,i,o,s,l,u;return function(t,f,d){u=!0,o=t,s=d;var c=(i=f).intersectsBox(3===o?this.boundingBoxHidden:this.boundingBox);return c===Yu.OUTSIDE?u:(a=this.frags.vizflags,r=this.frags,l=c!==Yu.CONTAINS,d||r.useThreeMesh?this.forEach(e.bind(this),null,s):this.forEachNoMesh(n.bind(this),null),u)}}();var Zu,Qu,Ju,$u={},ef={},tf=1,nf={meshToGeometry:w,createBufferGeometry:b},rf=1,af=function(e,t,n,r,a,i,o){for(var s=e.posOffset,l=r;l<a;l++){var u=l*e.vbstride+s;o.set(e.vb[u],e.vb[u+1],e.vb[u+2]),o.applyMatrix4(n),e.vb[u]=o.x,e.vb[u+1]=o.y,e.vb[u+2]=o.z}if(-1!==e.normalOffset){var f=2*e.vbstride,d=2*e.normalOffset,c=R(n,i);for(l=r;l<a;l++){var p=l*f+d;o.set(t[p],t[p+1],0),o.divideScalar(65535),A(o),o.applyMatrix4(c),o.normalize(),T(o),o.multiplyScalar(65535),t[p]=o.x,t[p+1]=o.y}}};S.prototype.run=function(e,t){for(var n=this.vb,r=n.length/this.vbstride,a=e.clone(),i=new Uint8Array(3*r),o=-1!==this.normalOffset?new Uint16Array(n.buffer,n.byteOffset,2*n.length):null,s=this.ranges,l=this.matrices,u=s.length-1,f=0;f<u;f++){var d=s[f],c=s[f+1];L(f,l,e),af(this,o,e,d,c,a,t);for(var p=3*d,h=c-d,m=this.dbIds[f],_=0;_<h;_++)E(m,i,p),p+=3}return{taskId:this.id,vb:this.vb,vertexIds:i}};var of=Du.getVertexCount,sf={ParallelGeomMerge:function e(t){function n(e){for(var t=e.data,n=0;n<t.length;n++){var i=t[n],l=i.taskId;C(i,a[l]),delete a[l]}if(0==--r)for(o.inProgress=!1,n=0;n<s.length;n++)s[n].clearAllEventListenerWithIntercept(),s[n].terminate(),s[n]=null}var r=0,a={},i=[],o=t,s=new Array(2);this.addMergeTask=function(e,t,n,r){var o=I(e,t,n,r);i.push(o),a[o.id]=t},this.runTasks=function(){for(var t=0;t<2;t++)s[t]=e.createWorker(),s[t].addEventListenerWithIntercept(n);for(var a=i.length,l=Math.floor(a/2),u=0;u<2;u++){var f=u*l,d=1===u?a:f+l,c=d-f,p=[],h=new Array(4*c),m=0;for(t=f;t<d;t++){var _=i[t];h[m++]=_.vb.buffer,h[m++]=_.matrices.buffer,h[m++]=_.ranges.buffer,h[m++]=_.dbIds.buffer,p.push(_)}var v={operation:"MERGE_GEOMETRY",tasks:p};s[u].doOperation(v,h),r++}o.inProgress=!0}},runMergeSingleThreaded:function(e,n,r,a){var i=I(e,n,r,a),o=new t.Vector3,s=new t.Matrix4;C(i.run(s,o),n)}},lf=[{id:"SOLID",name:"Solid",ascii_art:"_______________________________________",def:[1]},{id:"BORDER",name:"Border",ascii_art:"__ __ . __ __ . __ __ . __ __ . __ __ .",def:[.5,-.25,.5,-.25,0,-.25]},{id:"BORDER2",name:"Border (.5x)",ascii_art:"__ __ . __ __ . __ __ . __ __ . __ __ .",def:[.25,-.125,.25,-.125,0,-.125]},{id:"BORDERX2",name:"Border (2x)",ascii_art:"____  ____  .  ____  ____  .  ___",def:[1,-.5,1,-.5,0,-.5]},{id:"CENTER",name:"Center",ascii_art:"____ _ ____ _ ____ _ ____ _ ____ _ ____",def:[1.25,-.25,.25,-.25]},{id:"CENTER2",name:"Center (.5x)",ascii_art:"___ _ ___ _ ___ _ ___ _ ___ _ ___",def:[.75,-.125,.125,-.125]},{id:"CENTERX2",name:"Center (2x)",ascii_art:"________  __  ________  __  _____",def:[2.5,-.5,.5,-.5]},{id:"DASHDOT",name:"Dash dot",ascii_art:"__ . __ . __ . __ . __ . __ . __ . __",def:[.5,-.25,0,-.25]},{id:"DASHDOT2",name:"Dash dot (.5x)",ascii_art:"_._._._._._._._._._._._._._._.",def:[.25,-.125,0,-.125]},{id:"DASHDOTX2",name:"Dash dot (2x)",ascii_art:"____  .  ____  .  ____  .  ___",def:[1,-.5,0,-.5]},{id:"DASHED",name:"Dashed",ascii_art:"__ __ __ __ __ __ __ __ __ __ __ __ __ _",def:[.5,-.25]},{id:"DASHED2",name:"Dashed (.5x)",ascii_art:"_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _",def:[.25,-.125]},{id:"DASHEDX2",name:"Dashed (2x)",ascii_art:"____  ____  ____  ____  ____  ___",def:[1,-.5]},{id:"DIVIDE",name:"Divide",ascii_art:"____ . . ____ . . ____ . . ____ . . ____",def:[.5,-.25,0,-.25,0,-.25]},{id:"DIVIDE2",name:"Divide (.5x)",ascii_art:"__..__..__..__..__..__..__..__.._",def:[.25,-.125,0,-.125,0,-.125]},{id:"DIVIDEX2",name:"Divide (2x)",ascii_art:"________  .  .  ________  .  .  _",def:[1,-.5,0,-.5,0,-.5]},{id:"DOT",name:"Dot",ascii_art:". . . . . . . . . . . . . . . . . . . . . . . .",def:[0,-.25]},{id:"DOT2",name:"Dot (.5x)",ascii_art:"........................................",def:[0,-.125]},{id:"DOTX2",name:"Dot (2x)",ascii_art:".  .  .  .  .  .  .  .  .  .  .  .  .  .",def:[0,-.5]},{id:"HIDDEN",name:"Hidden",ascii_art:"__ __ __ __ __ __ __ __ __ __ __ __ __ __",def:[.25,-.125]},{id:"HIDDEN2",name:"Hidden (.5x)",ascii_art:"_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _",def:[.125,-.0625]},{id:"HIDDENX2",name:"Hidden (2x)",ascii_art:"____ ____ ____ ____ ____ ____ ____",def:[.5,-.25]},{id:"PHANTOM",name:"Phantom",ascii_art:"______  __  __  ______  __  __  ______",def:[1.25,-.25,.25,-.25,.25,-.25]},{id:"PHANTOM2",name:"Phantom (.5x)",ascii_art:"___ _ _ ___ _ _ ___ _ _ ___ _ _",def:[.625,-.125,.125,-.125,.125,-.125]},{id:"PHANTOMX2",name:"Phantom (2x)",ascii_art:"____________    ____    ____   _",def:[2.5,-.5,.5,-.5,.5,-.5]},{id:"ACAD_ISO02W100",name:"ISO dash",ascii_art:"__ __ __ __ __ __ __ __ __ __ __ __ __",def:[12,-3],pen_width:1,unit:"mm"},{id:"ACAD_ISO03W100",name:"ISO dash space",ascii_art:"__    __    __    __    __    __",def:[12,-18],pen_width:1,unit:"mm"},{id:"ACAD_ISO04W100",name:"ISO long-dash dot",ascii_art:"____ . ____ . ____ . ____ . _",def:[24,-3,.5,-3],pen_width:1,unit:"mm"},{id:"ACAD_ISO05W100",name:"ISO long-dash double-dot",ascii_art:"____ .. ____ .. ____ .",def:[24,-3,.5,-3,.5,-3],pen_width:1,unit:"mm"},{id:"ACAD_ISO06W100",name:"ISO long-dash triple-dot",ascii_art:"____ ... ____ ... ____",def:[24,-3,.5,-3,.5,-3,.5,-3],pen_width:1,unit:"mm"},{id:"ACAD_ISO07W100",name:"ISO dot",ascii_art:". . . . . . . . . . . . . . . . . . . .",def:[.5,-3],pen_width:1,unit:"mm"},{id:"ACAD_ISO08W100",name:"ISO long-dash short-dash",ascii_art:"____ __ ____ __ ____ _",def:[24,-3,6,-3],pen_width:1,unit:"mm"},{id:"ACAD_ISO09W100",name:"ISO long-dash double-short-dash",ascii_art:"____ __ __ ____",def:[24,-3,6,-3,6,-3],pen_width:1,unit:"mm"},{id:"ACAD_ISO10W100",name:"ISO dash dot",ascii_art:"__ . __ . __ . __ . __ . __ . __ . ",def:[12,-3,.5,-3],pen_width:1,unit:"mm"},{id:"ACAD_ISO11W100",name:"ISO double-dash dot",ascii_art:"__ __ . __ __ . __ __ . __ _",def:[12,-3,12,-3,.5,-3],pen_width:1,unit:"mm"},{id:"ACAD_ISO12W100",name:"ISO dash double-dot",ascii_art:"__ . . __ . . __ . . __ . .",def:[12,-3,.5,-3,.5,-3],pen_width:1,unit:"mm"},{id:"ACAD_ISO13W100",name:"ISO double-dash double-dot",ascii_art:"__ __ . . __ __ . . _",def:[12,-3,12,-3,.5,-3,.5,-3],pen_width:1,unit:"mm"},{id:"ACAD_ISO14W100",name:"ISO dash triple-dot",ascii_art:"__ . . . __ . . . __ . . . _",def:[12,-3,.5,-3,.5,-3,.5,-3],pen_width:1,unit:"mm"},{id:"ACAD_ISO15W100",name:"ISO double-dash triple-dot",ascii_art:"__ __ . . . __ __ . .",def:[12,-3,12,-3,.5,-3,.5,-3,.5,-3],pen_width:1,unit:"mm"},{id:"FENCELINE1",name:"Fenceline circle",ascii_art:"----0-----0----0-----0----0-----0--",def:[.25,-.1,["CIRC1","ltypeshp.shx","x=-.1","s=.1"],-.1,1]},{id:"FENCELINE2",name:"Fenceline square",ascii_art:"----[]-----[]----[]-----[]----[]---",def:[.25,-.1,["BOX","ltypeshp.shx","x=-.1","s=.1"],-.1,1]},{id:"TRACKS",name:"Tracks",ascii_art:"-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-",def:[.15,["TRACK1","ltypeshp.shx","s=.25"],.15]},{id:"BATTING",name:"Batting",ascii_art:"SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS",def:[1e-4,-.1,["BAT","ltypeshp.shx","x=-.1","s=.1"],-.2,["BAT","ltypeshp.shx","r=180","x=.1","s=.1"],-.1]},{id:"HOT_WATER_SUPPLY",name:"Hot water supply",ascii_art:"---- HW ---- HW ---- HW ----",def:[.5,-.2,["HW","STANDARD","S=.1","R=0.0","X=-0.1","Y=-.05"],-.2]},{id:"GAS_LINE",name:"Gas line",ascii_art:"----GAS----GAS----GAS----GAS----GAS----GAS--",def:[.5,-.2,["GAS","STANDARD","S=.1","R=0.0","X=-0.1","Y=-.05"],-.25]},{id:"ZIGZAG",name:"Zig zag",ascii_art:"/\\/\\/\\/\\/\\/\\/\\/\\/\\/\\/\\/\\/\\/\\/\\/\\/\\/\\/\\/\\/\\/\\/\\/",def:[1e-4,-.2,["ZIG","ltypeshp.shx","x=-.2","s=.2"],-.4,["ZIG","ltypeshp.shx","r=180","x=.2","s=.2"],-.2]}],uf=function(){for(var e=lf.length,n=0,r=0;r<e;r++)(f=lf[r]).def.length>n&&(n=f.def.length);for(var a=n+3,i=e,o=1;o<a;)o*=2;for(a=o,o=1;o<i;)o*=2;i=o;for(var s=new Uint8Array(a*i),l=0;l<e;l++){for(var u=l*a,f=lf[l],d=f.unit&&"mm"==f.unit?1/25.4:1,c=f.pen_width||0,p=f.def,h=0,r=0;r<p.length;r++){var m=Math.abs(p[r]);m<=.5*c&&(m=0);var _=0|96*m*d;h+=_,s[u+r+2]=_||1}s[u]=h%256,s[u+1]=h/256,s[u+p.length+2]=0}var v=new t.DataTexture(s,a,i,t.LuminanceFormat,t.UnsignedByteType,t.UVMapping,t.ClampToEdgeWrapping,t.ClampToEdgeWrapping,t.NearestFilter,t.NearestFilter,0);return v.generateMipmaps=!1,v.flipY=!1,v.needsUpdate=!0,v},ff={LineStyleDefs:lf,CreateLinePatternTexture:uf},df={uniforms:t.UniformsUtils.merge([t.UniformsLib.common,t.UniformsLib.lights,t.UniformsLib.fog,wl.CutPlanesUniforms,wl.IdUniforms,wl.ThemingUniform,wl.ShadowMapUniforms,D("surface_albedo_map"),D("surface_roughness_map"),D("surface_cutout_map"),D("surface_anisotropy_map"),D("surface_rotation_map"),D("opaque_albedo_map"),D("opaque_f0_map"),D("opaque_luminance_modifier_map"),D("layered_bottom_f0_map"),D("layered_f0_map"),D("layered_diffuse_map"),D("layered_fraction_map"),D("layered_roughness_map"),D("layered_anisotropy_map"),D("layered_rotation_map"),D("metal_f0_map"),D("wood_curly_distortion_map"),D("glazing_f0_map"),D("glazing_transmission_color_map"),D("glazing_transmission_roughness_map"),N("surface_normal_map"),N("layered_normal_map"),D("TilingMap"),D("TilingNormalMap"),D("TilingRandomMap"),{surface_albedo:{type:"c",value:new t.Color(1118481)},surface_roughness:{type:"f",value:1},surface_anisotropy:{type:"f",value:1},surface_rotation:{type:"f",value:1},opaque_albedo:{type:"c",value:new t.Color(1118481)},opaque_f0:{type:"f",value:1},opaque_luminance_modifier:{type:"c",value:new t.Color(1118481)},opaque_luminance:{type:"f",value:1},metal_f0:{type:"c",value:new t.Color(1118481)},layered_f0:{type:"f",value:1},layered_diffuse:{type:"c",value:new t.Color(0)},layered_fraction:{type:"f",value:1},layered_bottom_f0:{type:"c",value:new t.Color(1118481)},layered_roughness:{type:"f",value:1},layered_anisotropy:{type:"f",value:1},layered_rotation:{type:"f",value:1},transparent_ior:{type:"f",value:2},transparent_color:{type:"c",value:new t.Color(1118481)},transparent_distance:{type:"f",value:1},glazing_f0:{type:"c",value:new t.Color(16777215)},glazing_transmission_roughness:{type:"f",value:0},glazing_transmission_color:{type:"c",value:new t.Color(16777215)},wood_fiber_cosine_enable:{type:"i",value:1},wood_fiber_cosine_bands:{type:"i",value:2},wood_fiber_cosine_weights:{type:"v4",value:new t.Vector4(2.5,.5,1,1)},wood_fiber_cosine_frequencies:{type:"v4",value:new t.Vector4(15,4,1,1)},wood_fiber_perlin_enable:{type:"i",value:1},wood_fiber_perlin_bands:{type:"i",value:3},wood_fiber_perlin_weights:{type:"v4",value:new t.Vector4(3,1,.2,1)},wood_fiber_perlin_frequencies:{type:"v4",value:new t.Vector4(40,20,3.5,1)},wood_fiber_perlin_scale_z:{type:"f",value:.3},wood_growth_perlin_enable:{type:"i",value:1},wood_growth_perlin_bands:{type:"i",value:3},wood_growth_perlin_weights:{type:"v4",value:new t.Vector4(1,2,1,1)},wood_growth_perlin_frequencies:{type:"v4",value:new t.Vector4(1,5,13,1)},wood_latewood_ratio:{type:"f",value:.238},wood_earlywood_sharpness:{type:"f",value:.395},wood_latewood_sharpness:{type:"f",value:.109},wood_ring_thickness:{type:"f",value:.75},wood_earlycolor_perlin_enable:{type:"i",value:1},wood_earlycolor_perlin_bands:{type:"i",value:2},wood_earlycolor_perlin_weights:{type:"v4",value:new t.Vector4(.3,.5,.15,1)},wood_earlycolor_perlin_frequencies:{type:"v4",value:new t.Vector4(8,3,.35,1)},wood_early_color:{type:"c",value:new t.Color(.286,.157,.076)},wood_use_manual_late_color:{type:"i",value:0},wood_manual_late_color:{type:"c",value:new t.Color(.62,.35,.127)},wood_latecolor_perlin_enable:{type:"i",value:1},wood_latecolor_perlin_bands:{type:"i",value:1},wood_latecolor_perlin_weights:{type:"v4",value:new t.Vector4(.75,.55,1,1)},wood_latecolor_perlin_frequencies:{type:"v4",value:new t.Vector4(4.5,.05,1,1)},wood_late_color_power:{type:"f",value:1.25},wood_diffuse_perlin_enable:{type:"i",value:1},wood_diffuse_perlin_bands:{type:"i",value:3},wood_diffuse_perlin_weights:{type:"v4",value:new t.Vector4(.15,.2,.05,1)},wood_diffuse_perlin_frequencies:{type:"v4",value:new t.Vector4(.05,.1,3,1)},wood_diffuse_perlin_scale_z:{type:"f",value:.2},wood_use_pores:{type:"i",value:1},wood_pore_type:{type:"i",value:0},wood_pore_radius:{type:"f",value:.04},wood_pore_cell_dim:{type:"f",value:.15},wood_pore_color_power:{type:"f",value:1.45},wood_pore_depth:{type:"f",value:.02},wood_use_rays:{type:"i",value:1},wood_ray_color_power:{type:"f",value:1.1},wood_ray_seg_length_z:{type:"f",value:5},wood_ray_num_slices:{type:"f",value:160},wood_ray_ellipse_z2x:{type:"f",value:10},wood_ray_ellipse_radius_x:{type:"f",value:.2},wood_use_latewood_bump:{type:"i",value:1},wood_latewood_bump_depth:{type:"f",value:.01},wood_use_groove_roughness:{type:"i",value:1},wood_groove_roughness:{type:"f",value:.85},wood_diffuse_lobe_weight:{type:"f",value:.9},wood_curly_distortion_enable:{type:"i",value:0},wood_curly_distortion_scale:{type:"f",value:.25},wood_ring_fraction:{type:"v4",value:new t.Vector4(0,0,0,0)},wood_fall_rise:{type:"v2",value:new t.Vector2(0,0)},permutationMap:{type:"t",value:null},gradientMap:{type:"t",value:null},perm2DMap:{type:"t",value:null},permGradMap:{type:"t",value:null},importantSamplingRandomMap:{type:"t",value:null},importantSamplingSolidAngleMap:{type:"t",value:null},irradianceMap:{type:"t",value:null},envMap:{type:"t",value:null},exposureBias:{type:"f",value:1},envMapExposure:{type:"f",value:1},envRotationSin:{type:"f",value:0},envRotationCos:{type:"f",value:1},envExponentMin:{type:"f",value:1},envExponentMax:{type:"f",value:512},envExponentCount:{type:"f",value:10},tilingOverallTransform:{type:"m4",value:new t.Matrix4},uv2tile:{type:"v4",value:new t.Vector4(1,0,0,1)},tile2uv:{type:"v4",value:new t.Vector4(1,0,0,1)},tileAlignOffset:{type:"v2",value:new t.Vector2(0,0)},tilingUVTransform:{type:"m4",value:new t.Matrix4},tilingRandomAxisS:{type:"v2",value:new t.Vector2(0,0)},tilingRandomAxisT:{type:"v2",value:new t.Vector2(0,0)},tilingRandomAlignmentOffset:{type:"v2",value:new t.Vector2(0,0)}}]),vertexShader:"varying vec3 vViewPosition;\nvarying vec3 vNormal;\n#if defined(PRISMWOOD) && !defined(NO_UVW)\nvarying vec3 vUvw;\n#if defined(PRISMWOODBUMP)\nvarying vec3 vtNormal;\nvarying mat3 mNormalMatrix;\n#endif\n#endif\n#if MAX_SPOT_LIGHTS > 0 || NUM_CUTPLANES > 0\nvarying vec3 vWorldPosition;\n#endif\n#prism_check<USE_MAP>\n#if defined(USE_MAP) || defined(USE_TILING)\nvarying vec2 vUv;\n#endif\n#ifdef USE_LOGDEPTHBUF\n#ifdef USE_LOGDEPTHBUF_EXT\nvarying float vFragDepth;\n#endif\nuniform float logDepthBufFC;\n#endif\n#ifdef MRT_NORMALS\nvarying float depth;\n#endif\n#include<pack_normals>\n#include<instancing_decl_vert>\n#include<id_decl_vert>\n#include<shadowmap_decl_vert>\n#if !defined(USE_MAP) && (MAX_DIR_LIGHTS > 0 || MAX_POINT_LIGHTS > 0 || MAX_SPOT_LIGHTS > 0) || defined( PRISMWOODBUMP )\nvarying vec3 vTangent;\nvarying vec3 vBitangent;\nvoid ComputeTangents(vec3 normal, out vec3 u, out vec3 v)\n{\n    float scale = normal.z < 0.0 ? -1.0 : 1.0;\n    vec3 temp = scale * normal;\n    float e    = temp.z;\n    float h    = 1.0/(1.0 + e);\n    float hvx  = h   *  temp.y;\n    float hvxy = hvx * -temp.x;\n    u = vec3(e + hvx * temp.y, hvxy,                -temp.x);\n    v = vec3(hvxy,             e + h * temp.x * temp.x, -temp.y);\n    u *= scale;\n    v *= scale;\n}\n#endif\nvoid main() {\n#if defined(USE_MAP) || defined(USE_TILING)\n    vUv = uv;\n#endif\n#ifdef UNPACK_NORMALS\n    vec3 objectNormal = decodeNormal(normal);\n#else\n    vec3 objectNormal = normal;\n#endif\n#ifdef FLIP_SIDED\n    objectNormal = -objectNormal;\n#endif\n    objectNormal = getInstanceNormal(objectNormal);\n    vec3 instPos = getInstancePos(position);\n#if defined(PRISMWOOD) && !defined(NO_UVW)\n#if defined(PRISMWOODBUMP)\n    vUvw = instPos;\n    vtNormal = normalize(objectNormal);\n    mNormalMatrix = normalMatrix;\n#else\n    vUvw = uvw;\n#endif\n#endif\n    vec3 transformedNormal = normalMatrix * objectNormal;\n    vNormal = normalize( transformedNormal );\n    vec4 mvPosition = modelViewMatrix * vec4( instPos, 1.0 );\n    gl_Position = projectionMatrix * mvPosition;\n    vViewPosition = -mvPosition.xyz;\n#if MAX_SPOT_LIGHTS > 0 || NUM_CUTPLANES > 0\n    vec4 worldPosition = modelMatrix * vec4( instPos, 1.0 );\n    vWorldPosition = worldPosition.xyz;\n#endif\n#if !defined(USE_MAP) && (MAX_DIR_LIGHTS > 0 || MAX_POINT_LIGHTS > 0 || MAX_SPOT_LIGHTS > 0) || defined ( PRISMWOODBUMP )\n    vec3 Tu, Tv;\n#if defined(PRISMWOODBUMP)\n    ComputeTangents(vtNormal, Tu, Tv);\n#else\n    ComputeTangents(vNormal, Tu, Tv);\n#endif\n    vTangent = Tu;\n    vBitangent = Tv;\n#endif\n#ifdef USE_LOGDEPTHBUF\n    if (projectionMatrix[3][3] == 0.0) {\n        gl_Position.z = log2(max(1.0e-6, gl_Position.w + 1.0)) * logDepthBufFC;\n#ifdef USE_LOGDEPTHBUF_EXT\n        vFragDepth = 1.0 + gl_Position.w;\n#else\n        gl_Position.z = (gl_Position.z - 1.0) * gl_Position.w;\n#endif\n    } else {\n#ifdef USE_LOGDEPTHBUF_EXT\n        vFragDepth = 1.0 + vViewPosition.z;\n#else\n#endif\n    }\n#endif\n#ifdef MRT_NORMALS\n    depth = mvPosition.z;\n#endif\n#include<id_vert>\n#include<shadowmap_vert>\n}\n",fragmentShader:"\n#include<common>\n#define RECIPROCAL_PI 0.318309886\n#define ONE 0.00390625\nuniform float opacity;\nuniform vec3 surface_albedo;\nuniform float surface_roughness;\nuniform float surface_anisotropy;\nuniform float surface_rotation;\nuniform sampler2D importantSamplingRandomMap;\nuniform sampler2D importantSamplingSolidAngleMap;\n#if defined( PRISMOPAQUE )\nuniform vec3 opaque_albedo;\nuniform float opaque_f0;\nuniform vec3 opaque_luminance_modifier;\nuniform float opaque_luminance;\n#elif defined( PRISMMETAL )\nuniform vec3 metal_f0;\n#elif defined( PRISMLAYERED )\nuniform float layered_f0;\nuniform vec3 layered_diffuse;\nuniform float layered_fraction;\nuniform vec3 layered_bottom_f0;\nuniform float layered_roughness;\nuniform float layered_anisotropy;\nuniform float layered_rotation;\n#elif defined( PRISMTRANSPARENT )\nuniform float transparent_ior;\nuniform vec3 transparent_color;\nuniform float transparent_distance;\n#elif defined( PRISMGLAZING )\nuniform vec3 glazing_f0;\nuniform vec3 glazing_transmission_color;\nuniform float glazing_transmission_roughness;\n#elif defined( PRISMWOOD )\nuniform bool wood_fiber_cosine_enable;\nuniform int wood_fiber_cosine_bands;\nuniform vec4 wood_fiber_cosine_weights;\nuniform vec4 wood_fiber_cosine_frequencies;\nuniform bool wood_fiber_perlin_enable;\nuniform int wood_fiber_perlin_bands;\nuniform vec4 wood_fiber_perlin_weights;\nuniform vec4 wood_fiber_perlin_frequencies;\nuniform float wood_fiber_perlin_scale_z;\nuniform bool wood_growth_perlin_enable;\nuniform int wood_growth_perlin_bands;\nuniform vec4 wood_growth_perlin_weights;\nuniform vec4 wood_growth_perlin_frequencies;\nuniform float wood_latewood_ratio;\nuniform float wood_earlywood_sharpness;\nuniform float wood_latewood_sharpness;\nuniform float wood_ring_thickness;\nuniform bool wood_earlycolor_perlin_enable;\nuniform int wood_earlycolor_perlin_bands;\nuniform vec4 wood_earlycolor_perlin_weights;\nuniform vec4 wood_earlycolor_perlin_frequencies;\nuniform vec3 wood_early_color;\nuniform bool wood_use_manual_late_color;\nuniform vec3 wood_manual_late_color;\nuniform bool wood_latecolor_perlin_enable;\nuniform int wood_latecolor_perlin_bands;\nuniform vec4 wood_latecolor_perlin_weights;\nuniform vec4 wood_latecolor_perlin_frequencies;\nuniform float wood_late_color_power;\nuniform bool wood_diffuse_perlin_enable;\nuniform int wood_diffuse_perlin_bands;\nuniform vec4 wood_diffuse_perlin_weights;\nuniform vec4 wood_diffuse_perlin_frequencies;\nuniform float wood_diffuse_perlin_scale_z;\nuniform bool wood_use_pores;\nuniform int wood_pore_type;\nuniform float wood_pore_radius;\nuniform float wood_pore_cell_dim;\nuniform float wood_pore_color_power;\nuniform float wood_pore_depth;\nuniform bool wood_use_rays;\nuniform float wood_ray_color_power;\nuniform float wood_ray_seg_length_z;\nuniform float wood_ray_num_slices;\nuniform float wood_ray_ellipse_z2x;\nuniform float wood_ray_ellipse_radius_x;\nuniform bool wood_use_latewood_bump;\nuniform float wood_latewood_bump_depth;\nuniform bool wood_use_groove_roughness;\nuniform float wood_groove_roughness;\nuniform float wood_diffuse_lobe_weight;\nuniform sampler2D permutationMap;\nuniform sampler2D gradientMap;\nuniform sampler2D perm2DMap;\nuniform sampler2D permGradMap;\nuniform vec4 wood_ring_fraction;\nuniform vec2 wood_fall_rise;\n#endif\n#ifdef USE_TILING\nuniform mat4 tilingOverallTransform;\nuniform sampler2D TilingMap;\nuniform mat3 TilingMap_texMatrix;\nuniform vec4 uv2tile;\nuniform vec4 tile2uv;\nuniform vec2 tileAlignOffset;\nuniform mat4 tilingUVTransform;\n#ifdef USE_TILING_NORMAL\nuniform sampler2D TilingNormalMap;\nuniform mat3 TilingNormalMap_texMatrix;\n#endif\n#ifdef USE_TILING_RANDOM\nuniform sampler2D TilingRandomMap;\nuniform mat3 TilingRandomMap_texMatrix;\nuniform vec2 tilingRandomAxisS;\nuniform vec2 tilingRandomAxisT;\nuniform vec2 tilingRandomAlignmentOffset;\n#endif\n#endif\nuniform float envExponentMin;\nuniform float envExponentMax;\nuniform float envExponentCount;\n#include<env_sample>\n#if TONEMAP_OUTPUT > 0\nuniform float exposureBias;\n#include<tonemap>\n#endif\n#if MAX_SPOT_LIGHTS > 0 || NUM_CUTPLANES > 0\nvarying vec3 vWorldPosition;\n#endif\n#ifdef USE_LOGDEPTHBUF\nuniform float logDepthBufFC;\n#ifdef USE_LOGDEPTHBUF_EXT\n#extension GL_EXT_frag_depth : enable\nvarying highp float vFragDepth;\n#endif\n#endif\n#include<id_decl_frag>\n#include<theming_decl_frag>\n#include<shadowmap_decl_frag>\n#ifdef USE_FOG\nuniform vec3 fogColor;\nuniform float fogNear;\nuniform float fogFar;\n#endif\n#prism_check<USE_MAP>\n#if defined(USE_MAP) || defined(USE_TILING)\nvarying vec2 vUv;\n#endif\n#if defined(PRISMWOOD) && !defined(NO_UVW)\nvarying vec3 vUvw;\n#endif\n#prism_uniforms<surface_albedo_map>\n#prism_uniforms<surface_roughness_map>\n#prism_uniforms<surface_cutout_map>\n#prism_uniforms<surface_anisotropy_map>\n#prism_uniforms<surface_rotation_map>\n#prism_uniforms<opaque_albedo_map>\n#prism_uniforms<opaque_f0_map>\n#prism_uniforms<opaque_luminance_modifier_map>\n#prism_uniforms<layered_bottom_f0_map>\n#prism_uniforms<layered_f0_map>\n#prism_uniforms<layered_diffuse_map>\n#prism_uniforms<layered_fraction_map>\n#prism_uniforms<layered_roughness_map>\n#prism_uniforms<layered_anisotropy_map>\n#prism_uniforms<layered_rotation_map>\n#prism_uniforms<metal_f0_map>\n#prism_uniforms<glazing_f0_map>\n#prism_uniforms<glazing_transmission_roughness_map>\n#prism_uniforms<glazing_transmission_color_map>\n#prism_uniforms<wood_curly_distortion_map>\n#if defined( USE_WOOD_CURLY_DISTORTION_MAP )\nuniform bool wood_curly_distortion_enable;\nuniform float wood_curly_distortion_scale;\n#endif\n#prism_bump_uniforms<surface_normal_map>\n#prism_bump_uniforms<layered_normal_map>\nfloat SRGBToLinearComponent(float color) {\n    float result = color;\n    if (result<=0.04045)\n        result *= 0.07739938;\n    else\n        result = pow(abs((result+0.055)*0.947867298), 2.4);\n    return result;\n}\nvec3 SRGBToLinear(vec3 color) {\n    vec3 result = color;\n    result.x = SRGBToLinearComponent(result.x);\n    result.y = SRGBToLinearComponent(result.y);\n    result.z = SRGBToLinearComponent(result.z);\n    return result;\n}\n#if defined( USE_ENVMAP )\nuniform float envMapExposure;\nuniform samplerCube envMap;\n#endif\n#include<normal_map>\n#if !defined(USE_MAP) && (MAX_DIR_LIGHTS > 0 || MAX_POINT_LIGHTS > 0 || MAX_SPOT_LIGHTS > 0) || defined ( PRISMWOODBUMP )\nvarying vec3 vTangent;\nvarying vec3 vBitangent;\n#if defined( PRISMWOODBUMP )\nvarying vec3 vtNormal;\nvarying mat3 mNormalMatrix;\n#endif\n#endif\n#if defined( USE_ENVMAP )\nvec3 sampleReflection(vec3 N, vec3 V, float mipIndex) {\n    vec3 dir = (2.0 * dot(V, N)) * N - V;\n    dir = adjustLookupVector(mat3(viewMatrixInverse) * dir);\n#ifdef ENV_GAMMA\n#ifdef HAVE_TEXTURE_LOD\n    vec4 envTexColor = textureCubeLodEXT( envMap, dir, mipIndex );\n#else\n    vec4 envTexColor = textureCube( envMap, dir, mipIndex );\n#endif\n    return GammaDecode(envTexColor, envMapExposure);\n#elif defined(ENV_RGBM)\n#ifdef HAVE_TEXTURE_LOD\n    vec4 envTexColor = textureCubeLodEXT( envMap, dir, mipIndex );\n#else\n    vec4 envTexColor = textureCube( envMap, dir, mipIndex );\n#endif\n    return RGBMDecode(envTexColor, envMapExposure);\n#else\n    vec4 envTexColor = textureCube( envMap, dir );\n    vec3 cubeColor = envTexColor.xyz;\n#ifdef GAMMA_INPUT\n    cubeColor *= cubeColor;\n#endif\n    return cubeColor;\n#endif\n}\n#endif\n#include<hatch_pattern>\n#if defined( USE_ENVMAP ) && defined( USE_IRRADIANCEMAP )\nuniform samplerCube irradianceMap;\nvec3 sampleNormal(vec3 normal) {\n    vec3 worldNormal = mat3(viewMatrixInverse) * normal;\n    vec3 irradiance = sampleIrradianceMap(worldNormal, irradianceMap, envMapExposure);\n    irradiance = applyEnvShadow(irradiance, worldNormal);\n    return irradiance;\n}\n#endif\n#if MAX_DIR_LIGHTS > 0\nuniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];\nuniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];\n#endif\n#if MAX_POINT_LIGHTS > 0\nuniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];\nuniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];\nuniform float pointLightDistance[ MAX_POINT_LIGHTS ];\n#endif\n#if MAX_SPOT_LIGHTS > 0\nuniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];\nuniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];\nuniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];\nuniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];\nuniform float spotLightExponent[ MAX_SPOT_LIGHTS ];\nuniform float spotLightDistance[ MAX_SPOT_LIGHTS ];\n#endif\nfloat sqr(float x) {return x*x;}\nfloat aSqrd(float maxAlphaSqr, float cosTheta)\n{\n    if (abs(cosTheta) < 1e-10)\n    {\n        return 1e10;\n    }\n    float tan2 = 1.0/sqr(cosTheta) - 1.0;\n    return maxAlphaSqr * tan2;\n}\nvec3 Fresnel_Schlick(vec3 f0, float cosAngle)\n{\n    float x = 1.0 - cosAngle;\n    float x2 = x * x;\n    float x5 = x * x2 * x2;\n    return f0 + (1.0 - f0) * x5;\n}\nvec3 Fresnel_Rough(vec3 f0, float cosAngle, float alpha)\n{\n    float x = 1.0 - cosAngle;\n    float x2 = x * x;\n    float x5 = x * x2 * x2;\n    vec3 maxReflectance = mix(vec3(1.0), f0, vec3(min(0.7, alpha)) / 0.7);\n    return f0 + (maxReflectance - f0) * x5;\n}\nfloat IORToReflectance(float ior)\n{\n    return sqr((1.0 - ior)/(1.0 + ior));\n}\nvec2 RoughnessToAlpha(float roughness, float anisotropy)\n{\n    vec2 alpha = roughness * vec2(1.0, 1.0 - anisotropy);\n    alpha = alpha * alpha;\n    alpha = clamp(alpha, 0.001, 1.0);\n    return alpha;\n}\nfloat AlphaToPhong(float alpha)\n{\n    return max(0.0, 2.56/alpha - 7.0);\n}\nfloat ExponentToReflMipIndex(float exponent)\n{\n    float targetLog = log2(exponent);\n    float minLog = log2(envExponentMin);\n    float maxLog = log2(envExponentMax);\n    float deltaLog = clamp(targetLog - minLog, 0.0, maxLog - minLog);\n    float level = clamp((1.0-(deltaLog + 0.5) / envExponentCount), 0.0, 1.0) * 6.0;\n    return level;\n}\n#include<prism_wood>\n#if defined( ENABLEIMPORTANTSAMPLING ) && (defined( USE_SURFACE_ROTATION_MAP ) || defined( USE_SURFACE_ANISOTROPY_MAP ) || defined( USE_LAYERED_ROTATION_MAP ) || defined( USE_LAYERED_ANISOTROPY_MAP ))\n#define IMPORTANTSAMPLING\n#endif\n#if defined( IMPORTANTSAMPLING )\n#define SAMPLECOUNT 32\nvec2 Hammersley(int index)\n{\n    float u = (float(index) + 0.5) / 32.0;\n    float v = 0.5;\n    float noise = texture2D(importantSamplingRandomMap, vec2(u, v), 0.0).r;\n   return vec2(2.0 * PI * float(index/SAMPLECOUNT), noise);\n}\nvec3 ImportanceSampleAnisotropicGGX(int index, vec2 alpha, vec3 N, vec3 Tu, vec3 Tv)\n{\n    vec2 uniformSample2D = Hammersley(index);\n    float coef = sqrt(uniformSample2D.y / (1.0 - uniformSample2D.y));\n    float sinSigma, cosSigma;\n    sinSigma = sin(uniformSample2D.x);\n    cosSigma = cos(uniformSample2D.x);\n    vec3 H = coef * ((alpha.x * cosSigma) * Tu + (alpha.y * sinSigma) * Tv) + N;\n    H = normalize(H);\n    return H;\n}\nfloat ComputePDF(vec2 alpha, float NdotH, float HdotTu, float HdotTv, float VdotH)\n{\n    float factor1 = HdotTu / alpha.x;\n    float factor2 = HdotTv / alpha.y;\n    float factor3 = factor1 * factor1 + factor2 * factor2 + NdotH * NdotH;\n    float factor = factor3 * factor3 * alpha.x * alpha.y * VdotH * 4.0 * PI;\n    if (factor > 0.0)\n    {\n        return (NdotH / factor);\n    }\n    else\n    {\n        return 0.0;\n    }\n}\n#define INVFACESIZE 0.0078125\nfloat DirectionToSolidAngle(vec3 dir)\n{\n    dir = abs(dir);\n    float first = min(dir.x, dir.y);\n    float temp = max(dir.x, dir.y);\n    float second = min(temp, dir.z);\n    float third = max(temp, dir.z);\n    first /= third;\n    second /= third;\n    float u = (first+1.0)/2.0;\n    float v = (second + 1.0) / 2.0;\n    float solidAngle = texture2D(importantSamplingSolidAngleMap, vec2(u, v), 0.0).r * 0.000255;\n    return solidAngle;\n}\nfloat Smith_GGX(float value)\n{\n    return 2.0 / (1.0 + sqrt(1.0 + value));\n}\nvec2 RoughnessAnisotropyToAlpha(float roughness, float anisotropy)\n{\n    float aspect = sqrt(1.0 - 0.9 * anisotropy);\n    vec2 alpha = vec2(roughness * roughness / aspect, roughness * roughness * aspect);\n    return alpha;\n}\nvec3 ImportanceSamplingSpecular(float angle, vec3 reflectance, float roughness, float anisotropy, vec3 V, vec3 N, vec3 Tu, vec3 Tv)\n{\n    vec3 specular = vec3(0.0);\n    float radAngle;\n    if (anisotropy < 1e-10)\n    {\n        radAngle = 0.0;\n    }\n    else\n    {\n        radAngle = -PI * angle;\n    }\n    vec2 alpha = RoughnessAnisotropyToAlpha(roughness, anisotropy);\n    float alpha2 = max(alpha.x * alpha.x, alpha.y * alpha.y);\n    float NdotV = dot(N, V);\n    float alpha2NV = aSqrd(alpha2, NdotV);\n    vec2 sincosTheta;\n    sincosTheta.x = sin(radAngle);\n    sincosTheta.y = cos(radAngle);\n    vec3 Tu1, Tv1;\n    Tu1 = sincosTheta.y * Tu - sincosTheta.x * Tv;\n    Tv1 = sincosTheta.x * Tu + sincosTheta.y * Tv;\n    vec3 H;\n    vec3 sampleLightIntensity;\n    vec3 L;\n    float effectiveSample = 0.0;\n    for (int i = 0; i < SAMPLECOUNT; i++)\n    {\n        H = ImportanceSampleAnisotropicGGX(i, alpha, N, Tu1, Tv1);\n        float VdotH = dot(V, H);\n        L = 2.0 * VdotH * H - V;\n        float NdotH = dot(N, H);\n        float NdotL = dot(N, L);\n        if (NdotL >= 0.0 && NdotV > 0.0 && NdotH > 0.0)\n        {\n            float alpha2NL = aSqrd(alpha2, NdotL);\n            float HdotTu = dot(H, Tu1);\n            float HdotTv = dot(H, Tv1);\n            float pdf = ComputePDF(alpha, NdotH, HdotTu, HdotTv, VdotH);\n            float mipmapLevel = 0.0;\n            if (pdf > 0.0)\n            {\n                mipmapLevel = 0.3 * log2(1.0 / (float(SAMPLECOUNT) * pdf * DirectionToSolidAngle(L)));\n            }\n            mipmapLevel = clamp(mipmapLevel, 0.0, 4.0);\n            L = normalize(L);\n            sampleLightIntensity = sampleReflection(L, L, mipmapLevel).rgb;\n            float G = Smith_GGX(alpha2NL) * Smith_GGX(alpha2NV);\n            vec3 F = Fresnel_Schlick(reflectance, VdotH);\n            float factor = G * VdotH / (NdotH * NdotV);\n            if (factor >= 0.0)\n            {\n                specular += abs(sampleLightIntensity * F * factor);\n                effectiveSample += 1.0;\n            }\n        }\n    }\n    if (effectiveSample > 0.0)\n    {\n        specular /= effectiveSample;\n    }\n    return specular;\n}\n#endif\n#if MAX_DIR_LIGHTS > 0 || MAX_POINT_LIGHTS > 0 || MAX_SPOT_LIGHTS > 0\nvec3 DiffuseLobe(vec3 diffuseColor)\n{\n    return diffuseColor * RECIPROCAL_PI;\n}\nvec3 Rotate(vec3 vec, float angle)\n{\n    float s = sin(angle);\n    float c = cos(angle);\n    return vec3(vec.x * c - vec.y * s, vec.x * s + vec.y * c, vec.z);\n}\nfloat NDF_GGX(float alphaU, float alphaV, vec3 normal)\n{\n    float nx2 = sqr(normal.x);\n    float ny2 = sqr(normal.y);\n    float nz2 = sqr(normal.z);\n    float scale = 1.0/(alphaU * alphaV * PI);\n    return scale/sqr(nx2/sqr(alphaU) + ny2/sqr(alphaV) + nz2);\n}\nfloat G1_GGX(float aSqrd)\n{\n    return 2.0 / (1.0 + sqrt(1.0 + aSqrd));\n}\nvec3 MicrofacetLobe(\n        vec3 Hlocal, float NdotL, float NdotH, float NdotV, float VdotH,\n        float roughness, float anisotropy, float rotation, vec3 reflectance)\n{\n    vec2 alpha = RoughnessToAlpha(roughness, anisotropy);\n    Hlocal = Rotate(Hlocal, rotation);\n    vec3 F = Fresnel_Schlick(reflectance, VdotH);\n    float D = NDF_GGX(alpha.x, alpha.y, Hlocal);\n    float alpha2 = max(sqr(alpha.x), sqr(alpha.y));\n    float alpha2NL = aSqrd(alpha2, NdotL);\n    float alpha2NV = aSqrd(alpha2, NdotV);\n    float G = G1_GGX(alpha2NL) * G1_GGX(alpha2NV);\n    return max(F * D * G / (4.0 * NdotL * NdotV), vec3(0.0));\n}\n#if defined( PRISMOPAQUE )\nvec3 BRDF_Opaque(vec3 Hlocal, float NdotL, float NdotH, float NdotV, float VdotH,\n        vec3 surfaceAlbedo, float surfaceRoughness, float surfaceAnisotropy, float surfaceRotation,\n        float opaqueF0, vec3 opaqueAlbedo)\n{\n    vec3 diffuse = DiffuseLobe(opaqueAlbedo);\n    vec3 specular = surfaceAlbedo * MicrofacetLobe(\n            Hlocal, NdotL, NdotH, NdotV, VdotH,\n            surfaceRoughness, surfaceAnisotropy, surfaceRotation, vec3(opaqueF0));\n    return (specular+diffuse)*NdotL;\n}\n#elif defined( PRISMMETAL )\nvec3 BRDF_Metal(vec3 Hlocal, float NdotL, float NdotH, float NdotV, float VdotH,\n        vec3 surfaceAlbedo, float surfaceRoughness, float surfaceAnisotropy, float surfaceRotation,\n        vec3 metalF0)\n{\n    vec3 specular = surfaceAlbedo * MicrofacetLobe(\n            Hlocal, NdotL, NdotH, NdotV, VdotH,\n            surfaceRoughness, surfaceAnisotropy, surfaceRotation, metalF0);\n    return specular*NdotL;\n}\n#elif defined( PRISMLAYERED )\nvec3 BRDF_Layered(vec3 Hlocal, float NdotL, float NdotH, float NdotV, float VdotH,\n        vec3 Hlocal2, float N2dotL, float N2dotH, float N2dotV,\n        vec3 surfaceAlbedo, float surfaceRoughness, float surfaceAnisotropy, float surfaceRotation,\n        float layeredF0, vec3 layeredDiffuse, float layeredRoughness, float layeredAnisotropy,\n        float layeredRotation, vec3 bottom_f0, float layeredFraction)\n{\n    vec3 Fl = Fresnel_Schlick(vec3(layeredF0), NdotL);\n    vec3 Fv = Fresnel_Schlick(vec3(layeredF0), NdotV);\n    vec3 amount = (1.0 - Fl) * (1.0 - Fv);\n    vec3 topSpecular = surfaceAlbedo * MicrofacetLobe(\n            Hlocal, NdotL, NdotH, NdotV, VdotH,\n            surfaceRoughness, surfaceAnisotropy, surfaceRotation,\n            vec3(layeredF0));\n    vec3 topDiffuse = DiffuseLobe(layeredDiffuse);\n    vec3 botSpecular = MicrofacetLobe(\n            Hlocal2, N2dotL, N2dotH, N2dotV, VdotH,\n            layeredRoughness, layeredAnisotropy, layeredRotation,\n            bottom_f0);\n    return topSpecular*NdotL + amount * mix(topDiffuse*NdotL, botSpecular*N2dotL, layeredFraction);\n}\n#elif defined( PRISMTRANSPARENT )\nvec3 BRDF_Transparent(vec3 Hlocal, float NdotL, float NdotH, float NdotV, float VdotH,\n        vec3 surfaceAlbedo, float surfaceRoughness, float surfaceAnisotropy, float surfaceRotation)\n{\n    vec3 reflectance = vec3(IORToReflectance(transparent_ior));\n    vec3 specular = surfaceAlbedo * MicrofacetLobe(\n            Hlocal, NdotL, NdotH, NdotV, VdotH,\n            surfaceRoughness, surfaceAnisotropy, surfaceRotation, reflectance);\n    return specular*NdotL;\n}\n#elif defined( PRISMGLAZING )\nvec3 BRDF_Glazing(vec3 Hlocal, float NdotL, float NdotH, float NdotV, float VdotH,\n        vec3 surfaceAlbedo, float surfaceRoughness, float surfaceAnisotropy, float surfaceRotation,\n        vec3 glazingF0, vec3 glazingTransmissionColor, float glazingIlluminance)\n{\n    vec3 diffuse = DiffuseLobe(glazingTransmissionColor - vec3(glazingIlluminance, glazingIlluminance, glazingIlluminance));\n    vec3 specular = surfaceAlbedo * MicrofacetLobe(\n            Hlocal, NdotL, NdotH, NdotV, VdotH,\n            surfaceRoughness, surfaceAnisotropy, surfaceRotation, glazingF0);\n    return (specular+diffuse)*NdotL;\n}\n#elif defined( PRISMWOOD )\nvec3 BRDF_Wood(vec3 Hlocal, float NdotL, float NdotH, float NdotV, float VdotH,\n        vec3 surfaceAlbedo, float surfaceRoughness, vec3 woodDiffuse)\n{\n    vec3 diffuse = DiffuseLobe(woodDiffuse);\n    vec3 specular = surfaceAlbedo * MicrofacetLobe(\n            Hlocal, NdotL, NdotH, NdotV, VdotH,\n            surfaceRoughness, 0.0, 0.0, vec3(0.04));\n    return (specular+diffuse)*NdotL;\n}\n#endif\n#endif\n#if defined( USE_ENVMAP )\n#if defined( PRISMOPAQUE )\nvec3 Environment_Opaque(vec3 N, vec3 V, float NdotV, vec3 surfaceAlbedo, float surfaceRoughness,\n        float opaqueF0, vec3 opaqueAlbedo, float surfaceAnisotropy, float surfaceRotation, vec3 Tu, vec3 T)\n{\n    float alpha = RoughnessToAlpha(surfaceRoughness, 0.0).x;\n    vec3 F = Fresnel_Rough(vec3(opaqueF0), NdotV, alpha);\n#if defined( IMPORTANTSAMPLING )\n    vec3 specular = surfaceAlbedo * ImportanceSamplingSpecular(surfaceRotation, vec3(opaqueF0), surfaceRoughness, surfaceAnisotropy, V, N, Tu, Tv);\n#else\n    float exponent = AlphaToPhong(alpha);\n    float reflMipIndex = ExponentToReflMipIndex(exponent);\n    vec3 envSpecular = sampleReflection(N, V, reflMipIndex);\n    vec3 specular = F* surfaceAlbedo * envSpecular;\n#endif\n#if defined( USE_IRRADIANCEMAP )\n    vec3 envIrradiance = sampleNormal(N);\n#else\n    vec3 envIrradiance = vec3(1.0);\n#endif\n    vec3 diffuse = (1.0 - F) * opaqueAlbedo * envIrradiance;\n    vec3 luminanceModifier;\n#prism_sample_texture<opaque_luminance_modifier, luminanceModifier, false, true>\n    vec3 emission = luminanceModifier * opaque_luminance;\n    return diffuse + specular + emission;\n}\n#elif defined( PRISMMETAL )\nvec3 Environment_Metal(vec3 N, vec3 V, float NdotV, vec3 surfaceAlbedo, float surfaceRoughness, vec3 metalF0, float surfaceAnisotropy, float surfaceRotation, vec3 Tu, vec3 Tv)\n{\n#if defined( IMPORTANTSAMPLING )\n    vec3 specular = surfaceAlbedo * ImportanceSamplingSpecular(surfaceRotation, metalF0, surfaceRoughness, surfaceAnisotropy, V, N, Tu, Tv);\n#else\n    float alpha = RoughnessToAlpha(surfaceRoughness, 0.0).x;\n    float exponent = AlphaToPhong(alpha);\n    float reflMipIndex = ExponentToReflMipIndex(exponent);\n    vec3 F = Fresnel_Rough(metalF0, NdotV, alpha);\n    vec3 envSpecular = sampleReflection(N, V, reflMipIndex);\n    vec3 specular = F * surfaceAlbedo * envSpecular;\n#endif\n    return specular;\n}\n#elif defined( PRISMLAYERED )\nvec3 Environment_Layered(vec3 N, vec3 V, float NdotV, vec3 N2, float N2dotV, vec3 surfaceAlbedo, float surfaceRoughness,\n        float layeredF0, float surfaceAnisotropy, float surfaceRotation, vec3 Tu, vec3 Tv, vec3 layeredDiffuse, float layeredRoughness,\n        float layeredAnisotropy, float layeredRotation, vec3 bottom_f0, float layeredFraction)\n{\n    vec3 F = Fresnel_Schlick(vec3(layeredF0), NdotV);\n    float alpha = RoughnessToAlpha(surfaceRoughness, 0.0).x;\n#if defined( IMPORTANTSAMPLING )\n    vec3 topSpecular = surfaceAlbedo * ImportanceSamplingSpecular(surfaceRotation, vec3(layeredF0), surfaceRoughness, surfaceAnisotropy, V, N, Tu, Tv);\n#else\n    float exponent = AlphaToPhong(alpha);\n    float reflMipIndex = ExponentToReflMipIndex(exponent);\n    vec3 envSpecular = sampleReflection(N, V, reflMipIndex);\n    vec3 topSpecular = F * surfaceAlbedo * envSpecular;\n#endif\n    vec3 amount = (1.0 - F);\n#if defined( USE_IRRADIANCEMAP )\n    vec3 envIrradiance = sampleNormal(N);\n#else\n    vec3 envIrradiance = vec3(1.0);\n#endif\n    vec3 topDiffuse = layeredDiffuse * envIrradiance;\n#if defined( IMPORTANTSAMPLING )\n    vec3 botSpecular = ImportanceSamplingSpecular(layeredRotation, bottom_f0, layeredRoughness, layeredAnisotropy, V, N2, Tu, Tv);\n#else\n    alpha = RoughnessToAlpha(layeredRoughness, 0.0).x;\n    exponent = AlphaToPhong(alpha);\n    reflMipIndex = ExponentToReflMipIndex(exponent);\n    envSpecular = sampleReflection(N2, V, reflMipIndex);\n    F = Fresnel_Rough(bottom_f0, N2dotV, alpha);\n    vec3 botSpecular = F * envSpecular;\n#endif\n    return topSpecular + amount * mix(topDiffuse, botSpecular, layeredFraction);\n}\n#elif defined( PRISMTRANSPARENT )\nvec3 Environment_Transparent(vec3 N, vec3 V, float NdotV, vec3 surfaceAlbedo, float surfaceRoughness, float surfaceAnisotropy, float surfaceRotation, vec3 Tu, vec3 Tv)\n{\n    vec3 reflectance = vec3(IORToReflectance(transparent_ior));\n    float alpha = RoughnessToAlpha(surfaceRoughness, 0.0).x;\n    vec3 F = Fresnel_Rough(reflectance, NdotV, alpha);\n#if defined( IMPORTANTSAMPLING )\n    vec3 specular = surfaceAlbedo * ImportanceSamplingSpecular(surfaceRotation, reflectance, surfaceRoughness, surfaceAnisotropy, V, N, Tu, Tv);\n#else\n    float exponent = AlphaToPhong(alpha);\n    float reflMipIndex = ExponentToReflMipIndex(exponent);\n    vec3 envSpecular = sampleReflection(N, V, reflMipIndex);\n    vec3 specular = F * surfaceAlbedo * envSpecular;\n#endif\n#if defined( USE_IRRADIANCEMAP )\n    vec3 envIrradiance = sampleNormal(N);\n#else\n    vec3 envIrradiance = vec3(1.0);\n#endif\n    vec3 color = F * surfaceRoughness * transparent_color * envIrradiance;\n    return specular + color;\n}\n#elif defined( PRISMGLAZING )\nvec3 Environment_Glazing(vec3 N, vec3 V, float NdotV, vec3 surfaceAlbedo, float surfaceRoughness, float surfaceAnisotropy, float surfaceRotation, vec3 Tu, vec3 Tv,\n                         vec3 glazing_f0, vec3 transmissionF, float transmissionAlpha, vec3 glazingAdjustedColor, float glazingIlluminace)\n{\n    float surfaceAlpha = RoughnessToAlpha(surfaceRoughness, 0.0).x;\n    vec3 surfaceF = Fresnel_Rough(glazing_f0, NdotV, surfaceAlpha);\n#if defined( IMPORTANTSAMPLING )\n    vec3 specular = surfaceAlbedo * ImportanceSamplingSpecular(surfaceRotation, glazing_f0, surfaceRoughness, surfaceAnisotropy, V, N, Tu, Tv);\n#else\n    float exponent = AlphaToPhong(surfaceAlpha);\n    float reflMipIndex = ExponentToReflMipIndex(exponent);\n    vec3 envSpecular = sampleReflection(N, V, reflMipIndex);\n    vec3 specular = surfaceF * surfaceAlbedo * envSpecular;\n#endif\n#if defined( USE_IRRADIANCEMAP )\n    vec3 envIrradiance = sampleNormal(N);\n#else\n    vec3 envIrradiance = vec3(1.0);\n#endif\n    vec3 color = 0.5 * (1.0 - transmissionF) * (glazingAdjustedColor - vec3(glazingIlluminace, glazingIlluminace, glazingIlluminace)) * envIrradiance; \n    return specular + color;\n}\n#elif defined( PRISMWOOD )\nvec3 Environment_Wood(vec3 N, vec3 V, float NdotV, vec3 surfaceAlbedo, float surfaceRoughness, vec3 woodDiffuse, float surfaceAnisotropy, float surfaceRotation, vec3 Tu, vec3 Tv)\n{\n    float alpha = RoughnessToAlpha(surfaceRoughness, 0.0).x;\n    vec3 F = Fresnel_Rough(vec3(0.04), NdotV, alpha);\n#if defined( IMPORTANTSAMPLING )\n    vec3 specular = surfaceAlbedo * ImportanceSamplingSpecular(surfaceRotation, vec3(0.04), surfaceRoughness, surfaceAnisotropy, V, N, Tu, Tv);\n#else\n    float exponent = AlphaToPhong(alpha);\n    float reflMipIndex = ExponentToReflMipIndex(exponent);\n    vec3 envSpecular = sampleReflection(N, V, reflMipIndex);\n    vec3 specular = F * surfaceAlbedo * envSpecular;\n#endif\n#if defined( USE_IRRADIANCEMAP )\n    vec3 envIrradiance = sampleNormal(N);\n#else\n    vec3 envIrradiance = vec3(1.0);\n#endif\n    vec3 diffuse = (1.0 - F) * woodDiffuse * envIrradiance;\n    return diffuse + specular;\n}\n#endif\n#endif\n#if defined( PRISMTRANSPARENT )\n#include <prism_transparency>\n#elif defined( PRISMGLAZING )\n#include <prism_glazing>\n#endif\n#ifdef USE_TILING\nvec3 tilingTransform(vec2 uv, mat4 transform)\n{\n\treturn (transform * vec4(uv, 0.0, 1.0)).xyz;\n}\nvec4 tilingMapTest(sampler2D tilingSampler, mat3 transf, vec3 uv, vec4 uv2tile, vec4 tile2uv)\n{\n\tvec2 tileCoord = vec2(dot(uv2tile.xz, uv.xy), dot(uv2tile.yw, uv.xy));\n\tvec2 ijBase = floor(tileCoord);\n    vec2 fracC = fract(tileCoord);\n\tvec2 st = vec2(dot(tile2uv.xz, fracC), dot(tile2uv.yw, fracC));\n\tvec4 tileInfo = vec4(0.0, 0.0, 2.0, 2.0);\n\tvec2 iOffset = float(TILE_RANGE_X_MIN) * tile2uv.xy;\n\tvec2 jBaseOffset = float(TILE_RANGE_Y_MIN) * tile2uv.zw;\n\tfor( int i = TILE_RANGE_X_MIN; i <= TILE_RANGE_X_MAX; i++)\n\t{\n\t\tvec2 jOffset = jBaseOffset;\n\t\tfor( int j = TILE_RANGE_Y_MIN; j <= TILE_RANGE_Y_MAX; j++)\n\t\t{\n\t\t\tvec2 sampleUV = st + iOffset + jOffset;\n\t\t\tjOffset += tile2uv.zw;\n\t\t\tsampleUV = (transf * vec3(sampleUV, 1.0)).xy;\n\t\t\tvec4 tex = texture2D(tilingSampler, sampleUV);\n\t\t\tfloat d = max( min(tex.r, tex.g), min( max(tex.r, tex.g), tex.b));\n            if (d < tileInfo.z) {\n\t\t\t\ttileInfo.xy = vec2(float(i),float(j));\n\t\t\t\ttileInfo.w = tileInfo.z;\n\t\t\t\ttileInfo.z = d;\n\t\t\t} else {\n\t\t\t\ttileInfo.w = min(tileInfo.w, d);\n\t\t\t}\n\t\t}\n\t\tiOffset += tile2uv.xy;\n\t}\n\ttileInfo.zw = tileInfo.zw - 0.5;\n\tfloat w = clamp(tileInfo.z/max(fwidth(tileInfo.z), 0.000001) + 0.5, 0.0, 1.0);\n\tif ( w == 1.0 )\n\t\tdiscard;\n \tif (abs(tileInfo.w)<=abs(tileInfo.z))\n\t\tw = 0.0;\n\ttileInfo.w = 1.0 - w;\n\ttileInfo.xy -= ijBase;\n\treturn tileInfo;\n}\nvec2 tilingSubMaterialRelocate(vec3 uv, vec4 tileInfo, vec4 tile2uv)\n{\n\tvec2 offset = vec2(dot(tile2uv.xz, tileInfo.xy), dot(tile2uv.yw, tileInfo.xy));\n\treturn (uv.xy + offset);\n}\n#ifdef USE_TILING_RANDOM\nvec2 tilingRandom(vec2 uv, vec4 tileInfo, sampler2D randomSampler, mat3 transf, vec2 tileTextureAxisS, vec2 tileTextureAxisT, vec2 tile2TextureOffset)\n{\n    vec2 xti = (vec3(tileInfo.xy, 1.0) * transf).xy;\n    vec4 random = texture2D(randomSampler, xti);\n    vec2 randomOffset = vec2(tileTextureAxisS.x*random.z + tileTextureAxisT.x*random.w,\n        tileTextureAxisS.y*random.z + tileTextureAxisT.y*random.w) + tile2TextureOffset;\n    return uv + randomOffset;\n}\n#endif\nvoid tilingNormalOffset(\n    sampler2D bumpTexture,\n    vec2 uv,\n    mat3 transform,\n    inout vec3 T,\n    inout vec3 B,\n    inout vec3 N\n) {\n    vec2 st = (vec3(uv, 1.0) * transform).xy;\n    vec3 distort =  (2.0 * texture2D(bumpTexture, st).xyz - 1.0) - vec3(0.0,0.0,1.0);\n    mat3 mat = mat3(\n        T.x, B.x, N.x,\n        T.y, B.y, N.y,\n        T.z, B.z, N.z\n    );\n    N = normalize(N + (mat*distort));\n}\n#endif\nvarying vec3 vNormal;\nvarying vec3 vViewPosition;\n#include<cutplanes>\nvoid main() {\n#if NUM_CUTPLANES > 0\n    checkCutPlanes(vWorldPosition);\n#endif\n    vec3 N = normalize(vNormal);\n    vec3 Tu = vec3(0.0);\n    vec3 Tv = vec3(0.0);\n#if defined(USE_MAP) || defined(USE_TILING)\n    vec2 uv = vUv;\n#endif\n#ifdef USE_TILING\n    vec3 v_tilingOverallTransf = tilingTransform( vUv, tilingOverallTransform );\n    vec4 v_TilingMap = tilingMapTest( TilingMap, TilingMap_texMatrix, v_tilingOverallTransf, uv2tile, tile2uv );\n    uv = tilingSubMaterialRelocate( v_tilingOverallTransf, v_TilingMap, tile2uv ) + tileAlignOffset;\n#ifdef USE_TILING_NORMAL\n    vec2 uvNorm = uv;\n#endif\n#ifdef USE_TILING_RANDOM\n    uv = tilingRandom( uv, v_TilingMap, TilingRandomMap, TilingRandomMap_texMatrix, tilingRandomAxisS, tilingRandomAxisT, tilingRandomAlignmentOffset );\n#endif\n    uv = tilingTransform( uv, tilingUVTransform ).xy;\n#endif\n#if defined( USE_SURFACE_NORMAL_MAP ) || defined( USE_LAYERED_NORMAL_MAP ) || MAX_DIR_LIGHTS > 0 || MAX_POINT_LIGHTS > 0 || MAX_SPOT_LIGHTS > 0 || defined( PRISMWOODBUMP ) || defined( IMPORTANTSAMPLING )\n#if !defined(USE_MAP) || defined( PRISMWOODBUMP )\n    Tu = normalize(vTangent);\n    Tv = normalize(vBitangent);\n#else\n    vec3 q0 = dFdx( -vViewPosition );\n    vec3 q1 = dFdy( -vViewPosition );\n    vec2 st0 = dFdx( uv );\n    vec2 st1 = dFdy( uv );\n    Tu = normalize(  q0 * st1.t - q1 * st0.t );\n    Tv = normalize( -q0 * st1.s + q1 * st0.s );\n#endif\n#endif\n    vec3 V;\n    if (projectionMatrix[3][3] == 0.0) {\n        V = normalize( vViewPosition );\n    } else {\n        V = vec3(0.0, 0.0, 1.0);\n    }\n    N = faceforward(N, -V, N);\n#if defined(PRISMLAYERED)\n    vec3 N2 = N;\n#endif\n#ifndef FLAT_SHADED\n    vec3 normal = normalize( vNormal );\n#ifdef DOUBLE_SIDED\n    normal = normal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );\n#endif\n#else\n    vec3 fdx = dFdx( vViewPosition );\n    vec3 fdy = dFdy( vViewPosition );\n    vec3 normal = normalize( cross( fdx, fdy ) );\n#endif\n#if defined( USE_SURFACE_NORMAL_MAP )\n    if (surface_normal_map_bumpmapType == 0)\n        heightMapTransform(surface_normal_map, uv, surface_normal_map_texMatrix, surface_normal_map_bumpScale, Tu, Tv, N);\n    else\n        normalMapTransform(surface_normal_map, uv, surface_normal_map_texMatrix, surface_normal_map_bumpScale, Tu, Tv, N);\n#endif\n#if defined( USE_LAYERED_NORMAL_MAP )\n    if (layered_normal_map_bumpmapType == 0)\n        heightMapTransform(layered_normal_map, uv, layered_normal_map_texMatrix, layered_normal_map_bumpScale, Tu, Tv, N2);\n    else\n        normalMapTransform(layered_normal_map, uv, layered_normal_map_texMatrix, layered_normal_map_bumpScale, Tu, Tv, N2);\n#endif\n#ifdef USE_TILING_NORMAL\n    tilingNormalOffset(TilingNormalMap, uvNorm, TilingNormalMap_texMatrix, Tu, Tv, N);\n#endif\n#if defined( PRISMWOOD )\n#ifdef NO_UVW\n    vec3 p = vec3(0.0);\n#elif defined( USE_WOOD_CURLY_DISTORTION_MAP )\n    vec3 p = DistortCurly(vUvw);\n#else\n    vec3 p = vUvw;\n#endif\n#if !defined( NO_UVW ) && defined( PRISMWOODBUMP )\n    getFinalWoodContext(\n        N, V, Tu, Tv, p,\n        normal, vtNormal, vNormalMatrix\n    );\n#endif\n#endif\n    float NdotV = clamp(dot(N, V), EPSILON, 1.0);\n#if defined(PRISMLAYERED)\n    float N2dotV = clamp(dot(N2, V), EPSILON, 1.0);\n#endif\n    vec3 surfaceAlbedo;\n#prism_sample_texture<surface_albedo, surfaceAlbedo, false, true>\n    float surfaceRoughness;\n#prism_sample_texture<surface_roughness, surfaceRoughness, true, false>\n    float surfaceAnisotropy;\n#prism_sample_texture<surface_anisotropy, surfaceAnisotropy, true, false>\n    float surfaceRotation;\n#prism_sample_texture<surface_rotation, surfaceRotation, true, false>\n#if defined(PRISMOPAQUE)\n    float opaqueF0;\n#prism_sample_texture<opaque_f0, opaqueF0, true, false>\n    vec3 opaqueAlbedo;\n#prism_sample_texture<opaque_albedo, opaqueAlbedo, false, true>\n#elif defined(PRISMMETAL)\n    vec3 metalF0;\n#prism_sample_texture<metal_f0, metalF0, false, true>\n#elif defined(PRISMLAYERED)\n    float layeredF0;\n#prism_sample_texture<layered_f0, layeredF0, true, false>\n    vec3 layeredDiffuse;\n#prism_sample_texture<layered_diffuse, layeredDiffuse, false, true>\n    float layeredRoughness;\n#prism_sample_texture<layered_roughness, layeredRoughness, true, false>\n    float layeredAnisotropy;\n#prism_sample_texture<layered_anisotropy, layeredAnisotropy, true, false>\n    float layeredRotation;\n#prism_sample_texture<layered_rotation, layeredRotation, true, false>\n    vec3 bottom_f0;\n#prism_sample_texture<layered_bottom_f0, bottom_f0, false, true>\n    float layeredFraction;\n#prism_sample_texture<layered_fraction, layeredFraction, true, false>\n#elif defined( PRISMGLAZING )\n    vec3 glazingTransmissionColor;\n#prism_sample_texture<glazing_transmission_color, glazingTransmissionColor, false, true>\n    vec3 glazingF0;\n#prism_sample_texture<glazing_f0, glazingF0, false, true>\n    float glazingTransmissionRoughness;\n#prism_sample_texture<glazing_transmission_roughness, glazingTransmissionRoughness, true, false>\n    vec3 glazingAdjustedColor = TransmitAdjust(glazingTransmissionColor, glazingF0);\n    float glazingIlluminace = ColorToIlluminance(glazingAdjustedColor);\n    float transmissionAlpha = RoughnessToAlpha(glazingTransmissionRoughness, 0.0).x;\n    vec3 transmissionF = Fresnel_Rough(glazingF0, NdotV, transmissionAlpha);\n#elif defined(PRISMWOOD)\n    vec3 woodDiffuse = NoiseWood(p, surfaceRoughness);\n#endif\n    vec3 outRadianceLight = vec3(0.0);\n#if MAX_DIR_LIGHTS > 0 || MAX_POINT_LIGHTS > 0 || MAX_SPOT_LIGHTS > 0\n    vec3 lightDirection[ MAX_DIR_LIGHTS + MAX_POINT_LIGHTS + MAX_SPOT_LIGHTS ];\n    vec3 lightColor[ MAX_DIR_LIGHTS + MAX_POINT_LIGHTS + MAX_SPOT_LIGHTS ];\n#if MAX_DIR_LIGHTS > 0\n    for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {\n        vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );\n        lightDirection[i] = normalize( lDirection.xyz );\n        lightColor[i] = SRGBToLinear(directionalLightColor[ i ]);\n    }\n#endif\n#if MAX_POINT_LIGHTS > 0\n    for( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {\n        vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );\n        vec3 lVector = lPosition.xyz + vViewPosition.xyz;\n        lightDirection[MAX_DIR_LIGHTS + i] = normalize( lVector );\n        float lDistance = 1.0;\n        if ( pointLightDistance[ i ] > 0.0 )\n            lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );\n        lightColor[MAX_DIR_LIGHTS + i] = SRGBToLinear(pointLightColor[ i ]) * lDistance;\n    }\n#endif\n#if MAX_SPOT_LIGHTS > 0\n    for( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {\n        vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );\n        vec3 lVector = lPosition.xyz + vViewPosition.xyz;\n        lightDirection[MAX_DIR_LIGHTS + MAX_POINT_LIGHTS + i] = normalize( lVector );\n        float lDistance = 1.0;\n        if ( spotLightDistance[ i ] > 0.0 )\n            lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );\n        float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - vWorldPosition ) );\n        if ( spotEffect > spotLightAngleCos[ i ] )\n            spotEffect = max( pow( spotEffect, spotLightExponent[ i ] ), 0.0 );\n        lightColor[MAX_DIR_LIGHTS + MAX_POINT_LIGHTS + i] = SRGBToLinear(spotLightColor[ i ]) * lDistance * spotEffect;\n    }\n#endif\n    for( int i = 0; i < MAX_DIR_LIGHTS + MAX_POINT_LIGHTS + MAX_SPOT_LIGHTS; i ++ ) {\n        vec3 L = lightDirection[i];\n        float NdotL = max(EPSILON, dot(N, L));\n        vec3 H = normalize(L + V);\n        float NdotH = dot(N, H);\n        float VdotH = dot(V, H);\n        float Hu = dot(H, Tu);\n        float Hv = dot(H, Tv);\n        vec3 Hlocal = vec3(Hu, Hv, NdotH);\n#if defined(PRISMLAYERED)\n        float N2dotL = dot(N2, L);\n        float N2dotH = dot(N2, H);\n        vec3 Hlocal2 = vec3(Hu, Hv, N2dotH);\n#endif\n        vec3 brdf = lightColor[i] *\n#if defined(PRISMOPAQUE)\n            BRDF_Opaque(Hlocal, NdotL, NdotH, NdotV, VdotH,\n                    surfaceAlbedo, surfaceRoughness, surfaceAnisotropy, surfaceRotation,\n                    opaqueF0, opaqueAlbedo);\n#elif defined(PRISMMETAL)\n            BRDF_Metal(Hlocal, NdotL, NdotH, NdotV, VdotH,\n                surfaceAlbedo, surfaceRoughness, surfaceAnisotropy, surfaceRotation,\n                metalF0);\n#elif defined(PRISMLAYERED)\n            BRDF_Layered(Hlocal, NdotL, NdotH, NdotV, VdotH, Hlocal2, N2dotL, N2dotH, N2dotV,\n                surfaceAlbedo, surfaceRoughness, surfaceAnisotropy, surfaceRotation,\n                layeredF0, layeredDiffuse, layeredRoughness, layeredAnisotropy,\n                layeredRotation, bottom_f0, layeredFraction);\n#elif defined(PRISMTRANSPARENT)\n            BRDF_Transparent(Hlocal, NdotL, NdotH, NdotV, VdotH, surfaceAlbedo, surfaceRoughness, surfaceAnisotropy, surfaceRotation);\n#elif defined(PRISMGLAZING)\n            BRDF_Glazing(Hlocal, NdotL, NdotH, NdotV, VdotH, surfaceAlbedo, surfaceRoughness, surfaceAnisotropy, surfaceRotation,\n                         glazingF0, glazingTransmissionColor, glazingIlluminace);\n#elif defined(PRISMWOOD)\n            BRDF_Wood(Hlocal, NdotL, NdotH, NdotV, VdotH, surfaceAlbedo, surfaceRoughness, woodDiffuse);\n#endif\n        outRadianceLight += max(vec3(0.0), brdf);\n    }\n#endif\n    vec3 outRadianceEnv = vec3(0.0);\n#if defined( USE_ENVMAP )\n    outRadianceEnv =\n#if defined(PRISMOPAQUE)\n        Environment_Opaque(N, V, clamp(NdotV, 0.0, 1.0), surfaceAlbedo, surfaceRoughness,\n                opaqueF0, opaqueAlbedo, surfaceAnisotropy, surfaceRotation, Tu, Tv);\n#elif defined(PRISMMETAL)\n        Environment_Metal(N, V, clamp(NdotV, 0.0, 1.0), surfaceAlbedo, surfaceRoughness, metalF0, surfaceAnisotropy, surfaceRotation, Tu, Tv);\n#elif defined(PRISMLAYERED)\n        Environment_Layered(N, V, clamp(NdotV, 0.0, 1.0), N2, clamp(N2dotV, 0.0, 1.0), surfaceAlbedo, surfaceRoughness,\n            layeredF0, surfaceAnisotropy, surfaceRotation, Tu, Tv, layeredDiffuse, layeredRoughness, layeredAnisotropy,\n            layeredRotation, bottom_f0, layeredFraction);\n#elif defined(PRISMTRANSPARENT)\n        Environment_Transparent(N, V, clamp(NdotV, 0.0, 1.0), surfaceAlbedo, surfaceRoughness, surfaceAnisotropy, surfaceRotation, Tu, Tv);\n#elif defined(PRISMGLAZING)\n        Environment_Glazing(N, V, clamp(NdotV, 0.0, 1.0), surfaceAlbedo, surfaceRoughness, surfaceAnisotropy, surfaceRotation, Tu, Tv,\n            glazingF0, transmissionF, transmissionAlpha, glazingAdjustedColor, glazingIlluminace);\n#elif defined(PRISMWOOD)\n        Environment_Wood(N, V, clamp(NdotV, 0.0, 1.0), surfaceAlbedo, surfaceRoughness, woodDiffuse, surfaceAnisotropy, surfaceRotation, Tu, Tv);\n#endif\n#endif\n    float surface_cutout = 1.0;\n#prism_sample_texture<surface_cutout, surface_cutout, true, false>\n#if defined( USE_SURFACE_CUTOUT_MAP )\n    if(surface_cutout < 0.01) discard;\n#endif\n    gl_FragColor = vec4( outRadianceLight + outRadianceEnv, opacity*surface_cutout );\n#if TONEMAP_OUTPUT == 1\n    gl_FragColor.xyz = toneMapCanonOGS_WithGamma_WithColorPerserving(exposureBias * gl_FragColor.xyz);\n#elif TONEMAP_OUTPUT == 2\n    gl_FragColor.xyz = toneMapCanonFilmic_WithGamma(exposureBias * gl_FragColor.xyz);\n#endif\n#ifdef USE_FOG\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = smoothstep( fogNear, fogFar, depth );\n    gl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );\n#endif\n#if defined(PRISMTRANSPARENT)\n    applyPrismTransparency(gl_FragColor, transparent_color, transparent_ior);\n    gl_FragColor.a *= surface_cutout;\n#ifdef USE_TILING\n    gl_FragColor.a *= v_TilingMap.a;\n#endif\n#elif defined( PRISMGLAZING )\n    applyPrismGlazingOpacity(gl_FragColor, transmissionF, transmissionAlpha, NdotV, glazingIlluminace);\n#ifdef USE_TILING\n    gl_FragColor.a *= v_TilingMap.a;\n#endif\n#endif\n#include<theming_frag>\n#include<final_frag>\n}\n"};t.ShaderLib.prism=df;var cf=function(){var e=Gl.createShaderMaterial(df);return e.defaultAttributeValues.uvw=[0,0,0],e.enable3DWoodBump=!1,e.enableImportantSampling=!1,e.mapList={},e.isPrismMaterial=!0,e},pf=function(e){var n=cf();switch(n.name=e.name,n.side=e.side,n.opacity=e.opacity,n.transparent=e.transparent,n.blending=e.blending,n.blendSrc=e.blendSrc,n.blendDst=e.blendDst,n.blendEquation=e.blendEquation,n.blendSrcAlpha=e.blendSrcAlpha,n.blendDstAlpha=e.blendDstAlpha,n.blendEquationAlpha=e.blendEquationAlpha,n.depthTest=e.depthTest,n.depthWrite=e.depthWrite,n.polygonOffset=e.polygonOffset,n.polygonOffsetFactor=e.polygonOffsetFactor,n.polygonOffsetUnits=e.polygonOffsetUnits,n.alphaTest=e.alphaTest,n.overdraw=e.overdraw,n.visible=e.visible,n.mapList=e.mapList,n.prismType=e.prismType,n.surface_albedo=e.surface_albedo,void 0!==e.surface_albedo_map&&(n.surface_albedo_map=e.surface_albedo_map),n.surface_roughness=e.surface_roughness,void 0!==e.surface_roughness_map&&(n.surface_roughness_map=e.surface_roughness_map),n.surface_anisotropy=e.surface_anisotropy,void 0!==e.surface_anisotropy_map&&(n.surface_anisotropy_map=e.surface_anisotropy_map),n.surface_rotation=e.surface_rotation,void 0!==e.surface_rotation_map&&(n.surface_rotation_map=e.surface_rotation_map),void 0!==e.surface_cutout_map&&(n.surface_cutout_map=e.surface_cutout_map),void 0!==e.surface_normal_map&&(n.surface_normal_map=e.surface_normal_map),n.uniforms.importantSamplingRandomMap.value=e.uniforms.importantSamplingRandomMap.value,n.uniforms.importantSamplingSolidAngleMap.value=e.uniforms.importantSamplingSolidAngleMap.value,n.prismType){case"PrismOpaque":n.opaque_albedo=(new t.Color).copy(e.opaque_albedo),n.opaque_luminance_modifier=(new t.Color).copy(e.opaque_luminance_modifier),n.opaque_f0=e.opaque_f0,n.opaque_luminance=e.opaque_luminance,void 0!==e.opaque_albedo_map&&(n.opaque_albedo_map=e.opaque_albedo_map),void 0!==e.opaque_luminance_modifier_map&&(n.opaque_luminance_modifier_map=e.opaque_luminance_modifier_map),void 0!==e.opaque_f0_map&&(n.opaque_f0_map=e.opaque_f0_map);break;case"PrismMetal":n.metal_f0=(new t.Color).copy(e.metal_f0),void 0!==e.metal_f0_map&&(n.metal_f0_map=e.metal_f0_map);break;case"PrismLayered":n.layered_f0=e.layered_f0,n.layered_diffuse=(new t.Color).copy(e.layered_diffuse),n.layered_fraction=e.layered_fraction,n.layered_bottom_f0=(new t.Color).copy(e.layered_bottom_f0),n.layered_roughness=e.layered_roughness,n.layered_anisotropy=e.layered_anisotropy,n.layered_rotation=e.layered_rotation,void 0!==e.layered_bottom_f0_map&&(n.layered_bottom_f0_map=e.layered_bottom_f0_map),void 0!==e.layered_f0_map&&(n.layered_f0_map=e.layered_f0_map),void 0!==e.layered_diffuse_map&&(n.layered_diffuse_map=e.layered_diffuse_map),void 0!==e.layered_fraction_map&&(n.layered_fraction_map=e.layered_fraction_map),void 0!==e.layered_rotationlayered_roughness_map&&(n.layered_rotationlayered_roughness_map=e.layered_rotationlayered_roughness_map),void 0!==e.layered_anisotropy_map&&(n.layered_anisotropy_map=e.layered_anisotropy_map),void 0!==e.layered_rotation_map&&(n.layered_rotation_map=e.layered_rotation_map),void 0!==e.layered_normal_map&&(n.layered_normal_map=e.layered_normal_map);break;case"PrismTransparent":n.transparent_color=(new t.Color).copy(e.transparent_color),n.transparent_distance=e.transparent_distance,n.transparent_ior=e.transparent_ior,n.transparent=e.transparent,n.twoPassTransparency=e.twoPassTransparency;break;case"PrismGlazing":n.glazing_f0=(new t.Color).copy(e.glazing_f0),n.glazing_transmission_color=(new t.Color).copy(e.glazing_transmission_color),n.glazing_transmission_roughness=e.glazing_transmission_roughness,void 0!==e.glazing_f0_map&&(n.glazing_f0_map=e.glazing_f0_map),void 0!==e.glazing_transmission_color_map&&(n.glazing_transmission_color_map=e.glazing_transmission_color_map),void 0!==e.glazing_transmission_roughness_map&&(n.glazing_transmission_roughness_map=e.glazing_transmission_roughness_map);break;case"PrismWood":n.wood_fiber_cosine_enable=e.wood_fiber_cosine_enable,n.wood_fiber_cosine_bands=e.wood_fiber_cosine_bands,n.wood_fiber_cosine_weights=(new t.Vector4).copy(e.wood_fiber_cosine_weights),n.wood_fiber_cosine_frequencies=(new t.Vector4).copy(e.wood_fiber_cosine_frequencies),n.wood_fiber_perlin_enable=e.wood_fiber_perlin_enable,n.wood_fiber_perlin_bands=e.wood_fiber_perlin_bands,n.wood_fiber_perlin_weights=(new t.Vector4).copy(e.wood_fiber_perlin_weights),n.wood_fiber_perlin_frequencies=(new t.Vector4).copy(e.wood_fiber_perlin_frequencies),n.wood_fiber_perlin_scale_z=e.wood_fiber_perlin_scale_z,n.wood_growth_perlin_enable=e.wood_growth_perlin_enable,n.wood_growth_perlin_bands=e.wood_growth_perlin_bands,n.wood_growth_perlin_weights=(new t.Vector4).copy(e.wood_growth_perlin_weights),n.wood_growth_perlin_frequencies=(new t.Vector4).copy(e.wood_growth_perlin_frequencies),n.wood_latewood_ratio=e.wood_latewood_ratio,n.wood_earlywood_sharpness=e.wood_earlywood_sharpness,n.wood_latewood_sharpness=e.wood_latewood_sharpness,n.wood_ring_thickness=e.wood_ring_thickness,n.wood_earlycolor_perlin_enable=e.wood_earlycolor_perlin_enable,n.wood_earlycolor_perlin_bands=e.wood_earlycolor_perlin_bands,n.wood_earlycolor_perlin_weights=(new t.Vector4).copy(e.wood_earlycolor_perlin_weights),n.wood_earlycolor_perlin_frequencies=(new t.Vector4).copy(e.wood_earlycolor_perlin_frequencies),n.wood_early_color=(new t.Color).copy(e.wood_early_color),n.wood_use_manual_late_color=e.wood_use_manual_late_color,n.wood_manual_late_color=(new t.Color).copy(e.wood_manual_late_color),n.wood_latecolor_perlin_enable=e.wood_latecolor_perlin_enable,n.wood_latecolor_perlin_bands=e.wood_latecolor_perlin_bands,n.wood_latecolor_perlin_weights=(new t.Vector4).copy(e.wood_latecolor_perlin_weights),n.wood_latecolor_perlin_frequencies=(new t.Vector4).copy(e.wood_latecolor_perlin_frequencies),n.wood_late_color_power=e.wood_late_color_power,n.wood_diffuse_perlin_enable=e.wood_diffuse_perlin_enable,n.wood_diffuse_perlin_bands=e.wood_diffuse_perlin_bands,n.wood_diffuse_perlin_weights=(new t.Vector4).copy(e.wood_diffuse_perlin_weights),n.wood_diffuse_perlin_frequencies=(new t.Vector4).copy(e.wood_diffuse_perlin_frequencies),n.wood_diffuse_perlin_scale_z=e.wood_diffuse_perlin_scale_z,n.wood_use_pores=e.wood_use_pores,n.wood_pore_type=e.wood_pore_type,n.wood_pore_radius=e.wood_pore_radius,n.wood_pore_cell_dim=e.wood_pore_cell_dim,n.wood_pore_color_power=e.wood_pore_color_power,n.wood_pore_depth=e.wood_pore_depth,n.wood_use_rays=e.wood_use_rays,n.wood_ray_color_power=e.wood_ray_color_power,n.wood_ray_seg_length_z=e.wood_ray_seg_length_z,n.wood_ray_num_slices=e.wood_ray_num_slices,n.wood_ray_ellipse_z2x=e.wood_ray_ellipse_z2x,n.wood_ray_ellipse_radius_x=e.wood_ray_ellipse_radius_x,n.wood_use_latewood_bump=e.wood_use_latewood_bump,n.wood_latewood_bump_depth=e.wood_latewood_bump_depth,n.wood_use_groove_roughness=e.wood_use_groove_roughness,n.wood_groove_roughness=e.wood_groove_roughness,n.wood_diffuse_lobe_weight=e.wood_diffuse_lobe_weight,n.uniforms.permutationMap.value=e.uniforms.permutationMap.value,n.uniforms.gradientMap.value=e.uniforms.gradientMap.value,n.uniforms.perm2DMap.value=e.uniforms.perm2DMap.value,n.uniforms.permGradMap.value=e.uniforms.permGradMap.value,void 0!==e.wood_curly_distortion_map&&(n.wood_curly_distortion_map=e.wood_curly_distortion_map,n.wood_curly_distortion_enable=e.wood_curly_distortion_enable,n.wood_curly_distortion_scale=e.wood_curly_distortion_scale),n.wood_ring_fraction=e.wood_ring_fraction,n.wood_fall_rise=e.wood_fall_rise;break;default:t.warn("Unknown prism type: "+e.prismType)}return n.envExponentMin=e.envExponentMin,n.envExponentMax=e.envExponentMax,n.envExponentCount=e.envExponentCount,n.envMap=e.envMap,e.useTiling&&(n.useTiling=e.useTiling,n.tilingOverallTransform=(new t.Matrix4).copy(e.tilingOverallTransform),n.TilingMap=e.TilingMap,n.TilingMap_texMatrix=(new t.Matrix3).copy(e.TilingMap_texMatrix),n.hasRoundCorner=e.hasRoundCorner,n.hasRoundCorner&&(n.TilingNormalMap=e.TilingNormalMap,n.TilingNormalMap_texMatrix=(new t.Matrix3).copy(e.TilingNormalMap_texMatrix)),n.useRandomOffset=e.useRandomOffset,n.useRandomOffset&&(n.TilingRandomMap=e.TilingRandomMap,n.TilingRandomMap_texMatrix=(new t.Matrix3).copy(e.TilingRandomMap_texMatrix),n.tilingRandomAxisS=(new t.Vector2).copy(e.tilingRandomAxisS),n.tilingRandomAxisT=(new t.Vector2).copy(e.tilingRandomAxisT),n.tilingRandomAlignmentOffset=(new t.Vector2).copy(e.tilingRandomAlignmentOffset)),n.uv2tile=e.uv2tile,n.tile2uv=e.tile2uv,n.tilingRepeatRange=[e.tilingRepeatRange[0],e.tilingRepeatRange[1],e.tilingRepeatRange[2],e.tilingRepeatRange[3]],n.tileAlignOffset=(new t.Vector2).copy(e.tileAlignOffset),n.tilingUVTransform=(new t.Matrix4).copy(e.tilingUVTransform)),n.defines=e.defines,n},hf={PrismShader:df,GetPrismMapUniforms:D,createPrismMaterial:cf,clonePrismMaterial:pf};!function(e){e[e.DEBUG=5]="DEBUG",e[e.LOG=4]="LOG",e[e.INFO=3]="INFO",e[e.WARNING=2]="WARNING",e[e.ERROR=1]="ERROR",e[e.NONE=0]="NONE"}(e.LogLevels||(e.LogLevels={})),e.logger={initialize:function(e){},shutdown:function(){},track:function(e){},logToADP:function(e){return!1},updateRuntimeStats:function(e){},reportRuntimeStats:function(){},setLevel:function(e){},error:function(){},warn:function(){},info:function(){},log:function(){},debug:function(){}};var mf=-1e240;Object.assign(O.prototype,{set:function(e,t){return this.distance=e,this.dot=t,this},copy:function(e){this.distance=e.distance,this.dot=e.dot},lessThan:function(e){return Math.abs(this.distance)<Math.abs(e.distance)||Math.abs(this.distance)===Math.abs(e.distance)&&this.dot<e.dot},greaterThan:function(e){return Math.abs(this.distance)>Math.abs(e.distance)||Math.abs(this.distance)===Math.abs(e.distance)&&this.dot>e.dot},lessThanOrEquals:function(e){return Math.abs(this.distance)<Math.abs(e.distance)||Math.abs(this.distance)==Math.abs(e.distance)&&this.dot<=e.dot},greaterThanOrEquals:function(e){return Math.abs(this.distance)>Math.abs(e.distance)||Math.abs(this.distance)==Math.abs(e.distance)&&this.dot>=e.dot}});var _f=0,vf=1,gf=2,yf=3,xf=4,bf=5,wf=6,Mf=7;Object.assign(V.prototype,{set:function(e){return this.color=e,this},clone:function(){return new this.constructor(this.p[0],this.p[1],this.color)},point:function(e){return this.p[0].clone().lerp(this.p[1],e)},direction:function(){return this.p[1].clone().sub(this.p[0])},signedDistance:function(e){var t=e.clone().sub(this.p[0]),n=this.direction(),r=t.dot(n)/n.dot(n),a=this.p[r>.5?1:0].clone().sub(e),i=a.length();if(r>0&&r<1){var o=F(n,!1,!1).dot(t);if(Math.abs(o)<i){var s=new O;return s.set(o,0),[s,r]}}var l=2*(U(t,n)>0?1:0)-1,u=new O;return u.set(l*i,Math.abs(n.normalize().dot(a.normalize(a)))),[u,r]},distanceToPseudoDistance:function(e,t,n){var r=void 0,a=void 0;if(n<0){a=this.direction().normalize();var i=t.clone().sub(this.p[0]);i.dot(a)<0&&(r=U(i,a),Math.abs(r)<=Math.abs(e.distance)&&(e.distance=r,e.dot=0))}else if(n>1){a=this.direction().normalize();var o=t.clone().sub(this.p[1]);o.dot(a)>0&&(r=U(o,a),Math.abs(r)<=Math.abs(e.distance)&&(e.distance=r,e.dot=0))}},moveStartPoint:function(e){this.p[0].copy(e)},moveEndPoint:function(e){this.p[1].copy(e)},splitInThirds:function(e,t,n){var r=this.point(1/3),a=this.point(2/3);new V(this.p[0],r,this.color),new V(r,a,this.color),new V(a,this.p[1],this.color)}}),Object.assign(G.prototype,{addEdge:function(e){this.edges.push(e)},winding:function(){if(0===this.edges.length)return 0;var e=0,n=void 0,r=void 0,a=void 0,i=void 0;if(1==this.edges.length)n=new t.Vector2,r=new t.Vector2,a=new t.Vector2,n.copy(this.edges[0].point(0)),r.copy(this.edges[0].point(1/3)),a.copy(this.edges[0].point(2/3)),e+=B(n,r),e+=B(r,a),e+=B(a,n);else if(2==this.edges.length)n=new t.Vector2,r=new t.Vector2,a=new t.Vector2,i=new t.Vector2,n.copy(this.edges[0].point(0)),r.copy(this.edges[0].point(.5)),a.copy(this.edges[1].point(0)),i.copy(this.edges[1].point(.5)),e+=B(n,r),e+=B(r,a),e+=B(a,i),e+=B(i,n);else{var o=new t.Vector2,s=new t.Vector2;o=this.edges[this.edges.length-1].point(0);for(var l=0;l<this.edges.length;l++)e+=B(o,s=this.edges[l].point(0)),o=s}return z(e)}}),Object.assign(q.prototype,{clear:function(){this.nearEdge=null,this.nearParam=0},copy:function(e){this.minDistance.copy(e.minDistance),this.nearEdge=e.nearEdge,this.nearParam=e.nearParam}}),Object.assign(Y.prototype,{addContour:function(e){this.contours.push(e)},addBlankContour:function(){var e=new G;return this.contours.push(e),e},initialize:function(){for(var e=0;e<this.contours.length;++e){var t=this.contours[e];this.windings.push(t.winding())}},edgeColoringSimple:function(e,t){for(var n=Math.sin(e),r=0;r<this.contours.length;++r){var a=this.contours[r],i=[];if(a.edges.length>0)for(var o=a.edges[a.edges.length-1].direction(1),s=0;s<a.edges.length;++s){var l=a.edges[s];k(o.normalize(),l.direction(0).normalize(),n)&&i.push(s),o=l.direction(1)}if(0===i.length)for(var u=0;u<a.edges.length;++u)a.edges[u].color=Mf;else if(1==i.length){var f=[Mf,Mf],d=H(f[0],t);f[0]=d[0],t=d[1],f[2]=f[0],d=H(f[0],t),f[0]=d[0],t=d[1];var c=i[0];if(a.edges.length>=3)for(var p=a.edges.length,h=0;h<p;++h)a.edges[(c+h)%p].color=f[Math.floor(2.875*h/(p-1)+.0625)];else if(a.edges.length>=1){var m=[];a.edges[0].splitInThirds(m[0+3*c],m[1+3*c],m[2+3*c]),a.edges.length>=2?(a.edges[1].splitInThirds(m[3-3*c],m[4-3*c],m[5-3*c]),m[0].color=m[1].color=f[0],m[2].color=m[3].color=f[1],m[4].color=m[5].color=f[2]):(m[0].color=f[0],m[1].color=f[1],m[2].color=f[2]),a.edges.clear();for(var _=0;_<m.length;++_)a.edges.push(m[_])}}else{var v=i.length,g=0,y=i[0],x=a.edges.length,b=Mf,w=H(b,t);b=w[0],t=w[1];for(var M=b,S=0;S<x;++S){var T=(y+S)%x;g+1<v&&i[g+1]==T&&(b=(w=W(b,t,(++g===v-1?1:0)*M))[0],t=w[1]),a.edges[T].color=b}}}},calculateMSDFValue:function(e){for(var n=this.contours.length,r=[],a=new q,i=new q,o=new q,s=Math.abs(mf),l=-mf,u=mf,f=0,d=new q,c=new q,p=new q,h=0;h<this.contours.length;++h){r[h]={r:mf,g:mf,b:mf,med:mf};var m=this.contours[h];d.clear(),c.clear(),p.clear();for(var _=0;_<m.edges.length;++_){var v=m.edges[_],g=v.signedDistance(e),y=g[0],x=g[1];(v.color&vf)>0&&y.lessThan(d.minDistance)&&(d.minDistance.copy(y),d.nearEdge=v,d.nearParam=x),(v.color&gf)>0&&y.lessThan(c.minDistance)&&(c.minDistance.copy(y),c.nearEdge=v,c.nearParam=x),(v.color&xf)>0&&y.lessThan(p.minDistance)&&(p.minDistance.copy(y),p.nearEdge=v,p.nearParam=x)}d.minDistance.lessThan(a.minDistance)&&a.copy(d),c.minDistance.lessThan(i.minDistance)&&i.copy(c),p.minDistance.lessThan(o.minDistance)&&o.copy(p);var b=Math.abs(j(d.minDistance.distance,c.minDistance.distance,p.minDistance.distance));b<s&&(s=b,f=-this.windings[h]),d.nearEdge&&d.nearEdge.distanceToPseudoDistance(d.minDistance,e,d.nearParam),c.nearEdge&&c.nearEdge.distanceToPseudoDistance(c.minDistance,e,c.nearParam),p.nearEdge&&p.nearEdge.distanceToPseudoDistance(p.minDistance,e,p.nearParam),b=j(d.minDistance.distance,c.minDistance.distance,p.minDistance.distance),r[h].r=d.minDistance.distance,r[h].g=c.minDistance.distance,r[h].b=p.minDistance.distance,r[h].med=b,this.windings[h]>0&&b>=0&&Math.abs(b)<Math.abs(u)&&(u=b),this.windings[h]<0&&b<=0&&Math.abs(b)<Math.abs(l)&&(l=b)}a.nearEdge&&a.nearEdge.distanceToPseudoDistance(a.minDistance,e,a.nearParam),i.nearEdge&&i.nearEdge.distanceToPseudoDistance(i.minDistance,e,i.nearParam),o.nearEdge&&o.nearEdge.distanceToPseudoDistance(o.minDistance,e,o.nearParam);var w={r:mf,g:mf,b:mf,med:mf};if(u>=0&&Math.abs(u)<=Math.abs(l)){w.med=mf,f=1;for(var M=0;M<n;++M)this.windings[M]>0&&r[M].med>w.med&&Math.abs(r[M].med)<Math.abs(l)&&(w=r[M])}else if(l<=0&&Math.abs(l)<=Math.abs(u)){w.med=-mf,f=-1;for(var S=0;S<n;++S)this.windings[S]<0&&r[S].med<w.med&&Math.abs(r[S].med)<Math.abs(u)&&(w=r[S])}for(var T=0;T<n;++T)this.windings[T]!=f&&Math.abs(r[T].med)<Math.abs(w.med)&&(w=r[T]);return j(a.minDistance.distance,i.minDistance.distance,o.minDistance.distance)==w.med&&(w.r=a.minDistance.distance,w.g=i.minDistance.distance,w.b=o.minDistance.distance),new t.Vector3(w.r,w.g,w.b)},minSameColoredEdgeDistance:function(){for(var e=[1e10,1e10,1e10],t=0;t<this.contours.length;++t)for(var n=this.contours[t],r=0;r<n.edges.length;++r)for(var a=n.edges[r],i=0;i+1<r;++i){var o=n.edges[i];if(a.color==o.color){var s=Math.min(Math.min(X(a.point(0),o),X(a.point(1),o)),Math.min(X(o.point(0),a),X(o.point(1),a))),l=a.color-bf;e[l]=Math.min(e[l],s)}}return Math.min(Math.min(e[0],e[1]),e[2])}});var Sf,Tf,Af={MilliMeter:1e3,mm:1e3,8206:1e3,DeciMeter:10,dm:10,8204:10,CentiMeter:100,cm:100,8205:100,Meter:1,m:1,8193:1,KiloMeter:.001,km:.001,8201:.001,Inch:39.37008,in:39.37008,8214:39.37008,Foot:3.28084,ft:3.28084,8215:3.28084,Mile:62137e-8,mi:62137e-8,8225:62137e-8,Yard:1.09361,yard:1.09361,8221:1.09361},Ef={convertMaterial:function(e,n,r,a){a=a||e.userassets;var i=e.materials,o=i[a];o&&"TilingPattern"===o.definition&&(o=i[o.properties.references.grout_material.connections[0]]);var s=o.properties,l=Oe(e);if(r){if(!(l?r.isPrismMaterial:r instanceof t.MeshPhongMaterial))return null;r.needsUpdate=!0}else r=l?hf.createPrismMaterial():new t.MeshPhongMaterial;var u,f;if(r.proteinMat=e,r.proteinCategories=o.categories,r.packedNormals=!0,o&&l){r.tag=o.tag,r.prismType=o.definition,void 0===r.prismType&&(r.prismType=""),void 0!==e.IsSingleSided&&!1===e.IsSingleSided&&(r.side=t.DoubleSide);var d=r.mapList;switch(r.transparent=!1,r.envExponentMin=1,r.envExponentMax=512,r.envExponentCount=10,r.surface_albedo=re(K(s,"surface_albedo",new t.Color(1,0,0))),d.surface_albedo_map=te(s,"colors","surface_albedo",null),r.surface_anisotropy=J(s,"scalars","surface_anisotropy",0),d.surface_anisotropy_map=te(s,"scalars","surface_anisotropy",null),r.surface_rotation=J(s,"scalars","surface_rotation",0),d.surface_rotation_map=te(s,"scalars","surface_rotation",null),r.surface_roughness=J(s,"scalars","surface_roughness",0),d.surface_roughness_map=te(s,"scalars","surface_roughness",null),d.surface_cutout_map=te(s,"textures","surface_cutout",null),d.surface_normal_map=te(s,"textures","surface_normal",null),null!=d.surface_cutout_map&&(r.side=t.DoubleSide,r.transparent=!0),r.prismType){case"PrismOpaque":r.opaque_albedo=re(K(s,"opaque_albedo",new t.Color(1,0,0))),d.opaque_albedo_map=te(s,"colors","opaque_albedo",null),r.opaque_luminance_modifier=re(K(s,"opaque_luminance_modifier",new t.Color(0,0,0))),d.opaque_luminance_modifier_map=te(s,"colors","opaque_luminance_modifier",null),r.opaque_f0=J(s,"scalars","opaque_f0",0),d.opaque_f0_map=te(s,"scalars","opaque_f0",null),r.opaque_luminance=J(s,"scalars","opaque_luminance",0);break;case"PrismMetal":r.metal_f0=re(K(s,"metal_f0",new t.Color(1,0,0))),d.metal_f0_map=te(s,"colors","metal_f0",null);break;case"PrismLayered":r.layered_bottom_f0=re(K(s,"layered_bottom_f0",new t.Color(1,1,1))),d.layered_bottom_f0_map=te(s,"colors","layered_bottom_f0",null),r.layered_diffuse=re(K(s,"layered_diffuse",new t.Color(1,0,0))),d.layered_diffuse_map=te(s,"colors","layered_diffuse",null),r.layered_anisotropy=J(s,"scalars","layered_anisotropy",0),d.layered_anisotropy_map=te(s,"scalars","layered_anisotropy",null),r.layered_f0=J(s,"scalars","layered_f0",0),d.layered_f0_map=te(s,"scalars","layered_f0",null),r.layered_fraction=J(s,"scalars","layered_fraction",0),d.layered_fraction_map=te(s,"scalars","layered_fraction",null),r.layered_rotation=J(s,"scalars","layered_rotation",0),d.layered_rotation_map=te(s,"scalars","layered_rotation",null),r.layered_roughness=J(s,"scalars","layered_roughness",0),d.layered_roughness_map=te(s,"scalars","layered_roughness",null),d.layered_normal_map=te(s,"textures","layered_normal",null);break;case"PrismTransparent":r.transparent_color=re(K(s,"transparent_color",new t.Color(1,0,0))),r.transparent_distance=J(s,"scalars","transparent_distance",0),r.transparent_ior=J(s,"scalars","transparent_ior",0),r.transparent=!0;break;case"PrismGlazing":r.glazing_f0=re(K(s,"glazing_f0",new t.Color(1,1,1))),d.glazing_f0_map=te(s,"colors","glazing_f0",null),r.glazing_transmission_color=re(K(s,"glazing_transmission_color",new t.Color(1,1,1))),d.glazing_transmission_color_map=te(s,"colors","glazing_transmission_color",null),r.glazing_transmission_roughness=Z(s,"glazing_transmission_roughness",0),d.glazing_transmission_roughness_map=te(s,"scalars","glazing_transmission_roughness",null),r.side=J(s,"booleans","glazing_backface_culling",!1)?t.FrontSide:t.DoubleSide,r.transparent=!0;break;case"PrismWood":ue(r,s,"wood_fiber_cosine"),ue(r,s,"wood_fiber_perlin"),r.wood_fiber_perlin_scale_z=J(s,"scalars","wood_fiber_perlin_scale_z",0),ue(r,s,"wood_growth_perlin"),r.wood_latewood_ratio=J(s,"scalars","wood_latewood_ratio",0),r.wood_earlywood_sharpness=J(s,"scalars","wood_earlywood_sharpness",0),r.wood_latewood_sharpness=J(s,"scalars","wood_latewood_sharpness",0),r.wood_ring_thickness=J(s,"scalars","wood_ring_thickness",0),ue(r,s,"wood_earlycolor_perlin"),r.wood_early_color=re(K(s,"wood_early_color",new t.Color(1,0,0))),r.wood_use_manual_late_color=J(s,"booleans","wood_use_manual_late_color",0),r.wood_manual_late_color=re(K(s,"wood_manual_late_color",new t.Color(1,0,0))),ue(r,s,"wood_latecolor_perlin"),r.wood_late_color_power=J(s,"scalars","wood_late_color_power",0),ue(r,s,"wood_diffuse_perlin"),r.wood_diffuse_perlin_scale_z=J(s,"scalars","wood_diffuse_perlin_scale_z",0),r.wood_use_pores=J(s,"booleans","wood_use_pores",0),r.wood_pore_type=J(s,"choicelists","wood_pore_type",0),r.wood_pore_radius=J(s,"scalars","wood_pore_radius",0),r.wood_pore_cell_dim=J(s,"scalars","wood_pore_cell_dim",0),r.wood_pore_color_power=J(s,"scalars","wood_pore_color_power",0),r.wood_pore_depth=J(s,"scalars","wood_pore_depth",0),r.wood_use_rays=J(s,"booleans","wood_use_rays",0),r.wood_ray_color_power=J(s,"scalars","wood_ray_color_power",0),r.wood_ray_seg_length_z=J(s,"scalars","wood_ray_seg_length_z",0),r.wood_ray_num_slices=J(s,"integers","wood_ray_num_slices",0),r.wood_ray_ellipse_z2x=J(s,"scalars","wood_ray_ellipse_z2x",0),r.wood_ray_ellipse_radius_x=J(s,"scalars","wood_ray_ellipse_radius_x",0),r.wood_use_latewood_bump=J(s,"booleans","wood_use_latewood_bump",0),r.wood_latewood_bump_depth=J(s,"scalars","wood_latewood_bump_depth",0),r.wood_use_groove_roughness=J(s,"booleans","wood_use_groove_roughness",0),r.wood_groove_roughness=J(s,"scalars","wood_groove_roughness",0),r.wood_diffuse_lobe_weight=J(s,"scalars","wood_diffuse_lobe_weight",0),r.wood_curly_distortion_enable=J(s,"booleans","wood_curly_distortion_enable",0),r.wood_curly_distortion_scale=J(s,"scalars","wood_curly_distortion_scale",0),d.wood_curly_distortion_map=te(s,"scalars","wood_curly_distortion_map",null),Tf||le(),r.uniforms.permutationMap.value=Tf.permutation,r.uniforms.gradientMap.value=Tf.gradient,r.uniforms.perm2DMap.value=Tf.perm2D,r.uniforms.permGradMap.value=Tf.permGrad;break;default:t.warn("Unknown prism type: "+r.prismType)}r.enableImportantSampling&&(r.surface_anisotropy||r.surface_rotation||r.layered_anisotropy||r.layered_rotation)&&(Sf||se(),r.uniforms.importantSamplingRandomMap.value=Sf.randomNum,r.uniforms.importantSamplingSolidAngleMap.value=Sf.solidAngle),r.defines={},r.textureMaps={};for(var c in d)if(d[c]){var p=i[d[c]];f=p.properties,p.matrix=Ne(p,!0,n);var h="BumpMap"==p.definition?"bumpmap_Bitmap":"unifiedbitmap_Bitmap",m=f.uris[h].values[0];m&&(u={mapName:c,uri:m,textureObj:p,isPrism:!0},r.textureMaps[u.mapName]=u,r.defines["USE_"+c.toUpperCase()]="")}r.defines[r.prismType.toUpperCase()]="","PrismWood"==r.prismType&&r.enable3DWoodBump&&(r.defines.PRISMWOODBUMP=""),r.enableImportantSampling&&(r.defines.ENABLEIMPORTANTSAMPLING="")}else if(o&&!l&&"SimplePhong"==o.definition){r.tag=o.tag,r.proteinType=o.proteinType,void 0===r.proteinType&&(r.proteinType=null);var _=Q(s,"generic_baked_lighting",!1);r.disableEnvMap=_;var v=r.ambient=K(s,"generic_ambient"),g=r.color=K(s,"generic_diffuse"),y=r.specular=K(s,"generic_specular"),x=r.emissive=K(s,"generic_emissive");r.shininess=Z(s,"generic_glossiness",30),r.opacity=1-Z(s,"generic_transparency",0),r.reflectivity=Z(s,"generic_reflectivity_at_0deg",0);var b=Q(s,"generic_bump_is_normal"),w=Z(s,"generic_bump_amount",0);null==w&&(w=1),b?(w>1&&(w=1),r.normalScale=new t.Vector2(w,w)):(w>=1&&(w=.03),r.bumpScale=w);var M=Q(s,"generic_is_metal");void 0!==M&&(r.metal=M);var S=Q(s,"generic_backface_cull");void 0===S||S||(r.side=t.DoubleSide),r.transparent=o.transparent,r.textureMaps={};var T=o.textures;for(var A in T)if(u={},u.textureObj=i[T[A].connections[0]],f=u.textureObj.properties,u.textureObj.matrix=Ne(u.textureObj,!1,n),u.uri=f.uris.unifiedbitmap_Bitmap.values[0],u.uri){if("generic_diffuse"==A)u.mapName="map",(!r.color||0===r.color.r&&0===r.color.g&&0===r.color.b)&&r.color.setRGB(1,1,1);else if("generic_bump"==A)u.mapName=b?"normalMap":"bumpMap";else if("generic_specular"==A)u.mapName="specularMap";else{if("generic_alpha"!=A)continue;u.mapName="alphaMap",r.side=t.DoubleSide,r.transparent=!0}r.textureMaps[u.mapName]=u}0===g.r&&0===g.g&&0===g.b&&0===y.r&&0===y.g&&0===y.b&&0===v.r&&0===v.g&&0===v.b&&0===x.r&&0===x.g&&0===x.b&&(g.r=g.g=g.b=.4),r.extraDepthOffset=Z(s,"generic_depth_offset"),r.extraDepthOffset&&(r.polygonOffset=!0,r.polygonOffsetFactor=r.extraDepthOffset,r.polygonOffsetUnits=0)}else r.ambient=new t.Color(197379),r.color=new t.Color(7829367),r.specular=new t.Color(3355443),r.shininess=30,r.shading=t.SmoothShading;return e.transparent=r.transparent,r},materialTilingPattern:function(e,n,r,a,i){var o=n.properties,s={overallTransform:new t.Matrix4,insetSize:0,hasRoundCorner:!1,cornerRoundingAngle:0,cornerRoundingSize:0,offsetVectorA:new t.Vector2,offsetVectorB:new t.Vector2},l=new t.Vector2(ee(o,"scale_factor_x",i,1),ee(o,"scale_factor_y",i,1)),u=ee(o,"overall_offset_vector_x",i,1),f=ee(o,"overall_offset_vector_y",i,1),d=Z(o,"overall_rotation_angle",0)*Math.PI/180;fe(s.overallTransform,new t.Vector3(-u,-f,0),new t.Vector3(0,0,-d),new t.Vector3(1,1,1)),s.insetSize=ee(o,"inset_size",i,1),s.cornerRoundingAngle=Z(o,"overall_corner_rounding_angle",0)*Math.PI/180,s.cornerRoundingSize=ee(o,"overall_corner_rounding_size",i,1),s.offsetVectorA.x=Z(o,"offset_vector_a_x",0)*l.x,s.offsetVectorA.y=Z(o,"offset_vector_a_y",0)*l.y,s.offsetVectorB.x=Z(o,"offset_vector_b_x",0)*l.x,s.offsetVectorB.y=Z(o,"offset_vector_b_y",0)*l.y,s.hasRoundCorner=s.cornerRoundingAngle>0&&s.cornerRoundingSize>0;var c=void 0,p=void 0,h=[];for(c=0,p=r.length;c<p;c++){var m=r[c].properties,_={material:a[c].material,randomOffsetMode:0,rotation:0,vertices:[]};h[c]=_,_.randomOffsetMode=J(m,"choicelists","random_offset_mode",0),_.rotation=Z(m,"rotation_angle",0)*Math.PI/180;for(var v=m.scalars.vertices.values,g=0;g<v.length;g+=2)_.vertices[g/2]=new t.Vector2(v[g],v[g+1]);for(var y=0;y<_.vertices.length;y++)_.vertices[y].multiply(l);_.material.useRandomOffset=0!=_.randomOffsetMode}me(s,h);var x=Ee([s.offsetVectorA.clone(),s.offsetVectorB.clone()]);for(c=0,p=h.length;c<p;c++){var b=h[c],w=b.material;w.tilingOverallTransform=s.overallTransform,w.hasRoundCorner=s.hasRoundCorner,w.tilingUVTransform=de(b.rotation),w.useRandomOffset&&he(w,b),w.tile2uv=new t.Vector4(s.offsetVectorA.x,s.offsetVectorA.y,s.offsetVectorB.x,s.offsetVectorB.y),w.uv2tile=new t.Vector4(x[0].x,x[0].y,x[1].x,x[1].y)}},convertTexture:function(e,n,r,a){"bumpMap"==e.mapName||"normalMap"==e.mapName?n.anisotropy=0:n.anisotropy=a||0,n.flipY=void 0===e.flipY||e.flipY,n.invert=!1,n.wrapS=t.RepeatWrapping,n.wrapT=t.RepeatWrapping,e.isPrism?Ie(e.textureObj,n,r):De(e.textureObj,n)},get2DMapTransform:Ne,isPrismMaterial:Oe,hasTiling:function(e){var t=e.materials[e.userassets[0]];return!(!t||"TilingPattern"!==t.definition)},convertMaterialGltf:function(e,n){var r=new t.MeshPhongMaterial;r.packedNormals=!0,r.textureMaps={};var a=e.values,i=a.diffuse;if(i)if(Array.isArray(i))r.color=new t.Color(i[0],i[1],i[2]);else if("string"==typeof i){r.color=new t.Color(1,1,1);var o={};o.mapName="map";var s=n.gltf.textures[i];o.uri=s.source,o.flipY=!1,r.textureMaps[o.mapName]=o}var l=a.specular;return l&&(r.specular=new t.Color(l[0],l[1],l[2])),a.shininess&&(r.shininess=a.shininess),r.reflectivity=0,r.transparent=!1,r},applyAppearanceHeuristics:function(e,n,r){var a=e.proteinMat?e.proteinMat:null,i=e.prismType&&-1!==e.prismType.indexOf("Prism");if(i&&e.transparent&&(e.side===t.FrontSide&&"PrismGlazing"!=e.prismType&&(e.side=t.DoubleSide),e.side===t.DoubleSide&&e.depthTest&&(e.twoPassTransparency=!0)),!n){var o=e.proteinType&&-1!==e.proteinType.indexOf("Prism");if(e.metal)e.reflectivity||(e.reflectivity=Ue(e.specular)),a&&(1===e.reflectivity&&(e.reflectivity=Ue(e.specular)),0===e.color.r&&0===e.color.g&&0===e.color.b||(e.color.r*=.1,e.color.g*=.1,e.color.b*=.1));else if(o){var s=!1;if("PrismLayered"===e.proteinType){e.clearcoat=!0,e.reflectivity=.06;var l=e.proteinCategories;l&&l.length&&-1!=l[0].indexOf("Metal")&&(s=!0)}e.reflectivity=Math.sqrt(e.reflectivity),s?e.specular.copy(e.color):(e.specular.r=e.reflectivity,e.specular.g=e.reflectivity,e.specular.b=e.reflectivity)}else e.reflectivity?e.reflectivity>.3?(e.metal=!0,e.specular.r=e.color.r,e.specular.g=e.color.g,e.specular.b=e.color.b,e.color.r*=.1,e.color.g*=.1,e.color.b*=.1):(e.specular.r*=e.reflectivity,e.specular.g*=e.reflectivity,e.specular.b*=e.reflectivity):1!==e.color.r||1!==e.color.g||1!==e.color.b||1!==e.specular.r||1!==e.specular.g||1!==e.specular.b||e.textureMaps&&(e.textureMaps.map||e.textureMaps.specularMap)?(e.reflectivity=.01+.06*Ue(e.specular),e.specular.r*=e.reflectivity,e.specular.g*=e.reflectivity,e.specular.b*=e.reflectivity):(e.metal=!0,e.reflectivity=.7,e.color.r*=.1,e.color.g*=.1,e.color.b*=.1),e.opacity<1&&(e.reflectivity=1);(e.transparent||e.textureMaps&&(e.textureMaps.map&&-1!==e.textureMaps.map.uri.toLowerCase().indexOf(".png")||e.textureMaps.alphaMap))&&(e.alphaTest=.01)}if(e.textureMaps&&e.textureMaps.normalMap){var u=e.bumpScale;(void 0===u||u>=1)&&(u=1),e.normalScale=new t.Vector2(u,u)}else void 0===e.bumpScale&&e.textureMaps&&(e.textureMaps.map||e.textureMaps.bumpMap)?e.bumpScale=.03:e.bumpScale>=1&&(e.bumpScale=.03);n&&!i||!e.transparent||(i?(e.lmv_depthWriteTransparent=!0,e.depthWrite=!!r):e.opacity>=1?e.textureMaps&&e.textureMaps.alphaMap||(e.transparency=!1):(e.lmv_depthWriteTransparent=!0,e.depthWrite=!!r)),void 0!==e.shininess&&(e.shininess*=.25)},applyGeometryFlagsToMaterial:function(e,n){n.attributes.color&&(e.vertexColors=t.VertexColors,e.needsUpdate=!0),!e.proteinType&&n.attributes.uv&&n.attributes.uv.isPattern&&(e.map&&!e.bumpMap&&(e.bumpMap=e.map,e.needsUpdate=!0),e.textureMaps&&e.textureMaps.map&&!e.textureMaps.bumpMap&&(e.textureMaps.bumpMap=e.textureMaps.map,e.needsUpdate=!0),e.bumpScale=.03)}},Rf=ff.CreateLinePatternTexture,Lf=hf.clonePrismMaterial,Pf=function(e){this._renderer=e,this._textures={},this._texturesToUpdate=[],this._materials={},this._materialsNonHDR={},this._exposureBias=0,this._tonemapMethod=0,this._envMapExposure=1,this._envRotationSin=0,this._envRotationCos=1,this._reflectionMap=null,this._irradianceMap=null,this._cutplanes=[],this._mrtNormals=!1,this._mrtIdBuffer=void 0,this._polygonOffsetOn=!1,this._pixelsPerUnit=1,this._layerMaskTex=null,this._layersMap=null,this._lineStyleTex=null,this._selectionTex=null,this._swapBlackAndWhite=0,this._depthWriteTransparent=!0,this._needsTwoSided=!1,this._hasTransparentMaterial=!1,this.hasPrism=!1,this.defaultMaterial=new t.MeshPhongMaterial({ambient:197379,color:7829367,specular:3355443,shininess:30,shading:t.SmoothShading,reflectivity:0}),this.addMaterial("__defaultMaterial__",this.defaultMaterial)};Pf.MATERIAL_VARIANT={INSTANCED:0,VERTEX_IDS:1},Pf.prototype.dtor=function(){this.cleanup(),t.Cache.clear()},Pf.prototype._getModelHash=function(e){return"model:"+(e?e.id:"")+"|"},Pf.prototype._getMaterialHash=function(e,t){return e&&e.isOTG()?t:this._getModelHash(e)+"mat:"+t},Pf.prototype._getTextureHash=function(e,t,n){return this._getModelHash(e)+"tex:"+t+"|map:"+n},Pf.prototype.addNonHDRMaterial=function(e,t){t.doNotCut||(t.cutplanes=this._cutplanes),this._materialsNonHDR[e]=t},Pf.prototype.addMaterialNonHDR=function(e,t){this.addNonHDRMaterial.call(this,e,t)},Pf.prototype.addHDRMaterial=function(e,t){this._reflectionMap&&!t.disableEnvMap&&(t.envMap=this._reflectionMap),this._irradianceMap&&(t.irradianceMap=this._irradianceMap),t.exposureBias=Math.pow(2,this._exposureBias),t.tonemapOutput=this._tonemapMethod,t.envMapExposure=this._envMapExposure,t.envRotationSin=this._envRotationSin,t.envRotationCos=this._envRotationCos,t.doNotCut||(t.cutplanes=this._cutplanes),this._applyMRTFlags(t),this._applyPolygonOffset(t,this._polygonOffsetOn),this._materials[e]=t},Pf.prototype.addMaterial=function(e,n,r){var a=n.prismType&&-1!==n.prismType.indexOf("Prism");this.hasPrism=a||this.hasPrism,this._hasTransparentMaterial=this._hasTransparentMaterial||n.transparent,Ef.applyAppearanceHeuristics(n,a||r,this.isDepthWriteTransparentEnabled()),n.side===t.DoubleSide&&(this._needsTwoSided=!0),this.addHDRMaterial(e,n)},Pf.prototype.addObjectMaterial=function(e,n,r){e.getData().doubleSided&&(n.side=t.DoubleSide);var r=this._getMaterialHash(e,r);return this.addMaterial(r,n),this._hasTransparentMaterial=this._hasTransparentMaterial||n.transparent,r},Pf.prototype.addLineMaterial=function(e,t){this._layerMaskTex&&(t.defines.HAS_LAYERS=1,t.uniforms.tLayerMask.value=this._layerMaskTex),this._lineStyleTex&&(t.defines.HAS_LINESTYLES=1,t.defines.MAX_LINESTYLE_LENGTH=this._lineStyleTex.image.width,t.uniforms.tLineStyle.value=this._lineStyleTex,t.uniforms.vLineStyleTexSize.value.set(this._lineStyleTex.image.width,this._lineStyleTex.image.height)),t.uniforms.aaRange.value=.5/(this._pixelsPerUnit*t.modelScale),t.uniforms.pixelsPerUnit.value=this._pixelsPerUnit*t.modelScale,t.uniforms.swap.value=this._swapBlackAndWhite,this._materials[e]=t},Pf.prototype.addOverrideMaterial=function(e,t){if(this.addNonHDRMaterial(e,t),t.variants)for(var n=0;n<t.variants.length;n++){var r=t.variants[n];if(r){var a=e+"_variant_"+n;this.addNonHDRMaterial(a,r)}}},Pf.prototype.getMaterialVariant=function(e,t,n){var r=!!e.hash,a=(r?e.hash:this._getModelHash(n)+e.id)+"|"+t,i=this._materials[a];return i||(i=this.cloneMaterial(e,n),t===Pf.MATERIAL_VARIANT.INSTANCED?(i.useInstancing=!0,i.vertexIds=!0):t===Pf.MATERIAL_VARIANT.VERTEX_IDS&&(i.vertexIds=!0),this.addHDRMaterial(a,i)),r&&this._addMaterialRef(i,n.id),i},Pf.prototype.addInstancingSupport=function(e){var t=e.clone();t.useInstancing=!0;var n=e.clone();n.wideLines=!0,e.variants=[t,n],e.getCustomOverrideMaterial=function(e){return e.useInstancing?this.variants[0]:e.wideLines?this.variants[1]:null}},Pf.prototype.removeMaterial=function(e){delete this._materials[e]},Pf.prototype.findMaterial=function(e,t){var n=this._getMaterialHash(e,t);return this._materials[n]},Pf.prototype.lookupMaterial=function(e,t){var n=this._getMaterialHash(e,t);return this._materials[n]},Pf.prototype.convertSharedMaterial=function(e,t,n){var r=this.findMaterial(e,n);return r||((r=this.convertOneMaterial(e,t,n)).hash=n),this._addMaterialRef(r,e.id),r},Pf.prototype.convertOneMaterial=function(e,t,n){var r=e.getData(),a=r&&r.materials?r.materials.scene.SceneUnit:"inch",i=Ef.convertMaterial(t,a),o=this.addObjectMaterial(e,i,n);if(Ef.hasTiling(t)){i.decals=[];for(var s=t.materials,l=s[t.userassets[0]],u=l.properties.references.base_materials.connections,f=l.properties.references.tiles.connections,d=[],c=0;c<f.length;c++){var p=s[f[c]];d.push(p),(v=Ef.convertMaterial(t,a,null,u[c])).useTiling=!0,v.transparent=!0,i.decals.push({uv:0,material:v}),this.addMaterial(o+"|tile|"+c,v)}Ef.materialTilingPattern(t,l,d,i.decals,a)}if(t.decals){i.decals||(i.decals=[]);for(var h=0,m=t.decals.length;h<m;h++){var _=t.decals[h],v=Ef.convertMaterial(_.material,a);i.decals.push({uv:_.uv||0,material:v}),this.addMaterial(o+"|decal|"+h,v)}}return i},Pf.prototype.forEach=function(e,t){var n=this._materials;for(var r in n){var a=n[r];t&&a.is2d||e(a)}},Pf.prototype.updateMaterials=function(){for(var e={needsClear:!1,needsRender:!1,overlayDirty:!1};this._texturesToUpdate.length;){var t=this._texturesToUpdate.pop();for(var n in t.slots)for(var r=t.slots[n],a=0;a<r.length;a++)r[a][n]=t.tex,r[a].needsUpdate=!0,e.needsClear=!0}return e},Pf.prototype.clearTextureFromMaterial=function(e,t,n,r){var a=this._getTextureHash(e,n.uri,n.mapName),i=this._textures[a];i&&Ve(i,t,r)},Pf.prototype.setTextureInCache=function(e,t,n,r){var a=this._getTextureHash(e,t.uri,t.mapName),i=this._textures[a];if(i){var o=i.urls.findIndex(function(e){return e.url==r});if(-1==o&&(i.urls.unshift({url:r}),o=0),!(o<=i.loaded)){i.tex=n,i.loaded=o;for(var s in i.slots)for(var l=i.slots[s],u=0;u<l.length;u++)l[u][s]=n;for(var f=0;f<=o;++f){var d=i.urls[f].callback;delete i.urls[f].callback,d&&d.forEach(function(e){e(n)})}this._texturesToUpdate.push(i)}}},Pf.prototype.loadTextureFromCache=function(e,t,n,r,a,i){var o=this._getTextureHash(e,n.uri,n.mapName),s=this._textures[o];if(s){var l=0;if(a&&-1==(l=s.urls.findIndex(function(e){return e.url==a}))){var u={url:a};return i&&(u.callback=[i]),s.urls.push(u),!1}if(Fe(s,t,r),s.tex&&(t[r]=s.tex,t.needsUpdate=!0),s.loaded>=l)i&&i(s.tex);else if(i&&s.urls.length>0){var f=s.urls[l];(f.callback=f.callback||[]).push(i)}}else{var d={};d[r]=[t];var c=this._textures[o]={slots:d,tex:null,loaded:-1,url:a,urls:[]};if(a){var p={url:a};c.urls.push(p),i&&(p.callback=[i])}}return!!s},Pf.prototype.enumTextures=function(e,t){var n=e?this._getModelHash(e):"";for(var r in this._textures)0===r.indexOf(n)&&t(this._textures[r].tex)},Pf.prototype.exportModelMaterials=function(e,t){var n=this._getModelHash(e),r={};for(var a in this._materials)if(-1!==a.indexOf(n)){var i=this._materials[a];i.defines&&i.defines.hasOwnProperty("SELECTION_RENDERER")||(r[a]=i)}var o={};for(var a in this._materialsNonHDR)-1!==a.indexOf(n)&&(o[a]=this._materialsNonHDR[a]);var s={};for(var l in this._textures)-1!==l.indexOf(n)&&(s[l]=this._textures[l]);return this.cleanup(e),{mats:r,matsNonHDR:o,textures:s}},Pf.prototype.importModelMaterials=function(e){for(var t in e.mats){var n=e.mats[t];n.is2d?this.addLineMaterial(t,n):this.addHDRMaterial(t,n)}for(var t in e.matsNonHDR)this.addMaterialNonHDR(t,e.matsNonHDR[t]);for(var r in e.textures)this._textures[r]=e.textures[r]},Pf.prototype.cloneMaterial=function(n,r){var a=n.isPrismMaterial?Lf(n):n.clone();if(n.defines&&(a.defines=Object.assign({},n.defines)),(a instanceof t.MeshPhongMaterial||a.isPrismMaterial)&&(a.packedNormals=n.packedNormals,a.exposureBias=n.exposureBias,a.irradianceMap=n.irradianceMap,a.envMapExposure=n.envMapExposure,a.envRotationSin=n.envRotationSin,a.envRotationCos=n.envRotationCos,a.proteinType=n.proteinType,a.proteinMat=n.proteinMat,a.proteinCategories=n.proteinCategories,a.tonemapOutput=n.tonemapOutput,a.cutplanes=n.cutplanes,a.textureMaps=n.textureMaps,a.texturesLoaded=n.texturesLoaded),n.is2d&&(a.is2d=!0),n.disableEnvMap&&(a.disableEnvMap=!0),n.textureMaps)for(var i in n.textureMaps)if(n[i])a[i]=n[i];else if(r){var o=a.textureMaps[i],s=o.uri,l=o.mapName,u=this._getTextureHash(r,s,l),f=this._textures[u];f?Fe(f,a,i):e.logger.error("Missing texture receiver",u)}else e.logger.error("Cannot connect pending texture maps because cloneMaterial was called without a model");return this._applyMRTFlags(a),a},Pf.prototype.setupMaterial=function(e,n,r){var a,i=e.getData();if(n.isLines||n.isPoints){var o=!!n.attributes.color,s=this.findMaterial(e,r);n.isPoints?a=new t.PointCloudMaterial({vertexColors:o,size:n.pointSize}):n.isWideLines?((a=new t.MeshBasicMaterial({vertexColors:o})).wideLines=!0,n.isLines=!1,a.polygonOffset=s.polygonOffset,a.polygonOffsetFactor=s.polygonOffsetFactor,a.polygonOffsetUnits=s.polygonOffsetUnits):o?(s.cachedLineMaterialVC||(s.cachedLineMaterialVC=new t.LineBasicMaterial({vertexColors:o})),a=s.cachedLineMaterialVC):(s.cachedLineMaterial||(s.cachedLineMaterial=new t.LineBasicMaterial({vertexColors:o})),a=s.cachedLineMaterial),o||(a.color=s.color),a.svfMatId=r,this.addMaterialNonHDR(i.basePath+r+"_line_"+a.id,a),i.hasLines=!0}else(a=this.findMaterial(e,r))&&(a.svfMatId=r),Ef.applyGeometryFlagsToMaterial(a,n);return a},Pf.prototype._addMaterialRef=function(e,t){e._sharedBy||(e._sharedBy=[]);var n=e._sharedBy;-1===n.indexOf(t)&&n.push(t)},Pf.prototype._removeMaterialRef=function(e,t){var n=e._sharedBy,r=n?n.indexOf(t):-1;-1!==r&&n.splice(r,1)},Pf.prototype.cleanup=function(e){var n=this._getModelHash(e),r={};for(var a in this._textures){var i=this._textures[a];-1===a.indexOf(n)?r[a]=i:i.tex&&(i.tex.dispose(),i.tex.needsUpdate=!0)}this._textures=r;var o={},s={type:"dispose"};for(var l in this._materials){var u=this._materials[l],f=!e||-1!==l.indexOf(n);if(u._sharedBy&&(f?u._sharedBy.length=0:(this._removeMaterialRef(u,e.id),0===u._sharedBy.length&&(f=!0))),f){if((u=this._materials[l]).dispatchEvent(s),u.needsUpdate=!0,u.envMap=null,u.is2d){u.uniforms.tLayerMask.value=null,u.uniforms.tLineStyle.value=null;var d=u.uniforms.tRaster;d&&d.value instanceof t.Texture&&(d.value.dispose(),d.value.needsUpdate=!0)}}else o[l]=this._materials[l]}this._materials=o;var c={};for(var l in this._materialsNonHDR)e&&-1===l.indexOf(n)?c[l]=this._materialsNonHDR[l]:((u=this._materialsNonHDR[l]).dispatchEvent(s),u.needsUpdate=!0);this._materialsNonHDR=c},Pf.prototype.toggleDepthWriteTransparent=function(e){this._depthWriteTransparent!=e&&(this._depthWriteTransparent=e,this.forEach(function(t){t.lmv_depthWriteTransparent&&(t.depthWrite=e)}))},Pf.prototype.isDepthWriteTransparentEnabled=function(){return this._depthWriteTransparent},Pf.prototype.hasTwoSidedMaterials=function(){return this._needsTwoSided},Pf.prototype.hasTransparentMaterial=function(){return this._hasTransparentMaterial},Pf.prototype.texturesLoaded=function(){return 0===this._texturesToUpdate.length},Pf.prototype.setTonemapExposureBias=function(e){this._exposureBias=e;var t=Math.pow(2,e);this.forEach(function(e){e.exposureBias=t,e.needsUpdate=!0},!0)},Pf.prototype.setTonemapMethod=function(e){this._tonemapMethod=e,this.forEach(function(t){t.tonemapOutput=e,t.needsUpdate=!0},!0)},Pf.prototype.setEnvExposure=function(e){var t=Math.pow(2,e);this._envMapExposure=t,this.forEach(function(e){e.envMapExposure=t,e.needsUpdate=!0},!0)},Pf.prototype.setEnvRotation=function(e){var t=this._envRotationSin=Math.sin(e),n=this._envRotationCos=Math.cos(e);this.forEach(function(e){e.envRotationSin=t,e.envRotationCos=n,e.needsUpdate=!0},!0)},Pf.prototype.setReflectionMap=function(e){this._reflectionMap=e,this.forEach(function(t){t.disableEnvMap||(t.envMap=e,t.needsUpdate=!0)},!0)},Pf.prototype.setIrradianceMap=function(e){this._irradianceMap=e,this.forEach(function(t){t.irradianceMap=e,t.needsUpdate=!0},!0)},Pf.prototype.setCutPlanes=function(e){if(this._cutplanes.length!==(e?e.length||0:0)){this.forEach(function(n){n.doNotCut||(n.needsUpdate=!0,e&&e.length>0&&(n.side=t.DoubleSide))});for(var n in this._materialsNonHDR)this._materialsNonHDR[n].doNotCut||(this._materialsNonHDR[n].needsUpdate=!0)}for(;this._cutplanes.length>0;)this._cutplanes.pop();if(e)for(var r=0;r<e.length;r++)this._cutplanes.push(e[r].clone())},Pf.prototype.getCutPlanes=function(){return this._cutplanes.slice()},Pf.prototype.getCutPlanesRaw=function(){return this._cutplanes},Pf.prototype._applyPolygonOffset=function(e){(e instanceof t.MeshPhongMaterial||e.isPrismMaterial)&&(e.polygonOffset=this._polygonOffsetOn,e.polygonOffsetFactor=this._polygonOffsetFactor,e.polygonOffsetUnits=this._polygonOffsetUnits,e.extraDepthOffset&&(e.polygonOffsetFactor+=e.extraDepthOffset),e.needsUpdate=!0)},Pf.prototype.getPolygonOffsetOn=function(){return this._polygonOffsetOn},Pf.prototype.getPolygonOffsetFactor=function(){return this._polygonOffsetFactor},Pf.prototype.getPolygonOffsetUnits=function(){return this._polygonOffsetUnits},Pf.prototype.togglePolygonOffset=function(e,t,n){this._polygonOffsetOn=e,this._polygonOffsetFactor=e?t||1:0,this._polygonOffsetUnits=e?n||.1:0;var r=this;this.forEach(function(e){r._applyPolygonOffset(e)})},Pf.prototype._applyMRTFlags=function(e){var n=e.supportsMrtNormals||e instanceof t.MeshPhongMaterial||e.isPrismMaterial,r=e.mrtNormals,a=e.mrtIdBuffer,i=this._renderer&&this._renderer.supportsMRT();e.mrtNormals=n&&i&&this._mrtNormals,e.mrtIdBuffer=i?this._mrtIdBuffer:void 0,e.mrtNormals===r&&e.mrtIdBuffer===a||(e.needsUpdate=!0)},Pf.prototype.toggleMRTSetting=function(e){this._mrtNormals=e.mrtNormals,this._mrtIdBuffer=e.mrtIdBuffer;var t=this;this.forEach(function(e){e.is2d||t._applyMRTFlags(e)})},Pf.prototype.initLineStyleTexture=function(){this._lineStyleTex=Rf()},Pf.prototype.initLayersTexture=function(e,n){if(!this._layerMaskTex){for(var r=new Uint8Array(65536),a=0,i=e;a<i;a++)r[a]=255;var o=new t.DataTexture(r,256,256,t.LuminanceFormat,t.UnsignedByteType,t.UVMapping,t.ClampToEdgeWrapping,t.ClampToEdgeWrapping,t.NearestFilter,t.NearestFilter,0);o.generateMipmaps=!1,o.flipY=!1,o.needsUpdate=!0,this._layerMaskTex=o,this._layersMap=n}},Pf.prototype.setLayerVisible=function(e,t){for(var n=this._layerMaskTex,r=n.image.data,a=this._layersMap,i=t?255:0,o=0;o<e.length;++o)r[a[e[o]]]=i;n.needsUpdate=!0,this.forEach(function(e){e.is2d&&(e.needsUpdate=!0)})},Pf.prototype.isLayerVisible=function(e){return!!this._layerMaskTex.image.data[this._layersMap[e]]},Pf.prototype.initSelectionTexture=function(e){for(var n=e||1,r=0|Math.ceil(n/4096),a=1;a<r;)a*=2;r=a;for(var i=new Uint8Array(4096*r),o=0;o<n;o++)i[o]=0;var s=new t.DataTexture(i,4096,r,t.LuminanceFormat,t.UnsignedByteType,t.UVMapping,t.ClampToEdgeWrapping,t.ClampToEdgeWrapping,t.NearestFilter,t.NearestFilter,0);return s.generateMipmaps=!1,s.flipY=!1,s.needsUpdate=!0,this._selectionTex=s,s},Pf.prototype.highlightObject2D=function(e,t){var n=this._selectionTex;n&&(n.image.data[e]=t?255:0,n.needsUpdate=!0)},Pf.prototype.updatePixelScale=function(e){var t=this._pixelsPerUnit=e;this.forEach(function(e){e.is2d&&(e.uniforms.aaRange.value=.5/(t*e.modelScale),e.uniforms.pixelsPerUnit.value=t*e.modelScale)})},Pf.prototype.updateSwapBlackAndWhite=function(e){var t=this._swapBlackAndWhite=e?1:0;this.forEach(function(e){e.is2d&&(e.uniforms.swap.value=t)})},Pf.prototype.updateViewportId=function(e){this.forEach(function(t){t.is2d&&(t.uniforms.viewportId.value=e,t.needsUpdate=!0)})};var If=Du.getVertexCount,Cf=sf.runMergeSingleThreaded,Df=sf.ParallelGeomMerge,Nf=Pf.MATERIAL_VARIANT,Of={UNKNOWN:0,TRIANGLES:1,LINES:2,WIDE_LINES:3,POINTS:4};Ge.prototype={constructor:Ge,addGeom:function(e,n,r){this.geoms.push(e),this.fragIds.push(r),this.worldBox.union(n),this.vertexCount+=If(e);var a=this.geoms.length;return 1==a?0:(void 0===e.byteSize&&t.warn("Error in consolidation: Geometry must contain byteSize."),e.byteSize+(2==a?this.geoms[0].byteSize:0))}},Ye.prototype={constructor:Ye,addContainerMesh:function(e,n,r,a,i){var o=new t.Mesh(e,n);this.meshes.push(o),this.byteSize+=e.byteSize;var s=a||0,l=s+(i||r.length);o.frustumCulled=!1;for(var u=this.meshes.length-1,f=s;f<l;f++){var d=r[f];this.fragId2MeshIndex[d]=u}},addSingleMesh:function(e,n,r,a,i){var o=new t.Mesh(e,n);o.matrix.copy(a),o.matrixAutoUpdate=!1,o.dbId=i,o.fragId=r,this.meshes.push(o),o.frustumCulled=!1,this.fragId2MeshIndex[r]=this.meshes.length-1},addSingleFragment:function(e,t){var n=e.getVizmesh(t);this.addSingleMesh(n.geometry,n.material,t,n.matrixWorld,n.dbId)}},Ke.prototype={addGeom:function(e,t,n,r){var a=null,i=this.buckets[t.id];if(i)for(var o=0;o<i.length;o++){var s=i[o];if(Xe(s.geoms[0],e)&&!(If(e)+s.vertexCount>65535)){a=s;break}}a||(a=new Ge(t),this.bucketCount++,this.buckets[t.id]?this.buckets[t.id].push(a):this.buckets[t.id]=[a]),this.costs+=a.addGeom(e,n,r)},createConsolidationMap:function(e,t){var n=new Ze(e.length,this.bucketCount),r=0,a=0;for(var i in this.buckets)for(var o=this.buckets[i],s=0;s<o.length;s++){var l=o[s];n.ranges[a]=r,n.boxes[a]=l.worldBox,n.fragOrder.set(l.fragIds,r),r+=l.fragIds.length,a++}n.numConsolidated=t;for(var u=t;u<e.length;u++)n.fragOrder[u]=e[u];return n}},Ze.prototype={buildConsolidation:function(e,n,r){var a=this.fragOrder,i=e.getCount(),o=this.ranges.length,s=new Ye(i),l=null;Je()&&(l=new Df(s));for(var u=[],f=new t.Matrix4,d=0;d<o;d++){var c=this.ranges[d],p=(d===o-1?this.numConsolidated:this.ranges[d+1])-c;if(1===p){var h=a[c];s.addSingleFragment(e,h,s)}u.length=p;for(var m=new Float32Array(16*p),_=new Uint32Array(p),v=0;v<p;v++)h=a[c+v],u[v]=e.getGeometry(h),e.getOriginalWorldMatrix(h,f),m.set(f.elements,16*v),_[v]=e.getDbIds(h);var g=this.boxes[d],y=a[c],x=e.getMaterial(y),b=je(u,m,_,g,l),w=n.getMaterialVariant(x,Nf.VERTEX_IDS,r);s.addContainerMesh(b,w,a,c,p)}return l&&l.runTasks(),s.consolidationMap=this,s}};var Uf={copyVertexFormat:ke,copyPrimitiveProps:He,mergeGeometries:je,Consolidation:Ye,ConsolidationBuilder:Ke,registerWorkerSupport:Qe,multithreadingSupported:Je},Ff=wl.resolve,Vf="undefined"!=typeof navigator&&!!navigator.userAgent.match(/Trident\/7\./),Bf=["opaque_luminance_modifier","surface_albedo","surface_roughness","surface_anisotropy","surface_rotation","opaque_f0","opaque_albedo","metal_f0","layered_f0","layered_diffuse","layered_roughness","layered_anisotropy","layered_rotation","layered_bottom_f0","layered_fraction","surface_cutout","glazing_transmission_color","glazing_f0","glazing_transmission_roughness","wood_curly_distortion"],zf=function(e,t,n){var r="uv_"+e+"_map",a="";return t&&n?a="if ("+r+".x < 0.0 || "+r+".x > 1.0 || "+r+".y < 0.0 || "+r+".y > 1.0) { discard; }":t?a="if ("+r+".x < 0.0 || "+r+".x > 1.0) { discard; }":n&&(a="if ("+r+".y < 0.0 || "+r+".y > 1.0) { discard; }"),"#define "+e.toUpperCase()+"_CLAMP_TEST "+a},Gf=function(){var e=0,n=function(e){var t,n,r=[];for(var a in e)!1!==(t=e[a])&&(n="#define "+a+" "+t,r.push(n));return r.join("\n")},r=function(e,t,n){for(var r={},a=0,i=n.length;a<i;a++){var o=n[a];r[o]=e.getUniformLocation(t,o)}return r},a=function(e,t,n){for(var r={},a=0,i=n.length;a<i;a++){var o=n[a];r[o]=e.getAttribLocation(t,o)}return r},i=function(e,t,n,r,a){var i=r?"1.0-":"",o="texture2D("+e+", (UV))",s="";return a=a||"vec4(0.0)",t&&n?s="((UV).x < 0.0 || (UV).x > 1.0 || (UV).y < 0.0 || (UV).y > 1.0) ? "+a+" : ":t?s="((UV).x < 0.0 || (UV).x > 1.0) ? "+a+" : ":n&&(s="((UV).y < 0.0 || (UV).y > 1.0) ? "+a+" : "),"#define GET_"+e.toUpperCase()+"(UV) ("+s+i+o+")"},o=function(e){for(var t="\n",n=0;n<Bf.length;n++){var r=e[Bf[n]];r&&(t+=zf(Bf[n],r.S,r.T)+"\n")}return t};return function(s,l,u,f){var d=s,c=d.context,p=u.defines,h=u.__webglShader.uniforms,m=u.attributes,_=Ff(u.__webglShader.vertexShader),v=Ff(u.__webglShader.fragmentShader),g=u.index0AttributeName;void 0===g&&!0===f.morphTargets&&(g="position");var y,x,b=s.gammaFactor>0?s.gammaFactor:1,w=n(p),M=c.createProgram();u instanceof t.RawShaderMaterial?(y="",x=""):(y=["precision "+f.precision+" float;","precision "+f.precision+" int;",w,f.vertexPrefix,f.supportsVertexTextures?"#define VERTEX_TEXTURES":"",d.gammaInput?"#define GAMMA_INPUT":"",d.gammaOutput?"#define GAMMA_OUTPUT":"","#define GAMMA_FACTOR "+b,f.mrtNormals?"#define MRT_NORMALS":"",f.mrtIdBuffer?"#define MRT_ID_BUFFER":"","#define MAX_DIR_LIGHTS "+f.maxDirLights,"#define MAX_POINT_LIGHTS "+f.maxPointLights,"#define MAX_SPOT_LIGHTS "+f.maxSpotLights,"#define MAX_HEMI_LIGHTS "+f.maxHemiLights,"#define MAX_BONES "+f.maxBones,"#define NUM_CUTPLANES "+f.numCutplanes,f.map?"#define USE_MAP":"",f.envMap?"#define USE_ENVMAP":"",f.envMap?"#define ENVMAP_MODE_REFLECTION":"",f.irradianceMap?"#define USE_IRRADIANCEMAP":"",f.lightMap?"#define USE_LIGHTMAP":"",f.bumpMap?"#define USE_BUMPMAP":"",f.normalMap?"#define USE_NORMALMAP":"",f.specularMap?"#define USE_SPECULARMAP":"",f.alphaMap?"#define USE_ALPHAMAP":"",f.vertexColors?"#define USE_COLOR":"",f.vertexIds?"#define USE_VERTEX_ID":"",f.useTiling?"#define USE_TILING":"",f.useInstancing?"#define USE_INSTANCING":"",f.wideLines?"#define WIDE_LINES":"",f.skinning?"#define USE_SKINNING":"",f.useVertexTexture?"#define BONE_TEXTURE":"",f.morphTargets?"#define USE_MORPHTARGETS":"",f.morphNormals?"#define USE_MORPHNORMALS":"",f.wrapAround?"#define WRAP_AROUND":"",f.doubleSided?"#define DOUBLE_SIDED":"",f.flipSided?"#define FLIP_SIDED":"",f.sizeAttenuation?"#define USE_SIZEATTENUATION":"",f.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",f.useFragDepthExt?"#define USE_LOGDEPTHBUF_EXT":"",f.packedNormals?"#define UNPACK_NORMALS":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","attribute vec3 position;","#ifdef UNPACK_NORMALS","attribute vec2 normal;","#else","attribute vec3 normal;","#endif","attribute vec2 uv;","attribute vec2 uv2;","#ifdef PRISMWOOD","attribute vec3 uvw;","#endif","#ifdef USE_COLOR","   attribute vec3 color;","#endif",""].join("\n"),x=[f.bumpMap||f.normalMap?"#extension GL_OES_standard_derivatives : enable":"",!f.mrtIdBuffer&&!f.mrtNormals||Vf?"":"#extension GL_EXT_draw_buffers : enable",f.mrtIdBuffer?"#define gl_FragColor gl_FragData[0]":"",f.haveTextureLod?"#define HAVE_TEXTURE_LOD":"",w,f.fragmentPrefix,"#define MAX_DIR_LIGHTS "+f.maxDirLights,"#define MAX_POINT_LIGHTS "+f.maxPointLights,"#define MAX_SPOT_LIGHTS "+f.maxSpotLights,"#define MAX_HEMI_LIGHTS "+f.maxHemiLights,"#define NUM_CUTPLANES "+f.numCutplanes,f.alphaTest?"#define ALPHATEST "+f.alphaTest:"",d.gammaInput?"#define GAMMA_INPUT":"",d.gammaOutput?"#define GAMMA_OUTPUT":"","#define GAMMA_FACTOR "+b,f.mrtNormals?"#define MRT_NORMALS":"",f.mrtIdBuffer?"#define MRT_ID_BUFFER":"",f.mrtIdBuffer>1?"#define MODEL_COLOR":"","#define TONEMAP_OUTPUT "+(f.tonemapOutput||0),f.useFog&&f.fog?"#define USE_FOG":"",f.useFog&&f.fogExp?"#define FOG_EXP2":"",f.map?"#define USE_MAP":"",f.envMap?"#define USE_ENVMAP":"",f.envMap?"#define ENVMAP_TYPE_CUBE":"",f.envMap?"#define ENVMAP_MODE_REFLECTION":"",f.envMap?"#define ENVMAP_BLENDING_MULTIPLY":"",f.irradianceMap?"#define USE_IRRADIANCEMAP":"",f.envGammaEncoded?"#define ENV_GAMMA":"",f.irrGammaEncoded?"#define IRR_GAMMA":"",f.envRGBM?"#define ENV_RGBM":"",f.irrRGBM?"#define IRR_RGBM":"",f.lightMap?"#define USE_LIGHTMAP":"",f.bumpMap?"#define USE_BUMPMAP":"",f.normalMap?"#define USE_NORMALMAP":"",f.specularMap?"#define USE_SPECULARMAP":"",f.alphaMap?"#define USE_ALPHAMAP":"",f.vertexColors?"#define USE_COLOR":"",f.vertexIds?"#define USE_VERTEX_ID":"",f.metal?"#define METAL":"",f.clearcoat?"#define CLEARCOAT":"",f.wrapAround?"#define WRAP_AROUND":"",f.doubleSided?"#define DOUBLE_SIDED":"",f.flipSided?"#define FLIP_SIDED":"",f.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",f.hatchPattern?"#define HATCH_PATTERN":"",f.mapInvert?"#define MAP_INVERT":"",f.useTiling?"#define USE_TILING":"",f.useTiling?"#define TILE_RANGE_X_MIN "+f.tilingRepeatRange[0]:"",f.useTiling?"#define TILE_RANGE_Y_MIN "+f.tilingRepeatRange[1]:"",f.useTiling?"#define TILE_RANGE_X_MAX "+f.tilingRepeatRange[2]:"",f.useTiling?"#define TILE_RANGE_Y_MAX "+f.tilingRepeatRange[3]:"",f.hasRoundCorner?"#define USE_TILING_NORMAL":"",f.useRandomOffset?"#define USE_TILING_RANDOM":"",i("map",f.mapClampS,f.mapClampT),i("bumpMap",f.bumpMapClampS,f.bumpMapClampT),i("normalMap",f.normalMapClampS,f.normalMapClampT),i("specularMap",f.specularMapClampS,f.specularMapClampT),i("alphaMap",f.alphaMapClampS,f.alphaMapClampT,f.alphaMapInvert),"#ifdef USE_ENVMAP","#ifdef HAVE_TEXTURE_LOD","#extension GL_EXT_shader_texture_lod : enable","#endif","#endif","#extension GL_OES_standard_derivatives : enable","precision "+f.precisionFragment+" float;","precision "+f.precisionFragment+" int;","uniform highp mat4 viewMatrix;","uniform highp mat4 projectionMatrix;","uniform highp vec3 cameraPosition;","#if defined(USE_ENVMAP) || defined(USE_IRRADIANCEMAP)","uniform mat4 viewMatrixInverse;","#endif",""].join("\n"),f.isPrism&&(x+=o(f)));var S=new bu(c,c.VERTEX_SHADER,y+_),T=new bu(c,c.FRAGMENT_SHADER,x+v);c.attachShader(M,S),c.attachShader(M,T),void 0!==g&&c.bindAttribLocation(M,0,g),c.linkProgram(M),c.deleteShader(S),c.deleteShader(T);var A=["viewMatrix","modelViewMatrix","projectionMatrix","normalMatrix","modelMatrix","cameraPosition","viewMatrixInverse","mvpMatrix","dbId"];f.logarithmicDepthBuffer&&A.push("logDepthBufFC");for(var E in h)A.push(E);this.uniforms=r(c,M,A),A=["position","normal","uv","uv2","tangent","color","lineDistance","uvw","id","instOffset","instScaling","instRotation","prev","next","side"];for(var R in m)A.push(R);return this.attributes=a(c,M,A),this.attributesKeys=Object.keys(this.attributes),this.id=e++,this.code=l,this.usedTimes=1,this.program=M,this.vertexShader=S,this.fragmentShader=T,this}}(),kf={PrismMaps:Bf,GetPrismMapChunk:zf,WebGLProgram:Gf},Hf={uniforms:{cutplanes:{type:"v4v",value:[]}},vertexShader:"#ifdef USE_LOGDEPTHBUF\n#ifdef USE_LOGDEPTHBUF_EXT\nvarying float vFragDepth;\n#endif\nuniform float logDepthBufFC;\n#endif\n#if NUM_CUTPLANES > 0\nvarying vec3 vWorldPosition;\n#endif\nvoid main() {\n    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );;\n#if NUM_CUTPLANES > 0\n    vec4 worldPosition = modelMatrix * vec4( position, 1.0 );\n    vWorldPosition = worldPosition.xyz;\n#endif\n#ifdef USE_LOGDEPTHBUF\n    gl_Position.z = log2(max(1e-6, gl_Position.w + 1.0)) * logDepthBufFC;\n#ifdef USE_LOGDEPTHBUF_EXT\n    vFragDepth = 1.0 + gl_Position.w;\n#else\n    gl_Position.z = (gl_Position.z - 1.0) * gl_Position.w;\n#endif\n#endif\n}\n",fragmentShader:"#ifdef USE_LOGDEPTHBUF\nuniform float logDepthBufFC;\n#ifdef USE_LOGDEPTHBUF_EXT\n#extension GL_EXT_frag_depth : enable\nvarying float vFragDepth;\n#endif\n#endif\n#include<pack_depth>\n#if NUM_CUTPLANES > 0\nvarying vec3 vWorldPosition;\n#endif\n#include<cutplanes>\nvoid main() {\n#if NUM_CUTPLANES > 0\n    checkCutPlanes(vWorldPosition);\n#endif\n#if defined(USE_LOGDEPTHBUF) && defined(USE_LOGDEPTHBUF_EXT)\n    gl_FragDepthEXT = log2(vFragDepth) * logDepthBufFC * 0.5;\n#endif\n#ifdef USE_LOGDEPTHBUF_EXT\n    float depth = gl_FragDepthEXT / gl_FragCoord.w;\n#else\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n#endif\n    depth = 1.0 - depth;\n    gl_FragColor = packDepth(depth);\n}\n"},Wf={uniforms:{tDepth:{type:"t",value:null},worldSize:{type:"v3",value:new t.Vector3(1,1,1)}},defines:{},vertexShader:Sl,fragmentShader:"#define NUM_SAMPLES 29.0\n#define NUM_SPIRAL_TURNS 7.0\nuniform sampler2D tDepth;\nuniform vec3 worldSize;\nvarying vec2 vUv;\n#ifdef PRESET_2\n#define SAMPLE_RADIUS 0.3\n#define AO_GAMMA 1.0\n#define AO_INTENSITY 1.0\n#else\n#define SAMPLE_RADIUS 0.2\n#define AO_GAMMA 3.0\n#define AO_INTENSITY 0.8\n#endif\n#include<pack_depth>\n#define PI 3.14159265358979\nfloat rand(vec2 co) {\n    return fract(sin(dot(co.xy, vec2(12.9898, 78.233))) * 43758.5453);\n}\nfloat getRandomAngle(vec2 pos) {\n    return rand(pos) * (2.0 * PI);\n}\nvec2 tapLocation(float sampleNumber, float spinAngle, out float ssR){\n    float alpha = float(sampleNumber + 0.5) * (1.0 / NUM_SAMPLES);\n    float angle = alpha * (NUM_SPIRAL_TURNS * PI * 2.0) + spinAngle;\n    ssR = alpha;\n    return vec2(cos(angle), sin(angle));\n}\nvec2 sampleAO(vec2 unitDirection, float radius) {\n    vec2 sampleOffset = unitDirection * radius;\n    float idepth = unpackDepth(texture2D(tDepth, vUv + sampleOffset));\n    float depth = 1.0 - idepth;\n    if (depth < 1e-6) {\n        if (radius == 0.0)\n            return vec2(1.0, 1.0);\n        else\n            return vec2(0.0, 1.0);\n    }\n    vec3 dir = vec3(sampleOffset.x, depth, sampleOffset.y) * worldSize;\n    float distance2 = dot(dir,dir);\n    float idistance = 1.0 / sqrt(distance2);\n    vec3 ndir = dir * idistance;\n#ifdef PRESET_2\n    float importance = ndir.y * idistance;\n#else\n    float importance = ndir.y / distance2;\n#endif\n    vec2 ret;\n    ret.x = (idepth == 0.0) ? 0.0 : importance;\n    ret.y = importance;\n    return ret;\n}\nvoid main() {\n    vec2 sum = vec2(0.0);\n    float angle = getRandomAngle(vUv);\n    for (float i = 0.0; i<NUM_SAMPLES; i+= 1.0) {\n        float ssR;\n        vec2 uv = tapLocation(i, angle, ssR);\n        sum += sampleAO(uv, ssR * SAMPLE_RADIUS);\n    }\n    float ao = sum.x / sum.y;\n    gl_FragColor = packDepth(AO_INTENSITY * clamp(pow(ao, AO_GAMMA), 0.0, 0.9999));\n}\n"},qf={uniforms:{tDepth:{type:"t",value:null}},defines:{},vertexShader:Sl,fragmentShader:"uniform sampler2D tDepth;\nvarying vec2 vUv;\n#ifdef HORIZONTAL\n#define GET_UV(X) vec2(vUv.x + KERNEL_SCALE*(X), vUv.y)\n#else\n#define GET_UV(Y) vec2(vUv.x, vUv.y + KERNEL_SCALE*(Y))\n#endif\n#include<pack_depth>\n#define PI 3.14159265358979\n#define SIGMA ((2.0 * KERNEL_RADIUS+1.0) / 6.0)\n#define SIGMASQ2 (2.0 * SIGMA * SIGMA)\n#ifdef BOX\n#define KERNEL_VAL(X) 1.0\n#else\n#define KERNEL_VAL(X) ( (1.0 / sqrt(PI * SIGMASQ2)) * exp(-(X)*(X)/SIGMASQ2) )\n#endif\nvoid main() {\n    float depthVal = 0.0;\n    float sum = 0.0;\n    for (float x=-KERNEL_RADIUS; x<=KERNEL_RADIUS; x+=1.0) {\n        depthVal += unpackDepth(texture2D(tDepth, GET_UV(x))) * KERNEL_VAL(x);\n        sum += KERNEL_VAL(x);\n    }\n    gl_FragColor = packDepth(depthVal/sum);\n}\n"},jf={uniforms:{tDepth:{type:"t",value:null},uShadowColor:{type:"v4",value:new t.Vector4(0,0,0,1)}},vertexShader:Sl,fragmentShader:"uniform sampler2D tDepth;\nuniform vec4 uShadowColor;\nvarying vec2 vUv;\n#include<pack_depth>\nvoid main() {\n    float depthVal = unpackDepth(texture2D(tDepth, vUv));\n    gl_FragColor = vec4(uShadowColor.rgb, uShadowColor.a * depthVal);\n}\n"},Xf=function(){var e,n,r;return function(a,i,o,s,l){e||(e=new t.Matrix4),n||(n=new t.Vector3),r||(r=new t.Vector3),n.subVectors(i,s),e.lookAt(n,i,l),r.copy(s).multiplyScalar(-.5*o.y).add(i),a.position.copy(r),a.rotation.setFromRotationMatrix(e),a.scale.set(o.z,o.x,o.y)}}(),Yf=function(e,n){var r,a,i,o,s,l,u,f,d,c,p,h=e,m=!1,_=!0,v=1,g={texSize:64,pixScale:1,blurRadius:7,debug:!1};if(this.setTransform=function(){var e=new t.Vector3(0,0,0),n=new t.Vector3(0,0,0),a=new t.Vector3(0,0,0),o=new t.Vector3(0,0,0);return function(t,s,l,u){t.equals(e)&&s.equals(n)&&l.equals(a)&&u.equals(o)||(e.copy(t),n.copy(s),a.copy(l),o.copy(u),this.setDirty(),r.left=-s.z/2,r.right=s.z/2,r.top=s.x/2,r.bottom=-s.x/2,r.near=1,r.far=s.y+r.near,r.updateProjectionMatrix(),Xf(i,t,s,l,u),r.position.addVectors(t,l.clone().multiplyScalar(-s.y/2-r.near)),u&&r.up.set(u.x,u.y,u.z),r.lookAt(t),g.debug&&(p.position.set(t.x,t.y,t.z),p.rotation.set(r.rotation.x,r.rotation.y,r.rotation.z),p.scale.set(s.z,s.x,s.y)),c.uniforms.worldSize.value.copy(s))}}(),this.renderIntoShadow=function(e){if(!e.overrideMaterial||!e.overrideMaterial.transparent){var t=e.overrideMaterial;e.overrideMaterial=l,h.render(e,r,o,!1),e.overrideMaterial=t}},this.prepareGroundShadow=function(){var e,t=0,n=0,r=0;return function(a,i,o,s){if(!this.enabled||a.isEmpty())return v=1,o;if(e!=a.getGeomScenes()&&(_=!0),_)this.clear(),_=!1,e=a.getGeomScenes(),t=e.length,n=0,r=i?Math.max(Math.ceil(t/100),i):t;else{if(2===v||1===v)return v=1,o;0===i&&(r=t)}var l,u;o&&(l=performance.now(),u=(s=void 0===s?1:s)*o);for(var f,d=0;d<r&&n<t;){var c=e[n++];if(c&&(d++,c.forceVisible=!0,this.renderIntoShadow(c),c.forceVisible=!1,o)){var p=performance.now()-l;if(u<p){v=0,f=o-p;break}}}return n<t&&(v=0,f=o?o-performance.now()+l:1),void 0!==f?f:(this.postprocess(),v=2,o?o-performance.now()+l:1)}}(),this.renderShadow=function(e,t){m&&(t?h.render(a,e,t,!1):h.render(a,e))},this.postprocess=function(){d.render(h,s,o),f.render(h,o,s),m=!0},this.clear=function(){var e=h.getClearColor().getHex(),t=h.getClearAlpha();h.setClearColor(0,0),h.clearTarget(o,!0,!0,!1),h.setClearColor(e,t),h.clearBlend(),m=!1},this.setColor=function(e){u.uniforms.uShadowColor.value.x=e.r,u.uniforms.uShadowColor.value.y=e.g,u.uniforms.uShadowColor.value.z=e.b},this.getColor=function(){return new t.Color(u.uniforms.uShadowColor.value.x,u.uniforms.uShadowColor.value.y,u.uniforms.uShadowColor.value.z)},this.setAlpha=function(e){u.uniforms.uShadowColor.value.w=e},this.getAlpha=function(){return u.uniforms.uShadowColor.value.w},this.isValid=function(){return m},this.getStatus=function(){return v},this.setDirty=function(){_=!0,v=0},this.getDepthMaterial=function(){return l},n)for(var y in g)g[y]=n[y]||g[y];a=new t.Scene,r=new t.OrthographicCamera,(o=new t.WebGLRenderTarget(g.texSize,g.texSize,{minFilter:t.LinearFilter,magFilter:t.LinearFilter,format:t.RGBAFormat,stencilBuffer:!1})).generateMipmaps=!1,(s=new t.WebGLRenderTarget(g.texSize,g.texSize,{minFilter:t.LinearFilter,magFilter:t.LinearFilter,format:t.RGBAFormat,stencilBuffer:!1})).generateMipmaps=!1,(l=Gl.createShaderMaterial(Hf)).side=t.DoubleSide,l.blending=t.NoBlending,f=new kl(qf,"tDepth"),d=new kl(qf,"tDepth"),c=new kl(Wf,"tDepth"),f.material.defines.KERNEL_SCALE=d.material.defines.KERNEL_SCALE=(g.pixScale/g.texSize).toFixed(4),f.material.defines.KERNEL_RADIUS=d.material.defines.KERNEL_RADIUS=g.blurRadius.toFixed(2),c.material.blending=f.material.blending=d.material.blending=t.NoBlending,c.material.depthWrite=f.material.depthWrite=d.material.depthWrite=!1,c.material.depthTest=f.material.depthTest=d.material.depthTest=!1,f.material.defines.HORIZONTAL=1,(u=Gl.createShaderMaterial(jf)).uniforms.tDepth.value=o,u.depthWrite=!1,u.transparent=!0,i=et(u),a.add(i),g.debug&&(p=new t.Mesh(new t.BoxGeometry(1,1,1),new t.MeshBasicMaterial({color:65280,wireframe:!0})),a.add(p)),this.setTransform(new t.Vector3(0,0,0),new t.Vector3(1,1,1),new t.Vector3(0,1,0),t.Object3D.DefaultUp)};Yf.prototype.constructor=Yf;var Kf={GroundShadow:Yf,createGroundShape:et,setGroundShapeTransform:Xf},Zf={uniforms:t.UniformsUtils.merge([wl.ShadowMapCommonUniforms,{shadowMapRangeMin:{type:"f",value:0},shadowMapRangeSize:{type:"f",value:0},shadowMinOpacity:{type:"f",value:0},map:{type:"t",value:null},alphaMap:{type:"t",value:null},texMatrix:{type:"m3",value:new t.Matrix3},texMatrixAlpha:{type:"m3",value:new t.Matrix3}},hf.GetPrismMapUniforms("surface_cutout_map")]),vertexShader:"#include<shadowmap_decl_common>\nvarying float depth;\n#ifdef USE_SURFACE_CUTOUT_MAP\nvarying vec2 vUv;\n#else\n#ifdef USE_MAP\nvarying vec2 vUv;\nuniform mat3 texMatrix;\n#endif\n#ifdef USE_ALPHAMAP\nvarying vec2 vUvAlpha;\nuniform mat3 texMatrixAlpha;\n#endif\n#endif\nvoid passCutoutUVCoords() {\n#ifdef USE_SURFACE_CUTOUT_MAP\n    vUv = uv;\n#else\n#ifdef USE_MAP\n    vUv = (texMatrix * vec3(uv, 1.0)).xy;\n#endif\n#ifdef USE_ALPHAMAP\n    vUvAlpha = (texMatrixAlpha * vec3(uv, 1.0)).xy;\n#endif\n#endif\n}\nvoid main() {\n    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n    vec4 p_Position = projectionMatrix * mvPosition;\n    gl_Position = p_Position;\n    depth = -mvPosition.z;\n    passCutoutUVCoords();\n}\n",fragmentShader:"#include<shadowmap_decl_common>\nvarying float depth;\n#ifdef USE_SURFACE_CUTOUT_MAP\n#include<float3_average>\n#prism_uniforms<surface_cutout_map>\nvarying vec2 vUv;\n#else\n#ifdef USE_MAP\nvarying vec2 vUv;\nuniform sampler2D map;\n#endif\n#ifdef USE_ALPHAMAP\nvarying vec2 vUvAlpha;\nuniform sampler2D alphaMap;\n#endif\n#endif\nuniform float shadowMinOpacity;\nvoid applyCutoutMaps() {\n    float opacity = 1.0;\n#ifdef USE_SURFACE_CUTOUT_MAP\n#prism_sample_texture<surface_cutout, opacity, true, false>\n#else\n#ifdef USE_MAP\n    opacity *= GET_MAP(vUv).a;\n#endif\n#ifdef USE_ALPHAMAP\n    opacity *= GET_ALPHAMAP(vUvAlpha).r;\n#endif\n#endif\n#if defined(USE_SURFACE_CUTOUT_MAP) || defined(USE_MAP) || defined(USE_ALPHAMAP)\n    if (opacity < shadowMinOpacity) discard;\n#endif\n}\nvoid main() {\n    float normalizedLinearDepth = (depth - shadowMapRangeMin) / shadowMapRangeSize;\n    float val = exp(shadowESMConstant * normalizedLinearDepth);\n#ifdef USE_HARD_SHADOWS\n    val = normalizedLinearDepth;\n#endif\n    applyCutoutMaps();\n    gl_FragColor = vec4(val, 0, 0, 1);\n}\n"},Qf={uniforms:wl.ShadowMapUniforms,vertexShader:"#include<shadowmap_decl_vert>\nvoid main() {\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n#include<shadowmap_vert>\n}\n",fragmentShader:"#include<shadowmap_decl_frag>\nvoid main() {\n    float shadowIntensity = 0.5 * (1.0 - getShadowValue());\n    gl_FragColor = vec4(0.0, 0.0, 0.0, shadowIntensity);\n}\n"},Jf=function(){function e(e,t){var n=e.getMaterialIndex();if(!a[n]){var r=i.clone();e.isPrism&&e.alphaMap&&(Gl.setMacro(r,"USE_SURFACE_CUTOUT_MAP"),r.fragmentShader=kf.GetPrismMapChunk("surface_cutout",e.alphaClampS,e.alphaClampT)+"\n"+r.fragmentShader),e.instanced&&(r.useInstancing=!0),a[n]=r}return a[n]}function n(e){return e instanceof t.MeshPhongMaterial?e.opacity<$f.ShadowMinOpacity:e.isPrismMaterial?"PrismTransparent"===e.prismType||"PrismGlazing"===e.prismType:!e.visible}function r(r,a){if(n(r))return o;var i=r instanceof t.MeshPhongMaterial,s=r.isPrismMaterial;if(!i&&!s)return null;var u=i?r.alphaMap:r.surface_cutout_map,f=i&&r.alphaTest?r.map:null;if(!u&&!f&&!r.useInstancing)return null;var d=l;d.init(),d.isPrism=s,d.alphaMap=!!u,d.rgbaMap=!!f,d.instanced=r.useInstancing,d.decalIndex=void 0===a?-1:a,u&&(d.alphaClampS=u.clampS,d.alphaClampT=u.clampT,d.alphaInvert=u.invert),f&&(d.rgbaClampS=f.clampS,d.rgbaClampT=f.clampT,d.rgbaInvert=f.invert);var c=e(d,a);return u&&(i?(c.uniforms.alphaMap.value=u,c.uniforms.texMatrixAlpha.value=u.matrix,c.alphaMap=u,c.side=r.side):(c.uniforms.surface_cutout_map.value=u,c.uniforms.surface_cutout_map_texMatrix.value.copy(u.matrix),c.uniforms.surface_cutout_map_invert.value=u.invert,c.side=t.DoubleSide)),f&&(c.uniforms.map.value=f,c.uniforms.texMatrix.value=f.matrix,c.map=f),c}var a=[],i=Gl.createShaderMaterial(Zf),o=new t.Material;o.visible=!1;var s=[],l=new function(){this.init=function(){this.isPrism=!1,this.alphaMap=!1,this.alphaClampS=!1,this.alphaClampT=!1,this.alphaInvert=!1,this.rgbaMap=!1,this.rgbaClampS=!1,this.rgbaClampT=!1,this.rgbaInvert=!1,this.instanced=!1,this.decalIndex=-1},this.init(),this.getMaterialIndex=function(){return(this.isPrism?1:0)|(this.alphaMap?2:0)|(this.alphaClampS?4:0)|(this.alphaClampT?8:0)|(this.alphaInvert?16:0)|(this.rgbaMap?32:0)|(this.rgbaClampS?64:0)|(this.rgbaClampT?128:0)|(this.rgbaInvert?256:0)|(this.instanced?512:0)|1024*(this.decalIndex+1)}};this.forEachMaterial=function(e){for(var t=0;t<a.length;t++){var n=a[t];n&&e(n)}e(i)},this.getCustomOverrideMaterial=function(e){var t=r(e);if(!t)return null;if(!e.decals)return t.decals=null,t;if(e.decals){s.length=0;for(var n=0;n<e.decals.length;n++){var a=e.decals[n],i=r(a.material,n);if(!i)return null;s.push({uv:a.uv,material:i})}}return t.decals=s,t},this.dispose=function(){this.forEachMaterial(function(e){e.dispose()})}},$f={ShadowMapSize:1024,ShadowESMConstant:80,ShadowBias:.001,ShadowDarkness:.7,ShadowMapBlurRadius:4,ShadowMinOpacity:.9,UseHardShadows:!1,BlurShadowMap:!0},ed=0,td=1,nd=2,rd=new tt,ad=function(){};ad.RefreshUniformsShadow=function(e,t){e.shadowMap&&(e.shadowMap.value=t.shadowMap),e.shadowMatrix&&(e.shadowMatrix.value=t.shadowMatrix),e.shadowLightDir&&(e.shadowLightDir.value=t.shadowLightDir),e.shadowESMConstant&&(e.shadowESMConstant.value=$f.ShadowESMConstant),e.shadowBias&&(e.shadowBias.value=$f.ShadowBias),e.shadowMapSize&&(e.shadowMapSize.value=$f.ShadowMapSize),e.shadowDarkness&&(e.shadowDarkness.value=$f.ShadowDarkness)};var id={ShadowMapOverrideMaterials:Jf,SHADOWMAP_NEEDS_UPDATE:0,SHADOWMAP_INCOMPLETE:1,SHADOWMAP_VALID:2,ShadowConfig:$f,ShadowRender:ad,ShadowMaps:nt},od="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},sd=(function(){function e(e){this.value=e}function t(t){function n(a,i){try{var o=t[a](i),s=o.value;s instanceof e?Promise.resolve(s.value).then(function(e){n("next",e)},function(e){n("throw",e)}):r(o.done?"return":"normal",o.value)}catch(e){r("throw",e)}}function r(e,t){switch(e){case"return":a.resolve({value:t,done:!0});break;case"throw":a.reject(t);break;default:a.resolve({value:t,done:!1})}(a=a.next)?n(a.key,a.arg):i=null}var a,i;this._invoke=function(e,t){return new Promise(function(r,o){var s={key:e,arg:t,resolve:r,reject:o,next:null};i?i=i.next=s:(a=i=s,n(e,t))})},"function"!=typeof t.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)}}(),function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}),ld=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),ud=function e(t,n,r){null===t&&(t=Function.prototype);var a=Object.getOwnPropertyDescriptor(t,n);if(void 0===a){var i=Object.getPrototypeOf(t);return null===i?void 0:e(i,n,r)}if("value"in a)return a.value;var o=a.get;if(void 0!==o)return o.call(r)},fd=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},dd=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},cd=function(){function e(e,t){var n=[],r=!0,a=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(r=(o=s.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(e){a=!0,i=e}finally{try{!r&&s.return&&s.return()}finally{if(a)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),pd=function(e){function t(e,n){function r(t){!0!==i[t]&&(e.enable(t),i[t]=!0)}function a(t){!1!==i[t]&&(e.disable(t),i[t]=!1)}sd(this,t);var i={},o=dd(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n));o.buffers={stencil:function(){var t=!1,n=null,i=null,o=null,s=null,l=null,u=null,f=null,d=null;return{setTest:function(t){t?r(e.STENCIL_TEST):a(e.STENCIL_TEST)},setMask:function(r){n===r||t||(e.stencilMask(r),n=r)},setFunc:function(t,n,r){i===t&&o===n&&s===r||(e.stencilFunc(t,n,r),i=t,o=n,s=r)},setOp:function(t,n,r){l===t&&u===n&&f===r||(e.stencilOp(t,n,r),l=t,u=n,f=r)},setLocked:function(e){t=e},setClear:function(t){d!==t&&(e.clearStencil(t),d=t)},reset:function(){t=!1,n=null,i=null,o=null,s=null,l=null,u=null,f=null,d=null}}}()};var s=o.reset.bind(o);return o.reset=function(){this.buffers.stencil.reset(),s()},o}return fd(t,e),t}(t.WebGLState);rt.prototype=Object.create(_.prototype),rt.prototype.constructor=rt,rt.prototype.resetVisStatus=function(){this.visibleStats=0},rt.prototype.forEach=function(e,t,n){for(var r=this.getIndices(),a=this.frags,i=!this.sortByShaderDone,o=a.pageOutGeometryEnabled(),s=a.onDemandLoadingEnabled(),l=this.start,u=this.lastItem;l<u;l++){var f=r?r[l]:l,d=a.getVizmesh(f,this.renderImportance,!0);if(!i||d&&d.material&&d.material.program&&!d.geometry_proxy||(i=!1),s){if(a.isFlagSet(f,hu)&&t==_u)continue;if(!n&&t&&a.isFlagSet(f,t)&&(d.geometry||(d.geometry=a.requireGeometry(f),f<this.drawOrderRender&&(this.drawOrderRender=f),!d.geometry&&d.geometry_proxy&&(d.geometry=d.geometry_proxy)),d.geometry)){var c=t==_u&&a.isFlagSet(f,mu);if(t==_u){if(!(void 0==this.drawOrderRender||f<this.drawOrderRender))continue;a.setFlagFragment(f,mu,!0)}if(!c&&o&&a.pagingProxy){var p=a.getMaterial(f);p&&a.pagingProxy.onGeomTraversed(d.geometry,p.transparent)}}}!(n||d&&d.geometry)||t&&!a.isFlagSet(f,t)||e(d,f)}i&&this.sortByShader()},rt.prototype.applyVisibility=function(){function e(e,n,r,a){var i=!1;f||(f=new t.Box3),r.getWorldBounds(a,f);var o=n.intersectsBox(f);if(e&&o===Yu.OUTSIDE)i=!0;else if(r.pixelCullingEnable()){var s=n.projectedBoxArea(f,o===Yu.CONTAINS);(s*=n.areaConv)<r.pixelCullingThreshold()&&(i=!0)}return i}function n(n,f){if(n||!r.useThreeMesh)if(d||e(l,i,r,f)){if(n?n.visible=!1:t.warn("Unexpected null mesh"),a[f]=a[f]&~_u,r.pageOutGeometryEnabled()){var c=r.geomids[f],p=r.geoms.getGeometry(c);r.pagingProxy&&r.pagingProxy.onGeomCulled(p)}}else{var h=this.evalVisbility(o,a,f);n&&(n.visible=!!h),u=u&&!h}else s&&s(f)}var r,a,i,o,s,l,u,f,d;return function(e,t,f){u=!0,d=!1,i=t,o=e,s=f,r=this.frags;var c=3===o?this.boundingBoxHidden:this.boundingBox,p=i.intersectsBox(c);if(p===Yu.OUTSIDE&&(d=!0),l=p!==Yu.CONTAINS,r.pixelCullingEnable()){var h=this.renderImportance;0==h&&(h=i.projectedBoxArea(c,!l)),(h*=i.areaConv)<r.pixelCullingThreshold()&&(d=!0)}return a=this.frags.vizflags,this.forEach(n.bind(this),null,s),u}}();var hd=function(e){var t=500;return e&&(t/=3),Yl()&&(t/=3,e&&(t/=2)),(t=Math.floor(t))>0?t:500},md=function(){function e(t,n,r){sd(this,e),this._fragOrder=[],this._currentScene=0,this._geomScenes=[],this._resetVisStatus=!0,this.rayCast=function(e,t,n){for(var r=this.getSceneCount(),a=0;a<r;a++)this._geomScenes[a].raycast(e,t,n)},this._frags=t.getFragmentList(),this._model=t,this._fillLast=r,this._fragsPerScene=hd(t.is2d());for(var a=new Int32Array(n),i=0;i<this._fragCount;i++)a[i]=i;this.setFragmentOrder(a,n)}return ld(e,[{key:"setFragmentOrder",value:function(e,t){this._fragCount=t,this._fragOrder[0]=e;var n=Math.ceil(this._fragCount/this._fragsPerScene),r=this._frags.onDemandLoadingEnabled(),a=this._RBClass=r?rt:_,i=this._geomScenes.length;this._geomScenes.length=n;for(var o=this._geomScenes,s=this._fragsPerScene,l=0;l<n;l++){var u=l*s,f=l<i?o[l]:o[l]=new a(this._frags,this._fragOrder,u,this._fragsPerScene),d=u+this._fragsPerScene;d>this._fragCount&&(d=this._fragCount),f.lastItem=d,r&&f.calculateBounds()}}},{key:"addFragment",value:function(e){if(this._fragOrder[0].length<=e){var t=2*this._fragOrder[0].length;t<=e&&(t=e+1);var n=new Int32Array(t);n.set(this._fragOrder[0]),this._fragOrder[0]=n}this._fragOrder[0][e]=e;var r=Math.floor(e/this._fragsPerScene);if(this._geomScenes){var a=this._geomScenes[r];a||(this._geomScenes[r]=a=new this._RBClass(this._frags,this._fragOrder,r*this._fragsPerScene,this._fragsPerScene)),a&&a.onFragmentAdded(e,e)}}},{key:"getFragmentCount",value:function(){if(!this._geomScenes.length)return 0;for(var e=this._geomScenes[this._geomScenes.length-1].lastItem;--e>=0&&!(this._frags.geomids[e]>=0););return e+1}},{key:"reset",value:function(e,t){if(this._currentScene=0,this._fillLast&&this._geomScenes[0]&&(this._geomScenes[0].drawEnd=0),this._resetVisStatus){for(var n=this._geomScenes,r=n.length,a=0;a<r;++a){var i=n[a];i&&i.resetVisStatus&&i.resetVisStatus()}this._resetVisStatus=!1}}},{key:"getSceneCount",value:function(){return this._geomScenes.length}},{key:"getGeomScenes",value:function(){return this._geomScenes}},{key:"resetVisStatus",value:function(){this._resetVisStatus=!0}},{key:"done",value:function(){if(this._fillLast&&!this._model.isLoadDone())return!1;var e;return this._currentScene>=this._geomScenes.length-1&&(!(e=this._geomScenes[this._currentScene])||e.drawStart>=e.lastItem)}},{key:"nextBatch",value:function(){if(this._currentScene>=this.getSceneCount())return null;var e=this._geomScenes[this._currentScene];if(this._fillLast){if(e.lastItem>=e.start+e.count&&(++this._currentScene,this._geomScenes[this._currentScene]&&(this._geomScenes[this._currentScene].drawEnd=this._geomScenes[this._currentScene].start)),e.drawStart=e.drawEnd,e.drawEnd=e.lastItem,e.hasOwnProperty("drawStart")&&e.lastItem<=e.drawStart)return null}else++this._currentScene;return e.renderImportance=0,e}},{key:"getVisibleBounds",value:function(e,t){for(var n=this.getSceneCount(),r=0;r<n;r++)this._geomScenes[r].calculateBounds(),e.union(this._geomScenes[r].boundingBox),t.union(this._geomScenes[r].boundingBox),t.union(this._geomScenes[r].boundingBoxHidden)}}]),e}(),_d=function(e){function t(e){sd(this,t);var n=e.getFragmentList(),r=e.is2d()&&!n.onDemandLoadingEnabled(),a=dd(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n.getCount(),r));return a._lastCameraHash=0,a._cameraChanged=!1,a}return fd(t,md),ld(t,[{key:"calculateFragOrder",value:function(e){if(this._model.isvizCacheEnabled){var t,n=this._model.readbackTargetIdCallback(),r={},a=n.width*n.height,i=n.buffer;for(t=0;t<a;t++){var o=i[4*t+2]<<16|i[4*t+1]<<8|i[4*t];16777215!=o&&(r[o]=1+(0|r[o]))}var s=Object.keys(r).sort(function(e,t){return r[t]-r[e]}).map(Number);this._model.setFastLoadList(s,this._lastCameraObj);var l=this._fragOrder[0];l.set(s);var u=s.length;for(t=0;t<this._fragCount;++t)r[t]||(l[u++]=t)}}},{key:"reset",value:function(e,n){ud(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"reset",this).call(this,e,n),this._lastCameraHash!=at(n)&&(this._cameraChanged=!0),this._lastCameraHash=at(n),this._lastCameraObj=n}},{key:"nextBatch",value:function(){return this._model.isvizCacheEnabled&&this._cameraChanged&&(90==this._currentScene||400==this._currentScene||this._currentScene==this.getSceneCount()-1)&&(this._currentScene==this.getSceneCount()-1&&this._model.isLoadDone()&&(this._cameraChanged=!1),this.calculateFragOrder(this._currentScene>=this.getSceneCount()-1)),ud(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"nextBatch",this).call(this)}}]),t}(),vd=function(e){function t(e){sd(this,t);e.getFragmentList();var n=dd(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,0,!1));return n._ids={},n._curCount=0,n._dirty=!1,n}return fd(t,md),ld(t,[{key:"addFragment",value:function(e){this._ids[e]||(this._ids[e]=!0,++this._curCount,this._dirty=!0)}},{key:"removeFragment",value:function(e){this._ids[e]&&(delete this._ids[e],--this._curCount,this._dirty=!0)}},{key:"reset",value:function(e,n){if(this._dirty){for(var r=Object.keys(this._ids),a=new Int32Array(r.length),i=r.length;--i>=0;)a[i]=parseInt(r[i]);this.setFragmentOrder(a,r.length),this._dirty=!1}ud(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"reset",this).call(this,e,n)}},{key:"getSceneCount",value:function(){return Math.ceil(this._curCount/this._fragsPerScene)}}]),t}(),gd=Pf.MATERIAL_VARIANT,yd=function(){var e=null,n=[];return function(r,a,i,o,s,l){e||(e=new t.Matrix4);var u=i[o],f=r.getGeometry(u),d=r.getMaterial(u),c=s-o;if(1!=c){n.length=0;for(var p=new $e(f,c),h=o;h<s;h++){var m=i[h];r.getOriginalWorldMatrix(m,e);var _=r.fragments.fragId2dbId[m];p.addInstance(e,_)||n.push(m)}var v=p.finish();if(v){var g=a.getMaterialVariant(d,gd.INSTANCED,r.model);l.addContainerMesh(v,g,i,o,c)}for(h=0;h<n.length;h++)m=n[h],l.addSingleFragment(r,m)}else l.addSingleFragment(r,u)}}(),xd=function(e){var t=e||function(e,t){return e<t},n=[],r=[],a=function e(a,i,o){if(i||(i=0),o||(o=r.length),i>=o)return o;if(o===i+1){var s=n[r[i]];return t(s,a)?o:i}var l=parseInt(i+(o-i)/2),u=n[r[l-1]];return t(a,u)?e(a,i,l):t(u,a)?e(a,l,o):l-1};this.add=function(e){var t=a(e);if(t===r.length)return n.push(e),void r.push(n.length-1);n.push(e),r.splice(t,0,n.length-1)},this.size=function(){return r.length},this.get=function(e){return n[r[e]]},this.removeAt=function(e){var t=r[e];n[t]=void 0,r.splice(e,1)},this.toString=function(){for(var e="",t=0,n=this.size();t<n;++t)e+=this.get(t),t<n-1&&(e+=", ");return e}};pt.prototype.resetBoxRun=function(){this.boxCount=0},pt.prototype.getNextAvailableFragmentId=function(){return this.nextAvailableFragID++},pt.prototype.fragmentsHaveBeenAdded=function(){return this.vizflags.length>this.fragments.length},pt.prototype.getSvfMaterialId=function(e){var t=this.getMaterial(e);return t?t.svfMatId:void 0},pt.prototype.onDemandLoadingEnabled=function(){return this.pagingProxy&&this.pagingProxy.onDemandLoadingEnabled()},pt.prototype.pageOutGeometryEnabled=function(){return this.pagingProxy&&this.pagingProxy.pageOutGeometryEnabled()},pt.prototype.pixelCullingEnable=function(){return this.pagingProxy&&this.pagingProxy.pixelCullingEnable()},pt.prototype.pixelCullingThreshold=function(){return this.pagingProxy?this.pagingProxy.pixelCullingThreshold():0},pt.prototype.requireGeometry=function(e){var t=null,n=this.geomids[e];if(n>=0&&(t=this.geoms.getGeometry(n)),null==t){var r=this.fragments.packIds?this.fragments.packIds[e]:e;this.pagingProxy&&this.pagingProxy.loadPackFile(r)}return t},pt.prototype.promiseGeometry=function(e){function t(e,t){var n;return n=e.then(function(){return n&&(delete n.lmv_loader_promise,n.lmv_geom_canceled)?Promise.reject({canceled:!0}):t},function(e){return n&&(delete n.lmv_loader_promise,n.lmv_geom_canceled)?Promise.reject({canceled:!0}):Promise.reject(e)}),n.lmv_loader_promise=e,n}if(this.getGeometry(e))return t(Promise.resolve(),{model:this.model,fragId:e});var n=this.fragments.packIds?this.fragments.packIds[e]:e;if(!this.pagingProxy||!this.pagingProxy.promisePackFile)return t(Promise.reject({reason:"Not supported"}));var r=this.pagingProxy.promisePackFile(n);return r.hasOwnProperty("lmv_promise_count")||(r.lmv_promise_count=0),++r.lmv_promise_count,this.pagingProxy.pageOut(!1,!1),t(r,{model:this.model,fragId:e})},pt.prototype.cancelPromisedGeometry=function(e){if(!e)return!1;var t=e.lmv_loader_promise;return!!t&&(!!e.lmv_geom_canceled||(e.lmv_geom_canceled=!0,t.hasOwnProperty("lmv_promise_count")&&--t.lmv_promise_count<=0&&this.pagingProxy&&this.pagingProxy.promisePackFile&&this.pagingProxy.cancelPromisedPackFile(t),!0))},pt.prototype.setMesh=function(e,n,r){if(this.vizmeshes){var a=this.vizmeshes[e];a&&a.parent&&a.parent.remove(a)}if(this.vizflags.length<=e){this.isFixedSize&&(t.warn("Attempting to resize a fragments list that was initialized with fixed data. This will have a performance impact."),this.isFixedSize=!1);var i=Math.ceil(1.5*this.vizflags.length)||1;this.useThreeMesh&&i<this.vizmeshes.length&&(i=this.vizmeshes.length);var o=new Uint16Array(i);if(o.set(this.vizflags),this.vizflags=o,this.transforms){var s=new Float32Array(12*i);s.set(this.transforms),this.transforms=s}if(this.boxes){var l=new Float32Array(6*i);l.set(this.boxes),this.boxes=l}if(this.geomids){var u=new Int32Array(i);u.set(this.geomids),this.geomids=u}if(this.materialids){var f=new Int32Array(i);f.set(this.materialids),this.materialids=f}}if(this.useThreeMesh){var d=new t.Mesh(n.geometry,n.material);n.matrix&&(d.matrix&&d.matrix.copy(n.matrix),d.matrixWorld.copy(n.matrix)),d.is2d=n.is2d,d.isLine=n.isLine,d.isWideLine=n.isWideLine,d.isPoint=n.isPoint,d.matrixAutoUpdate=!1,d.frustumCulled=!1,d.fragId=e,d.dbId=0|this.fragments.fragId2dbId[e],d.modelId=this.model.getModelId(),this.vizmeshes[e]=d}else{var c=void 0;n.geometry.hash?(void 0===n.geomId&&console.error("meshInfo must provide geomId"),c=n.geomId):c=n.geometry.svfid,this.geomids[e]=c,this.materialids[e]=n.material.id,this.materialmap[n.material.id]||(this.materialmap[n.material.id]=n.material)}var p=0;if(n.isLine?p=8:n.isWideLine?p=512:n.isPoint&&(p=256),this.isFixedSize?this.vizflags[e]|=p:this.vizflags[e]|=fu|p,r){var h=n.matrix,m=12*e,_=h.elements,v=this.transforms;v[m]=_[0],v[m+1]=_[1],v[m+2]=_[2],v[m+3]=_[4],v[m+4]=_[5],v[m+5]=_[6],v[m+6]=_[8],v[m+7]=_[9],v[m+8]=_[10],v[m+9]=_[12],v[m+10]=_[13],v[m+11]=_[14];var g=new t.Box3;n.geometry&&n.geometry.boundingBox?g.copy(n.geometry.boundingBox):this.geoms.getModelBox(this.geomids[e],g),g.applyMatrix4(h);var y=6*e,x=this.boxes;x[y]=g.min.x,x[y+1]=g.min.y,x[y+2]=g.min.z,x[y+3]=g.max.x,x[y+4]=g.max.y,x[y+5]=g.max.z}},pt.prototype.isFlagSet=function(e,t){return!!(this.vizflags[e]&t)},pt.prototype.setFlagFragment=function(e,t,n){var r=this.vizflags[e];return!!(r&t)!=n&&(this.vizflags[e]=n?r|t:r&~t,!0)},pt.prototype.setFlagGlobal=function(e,t){var n=this.vizflags,r=0,a=n.length;if(t)for(;r<a;r++)n[r]=n[r]|e;else for(var i=~e;r<a;r++)n[r]=n[r]&i},pt.prototype.hideLines=function(e){this.hideFragments(8,e),this.hideFragments(512,e)},pt.prototype.hidePoints=function(e){this.hideFragments(256,e)},pt.prototype.hideFragments=function(e,t){var n=cu,r=this.vizflags,a=0,i=r.length;if(t)for(;a<i;a++)r[a]&e&&(r[a]=r[a]|n);else for(var o=~n;a<i;a++)r[a]&e&&(r[a]=r[a]&o);this.allVisibleDirty=!0},pt.prototype.isFragVisible=function(e){return 1==(this.vizflags[e]&(fu|cu))},pt.prototype.isFragOff=function(e){return!!(this.vizflags[e]&cu)},pt.prototype.isLine=function(e){return!!(8&this.vizflags[e])},pt.prototype.isWideLine=function(e){return this.isFlagSet(e,512)},pt.prototype.isPoint=function(e){return this.isFlagSet(e,256)},pt.prototype.areAllVisible=function(){if(this.allVisibleDirty){for(var e=this.vizflags,t=!0,n=0,r=e.length;n<r;n++)if(0==(1&e[n])){t=!1;break}this.allVisible=t,this.allVisibleDirty=!1}return this.allVisible};var bd=function(){var e=null,n=null,r=parseInt("00FFFFFF",16),a=parseInt("FF000000",16);return function(i,o){return e||(e=new t.Color,n=new t.Color),e.set(i&r),ht(e),o&&(n.setRGB(o.x,o.y,o.z),e.lerp(n,o.w)),ht(e).getHex()|i&a}}();pt.prototype.getVizmesh=function(){function e(){a||((a=new t.Mesh(void 0,void 0,!0)).isTemp=!0,a.dbId=0,a.modelId=0,a.fragId=-1,a.hide=!1,a.isLine=!1,a.isWideLine=!1,a.isPoint=!1,(i=new t.MeshLambertMaterial({color:0,depthWrite:!1,emissive:13421772})).cutplanes=null,o=new t.Box3,s=new t.Vector3,l=new t.Vector3,u=new Float32Array([1,-1,-1,-1,-1,-1,1,1,-1,-1,1,-1,1,1,-1,-1,-1,-1,-1,-1,1,1,-1,1,1,1,1,1,1,1,-1,1,1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,1,-1,1,-1,-1,1,-1,-1,-1,1,1,-1,-1,1,-1,1,1,1,-1,1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,1,-1,1,1,-1,-1,1,1,1,1,1,-1,1,1,1,1,-1,-1]),(f=new t.BufferGeometry).addAttribute("position",new t.BufferAttribute(u,3)))}function n(e,t,n,r){var a=e*t,i=r.boxes;n.min.x=i[a],n.min.y=i[a+1],n.min.z=i[a+2],n.max.x=i[a+3],n.max.y=i[a+4],n.max.z=i[a+5]}function r(e,r,a){if(!a.boxTransform[r]){n(r,6,o,a);var i=new t.Matrix4;l.subVectors(o.max,o.min),l.multiplyScalar(.5),i.makeScale(l.x,l.y,l.z),s.addVectors(o.max,o.min),s.multiplyScalar(.5);var u=i.elements;u[12]=s.x,u[13]=s.y,u[14]=s.z,a.boxTransform[r]=i}e.geometry_proxy=f,e.matrixWorld.copy(a.boxTransform[r])}var a,i,o,s,l,u,f;return function(t,n,o){if(this.model.is2d()&&mt(this,t),this.useThreeMesh)return this.vizmeshes[t];e(),this.getWorldMatrix(t,a.matrixWorld),a.visible=!0,a.hide=this.isFragOff(t),a.fragId=t,a.dbId=this.getDbIds(t),a.themingColor=this.db2ThemingColor[a.dbId],a.modelId=this.model.getModelId(),a.geometry=this.getGeometry(t);var s=!1;if(!s){var l=this.pagingProxy?this.pagingProxy.options.debug.boxProxyMaxCount:0;if(!a.geometry&&this.boxCount<l){var u=this.pagingProxy?this.pagingProxy.options.debug.boxProxyMinScreen:.1;(void 0===n||0==n||void 0!==n&&n>u)&&(s=!0)}}return s?(r(a,t,this),o||(a.geometry=a.geometry_proxy),this.boxCount++,a.material=i,a.isLine=!1,a.isWideLine=!1,a.isPoint=!1):(a.material=this.getMaterial(t),a.isLine=this.isLine(t),a.isWideLine=this.isWideLine(t),a.isPoint=this.isPoint(t),a.geometry&&this.boxTransform[t]&&(this.boxTransform[t]=null)),a}}(),pt.prototype.promiseVizmesh=function(e){return this.promiseGeometry(e)},pt.prototype.cancelPromisedVizmesh=function(e){return this.cancelPromisedGeometry(e)},pt.prototype.getMaterialId=function(e){return this.useThreeMesh?this.vizmeshes[e].material.id:this.materialids[e]},pt.prototype.getMaterial=function(e){return this.useThreeMesh?this.vizmeshes[e].material:this.materialmap[this.materialids[e]]},pt.prototype.getGeometry=function(e){var t;return this.useThreeMesh?(t=this.vizmeshes[e])?t.geometry:null:this.geoms.getGeometry(this.geomids[e])},pt.prototype.lockGeometry=function(e){return!!this.useThreeMesh||this.geoms.lockGeometry(this.geomids[e])},pt.prototype.unlockGeometry=function(e){return!!this.useThreeMesh||this.geoms.unlockGeometry(this.geomids[e])},pt.prototype.getLockCount=function(e){return this.useThreeMesh?0:this.geoms.getLockCount(this.geomids[e])},pt.prototype.getGeometryId=function(e){return this.useThreeMesh?e:this.geomids[e]},pt.prototype.setMaterial=function(e,t){this.useThreeMesh?this.vizmeshes[e].material=t:(this.materialids[e]=t.id,this.materialmap[t.id]=t)},pt.prototype.getCount=function(){return this.vizmeshes?this.vizmeshes.length:this.vizflags.length},pt.prototype.getDbIds=function(e){return this.fragments.fragId2dbId[e]},pt.prototype.dispose=function(e){if(this.useThreeMesh)for(var t={type:"dispose"},n={type:"removed"},r=0;r<this.vizmeshes.length;r++){var a=this.vizmeshes[r];a&&(a.dispatchEvent(n),a.geometry.dispatchEvent(t))}else this.geoms.dispose(e)},pt.prototype.setVisibility=function(e,t){this.setFlagFragment(e,fu,t),this.allVisibleDirty=!0},pt.prototype.setFragOff=function(e,t){this.setFlagFragment(e,cu,t),this.allVisibleDirty=!0},pt.prototype.setAllVisibility=function(e){if(this.model.is2d()){var t=this.fragments;if(t&&t.dbId2fragId)for(var n in t.dbId2fragId)this.setObject2DGhosted(n,!e)}else this.setFlagGlobal(fu,e),this.allVisible=e,this.allVisibleDirty=!1},pt.prototype.updateAnimTransform=function(e,t,n,r){var a,i=this.animxforms;if(!i){var o=this.getCount();i=this.animxforms=new Float32Array(10*o);for(var s=0;s<o;s++)i[a=10*s]=1,i[a+1]=1,i[a+2]=1,i[a+3]=0,i[a+4]=0,i[a+5]=0,i[a+6]=1,i[a+7]=0,i[a+8]=0,i[a+9]=0}a=10*e;var l=!1;t&&(i[a]=t.x,i[a+1]=t.y,i[a+2]=t.z,l=!0),n&&(i[a+3]=n.x,i[a+4]=n.y,i[a+5]=n.z,i[a+6]=n.w,l=!0),r&&(i[a+7]=r.x,i[a+8]=r.y,i[a+9]=r.z,l=!0),this.setFlagFragment(e,pu,l),l||(i[a]=1,i[a+1]=1,i[a+2]=1,i[a+3]=0,i[a+4]=0,i[a+5]=0,i[a+6]=1,i[a+7]=0,i[a+8]=0,i[a+9]=0)},pt.prototype.getAnimTransform=function(e,t,n,r){if(!this.animxforms)return!1;if(!this.isFlagSet(e,pu))return!1;var a=10*e,i=this.animxforms;return t&&(t.x=i[a],t.y=i[a+1],t.z=i[a+2]),n&&(n.x=i[a+3],n.y=i[a+4],n.z=i[a+5],n.w=i[a+6]),r&&(r.x=i[a+7],r.y=i[a+8],r.z=i[a+9]),!0},pt.prototype.getOriginalWorldMatrix=function(e,t){var n=12*e,r=t.elements,a=this.transforms;if(a)r[0]=a[n],r[1]=a[n+1],r[2]=a[n+2],r[3]=0,r[4]=a[n+3],r[5]=a[n+4],r[6]=a[n+5],r[7]=0,r[8]=a[n+6],r[9]=a[n+7],r[10]=a[n+8],r[11]=0,r[12]=a[n+9],r[13]=a[n+10],r[14]=a[n+11],r[15]=1;else if(this.useThreeMesh){var i=this.getVizmesh(e);i?t.copy(i.matrixWorld):t.identity()}else t.identity()},pt.prototype.getWorldMatrix=function(){function e(){n=new t.Matrix4,r=new t.Vector3,a=new t.Quaternion,i=new t.Vector3}var n,r,a,i;return function(t,o){n||e(),this.getOriginalWorldMatrix(t,o),this.isFlagSet(t,pu)&&(this.getAnimTransform(t,i,a,r),n.compose(r,a,i),o.multiplyMatrices(n,o))}}(),pt.prototype.getWorldBounds=function(){function e(){n=new t.Matrix4}var n;return function(t,r){if(n||e(),this.boxes&&!this.isFlagSet(t,pu)){var a=this.boxes,i=6*t;return r.min.x=a[i],r.min.y=a[i+1],r.min.z=a[i+2],r.max.x=a[i+3],r.max.y=a[i+4],void(r.max.z=a[i+5])}if(this.useThreeMesh){var o=this.getVizmesh(t);o&&o.geometry&&r.copy(o.geometry.boundingBox)}else this.geoms.getModelBox(this.geomids[t],r);r.empty()||(this.getWorldMatrix(t,n),r.applyMatrix4(n))}}(),pt.prototype.setThemingColor=function(e,t){var n=this.db2ThemingColor[e];n===t||n&&t&&n.equals(t)||(this.db2ThemingColor[e]=t,_t(this,e))},pt.prototype.clearThemingColors=function(){if(this.model.is2d())for(var e=1,t=this.fragments.dbId2fragId.length;e<t;e++)_t(this,e);this.db2ThemingColor.length=0},pt.prototype.setObject2DGhosted=function(e,t){!!t!=!!this.dbIdIsGhosted[e]&&(this.dbIdIsGhosted[e]=t,_t(this,e))},pt.prototype.setObject2DVisible=function(e,t){t!==!this.dbIdIsHidden[e]&&(this.dbIdIsHidden[e]=!t,_t(this,e))},pt.prototype.getMemoryInfo=function(){return this.pagingProxy?this.pagingProxy.getMemoryInfo():null},vt.prototype.getWorldMatrix=function(e){this.frags.getWorldMatrix(this.fragId,e)},vt.prototype.getOriginalWorldMatrix=function(e){this.frags.getOriginalWorldMatrix(this.fragId,e)},vt.prototype.getWorldBounds=function(e){return this.frags.getWorldBounds(this.fragId,e)},vt.prototype.getAnimTransform=function(){return this.scale||(this.scale=new t.Vector3(1,1,1),this.quaternion=new t.Quaternion(0,0,0,1),this.position=new t.Vector3(0,0,0)),this.frags.getAnimTransform(this.fragId,this.scale,this.quaternion,this.position)},vt.prototype.updateAnimTransform=function(){this.scale||(this.scale=new t.Vector3(1,1,1),this.quaternion=new t.Quaternion(0,0,0,1),this.position=new t.Vector3(0,0,0)),this.frags.updateAnimTransform(this.fragId,this.scale,this.quaternion,this.position)},vt.prototype.getMaterial=function(){return this.frags.getMaterial(this.fragId)},vt.prototype.setMaterial=function(e){return this.frags.setMaterial(this.fragId,e)};var wd={FragmentPointer:vt,FragmentList:pt};gt.prototype={constructor:gt,copy:function(){return new gt(this.level,this.x,this.y)},isValid:function(){return Number.isInteger(this.level)&&this.level>=0&&Number.isInteger(this.x)&&Number.isInteger(this.y)},getChild:function(e){var t=1&e?1:0,n=2&e?1:0;return new gt(this.level+1,2*this.x+t,2*this.y+n)},getParent:function(){return 0==this.level?null:new gt(this.level-1,Math.floor(this.x/2),Math.floor(this.y/2))},getParentAtLevel:function(e){if(e<0||e>this.level)return null;var t=this.level-e;return new gt(e,Math.floor(this.x>>t),Math.floor(this.y>>t))},toString:function(){return"("+this.level+", "+this.x+", "+this.y+")"},equals:function(e,t,n){return e instanceof gt?this.equals(e.level,e.x,e.y):this.level===e&&this.x===t&&this.y===n}};var Md=function(e){var t=((1<<2*e.level)-1)/3,n=1<<e.level;return t+e.y*n+e.x},Sd=function(e){for(var t=new gt(0,0,0);Md(t)<=e;)t.level++;t.level--;var n=e-Md(t),r=1<<t.level;return t.y=Math.floor(n/r),t.x=n%r,t},Td={TileCoords:gt,tile2Index:Md,index2Tile:Sd},Ad=function(e){this.elements=e?new Float64Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]):new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])};Ad.prototype={constructor:Ad,set:function(e,t,n,r,a,i,o,s,l,u,f,d,c,p,h,m){var _=this.elements;return _[0]=e,_[4]=t,_[8]=n,_[12]=r,_[1]=a,_[5]=i,_[9]=o,_[13]=s,_[2]=l,_[6]=u,_[10]=f,_[14]=d,_[3]=c,_[7]=p,_[11]=h,_[15]=m,this},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},copy:function(e){return this.elements.set(e.elements),this},makeRotationFromQuaternion:function(e){var t=this.elements,n=e.x,r=e.y,a=e.z,i=e.w,o=n+n,s=r+r,l=a+a,u=n*o,f=n*s,d=n*l,c=r*s,p=r*l,h=a*l,m=i*o,_=i*s,v=i*l;return t[0]=1-(c+h),t[4]=f-v,t[8]=d+_,t[1]=f+v,t[5]=1-(u+h),t[9]=p-m,t[2]=d-_,t[6]=p+m,t[10]=1-(u+c),t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},multiply:function(e){return this.multiplyMatrices(this,e)},multiplyMatrices:function(e,t){var n=e.elements,r=t.elements,a=this.elements,i=n[0],o=n[4],s=n[8],l=n[12],u=n[1],f=n[5],d=n[9],c=n[13],p=n[2],h=n[6],m=n[10],_=n[14],v=n[3],g=n[7],y=n[11],x=n[15],b=r[0],w=r[4],M=r[8],S=r[12],T=r[1],A=r[5],E=r[9],R=r[13],L=r[2],P=r[6],I=r[10],C=r[14],D=r[3],N=r[7],O=r[11],U=r[15];return a[0]=i*b+o*T+s*L+l*D,a[4]=i*w+o*A+s*P+l*N,a[8]=i*M+o*E+s*I+l*O,a[12]=i*S+o*R+s*C+l*U,a[1]=u*b+f*T+d*L+c*D,a[5]=u*w+f*A+d*P+c*N,a[9]=u*M+f*E+d*I+c*O,a[13]=u*S+f*R+d*C+c*U,a[2]=p*b+h*T+m*L+_*D,a[6]=p*w+h*A+m*P+_*N,a[10]=p*M+h*E+m*I+_*O,a[14]=p*S+h*R+m*C+_*U,a[3]=v*b+g*T+y*L+x*D,a[7]=v*w+g*A+y*P+x*N,a[11]=v*M+g*E+y*I+x*O,a[15]=v*S+g*R+y*C+x*U,this},multiplyToArray:function(e,t,n){var r=this.elements;return this.multiplyMatrices(e,t),n[0]=r[0],n[1]=r[1],n[2]=r[2],n[3]=r[3],n[4]=r[4],n[5]=r[5],n[6]=r[6],n[7]=r[7],n[8]=r[8],n[9]=r[9],n[10]=r[10],n[11]=r[11],n[12]=r[12],n[13]=r[13],n[14]=r[14],n[15]=r[15],this},multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this},determinant:function(){var e=this.elements,t=e[0],n=e[4],r=e[8],a=e[12],i=e[1],o=e[5],s=e[9],l=e[13],u=e[2],f=e[6],d=e[10],c=e[14];return e[3]*(+a*s*f-r*l*f-a*o*d+n*l*d+r*o*c-n*s*c)+e[7]*(+t*s*c-t*l*d+a*i*d-r*i*c+r*l*u-a*s*u)+e[11]*(+t*l*f-t*o*c-a*i*f+n*i*c+a*o*u-n*l*u)+e[15]*(-r*o*u-t*s*f+t*o*d+r*i*f-n*i*d+n*s*u)},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this},flattenToArrayOffset:function(e,t){var n=this.elements;return e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8],e[t+9]=n[9],e[t+10]=n[10],e[t+11]=n[11],e[t+12]=n[12],e[t+13]=n[13],e[t+14]=n[14],e[t+15]=n[15],e},setPosition:function(e){var t=this.elements;return t[12]=e.x,t[13]=e.y,t[14]=e.z,this},getInverse:function(e,t){var n=this.elements,r=e.elements,a=r[0],i=r[4],o=r[8],s=r[12],l=r[1],u=r[5],f=r[9],d=r[13],c=r[2],p=r[6],h=r[10],m=r[14],_=r[3],v=r[7],g=r[11],y=r[15];n[0]=f*m*v-d*h*v+d*p*g-u*m*g-f*p*y+u*h*y,n[4]=s*h*v-o*m*v-s*p*g+i*m*g+o*p*y-i*h*y,n[8]=o*d*v-s*f*v+s*u*g-i*d*g-o*u*y+i*f*y,n[12]=s*f*p-o*d*p-s*u*h+i*d*h+o*u*m-i*f*m,n[1]=d*h*_-f*m*_-d*c*g+l*m*g+f*c*y-l*h*y,n[5]=o*m*_-s*h*_+s*c*g-a*m*g-o*c*y+a*h*y,n[9]=s*f*_-o*d*_-s*l*g+a*d*g+o*l*y-a*f*y,n[13]=o*d*c-s*f*c+s*l*h-a*d*h-o*l*m+a*f*m,n[2]=u*m*_-d*p*_+d*c*v-l*m*v-u*c*y+l*p*y,n[6]=s*p*_-i*m*_-s*c*v+a*m*v+i*c*y-a*p*y,n[10]=i*d*_-s*u*_+s*l*v-a*d*v-i*l*y+a*u*y,n[14]=s*u*c-i*d*c-s*l*p+a*d*p+i*l*m-a*u*m,n[3]=f*p*_-u*h*_-f*c*v+l*h*v+u*c*g-l*p*g,n[7]=i*h*_-o*p*_+o*c*v-a*h*v-i*c*g+a*p*g,n[11]=o*u*_-i*f*_-o*l*v+a*f*v+i*l*g-a*u*g,n[15]=i*f*c-o*u*c+o*l*p-a*f*p-i*l*h+a*u*h;var x=a*n[0]+l*n[4]+c*n[8]+_*n[12];if(0==x){var b="Matrix4.getInverse(): can't invert matrix, determinant is 0";if(t)throw new Error(b);return console.warn(b),this.identity(),this}return this.multiplyScalar(1/x),this},scale:function(e){var t=this.elements,n=e.x,r=e.y,a=e.z;return t[0]*=n,t[4]*=r,t[8]*=a,t[1]*=n,t[5]*=r,t[9]*=a,t[2]*=n,t[6]*=r,t[10]*=a,t[3]*=n,t[7]*=r,t[11]*=a,this},makeTranslation:function(e,t,n){return this.set(1,0,0,e,0,1,0,t,0,0,1,n,0,0,0,1),this},makeRotationX:function(e){var t=Math.cos(e),n=Math.sin(e);return this.set(1,0,0,0,0,t,-n,0,0,n,t,0,0,0,0,1),this},makeRotationY:function(e){var t=Math.cos(e),n=Math.sin(e);return this.set(t,0,n,0,0,1,0,0,-n,0,t,0,0,0,0,1),this},makeRotationZ:function(e){var t=Math.cos(e),n=Math.sin(e);return this.set(t,-n,0,0,n,t,0,0,0,0,1,0,0,0,0,1),this},makeRotationAxis:function(e,t){var n=Math.cos(t),r=Math.sin(t),a=1-n,i=e.x,o=e.y,s=e.z,l=a*i,u=a*o;return this.set(l*i+n,l*o-r*s,l*s+r*o,0,l*o+r*s,u*o+n,u*s-r*i,0,l*s-r*o,u*s+r*i,a*s*s+n,0,0,0,0,1),this},makeScale:function(e,t,n){return this.set(e,0,0,0,0,t,0,0,0,0,n,0,0,0,0,1),this},compose:function(e,t,n){return this.makeRotationFromQuaternion(t),this.scale(n),this.setPosition(e),this},transformPoint:function(e){var t=e.x,n=e.y,r=e.z,a=this.elements;return e.x=a[0]*t+a[4]*n+a[8]*r+a[12],e.y=a[1]*t+a[5]*n+a[9]*r+a[13],e.z=a[2]*t+a[6]*n+a[10]*r+a[14],e},transformDirection:function(e){var t=e.x,n=e.y,r=e.z,a=this.elements;e.x=a[0]*t+a[4]*n+a[8]*r,e.y=a[1]*t+a[5]*n+a[9]*r,e.z=a[2]*t+a[6]*n+a[10]*r;var i=Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z);if(i>0){var o=1/i;e.x*=o,e.y*=o,e.z*=o}return e},fromArray:function(e){return this.elements.set(e),this},toArray:function(){var e=this.elements;return[e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15]]},clone:function(){return new Ad(this.elements instanceof Float64Array).fromArray(this.elements)}},yt.prototype.toVec4=function(){return new t.Vector4(this.offsetX,this.offsetY,this.scaleX,this.scaleY)},yt.prototype.copyTo=function(e){e.offsetX=this.offsetX,e.offsetY=this.offsetY,e.scaleX=this.scaleX,e.scaleY=this.scaleY};var Ed=Td,Rd=0,Ld=1,Pd=2,Id=function(e,t){this.timeStamp=e,this.mesh=t,this.state=Rd},Cd={ModelIteratorTexQuad:St,TexQuadConfig:Mt},Dd=10,Nd=1,Od=[1,8,8,2,4],Ud="\nvoid main() {\n    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}\n",Fd={uniforms:{tDiffuse:{type:"t",value:null},cameraNear:{type:"f",value:1},cameraInvNearFar:{type:"f",value:100},resolution:{type:"v2",value:new t.Vector2(1/512,1/512)}},vertexShader:Ud,fragmentShader:"uniform sampler2D tDiffuse;\nuniform vec2 resolution;\nuniform float cameraNear;\nuniform float cameraInvNearFar;\n#include <pack_depth>\nvoid main() {\n    vec2 ssP = vec2(gl_FragCoord.xy);\n    ssP = ssP * 2.0 + mod(ssP, 2.0);\n    ssP = (ssP + 0.5) * resolution * 0.5;\n    float depth = texture2D(tDiffuse, ssP).z;\n    if (depth != 0.0)\n        depth = (depth + cameraNear) * cameraInvNearFar;\n    gl_FragColor = packDepth(depth);\n}\n"},Vd={uniforms:{tDiffuse:{type:"t",value:null},resolution:{type:"v2",value:new t.Vector2(1/512,1/512)}},vertexShader:Ud,fragmentShader:"uniform sampler2D tDiffuse;\nuniform vec2 resolution;\nvoid main() {\n    vec2 ssP = vec2(gl_FragCoord.xy);\n    ssP = ssP * 2.0 + mod(ssP, 2.0);\n    ssP = (ssP + 0.5) * resolution * 0.5;\n    gl_FragColor = texture2D(tDiffuse, ssP);\n}\n"},Bd=new Float32Array(1),zd=new Uint32Array(Bd.buffer),Gd=new Uint16Array(1),kd=new Uint16Array(1),Hd=function(e){Bd[0]=e;var t=zd[0],n=0;if(0==(2147483647&t))kd[n++]=t>>16;else{var r=2147483648&t,a=2139095040&t,i=8388607&t;if(0===a)kd[n++]=r>>16;else if(2139095040==a)kd[n++]=0===i?r>>16|31744:65024;else{var o,s,l=r>>16,u=(0|a>>23)-127+15;u>=31?kd[n++]=r>>16|31744:u<=0?(14-u>24?o=0:(o=(i|=8388608)>>14-u,Gd[0]=o,o=Gd[0],i>>13-u&1&&(o+=1)),kd[n++]=l|o):(s=u<<10,Gd[0]=s,s=Gd[0],o=i>>13,Gd[0]=o,o=Gd[0],kd[n++]=4096&i?1+(l|s|o):l|s|o)}}return kd[0]},Wd=function(e){var t,n=65535&e;if(0==(32767&n))t=n<<16;else{var r=32768&n,a=31744&n,i=1023&n;if(0===a){var o=-1;do{o++,i<<=1}while(0==(1024&i));var s=r<<16,l=(a<<16>>26)-15+127-o,u=l<<23,f=(1023&i)<<13;t=s|u|f}else t=31744==a?0===i?r<<16|2139095040:4290772992:(s=r<<16)|(u=(l=(a<<16>>26)-15+127)<<23)|(f=i<<13)}return zd[0]=t,Bd[0]},qd=function(e){if(e>59389||e<0)return t.log("out of range"),Hd(NaN);if(0===e)return 0;var n=!1;e>29694&&(n=!0,e-=29694);var r=0|Math.abs(e/1024),a=Math.pow(2,r-13),i=a+(e-1024*r)*a/1024;return n&&(i=-i),Hd(i)},jd=function(e){if(0===e)return 0;var t=Wd(e),n=!1;t<0&&(n=!0,t=-t);var r=0|Math.floor(Math.log(t)/Math.log(2)),a=Math.pow(2,r),i=(t-a)/a*1024+1024*(r+13);return n&&(i+=29694),i},Xd=function(){for(var e=[-1/255,-.17,-75,-1789,-.005],n=0;n<e.length;n++)t.log("input",e[n],"encoded",Hd(e[n]),"decoded",Wd(Hd(e[n])));for(n=0;n<59390;n++){var r=jd(qd(n));r!==n&&t.log("Roundtrip failed for",n,r)}},Yd={FloatToHalf:Hd,HalfToFloat:Wd,HALF_INT_MAX:59390,IntToHalf:qd,HalfToInt:jd,HalfTest:Xd},Kd="#define HIGHLIGHT_NONE 0\n#define HIGHLIGHT_A 1\n#define HIGHLIGHT_B 2\n#define MIN_DIFF_VAL 0.5\n#define DIFF_THRESHOLD 0.1\nuniform sampler2D texture1;\nuniform sampler2D texture2;\nuniform float splitPosition;\nuniform int model;\nuniform int highlight;\nuniform vec2 resolution1;\nuniform vec2 resolution2;\nvarying vec2 vUvA;\nvarying vec2 vUvB;\nconst int BIT_COUNT = 2;\nint modi(int x, int y) {\n    return x - y * (x / y);\n}\nint and(int a, int b) {\n    int result = 0;\n    int n = 1;\n    for(int i = 0; i < BIT_COUNT; i++) {\n        if ((modi(a, 2) == 1) && (modi(b, 2) == 1)) {\n            result += n;\n        }\n        a = a / 2;\n        b = b / 2;\n        n = n * 2;\n        if(!(a > 0 && b > 0)) {\n            break;\n        }\n    }\n    return result;\n}\nfloat toGrayscale(vec4 v) {\n    return dot(v.rgb, vec3(0.299, 0.587, 0.114));\n}\nvoid main() {\n#ifdef SINGLE_MODEL\n    vec4 tex = texture2D(texture1, vUvA);\n    #ifdef SPLIT_VIEW\n    if (model == 1 && gl_FragCoord.x < splitPosition ||\n        model == 2 && gl_FragCoord.x >= splitPosition) {\n        gl_FragColor = tex;\n    } else {\n        discard;\n    }\n    #else\n    float gray = toGrayscale(tex);\n    gl_FragColor.rgb = vec3(gray);\n    #endif\n#else\n    vec4 tex1 = texture2D(texture1, vUvA);\n    vec4 tex2 = texture2D(texture2, vUvB);\n    #ifdef SPLIT_VIEW\n    gl_FragColor = gl_FragCoord.x < splitPosition ? tex1 : tex2;\n    #else\n    float gray1 = toGrayscale(tex1);\n    float gray2 = toGrayscale(tex2);\n    float maxGray = min(gray1, gray2);\n    float delta = gray1 - gray2;\n    gl_FragColor.rgb = vec3(maxGray);\n    if (abs(delta) > DIFF_THRESHOLD) {\n        if (delta > 0.0 && and(highlight, HIGHLIGHT_A) == HIGHLIGHT_A) {\n            gl_FragColor = vec4(max(gray1, MIN_DIFF_VAL), 0.0, 0.0, 1.0);\n        } else if (delta < 0.0 && and(highlight, HIGHLIGHT_B) == HIGHLIGHT_B) {\n            gl_FragColor = vec4(0.0, 0.0, max(gray2, MIN_DIFF_VAL), 1.0);\n        }\n    }\n        #ifdef ADD_THICKENING\n    else {\n        bool found = false;\n        for (int i = 0; i < 3; i++) {\n            for (int j = 0; j < 3; j++) {\n                if (i != 1 && j != 1) {\n                    vec4 nTex1 = texture2D(texture1, vUvA + resolution1*vec2(i - 1, j - 1));\n                    vec4 nTex2 = texture2D(texture2, vUvB + resolution2*vec2(i - 1, j - 1));\n                    float nGray1 = toGrayscale(nTex1);\n                    float nGray2 = toGrayscale(nTex2);\n                    delta = nGray1 - nGray2;\n                    if (abs(delta) > DIFF_THRESHOLD) {\n                        if (delta > 0.0 && and(highlight, HIGHLIGHT_A) == HIGHLIGHT_A) {\n                            gl_FragColor = vec4(1.25*max(nGray1, MIN_DIFF_VAL), 0.25, 0.25, 1.0);\n                        } else if (delta < 0.0 && and(highlight, HIGHLIGHT_B) == HIGHLIGHT_B) {\n                            gl_FragColor = vec4(0.25, 0.25, 1.25*max(nGray2, MIN_DIFF_VAL), 1.0);\n                        }\n                        found = true;\n                        break;\n                    }\n                }\n            }\n            if (found) break;\n        }\n    }\n        #endif\n    #endif\n#endif\n}",Zd="varying vec2 vUvA;\nvarying vec2 vUvB;\nuniform vec4 uvTFa;\nuniform vec4 uvTFb;\nvoid main() {\n    vUvA = uv;\n#ifndef SINGLE_MODEL\n    float x = (uv.x - uvTFa.x) / uvTFa.z;\n    float y = (uv.y - uvTFa.y) / uvTFa.w;\n    vUvB.x = uvTFb.x + x*uvTFb.z;\n    vUvB.y = uvTFb.y + y*uvTFb.w;\n#endif\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}",Qd={NORMAL_DIFF:0,MODEL_A_ONLY:1,MODEL_B_ONLY:2,SPLIT_VIEW:3,HIGHLIGHT_A:4,HIGHLIGHT_B:5};Et.prototype.width=function(){return this.r-this.l},Et.prototype.height=function(){return this.t-this.b},Et.prototype.getIntersection=function(e){var t=Math.max(this.l,e.l),n=Math.min(this.r,e.r),r=Math.max(this.b,e.b),a=Math.min(this.t,e.t);return n>t&&a>r?new Et(t,r,n,a):null},Et.prototype.equals=function(e){return this.l==e.l&&this.r==e.r&&this.t==e.t&&this.b==e.b},Et.prototype.union=function(e){return this.l=Math.min(this.l,e.l),this.r=Math.max(this.r,e.r),this.b=Math.min(this.b,e.b),this.t=Math.max(this.t,e.t),this};var Jd={LEAF_OBJECT:0,FIRST_OBJECT:1,LAST_OBJECT:2};Lt.prototype.setFlagNode=function(e,t,n){var r=this.nodeAccess.getNodeFlags(e);return!!(r&t)!=n&&(n?this.nodeAccess.setNodeFlags(e,r|t):this.nodeAccess.setNodeFlags(e,r&~t),!0)},Lt.prototype.setFlagGlobal=function(e,t){var n=this.nodeAccess,r=0,a=n.numNodes;if(t)for(;r<a;r++)n.setNodeFlags(r,n.getNodeFlags(r)|e);else for(var i=~e;r<a;r++)n.setNodeFlags(r,n.getNodeFlags(r)&i)},Lt.prototype.setNodeOff=function(e,t){var n=this.setFlagNode(e,1073741824,t);return n&&(t?this.numOff++:this.numOff--),n},Lt.prototype.isNodeOff=function(e){return!!(1073741824&this.nodeAccess.getNodeFlags(e))},Lt.prototype.setNodeHidden=function(e,t){var n=this.setFlagNode(e,2147483648,t);return n&&(t?this.numHidden++:this.numHidden--),n},Lt.prototype.isNodeHidden=function(e){return!!(2147483648&this.nodeAccess.getNodeFlags(e))},Lt.prototype.getNodeType=function(e){return 7&this.nodeAccess.getNodeFlags(e)},Lt.prototype.isNodeSelectable=function(e){return!(536870912&this.nodeAccess.getNodeFlags(e))},Lt.prototype.getNodeParentId=function(e){return this.nodeAccess.getParentId(e)},Lt.prototype.getRootId=function(){return this.nodeAccess.rootId},Lt.prototype.getNodeName=function(e){return this.nodeAccess.name(e)},Lt.prototype.getChildCount=function(e){return this.nodeAccess.getNumChildren(e)},Lt.prototype.getNodeBox=function(e,t){this.nodeAccess.getNodeBox(e,t)},Lt.prototype.getNodeIndex=function(e){return this.nodeAccess.getIndex(e)},Lt.prototype.enumNodeFragments=function(e,t,n){this.findNodeFragment(e,function(){return t.apply(null,arguments),!1},n)},Lt.prototype.enumNodeChildren=function(e,t,n){this.findNodeChild(e,function(){return t.apply(null,arguments),!1},n)},Lt.prototype.findNodeFragment=function(e,t,n){function r(e){return i.nodeAccess.findNodeFragment(e,t)?e:n?i.findNodeChild(e,function(e){return r(e)}):void 0}var a;"number"==typeof e?a=e:e&&(a=e.dbId);var i=this;return r(a)},Lt.prototype.findNodeChild=function(e,t,n){function r(e){return i.nodeAccess.findNodeChild(e,function(e){return t(e)?e:n?r(e):void 0})}var a;"number"==typeof e?a=e:e&&(a=e.dbId);var i=this;return n&&t(a)?a:r(a)},Lt.prototype.findNodeForSelection=function(e,t){if(t===Jd.LEAF_OBJECT)return e;var n,r,a=e;if(t===Jd.FIRST_OBJECT){var i=[];for(n=e;n;)i.push(n),n=this.getNodeParentId(n);for(var o=i.length-1;o>=0;o--)if(5!==(r=this.getNodeType(i[o]))&&2!==r&&3!==r){a=i[o];break}}else if(t===Jd.LAST_OBJECT)for(n=e;n;){if(4===(r=this.getNodeType(n))){a=n;break}n=this.getNodeParentId(n)}return a};var $d=16777216,ec=33554432,tc=16777215,nc=-1<<30,rc=5;It.prototype.getIndex=function(e){var t=this.dbIdToIndex[e];if(t)return t;t=this.nextNode++,this.nodes.push(e);for(var n=1;n<rc;n++)this.nodes.push(0);return this.dbIdToIndex[e]=t,t},It.prototype.setNode=function(e,t,n,r,a,i){var o=this.getIndex(e),s=o*rc,l=a.length,u=i&&i.length;u&&(l+=i.length),this.nodes[s+1]=t,this.nodes[s+2]=this.nextChild,this.nodes[s+3]=u?-l:l,this.nodes[s+4]=r;var f;for(f=0;f<a.length;f++)this.children[this.nextChild++]=this.getIndex(a[f]);if(u)for(f=0;f<i.length;f++)this.children[this.nextChild++]=-i[f]-1;this.nextChild>this.children.length&&console.error("Child index out of bounds -- should not happen"),this.processName(o,n)},It.prototype.processName=function(e,t){var n,r,a=-1,i=-1;if(t&&(i=t.lastIndexOf("]"),-1!==(a=t.lastIndexOf("["))&&-1!==i||(a=t.lastIndexOf(":"),i=t.length)),a>=0&&i>a){n=t.slice(0,a+1);var o=t.slice(a+1,i);(r=parseInt(o,10))&&r+""===o||(n=t,r=0)}else n=t,r=0;var s=this.s2i[n];void 0===s&&(this.strings.push(n),s=this.strings.length-1,this.s2i[n]=s),this.names[e]=s,this.nameSuffixes[e]=r},It.prototype.flatten=function(e,t,n,r,a,i){this.nodes=Ct(this.nodes),this.children=Ct(this.children),this.names=Ct(this.names),this.nameSuffixes=Ct(this.nameSuffixes),this.s2i=null},Dt.prototype.getNumNodes=function(e){return this.numNodes},Dt.prototype.getIndex=function(e){return this.dbIdToIndex[e]},Dt.prototype.name=function(e){var t=this.dbIdToIndex[e];if("number"==typeof t){var n=this.strings[this.names[t]],r=this.nameSuffixes[t];return r?"["===n.charAt(n.length-1)?n+r+"]":n+r:n}},Dt.prototype.getParentId=function(e){var t=this.dbIdToIndex[e];if("number"==typeof t)return this.nodes[t*rc+1]},Dt.prototype.getNodeFlags=function(e){var t=this.dbIdToIndex[e];if("number"==typeof t)return this.nodes[t*rc+4]},Dt.prototype.setNodeFlags=function(e,t){var n=this.dbIdToIndex[e];"number"==typeof n&&(this.nodes[n*rc+4]=t)},Dt.prototype.getNumChildren=function(e){var t=this.dbIdToIndex[e];if("number"!=typeof t)return 0;var n=this.nodes[t*rc+3];if(n>=0)return n;var r=this.nodes[t*rc+2];n=Math.abs(n);for(var a=0,i=0;i<n&&!(this.children[r+i]<0);i++)a++;return a},Dt.prototype.getNumFragments=function(e){var t=this.dbIdToIndex[e];if("number"!=typeof t)return 0;var n=this.nodes[t*rc+3];if(n>=0)return 0;for(var r=this.nodes[t*rc+2],a=0,i=(n=Math.abs(n))-1;i>=0&&!(this.children[r+i]>=0);i--)a++;return a},Dt.prototype.getNodeBox=function(e,t){var n=this.getIndex(e);if("number"==typeof n)for(var r=6*n,a=0;a<6;a++)t[a]=this.nodeBoxes[r+a];else t.makeEmpty()},Dt.prototype.getVisibleIds=function(){return this.visibleIds||(this.visibleIds=Object.keys(this.dbIdToIndex).map(function(e){return parseInt(e)})),this.visibleIds},Dt.prototype.enumNodeChildren=function(e,t){this.findNodeChild(e,function(){return t.apply(null,arguments),!1})},Dt.prototype.enumNodeFragments=function(e,t){this.findNodeFragment(e,function(){return t.apply(null,arguments),!1})},Dt.prototype.findNodeChild=function(e,t){var n=this.dbIdToIndex[e];if("number"==typeof n){var r=this.nodes[n*rc+2],a=this.nodes[n*rc+3];a=Math.abs(a);for(var i=0;i<a;i++){var o=this.children[r+i];if(o<0)break;if(t(this.nodes[o*rc+0],e,n))return e}}},Dt.prototype.findNodeFragment=function(e,t){var n=this.dbIdToIndex[e];if("number"==typeof n){var r=this.nodes[n*rc+2],a=this.nodes[n*rc+3];if(a<0){a=-a;for(var i=0;i<a;i++){var o=this.children[r+i];if(!(o>0)&&t(-o-1,e,n))return e}}}},Dt.prototype.computeBoxes=function(e){function t(e,t,n){var i=a.getIndex(e);r(e,i);for(var s=6*n,l=6*i,u=0;u<3;u++)o[s+u]>o[l+u]&&(o[s+u]=o[l+u]),o[s+u+3]<o[l+u+3]&&(o[s+u+3]=o[l+u+3])}function n(t,n,r){for(var a=6*t,i=6*r,s=0;s<3;s++)o[i+s]>e[a+s]&&(o[i+s]=e[a+s]),o[i+s+3]<e[a+s+3]&&(o[i+s+3]=e[a+s+3])}function r(e,r){var i=6*r;o[i]=o[i+1]=o[i+2]=1/0,o[i+3]=o[i+4]=o[i+5]=-1/0,a.getNumChildren(e)&&a.enumNodeChildren(e,t,!0),a.getNumFragments(e)&&a.enumNodeFragments(e,n)}var a=this,i=a.getIndex(a.rootId),o=a.nodeBoxes;r(a.rootId,i)},Nt.prototype.setLeftChild=function(e,t){this.nodesI[e*this.node_stride+6]=t},Nt.prototype.getLeftChild=function(e){return this.nodesI[e*this.node_stride+6]},Nt.prototype.setPrimStart=function(e,t){this.is_lean_node?this.nodesI[e*this.node_stride+6]=t:this.nodesI[e*this.node_stride+8]=t},Nt.prototype.getPrimStart=function(e){return this.is_lean_node?this.nodesI[e*this.node_stride+6]:this.nodesI[e*this.node_stride+8]},Nt.prototype.setPrimCount=function(e,t){this.nodesS[e*this.node_stride_short+14]=t},Nt.prototype.getPrimCount=function(e){return this.nodesS[e*this.node_stride_short+14]},Nt.prototype.setFlags=function(e,t,n,r){this.nodesS[e*this.node_stride_short+15]=r<<3|n<<2|3&t},Nt.prototype.getFlags=function(e){return this.nodesS[e*this.node_stride_short+15]},Nt.prototype.setBox0=function(e,t){var n=e*this.node_stride,r=this.nodesF;r[n]=t[0],r[n+1]=t[1],r[n+2]=t[2],r[n+3]=t[3],r[n+4]=t[4],r[n+5]=t[5]},Nt.prototype.getBoxThree=function(e,t){var n=e*this.node_stride,r=this.nodesF;t.min.x=r[n],t.min.y=r[n+1],t.min.z=r[n+2],t.max.x=r[n+3],t.max.y=r[n+4],t.max.z=r[n+5]},Nt.prototype.setBoxThree=function(e,t){var n=e*this.node_stride,r=this.nodesF;r[n]=t.min.x,r[n+1]=t.min.y,r[n+2]=t.min.z,r[n+3]=t.max.x,r[n+4]=t.max.y,r[n+5]=t.max.z},Nt.prototype.makeEmpty=function(e){var t=e*this.node_stride,n=this.nodesI;n[t+6]=-1,n[t+7]=0,this.is_lean_node||(n[t+8]=-1)},Nt.prototype.realloc=function(e){if(this.nodeCount+e>this.nodeCapacity){var t=0|3*this.nodeCapacity/2;t<this.nodeCount+e&&(t=this.nodeCount+e);var n=new ArrayBuffer(t*this.bytes_per_node),r=new Int32Array(n);r.set(this.nodesI),this.nodeCapacity=t,this.nodesRaw=n,this.nodesF=new Float32Array(n),this.nodesI=r,this.nodesS=new Uint16Array(n)}},Nt.prototype.nextNodes=function(e){this.realloc(e);var t=this.nodeCount;this.nodeCount+=e;for(var n=0;n<e;n++)this.makeEmpty(t+n);return t},Nt.prototype.getRawData=function(){return this.nodesRaw.slice(0,this.nodeCount*this.bytes_per_node)};var ac=3,ic=1e-5,oc=1e-5,sc=15,lc=16,uc=function(){function e(e,t,n,r){e[t]=.5*(n[r]+n[r+3]),e[t+1]=.5*(n[r+1]+n[r+4]),e[t+2]=.5*(n[r+2]+n[r+5])}function t(e,t,n){e[0]>t[n]&&(e[0]=t[n]),e[3]<t[n]&&(e[3]=t[n]),e[1]>t[n+1]&&(e[1]=t[n+1]),e[4]<t[n+1]&&(e[4]=t[n+1]),e[2]>t[n+2]&&(e[2]=t[n+2]),e[5]<t[n+2]&&(e[5]=t[n+2])}function n(e,t,n){e[0]>t[n]&&(e[0]=t[n]),e[1]>t[n+1]&&(e[1]=t[n+1]),e[2]>t[n+2]&&(e[2]=t[n+2]),e[3]<t[n+3]&&(e[3]=t[n+3]),e[4]<t[n+4]&&(e[4]=t[n+4]),e[5]<t[n+5]&&(e[5]=t[n+5])}function r(e,t){e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]>t[2]&&(e[2]=t[2]),e[3]<t[3]&&(e[3]=t[3]),e[4]<t[4]&&(e[4]=t[4]),e[5]<t[5]&&(e[5]=t[5])}function a(e,t,n,r){for(var a=0;a<3;a++)e[t+a]=n[r+3+a]-n[r+a]}function i(e,t){e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5]}function o(e){e[0]=m,e[1]=m,e[2]=m,e[3]=-m,e[4]=-m,e[5]=-m}function s(e){var t=e[3]-e[0],n=e[4]-e[1],r=e[5]-e[2];return t<0||n<0||r<0?0:2*(t*n+n*r+r*t)}function l(){this.vb_left=new Float32Array(6),this.vb_right=new Float32Array(6),this.cb_left=new Float32Array(6),this.cb_right=new Float32Array(6),this.num_left=0,this.best_split=-1,this.best_cost=-1,this.num_bins=-1}function u(){this.box_bbox=new Float32Array(6),this.box_centroid=new Float32Array(6),this.num_prims=0}function f(){this.BL=new Float32Array(6),this.CL=new Float32Array(6),this.NL=0,this.AL=0}function d(e,r,a,i,o,s,l){for(var u=e.centroids,f=e.primitives,d=e.finfo.boxes,c=e.finfo.boxStride,p=l*(1-oc)/s[i],h=o[i],m=e.sort_prims,_=r;_<=a;_++){var g=0|f[_],y=0|p*(u[3*g+i]-h);y<0?y=0:y>=l&&(y=l-1),m[_]=y,v[y].num_prims++,n(v[y].box_bbox,d,g*c),t(v[y].box_centroid,u,3*g)}}function c(e,t,n,a,o,l,u){if(l[a]<e.scene_epsilon)u.best_cost=1/0;else{var f=lc;f>n-t+1&&(f=n-t+1);var c;for(c=0;c<f;c++)v[c].reset();for(c=0;c<f-1;c++)g[c].reset();u.num_bins=f,d(e,t,n,a,o,l,f),i(g[0].BL,v[0].box_bbox),i(g[0].CL,v[0].box_centroid),g[0].AL=s(g[0].BL),g[0].NL=v[0].num_prims;var p;for(c=1;c<f-1;c++){p=v[c];var h=g[c];i(h.BL,g[c-1].BL),r(h.BL,p.box_bbox),h.AL=s(h.BL),i(h.CL,g[c-1].CL),r(h.CL,p.box_centroid),h.NL=g[c-1].NL+p.num_prims}i(y,v[c=f-1].box_bbox),i(x,v[c].box_centroid);var m=s(y),_=v[c].num_prims,b=c,w=m*_+g[c-1].AL*g[c-1].NL;for(i(u.vb_right,y),i(u.cb_right,v[c].box_centroid),i(u.vb_left,g[c-1].BL),i(u.cb_left,g[c-1].CL),u.num_left=g[c-1].NL,c-=1;c>=1;c--){p=v[c],r(y,p.box_bbox),r(x,p.box_centroid);var M=(m=s(y))*(_+=p.num_prims)+g[c-1].AL*g[c-1].NL;M<=w&&(w=M,b=c,i(u.vb_right,y),i(u.cb_right,x),i(u.vb_left,g[c-1].BL),i(u.cb_left,g[c-1].CL),u.num_left=g[c-1].NL)}u.best_split=b,u.best_cost=w}}function p(e,t,n,r,a,i,o){var s,l,u=e.primitives,f=e.sort_prims,d=0,c=0|t,p=0|o.best_split;for(s=t;s<=n;s++){var h=0|u[s];f[s]<p?u[c++]=h:f[d++]=h}for(l=0;l<d;l++)u[c+l]=f[l]}function h(e,n,r,i,s,l,u,f){var d=e.primitives,c=e.centroids,p=s-i+1;p>e.frags_per_inner_node&&(p=e.frags_per_inner_node),p>f&&(p=f),n.setPrimStart(r,i),n.setPrimCount(r,p),i+=p,o(l);for(var h=i;h<=s;h++)t(l,c,3*d[h]);a(u,0,l,0);var m=0;return u[1]>u[0]&&(m=1),u[2]>u[m]&&(m=2),m}var m=1/0;l.prototype.reset=function(){this.num_left=0,this.best_split=-1,this.best_cost=-1,this.num_bins=-1},u.prototype.reset=function(){this.num_prims=0,o(this.box_bbox),o(this.box_centroid)},f.prototype.reset=function(){this.NL=0,this.AL=0,o(this.BL),o(this.CL)};var _,v=[];for(_=0;_<lc;_++)v.push(new u);var g=[];for(_=0;_<lc-1;_++)g.push(new f);var y=new Float32Array(6),x=new Float32Array(6),b=new Float32Array(3);return{bvh_subdivide:function(e,t,n,r,i,o,s,u){a(b,0,o,0);var f=e.nodes,d=s?e.frags_per_leaf_node_transparent:e.frags_per_leaf_node,m=s?e.frags_per_inner_node_transparent:e.frags_per_inner_node,_=e.max_polys_per_node,v=0;b[1]>b[0]&&(v=1),b[2]>b[v]&&(v=2),f.setBox0(t,i);var g=0,y=0,x=r-n+1;if(e.finfo.hasPolygonCounts&&e.frags_per_inner_node)for(var w=x<=e.frags_per_inner_node?r:n+e.frags_per_inner_node-1,M=n;M<=w&&(g+=e.finfo.getPolygonCount(e.primitives[M]),y++,!(g>_));M++);if(x<=d&&g<_||1===x||u>sc||b[v]<e.scene_epsilon)return f.setLeftChild(t,-1),f.setPrimStart(t,n),f.setPrimCount(t,r-n+1),void f.setFlags(t,0,0,s?1:0);m&&(v=h(e,f,t,n,r,o,b,y),n+=f.getPrimCount(t));var S=new l;if(c(e,n,r,v,o,b,S),S.num_bins<0)f.setPrimCount(t,f.getPrimCount(t)+r-n+1);else{p(e,n,r,v,o,b,S);var T=f.nextNodes(2),A=.5*(S.vb_left[3+v]+S.vb_left[v]),E=.5*(S.vb_right[3+v]+S.vb_right[v]);f.setFlags(t,v,A<E?0:1,s?1:0),f.setLeftChild(t,T),e.recursion_stack.push([e,T+1,n+S.num_left,r,S.vb_right,S.cb_right,s,u+1]),e.recursion_stack.push([e,T,n,n+S.num_left-1,S.vb_left,S.cb_left,s,u+1])}},compute_boxes:function(r){var i=r.boxv_o,s=r.boxc_o,l=r.boxv_t,u=r.boxc_t;o(i),o(s),o(l),o(u);for(var f=r.centroids,d=r.finfo.boxes,c=r.finfo.boxStride,p=0,h=r.prim_count;p<h;p++){var m=r.primitives[p];e(f,3*m,d,c*m),p>=r.first_transparent?(t(u,f,3*m),n(l,d,c*m)):(t(s,f,3*m),n(i,d,c*m))}a(b,0,r.boxv_o,0);var _=Math.max(b[0],b[1],b[2]);r.scene_epsilon=ic*_},box_area:function(e,t){var n=e[t+3]-e[t],r=e[t+4]-e[t+1],a=e[t+5]-e[t+2];return n<0||r<0||a<0?0:2*(n*r+r*a+a*n)}}}();Ot.prototype.getCount=function(){return this.count},Ot.prototype.isTransparent=function(e){return!(!this.materialDefs||!this.materialDefs[this.materials[e]])&&this.materialDefs[this.materials[e]].transparent},Ot.prototype.getPolygonCount=function(e){return this.polygonCounts[e]},Ut.prototype.sortPrimitives=function(){var e,t,n=new Float32Array(this.work_buf),r=this.primitives,a=0;for(e=0,t=this.prim_count;e<t;e++){r[e]=e;var i=this.finfo.isTransparent(e);i&&a++,n[e]=uc.box_area(this.finfo.boxes,this.finfo.boxStride*e),i&&(n[e]=-n[e])}Array.prototype.sort.call(this.primitives,function(e,t){return n[t]-n[e]}),this.first_transparent=this.prim_count-a},Ut.prototype.build=function(e){function t(t,n){e.hasOwnProperty(t)?r[t]=e[t]:r[t]=n}var n=e&&!!e.useSlimNodes,r=this;if(n)t("frags_per_leaf_node",1),t("frags_per_inner_node",0),t("frags_per_leaf_node_transparent",1),t("frags_per_inner_node_transparent",0),t("max_polys_per_node",1/0);else{var a=e.isWeakDevice?.5:1;t("frags_per_leaf_node",0|32*a),t("frags_per_inner_node",0|this.frags_per_leaf_node),t("frags_per_leaf_node_transparent",this.frags_per_leaf_node),t("frags_per_inner_node_transparent",0),t("max_polys_per_node",0|1e4*a)}if(this.nodes&&this.nodes.is_lean_node==n)this.nodes.nodeCount=0;else{for(var i=this.prim_count/this.frags_per_leaf_node,o=1;o<i;)o*=2;this.nodes=new Nt(o,!!e&&e.useSlimNodes)}this.sortPrimitives(),uc.compute_boxes(this);var s=this.nodes.nextNodes(2);uc.bvh_subdivide(this,s,0,this.first_transparent-1,this.boxv_o,this.boxc_o,!1,0);for(var l;this.recursion_stack.length;)l=this.recursion_stack.pop(),uc.bvh_subdivide(l[0],l[1],l[2],l[3],l[4],l[5],l[6],l[7]);for(uc.bvh_subdivide(this,s+1,this.first_transparent,this.prim_count-1,this.boxv_t,this.boxc_t,!0,0);this.recursion_stack.length;)l=this.recursion_stack.pop(),uc.bvh_subdivide(l[0],l[1],l[2],l[3],l[4],l[5],l[6],l[7])};var fc={};!function(e){e[e.UNKNOWN_FAILURE=1]="UNKNOWN_FAILURE",e[e.BAD_DATA=2]="BAD_DATA",e[e.NETWORK_FAILURE=3]="NETWORK_FAILURE",e[e.NETWORK_ACCESS_DENIED=4]="NETWORK_ACCESS_DENIED",e[e.NETWORK_FILE_NOT_FOUND=5]="NETWORK_FILE_NOT_FOUND",e[e.NETWORK_SERVER_ERROR=6]="NETWORK_SERVER_ERROR",e[e.NETWORK_UNHANDLED_RESPONSE_CODE=7]="NETWORK_UNHANDLED_RESPONSE_CODE",e[e.BROWSER_WEBGL_NOT_SUPPORTED=8]="BROWSER_WEBGL_NOT_SUPPORTED",e[e.BAD_DATA_NO_VIEWABLE_CONTENT=9]="BAD_DATA_NO_VIEWABLE_CONTENT",e[e.BROWSER_WEBGL_DISABLED=10]="BROWSER_WEBGL_DISABLED",e[e.BAD_DATA_MODEL_IS_EMPTY=11]="BAD_DATA_MODEL_IS_EMPTY",e[e.RTC_ERROR=12]="RTC_ERROR",e[e.UNSUPORTED_FILE_EXTENSION=13]="UNSUPORTED_FILE_EXTENSION",e[e.VIEWER_INTERNAL_ERROR=14]="VIEWER_INTERNAL_ERROR"}(e.ErrorCodes||(e.ErrorCodes={}));!function(){function t(){sd(this,t),this.callback=function(e,t){},this.level=-1,this.setLevel(e.LogLevels.ERROR)}ld(t,[{key:"initialize",value:function(e){e&&e.eventCallback&&(this.callback=e.callback)}},{key:"shutdown",value:function(){}},{key:"track",value:function(e){}},{key:"logToADP",value:function(e){return!1}},{key:"updateRuntimeStats",value:function(e){}},{key:"reportRuntimeStats",value:function(){}},{key:"setLevel",value:function(t){function n(){}if(this.level!==t){this.level=t;var r=this;this.debug=t>=e.LogLevels.DEBUG?console.log.bind(console):n,this.log=t>=e.LogLevels.LOG?console.log.bind(console):n,this.info=t>=e.LogLevels.INFO?console.info.bind(console):n,this.warn=t>=e.LogLevels.WARNING?console.warn.bind(console):n,this.error=t>=e.LogLevels.ERROR?function(){var e=Array.prototype.slice.call(arguments).join(" ");r.callback({category:"error",message:e},{adp:!1}),console.error.apply(console,arguments)}:n}}}])}();var dc=!0,cc={};(function(){function e(e){throw e}function t(e,t){var n=e.split("."),r=d;!(n[0]in r)&&r.execScript&&r.execScript("var "+n[0]);for(var a;n.length&&(a=n.shift());)n.length||t===f?r=r[a]?r[a]:r[a]={}:r[a]=t}function n(e,t,n){var r,a="number"==typeof t?t:t=0,i="number"==typeof n?n:e.length;for(r=-1,a=7&i;a--;++t)r=r>>>8^h[255&(r^e[t])];for(a=i>>3;a--;t+=8)r=r>>>8^h[255&(r^e[t])],r=r>>>8^h[255&(r^e[t+1])],r=r>>>8^h[255&(r^e[t+2])],r=r>>>8^h[255&(r^e[t+3])],r=r>>>8^h[255&(r^e[t+4])],r=r>>>8^h[255&(r^e[t+5])],r=r>>>8^h[255&(r^e[t+6])],r=r>>>8^h[255&(r^e[t+7])];return(4294967295^r)>>>0}function r(){}function a(e){var t,n,r,a,i,o,s,l,u,f=e.length,d=0,p=Number.POSITIVE_INFINITY;for(l=0;l<f;++l)e[l]>d&&(d=e[l]),e[l]<p&&(p=e[l]);for(t=1<<d,n=new(c?Uint32Array:Array)(t),r=1,a=0,i=2;r<=d;){for(l=0;l<f;++l)if(e[l]===r){for(o=0,s=a,u=0;u<r;++u)o=o<<1|1&s,s>>=1;for(u=o;u<t;u+=i)n[u]=r<<16|l;++a}++r,a<<=1,i<<=1}return[n,d,p]}function i(t,n){switch(this.i=[],this.j=32768,this.d=this.f=this.c=this.n=0,this.input=c?new Uint8Array(t):t,this.o=!1,this.k=y,this.w=!1,!n&&(n={})||(n.index&&(this.c=n.index),n.bufferSize&&(this.j=n.bufferSize),n.bufferType&&(this.k=n.bufferType),n.resize&&(this.w=n.resize)),this.k){case g:this.a=32768,this.b=new(c?Uint8Array:Array)(32768+this.j+258);break;case y:this.a=0,this.b=new(c?Uint8Array:Array)(this.j),this.e=this.D,this.q=this.A,this.l=this.C;break;default:e(Error("invalid inflate mode"))}}function o(t,n){for(var r,a=t.f,i=t.d,o=t.input,s=t.c;i<n;)(r=o[s++])===f&&e(Error("input buffer is broken")),a|=r<<i,i+=8;return r=a&(1<<n)-1,t.f=a>>>n,t.d=i-n,t.c=s,r}function s(e,t){for(var n,r,a,i=e.f,o=e.d,s=e.input,l=e.c,u=t[0],d=t[1];o<d&&(n=s[l++])!==f;)i|=n<<o,o+=8;return r=u[i&(1<<d)-1],a=r>>>16,e.f=i>>a,e.d=o-a,e.c=l,65535&r}function l(e){function t(e,t,n){var r,a,i,l;for(l=0;l<e;)switch(r=s(this,t)){case 16:for(i=3+o(this,2);i--;)n[l++]=a;break;case 17:for(i=3+o(this,3);i--;)n[l++]=0;a=0;break;case 18:for(i=11+o(this,7);i--;)n[l++]=0;a=0;break;default:a=n[l++]=r}return n}var n,r,i,l,u=o(e,5)+257,f=o(e,5)+1,d=o(e,4)+4,p=new(c?Uint8Array:Array)(M.length);for(l=0;l<d;++l)p[M[l]]=o(e,3);n=a(p),r=new(c?Uint8Array:Array)(u),i=new(c?Uint8Array:Array)(f),e.l(a(t.call(e,u,n,r)),a(t.call(e,f,n,i)))}function u(e){this.input=e,this.c=0,this.m=[],this.s=!1}var f=void 0,d=this,c="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array;new(c?Uint8Array:Array)(256);var p=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117],h=c?new Uint32Array(p):p;r.prototype.getName=function(){return this.name},r.prototype.getData=function(){return this.data},r.prototype.G=function(){return this.H},t("Zlib.GunzipMember",r),t("Zlib.GunzipMember.prototype.getName",r.prototype.getName),t("Zlib.GunzipMember.prototype.getData",r.prototype.getData),t("Zlib.GunzipMember.prototype.getMtime",r.prototype.G);var m,_=[];for(m=0;288>m;m++)switch(!0){case 143>=m:_.push([m+48,8]);break;case 255>=m:_.push([m-144+400,9]);break;case 279>=m:_.push([m-256+0,7]);break;case 287>=m:_.push([m-280+192,8]);break;default:e("invalid literal: "+m)}var v=function(){var t,n,r=[];for(t=3;258>=t;t++)n=function(t){switch(!0){case 3===t:return[257,t-3,0];case 4===t:return[258,t-4,0];case 5===t:return[259,t-5,0];case 6===t:return[260,t-6,0];case 7===t:return[261,t-7,0];case 8===t:return[262,t-8,0];case 9===t:return[263,t-9,0];case 10===t:return[264,t-10,0];case 12>=t:return[265,t-11,1];case 14>=t:return[266,t-13,1];case 16>=t:return[267,t-15,1];case 18>=t:return[268,t-17,1];case 22>=t:return[269,t-19,2];case 26>=t:return[270,t-23,2];case 30>=t:return[271,t-27,2];case 34>=t:return[272,t-31,2];case 42>=t:return[273,t-35,3];case 50>=t:return[274,t-43,3];case 58>=t:return[275,t-51,3];case 66>=t:return[276,t-59,3];case 82>=t:return[277,t-67,4];case 98>=t:return[278,t-83,4];case 114>=t:return[279,t-99,4];case 130>=t:return[280,t-115,4];case 162>=t:return[281,t-131,5];case 194>=t:return[282,t-163,5];case 226>=t:return[283,t-195,5];case 257>=t:return[284,t-227,5];case 258===t:return[285,t-258,0];default:e("invalid length: "+t)}}(t),r[t]=n[2]<<24|n[1]<<16|n[0];return r}();c&&new Uint32Array(v);var g=0,y=1;i.prototype.g=function(){for(;!this.o;){var t=o(this,3);switch(1&t&&(this.o=!0),t>>>=1){case 0:var n=this.input,r=this.c,a=this.b,i=this.a,s=f,u=f,d=f,p=a.length,h=f;switch(this.d=this.f=0,(s=n[r++])===f&&e(Error("invalid uncompressed block header: LEN (first byte)")),u=s,(s=n[r++])===f&&e(Error("invalid uncompressed block header: LEN (second byte)")),u|=s<<8,(s=n[r++])===f&&e(Error("invalid uncompressed block header: NLEN (first byte)")),d=s,(s=n[r++])===f&&e(Error("invalid uncompressed block header: NLEN (second byte)")),d|=s<<8,u===~d&&e(Error("invalid uncompressed block header: length verify")),r+u>n.length&&e(Error("input buffer is broken")),this.k){case g:for(;i+u>a.length;){if(h=p-i,u-=h,c)a.set(n.subarray(r,r+h),i),i+=h,r+=h;else for(;h--;)a[i++]=n[r++];this.a=i,a=this.e(),i=this.a}break;case y:for(;i+u>a.length;)a=this.e({t:2});break;default:e(Error("invalid inflate mode"))}if(c)a.set(n.subarray(r,r+u),i),i+=u,r+=u;else for(;u--;)a[i++]=n[r++];this.c=r,this.a=i,this.b=a;break;case 1:this.l(O,F);break;case 2:l(this);break;default:e(Error("unknown BTYPE: "+t))}}return this.q()};var x,b,w=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],M=c?new Uint16Array(w):w,S=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],T=c?new Uint16Array(S):S,A=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],E=c?new Uint8Array(A):A,R=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],L=c?new Uint16Array(R):R,P=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],I=c?new Uint8Array(P):P,C=new(c?Uint8Array:Array)(288);for(x=0,b=C.length;x<b;++x)C[x]=143>=x?8:255>=x?9:279>=x?7:8;var D,N,O=a(C),U=new(c?Uint8Array:Array)(30);for(D=0,N=U.length;D<N;++D)U[D]=5;var F=a(U);i.prototype.l=function(e,t){var n=this.b,r=this.a;this.r=e;for(var a,i,l,u,f=n.length-258;256!==(a=s(this,e));)if(256>a)r>=f&&(this.a=r,n=this.e(),r=this.a),n[r++]=a;else for(u=T[i=a-257],0<E[i]&&(u+=o(this,E[i])),a=s(this,t),l=L[a],0<I[a]&&(l+=o(this,I[a])),r>=f&&(this.a=r,n=this.e(),r=this.a);u--;)n[r]=n[r++-l];for(;8<=this.d;)this.d-=8,this.c--;this.a=r},i.prototype.C=function(e,t){var n=this.b,r=this.a;this.r=e;for(var a,i,l,u,f=n.length;256!==(a=s(this,e));)if(256>a)r>=f&&(n=this.e(),f=n.length),n[r++]=a;else for(u=T[i=a-257],0<E[i]&&(u+=o(this,E[i])),a=s(this,t),l=L[a],0<I[a]&&(l+=o(this,I[a])),r+u>f&&(n=this.e(),f=n.length);u--;)n[r]=n[r++-l];for(;8<=this.d;)this.d-=8,this.c--;this.a=r},i.prototype.e=function(){var e,t,n=new(c?Uint8Array:Array)(this.a-32768),r=this.a-32768,a=this.b;if(c)n.set(a.subarray(32768,n.length));else for(e=0,t=n.length;e<t;++e)n[e]=a[e+32768];if(this.i.push(n),this.n+=n.length,c)a.set(a.subarray(r,r+32768));else for(e=0;32768>e;++e)a[e]=a[r+e];return this.a=32768,a},i.prototype.D=function(e){var t,n,r,a,i=this.input.length/this.c+1|0,o=this.input,s=this.b;return e&&("number"==typeof e.t&&(i=e.t),"number"==typeof e.z&&(i+=e.z)),2>i?(n=(o.length-this.c)/this.r[2],a=n/2*258|0,r=a<s.length?s.length+a:s.length<<1):r=s.length*i,c?(t=new Uint8Array(r)).set(s):t=s,this.b=t},i.prototype.q=function(){var e,t,n,r,a,i=0,o=this.b,s=this.i,l=new(c?Uint8Array:Array)(this.n+(this.a-32768));if(0===s.length)return c?this.b.subarray(32768,this.a):this.b.slice(32768,this.a);for(t=0,n=s.length;t<n;++t)for(r=0,a=(e=s[t]).length;r<a;++r)l[i++]=e[r];for(t=32768,n=this.a;t<n;++t)l[i++]=o[t];return this.i=[],this.buffer=l},i.prototype.A=function(){var e,t=this.a;return c?this.w?(e=new Uint8Array(t)).set(this.b.subarray(0,t)):e=this.b.subarray(0,t):(this.b.length>t&&(this.b.length=t),e=this.b),this.buffer=e},u.prototype.F=function(){return this.s||this.g(),this.m.slice()},u.prototype.g=function(){for(var t=this.input.length;this.c<t;){var a=new r,o=f,s=f,l=f,u=f,d=f,p=f,h=f,m=f,_=f,v=this.input,g=this.c;switch(a.u=v[g++],a.v=v[g++],(31!==a.u||139!==a.v)&&e(Error("invalid file signature:"+a.u+","+a.v)),a.p=v[g++],a.p){case 8:break;default:e(Error("unknown compression method: "+a.p))}if(a.h=v[g++],m=v[g++]|v[g++]<<8|v[g++]<<16|v[g++]<<24,a.H=new Date(1e3*m),a.N=v[g++],a.M=v[g++],0<(4&a.h)&&(a.I=v[g++]|v[g++]<<8,g+=a.I),0<(8&a.h)){for(h=[],p=0;0<(d=v[g++]);)h[p++]=String.fromCharCode(d);a.name=h.join("")}if(0<(16&a.h)){for(h=[],p=0;0<(d=v[g++]);)h[p++]=String.fromCharCode(d);a.J=h.join("")}0<(2&a.h)&&(a.B=65535&n(v,0,g),a.B!==(v[g++]|v[g++]<<8)&&e(Error("invalid header crc16"))),o=v[v.length-4]|v[v.length-3]<<8|v[v.length-2]<<16|v[v.length-1]<<24,v.length-g-4-4<512*o&&(u=o),s=new i(v,{index:g,bufferSize:u}),a.data=l=s.g(),g=s.c,a.K=_=(v[g++]|v[g++]<<8|v[g++]<<16|v[g++]<<24)>>>0,n(l,f,f)!==_&&e(Error("invalid CRC-32 checksum: 0x"+n(l,f,f).toString(16)+" / 0x"+_.toString(16))),a.L=o=(v[g++]|v[g++]<<8|v[g++]<<16|v[g++]<<24)>>>0,(4294967295&l.length)!==o&&e(Error("invalid input size: "+(4294967295&l.length)+" / "+o)),this.m.push(a),this.c=g}this.s=!0;var y,x,b,w=this.m,M=0,S=0;for(y=0,x=w.length;y<x;++y)S+=w[y].data.length;if(c)for(b=new Uint8Array(S),y=0;y<x;++y)b.set(w[y].data,M),M+=w[y].data.length;else{for(b=[],y=0;y<x;++y)b[y]=w[y].data;b=Array.prototype.concat.apply([],b)}return b},t("Zlib.Gunzip",u),t("Zlib.Gunzip.prototype.decompress",u.prototype.g),t("Zlib.Gunzip.prototype.getMembers",u.prototype.F)}).call(cc);var pc=cc.Zlib,hc="undefined"!=typeof self&&"undefined"==typeof window,mc={endpoint:{HTTP_REQUEST_HEADERS:{},getApiEndpoint:function(){return null},getManifestApi:function(e,t,n){return null},getItemApi:function(e,t,n){return null},getThumbnailApi:function(e,t,n){return null},makeOssPath:function(e,t,n){return null},getUseCredentials:function(){return!1},pathRequiresCredentials:function(e){return!1},getDomainParam:function(){return""},setUseCredentials:function(e){}}};mc.setEndpoint=function(e){this.endpoint=e};var _c=!1;mc.simplifyPath=Gt,mc.OSS_PREFIX="urn:adsk.objects:os.object:",mc.getDirectOSSUrl=function(e,t){var n=t.indexOf(mc.OSS_PREFIX);if(-1!==n){var r=t.substr(n+mc.OSS_PREFIX.length),a=r.substr(0,r.indexOf("/")),i=r.substr(r.indexOf("/")+1);return i=Gt(i),this.endpoint.makeOssPath(e,a,i)}},mc.generateUrl=function(e,t,n){if(n=n||"",Jl()&&!Ht(e,n))return n;var r=(n=Gt(n)).indexOf("urn:"),a=n.indexOf("?");if(n=-1!=r?-1!==a?n.slice(0,r)+encodeURIComponent(n.slice(r,a))+n.slice(a):n.slice(0,r)+encodeURIComponent(n.slice(r)):encodeURI(n),!t||0!==decodeURIComponent(n).indexOf("urn:"))return Ht(null,n)?n:e+n;switch("items"!==t&&(n=n.substr(6)),t){case"items":return this.endpoint.getItemApi(e,n);case"bubbles":return this.endpoint.getManifestApi(e,n);case"thumbnails":return this.endpoint.getThumbnailApi(e,n)}},Jl()?function(){function t(e,t,n,i){function o(e){if("json"===i.responseType)try{return JSON.parse(e.toString("utf8"))}catch(e){n(e)}return e}0===e.indexOf("file://")&&(e=e.substr(7)),r.readFile(e,function(r,s){r?n(0,0,{httpStatusText:r,url:e}):31===s[0]&&139===s[1]?a.gunzip(s,null,function(r,a){r?n(0,0,{httpStatusText:r,url:e}):(a=o(a),i.ondata&&i.ondata(a),t(a))}):(s=o(s),i.ondata&&i.ondata(s),t(s))})}function n(e,t){return"gzip"===e.headers["content-encoding"]||(!!t.endsWith(".json.gz")||(!!t.endsWith("FragmentList.pack")||(!!t.endsWith("LightList.bin")||(!!t.endsWith("CameraList.bin")||(!!t.endsWith("CameraDefinitions.bin")||!!t.endsWith("LightDefinitions.bin"))))))}var r=require("fs"),a=require("zlib"),i=require("https"),o=require("http"),s=require("url"),l=new i.Agent({maxSockets:10});mc.rawGet=function(r,u,f,d,c,p){if(p=p||{},f=mc.generateUrl(r,u,f),Ht(r,f)){if(p.queryParams){var h=-1===f.indexOf("?")?"?":"&";f=f+h+p.queryParams}var m=s.parse(f),_={host:m.hostname,port:m.port,method:p.method||"GET",path:m.path,headers:{},retryCount:0};if(_.host.endsWith(".api.autodesk.com")&&(_.path.startsWith("/derivativeservice")||_.path.startsWith("/modelderivative"))&&(_.agent=l),p.headers)for(var v in p.headers)_.headers[v]=p.headers[v];_.headers["accept-encoding"]||(_.headers["accept-encoding"]="gzip, deflate"),p.range&&(_.headers.Range="bytes="+p.range.min+"-"+p.range.max),(p.ondata||p.onprogress)&&(p.responseType="arraybuffer");var g=("https:"===m.protocol?i:o).request(_,function(t){var r=!(t.statusCode>=200&&t.statusCode<400),i=t;r||!n(t,m.pathname)||p.skipDecompress||(i=t.pipe(a.createGunzip())),"json"!==p.responseType&&"text"!==p.responseType&&p.responseType||i.setEncoding("utf8");var o,s=[];i.on("data",function(e){if(p.onprogress)return o=o?Buffer.concat([o,e]):e,void p.onprogress(o);s.push(e),p.ondata&&p.ondata(e)}),i.on("end",function(){if(t.statusCode>=200&&t.statusCode<400){if("json"===p.responseType){var n=JSON.parse(s.join(""));return void d(n)}if("text"===p.responseType||""===p.responseType){var r=s.join("");return void d(r)}var i=p.onprogress?o:Buffer.concat(s);if(!p.skipDecompress&&31===i[0]&&139===i[1]){e.logger.warn("An LMV resource ("+f+") was double compressed, or Content-Encoding header missing");try{i=a.gunzipSync(i)}catch(t){c(e.ErrorCodes.BAD_DATA,"Malformed data received when requesting file",{url:f,exception:t.toString(),stack:t.stack})}}d(i)}else c&&c(t.statusCode,t.statusMessage,{url:f})})});g.on("error",function(e){c&&c(e.code,e.message,{url:f})}),p.postData&&g.write(p.postData),g.end()}else t(f,d,c,p)}}():mc.rawGet=function(t,n,r,a,i,o){function s(e){i&&i(d.status,d.statusText,{url:r})}function l(e){if("json"===o.responseType)try{if(e instanceof Uint8Array)return zt(e);if("string"==typeof e)return JSON.parse(e)}catch(e){}return e}function u(t){if(200===d.status||206===d.status)if(d.response&&d.response instanceof ArrayBuffer){var n=new Uint8Array(d.response);if(!o.skipDecompress&&31===n[0]&&139===n[1]){_c||(_c=!0,e.logger.warn("An LMV resource ("+r+") was not uncompressed by the browser. This hurts performance. Check the Content-Encoding header returned by the server and check whether you're getting double-compressed streams. The warning prints only once but it's likely the problem affects multiple resources."));try{n=new pc.Gunzip(n).decompress()}catch(t){i(e.ErrorCodes.BAD_DATA,"Malformed data received when requesting file",{url:r,exception:t.toString(),stack:t.stack})}}a&&a(l(n))}else{var u=d.response;u||o.responseType&&"text"!==o.responseType||(u=d.responseText),a&&a(l(u))}else s(t)}if(o=o||{},r=mc.generateUrl(t,n,r),o.queryParams){var f=-1===r.indexOf("?")?"?":"&";r=r+f+o.queryParams}var d=new XMLHttpRequest;try{var c=!o.hasOwnProperty("asynchronous")||o.asynchronous;if(d.open(o.method||(o.noBody?"HEAD":"GET"),r,c),o.hasOwnProperty("responseType")&&(d.responseType=o.responseType),d.withCredentials=!0,o.hasOwnProperty("withCredentials")&&(d.withCredentials=o.withCredentials),o.range&&d.setRequestHeader("Range","bytes="+o.range.min+"-"+o.range.max),o.headers)for(var p in o.headers)d.setRequestHeader(p,o.headers[p]),"authorization"===p.toLocaleLowerCase()&&(d.withCredentials=!1);c&&(d.onload=u,d.onerror=s,d.ontimeout=s,(o.ondata||o.onprogress)&&(d.overrideMimeType("text/plain; charset=x-user-defined"),o._dlProgress={streamOffset:0},d.onreadystatechange=function(){if(d.readyState>2&&200===d.status)if(o.ondata){var e=d.responseText;if(o._dlProgress.streamOffset>=e.length)return;var t=kt(e,o._dlProgress.streamOffset);o._dlProgress.streamOffset=e.length,o.ondata(t)}else o.onprogress&&o.onprogress(d.responseText)})),d.send(o.postData),o.skipAssetCallback||(hc?self.postMessage({assetRequest:[r,o.headers,null]}):e.assets&&e.assets.push([r,o.headers,null])),c||u()}catch(e){i(d.status,d.statusText,{url:r,exception:e})}},mc.defaultFailureCallback=function(t,n,r){403==t?this.raiseError(e.ErrorCodes.NETWORK_ACCESS_DENIED,"Access denied to remote resource",{url:r.url,httpStatus:t,httpStatusText:n}):404==t?this.raiseError(e.ErrorCodes.NETWORK_FILE_NOT_FOUND,"Remote resource not found",{url:r.url,httpStatus:t,httpStatusText:n}):t>=500&&t<600?this.raiseError(e.ErrorCodes.NETWORK_SERVER_ERROR,"Server error when accessing resource",{url:r.url,httpStatus:t,httpStatusText:n}):r.exception?this.raiseError(e.ErrorCodes.NETWORK_FAILURE,"Network failure",{url:r.url,exception:r.exception.toString(),stack:r.exception.stack}):this.raiseError(e.ErrorCodes.NETWORK_UNHANDLED_RESPONSE_CODE,"Unhandled response code from server",{url:r.url,httpStatus:t,httpStatusText:n,data:r})},mc.getItem=function(e,t,n,r,a){Wt(e,a=a||{}),mc.rawGet(e.endpoint,"items",t,n,r,a)},mc.getManifest=function(e,t,n,r,a){(a=a||{}).hasOwnProperty("responseType")||(a.responseType="json"),Wt(e,a),mc.rawGet(e.endpoint,"bubbles",t,n,r,a)},mc.getThumbnail=function(e,t,n,r,a){Wt(e,a=a||{});var i=a.queryParams||"",o=[];if(-1===i.indexOf("guid=")&&o.push("guid="+encodeURIComponent(a.guid)),-1===i.indexOf("role=")){var s=a.role||"rendered";o.push("role="+s)}if(-1===i.indexOf("width=")){l=a.size||400;o.push("width="+l)}if(-1===i.indexOf("height=")){var l=a.size||400;o.push("height="+l)}-1===i.indexOf("acmsession=")&&a.acmsession&&o.push("acmsession="+a.acmsession);var u=o.join("&");a.queryParams?a.queryParams=a.queryParams+"&"+u:a.queryParams=u,mc.rawGet(e.endpoint,"thumbnails",t,n,r,a)},mc.getACMSession=function(e,t,n,r){var a,i={};for(var o in t)"oauth2AccessToken"===o?a=t[o]:-1!==o.indexOf("x-ads-acm")&&(i[o]=t[o]);i.application="autodesk";var s=new XMLHttpRequest;s.open("POST",e+"/oss-ext/v2/acmsessions",!0),s.setRequestHeader("Content-Type","application/json"),s.setRequestHeader("Authorization","Bearer "+a),s.responseType="json",s.onload=function(){if(200===s.status&&s.response){var e="string"==typeof s.response?JSON.parse(s.response):s.response;e&&e.acmsession?n(e.acmsession):r(s.status,"Can't get acm session from response.")}else r(s.status)},s.onerror=r,s.ontimeout=r,s.send(JSON.stringify(i)),delete i.application};var vc,gc=function(){function e(t,n){sd(this,e),this.delegate=e.copyDelegate(this,t)}return ld(e,[{key:"dtor",value:function(){this.delegate=null}},{key:"isValid",value:function(){return null!=this.delegate}},{key:"transferToDelegate",value:function(t){return null==this.delegate?(console.warn("Cannot transfer destroyed loader to new delegate"),!1):(this.delegate=e.copyDelegate(this,t),this.model&&this.model.getData()&&this.model.getData().propDbLoader&&this.model.getData().propDbLoader.transferToDelegate(this.delegate),!0)}}],[{key:"simpleInitLoadContext",value:function(e){return e=e||{},e.headers=e.headers||{},e}},{key:"nullFunction",value:function(){}},{key:"copyDelegate",value:function(n,r){var a={};return r&&Object.assign(a,r),a.workerScript||fc.mainThreadClass&&(a.workerScript=new fc.mainThreadClass),a.matman||(a.matman=new Pf),a.model||(a.model=At),a.getGeomCache||(a.getGeomCache=e.nullFunction),a.eventTarget||(t.EventDispatcher.prototype.apply(n),a.eventTarget=n),a.initLoadContext||(a.initLoadContext=e.simpleInitLoadContext),a.requestRedraw||(a.requestRedraw=e.nullFunction),a.reportError||(a.reportError=e.nullFunction),a.signalProgress||(a.signalProgress=e.nullFunction),a.toggleTwoSided||(a.toggleTwoSided=e.nullFunction),a}}]),e}(),yc=2,xc=1048576,bc=function(t,n){function r(e,t,n,r,a,o){function s(e,t,n){var r=null;if(t){var a=n-1;g=g+a&~a;var i=t.length;(r=new e(v,g,i)).set(t),g+=i*n}return r}var l,u=0,f=0,d=[],c=o.inMemory,p=!1,h=0,m=t.geoms;if(!n&&o.travsed>=o.currentCount)return 0;var _;for(_=0;_<o.totalCount;++_)!function(o){if(c[o>>5]&1<<(31&o)){var s=t.fragments.mesh2frag[e+":"+o];Array.isArray(s)&&(s=s[0]);var _=m.geoms[t.getGeometryId(s)];if(_&&_.packId==e){var v=_.vb.buffer===_.ib.buffer?_.vb.buffer.byteLength>_.vb.byteLength+_.ib.byteLength:_.vb.buffer.byteLength>_.vb.byteLength||_.ib.buffer.byteLength>_.ib.byteLength;(n||_.traversed!=r&&_.transparent!=a)&&(l=m.removeGeometry(_.svfid,i.delegate.webGLRenderer))>0?(f+=l,c[_.meshIndex>>5]&=~(1<<(31&_.meshIndex)),p=p||v):(++h,v&&(u+=_.vb.byteLength,u+=_.ib.byteLength+3&-4,d.push(_)))}else console.error("Mismapped or missing geometry %d:%d",e,o)}}(_);if(o.currentCount=h,o.culled=0,0==f)return 0;if(f/=xc,0==d.length||!p)return f;var v=new ArrayBuffer(u),g=0;return d.forEach(function(e){e.vb=s(Float32Array,e.vb,4),e.ib=s(Uint16Array,e.ib,2)}),f}var a=function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},i=t;this.options={onDemandLoading:!1,pageOutGeometryEnabled:!1},a(this.options,n),this.options.debug={maxPageOutSize:195,pixelCullingEnable:this.options.onDemandLoading,pixelCullingThreshold:ou,occlusionThreshold:1,occlusionTestThreshold:1,startOcclusionTestingPackCount:8,testPackfileCount:4,useOcclusionInstancing:!0,automaticRefresh:!0,boxProxyMaxCount:0,boxProxyMinScreen:.4},a(this.options.debug,n.debug),this.reachLimit=!1,this.geomidsmap={},this.geomTravCount=[],this.loadedPacks={},this.loadedPackfileCount=0,this.memoryOverhead=0,this.loadingPacks={},this.loadingPacksSize=0,this.queuedPacks=[],this.packQueuedMap={},this.queuedPacksSize=0,this.occludedPacks=[],this.occlusionCulledCount=0,this.packsPagedOut=0,this.traversedCounter=0,this.transparentCounter=0,this.resetCount=0,this.invalidateCount=-1,this.geompacks=i.svf.geompacks,this.geommap=i.geommap,this.totalGeomSize=this.options.totalGeomSize,this.overheadSize=this.options.overheadSize,this.minMemoryLimit=Math.min(Math.max(.1*this.totalGeomSize,10),50)+this.overheadSize,this.lastPageOut=-1,this.pageOutResetCounter=-1;var o,s=!1,l=0,u=0,f=0,d=[],c=-1,p=[],h=!0,m=null,_=0,v=!0,g=!1,y=function(e){this.resetCanPageOut(!!e.debug.unloadPackFiles,0!=e.delay,!1)}.bind(this);i.delegate.eventTarget&&i.delegate.eventTarget.addEventListener("loadMissingGeometry",y),this.dtor=function(){i.delegate.eventTarget&&i.delegate.eventTarget.removeEventListener("loadMissingGeometry",y)},this.onDemandLoadingEnabled=function(){return this.options.onDemandLoading},this.pageOutGeometryEnabled=function(){return this.options.pageOutGeometryEnabled&&this.onDemandLoadingEnabled()},this.pixelCullingEnable=function(){return this.options.debug.pixelCullingEnable},this.pixelCullingThreshold=function(){return this.options.debug.pixelCullingThreshold},this.getMemoryLimit=function(){return Math.max(this.minMemoryLimit,this.options.limit)},this.getMemoryInfo=function(){return this.onDemandLoadingEnabled()?{limit:this.options.limit,effectiveLimit:this.getMemoryLimit(),loaded:this.preparedPackFilesSize()}:null},this.getLoadedMeshes=function(e){var t=this.loadedPacks[e];return t&&t.inMemory},this.loadPackFile=function(){return!0},this.doLoadPackFile=function(e){return!!this.onDemandLoadingEnabled()&&(!!this.loadingPacks[e]||!0!==this.occludedPacks[e]&&(this.queuedPacks.length>0||this.occlusionTesting>=1?!!this.addGeomPackMissingLastFrame(e)&&(this.loadGeometryMissingLastFrame(),!0):i.loadGeometryPackOnDemand(e,this.getLoadedMeshes(e))))},this.unloadPackFile=function(e,t,n){if(!this.onDemandLoadingEnabled())return!1;var a=i.model.getFragmentList(),o=this.loadedPacks[e];return!!(a&&o&&a.geoms)&&(r(e,a,t,this.traversedCounter,this.transparentCounter,o),0==o.currentCount&&(delete this.loadedPacks[e],--this.loadedPackfileCount,n&&++this.packsPagedOut),!0)};var x=function(){if(this.resetCount!=this.pageOutResetCounter)return!1;i.delegate.requestRedraw(!1)}.bind(this);this.onPackFileLoaded=function(t,n,r){var a=this.geommap[t];if(g=!1,this.loadingPacks.hasOwnProperty(t)&&(delete this.loadingPacks[t],this.loadingPacksSize-=a.geomSize+a.usize),n){var i=this.loadedPacks[t];if(!i){var o=n.meshes.length;i=this.loadedPacks[t]={totalCount:o,travsed:0,culled:0,resetCounter:this.resetCount,geomSize:0,inMemory:new Array((o+31)/32|0)},++this.loadedPackfileCount,this.options.debug.occlusionTestThreshold>0&&0==this.occlusionTesting&&this.loadedPackfileCount>=this.options.debug.startOcclusionTestingPackCount&&(this.occlusionTesting=1)}i.geomSize+=r,i.currentCount=i.totalCount,i.inMemory.fill(-1),this.totalGeomSize+=i.geomSize-a.geomSize,this.packQueuedMap[t]&&(this.queuedPacksSize+=i.geomSize-a.geomSize),a.geomSize=i.geomSize,x()}this.loadedGeometrySize()>this.getMemoryLimit()&&e.logger.warn("More pack files being loaded than the max count: "+this.loadedGeometrySize())},this.checkLoadFinished=function(){if(!g){var e=i.pack_workers;if(e)for(var t=0;t<e.length;t++)if(0!=e[t].queued)return;(0!=this.geomPacksMissingLastFrame().length||l<d.length)&&(this.loadedGeometrySize()<this.getMemoryLimit()||v)||(g=!0,i.onDemandGeomLoadDone())}},this.doOnDemandLoadFinished=function(){this.loadGeometryMissingLastFrame(),this.checkLoadFinished()},this.onPackFileLoading=function(e){if(!this.loadingPacks.hasOwnProperty(e)){this.loadingPacks[e]=!0;var t=this.geommap[e];this.loadingPacksSize+=t.geomSize+t.usize}},this.onProcessReceivedMesh=function(e,t){var n=e.svfid;this.onDemandLoadingEnabled()&&t>1&&null==this.geomidsmap[n]&&(this.geomidsmap[n]=this.geomTravCount.length,this.geomTravCount.push(0))},this.loadedGeometrySize=function(){return i.model.getGeometryList().geomMemory/xc+this.overheadSize},this.preparedPackFilesSize=function(){return this.loadingPacksSize+this.loadedGeometrySize()},this.cancelPending=function(){this.loadingPacksSize>1/xc&&(i.cancelGeometryPackLoading(),this.loadingPacks={},this.loadingPacksSize=0),this.queuedPacks.length=0,this.queuedPacksSize=0,this.packQueuedMap={},this.occlusionTesting=this.onDemandLoadingEnabled()&&this.options.debug.occlusionTestThreshold>0&&this.loadedPackfileCount>=this.options.debug.startOcclusionTestingPackCount?1:0,this.occludedPacks.length=0},this.resetIterator=function(e){this.lastCamera=e,++this.resetCount},this.reset=function(){var e=this.loadedPacks;for(var t in e)e[t].travsed=0,e[t].culled=0;this.geomTravCount.fill(0),this.resetCount>this.invalidateCount&&(this.cancelPending(),this.resetCanPageOut(!1,!0,!0))},this.geomPacksMissingLastFrame=function(){return this.queuedPacks},this.addGeomPackMissingLastFrame=function(e){if(!this.onDemandLoadingEnabled())return!0;if(this.pageOutGeometryEnabled()&&this.loadedGeometrySize()>=this.getMemoryLimit()&&(this.reachLimit=!0),!this.packQueuedMap[e]){var t=this.geommap[e];t&&(this.queuedPacks.push(e),this.queuedPacksSize+=t.geomSize,this.packQueuedMap[e]=!0)}return!0},this.loadGeometryMissingLastFrame=function(){var e,t=this.queuedPacks;for(e=0;e<t.length;++e){var n=t[e];if(this.occlusionTesting>=1&&void 0===this.occludedPacks[n])break;if(!this.geommap[n].loading&&!this.occludedPacks[n]&&!i.loadGeometryPackOnDemand(n,this.getLoadedMeshes(n)))break}0!=e||g||x();var r=this;t.splice(0,e).forEach(function(e){r.queuedPacksSize-=r.geommap[e].geomSize,delete r.packQueuedMap[e]})},this.needResumeNextFrame=function(){return s};var b=function(e,t){var n=e>=p.length?1e10:p[e];return(t>=p.length?1e10:p[t])-n}.bind(this.loadedPacks);this.markVisibleGeoms=function(e){var t,n=i.model.getData().instanceTree||i.model.getData().fragmentMap;if(n&&e.visibleIdCB&&(t=e.visibleIdCB())){var r,a,o=++this.traversedCounter,s={},l=t.length,u=this.loadedPacks;for(a in u)u[a].travsed=0;for(var f=0;f<l;f+=4)(r=(r=t[f]|t[f+1]<<8|t[f+2]<<16)<<8>>8)>0&&(s[r]=1+(0|s[r]));var d=i.model.getFragmentList(),c=0|this.options.debug.occlusionThreshold;for(a in s)s[r=Number(a)]>=c&&n.enumNodeFragments(r,function(e){var t=d.getGeometry(e);if(t){var n=u[t.packId];n&&t.traversed!=o&&++n.travsed,t.traversed=o}})}},this.pageOut=function(t,n,r){s=!1;var a=0;if(t&&this.options.debug.occlusionTestThreshold>0&&this.loadedPackfileCount>=this.options.debug.startOcclusionTestingPackCount&&(this.occlusionTesting=yc),this.occlusionTest(r),!t)return a;this.pageOutResetCounter=this.resetCount;var i=this.loadedGeometrySize();if(v=!0,i&&(this.reachLimit||i>this.getMemoryLimit())){this.markVisibleGeoms(r);var o=this.loadedPacks,l=Object.keys(o),u=!1;l.sort(b);var f=i-Math.min(i,this.options.debug.maxPageOutSize);return l.every(function(e){return o[e].resetCounter<this.resetCount?this.unloadPackFile(e,!1,!0):u=!0,this.loadedGeometrySize()>f}.bind(this)),n&&this.loadedGeometrySize()==i&&o[l[0]].resetCounter<this.resetCount&&(this.unloadPackFile(l[0],!1,!0),e.logger.log("A force page out occur.")),this.loadedGeometrySize()==i?(a=0,this.reachLimit=!0):(this.reachLimit=!1,this.loadGeometryMissingLastFrame(),s=!0),this.lastPageOut=i-this.loadedGeometrySize(),e.logger.log("[On Demand Loading] Unload pack files size: "+this.lastPageOut),window&&window.gc&&window.gc(),0==this.lastPageOut&&(v=u,this.checkLoadFinished()),a}return s=s||this.queuedPacks.length>0,this.loadFragsFromLoadOrder(),a},this.occlusionTest=function(t){function n(e){var t=l.fragments.packIds;if(!t)return null;var n=[];return e.forEach(function(e){for(var r=[],a=t.lastIndexOf(e);a>=0;)t[a]==e?r.push(a--):a=t.lastIndexOf(e,a-1);n.push(r)}),n}function r(e){var n=null;p=0;var r=t.queuedPacks,a=t.occludedPacks;e=Math.min(4,e||4);for(var i=r.length,o=0;o<i&&e>0;++o){var s=r[o];void 0===a[s]?((n=n||[]).push(s),--e):a[s]||++p}return n}function a(n){f=null;for(var r=0;r<d.length;++r)t.occludedPacks[d[r]]=!n[r],n[r]||(e.logger.debug("[On Demand Loading] Occluded Geometry Pack file: "+d[r]),++t.occlusionCulledCount);t.doOnDemandLoadFinished(),o()}function o(){c||f||g||(f=null,s&&!u&&(d=r(t.options.debug.testPackfileCount))&&(c=setTimeout(function(){c=0;var e=n(d);(f=s(l.boxes,t.options.debug.occlusionTestThreshold,e,t.options.debug.useOcclusionInstancing,d)).then(a,function(){a([!0,!0,!0,!0])})},p*h)))}var s=null,l=null,u=!1,f=null,d=null,c=0,p=0,h=3;return function(e){f||this.occlusionTesting<yc||(e&&(s=e.occlusionTestCB,u=e.moved),(l=i.model.getFragmentList())&&s&&!u&&o())}}(this),this.loadFragsFromLoadOrder=function(){for(var e=i.model.getFragmentList();l<d.length;){for(var t=d[l],n=t.length;u<n;){var r=t[u];if(!e.getGeometry(r)){var a=e.fragments.packIds?e.fragments.packIds[r]:r,o=this.queuedPacks.length;if(!this.doLoadPackFile(a)&&o==this.queuedPacks.length)return}++u}++l,u=0}},this.pfOrder=function(){return o},this.getNumVisiblePFs=function(){return o?c:-1},this.onLoadOrderCalculated=function(t){if(t.error)m=null;else if(t.fragOrder&&t.packOrder&&(m=t),t.id==f&&m){if(this.lastPageOut=-1,v=!0,g=!1,d.length=0,i.model){var n=i.model.getFastLoadList();n&&(e.logger.log("Using PF fast-load-list for homeView, size:",n.length),d.push(n))}d.push(m.fragOrder),o=m.packOrder,c=m.pfVisible;var r,a=o.length;for(p.length=this.geompacks.length,p.fill(1e10),r=0;r<a;++r)p[o[r]]=r;var s,h=i.model.getFragmentList(),_=this.overheadSize,y=this.getMemoryLimit();for(s=0;s<d.length&&_<y;++s){var x=d[s];a=x.length;var b=[];b.length=p.length,b.fill(0);var w=this.geompacks;for(r=0;r<a&&_<y;++r){var M=x[r],S=h.fragments.packIds?h.fragments.packIds[M]:M,T=w[S];if(T){var A=h.getGeometry(M)?T.geomSize:T.totalGeomSize;A>b[S]&&(_+=A-b[S],b[S]=A)}}}var E=this.loadedPacks;for(var R in E)E.hasOwnProperty(R)&&(b[R]||this.unloadPackFile(R,!0));++this.traversedCounter,++this.transparentCounter,this.reachLimit=this.loadedGeometrySize()>=this.getMemoryLimit(),this.cancelPending(),l=0,u=0,this.loadFragsFromLoadOrder(),i.delegate.requestRedraw(!0),this.invalidateCount=this.resetCount+1}},this.resetCanPageOut=function(e,t,n){function r(){if(_=0,h||!n||a.options.debug.automaticRefresh){a.occlusionCulledCount=0,a.packsPagedOut=0;var t,r=a.lastCamera,o=a.loadedPacks;if(e)for(t in o)o.hasOwnProperty(t)&&a.unloadPackFile(t,!0);i.calculateLoadOrder(++f,r,a.options.debug.pixelCullingEnable?a.options.debug.pixelCullingThreshold:-1),h=!1}}_&&(clearTimeout(_),_=0);var a=this;t?_=setTimeout(r,100):r()},this.onGeomTraversed=function(e,t){var n=e.packId,r=e.svfid;e.traversed=this.traversedCounter,t&&(e.transparent=this.transparentCounter);var a=!0,i=this.geomidsmap[r];null!=i&&(this.geomTravCount[i]+=2,this.geomTravCount[i]|=1,a=e.instanceCount==this.geomTravCount[i]>>1);var o=this.loadedPacks[n];o&&a&&o.travsed++},this.onGeomCulled=function(e){if(e){var t=e.packId,n=e.svfid,r=this.geomidsmap[n],a=!r;null!=r&&(1&this.geomTravCount[r]?this.onGeomTraversed(e):(this.geomTravCount[r]+=2,a=e.instanceCount==this.geomTravCount[r]>>1));var i=this.loadedPacks[t];i&&a&&i.culled++}}},wc="UNLOAD_PROPERTYDB",Mc=1,Sc={},Tc=function(t,n,r){if(this.delegate=gc.copyDelegate(this,r),this.eventTarget=this.delegate.eventTarget,this.model=n,this.svf=n&&n.getData(),this.dbPath="",this.sharedDbPath=!1,this.svf&&this.svf.propertydb&&this.svf.propertydb.avs.length){this.dbFiles=this.svf.propertydb;for(var a in this.dbFiles)this.dbFiles[a][0]&&(this.dbFiles[a][0]=this.dbFiles[a][0].replace(/\\/g,"/"));var i=eu(this.svf.basePath);if(t){var o=mc.simplifyPath(i+this.svf.propertydb.avs[0]);if((o=o.slice(0,o.lastIndexOf("/")+1))===t){var s={};for(var a in this.dbFiles){var l=this.dbFiles[a][0];l=mc.simplifyPath(i+l),s[a]=[l]}this.dbFiles=s,this.dbPath=t,this.sharedDbPath=!0}else this.dbPath=i,this.sharedDbPath=!1}else this.dbPath=i,this.sharedDbPath=!1}else this.sharedDbPath=!0,this.dbPath=t,this.dbFiles={attrs:[],avs:[],ids:[],values:[],offsets:[]},e.logger.log("Using shared db path "+t);this.queryParams="",this.svf&&this.svf.acmSessionId&&(this.queryParams="acmsession="+this.svf.acmSessionId)};Tc.prototype.transferToDelegate=function(e){return this.delegate=gc.copyDelegate(this,e),!0},Tc.prototype.dtor=function(){this.asyncPropertyOperation({operation:wc},function(){},function(){})},Tc.prototype.processLoadResult=function(t){var n=this;if(t.instanceTreeStorage){var r=new Dt(t.instanceTreeStorage,t.rootId,t.instanceBoxes);n.instanceTree=new Lt(r,t.objectCount,t.maxTreeDepth),n.svf&&(n.svf.instanceTree=n.instanceTree)}else t.instanceTree?(e.logger.warn("glTF instance tree not supported"),n.hasObjectProperties=t.objectCount):t.objectCount&&(n.hasObjectProperties=t.objectCount,n.svf&&(n.svf.hasObjectProperties=t.objectCount));n.eventTarget.dispatchEvent({type:"propertyDbLoaded",svf:n.svf,model:n.model,target:n})},Tc.prototype.processLoadError=function(e){var t=this;t.propertyDbError=e,t.eventTarget.dispatchEvent({type:"propertyDbUnavailable",svf:t.svf,model:t.model,target:t})},Tc.prototype.load=function(){var e=this;if(this.svf&&this.svf.instanceTree&&this.svf.instanceBoxes)setTimeout(function(){e.processLoadResult(e.svf)},0);else{vc||(vc=this.delegate.workerScript.createWorkerWithIntercept()).addEventListenerWithIntercept(qt),this.propWorker=vc;var t=jt(function(t){e.processLoadResult(t)},function(t){e.processLoadError(t)}),n={operation:"LOAD_PROPERTYDB",dbPath:this.dbPath,sharedDbPath:this.sharedDbPath,propertydb:this.dbFiles,fragToDbId:this.svf&&this.svf.fragments.fragId2dbId,fragBoxes:this.svf&&this.svf.fragments.boxes,cbId:t,queryParams:this.queryParams};vc.doOperation(this.delegate.initLoadContext(n))}},Tc.prototype.asyncPropertyOperation=function(t,n,r){var a=this;if(t.dbPath=this.dbPath,a.instanceTree||a.hasObjectProperties)t.cbId=jt(n,r),vc.doOperation(t);else if(a.propertyDbError)r&&r(a.propertyDbError);else{var i=function i(o){a.eventTarget.removeEventListener("propertyDbLoaded",i),a.eventTarget.removeEventListener("propertyDbUnavailable",i),a.instanceTree||a.hasObjectProperties||a.propertyDbError?a.asyncPropertyOperation(t,n,r):r&&r({code:e.ErrorCodes.UNKNOWN_FAILURE,msg:"Failed to load properties"})};a.eventTarget.addEventListener("propertyDbLoaded",i),a.eventTarget.addEventListener("propertyDbUnavailable",i)}},Tc.prototype.getProperties=function(e,t,n){this.asyncPropertyOperation({operation:"GET_PROPERTIES",dbId:e},t,n)},Tc.prototype.getBulkProperties=function(e,t,n,r,a){this.asyncPropertyOperation({operation:"GET_PROPERTIES",dbIds:e,propFilter:t,ignoreHidden:a},n,r)},Tc.prototype.searchProperties=function(e,t,n,r,a){this.asyncPropertyOperation({operation:"SEARCH_PROPERTIES",searchText:e,attributeNames:t,completeInfo:a},n,r)},Tc.prototype.findProperty=function(e){var t=this;return new Promise(function(n,r){t.asyncPropertyOperation({operation:"FIND_PROPERTY",propertyName:e},n,r)})},Tc.prototype.findLayers=function(){var e=this;return new Promise(function(t,n){e.asyncPropertyOperation({operation:"FIND_LAYERS"},t,n)})},Tc.prototype.getExternalIdMapping=function(e,t){this.asyncPropertyOperation({operation:"BUILD_EXTERNAL_ID_MAPPING"},e,t)},Tc.prototype.getLayerToNodeIdMapping=function(e,t){this.asyncPropertyOperation({operation:"BUILD_LAYER_TO_NODE_ID_MAPPING"},e,t)},Tc.prototype.isObjectTreeLoaded=function(){return!!this.instanceTree},Tc.prototype.getObjectTree=function(e,t){var n=this;if(n.instanceTree)e(n.instanceTree);else if(n.propertyDbError)t&&t(n.propertyDbError);else if("hasObjectProperties"in n)t&&t("F2D files do not have an InstanceTree.");else{var r=function r(){n.eventTarget.removeEventListener("propertyDbLoaded",r),n.eventTarget.removeEventListener("propertyDbUnavailable",r),n.getObjectTree(e,t)};n.eventTarget.addEventListener("propertyDbLoaded",r),n.eventTarget.addEventListener("propertyDbUnavailable",r)}};var Ac=[6.0014,-2.7008,-1.7996,-1.332,3.1029,-5.7721,.3008,-1.0882,5.6268],Ec=new Float32Array(4),Rc=new Float32Array(4),Lc=function(n,r,a,i){if(n.LogLuv){for(var o=Math.pow(2,r),s=Array.isArray(n.image)?n.image:[n.image],l=0;l<s.length;l++)for(var u=s[l],f=0;f<u.mipmaps.length;f++){var d,c=u.mipmaps[f],p=c.data;a?(d=new Uint16Array(p.length/4*3),c.data=d):d=p.buffer;for(var h=0,m=0;m<p.length;m+=4)Ec[0]=p[m]/255,Ec[1]=p[m+1]/255,Ec[2]=p[m+2]/255,Ec[3]=p[m+3]/255,Xt(Rc,Ec),a?(Kt(Ec,Rc,o),d[h++]=Hd(Ec[0]),d[h++]=Hd(Ec[1]),d[h++]=Hd(Ec[2])):(Yt(Ec,Rc,o),p[m]=Math.round(255*Ec[0]),p[m+1]=Math.round(255*Ec[1]),p[m+2]=Math.round(255*Ec[2]),p[m+3]=Math.round(255*Ec[3]))}n.LogLuv=!1,a?(n.type=t.HalfFloatType,n.format=t.RGBFormat,n.RGBM=!1,n.GammaEncoded=!0):n.RGBM=!0,i&&i(n)}else e.logger.warn("Environment map expected to be in LogLuv format.")},Pc=null,Ic=1;THREE.DDSLoader=function(){this._parser=THREE.DDSLoader.parse},THREE.DDSLoader.prototype=Object.create(THREE.CompressedTextureLoader.prototype),THREE.DDSLoader.prototype.constructor=THREE.DDSLoader,THREE.DDSLoader.parse=function(e,t){function n(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}var r={mipmaps:[],width:0,height:0,format:null,mipmapCount:1},a=n("DXT1"),i=n("DXT3"),o=n("DXT5"),s=new Int32Array(e,0,31);if(542327876!==s[0])return console.error("THREE.DDSLoader.parse: Invalid magic number in DDS header."),r;if(4&!s[20])return console.error("THREE.DDSLoader.parse: Unsupported format, must contain a FourCC code."),r;var l,u=s[21],f=!1;switch(u){case a:l=8,r.format=THREE.RGB_S3TC_DXT1_Format;break;case i:l=16,r.format=THREE.RGBA_S3TC_DXT3_Format;break;case o:l=16,r.format=THREE.RGBA_S3TC_DXT5_Format;break;default:if(!(32==s[22]&&16711680&s[23]&&65280&s[24]&&255&s[25]&&4278190080&s[26]))return console.error("THREE.DDSLoader.parse: Unsupported FourCC code ",function(e){return String.fromCharCode(255&e,e>>8&255,e>>16&255,e>>24&255)}(u)),r;f=!0,l=64,r.format=THREE.RGBAFormat}r.mipmapCount=1,s[7]>0&&!1!==t&&(r.mipmapCount=Math.max(1,s[7])),r.isCubemap=!!(512&s[28]),r.width=s[4],r.height=s[3];for(var d=s[1]+4,c=r.width,p=r.height,h=r.isCubemap?6:1,m=0;m<h;m++){for(var _=0;_<r.mipmapCount;_++){if(f)v=(g=function(e,t,n,r){for(var a=n*r*4,i=new Uint8Array(e,t,a),o=new Uint8Array(a),s=0,l=0,u=0;u<r;u++)for(var f=0;f<n;f++){var d=i[l],c=i[++l],p=i[++l],h=i[++l];l++,o[s]=p,o[++s]=c,o[++s]=d,o[++s]=h,s++}return o}(e,d,c,p)).length;else var v=Math.max(4,c)/4*Math.max(4,p)/4*l,g=new Uint8Array(e,d,v);var y={data:g,width:c,height:p};r.mipmaps.push(y),d+=v,c=Math.max(.5*c,1),p=Math.max(.5*p,1)}c=r.width,p=r.height}return r},THREE.PVRLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager,this._parser=THREE.PVRLoader.parse},THREE.PVRLoader.prototype=Object.create(THREE.CompressedTextureLoader.prototype),THREE.PVRLoader.prototype.constructor=THREE.PVRLoader,THREE.PVRLoader.parse=function(e,t){var n=new Uint32Array(e,0,13),r={buffer:e,header:n,loadMipmaps:t};if(55727696===n[0])return THREE.PVRLoader._parseV3(r);if(559044176===n[11])return THREE.PVRLoader._parseV2(r);throw new Error("[THREE.PVRLoader] Unknown PVR format")},THREE.PVRLoader._parseV3=function(e){var t,n,r=e.header,a=r[12],i=r[2],o=r[6],s=r[7],l=(r[9],r[10]),u=r[11];switch(i){case 0:t=2,n=THREE.RGB_PVRTC_2BPPV1_Format;break;case 1:t=2,n=THREE.RGBA_PVRTC_2BPPV1_Format;break;case 2:t=4,n=THREE.RGB_PVRTC_4BPPV1_Format;break;case 3:t=4,n=THREE.RGBA_PVRTC_4BPPV1_Format;break;default:throw new Error("pvrtc - unsupported PVR format "+i)}return e.dataPtr=52+a,e.bpp=t,e.format=n,e.width=s,e.height=o,e.numSurfaces=l,e.numMipmaps=u,e.isCubemap=6===l,THREE.PVRLoader._extract(e)},THREE.PVRLoader._parseV2=function(e){var t,n=e.header,r=n[0],a=n[1],i=n[2],o=n[3],s=n[4],l=(n[5],n[6]),u=(n[7],n[8],n[9],n[10]),f=(n[11],n[12]),d=255&s,c=u>0;if(25===d)t=c?THREE.RGBA_PVRTC_4BPPV1_Format:THREE.RGB_PVRTC_4BPPV1_Format,l=4;else{if(24!==d)throw new Error("pvrtc - unknown format "+d);t=c?THREE.RGBA_PVRTC_2BPPV1_Format:THREE.RGB_PVRTC_2BPPV1_Format,l=2}return e.dataPtr=r,e.bpp=l,e.format=t,e.width=i,e.height=a,e.numSurfaces=f,e.numMipmaps=o+1,e.isCubemap=6===f,THREE.PVRLoader._extract(e)},THREE.PVRLoader._extract=function(e){var t={mipmaps:[],width:e.width,height:e.height,format:e.format,mipmapCount:e.numMipmaps,isCubemap:e.isCubemap},n=e.buffer,r=e.dataPtr,a=e.bpp,i=e.numSurfaces,o=0,s=0,l=0,u=0,f=0,d=0;2===a?(l=8,u=4):(l=4,u=4),s=l*u*a/8,t.mipmaps.length=e.numMipmaps*i;for(var c=0;c<e.numMipmaps;){var p=e.width>>c,h=e.height>>c;d=h/u,(f=p/l)<2&&(f=2),d<2&&(d=2),o=f*d*s;for(var m=0;m<i;m++){var _={data:new Uint8Array(n,r,o),width:p,height:h};t.mipmaps[m*e.numMipmaps+c]=_,r+=o}c++}return t};var Cc=Yl()?4:1/0,Dc=[],Nc=0,Oc=Yl()?32:1/0;Oc*=1048576;var Uc=0,Fc=1/0,Vc=function(){for(;Nc<Cc&&Dc.length>0;){var e=Dc.shift();++Nc,e.loadFunction(e.context,e.path,e.mapping,e.callback,e.options)}},Bc=function(t,n,r,a,i,o){if(Nc<Cc&&Dc.length<=0)return++Nc,void t(n,r,a,i,o);if(e.assets&&n){var s=mc.generateUrl(n.endpoint,"items",r);n.queryParams&&(s=s+(-1===s.indexOf("?")?"?":"&")+n.queryParams),e.assets.push([s,n.headers,null])}Dc.push({loadFunction:t,context:n,path:r,mapping:a,callback:i,options:o}),Vc()},zc=function(e,n,r,a,i,o,s,l){Hc.loadTextureWithSecurity(r,a,t.UVMapping,function(t){if(t){var a=s.materials.scene.SceneUnit,o=e.webGLRenderer?e.webGLRenderer.getMaxAnisotropy():0;l(i,t,a,o)}var u=e.matman;u&&(u.setTextureInCache(n,i,t,r),s.loadOptions.onTextureReceived&&s.loadOptions.setTextureInCache(u,i,t,!sn()),sn()||!s.loadDone||s.texLoadDone||(s.texLoadDone=!0,e.eventTarget.dispatchEvent({type:"texturesLoaded",model:n})))},o,e.initLoadContext)},Gc=function(e,t,n){var r=n.length;if(r>0){Hc.setTextureCount(r);for(var a=t.getData(),i=0;i<r;++i){var o=n[i];zc(e,t,o.path,o.isShared,o.map,o.acmSessionId,a,Ef.convertTexture)}}},kc=function(e,t,n,r){if(n.textureMaps&&!n.texturesLoaded){n.texturesLoaded=!0;var a=n.textureMaps;for(var i in a){var o=a[i];o.uri&&o.textureObj&&o.mapName&&!e.matman.loadTextureFromCache(t,n,o,i)&&r.push(function(t,n,r,a){var i=t.getData(),o=Hc.calculateTexturePath(t,r.uri,n,e.initLoadContext);return o.map=r,o.acmSessionId=i.acmSessionId,o}(t,n,o))}}},Hc=function(){function n(){sd(this,n)}return ld(n,null,[{key:"setMaxRequest",value:function(e){e>0&&(Cc=e)}},{key:"getMaxRequest",value:function(){return Cc}},{key:"setMemoryLimit",value:function(e){e>0&&(Oc=e,n.setTextureCount(Uc))}},{key:"getMemoryLimit",value:function(){return Oc}},{key:"setTextureCount",value:function(e){e>=0&&(Uc=e,Fc=Math.max(16384,Oc/(4*Uc)))}},{key:"getTextureCount",value:function(){return Uc}},{key:"calculateTexturePath",value:function(e,t,n,r,a){var i=e.getData();return e.isOTG()?function(){var e=r({});return{path:i.makeSharedResourcePath(e.otg_cdn,"textures",t),isShared:!!e.otg_cdn}}():function(){var e=null,r=n&&n.proteinType,o=n&&n.isPrismMaterial&&n.prismType,s=(o&&mc.endpoint.PRISM_ROOT||r&&mc.endpoint.PROTEIN_ROOT)&&(0===t.indexOf("1/Mats")||0===t.indexOf("2/Mats")||0===t.indexOf("3/Mats"));if(a&&(a.asset=null),s)e=o?mc.endpoint.PRISM_ROOT+t:mc.endpoint.PROTEIN_ROOT+t;else{for(var l=0;l<i.manifest.assets.length;++l){var u=i.manifest.assets[l];if(u.id.toLowerCase()==t.toLowerCase()){e=eu(i.basePath+u.URI),a&&(a.asset=u);break}}e||(e=eu(i.basePath+t))}return{path:e,isShared:s}}()}},{key:"loadTextureWithSecurity",value:function(n,r,a,i,o,s,l,u){var f=void 0;mc.endpoint.getUseCredentials()?(f=!r&&mc.endpoint.pathRequiresCredentials(n),t.ImageUtils.crossOrigin=f?"use-credentials":"anonymous"):t.ImageUtils.crossOrigin="";var d=n.indexOf("urn:"),c=void 0;f&&-1!==d&&(c=mc.endpoint.getDomainParam(),o&&(c=c?c+"&":"",c+="acmsession="+o)),u&&u.queryParams&&(c=c?c+"&":"",c+=u.queryParams),c&&(n+="?"+c);var p=function(e){Nc--,i(e),Vc()},h=l?p:function(e){Nc--,e&&(e.image=Qt(e.image)),i(e),Vc()},m=function(t){Nc--,e.logger.error("Texture load error",t),i(null)};if(Jl())Bc(an,s(),n,a,p,u);else if(".dds"===n.slice(n.length-4).toLocaleLowerCase())if(jl()){var _=n.slice(0,n.length-4)+".pvr";Bc(function(e,n,r,a){(new t.PVRLoader).load(_,a,m)},null,_,a,p)}else Bc(function(e,n,r,a){(new t.DDSLoader).load(n,a,m)},null,n,a,p);else f||u&&(u.rawData||u.extractImage)?Bc(rn,s(),n,a,h,u):Bc(function(e,n,r,a){t.ImageUtils.loadTexture(n,r,a,m)},null,n,a,h,u)}},{key:"setTextureDefinition",value:function(e,t,n,r,a){if(!on(t,e.matman,n,r))return!1;var i=t.getData(),o=i&&i.materials?i.materials.scene.SceneUnit:"inch";return n.textureMaps[r].textureObj=a,Ef.get2DMapTransform(a,!0,o),!0}},{key:"loadTexture",value:function(e,t,n,r,a,i,o,s,l){var u=n.textureMaps;if(!u)return!1;var f=u[r];return!(!f||!f.textureObj)&&(f.uri=a,e.matman.loadTextureFromCache(t,n,f,r,i,function(e){l&&l(e?null:"Texture load failed",e)})?l&&l(null,n[r]):zc(e,t,i,o,f,null,t.getData(),s),!0)}},{key:"loadMaterialTextures",value:function(e,t,n){var r=[];kc(e,t,n,r),Gc(e,t,r)}},{key:"loadModelTextures",value:function(e,t){var n=e.matman,r=n._getModelHash(t),a=[];for(var i in n._materials)if(-1!=i.indexOf(r)){var o=n._materials[i];kc(e,t,o,a)}Gc(e,t,a);var s=t.getData();sn()||!s.loadDone||s.texLoadDone||(s.texLoadDone=!0,e.eventTarget.dispatchEvent({type:"texturesLoaded",model:t}))}},{key:"loadCubeMap",value:function(e,n,r){var a=function(a){a?(a.mapping=t.CubeReflectionMapping,a.LogLuv=-1!==e.indexOf("logluv"),a.RGBM=-1!==e.indexOf("rgbm"),Lc(a,n,!1,r)):r&&r(a)},i=void 0;return t.ImageUtils.crossOrigin="",Array.isArray(e)?(i=t.ImageUtils.loadTextureCube(e,t.CubeReflectionMapping,a)).format=t.RGBFormat:"string"==typeof e?-1!==e.toLowerCase().indexOf(".dds")?i=(new t.DDSLoader).load(e,a):(i=t.ImageUtils.loadTexture(e,t.SphericalReflectionMapping,r)).format=t.RGBFormat:e?r&&r(e):r&&r(null),i}}]),n}(),Wc=Jl()?10:Yl()?2:6,qc=1048576,jc={},Xc={type:"fragmentLoaded",model:null,data:null,getFragIds:function(){if(this.fragIds)return this.fragIds;var e=this.model;if(!e||!this.data||!this.data.meshes)return null;var t=this.fragIds=[],n=this.data.packId,r=0,a=e.getData().fragments,i=this.data.meshes.length;for(r=0;r<i;++r){var o=n+":"+r++,s=a.mesh2frag[o];if(void 0===s)return;Array.isArray(s)?s.forEach(function(e){t.push(e)}):t.push(s)}return t}},Yc=function(e,t){Xc.model=e.model,Xc.data=t,e.delegate.eventTarget.dispatchEvent(Xc)},Kc=function(e){var n=4;switch(e.format){case t.AlphaFormat:n=1;break;case t.RGBFormat:n=3;break;case t.LuminanceFormat:n=1;break;case t.LuminanceAlphaFormat:n=2}switch(e.type){case t.ShortType:case t.UnsignedShortType:case t.HalfFloatType:n*=2;break;case t.IntType:case t.UnsignedIntType:case t.FloatType:n*=4;break;case t.UnsignedShort4444Type:case t.UnsignedShort5551Type:case t.UnsignedShort565Type:n=2}var r=n*e.image.width;return r+=e.unpackAlignment-1,r-=r%e.unpackAlignment,e.image.height*r},Zc=function(n){function r(n,a){sd(this,r);var i=dd(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,n,a));i.next_pack=0,i.loading=!1,i.loadedPacksCount=0,i.tmpMatrix=new t.Matrix4,i.tmpBox=new t.Box3,i.fetchingTopology=!1,i.loadTime=0;var o=i;i.delegate.loadPropertyDb||(i.delegate.loadPropertyDb=function(e,t){var n=t.getData();n.propDbLoader=new Tc(e,t,o.delegate),n.propDbLoader.load()}),i.delegate.loadModelTextures||(i.delegate.loadModelTextures=function(e){Hc.loadModelTextures(o.delegate,e)});var s=a&&a.memory,l=i.memoryOpts={debug:{}};if(!Jl()){if(l.limit=Xl()?195:jl()?150:600,l.onDemandLoading=!0,l.pageOutGeometryEnabled=!0,s){l.debug=s.debug||{};var u=s.hasOwnProperty("limit")?s.limit:0;(0|u)>0?l.limit=0|u:0==u?(l.onDemandLoading=!1,l.pageOutGeometryEnabled=!1,l.debug.force=!1):e.logger.warn("Memory limit, "+u+", is invalid - ignored")}l.onDemandLoading&&ru(!0)}return i}return fd(r,gc),ld(r,[{key:"dtor",value:function(){if(this.initWorkerScriptToken&&(this.initWorkerScriptToken.cancel(),this.initWorkerScriptToken=null,e.logger.debug("SVF loader dtor: on init worker script.")),this.svfWorker&&(this.svfWorker.clearAllEventListenerWithIntercept(),this.svfWorker.terminate(),this.svfWorker=null,e.logger.debug("SVF loader dtor: on svf worker.")),this.svfLoadOrderWorker&&(this.svfLoadOrderWorker.terminate(),this.svfLoadOrderWorker=null,e.logger.debug("SVF loader dtor: on load order worker.")),this.pack_workers){for(var t=0;t<this.pack_workers.length;t++)this.pack_workers[t].clearAllEventListenerWithIntercept(),this.pack_workers[t].terminate();this.pack_workers=null,e.logger.debug("SVF loader dtor: on geom worker.")}this.svf&&this.svf.propDbLoader&&(this.svf.propDbLoader.dtor(),this.svf.propDbLoader=null),this.pagingProxy&&(this.pagingProxy.dtor(),this.pagingProxy=null),this.tmpMatrix=null,this.tmpBox=null,this.next_pack=0,this.loading=!1,this.loadedPacksCount=0,this.loadTime=0,ud(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"dtor",this).call(this)}},{key:"loadFile",value:function(t,n,r,a){if(!this.delegate)return e.logger.log("SVF loader was already destructed. So no longer usable."),!1;if(this.loading)return e.logger.log("Loading of SVF already in progress. Ignoring new request."),!1;this.loading=!0,this.delegate.eventTarget.dispatchEvent({type:"fileLoadStarted",loader:this});var i=t.indexOf("urn:");if(-1!=i){var o=(t=decodeURIComponent(t)).substr(i,t.substr(i).indexOf("/"));e.logger.log("Extracted URN: "+o);var s=o.lastIndexOf(":");this.svfUrn=o.substr(s+1)}else this.svfUrn=t;this.sharedDbPath=n.sharedPropertyDbPath,this.currentLoadPath=t;var l=this.currentLoadPath.lastIndexOf("/");-1!=l&&(this.basePath=this.currentLoadPath.substr(0,l+1)),this.acmSessionId=n.acmSessionId,this.queryParams="",this.acmSessionId&&(this.queryParams="acmsession="+this.acmSessionId),this.options=n;var u=this;return this.initWorkerScriptToken=this.delegate.workerScript.initWorkerScript(function(){u.loadSvfCB(t,n,r,a)}),!0}},{key:"loadSvfCB",value:function(t,n,a,i){this.t0=(new Date).getTime(),this.firstPixelTimestamp=null,this.failedToLoadSomeGeometryPacks=null,this.failedToLoadPacksCount=0;var o=!0;n.doneWhenDownloaded&&(this.onDone=a);var s=this,l={url:eu(t),basePath:this.currentLoadPath,objectIds:n.ids,globalOffset:n.globalOffset,placementTransform:n.placementTransform,applyRefPoint:n.applyRefPoint,queryParams:this.queryParams,bvhOptions:n.bvhOptions||{isWeakDevice:Yl()},applyScaling:n.applyScaling,loadInstanceTree:n.loadInstanceTree,max_pf_files:0},u=this.memoryOpts.onDemandLoading||!!this.memoryOpts.debug.memoryOptimizedSvfLoading;u&&(l.perfOpt={memoryOptimizedSvfLoading:u,forceMemoryOptimizedMode:!!this.memoryOpts.debug.forceMemoryOptimizedModeOnSvfLoading});var f=this.svfWorker=this.delegate.workerScript.createWorkerWithIntercept();return f.addEventListenerWithIntercept(function(t){var u=function(){f&&(f.clearAllEventListenerWithIntercept(),f.terminate(),s.svfWorker=null,f=null)};if(o&&i&&(o=!1,i()),t.data&&t.data.manifest)r.interceptManifest.call(s,t.data.manifest),l.operation="LOAD_SVF_CONTD",l.manifest=t.data.manifest,f.doOperation(l);else if(t.data&&t.data.svf){var d=s.svf=t.data.svf;s.failedToLoadSomeGeometryPacks&&(a&&(a(s.failedToLoadSomeGeometryPacks,null),delete s.onDone),s.failedToLoadSomeGeometryPacks=null),s.onModelRootLoadDone(d),a&&!n.doneWhenDownloaded&&a(null,s.model),s.delegate.eventTarget.dispatchEvent({type:"svfLoaded",svf:d,model:s.model}),s.svf.loadDone=!1;var c=!1;if(s.svf.metadata&&s.svf.metadata.gltf&&(c=!0),!c){var p=d.geompacks.length;if(0==p)s.onGeomLoadDone();else if(s.model.getFragmentList().onDemandLoadingEnabled())e.logger.debug("[On Demand Loading]: Enabled."),s.loadedPacksCount=0;else if(p)for(var h=Math.min(p,Wc),m=0;m<h;m++)!function(e){var t=d.geompacks[s.next_pack++];t.loading=!0,Jl()?s.loadGeometryPack(t.id,t.uri):function(t){setTimeout(function(){s.loadGeometryPack(t.id,t.uri)},200*e)}(t)}(m)}1==t.data.progress&&(s.loading=!1,u()),d.fragments.polygonCounts||(d.fragments.polygonCounts=new Int32Array(d.fragments.length)),t.data.bvh&&(s.svf.bvh=t.data.bvh,s.model.setBVH(new Nt(s.svf.bvh.nodes,s.svf.bvh.useLeanNodes),s.svf.bvh.primitives,s.options.bvhOptions),s.delegate.requestRedraw(!1))}else t.data&&t.data.bvh?(s.svf&&!s.svf.bvh&&(s.svf.bvh=t.data.bvh,s.model.setBVH(new Nt(s.svf.bvh.nodes,s.svf.bvh.useLeanNodes),s.svf.bvh.primitives,s.options.bvhOptions),s.delegate.requestRedraw(!1)),s.loading=!1,u()):t.data&&t.data.mesh?(s.processReceivedMesh(t.data),1===t.data.progress&&(s.onGeomLoadDone(),s.loading=!1,u())):t.data&&t.data.progress?1==t.data.progress&&(s.loading=!1,u()):t.data&&t.data.error?(s.loading=!1,u(),e.logger.error("Error while processing SVF: "+JSON.stringify(t.data.error.args)),a&&(a(t.data.error,null),delete s.onDone)):t.data&&t.data.debug?e.logger.debug(t.data.message):(s.delegate.reportError(e.ErrorCodes.NETWORK_FAILURE,"SVF download failed."),s.loading=!1,u())}),l.operation="LOAD_SVF",l.interceptManifest=!!r.interceptManifest,f.doOperation(this.delegate.initLoadContext(l)),!0}},{key:"cancelGeometryPackLoading",value:function(){if(this.pack_workers&&this.isValid()){for(var e=0;e<this.pack_workers.length;e++){if(this.svf){var t=this.geommap[this.pack_workers[e].packId];t&&(t.loading=!1)}this.pack_workers[e].queued=0,this.pack_workers[e].clearAllEventListenerWithIntercept(),this.pack_workers[e].terminate()}this.pack_workers=null}}},{key:"loadGeometryPackOnDemand",value:function(t,n){function r(e,t){e.queued=0,s.geommap[t].loading=!1,i.doOnDemandLoadFinished()}if(!this.svf||!this.isValid())return!0;var a=this.geommap[t];if(!a||a.loading)return!0;this.t0||(this.t0=(new Date).getTime());var i=this.pagingProxy,o=void 0,s=this;if(!this.pack_workers){this.pack_workers=[];var l=Wc;for(o=0;o<l;o++){var u=this.delegate.workerScript.createWorkerWithIntercept();u.addEventListenerWithIntercept(function(t){if(t.data&&t.data.meshes){for(var n=t.data.meshes,a={packId:t.data.packId,meshIndex:0,mesh:null},o=0,l=0;l<n.length;l++){var u=n[l];u&&(a.meshIndex=l,a.mesh=u,s.processReceivedMesh(a),a.geometry&&(o+=a.geometry.byteSize+464,a.geometry=null))}i.onPackFileLoaded(t.data.packId,t.data,o/qc),Yc(s,t.data),t.data.progress>=1&&(s.loadedPacksCount++,r(s.pack_workers[t.data.workerId],t.data.packId))}else t.data&&t.data.progress?(s.pack_workers[t.data.workerId].queued-=1,s.delegate.signalProgress(100*s.loadedPacksCount/s.svf.geompacks.length)):t.data&&t.data.debug?e.logger.debug(t.data.message):t.data&&t.data.error?(i.onPackFileLoaded(t.target.packId,null,0),r(t.target,t.target.packId),++s.failedToLoadPacksCount,s.failedToLoadSomeGeometryPacks={code:t.data.error.code,msg:t.data.error.msg}):(i.onPackFileLoaded(t.target.packId,null,0),r(t.target,t.target.packId))}),u.queued=0,this.pack_workers.push(u)}}var f=0,d=this.pack_workers[0].queued;for(o=1;o<this.pack_workers.length;o++)this.pack_workers[o].queued<d&&(f=o,d=this.pack_workers[o].queued);if(d>1||i.preparedPackFilesSize()>=i.getMemoryLimit())return this.model.addGeomPackMissingLastFrame(t)||this.delegate.requestRedraw(!1),!1;var c=void 0,p=void 0,h=a.uri;(c=this.pack_workers[f]).queued+=2,c.packId=t,p=f,i.onPackFileLoading(t),a.loading=!0,this.svf.partPacksLoadDone=!1,e.logger.debug("[On Demand Loading] Loading Geometry Pack file: "+t);var m={operation:"LOAD_GEOMETRY",url:eu(this.svf.basePath+h),packId:t,workerId:p,packNormals:this.options.packNormals,createWireframe:this.options.createWireframe,skipAssetCallback:!0,queryParams:this.queryParams,inMemory:n};return c.doOperation(this.delegate.initLoadContext(m)),!0}},{key:"loadGeometryPack",value:function(t,n){var r=void 0,a=void 0,i=void 0,o=void 0,s=this;if(this.svf&&this.isValid()){var l=this.pack_workers;if(l||(l=this.pack_workers=[]),l.length<Wc){var u=!0;for(i=0;i<l.length;i++)if(0===l[i].queued){u=!1;break}if(u){var f=this.delegate.workerScript.createWorkerWithIntercept();f.addEventListenerWithIntercept(function(t){if(t.data&&t.data.meshes){for(var n=t.data.meshes,r={packId:t.data.packId,meshIndex:0,mesh:null},a=0;a<n.length;a++){var i=n[a];i&&(r.meshIndex=a,r.mesh=i,s.processReceivedMesh(r))}if(t.data.progress>=1){s.pack_workers[t.data.workerId].queued-=1,s.loadedPacksCount++,s.delegate.signalProgress(100*s.loadedPacksCount/s.svf.geompacks.length);var l=!0;for(o=0;o<s.pack_workers.length;o++)if(0!=s.pack_workers[o].queued){l=!1;break}if(l){for(o=0;o<s.pack_workers.length;o++)s.pack_workers[o].clearAllEventListenerWithIntercept(),s.pack_workers[o].terminate();s.pack_workers=null}s.loadedPacksCount+s.failedToLoadPacksCount==s.svf.geompacks.length&&s.onGeomLoadDone()}}else if(t.data&&t.data.progress){if(s.pack_workers[t.data.workerId].queued-=1,s.next_pack<s.svf.geompacks.length){for(var u=null;s.next_pack<s.svf.geompacks.length&&(u=s.svf.geompacks[s.next_pack++]).loading;);u&&!u.loading?(u.loading=!0,s.loadGeometryPack(u.id,u.uri)):s.svf.fragments.packIds=null}}else t.data&&t.data.debug?e.logger.debug(t.data.message):t.data&&t.data.error?(++s.failedToLoadPacksCount,s.failedToLoadSomeGeometryPacks={code:t.data.error.code,msg:t.data.error.msg}):s.pack_workers[t.data.workerId].queued-=2}),f.queued=0,l.push(f)}}var d=0,c=l[0].queued;for(i=1;i<l.length;i++)l[i].queued<c&&(d=i,c=l[i].queued);(r=l[d]).queued+=2,a=d;var p={operation:"LOAD_GEOMETRY",url:eu(this.svf.basePath+n),packId:parseInt(t),workerId:a,createWireframe:this.options.createWireframe,packNormals:this.options.packNormals,queryParams:this.queryParams};r.doOperation(this.delegate.initLoadContext(p))}}},{key:"processReceivedMesh",value:function(t){var n=t.packId+":"+t.meshIndex,r=this.svf,a=r.fragments,i=this.model,o=a.mesh2frag[n];if(void 0!==o){Array.isArray(o)||(o=[o]),nf.meshToGeometry(t),t.geometry.packId=t.packId,t.geometry.meshIndex=t.meshIndex;var s=o.length,l=i.getFragmentList().getGeometryId(o[0]);i.getGeometryList().addGeometry(t.geometry,s,l),this.pagingProxy&&this.pagingProxy.onProcessReceivedMesh(t.geometry,s);for(var u=(t.geometry.attributes.index.array||t.geometry.ib).length/3,f=0;f<o.length;f++){var d=0|o[f];i.getFragmentList().getOriginalWorldMatrix(d,this.tmpMatrix);var c=a.materials[d].toString();a.polygonCounts&&(a.polygonCounts[d]=u);var p=t.geometry;jc.geometry=p,jc.material=this.delegate.matman.setupMaterial(this.model,p,c),jc.matrix=this.tmpMatrix,jc.isLine=p.isLines,jc.isWideLine=p.isWideLines,jc.isPoint=p.isPoints,jc.is2d=p.is2d,i.activateFragment(d,jc,!!r.placementTransform)}this.model.getFragmentList().onDemandLoadingEnabled()||(a.mesh2frag[n]=null),a.numLoaded+=o.length,i.getGeometryList().geomPolyCount>r.nextRepaintPolys&&(this.firstPixelTimestamp=this.firstPixelTimestamp||Date.now(),r.numRepaints++,r.nextRepaintPolys+=1e4*Math.pow(1.5,r.numRepaints),this.delegate.requestRedraw(!1))}else e.logger.warn("Mesh "+n+" was not referenced by any fragments.")}},{key:"onModelRootLoadDone",value:function(n){n.geomMemory=0,n.fragments.numLoaded=0,n.gpuNumMeshes=0,n.gpuMeshMemory=0,n.nextRepaintPolys=0,n.numRepaints=0,n.urn=this.svfUrn,n.acmSessionId=this.acmSessionId,n.basePath=this.basePath,n.loadOptions=this.options;var r=Date.now();this.loadTime+=r-this.t0,e.logger.log("SVF load: "+(r-this.t0));var a=this.model=new this.delegate.model(n);a.loader=this;var i=this.memoryOpts;this.delegate.renderScene&&this.delegate.renderScene.length>0&&(i.pageOutGeometryEnabled=!1);var o=this.geommap={},s=(224*Object.keys(n.fragments.mesh2frag).length+134*n.fragments.length)/qc,l=0;n.geompacks.forEach(function(e){e.hasOwnProperty("geomSize")||(e.geomSize=.7*e.usize),e.usize/=qc,e.geomSize/=qc,l+=e.geomSize,o[parseInt(e.id)]=e});var u=Yl()?Math.min(l,au/qc):0;l+=s,i.totalGeomSize=l,i.overheadSize=s,i.onDemandLoading&&(l+u<i.limit&&!i.debug.force?i.onDemandLoading=!1:this.pagingProxy=new bc(this,i)),a.initialize(this.pagingProxy);var f=this;this.model.getFragmentList().onDemandLoadingEnabled()&&n.fragments.boxes&&n.fragments.packIds&&(this.svfLoadOrderWorker=this.delegate.workerScript.createWorker(),this.svfLoadOrderWorker.addEventListener("message",function(e){f.isValid()&&f.pagingProxy&&f.pagingProxy.onLoadOrderCalculated(e.data)},!1),this.svfLoadOrderWorker.doOperation({operation:"CALCULATE_LOAD_ORDER",fragments:{boxes:n.fragments.boxes,packIds:n.fragments.packIds}}),this.model.setUUID(n.urn)),!(this.model.getFragmentList().onDemandLoadingEnabled()&&Yl())&&!this.options.skipPropertyDb?this.delegate.loadPropertyDb(this.sharedDbPath,this.model):this.svf.fragmentMap=new Pt(this.svf.fragments.fragId2dbId);var d=this.convertMaterials(a);if(this.t0=r,n.bbox=(new t.Box3).copy(n.bbox),n.modelBox&&(n.modelBox=(new t.Box3).copy(n.modelBox)),n.refPointTransform&&(n.refPointTransform=new Ad(!0).copy(n.refPointTransform)),n.placementTransform&&(n.placementTransform=new Ad(!0).copy(n.placementTransform)),n.cameras)for(var c=0;c<n.cameras.length;c++){var p=n.cameras[c];p.position=(new t.Vector3).copy(p.position),p.target=(new t.Vector3).copy(p.target),p.up=(new t.Vector3).copy(p.up),isFinite(p.position.x+p.position.y+p.position.z+p.target.x+p.target.y+p.target.z+p.up.x+p.up.y+p.up.z)||(p.target=n.bbox.center(),p.position.copy(p.target),p.position.z+=n.bbox.max.z-n.bbox.min.z,p.up={x:0,y:1,z:0}),isFinite(p.aspect)||(p.aspect=1),isFinite(p.fov)||(p.fov=90),isFinite(p.orthoScale)||(p.orthoScale=1)}!(n.proteinMaterials&&mc.endpoint.PROTEIN_ROOT&&mc.endpoint.PRISM_ROOT)||i.onDemandLoading&&Yl()||this.delegate.loadModelTextures(this.model),e.logger.log("scene bounds: "+JSON.stringify(n.bbox));var h={category:"metadata_load_stats",urn:n.urn,has_topology:!!n.topologyPath,has_animations:!!n.animations,cameras:n.cameras?n.cameras.length:0,lights:n.lights?n.lights.length:0,materials:d,is_mobile:Yl()};e.logger.track(h),this.delegate.signalProgress(5),this.delegate.requestRedraw(!1)}},{key:"calculateLoadOrder",value:function(e,t,n){if(!this.svfLoadOrderWorker)return!1;var r={operation:"CALCULATE_LOAD_ORDER",id:e,camera:{projectionMatrix:{elements:t.projectionMatrix.elements},matrixWorldInverse:{elements:t.matrixWorldInverse.elements},aspect:t.aspect,position:{x:t.position.x,y:t.position.y,z:t.position.z},clientWidth:t.clientWidth,clientHeight:t.clientHeight},pixelCullingThreshold:n};return this.svfLoadOrderWorker.doOperation(r),!0}},{key:"convertMaterials",value:function(e){var t=this.delegate.matman,n=this.svf,r=0,a=void 0;if(!n.materials)return r;if(n.gltfMaterials){var i=n.materials.materials;for(a in i){var o=i[a],s=Ef.convertMaterialGltf(o,n),l=t._getMaterialHash(e,a);t.addMaterial(l,s,!1),r++}return r}var u=n.materials.materials,f=n.proteinMaterials?n.proteinMaterials.materials:null;for(a in u){var d=f&&f[a]&&Ef.isPrismMaterial(f[a])?f[a]:u[a];t.convertOneMaterial(e,d,a),r++}return r}},{key:"makeBVH",value:function(t){var n=performance.now(),r=t.materials?t.materials.materials:null;t.bvh=new Ut(t.fragments,r),t.bvh.build(this.options.bvhOptions||{isWeakDevice:Yl()});var a=performance.now();e.logger.log("BVH build time: "+(a-n))}},{key:"onDemandGeomLoadDone",value:function(){if(!this.svf.loadDone&&(!this.svf.proteinMaterials||!mc.endpoint.PROTEIN_ROOT||!mc.endpoint.PRISM_ROOT||Yl()))if(Yl()){var t=this.delegate.renderScene?this.delegate.renderScene.getMemoryInfo():this.model.getMemoryInfo();if(null!=t&&t.effectiveLimit<=t.limit&&t.limit-t.loaded>50){var n=function(e){this.delegate.eventTarget.removeEventListener("texturesLoaded",n);var t=0;this.delegate.matman.enumTextures(this.model,function(e){e&&(t+=Kc(e))}),t/=qc,this.pagingProxy.options.limit-=t}.bind(this);this.delegate.eventTarget.addEventListener("texturesLoaded",n),this.delegate.loadModelTextures(this.model)}}else this.delegate.loadModelTextures(this.model);this.svf.loadDone=!0;var r=Date.now(),a="[On Demand Loading] On demand requested geometries load time: "+(r-this.t0);e.logger.log(a);var i={category:"on_demand_geom_load_stats",is_f2d:!1,has_prism:this.delegate.matman.hasPrism,load_time:r-this.t0,geometry_size:this.model.getGeometryList().geomMemory,meshes_count:this.model.getGeometryList().geoms.length,fragments_count:this.model.getFragmentList().getCount(),load_pack_count:this.loadedPacksCount,urn:this.svfUrn};e.logger.track(i),this.t0=null,e.assets&&!Jl()&&window.webkit&&(!function(e){var t={command:"assets",data:e};!Jl()&&window.webkit.messageHandlers.callbackHandler&&window.webkit.messageHandlers.callbackHandler.postMessage(t)}(e.assets),tu()),this.loadedPacksCount=0,this.svf.partPacksLoadDone=!0,this.delegate.eventTarget.dispatchEvent({type:"geometryDownloadComplete",model:this.model,memoryLimited:!0}),this.onDone&&(this.onDone(null,this.model),delete this.onDone)}},{key:"onGeomLoadDone",value:function(){this.svf.loadDone=!0,this.svf.proteinMaterials&&mc.endpoint.PROTEIN_ROOT&&mc.endpoint.PRISM_ROOT||this.delegate.loadModelTextures(this.model),this.svf.fragments.entityIndexes=null,this.svf.fragments.mesh2frag=null;var t=Date.now(),n="Fragments load time: "+(t-this.t0);this.loadTime+=t-this.t0;var r=this.firstPixelTimestamp-this.t0;n+=" (first pixel time: "+r+")",this.svf.bvh&&!this.svf.placementTransform||(this.makeBVH(this.svf),this.model.setBVH(this.svf.bvh.nodes,this.svf.bvh.primitives,this.options.bvhOptions),this.delegate.requestRedraw(!1)),e.logger.log(n),this.options.useConsolidation&&this.delegate.webGLRenderer&&this.model.consolidate(this.delegate.matman,this.options.consolidationMemoryLimit,this.delegate.webGLRenderer);var a={category:"model_load_stats",is_f2d:!1,has_prism:this.delegate.matman.hasPrism,load_time:this.loadTime,geometry_size:this.model.getGeometryList().geomMemory,meshes_count:this.model.getGeometryList().geoms.length,fragments_count:this.model.getFragmentList().getCount(),urn:this.svfUrn};r>0&&(a.first_pixel_time=r),e.logger.track(a),e.assets&&!Jl()&&window.webkit&&(!function(e){var t={command:"assets",data:e};!Jl()&&window.webkit.messageHandlers.callbackHandler&&window.webkit.messageHandlers.callbackHandler.postMessage(t)}(e.assets),tu()),this.currentLoadPath=null,this.delegate.eventTarget.dispatchEvent({type:"geometryDownloadComplete",model:this.model,memoryLimited:!1}),this.onDone&&(this.onDone(null,this.model),delete this.onDone)}},{key:"fetchTopologyFile",value:function(t,n){if(!this.fetchingTopology){this.fetchingTopology=!0;var r=this.delegate.workerScript.createWorkerWithIntercept();r.addEventListenerWithIntercept(function(t){if(t.data["status-topology"])return o=(new Date).getTime(),l=Math.round((o-i)/1e3),void e.logger.log("Topology file downloaded. ("+l+" seconds). Processing...");var a=t.data["fetch-topology"];a&&(s=(new Date).getTime(),l=Math.round((s-o)/1e3),a.topology?e.logger.log("Topology file processed successfully! ("+l+" seconds)."):e.logger.log("Topology file processed, but an error ocurred. ("+l+" seconds)."),n(a),u.fetchingTopology=!1,r.clearAllEventListenerWithIntercept(),r.terminate(),r=null)});var a={path:t,queryParams:this.queryParams},i=(new Date).getTime(),o=void 0,s=void 0,l=void 0;e.logger.log("Fetching topology file..."),a.operation="FETCH_TOPOLOGY",r.doOperation(this.delegate.initLoadContext(a));var u=this}}},{key:"is3d",value:function(){return!0}}]),r}();Zc.interceptManifest=void 0;var Qc=new(function(){function e(){sd(this,e),this._workers=new Map}return ld(e,[{key:"dispatch",value:function(e){if(e.hasOwnProperty("operation")){var t=this._workers.get(e.operation);if(t){if(e.basePath="",e.url){var n=e.url.lastIndexOf("/");-1!=n&&(e.basePath=e.url.substr(0,n+1))}e.raiseError=function(){e.worker.raiseError.apply(e.worker,arguments)},e.onFailureCallback=mc.defaultFailureCallback.bind(e),t.doOperation(e)}}}},{key:"register",value:function(e,t){this._workers.set(e,t)}},{key:"unregister",value:function(e){this._workers.delete(e)}}]),e}());dn.prototype.getCount=function(){return this.count},dn.prototype.isTransparent=function(e){return!!(this.flags[e*this.boxStride+6]>>24)},dn.prototype.getPolygonCount=function(e){return 16777215&this.flags[e*this.boxStride+6]},Qc.register("LOAD_OTG_BVH",{doOperation:function(e){e.fragments_extra&&ln(e,e.fragments_extra,"",function(t){if(t&&t.length){var n=new dn(t,e.placementWithOffset,e.placementTransform,e.globalOffset);if(n.count){var r=new Ut(null,null,n);r.build(e.bvhOptions);var a={nodes:r.nodes.getRawData(),primitives:r.primitives};e.worker.postMessage({bvh:a},[a.nodes,a.primitives.buffer])}}})}}),Qc.register("LOAD_OTG_MATS",{doOperation:function(e){}});var Jc={};(function(){function e(e){throw e}function t(e,t){var n=e.split("."),r=u;!(n[0]in r)&&r.execScript&&r.execScript("var "+n[0]);for(var a;n.length&&(a=n.shift());)n.length||t===l?r=r[a]?r[a]:r[a]={}:r[a]=t}function n(e){var t,n,r,a,i,o,s,l,u,d=e.length,c=0,p=Number.POSITIVE_INFINITY;for(l=0;l<d;++l)e[l]>c&&(c=e[l]),e[l]<p&&(p=e[l]);for(t=1<<c,n=new(f?Uint32Array:Array)(t),r=1,a=0,i=2;r<=c;){for(l=0;l<d;++l)if(e[l]===r){for(o=0,s=a,u=0;u<r;++u)o=o<<1|1&s,s>>=1;for(u=o;u<t;u+=i)n[u]=r<<16|l;++a}++r,a<<=1,i<<=1}return[n,c,p]}function r(t,n){switch(this.g=[],this.h=32768,this.d=this.f=this.a=this.l=0,this.input=f?new Uint8Array(t):t,this.m=!1,this.i=c,this.r=!1,!n&&(n={})||(n.index&&(this.a=n.index),n.bufferSize&&(this.h=n.bufferSize),n.bufferType&&(this.i=n.bufferType),n.resize&&(this.r=n.resize)),this.i){case d:this.b=32768,this.c=new(f?Uint8Array:Array)(32768+this.h+258);break;case c:this.b=0,this.c=new(f?Uint8Array:Array)(this.h),this.e=this.z,this.n=this.v,this.j=this.w;break;default:e(Error("invalid inflate mode"))}}function a(t,n){for(var r,a=t.f,i=t.d,o=t.input,s=t.a;i<n;)(r=o[s++])===l&&e(Error("input buffer is broken")),a|=r<<i,i+=8;return r=a&(1<<n)-1,t.f=a>>>n,t.d=i-n,t.a=s,r}function i(e,t){for(var n,r,a,i=e.f,o=e.d,s=e.input,u=e.a,f=t[0],d=t[1];o<d&&(n=s[u++])!==l;)i|=n<<o,o+=8;return r=f[i&(1<<d)-1],a=r>>>16,e.f=i>>a,e.d=o-a,e.a=u,65535&r}function o(e){function t(e,t,n){var r,o,s,l;for(l=0;l<e;)switch(r=i(this,t)){case 16:for(s=3+a(this,2);s--;)n[l++]=o;break;case 17:for(s=3+a(this,3);s--;)n[l++]=0;o=0;break;case 18:for(s=11+a(this,7);s--;)n[l++]=0;o=0;break;default:o=n[l++]=r}return n}var r,o,s,l,u=a(e,5)+257,d=a(e,5)+1,c=a(e,4)+4,p=new(f?Uint8Array:Array)(v.length);for(l=0;l<c;++l)p[v[l]]=a(e,3);r=n(p),o=new(f?Uint8Array:Array)(u),s=new(f?Uint8Array:Array)(d),e.j(n(t.call(e,u,r,o)),n(t.call(e,d,r,s)))}function s(t,n){var a,i;switch(this.input=t,this.a=0,!n&&(n={})||(n.index&&(this.a=n.index),n.verify&&(this.A=n.verify)),a=t[this.a++],i=t[this.a++],15&a){case C:this.method=C;break;default:e(Error("unsupported compression method"))}0!=((a<<8)+i)%31&&e(Error("invalid fcheck flag:"+((a<<8)+i)%31)),32&i&&e(Error("fdict flag is not supported")),this.q=new r(t,{index:this.a,bufferSize:n.bufferSize,bufferType:n.bufferType,resize:n.resize})}var l=void 0,u=this,f="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array,d=0,c=1,p={t:d,s:c};r.prototype.k=function(){for(;!this.m;){var t=a(this,3);switch(1&t&&(this.m=!0),t>>>=1){case 0:var n=this.input,r=this.a,i=this.c,s=this.b,u=l,p=l,h=l,m=i.length,_=l;switch(this.d=this.f=0,(u=n[r++])===l&&e(Error("invalid uncompressed block header: LEN (first byte)")),p=u,(u=n[r++])===l&&e(Error("invalid uncompressed block header: LEN (second byte)")),p|=u<<8,(u=n[r++])===l&&e(Error("invalid uncompressed block header: NLEN (first byte)")),h=u,(u=n[r++])===l&&e(Error("invalid uncompressed block header: NLEN (second byte)")),h|=u<<8,p===~h&&e(Error("invalid uncompressed block header: length verify")),r+p>n.length&&e(Error("input buffer is broken")),this.i){case d:for(;s+p>i.length;){if(_=m-s,p-=_,f)i.set(n.subarray(r,r+_),s),s+=_,r+=_;else for(;_--;)i[s++]=n[r++];this.b=s,i=this.e(),s=this.b}break;case c:for(;s+p>i.length;)i=this.e({p:2});break;default:e(Error("invalid inflate mode"))}if(f)i.set(n.subarray(r,r+p),s),s+=p,r+=p;else for(;p--;)i[s++]=n[r++];this.a=r,this.b=s,this.c=i;break;case 1:this.j(L,I);break;case 2:o(this);break;default:e(Error("unknown BTYPE: "+t))}}return this.n()};var h,m,_=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],v=f?new Uint16Array(_):_,g=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],y=f?new Uint16Array(g):g,x=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],b=f?new Uint8Array(x):x,w=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],M=f?new Uint16Array(w):w,S=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],T=f?new Uint8Array(S):S,A=new(f?Uint8Array:Array)(288);for(h=0,m=A.length;h<m;++h)A[h]=143>=h?8:255>=h?9:279>=h?7:8;var E,R,L=n(A),P=new(f?Uint8Array:Array)(30);for(E=0,R=P.length;E<R;++E)P[E]=5;var I=n(P);r.prototype.j=function(e,t){var n=this.c,r=this.b;this.o=e;for(var o,s,l,u,f=n.length-258;256!==(o=i(this,e));)if(256>o)r>=f&&(this.b=r,n=this.e(),r=this.b),n[r++]=o;else for(u=y[s=o-257],0<b[s]&&(u+=a(this,b[s])),o=i(this,t),l=M[o],0<T[o]&&(l+=a(this,T[o])),r>=f&&(this.b=r,n=this.e(),r=this.b);u--;)n[r]=n[r++-l];for(;8<=this.d;)this.d-=8,this.a--;this.b=r},r.prototype.w=function(e,t){var n=this.c,r=this.b;this.o=e;for(var o,s,l,u,f=n.length;256!==(o=i(this,e));)if(256>o)r>=f&&(n=this.e(),f=n.length),n[r++]=o;else for(u=y[s=o-257],0<b[s]&&(u+=a(this,b[s])),o=i(this,t),l=M[o],0<T[o]&&(l+=a(this,T[o])),r+u>f&&(n=this.e(),f=n.length);u--;)n[r]=n[r++-l];for(;8<=this.d;)this.d-=8,this.a--;this.b=r},r.prototype.e=function(){var e,t,n=new(f?Uint8Array:Array)(this.b-32768),r=this.b-32768,a=this.c;if(f)n.set(a.subarray(32768,n.length));else for(e=0,t=n.length;e<t;++e)n[e]=a[e+32768];if(this.g.push(n),this.l+=n.length,f)a.set(a.subarray(r,r+32768));else for(e=0;32768>e;++e)a[e]=a[r+e];return this.b=32768,a},r.prototype.z=function(e){var t,n,r,a,i=this.input.length/this.a+1|0,o=this.input,s=this.c;return e&&("number"==typeof e.p&&(i=e.p),"number"==typeof e.u&&(i+=e.u)),2>i?(n=(o.length-this.a)/this.o[2],a=n/2*258|0,r=a<s.length?s.length+a:s.length<<1):r=s.length*i,f?(t=new Uint8Array(r)).set(s):t=s,this.c=t},r.prototype.n=function(){var e,t,n,r,a,i=0,o=this.c,s=this.g,l=new(f?Uint8Array:Array)(this.l+(this.b-32768));if(0===s.length)return f?this.c.subarray(32768,this.b):this.c.slice(32768,this.b);for(t=0,n=s.length;t<n;++t)for(r=0,a=(e=s[t]).length;r<a;++r)l[i++]=e[r];for(t=32768,n=this.b;t<n;++t)l[i++]=o[t];return this.g=[],this.buffer=l},r.prototype.v=function(){var e,t=this.b;return f?this.r?(e=new Uint8Array(t)).set(this.c.subarray(0,t)):e=this.c.subarray(0,t):(this.c.length>t&&(this.c.length=t),e=this.c),this.buffer=e},s.prototype.k=function(){var t,n,r=this.input;if(t=this.q.k(),this.a=this.q.a,this.A){n=(r[this.a++]<<24|r[this.a++]<<16|r[this.a++]<<8|r[this.a++])>>>0;var a=t;if("string"==typeof a){var i,o,s=a.split("");for(i=0,o=s.length;i<o;i++)s[i]=(255&s[i].charCodeAt(0))>>>0;a=s}for(var l,u=1,f=0,d=a.length,c=0;0<d;){d-=l=1024<d?1024:d;do{u+=a[c++],f+=u}while(--l);u%=65521,f%=65521}n!==(f<<16|u)>>>0&&e(Error("invalid adler-32 checksum"))}return t};var C=8;t("Zlib.Inflate",s),t("Zlib.Inflate.prototype.decompress",s.prototype.k);var D,N,O,U,F={ADAPTIVE:p.s,BLOCK:p.t};if(Object.keys)D=Object.keys(F);else for(N in D=[],O=0,F)D[O++]=N;for(O=0,U=D.length;O<U;++O)N=D[O],t("Zlib.Inflate.BufferType."+N,F[N])}).call(Jc);for(var $c=Jc.Zlib,ep=new Array(256),tp=0;tp<256;tp++){var np=tp.toString(16);1===np.length&&(np="0"+np),ep[tp]=np}yn.prototype.getMaterialHash=function(e){var t=this.materialIdToHash[e];if(t)return t;var n=this.materialHashes.byteStride,r=xn(this.materialHashes.hashes,e*n,n);return this.materialIdToHash[e]=r,r},yn.prototype.getGeometryHash=function(e){var t=this.geomIdToHash[e];if(t)return t;var n=this.geomMetadata.byteStride,r=xn(this.geomMetadata.hashes,e*n,n);return this.geomIdToHash[e]=r,r},yn.prototype.initEmptyLists=function(){var e=this,t=e.fragments={};t.length=e.metadata.stats.num_fragments,t.numLoaded=0,t.boxes=new Float32Array(6*t.length),t.transforms=new Float32Array(12*t.length),t.materials=new Int32Array(t.length),t.geomDataIndexes=new Int32Array(t.length),t.fragId2dbId=new Int32Array(t.length),t.mesh2frag={},t.topoIndexes=null,e.geomMetadata={hashes:null,byteStride:0,version:0,numLoaded:0,hashToIndex:{}},e.materialHashes={hashes:null,byteStride:0,version:0,numLoaded:0},e.materials={name:"LMVTK Simple Materials",version:"1.0",scene:{SceneUnit:8215,YIsUp:0},materials:{}}},yn.prototype.loadAsyncResource=function(e,t,n,r,a){var i=this;this.pendingRequests++,t=bn(e,t),mc.getItem(e,t,function(e){i.pendingRequests--,r(e)},e.onFailureCallback,{asynchronous:!0,responseType:n||"arraybuffer",onprogress:a})},yn.prototype.loadAsyncProgressive=function(e,t,n,r){var a=this;t=bn(e,t),mc.getItem(e,t,function(t){n.onEnd(t),a.postLoad(e,r,n,t)},e.onFailureCallback,{asynchronous:!0,responseType:"text",ondata:function(e,t){a.aborted&&t?t.abort():n.onData(e)}})},yn.prototype.loadMetadata=function(e,t){var n=this;this.loadAsyncResource(e,t,"json",function(r){n.metadata=r,n.manifest=n.metadata.manifest,n.processMetadata(e),n.initEmptyLists();var a=n.metadata.manifest,i=a.shared_assets.pdb;for(var o in i)n.propertydb[o]&&n.propertydb[o].push(i[o]);var s=a.assets.pdb;for(var o in s)n.propertydb[o]&&n.propertydb[o].push(s[o]);a.assets.materials_pack&&(n.pendingMaterialsPack=2,n.loadAsyncResource(e,a.assets.materials_pack,null,function(t){n.hasMaterialsPack=!0,n.pendingMaterialsPack--,n.materials_pack=t,e.onLoaderEvent("materials_pack")}),n.loadAsyncResource(e,a.assets.materials_idx,null,function(t){n.materials_offsets=new Uint32Array(t.buffer),n.pendingMaterialsPack--,e.onLoaderEvent("materials_offsets")})),a.assets.animations&&n.loadAsyncResource(e,a.assets.animations,"json",function(e){n.animations=e,vn(n)}),a.assets.topology&&n.loadAsyncResource(e,t,"json",function(e){n.topology=e}),e.onLoaderEvent("otg_root"),n.postLoad(e,"metadata")})},yn.prototype.loadFragmentList=function(e,t){var n=this,r=new Nu,a=new Nu,i={x:0,y:0,z:0,w:1},o=new Ad,s=new Ou,l=4,u=new gn(function(t){if(n.metadata){var f=u.idata(),d=u.fdata(),c=n.fragments,p=c.geomDataIndexes[t]=f[0],h=c.materials[t]=f[1];if(p>n.geomMetadata.numLoaded||h>n.materialHashes.numLoaded)return console.log("Delayed fragment",t),!1;c.fragId2dbId[t]=f[2];var m=c.mesh2frag[p];void 0===m?c.mesh2frag[p]=t:Array.isArray(m)?m.push(t):c.mesh2frag[p]=[m,t];var _=0+l;r.set(d[_+0],d[_+1],d[_+2]),i.x=d[_+3],i.y=d[_+4],i.z=d[_+5],i.w=d[_+6],a.set(d[_+7],d[_+8],d[_+9]),o.compose(r,i,a),n.placementWithOffset&&o.multiplyMatrices(n.placementWithOffset,o);var v=o.elements,g=c.transforms,y=12*t;return g[y+0]=v[0],g[y+1]=v[1],g[y+2]=v[2],g[y+3]=v[4],g[y+4]=v[5],g[y+5]=v[6],g[y+6]=v[8],g[y+7]=v[9],g[y+8]=v[10],g[y+9]=v[12],g[y+10]=v[13],g[y+11]=v[14],s.min.x=-.5,s.min.y=-.5,s.min.z=-.5,s.max.x=.5,s.max.y=.5,s.max.z=.5,s.applyMatrix4(o),g=c.boxes,y=6*t,g[y+0]=s.min.x,g[y+1]=s.min.y,g[y+2]=s.min.z,g[y+3]=s.max.x,g[y+4]=s.max.y,g[y+5]=s.max.z,c.numLoaded=t+1,e.onLoaderEvent("fragment",t),!0}},52);return this.loadAsyncProgressive(e,t,u,"all_fragments"),u},yn.prototype.loadGeometryHashList=function(e,t){var n=this,r=new gn(function(e){return!!n.metadata&&(n.geomMetadata.hashes||(n.numGeoms=n.metadata.stats.num_geoms,n.geomMetadata.hashes=new Uint8Array(r.byteStride()*(n.numGeoms+1)),n.geomMetadata.byteStride=r.byteStride(),n.geomMetadata.version=r.version()),e+=1,n.geomMetadata.hashes.set(r.bdata(),e*r.byteStride()),n.geomMetadata.numLoaded=e,!0)},20);return this.loadAsyncProgressive(e,t,r,"geometry_ptrs"),r},yn.prototype.loadMaterialHashList=function(e,t){var n=this,r=new gn(function(e){return!!n.metadata&&(n.materialHashes.hashes||(n.numMaterials=n.metadata.stats.num_materials,n.materialHashes.hashes=new Uint8Array(r.byteStride()*(n.numMaterials+1)),n.materialHashes.byteStride=r.byteStride(),n.materialHashes.version=r.version()),e+=1,n.materialHashes.hashes.set(r.bdata(),e*r.byteStride()),n.materialHashes.numLoaded=e,!0)},20);return this.loadAsyncProgressive(e,t,r,"material_ptrs"),r},yn.prototype.processMetadata=function(e){var t=this,n=t.metadata;mn(t,e);var r=t.placementWithOffset;if(n.cameras&&(t.cameras=n.cameras,r))for(var a=0;a<t.cameras.length;a++){var i=t.cameras[a];i.position=new Nu(i.position.x,i.position.y,i.position.z),i.position.applyMatrix4(r),i.target=new Nu(i.target.x,i.target.y,i.target.z),i.target.applyMatrix4(r),i.up=new Nu(i.up.x,i.up.y,i.up.z),i.up.transformDirection(r)}},yn.prototype.loadRemainingSvf=function(e,t){this.loadMetadata(e,t),this.materialsCtx=this.loadMaterialHashList(e,"materials_ptrs.hl"),this.geometryCtx=this.loadGeometryHashList(e,"geometry_ptrs.hl"),this.fragmentsCtx=this.loadFragmentList(e,"fragments.fl")},yn.prototype.extractMaterialFromPack=function(e){if(this.materials_pack&&this.materials_offsets){var t,n=this.materials_offsets[e],r=(e<this.materials_offsets.length-1?this.materials_offsets[e+1]:this.materials_pack.length)-n,a=new Uint8Array(this.materials_pack.buffer,n,r),i=Bt(a=new $c.Inflate(a).decompress(),0,a.length);try{t=JSON.parse(i)}catch(e){console.error(e)}return t}return null},yn.prototype.makeSharedResourcePath=function(e,t,n){if(e){var r=n,a="";(s=this.manifest.shared_assets.global_sharding||0)&&(a="/"+n.slice(0,s),r=n.slice(s));var i=this.manifest.shared_assets[t];if(0!==i.indexOf("urn:adsk.fluent:fs.file:fluent-cdn")){var o=i.split("/");i="/"+(o[o.length-1]||o[o.length-2])+"/"}else i=i.slice(i.indexOf("/"));return e+a+i+r}var s=this.manifest.shared_assets.global_sharding||2,r=n,a="";return s&&(a="/"+n.slice(0,s)+"/",r=n.slice(s)),eu(this.basePath)+this.manifest.shared_assets[t]+a+r},yn.prototype.loadMaterial=function(t,n,r){var a;0!==(a=this.makeSharedResourcePath(t.otg_cdn,"materials",n)).indexOf("https://")&&0!==a.indexOf("http://")&&(a=t.basePath+a),mc.getItem(t.otg_cdn?{}:t,a,r,function(t){e.logger.error("Failed to load material "+n)},{asynchronous:!0,responseType:"json",withCredentials:!1})},yn.prototype.postLoad=function(t,n,r,a){n&&this.initialLoadProgress++,4===this.initialLoadProgress&&(this.materialsCtx.flush(),this.geometryCtx.flush(),this.fragmentsCtx.flush(),this.materialsCtx=null,this.geometryCtx=null,this.fragmentsCtx=null,this.fragments.numLoaded<this.metadata.stats.num_fragments&&e.logger.warn("Fragments actually loaded fewer than expected."),t.onLoaderEvent("all_fragments"))},yn.prototype.abort=function(){this.aborted=!0},yn.prototype.makeBVH=function(t){var n=this;this.manifest.assets.fragments_extra&&this.loadAsyncResource(t,this.manifest.assets.fragments_extra,"",function(r){if(r&&r.length){var a=performance.now(),i=new dn(r,n.placementWithOffset);if(i.count){var o=new Ut(null,null,i);o.build(t.bvhOptions),n.bvh={nodes:o.nodes,primitives:o.primitives};var s=performance.now();e.logger.debug("BVH build time:"+(s-a)),t.onLoaderEvent("bvh",n.bvh)}}})};var rp="meshReceived",ap="meshFailed",ip=function(){var e=null;return function(t,n,r){return e||(e=new Nu),e.copy(t),e.max(n),e.min(r),e.distanceToSquared(t)}}(),op=function(){var e=null;return function(t,n,r){e||(e=new Ou);var a=Tn(n,t,e);if(r.intersectsBox(a)===Yu.OUTSIDE)return 0;var i=Yu.INTERSECTS,o=r.projectedBoxArea(a,i),s=ip(r.eye,a.min,a.max);return s=Math.max(s,.01),o/s}}();t.EventDispatcher.prototype.apply(An.prototype);var sp=function(t){this.delegate=gc.copyDelegate(this,t);var n=this;this.delegate.loadPropertyDb||(this.delegate.loadPropertyDb=function(e,t){n.svf.propDbLoader=new Tc(e,t,n.delegate),n.svf.propDbLoader.load()}),this.delegate.loadModelTextures||(this.delegate.loadModelTextures=function(e){Hc.loadModelTextures(n.delegate,e)}),this.delegate.loadMaterialTextures||(this.delegate.loadMaterialTextures=function(e,t){Hc.loadMaterialTextures(n.delegate,e,t)}),this.loading=!1,this.tmpMatrix=new Ad,this.tmpBox=new Ou,this.logger=e.logger,this.loadTime=0,this.pendingMaterials={},this.pendingMaterialIds=[],this.pendingMaterialsCount=0,this.operationsDone=0};sp.prototype.dtor=function(){this.initWorkerScriptToken&&(this.initWorkerScriptToken.cancel(),this.initWorkerScriptToken=null,e.logger.debug("SVF loader dtor: on init worker script.")),this.bvhWorker&&(this.bvhWorker.clearAllEventListenerWithIntercept(),this.bvhWorker.terminate(),this.bvhWorker=null,e.logger.debug("SVF loader dtor: on svf worker.")),this.svf&&(this.svf.loadDone||console.log("stopping load before it was complete"),this.svf.abort(),this.svf.propWorker&&(this.svf.propWorker.dtor(),this.svf.propWorker=null)),this.geomCache&&this.model&&(this.loading&&this.geomCache.cancelRequests(this.svf.geomMetadata.hashToIndex),this.removeMeshReceiveListener()),this.delegate=null,this.model=null,this.svf=null,this.logger=null,this.tmpMatrix=null,this.loading=!1,this.loadTime=0},sp.prototype.isValid=function(){return null!=this.delegate},sp.prototype.removeMeshReceiveListener=function(){this.meshReceiveListener&&(this.geomCache.removeEventListener(rp,this.meshReceiveListener),this.geomCache.removeEventListener(ap,this.meshReceiveListener),this.meshReceiveListener=null)},sp.prototype.loadFile=function(t,n,r,a){if(!this.delegate)return e.logger.log("OTG loader was already destructed. So no longer usable."),!1;if(this.loading)return e.logger.log("Loading of OTG already in progress. Ignoring new request."),!1;if(this.geomCache=this.delegate.getGeomCache(),!this.geomCache)return e.logger.log("GeomCache not provided so OTG loader cannot load the model"),!1;this.loading=!0,this.delegate.eventTarget.dispatchEvent({type:"fileLoadStarted",loader:this});var i=t.indexOf("urn:");if(-1!=i){var o=(t=decodeURIComponent(t)).substr(i,t.substr(i).indexOf("/"));e.logger.log("Extracted URN: "+o);var s=o.lastIndexOf(":");this.svfUrn=o.substr(s+1)}else this.svfUrn=t;this.sharedDbPath=n.sharedPropertyDbPath,this.currentLoadPath=t;var l="",u=this.currentLoadPath.lastIndexOf("/");-1!=u&&(l=this.currentLoadPath.substr(0,u+1)),this.basePath=l,this.acmSessionId=n.acmSessionId,this.options=n;var f={basePath:l,objectIds:n.ids,globalOffset:n.globalOffset,placementTransform:n.placementTransform,applyRefPoint:n.applyRefPoint,queryParams:n.acmSessionId?"acmsession="+n.acmSessionId:"",bvhOptions:n.bvhOptions||{isWeakDevice:Yl()},applyScaling:n.applyScaling,loadInstanceTree:n.loadInstanceTree};return this.loadContext=this.delegate.initLoadContext(f),f.onFailureCallback=function(e,t,n){r&&r({code:e,message:t,data:n})},this.loadModelRoot(f,r),a&&a(),!0},sp.prototype.loadModelRoot=function(t,n){this.t0=(new Date).getTime(),this.firstPixelTimestamp=null;var r=this,a=this.svf=new yn;return a.basePath=t.basePath,t.onLoaderEvent=function(t,i){if(r.svf){if("otg_root"===t){r.onModelRootLoadDone(a),n&&n(null,r.model),r.makeBVHInWorker();var o=r.geomCache;o||e.logger.error("geomCache is required for loading OTG models.");var s=r.svf.manifest.assets.geometry_pack;if(s){0!==s.indexOf("https://")&&0!==s.indexOf("http://")&&(s=eu(r.basePath)+s);var l=r.svf.manifest.assets.geometry_idx;0!==l.indexOf("https://")&&0!==l.indexOf("http://")&&(l=eu(r.basePath)+l),o.initWorker(s,l,r.svf.metadata.stats.geometry_pack_fanout)}r.meshReceiveListener=function(e){e.error&&e.error.args?r.onMeshError(e):r.onMeshReceived(e.geom)},o.addEventListener(rp,r.meshReceiveListener),o.addEventListener(ap,r.meshReceiveListener),r.svf.loadDone=!1}else if("fragment"===t)r.options.skipMeshLoad||r.tryToActivateFragment(i,"fragment");else if("all_fragments"===t)r.options.skipPropertyDb||r.delegate.loadPropertyDb(r.sharedDbPath,r.model),r.delegate.eventTarget.dispatchEvent({type:"svfLoaded",svf:a,model:r.model}),r.options.skipMeshLoad?r.onGeomLoadDone():r.onOperationComplete();else if("bvh"===t){var u=i;r.model&&(r.model.setBVH(u.nodes,u.primitives,r.options.bvhOptions),r.delegate.renderScene&&r.delegate.renderScene.findModel(r.model.id)&&r.delegate.requestRedraw(!1)),r.onOperationComplete()}else if(("materials_pack"===t||"materials_offsets"===t)&&r.svf.materials_pack&&r.svf.materials_offsets){for(var f=0;f<r.pendingMaterialIds.length;f++){var d=r.pendingMaterialIds[f],c=r.svf.getMaterialHash(d),p=r.svf.extractMaterialFromPack(d);r.onMaterialLoaded(p,c,d)}r.pendingMaterialIds=null}}else console.error("load callback called after load was aborted")},a.loadRemainingSvf(t,eu(this.currentLoadPath)),!0},sp.prototype.makeBVHInWorker=function(){var e=this;this.initWorkerScriptToken=this.delegate.workerScript.initWorkerScript(function(){e.bvhWorker=e.delegate.workerScript.createWorkerWithIntercept();e.bvhWorker.addEventListenerWithIntercept(function(t){if(t.data.bvh){console.log("Received BVH from worker");var n=t.data.bvh;e.model&&(e.svf.bvh=n,e.model.setBVH(new Nt(n.nodes,n.useLeanNodes),n.primitives,e.options.bvhOptions),e.delegate&&e.delegate.renderScene.findModel(e.model.id)&&e.delegate.requestRedraw(!1)),e.bvhWorker.clearAllEventListenerWithIntercept(),e.bvhWorker.terminate(),e.bvhWorker=null,e.onOperationComplete()}});var t=Object.assign({},e.loadContext);t.operation="LOAD_OTG_BVH",t.onFailureCallback=null,t.onLoaderEvent=null,t.fragments_extra=eu(e.basePath)+e.svf.manifest.assets.fragments_extra,t.placementTransform=e.svf.placementTransform,t.placementWithOffset=e.svf.placementWithOffset,t.globalOffset=e.svf.globalOffset,e.bvhWorker.doOperation(t)})};var lp={};sp.prototype.tryToActivateFragment=function(e,t){var n=this;if(n.model){var r=n.svf,a=n.model,i=a.getGeometryList(),o=r.fragments.materials[e],s=r.getMaterialHash(o),l=!1;this.findOrLoadMaterial(a,s,o)||("fragment"===t&&this.pendingMaterials[s].push(e),"material"!==t?l=!0:console.log("material loading probably failed"));var u=r.fragments.geomDataIndexes[e];if(0===u){if(r.failedFrags[e])return;return r.failedFrags[e]=1,void n.trackGeomLoadProgress(r,e)}a.getFragmentList().getOriginalWorldMatrix(e,n.tmpMatrix);var f=i.getGeometry(u);f||("fragment"===t&&this.loadGeometry(u,this.options.createWireframe?n.tmpMatrix:null),l=!0),l||(lp.geometry=f,lp.material=this.delegate.matman.setupMaterial(a,f,s),lp.matrix=n.tmpMatrix,lp.isLine=f.isLines,lp.isWideLine=f.isWideLines,lp.isPoint=f.isPoints,lp.is2d=f.is2d,lp.geomId=u,a.activateFragment(e,lp,!!r.placementTransform),this.geomCache.updateGeomImportance(a,e),n.trackGeomLoadProgress(r,e))}},sp.prototype.onModelRootLoadDone=function(t){t.isOTG=!0,t.geomMetadata.hashToIndex={},t.failedFrags={},t.geomMemory=0,t.gpuNumMeshes=0,t.gpuMeshMemory=0,t.fragsLoaded=0,t.nextRepaintPolys=0,t.numRepaints=0,t.urn=this.svfUrn,t.acmSessionId=this.acmSessionId,t.basePath=this.basePath,t.loadOptions=this.options;var n=Date.now();this.loadTime+=n-this.t0,e.logger.log("SVF load: "+(n-this.t0));var r=this.model=new this.delegate.model(t);if(r.loader=this,r.initialize(),this.t0=n,t.bbox=(new Ou).copy(t.bbox),t.refPointTransform&&(t.refPointTransform=new Ad(!0).copy(t.refPointTransform)),t.placementTransform&&(t.placementTransform=new Ad(!0).copy(t.placementTransform)),t.cameras)for(var a=0;a<t.cameras.length;a++){var i=t.cameras[a];i.position=(new Nu).copy(i.position),i.target=(new Nu).copy(i.target),i.up=(new Nu).copy(i.up)}e.logger.log("scene bounds: "+JSON.stringify(t.bbox));var o={category:"metadata_load_stats",urn:t.urn,has_topology:!!t.topology,has_animations:!!t.animations,materials:t.metadata.stats.num_materials,is_mobile:Yl()};e.logger.track(o),this.delegate.signalProgress(0)},sp.prototype.trackGeomLoadProgress=function(e,t){var n=En(e);e.fragsLoaded++;var r=En(e);r>n&&this.delegate.signalProgress(r),this.model.getGeometryList().geomPolyCount>e.nextRepaintPolys&&(this.firstPixelTimestamp=this.firstPixelTimestamp||Date.now(),e.numRepaints++,e.nextRepaintPolys+=1e4*Math.pow(1.5,e.numRepaints),this.delegate.renderScene.findModel(this.model.id)&&this.delegate.requestRedraw(!1)),e.fragsLoaded===e.metadata.stats.num_fragments&&this.onOperationComplete()},sp.prototype.onOperationComplete=function(){3===++this.operationsDone&&this.onGeomLoadDone()},sp.prototype.onMaterialLoaded=function(e,t,n){var r=this.delegate.matman;if(e){e.hash=t;var a=r.convertSharedMaterial(this.model,e,t);this.delegate.loadMaterialTextures(this.model,a),r.hasTwoSidedMaterials()&&this.delegate.toggleTwoSided(!0);for(var i=this.pendingMaterials[t],o=0;o<i.length;o++)this.tryToActivateFragment(i[o],"material")}else console.error('Got null pointer for "matObj" for "matHash" '+t);this.pendingMaterialsCount--,delete this.pendingMaterials[t]},sp.prototype.findOrLoadMaterial=function(e,t,n){var r=this.model.getData();if(this.delegate.matman.findMaterial(e,t))return!0;if(this.pendingMaterials[t])return!1;if(this.pendingMaterialsCount++,this.pendingMaterials[t]=[],r.hasMaterialsPack||r.pendingMaterialsPack){var a=r.extractMaterialFromPack(n);return a?(this.onMaterialLoaded(a,t,n),!0):(this.pendingMaterialIds.push(n),!1)}var i=this;return this.svf.loadMaterial(this.loadContext,t,function(e){i.onMaterialLoaded(e,t,n)}),!1},sp.prototype.loadGeometry=function(e,t){var n=this.svf,r=!!this.loadContext.otg_cdn,a=n.getGeometryHash(e);n.geomMetadata.hashToIndex[a]=e;var i=n.makeSharedResourcePath(this.loadContext.otg_cdn,"geometry",a);this.geomCache.requestGeometry(i,r,a,e,r?"":this.queryParam,t)},sp.prototype.onMeshError=function(e){var t=this.svf.fragments,n=this.svf.geomMetadata.hashToIndex[e.error.args.hash],r=t.mesh2frag[n],a=this.svf.basePath+this.svf.manifest.assets.geometry_ptrs;if(console.warn("Error loading mesh",e.error.args.hash,"(GeomId: "+n+", HashFile: "+a+")"),void 0!==r)if(Array.isArray(r))for(var i=0;i<r.length;i++)this.trackGeomLoadProgress(this.svf,r[i]);else this.trackGeomLoadProgress(this.svf,r)},sp.prototype.onMeshReceived=function(e){var t=this.model;if(t){var n=t.getGeometryList(),r=this.svf.fragments,a=this.svf.geomMetadata.hashToIndex[e.hash];if(void 0!==a){var i=n.getGeometry(a),o=r.mesh2frag[a];if(!i&&(n.addGeometry(e,o&&o.length||1,a),this.svf.loadDone&&console.error("Geometry received after load was done"),void 0!==o))if(Array.isArray(o))for(var s=0;s<o.length;s++)this.tryToActivateFragment(o[s],"geom");else this.tryToActivateFragment(o,"geom")}}else console.warn("Received geometry after loader was done. Possibly leaked event listener?",e.hash)},sp.prototype.onGeomLoadDone=function(){if(this.svf.loadDone=!0,this.removeMeshReceiveListener(),this.delegate.loadModelTextures(this.model),this.options.skipMeshLoad)return this.currentLoadPath=null,void this.delegate.eventTarget.dispatchEvent({type:"geometryDownloadComplete",model:this.model,memoryLimited:!1});this.svf.fragments.entityIndexes=null,this.svf.fragments.mesh2frag=null;var t=Date.now(),n="Fragments load time: "+(t-this.t0);this.loadTime+=t-this.t0;var r=this.firstPixelTimestamp-this.t0;if(n+=" (first pixel time: "+r+")",e.logger.log(n),this.options.useConsolidation&&this.delegate.webGLRenderer){var a=this.delegate.webGLRenderer;this.model.consolidate(this.delegate.matman,this.options.consolidationMemoryLimit,a)}var i={category:"model_load_stats",is_f2d:!1,has_prism:this.delegate.matman.hasPrism,load_time:this.loadTime,geometry_size:this.model.getGeometryList().geomMemory,meshes_count:this.svf.metadata.stats.num_geoms,fragments_count:this.svf.metadata.stats.num_fragments,urn:this.svfUrn};r>0&&(i.first_pixel_time=r),e.logger.track(i),this.currentLoadPath=null,this.delegate.eventTarget.dispatchEvent({type:"geometryDownloadComplete",model:this.model,memoryLimited:!1})},sp.prototype.is3d=function(){return!0};var up=["degree","radian","millimeter","centimeter","meter","kilometer","inch","foot","mile"],fp={mm:"millimeter",cm:"centimeter",m:"meter",km:"kilometer",in:"inch",ft:"foot"},dp=["AssetLibID","Hidden","thumbnail","unifiedbitmap_Bitmap","bumpmap_Bitmap","BaseSchema","UIName","revision","opaque_albedo_urn","opaque_f0_urn","opaque_luminance_modifier_urn","opaque_mfp_modifier_urn","surface_albedo_urn","surface_anisotropy_urn","surface_cutout_urn","surface_normal_urn","surface_rotation_urn","surface_roughness_urn"],cp=["beckmann","ggx"],pp={surface_ndf_type:cp,layered_ndf_type:cp,bumpmap_Type:["height","normal"],wood_pore_type:["both","earlywood","latewood"],common_Shared_Asset:[0,1]},hp={strings:function(e,t){var n=Dn(e,t);return Array.isArray(n)||(n.hasOwnProperty("default")||Rn(t,e,"String object missing a default language value."),n=n.default),Array.isArray(n)||Rn(e,t,"Expected an array value."),1===n.length?n[0]:n},booleans:function(e,t){if("boolean"==typeof t)return t;var n=On(e,t);return"boolean"!=typeof n&&Rn(e,n,"Boolean value expected."),n},scalars:function(e,t,n){var r=["wood_earlywood_sharpness","wood_latewood_ratio","wood_fiber_roughness","wood_late_color_power","wood_ray_ellipse_z2x","wood_diffuse_perlin_scale_z","wood_latewood_sharpness","wood_diffuse_lobe_weight","wood_groove_roughness","wood_secondary_perlin_scale_z","wood_ray_color_power","wood_fiber_perlin_scale_z","wood_secondary_color_power","wood_pore_color_power","wood_curly_distortion_scale","bumpmap_RGBAmount","bumpmap_UOffset","bumpmap_VOffset","bumpmap_UScale","bumpmap_VScale","unifiedbitmap_RGBAmount","unifiedbitmap_UOffset","unifiedbitmap_VOffset","unifiedbitmap_UScale","unifiedbitmap_VScale","opaque_luminance","transparent_ior","illuminance","white_luminance"];if(["wood_growth_perlin_prof","wood_fiber_perlin_prof","wood_diffuse_perlin_prof","wood_earlycolor_perlin_prof","wood_latecolor_perlin_prof","wood_fiber_cosine_prof","wood_secondary_perlin_prof","center_direction","up_direction"].indexOf(e)>=0)return Nn(e,t);if(r.indexOf(e)>=0)return Nn(e,t)[0];var a=Cn(e,t),i=In(e,t,n);if(i)return a&&(i.unit=a),i;if(n.unitsProps?n.unitsProps[e]:a)return{value:On(e,t),unit:a||"inch"};var o=Nn(e,t);return o=1===o.length?o[0]:o,n.scalarValues?o:{value:o}},integers:function(e,t){if("number"==typeof t)return t;var n=On(e,t);return Number.isInteger(n)||Rn(e,n,"Integer value expected."),n},colors:function(e,t,n){var r=In(e,t,n);if(r)return r;var a=On(e,t);return a.hasOwnProperty("r")&&a.hasOwnProperty("g")&&a.hasOwnProperty("b")||Rn(a,e,"Expected a color object with r, g and b fields."),{value:{linearFloat:[a.r,a.g,a.b]}}},choicelists:function(e,t){var n=On(e,t);pp.hasOwnProperty(e)||Rn(e,n,"Unknown choice type key.");var r=pp[e];return(n<0||n>=r.length)&&Rn(e,n,"Choice value is out of range."),pp[e][n]},uris:function(e,t,n){t.hasOwnProperty("binary_connections")||Rn(e,t,"Expected binary connections field in value.");var r=t.binary_connections;if(1===r.length)return Pn(e,r[0],n);Rn(e,t,"Invalid binary connections field.")}},mp={texture_RealWorldScaleX:!0,texture_RealWorldScaleY:!0,texture_RealWorldOffsetX:!0,texture_RealWorldOffsetY:!0,bumpmap_Depth:!0,bumpmap_RealWorldScaleX:!0,bumpmap_RealWorldScaleY:!0,bumpmap_RealWorldOffsetX:!0,bumpmap_RealWorldOffsetY:!0,unifiedbitmap_RealWorldScaleX:!0,unifiedbitmap_RealWorldScaleY:!0,unifiedbitmap_RealWorldOffsetX:!0,unifiedbitmap_RealWorldOffsetY:!0},_p={bumpmap_RealWorldScaleX:"texture_RealWorldScaleX",bumpmap_RealWorldScaleY:"texture_RealWorldScaleY",bumpmap_RealWorldOffsetX:"texture_RealWorldOffsetX",bumpmap_RealWorldOffsetY:"texture_RealWorldOffsetY",bumpmap_UScale:"texture_UScale",bumpmap_VScale:"texture_VScale",bumpmap_UOffset:"texture_UOffset",bumpmap_VOffset:"texture_VOffset",bumpmap_URepeat:"texture_URepeat",bumpmap_VRepeat:"texture_VRepeat",bumpmap_WAngle:"texture_WAngle",unifiedbitmap_RealWorldScaleX:"texture_RealWorldScaleX",unifiedbitmap_RealWorldScaleY:"texture_RealWorldScaleY",unifiedbitmap_RealWorldOffsetX:"texture_RealWorldOffsetX",unifiedbitmap_RealWorldOffsetY:"texture_RealWorldOffsetY",unifiedbitmap_UScale:"texture_UScale",unifiedbitmap_VScale:"texture_VScale",unifiedbitmap_UOffset:"texture_UOffset",unifiedbitmap_VOffset:"texture_VOffset",unifiedbitmap_URepeat:"texture_URepeat",unifiedbitmap_VRepeat:"texture_VRepeat",unifiedbitmap_WAngle:"texture_WAngle"},vp={height:0,normal:1},gp={beckmann:0,ggx:1},yp={millimeter:1e3,MilliMeter:1e3,mm:1e3,8206:1e3,decimeter:10,DeciMeter:10,dm:10,8204:10,centimeter:100,CentiMeter:100,cm:100,8205:100,meter:1,Meter:1,m:1,8193:1,kilometer:.001,KiloMeter:.001,km:.001,8201:.001,inch:39.37008,Inch:39.37008,in:39.37008,8214:39.37008,foot:3.28084,Foot:3.28084,ft:3.28084,8215:3.28084,mile:62137e-8,Mile:62137e-8,mi:62137e-8,8225:62137e-8,Yard:1.09361,yard:1.09361,yd:1.09361,8221:1.09361},xp=void 0,bp=void 0,wp={convertMaterial:function(e,n,r,a){if(a){if(!a.isPrismMaterial)return null;a.needsUpdate=!0}else a=cf();a.proteinMat=e,a.proteinCategories=e.options.tags,a.packedNormals=!0,a.name=e.options.data.private_tags[2],a.tag=e.options.data.private_tags[2],a.prismType=e.options.data.protein_type||"",a.side=t.DoubleSide,a.transparent=!1,a.envExponentMin=1,a.envExponentMax=512,a.envExponentCount=10;var i=r||{};switch(a.surface_albedo=Bn(e.options.data.surface_albedo),i.surface_albedo_map=Hn(e.options.data.surface_albedo),a.surface_anisotropy=Wn(e.options.data.surface_anisotropy),i.surface_anisotropy_map=Hn(e.options.data.surface_anisotropy),i.surface_cutout_map=kn(e.options.data.surface_cutout),a.surface_ndf_type=gp[e.options.data.surface_ndf_type]||1,i.surface_normal_map=Hn(e.options.data.surface_normal),a.surface_rotation=jn(e.options.data.surface_rotation,!0),i.surface_rotation_map=Hn(e.options.data.surface_rotation),a.surface_roughness=Wn(e.options.data.surface_roughness,.2),i.surface_roughness_map=Hn(e.options.data.surface_roughness),i.surface_cutout_map&&(a.side=t.DoubleSide,a.transparent=!0),a.prismType){case"PrismOpaque":a.opaque_albedo=Bn(e.options.data.opaque_albedo),i.opaque_albedo_map=Hn(e.options.data.opaque_albedo),a.opaque_emission=!!e.options.data.opaque_emission||!1,a.opaque_f0=Wn(e.options.data.opaque_f0,.02),i.opaque_f0_map=Hn(e.options.data.opaque_f0),a.opaque_luminance=e.options.data.opaque_luminance||0,a.opaque_luminance_modifier=Bn(e.options.data.opaque_luminance_modifier,!0),i.opaque_luminance_modifier_map=Hn(e.options.data.opaque_luminance_modifier),a.opaque_mfp=qn(e.options.data.opaque_mfp,n,"millimeter"),a.opaque_mfp_modifier=Bn(e.options.data.opaque_mfp_modifier),i.opaque_mfp_modifier_map=Hn(e.options.data.opaque_mfp_modifier),a.opaque_translucency=!!e.options.data.opaque_translucency||!1;break;case"PrismMetal":a.metal_f0=Bn(e.options.data.metal_f0,!0),i.metal_f0_map=Hn(e.options.data.metal_f0);break;case"PrismLayered":a.layered_anisotropy=Wn(e.options.data.layered_anisotropy),i.layered_anisotropy_map=Hn(e.options.data.layered_anisotropy),a.layered_bottom_f0=Bn(e.options.data.layered_bottom_f0,!0),i.layered_bottom_f0_map=Hn(e.options.data.layered_bottom_f0),a.layered_diffuse=Bn(e.options.data.layered_diffuse,!0),i.layered_diffuse_map=Hn(e.options.data.layered_diffuse),a.layered_f0=Wn(e.options.data.layered_f0,.02),i.layered_f0_map=Hn(e.options.data.layered_f0),a.layered_fraction=Wn(e.options.data.layered_fraction,.5),i.layered_fraction_map=Hn(e.options.data.layered_fraction),a.layered_ndf_type=gp[e.options.data.layered_ndf_type]||1,i.layered_normal_map=Hn(e.options.data.layered_normal),a.layered_rotation=jn(e.options.data.layered_rotation,!0),i.layered_rotation_map=Hn(e.options.data.layered_rotation),a.layered_roughness=Wn(e.options.data.layered_roughness,.2),i.layered_roughness_map=Hn(e.options.data.layered_roughness);break;case"PrismTransparent":a.transparent=!0,a.transparent_color=Bn(e.options.data.transparent_color,!0),a.transparent_distance=qn(e.options.data.transparent_distance,n,"inch",.125),a.transparent_ior=e.options.data.transparent_ior||1.5;break;case"PrismWood":Kn(a,e,"diffuse_perlin"),Kn(a,e,"earlycolor_perlin"),Kn(a,e,"fiber_cosine"),Kn(a,e,"fiber_perlin"),Kn(a,e,"growth_perlin"),Kn(a,e,"latecolor_perlin"),i.wood_curly_distortion_map=kn(e.options.data.wood_curly_distortion_map),a.wood_curly_distortion_enable=Wn(e.options.data.wood_curly_distortion_enable),a.wood_curly_distortion_scale=Wn(e.options.data.wood_curly_distortion_scale),a.wood_diffuse_lobe_weight=Wn(e.options.data.wood_diffuse_lobe_weight),a.wood_diffuse_perlin_scale_z=Wn(e.options.data.wood_diffuse_perlin_scale_z),a.wood_early_color=Bn(e.options.data.wood_early_color,!0),a.wood_earlywood_sharpness=Wn(e.options.data.wood_earlywood_sharpness),a.wood_latewood_sharpness=Wn(e.options.data.wood_latewood_sharpness),a.wood_fiber_perlin_scale_z=Wn(e.options.data.wood_fiber_perlin_scale_z),a.wood_groove_roughness=Wn(e.options.data.wood_groove_roughness),a.wood_late_color_power=Wn(e.options.data.wood_late_color_power),a.wood_latewood_bump_depth=Wn(e.options.data.wood_latewood_bump_depth),a.wood_latewood_ratio=Wn(e.options.data.wood_latewood_ratio),a.wood_manual_late_color=Bn(e.options.data.wood_manual_late_color,!0),a.wood_pore_cell_dim=Wn(e.options.data.wood_pore_cell_dim),a.wood_pore_color_power=Wn(e.options.data.wood_pore_color_power),a.wood_pore_depth=Wn(e.options.data.wood_pore_depth),a.wood_pore_radius=Wn(e.options.data.wood_pore_radius),a.wood_pore_type=Wn(e.options.data.wood_pore_type),a.wood_ray_color_power=Wn(e.options.data.wood_ray_color_power),a.wood_ray_ellipse_radius_x=Wn(e.options.data.wood_ray_ellipse_radius_x),a.wood_ray_ellipse_z2x=Wn(e.options.data.wood_ray_ellipse_z2x),a.wood_ray_num_slices=Wn(e.options.data.wood_ray_num_slices),a.wood_ray_seg_length_z=Wn(e.options.data.wood_ray_seg_length_z),a.wood_ring_thickness=Wn(e.options.data.wood_ring_thickness),a.wood_use_groove_roughness=Wn(e.options.data.wood_use_groove_roughness),a.wood_use_latewood_bump=Wn(e.options.data.wood_use_latewood_bump),a.wood_use_manual_late_color=Wn(e.options.data.wood_use_manual_late_color),a.wood_use_pores=Wn(e.options.data.wood_use_pores),a.wood_use_rays=Wn(e.options.data.wood_use_rays),bp||Yn(),a.uniforms.permutationMap.value=bp.permutation,a.uniforms.gradientMap.value=bp.gradient,a.uniforms.perm2DMap.value=bp.perm2d,a.uniforms.permGradMap.value=bp.permGrad;break;default:t.warn("Unknown Prism type: "+a.prismType)}return a.enableImportantSampling&&(a.surface_anisotropy||a.surface_rotation||a.layered_anisotropy||a.layered_rotation)&&(xp||Xn(),a.uniforms.importantSamplingRandomMap.value=xp.randomNum,a.uniforms.importantSamplingSolidAngleMap.value=xp.solidAngle),a.defines={},a.textureMaps={},a.defines[a.prismType.toUpperCase()]="","PrismWood"===a.prismType&&a.enable3DWoodBump&&(a.defines.PRISMWOODBUMP=""),a.enableImportantSampling&&(a.defines.ENABLEIMPORTANTSAMPLING=""),a.transparent&&(a.lmv_depthWriteTransparent=!0,a.depthWrite=!0),Object.keys(i).forEach(function(e){i[e]?(a.textureMaps[e]={mapName:e,isPrism:!0},a.defines["USE_"+e.toUpperCase()]=""):delete i[e]}),a},convertTexture:function(e,n,r,a){var i=e.textureObj;n.name=i.options.title,n.clampS=(i.options.data.texture_URepeat,!1),n.clampT=(i.options.data.texture_VRepeat,!1),n.wrapS=n.clampS?t.ClampToEdgeWrapping:t.RepeatWrapping,n.wrapT=n.clampT?t.ClampToEdgeWrapping:t.RepeatWrapping;var o=qn(i.options.data.texture_RealWorldOffsetX,r,"inch"),s=qn(i.options.data.texture_RealWorldOffsetY,r,"inch"),l=i.options.data.texture_UOffset||0,u=i.options.data.texture_VOffset||0,f=void 0,d=void 0;f=qn(i.options.data.texture_RealWorldScaleX,r,"inch",1),d=qn(i.options.data.texture_RealWorldScaleY,r,"inch",1);var c=i.options.data.texture_UScale||1,p=i.options.data.texture_VScale||1,h=jn(i.options.data.texture_WAngle,!1),m=Math.cos(h),_=Math.sin(h),v=c/f,g=p/d;if(n.matrix={elements:[m*v,_*g,0,-_*g,m*g,0,-m*v*o+_*g*s+l,-_*v*o-m*g*s+u,1]},"BumpMap"===i.options.data.protein_type)if(n.bumpmapType=vp[i.options.data.bumpmap_Type]||0,0===n.bumpmapType){var y=qn(i.options.data.bumpmap_Depth,r,"inch",1);n.bumpScale=new t.Vector2(y/f,y/d)}else{var x=i.options.data.bumpmap_NormalScale||1;n.bumpScale=new t.Vector2(x,x)}else n.invert=i.options.data.unifiedbitmap_Invert||!1}},Mp=function(){function e(t,n,r,a,i){sd(this,e),this._aesMaterials={},this._nextId=-1,this._model=t,this._textureDelegate={eventTarget:n,matman:r,initLoadContext:a,webGLRenderer:i};var o=t.getData();if(this._nextId=0,o&&o.materials){for(var s in o.materials.materials){this._aesMaterials[s]=void 0;var l=parseInt(s,10);this._nextId<l&&(this._nextId=l)}++this._nextId}}return ld(e,[{key:"getMaterialIds",value:function(){return Object.keys(this._aesMaterials)}},{key:"getMaterialUrn",value:function(e){return this._aesMaterials.hasOwnProperty(e)?"mid:"+e:null}},{key:"getMaterialId",value:function(e){if(null==e)return null;if("mid:"!=e.substr(0,4))return null;var t=e.substr(4);return this._aesMaterials.hasOwnProperty(t)?t:null}},{key:"getRootObjectId",value:function(){var e=this._model.getFragmentMap();return e?e.getRootId():0}},{key:"enumerateChildObjectIds",value:function(e,t,n){var r=this._model.getFragmentMap();return!!r&&(r.enumNodeChildren(e,t,n),!0)}},{key:"getObjectUrn",value:function(e){var t=void 0;if(e)if(Array.isArray(e)){var n=[];e.forEach(function(e){n.push(e?"dbid:"+e.toString():null)}),t=n}else t="dbid:"+e.toString();else t=null;return Promise.resolve(t)}},{key:"getObjectId",value:function(e){var t=void 0;if(e)if(Array.isArray(e)){var n=[];e.forEach(function(e){if(e&&"dbid:"==e.substr(0,5)){var t=e.substr(5);n.push(parseInt(t))}else n.push(0)}),t=n}else if("dbid:"!=e.substr(0,5))t=0;else{var r=e.substr(5);t=parseInt(r)}else t=0;return Promise.resolve(t)}},{key:"getMaterialDefinition",value:function(e){if(!this._aesMaterials.hasOwnProperty(e))return null;var t=this._aesMaterials[e];if(void 0!==t)return t;var n=this._model.getData(),r=n.materials.materials[e];if(n.proteinMaterials){var a=n.proteinMaterials.materials[e];a&&Ef.isPrismMaterial(a)&&(r=a)}var i=this,o=r?Vn(r,function(t){var n=null;n=i._textureDelegate.matman.lookupMaterial(i._model,e);var r={},a={url:Hc.calculateTexturePath(i._model,t,n,i._textureDelegate.initLoadContext,r).path};return r.asset&&(a.size=r.asset.size),a}):null;return this._aesMaterials[e]=o,o}},{key:"_parseMaterial",value:function(e,t,n,r){var a=n||this._nextId.toString(),i=this._model.getData(),o=i&&i.materials?i.materials.scene.SceneUnit:"inch";if(e.hasOwnProperty("userassets")&&e.hasOwnProperty("materials"))this._textureDelegate.matman.convertOneMaterial(this._model,e,a);else{var s=wp.convertMaterial(e,o,t,this._textureDelegate.matman.lookupMaterial(this._model,a));if(!s)return null;n||(this._textureDelegate.matman.addObjectMaterial(this._model,s,a),++this._nextId)}return this._aesMaterials[a]=e,a}},{key:"createMaterial",value:function(e,t){return this._parseMaterial(e,t)}},{key:"updateMaterial",value:function(e,t,n){return!("string"!=typeof e||!e||!this._aesMaterials.hasOwnProperty(e))&&!!this._parseMaterial(t,n,e)}},{key:"setTextureDefinition",value:function(e,t,n){var r=this._textureDelegate.matman.lookupMaterial(this._model,e);return!!r&&(n.properties||(n.properties={}),n.properties.booleans||(n.properties.booleans={}),n.properties.booleans.texture_URepeat={values:[n.options.data.texture_URepeat]},n.properties.booleans.texture_VRepeat={values:[n.options.data.texture_VRepeat]},Hc.setTextureDefinition(this._textureDelegate,this._model,r,t,n))}},{key:"loadTexture",value:function(e,t,n,r){var a=this;return new Promise(function(i,o){var s=a._textureDelegate.matman.lookupMaterial(a._model,e);s?Hc.loadTexture(a._textureDelegate,a._model,s,t,n,r,!1,wp.convertTexture,function(a,s){a?o(a):i({matid:e,mapName:t,urn:n,url:r})})||o("Invalid Arguments"):o("Invalid Material Id")})}},{key:"getObjectMaterialIds",value:function(e){var t=this._model.getFragmentMap();if(!t)return null;var n=this._model.getData().fragments;if(!n)return null;var r=[];return t.enumNodeFragments(e,function(e){var t=n.materials[e].toString();r.push(t)},!1),r}},{key:"getObjectVisibility",value:function(e){return!this._model.visibilityManager||this._model.visibilityManager.isNodeVisible(e)}},{key:"setObjectMaterials",value:function(e,t){var n=this._model.getFragmentMap();if(!n)return!1;var r=this._model,a=this._model.getData().fragments;if(!a)return null;var i=this._model.getFragmentList(),o=this._textureDelegate,s=void 0;if(Array.isArray(t)){var l=0;s=function(e){var n=t[l++];if(n){a.materials[e]=parseInt(n);var s=o.matman.lookupMaterial(r,n);s&&i.setMaterial(e,s)}}}else{var u=this._textureDelegate.matman.lookupMaterial(r,t);if(u){var f=parseInt(t);s=function(e){a.materials[e]=f,i.setMaterial(e,u)}}}return n.enumNodeFragments(e,s,!1),!0}},{key:"setObjectVisibility",value:function(e,t){return!!this._model.visibilityManager&&(t?this._model.visibilityManager.show(e):this._model.visibilityManager.hide(e),!0)}}]),e}(),Sp=Zn.version,Tp=function(){function t(e,n){sd(this,t),this.WORKER_DATA_URL=null,this.WORKER_FETCHING_SCRIPT=!1,this.WORKER_FETCHING_CALLBACKS=[],this._url=e,this._enableInlineWorker=n}return ld(t,[{key:"clearWorkerDataURL",value:function(){this.WORKER_DATA_URL=null}},{key:"initWorkerScript",value:function(e,t){if(this._enableInlineWorker&&!this.WORKER_DATA_URL){this.WORKER_FETCHING_CALLBACKS.push({successCB:e});var n=this;if(!this.WORKER_FETCHING_SCRIPT){var r=new XMLHttpRequest,a=this._url;r.open("GET",a,!0),r.withCredentials=!1,r.onload=function(){n.WORKER_FETCHING_SCRIPT=!1;var e=void 0;window.URL=window.URL||window.webkitURL;try{e=new Blob([r.responseText],{type:"application/javascript"})}catch(n){var t=new BlobBuilder;t.append(r.responseText),e=t.getBlob()}n.WORKER_DATA_URL=URL.createObjectURL(e);var a=n.WORKER_FETCHING_CALLBACKS.concat();n.WORKER_FETCHING_CALLBACKS=[];for(var i=0;i<a.length;++i)a[i].successCB&&a[i].successCB()},this.WORKER_FETCHING_SCRIPT=!0,r.send()}var i={};return i.cancel=function(){var t=-1;return!!n.WORKER_FETCHING_CALLBACKS.some(function(n,r){return n.successCB==e&&(t=r,!0)})&&(n.WORKER_FETCHING_CALLBACKS.splice(t,1),!0)},i}return e&&e(),null}},{key:"createWorker",value:function(){var e=void 0;return e=this._enableInlineWorker?new Worker(this.WORKER_DATA_URL):new Worker(this._url),e.doOperation=e.postMessage,e}},{key:"createWorkerWithIntercept",value:function(){function t(e){if(!r)return null;for(var t=0;t<r.length;++t)if(r[t].arg===e){var n=r[t].callback;return r.splice(t,1),0===r.length&&(r=null),n}return null}var n=this.createWorker();n.checkEvent=function(t){return!(!t.data||!t.data.assetRequest)&&(e.assets&&e.assets.push(t.data.assetRequest),!0)};var r=[];return n.addEventListenerWithIntercept=function(e){var t=function(t){n.checkEvent(t)||e(t)};return r||(r=[]),r.push({arg:e,callback:t}),n.addEventListener("message",t,!1),t},n.removeEventListenerWithIntercept=function(e){var r=t(e);r&&n.removeEventListener("message",r,!1)},n.clearAllEventListenerWithIntercept=function(){if(r)for(var e=r.concat(),t=0;t<e.length;++t)n.removeEventListenerWithIntercept(e[t].arg)},n}}]),t}();fc.webWorkerClass=Tp;var Ap=function(e){return"\n    #if defined(USE_"+(e+="_map").toUpperCase()+")\n        uniform sampler2D "+e+";\n        uniform mat3 "+e+"_texMatrix;\n        uniform bool "+e+"_invert;\n    #endif\n    "},Ep=function(e){return"\n    #if defined(USE_"+(e+="_map").toUpperCase()+")\n        uniform sampler2D "+e+";\n        uniform mat3 "+e+"_texMatrix;\n        uniform vec2 "+e+"_bumpScale;\n        uniform int "+e+"_bumpmapType;\n    #endif\n    "},Rp=function(e,t){var n=e,r=e+"_map",a="_"+n,i="";switch(t={f:"float",c:"vec3",v2:"vec2",v3:"vec3",v4:"vec4"}[t]||t){case"float":i="x";break;case"vec2":i="xy";break;case"vec3":i="xyz";break;case"vec4":i="xyzw";break;default:throw new Error("Unexpected swizzle type: "+t)}return"\n    "+t+" "+a+" = "+n+";\n    #if defined(USE_"+r.toUpperCase()+")\n    {\n        "+a+" = texture2D("+r+", ("+r+"_texMatrix * vec3(uv, 1.0)).xy)."+i+";\n        if ("+r+"_invert) {\n            "+a+" = "+t+"(1.0) - "+a+";\n        }\n    }\n    #endif\n    "},Lp=function(e,n){t.ShaderChunk["prism_uniforms_"+e]=Ap(e),t.ShaderChunk["prism_sample_"+e]=Rp(e,n)},Pp=function(e){for(var t in e)Lp(t,e[t].type)},Ip="varying vec3 vViewPosition;\nvarying vec3 vNormal;\nvarying vec2 vUv;\nvarying vec3 vTangent;\nvarying vec3 vBitangent;\n#if defined(PRISMWOOD)\nvarying vec3 vUvw;\n#endif\n#if defined(PRISMWOOD) && defined(PRISMWOODBUMP)\nvarying vec3 vtNormal;\nvarying mat3 vNormalMatrix;\n#endif\nvoid computeTangents(vec3 normal, out vec3 u, out vec3 v) {\n    float scale = normal.z < 0.0 ? -1.0 : 1.0;\n    vec3 temp = scale * normal;\n    float e = temp.z;\n    float h = 1.0/(1.0 + e);\n    float hvx = h * temp.y;\n    float hvxy = hvx * -temp.x;\n    u = vec3(e + hvx * temp.y, hvxy, -temp.x);\n    v = vec3(hvxy, e + h * temp.x * temp.x, -temp.y);\n    u *= scale;\n    v *= scale;\n}\nvoid main() {\n    vUv = uv;\n    vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);\n    gl_Position = projectionMatrix * mvPosition;\n    vViewPosition = -mvPosition.xyz;\n    vNormal = normalize(normalMatrix * normal);\n    vec3 Tu, Tv;\n    computeTangents(vNormal, Tu, Tv);\n    vTangent = Tu;\n    vBitangent = Tv;\n#if defined(PRISMWOOD)\n    vUvw = position;\n#endif\n#if defined(PRISMWOOD) && defined(PRISMWOODBUMP)\n    vtNormal = normalize(normal);\n    vNormalMatrix = normalMatrix;\n#endif\n}\n",Cp=null,Dp=function(){return Cp||(Cp={uniforms:{opaque_albedo:{type:"c",value:new t.Color(.963976,.963976,.954687)},opaque_f0:{type:"f",value:.0529},opaque_luminance_modifier:{type:"c",value:new t.Color},opaque_luminance:{type:"f",value:0}},vertexShader:Ip,fragmentShader:"varying vec3 vViewPosition;\nvarying vec3 vNormal;\nvarying vec2 vUv;\nvarying vec3 vTangent;\nvarying vec3 vBitangent;\nuniform vec3 surface_albedo;\nuniform float surface_roughness;\nuniform float surface_anisotropy;\nuniform float surface_rotation;\nuniform vec3 opaque_albedo;\nuniform float opaque_f0;\nuniform float opaque_luminance;\nuniform vec3 opaque_luminance_modifier;\nuniform float uEnvExp;\n#include <prism_uniforms_surface_albedo>\n#include <prism_uniforms_surface_roughness>\n#include <prism_uniforms_surface_cutout>\n#include <prism_uniforms_surface_anisotropy>\n#include <prism_uniforms_surface_rotation>\n#include <prism_uniforms_surface_normal>\n#include <prism_uniforms_opaque_albedo>\n#include <prism_uniforms_opaque_f0>\n#include <prism_uniforms_opaque_luminance>\n#include <prism_uniforms_opaque_luminance_modifier>\n#include <common>\n#include <bsdfs>\n#include <lights_pars>\n#include <envmap_pars_fragment>\n#include <prism_common>\n#include <prism_math>\n#include <prism_env_opaque>\n#include <prism_brdf_opaque>\n#if (NUM_DIR_LIGHTS > 0) || (NUM_POINT_LIGHTS > 0) || (NUM_SPOT_LIGHTS > 0)\nvec3 getDiscreteLightRadiance(\n    GeometricContext geometry,\n    float NdotV, vec3 Tu, vec3 Tv,\n    vec3 surfaceAlbedo,\n    float surfaceRoughness,\n    float surfaceAnisotropy,\n    float surfaceRotation,\n    float opaqueF0,\n    vec3 opaqueAlbedo\n) {\n    vec3 N = geometry.normal;\n    vec3 V = geometry.viewDir;\n    IncidentLight directLight;\n    vec3 accumLight = vec3(0.0);\n#define ACCUM_LIGHT { vec3 L = directLight.direction; float NdotL = max(EPSILON, dot(N, L)); vec3 H = normalize(L + V); float NdotH = dot(N, H); float VdotH = dot(V, H); float Hu = dot(H, Tu); float Hv = dot(H, Tv); vec3 Hlocal = vec3(Hu, Hv, NdotH); accumLight += directLight.color * PrismOpaqueBRDF(Hlocal, NdotL, NdotH, NdotV, VdotH, surfaceAlbedo, surfaceRoughness, surfaceAnisotropy, surfaceRotation, opaqueF0, opaqueAlbedo ); }\n#if NUM_DIR_LIGHTS > 0\n    for (int i = 0; i < NUM_DIR_LIGHTS; i++) {\n        DirectionalLight directionalLight = directionalLights[i];\n        getDirectionalDirectLightIrradiance(directionalLight, geometry, directLight);\n        ACCUM_LIGHT\n    }\n#endif\n#if NUM_POINT_LIGHTS > 0\n    for (int i = 0; i < NUM_POINT_LIGHTS; i++) {\n        PointLight pointLight = pointLights[i];\n        getPointDirectLightIrradiance(pointLight, geometry, directLight);\n        ACCUM_LIGHT\n    }\n#endif\n#if NUM_SPOT_LIGHTS > 0\n    for (int i = 0; i < NUM_SPOT_LIGHTS; i++) {\n        SpotLight spotLight = spotLights[i];\n        getSpotDirectLightIrradiance(spotLight, geometry, directLight);\n        ACCUM_LIGHT\n    }\n#endif\n    return accumLight;\n}\n#endif\nvoid main() {\n    vec3 N;\n    vec3 V;\n    vec3 Tu;\n    vec3 Tv;\n    getGeoContext(\n        vViewPosition, vNormal, vUv,\n        vTangent, vBitangent,\n        N, V, Tu, Tv\n    );\n    float NdotV = clamp(dot(N, V), EPSILON, 1.0);\n    float surface_cutout = 1.0;\n    #include <prism_sample_surface_cutout>\n    if (_surface_cutout < 0.01) discard;\n    #include <prism_sample_surface_albedo>\n    #include <prism_sample_surface_roughness>\n    #include <prism_sample_surface_anisotropy>\n    #include <prism_sample_surface_rotation>\n    #include <prism_sample_opaque_albedo>\n    #include <prism_sample_opaque_f0>\n    #include <prism_sample_opaque_luminance_modifier>\n    #include <prism_sample_opaque_luminance>\n    vec3 outRadiance = vec3(0.0);\n#if (NUM_DIR_LIGHTS > 0) || (NUM_POINT_LIGHTS > 0) || (NUM_SPOT_LIGHTS > 0)\n    GeometricContext geometry;\n    geometry.position = -vViewPosition;\n    geometry.normal = N;\n    geometry.viewDir = V;\n    outRadiance += getDiscreteLightRadiance(\n        geometry,\n        NdotV, Tu, Tv,\n        _surface_albedo,\n        _surface_roughness,\n        _surface_anisotropy,\n        _surface_rotation,\n        _opaque_f0,\n        _opaque_albedo\n    );\n#endif\n#if defined(USE_ENVMAP)\n    outRadiance += PrismOpaqueIBL(\n        N, V, NdotV, Tu, Tv,\n        _surface_albedo,\n        _surface_roughness,\n        _surface_anisotropy,\n        _surface_rotation,\n        _opaque_f0,\n        _opaque_albedo,\n        _opaque_luminance,\n        _opaque_luminance_modifier\n    );\n#endif\n    outRadiance *= uEnvExp;\n    outRadiance = toneMapping(outRadiance);\n    gl_FragColor = LinearToGamma(vec4(outRadiance, 1.0), float(GAMMA_FACTOR));\n}\n"},Pp(Cp.uniforms),Cp)},Np=null,Op=null,Up=null,Fp=null,Vp=null,Bp=function(){var e=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],n=new Uint8Array(e),r=new t.DataTexture(n,256,1,t.LuminanceFormat,t.UnsignedByteType,t.UVMapping,t.RepeatWrapping,t.RepeatWrapping,t.NearestFilter,t.NearestFilter,0);r.generateMipmaps=!1,r.flipY=!1,r.needsUpdate=!0;var a=[225,39,122,231,29,173,15,159,75,88,233,19,179,79,72,94,54,73,151,161,171,113,221,144,127,83,168,19,88,122,62,225,109,128,246,247,172,101,61,139,211,168,64,210,224,82,87,97,119,250,201,44,242,239,154,99,126,13,44,70,246,170,100,52,135,28,187,22,207,119,199,1,235,187,55,131,190,124,222,249,236,53,225,231,71,30,173,185,153,47,79,133,225,10,140,62,17,99,100,29,137,95,142,244,76,5,83,124,38,216,253,195,44,210,148,185,188,39,78,195,132,30,60,73,92,223,133,80,230,56,118,207,79,15,251,211,111,21,79,23,240,146,150,207,3,61,103,27,148,6,31,127,235,58,173,244,116,81,34,120,192,213,188,226,97,23,16,161,106,80,242,148,35,37,91,117,51,216,97,193,126,222,39,38,133,217,215,23,237,57,205,42,222,165,126,133,33,8,227,154,27,18,56,11,192,120,80,92,236,38,210,207,128,31,135,39,123,5,49,127,107,200,34,14,153,239,134,19,248,162,58,201,159,198,243,158,72,5,138,184,222,200,34,141,233,40,195,238,191,122,171,32,66,254,229,197],i=new Uint8Array(a),o=new t.DataTexture(i,256,1,t.LuminanceFormat,t.UnsignedByteType,t.UVMapping,t.RepeatWrapping,t.RepeatWrapping,t.NearestFilter,t.NearestFilter,0);o.generateMipmaps=!1,o.flipY=!1,o.needsUpdate=!0;var s=function(t){return e[t%256]},l=new Array(262144),u=void 0,f=void 0,d=void 0,c=void 0,p=void 0,h=void 0,m=void 0,_=void 0,v=void 0;for(u=0;u<256;++u)for(f=0;f<256;++f)c=s(d=s(f)+u),p=s(d+1),m=s(h=s(f+1)+u),_=s(h+1),l[v=4*(256*u+f)]=c,l[v+1]=p,l[v+2]=m,l[v+3]=_;var g=new Uint8Array(l),y=new t.DataTexture(g,256,256,t.RGBAFormat,t.UnsignedByteType,t.UVMapping,t.RepeatWrapping,t.RepeatWrapping,t.NearestFilter,t.NearestFilter,0);y.generateMipmaps=!1,y.flipY=!1,y.needsUpdate=!0;var x=[1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1,1,1,0,0,-1,1,-1,1,0,0,-1,-1],b=new Array(1024);for(f=0;f<256;++f){var w=e[f]%16;b[4*f]=127*x[3*w]+128,b[4*f+1]=127*x[3*w+1]+128,b[4*f+2]=127*x[3*w+2]+128,b[4*f+3]=0}var M=new Uint8Array(b),S=new t.DataTexture(M,256,1,t.RGBAFormat,t.UnsignedByteType,t.UVMapping,t.RepeatWrapping,t.RepeatWrapping,t.NearestFilter,t.NearestFilter,0);return S.generateMipmaps=!1,S.flipY=!1,S.needsUpdate=!0,{permutationTex:r,gradientTex:o,perm2DTex:y,permGradTex:S}};t.ShaderChunk.normal_map=Gs,t.ShaderChunk.prism_common="#include <normal_map>\nfloat sqr(float x) {\n    return x * x;\n}\nvoid getGeoContext(\n    vec3 viewPosition,\n    vec3 normal,\n    vec2 uv,\n    vec3 tangent,\n    vec3 bitangent,\n    out vec3 N,\n    out vec3 V,\n    out vec3 Tu,\n    out vec3 Tv\n) {\n    N = normalize(normal);\n    V = normalize(viewPosition);\n    Tu = normalize(tangent);\n    Tv = normalize(bitangent);\n#if defined(USE_MAP)\n    vec3 q0 = dFdx(-viewPosition);\n    vec3 q1 = dFdy(-viewPosition);\n    vec2 st0 = dFdx(uv);\n    vec2 st1 = dFdy(uv);\n    Tu = normalize(q0 * st1.t - q1 * st0.t);\n    Tv = normalize(-q0 * st1.s + q1 * st0.s);\n#endif\n#if defined(USE_SURFACE_NORMAL_MAP)\n    if (surface_normal_map_bumpmapType == 0) {\n        heightMapTransform(surface_normal_map, uv, surface_normal_map_texMatrix, surface_normal_map_bumpScale, Tu, Tv, N);\n    } else {\n        normalMapTransform(surface_normal_map, uv, surface_normal_map_texMatrix, surface_normal_map_bumpScale, Tu, Tv, N);\n    }\n#endif\n}",t.ShaderChunk.prism_math="\nvec2 RoughnessToAlpha(float roughness, float anisotropy) {\n    vec2 alpha = roughness * vec2(1.0, 1.0 - anisotropy);\n    alpha = alpha * alpha;\n    alpha = clamp(alpha, 0.001, 1.0);\n    return alpha;\n}\nvec3 FresnelSchlick(vec3 f0, float cosAngle) {\n    float x = 1.0 - cosAngle;\n    float x2 = x * x;\n    float x5 = x * x2 * x2;\n    return f0 + (1.0 - f0) * x5;\n}\nvec3 FresnelRough(vec3 f0, float cosAngle, float alpha) {\n    float x = 1.0 - cosAngle;\n    float x2 = x * x;\n    float x5 = x * x2 * x2;\n    vec3 maxReflectance = mix(vec3(1.0), f0, vec3(min(0.7, alpha)) / 0.7);\n    return f0 + (maxReflectance - f0) * x5;\n}\nfloat IORToReflectance(float ior) {\n    return sqr((1.0 - ior) / (1.0 + ior));\n}\n",t.ShaderChunk.prism_env="#if defined(USE_ENVMAP)\nfloat alphaToPhong(float alpha) {\n    return max(0.0, 2.56/alpha - 7.0);\n}\nfloat phongToReflMipIndex(float exponent) {\n    const float EXP_COUNT = 10.0;\n    const float LOG_MIN = 0.0;\n    const float LOG_MAX = 9.0;\n    const float NUM_MIPS = 6.0;\n    float targetLog = log2(exponent);\n    float deltaLog = clamp(targetLog - LOG_MIN, 0.0, LOG_MAX - LOG_MIN);\n    float level = clamp((1.0-(deltaLog + 0.5) / EXP_COUNT), 0.0, 1.0) * NUM_MIPS;\n    return level;\n}\nvec3 decodeRGBM(in vec4 vRGBM) {\n    vec3 ret = vRGBM.rgb * (vRGBM.a * 16.0);\n    ret *= ret / uEnvExp;\n    return ret;\n}\nvec3 sampleReflection(vec3 n, vec3 v, float a) {\n    float mipLevel = phongToReflMipIndex(alphaToPhong(a));\n    v = reflect(-v, n);\n    v = inverseTransformDirection(v, viewMatrix);\n#ifdef GL_EXT_shader_texture_lod\n    return decodeRGBM(textureCubeLodEXT(envMap, v, mipLevel));\n#else\n    return decodeRGBM(textureCube(envMap, v, mipLevel));\n#endif\n}\nuniform samplerCube irrMap;\nvec3 sampleIrradiance(vec3 v) {\n    v = inverseTransformDirection(v, viewMatrix);\n    return decodeRGBM(textureCube(irrMap, v));\n}\n#endif\n",t.ShaderChunk.prism_env_opaque="#include <prism_env>\n#if defined(USE_ENVMAP)\nvec3 PrismOpaqueIBL(\n    vec3 N, vec3 V, float NdotV, vec3 Tu, vec3 Tv,\n    vec3 surfaceAlbedo,\n    float surfaceRoughness,\n    float surfaceAnisotropy,\n    float surfaceRotation,\n    float opaqueF0,\n    vec3 opaqueAlbedo,\n    float opaqueLuminance,\n    vec3 opaqueLuminanceModifier\n) {\n    float alpha = RoughnessToAlpha(surfaceRoughness, 0.0).x;\n    vec3 F = FresnelRough(vec3(opaqueF0), NdotV, alpha);\n    vec3 envSpecular = sampleReflection(N, V, alpha);\n    vec3 specular = F * surfaceAlbedo * envSpecular;\n    vec3 envIrradiance = sampleIrradiance(N);\n    vec3 diffuse = (1.0 - F) * opaqueAlbedo * envIrradiance;\n    vec3 emission = opaqueLuminanceModifier * opaqueLuminance;\n    return diffuse + specular + emission;\n}\n#endif\n",t.ShaderChunk.prism_env_metal="#include <prism_env>\n#if defined(USE_ENVMAP)\nvec3 PrismMetalIBL(\n    vec3 N, vec3 V, float NdotV, vec3 Tu, vec3 Tv,\n    vec3 surfaceAlbedo,\n    float surfaceRoughness,\n    float surfaceAnisotropy,\n    float surfaceRotation,\n    vec3 metalF0\n) {\n    float alpha = RoughnessToAlpha(surfaceRoughness, 0.0).x;\n    vec3 F = FresnelRough(metalF0, NdotV, alpha);\n    vec3 envSpecular = sampleReflection(N, V, alpha);\n    vec3 specular = F * surfaceAlbedo * envSpecular;\n    return specular;\n}\n#endif\n",t.ShaderChunk.prism_env_layered="#include <prism_env>\n#if defined(USE_ENVMAP)\nvec3 PrismLayeredIBL(\n    vec3 N, vec3 V, float NdotV, vec3 Tu, vec3 Tv,\n    vec3 N2, float N2dotV,\n    vec3 surfaceAlbedo,\n    float surfaceRoughness,\n    float surfaceAnisotropy,\n    float surfaceRotation,\n    float layeredF0,\n    vec3 layeredDiffuse,\n    float layeredRoughness,\n    float layeredAnisotropy,\n    float layeredRotation,\n    vec3 bottomF0,\n    float layeredFraction\n) {\n    vec3 F = FresnelSchlick(vec3(layeredF0), NdotV);\n    float alpha = RoughnessToAlpha(surfaceRoughness, 0.0).x;\n    vec3 envSpecular = sampleReflection(N, V, alpha);\n    vec3 topSpecular = F * surfaceAlbedo * envSpecular;\n    vec3 amount = (1.0 - F);\n    vec3 envIrradiance = sampleIrradiance(N);\n    vec3 topDiffuse = layeredDiffuse * envIrradiance;\n    alpha = RoughnessToAlpha(layeredRoughness, 0.0).x;\n    envSpecular = sampleReflection(N2, V, alpha);\n    F = FresnelRough(bottomF0, N2dotV, alpha);\n    vec3 botSpecular = F * envSpecular;\n    return topSpecular + amount * mix(topDiffuse, botSpecular, layeredFraction);\n}\n#endif",t.ShaderChunk.prism_env_transparent="#include <prism_env>\n#if defined(USE_ENVMAP)\nvec3 PrismTransparentIBL(\n    vec3 N, vec3 V, float NdotV, vec3 Tu, vec3 Tv,\n    vec3 surfaceAlbedo,\n    float surfaceRoughness,\n    float surfaceAnisotropy,\n    float surfaceRotation,\n    vec3 transparentColor,\n    float transparentIor\n) {\n    vec3 reflectance = vec3(IORToReflectance(transparentIor));\n    float alpha = RoughnessToAlpha(surfaceRoughness, 0.0).x;\n    vec3 F = FresnelRough(reflectance, NdotV, alpha);\n    vec3 envSpecular = sampleReflection(N, V, alpha);\n    vec3 specular = F * surfaceAlbedo * envSpecular;\n    vec3 envIrradiance = sampleIrradiance(N);\n    vec3 color = F * surfaceRoughness * transparentColor * envIrradiance;\n    return specular + color;\n}\n#endif",t.ShaderChunk.prism_brdf="float aSqrd(float maxAlphaSqr, float cosTheta) {\n    if (abs(cosTheta) < 1e-10) {\n        return 1e10;\n    }\n    float tan2 = 1.0/sqr(cosTheta) - 1.0;\n    return maxAlphaSqr * tan2;\n}\nvec3 Rotate(vec3 vec, float angle) {\n    float s = sin(angle);\n    float c = cos(angle);\n    return vec3(vec.x * c - vec.y * s, vec.x * s + vec.y * c, vec.z);\n}\nfloat NDF_GGX(float alphaU, float alphaV, vec3 normal) {\n    float nx2 = sqr(normal.x);\n    float ny2 = sqr(normal.y);\n    float nz2 = sqr(normal.z);\n    float scale = 1.0/(alphaU * alphaV * PI);\n    return scale/sqr(nx2/sqr(alphaU) + ny2/sqr(alphaV) + nz2);\n}\nfloat G1_GGX(float aSqrd) {\n    return 2.0 / (1.0 + sqrt(1.0 + aSqrd));\n}\nvec3 MicrofacetLobe(\n    vec3 Hlocal,\n    float NdotL,\n    float NdotH,\n    float NdotV,\n    float VdotH,\n    float roughness,\n    float anisotropy,\n    float rotation,\n    vec3 reflectance\n) {\n    vec2 alpha = RoughnessToAlpha(roughness, anisotropy);\n    Hlocal = Rotate(Hlocal, rotation);\n    vec3 F = FresnelSchlick(reflectance, VdotH);\n    float D = NDF_GGX(alpha.x, alpha.y, Hlocal);\n    float alpha2 = max(sqr(alpha.x), sqr(alpha.y));\n    float alpha2NL = aSqrd(alpha2, NdotL);\n    float alpha2NV = aSqrd(alpha2, NdotV);\n    float G = G1_GGX(alpha2NL) * G1_GGX(alpha2NV);\n    return max(F * D * G / (4.0 * NdotL * NdotV), vec3(0.0));\n}\nvec3 DiffuseLobe(vec3 diffuseColor) {\n    return diffuseColor * RECIPROCAL_PI;\n}\n",t.ShaderChunk.prism_brdf_opaque="#include <prism_brdf>\nvec3 PrismOpaqueBRDF(\n    vec3 Hlocal,\n    float NdotL,\n    float NdotH,\n    float NdotV,\n    float VdotH,\n    vec3 surfaceAlbedo,\n    float surfaceRoughness,\n    float surfaceAnisotropy,\n    float surfaceRotation,\n    float opaqueF0,\n    vec3 opaqueAlbedo\n) {\n    vec3 diffuse = DiffuseLobe(opaqueAlbedo);\n    vec3 specular = surfaceAlbedo * MicrofacetLobe(\n        Hlocal,\n        NdotL,\n        NdotH,\n        NdotV,\n        VdotH,\n        surfaceRoughness,\n        surfaceAnisotropy,\n        surfaceRotation,\n        vec3(opaqueF0)\n    );\n    return (specular + diffuse) * NdotL;\n}\n",t.ShaderChunk.prism_brdf_metal="#include <prism_brdf>\nvec3 PrismMetalBRDF(\n    vec3 Hlocal,\n    float NdotL,\n    float NdotH,\n    float NdotV,\n    float VdotH,\n    vec3 surfaceAlbedo,\n    float surfaceRoughness,\n    float surfaceAnisotropy,\n    float surfaceRotation,\n    vec3 metalF0\n) {\n    vec3 specular = surfaceAlbedo * MicrofacetLobe(\n        Hlocal,\n        NdotL,\n        NdotH,\n        NdotV,\n        VdotH,\n        surfaceRoughness,\n        surfaceAnisotropy,\n        surfaceRotation,\n        metalF0\n    );\n    return specular * NdotL;\n}\n",t.ShaderChunk.prism_brdf_layered="#include <prism_brdf>\nvec3 PrismLayeredBRDF(\n    vec3 Hlocal,\n    float NdotL,\n    float NdotH,\n    float NdotV,\n    float VdotH,\n    vec3 Hlocal2,\n    float N2dotL,\n    float N2dotH,\n    float N2dotV,\n    vec3 surfaceAlbedo,\n    float surfaceRoughness,\n    float surfaceAnisotropy,\n    float surfaceRotation,\n    float layeredF0,\n    vec3 layeredDiffuse,\n    float layeredRoughness,\n    float layeredAnisotropy,\n    float layeredRotation,\n    vec3 layeredBottomF0,\n    float layeredFraction\n) {\n    vec3 Fl = FresnelSchlick(vec3(layeredF0), NdotL);\n    vec3 Fv = FresnelSchlick(vec3(layeredF0), NdotV);\n    vec3 amount = (1.0 - Fl) * (1.0 - Fv);\n    vec3 topSpecular = surfaceAlbedo * MicrofacetLobe(\n        Hlocal,\n        NdotL,\n        NdotH,\n        NdotV,\n        VdotH,\n        surfaceRoughness,\n        surfaceAnisotropy,\n        surfaceRotation,\n        vec3(layeredF0)\n    );\n    vec3 topDiffuse = DiffuseLobe(layeredDiffuse);\n    vec3 botSpecular = MicrofacetLobe(\n        Hlocal2,\n        N2dotL,\n        N2dotH,\n        N2dotV,\n        VdotH,\n        layeredRoughness,\n        layeredAnisotropy,\n        layeredRotation,\n        layeredBottomF0\n    );\n    return topSpecular * NdotL + amount * mix(\n        topDiffuse * NdotL,\n        botSpecular * N2dotL,\n        layeredFraction\n    );\n}\n",t.ShaderChunk.prism_brdf_transparent="#include <prism_brdf>\nvec3 PrismTransparentBRDF(\n    vec3 Hlocal,\n    float NdotL,\n    float NdotH,\n    float NdotV,\n    float VdotH,\n    vec3 surfaceAlbedo,\n    float surfaceRoughness,\n    float surfaceAnisotropy,\n    float surfaceRotation,\n    float transparentIor\n) {\n    vec3 reflectance = vec3(IORToReflectance(transparentIor));\n    vec3 specular = surfaceAlbedo * MicrofacetLobe(\n        Hlocal,\n        NdotL,\n        NdotH,\n        NdotV,\n        VdotH,\n        surfaceRoughness,\n        surfaceAnisotropy,\n        surfaceRotation,\n        reflectance\n    );\n    return specular * NdotL;\n}\n",t.ShaderChunk.prism_wood=Bs,t.ShaderChunk.prism_transparency=zs,t.ShaderChunk.prism_uniforms_surface_normal=Ep("surface_normal"),Lp("surface_albedo","vec3"),Lp("surface_roughness","float"),Lp("surface_anisotropy","float"),Lp("surface_rotation","float"),Lp("surface_cutout","float");var zp={uniforms:{surface_albedo:{type:"c",value:new t.Color},surface_roughness:{type:"f",value:.1},surface_anisotropy:{type:"f",value:0},surface_rotation:{type:"f",value:0},uEnvExp:{type:"f",value:1}},extensions:{derivatives:!0,shaderTextureLOD:!0}},Gp={},kp=function(e){return(Gp[e]||Dp)()},Hp=function(e){function n(e){sd(this,n);var r=kp(e),a=Object.assign({},zp,r);a.uniforms=t.UniformsUtils.merge([zp.uniforms,r.uniforms]);var i=dd(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,a));for(var o in r.uniforms){var s=r.uniforms[o];"t"===s.type&&s.value&&(i.uniforms[o].value=s.value)}return i._lights=!1,i}return fd(n,e),ld(n,[{key:"lights",get:function(){return this._lights},set:function(e){if(e&&this.uniforms){var n=t.UniformsLib.lights;for(var r in n)this.uniforms[r]=t.UniformsUtils.clone(n[r])}this._lights=e}}]),n}(t.ShaderMaterial);Hp.OPAQUE=Symbol("Opaque"),Hp.METAL=Symbol("Metal"),Hp.LAYERED=Symbol("Layered"),Hp.TRANSPARENT=Symbol("Transparent"),Hp.WOOD=Symbol("Wood"),Gp[Hp.OPAQUE]=Dp,Gp[Hp.METAL]=function(){return Np||(Np={uniforms:{metal_f0:{type:"c",value:new t.Color(.963976,.963976,.954687)}},vertexShader:Ip,fragmentShader:"varying vec3 vViewPosition;\nvarying vec3 vNormal;\nvarying vec2 vUv;\nvarying vec3 vTangent;\nvarying vec3 vBitangent;\nuniform vec3 surface_albedo;\nuniform float surface_roughness;\nuniform float surface_anisotropy;\nuniform float surface_rotation;\nuniform vec3 metal_f0;\nuniform float uEnvExp;\n#include <prism_uniforms_surface_albedo>\n#include <prism_uniforms_surface_roughness>\n#include <prism_uniforms_surface_cutout>\n#include <prism_uniforms_surface_anisotropy>\n#include <prism_uniforms_surface_rotation>\n#include <prism_uniforms_surface_normal>\n#include <prism_uniforms_metal_f0>\n#include <common>\n#include <bsdfs>\n#include <lights_pars>\n#include <envmap_pars_fragment>\n#include <prism_common>\n#include <prism_math>\n#include <prism_env_metal>\n#include <prism_brdf_metal>\n#if (NUM_DIR_LIGHTS > 0) || (NUM_POINT_LIGHTS > 0) || (NUM_SPOT_LIGHTS > 0)\nvec3 getDiscreteLightRadiance(\n    GeometricContext geometry,\n    float NdotV, vec3 Tu, vec3 Tv,\n    vec3 surfaceAlbedo,\n    float surfaceRoughness,\n    float surfaceAnisotropy,\n    float surfaceRotation,\n    vec3 metalF0\n) {\n    vec3 N = geometry.normal;\n    vec3 V = geometry.viewDir;\n    IncidentLight directLight;\n    vec3 accumLight = vec3(0.0);\n#define ACCUM_LIGHT { vec3 L = directLight.direction; float NdotL = max(EPSILON, dot(N, L)); vec3 H = normalize(L + V); float NdotH = dot(N, H); float VdotH = dot(V, H); float Hu = dot(H, Tu); float Hv = dot(H, Tv); vec3 Hlocal = vec3(Hu, Hv, NdotH); accumLight += directLight.color * PrismMetalBRDF(Hlocal, NdotL, NdotH, NdotV, VdotH, surfaceAlbedo, surfaceRoughness, surfaceAnisotropy, surfaceRotation, metalF0); }\n#if NUM_DIR_LIGHTS > 0\n    for (int i = 0; i < NUM_DIR_LIGHTS; i++) {\n        DirectionalLight directionalLight = directionalLights[i];\n        getDirectionalDirectLightIrradiance(directionalLight, geometry, directLight);\n        ACCUM_LIGHT\n    }\n#endif\n#if NUM_POINT_LIGHTS > 0\n    for (int i = 0; i < NUM_POINT_LIGHTS; i++) {\n        PointLight pointLight = pointLights[i];\n        getPointDirectLightIrradiance(pointLight, geometry, directLight);\n        ACCUM_LIGHT\n    }\n#endif\n#if (NUM_SPOT_LIGHTS > 0)\n    for (int i = 0; i < NUM_SPOT_LIGHTS; i++) {\n        SpotLight spotLight = spotLights[i];\n        getSpotDirectLightIrradiance(spotLight, geometry, directLight);\n        ACCUM_LIGHT\n    }\n#endif\n    return accumLight;\n}\n#endif\nvoid main() {\n    vec3 N;\n    vec3 V;\n    vec3 Tu;\n    vec3 Tv;\n    getGeoContext(\n        vViewPosition, vNormal, vUv,\n        vTangent, vBitangent,\n        N, V, Tu, Tv\n    );\n    float NdotV = clamp(dot(N, V), EPSILON, 1.0);\n    float surface_cutout = 1.0;\n    #include <prism_sample_surface_cutout>\n    if (_surface_cutout < 0.01) discard;\n    #include <prism_sample_surface_albedo>\n    #include <prism_sample_surface_roughness>\n    #include <prism_sample_surface_anisotropy>\n    #include <prism_sample_surface_rotation>\n    #include <prism_sample_metal_f0>\n    vec3 outRadiance = vec3(0.0);\n#if (NUM_DIR_LIGHTS > 0) || (NUM_POINT_LIGHTS > 0) || (NUM_SPOT_LIGHTS > 0)\n    GeometricContext geometry;\n    geometry.position = -vViewPosition;\n    geometry.normal = N;\n    geometry.viewDir = V;\n    outRadiance += getDiscreteLightRadiance(\n        geometry,\n        NdotV, Tu, Tv,\n        _surface_albedo,\n        _surface_roughness,\n        _surface_anisotropy,\n        _surface_rotation,\n        _metal_f0\n    );\n#endif\n#if defined(USE_ENVMAP)\n    outRadiance += PrismMetalIBL(\n        N, V, NdotV, Tu, Tv,\n        _surface_albedo,\n        _surface_roughness,\n        _surface_anisotropy,\n        _surface_rotation,\n        _metal_f0\n    );\n#endif\n    outRadiance *= uEnvExp;\n    outRadiance = toneMapping(outRadiance);\n    gl_FragColor = LinearToGamma(vec4(outRadiance, 1.0), float(GAMMA_FACTOR));\n}\n"},Pp(Np.uniforms),Np)},Gp[Hp.LAYERED]=function(){return Op||(Op={uniforms:{layered_f0:{type:"f",value:.0603},layered_diffuse:{type:"c",value:new t.Color(.9673,.9556,.9137)},layered_fraction:{type:"f",value:.25},layered_bottom_f0:{type:"c",value:new t.Color(.9673,.9556,.9137)},layered_roughness:{type:"f",value:0},layered_anisotropy:{type:"f",value:0},layered_rotation:{type:"f",value:0}},vertexShader:Ip,fragmentShader:"varying vec3 vViewPosition;\nvarying vec3 vNormal;\nvarying vec2 vUv;\nvarying vec3 vTangent;\nvarying vec3 vBitangent;\nuniform vec3 surface_albedo;\nuniform float surface_roughness;\nuniform float surface_anisotropy;\nuniform float surface_rotation;\nuniform float layered_f0;\nuniform vec3 layered_diffuse;\nuniform float layered_fraction;\nuniform vec3 layered_bottom_f0;\nuniform float layered_roughness;\nuniform float layered_anisotropy;\nuniform float layered_rotation;\nuniform float uEnvExp;\n#include <prism_uniforms_surface_albedo>\n#include <prism_uniforms_surface_roughness>\n#include <prism_uniforms_surface_cutout>\n#include <prism_uniforms_surface_anisotropy>\n#include <prism_uniforms_surface_rotation>\n#include <prism_uniforms_surface_normal>\n#include <prism_uniforms_layered_f0>\n#include <prism_uniforms_layered_diffuse>\n#include <prism_uniforms_layered_fraction>\n#include <prism_uniforms_layered_bottom_f0>\n#include <prism_uniforms_layered_roughness>\n#include <prism_uniforms_layered_anisotropy>\n#include <prism_uniforms_layered_rotation>\n#include <common>\n#include <bsdfs>\n#include <lights_pars>\n#include <envmap_pars_fragment>\n#include <prism_common>\n#include <prism_math>\n#include <prism_env_layered>\n#include <prism_brdf_layered>\n#if (NUM_DIR_LIGHTS > 0) || (NUM_POINT_LIGHTS > 0) || (NUM_SPOT_LIGHTS > 0)\nvec3 getDiscreteLightRadiance(\n    GeometricContext geometry,\n    float NdotV, vec3 Tu, vec3 Tv,\n    vec3 surfaceAlbedo,\n    float surfaceRoughness,\n    float surfaceAnisotropy,\n    float surfaceRotation,\n    float layeredF0,\n    vec3 layeredDiffuse,\n    float layeredRoughness,\n    float layeredAnisotropy,\n    float layeredRotation,\n    vec3 layeredBottomF0,\n    float layeredFraction\n) {\n    vec3 N = geometry.normal;\n    vec3 V = geometry.viewDir;\n    IncidentLight directLight;\n    vec3 accumLight = vec3(0.0);\n#define ACCUM_LIGHT { vec3 L = directLight.direction; float NdotL = max(EPSILON, dot(N, L)); vec3 H = normalize(L + V); float NdotH = dot(N, H); float VdotH = dot(V, H); float Hu = dot(H, Tu); float Hv = dot(H, Tv); vec3 Hlocal = vec3(Hu, Hv, NdotH); accumLight += directLight.color * PrismLayeredBRDF( Hlocal, NdotL, NdotH, NdotV, VdotH, Hlocal, NdotL, NdotH, NdotV, surfaceAlbedo, surfaceRoughness, surfaceAnisotropy, surfaceRotation, layeredF0, layeredDiffuse, layeredRoughness, layeredAnisotropy, layeredRotation, layeredBottomF0, layeredFraction ); }\n#if NUM_DIR_LIGHTS > 0\n    for (int i = 0; i < NUM_DIR_LIGHTS; i++) {\n        DirectionalLight directionalLight = directionalLights[i];\n        getDirectionalDirectLightIrradiance(directionalLight, geometry, directLight);\n        ACCUM_LIGHT\n    }\n#endif\n#if NUM_POINT_LIGHTS > 0\n    for (int i = 0; i < NUM_POINT_LIGHTS; i++) {\n        PointLight pointLight = pointLights[i];\n        getPointDirectLightIrradiance(pointLight, geometry, directLight);\n        ACCUM_LIGHT\n    }\n#endif\n#if NUM_SPOT_LIGHTS > 0\n    for (int i = 0; i < NUM_SPOT_LIGHTS; i++) {\n        SpotLight spotLight = spotLights[i];\n        getSpotDirectLightIrradiance(spotLight, geometry, directLight);\n        ACCUM_LIGHT\n    }\n#endif\n    return accumLight;\n}\n#endif\nvoid main() {\n    vec3 N;\n    vec3 V;\n    vec3 Tu;\n    vec3 Tv;\n    getGeoContext(\n        vViewPosition, vNormal, vUv,\n        vTangent, vBitangent,\n        N, V, Tu, Tv\n    );\n    float NdotV = clamp(dot(N, V), EPSILON, 1.0);\n    float surface_cutout = 1.0;\n    #include <prism_sample_surface_cutout>\n    if (_surface_cutout < 0.01) discard;\n    #include <prism_sample_surface_albedo>\n    #include <prism_sample_surface_roughness>\n    #include <prism_sample_surface_anisotropy>\n    #include <prism_sample_surface_rotation>\n    #include <prism_sample_layered_f0>\n    #include <prism_sample_layered_diffuse>\n    #include <prism_sample_layered_fraction>\n    #include <prism_sample_layered_bottom_f0>\n    #include <prism_sample_layered_roughness>\n    #include <prism_sample_layered_anisotropy>\n    #include <prism_sample_layered_rotation>\n    vec3 outRadiance = vec3(0.0);\n#if (NUM_DIR_LIGHTS > 0) || (NUM_POINT_LIGHTS > 0) || (NUM_SPOT_LIGHTS > 0)\n    GeometricContext geometry;\n    geometry.position = -vViewPosition;\n    geometry.normal = N;\n    geometry.viewDir = V;\n    outRadiance += getDiscreteLightRadiance(\n        geometry,\n        NdotV, Tu, Tv,\n        _surface_albedo,\n        _surface_roughness,\n        _surface_anisotropy,\n        _surface_rotation,\n        _layered_f0,\n        _layered_diffuse,\n        _layered_roughness,\n        _layered_anisotropy,\n        _layered_rotation,\n        _layered_bottom_f0,\n        _layered_fraction\n    );\n#endif\n#if defined(USE_ENVMAP)\n    outRadiance += PrismLayeredIBL(\n        N, V, NdotV, Tu, Tv,\n        N, NdotV,\n        _surface_albedo,\n        _surface_roughness,\n        _surface_anisotropy,\n        _surface_rotation,\n        _layered_f0,\n        _layered_diffuse,\n        _layered_roughness,\n        _layered_anisotropy,\n        _layered_rotation,\n        _layered_bottom_f0,\n        _layered_fraction\n    );\n#endif\n    outRadiance *= uEnvExp;\n    outRadiance = toneMapping(outRadiance);\n    gl_FragColor = LinearToGamma(vec4(outRadiance, 1.0), float(GAMMA_FACTOR));\n}\n"},Pp(Op.uniforms),Op)},Gp[Hp.TRANSPARENT]=function(){return Up||(Up={transparent:!0,depthWrite:!1,uniforms:{transparent_color:{type:"c",value:new t.Color(1118481)},transparent_ior:{type:"f",value:2}},vertexShader:Ip,fragmentShader:"varying vec3 vViewPosition;\nvarying vec3 vNormal;\nvarying vec2 vUv;\nvarying vec3 vTangent;\nvarying vec3 vBitangent;\nuniform vec3 surface_albedo;\nuniform float surface_roughness;\nuniform float surface_anisotropy;\nuniform float surface_rotation;\nuniform vec3 transparent_color;\nuniform float transparent_ior;\nuniform float uEnvExp;\n#include <prism_uniforms_surface_albedo>\n#include <prism_uniforms_surface_roughness>\n#include <prism_uniforms_surface_cutout>\n#include <prism_uniforms_surface_anisotropy>\n#include <prism_uniforms_surface_rotation>\n#include <prism_uniforms_surface_normal>\n#include <prism_uniforms_transparent_color>\n#include <prism_uniforms_transparent_ior>\n#include <common>\n#include <bsdfs>\n#include <lights_pars>\n#include <envmap_pars_fragment>\n#include <prism_common>\n#include <prism_math>\n#include <prism_env_transparent>\n#include <prism_brdf_transparent>\n#include <prism_transparency>\n#if (NUM_DIR_LIGHTS > 0) || (NUM_POINT_LIGHTS > 0) || (NUM_SPOT_LIGHTS > 0)\nvec3 getDiscreteLightRadiance(\n    GeometricContext geometry,\n    float NdotV, vec3 Tu, vec3 Tv,\n    vec3 surfaceAlbedo,\n    float surfaceRoughness,\n    float surfaceAnisotropy,\n    float surfaceRotation,\n    float transparentIor\n) {\n    vec3 N = geometry.normal;\n    vec3 V = geometry.viewDir;\n    IncidentLight directLight;\n    vec3 accumLight = vec3(0.0);\n#define ACCUM_LIGHT { vec3 L = directLight.direction; float NdotL = max(EPSILON, dot(N, L)); vec3 H = normalize(L + V); float NdotH = dot(N, H); float VdotH = dot(V, H); float Hu = dot(H, Tu); float Hv = dot(H, Tv); vec3 Hlocal = vec3(Hu, Hv, NdotH); accumLight += directLight.color * PrismTransparentBRDF(Hlocal, NdotL, NdotH, NdotV, VdotH, surfaceAlbedo, surfaceRoughness, surfaceAnisotropy, surfaceRotation, transparentIor); }\n#if NUM_DIR_LIGHTS > 0\n    for (int i = 0; i < NUM_DIR_LIGHTS; i++) {\n        DirectionalLight directionalLight = directionalLights[i];\n        getDirectionalDirectLightIrradiance(directionalLight, geometry, directLight);\n        ACCUM_LIGHT\n    }\n#endif\n#if NUM_POINT_LIGHTS > 0\n    for (int i = 0; i < NUM_POINT_LIGHTS; i++) {\n        PointLight pointLight = pointLights[i];\n        getPointDirectLightIrradiance(pointLight, geometry, directLight);\n        ACCUM_LIGHT\n    }\n#endif\n#if (NUM_SPOT_LIGHTS > 0)\n    for (int i = 0; i < NUM_SPOT_LIGHTS; i++) {\n        SpotLight spotLight = spotLights[i];\n        getSpotDirectLightIrradiance(spotLight, geometry, directLight);\n        ACCUM_LIGHT\n    }\n#endif\n    return accumLight;\n}\n#endif\nvoid main() {\n    vec3 N;\n    vec3 V;\n    vec3 Tu;\n    vec3 Tv;\n    getGeoContext(\n        vViewPosition, vNormal, vUv,\n        vTangent, vBitangent,\n        N, V, Tu, Tv\n    );\n    float NdotV = clamp(dot(N, V), EPSILON, 1.0);\n    float surface_cutout = 1.0;\n    #include <prism_sample_surface_cutout>\n    if (_surface_cutout < 0.01) discard;\n    #include <prism_sample_surface_albedo>\n    #include <prism_sample_surface_roughness>\n    #include <prism_sample_surface_anisotropy>\n    #include <prism_sample_surface_rotation>\n    #include <prism_sample_transparent_color>\n    #include <prism_sample_transparent_ior>\n    vec3 outRadiance = vec3(0.0);\n#if (NUM_DIR_LIGHTS > 0) || (NUM_POINT_LIGHTS > 0) || (NUM_SPOT_LIGHTS > 0)\n    GeometricContext geometry;\n    geometry.position = -vViewPosition;\n    geometry.normal = N;\n    geometry.viewDir = V;\n    outRadiance += getDiscreteLightRadiance(\n        geometry,\n        NdotV, Tu, Tv,\n        _surface_albedo,\n        _surface_roughness,\n        _surface_anisotropy,\n        _surface_rotation,\n        _transparent_ior\n    );\n#endif\n#if defined(USE_ENVMAP)\n    outRadiance += PrismTransparentIBL(\n        N, V, NdotV, Tu, Tv,\n        _surface_albedo,\n        _surface_roughness,\n        _surface_anisotropy,\n        _surface_rotation,\n        _transparent_color,\n        _transparent_ior\n    );\n#endif\n    outRadiance *= uEnvExp;\n    outRadiance = toneMapping(outRadiance);\n    gl_FragColor = LinearToGamma(vec4(outRadiance, 1.0), float(GAMMA_FACTOR));\n    applyPrismTransparency(gl_FragColor, _transparent_color, _transparent_ior);\n}\n"},Pp(Up.uniforms),Up)},Gp[Hp.WOOD]=function(){return Fp||(Vp=Bp(),Fp={defines:{PRISMWOOD:""},uniforms:{wood_fiber_cosine_enable:{type:"i",value:!1},wood_fiber_cosine_bands:{type:"i",value:1},wood_fiber_cosine_weights:{type:"v4",value:new t.Vector4(.1,1,1,1)},wood_fiber_cosine_frequencies:{type:"v4",value:new t.Vector4(1,1,1,1)},wood_fiber_perlin_enable:{type:"i",value:!0},wood_fiber_perlin_bands:{type:"i",value:4},wood_fiber_perlin_weights:{type:"v4",value:new t.Vector4(8,2,.5,.05)},wood_fiber_perlin_frequencies:{type:"v4",value:new t.Vector4(.016666666666666666,.05,.18181818181818182,1)},wood_fiber_perlin_scale_z:{type:"f",value:.2},wood_growth_perlin_enable:{type:"i",value:!0},wood_growth_perlin_bands:{type:"i",value:2},wood_growth_perlin_weights:{type:"v4",value:new t.Vector4(2,.5,1,1)},wood_growth_perlin_frequencies:{type:"v4",value:new t.Vector4(.2,1,1,1)},wood_latewood_ratio:{type:"f",value:.082},wood_earlywood_sharpness:{type:"f",value:.25},wood_latewood_sharpness:{type:"f",value:.812},wood_ring_thickness:{type:"f",value:.6},wood_earlycolor_perlin_enable:{type:"i",value:!0},wood_earlycolor_perlin_bands:{type:"i",value:2},wood_earlycolor_perlin_weights:{type:"v4",value:new t.Vector4(.85,.3,1,1)},wood_earlycolor_perlin_frequencies:{type:"v4",value:new t.Vector4(.125,.3333333333333333,1,1)},wood_early_color:{type:"c",value:new t.Color(.42050799696531205,.14799801144636357,.0563742292350767)},wood_use_manual_late_color:{type:"i",value:!1},wood_manual_late_color:{type:"c",value:new t.Color(0,0,0)},wood_latecolor_perlin_enable:{type:"i",value:!0},wood_latecolor_perlin_bands:{type:"i",value:1},wood_latecolor_perlin_weights:{type:"v4",value:new t.Vector4(.35,1,1,1)},wood_latecolor_perlin_frequencies:{type:"v4",value:new t.Vector4(.2222222222222222,1,1,1)},wood_late_color_power:{type:"f",value:1.36},wood_diffuse_perlin_enable:{type:"i",value:!0},wood_diffuse_perlin_bands:{type:"i",value:2},wood_diffuse_perlin_weights:{type:"v4",value:new t.Vector4(.1,.25,1,1)},wood_diffuse_perlin_frequencies:{type:"v4",value:new t.Vector4(.5,20,1,1)},wood_diffuse_perlin_scale_z:{type:"f",value:.2},wood_use_pores:{type:"i",value:!0},wood_pore_type:{type:"i",value:0},wood_pore_radius:{type:"f",value:.04},wood_pore_cell_dim:{type:"f",value:.15},wood_pore_color_power:{type:"f",value:1.45},wood_pore_depth:{type:"f",value:.02},wood_use_rays:{type:"i",value:!0},wood_ray_color_power:{type:"f",value:1.2},wood_ray_seg_length_z:{type:"f",value:5},wood_ray_num_slices:{type:"f",value:160},wood_ray_ellipse_z2x:{type:"f",value:10},wood_ray_ellipse_radius_x:{type:"f",value:.2},wood_use_latewood_bump:{type:"i",value:!0},wood_latewood_bump_depth:{type:"f",value:.01},wood_use_groove_roughness:{type:"i",value:!0},wood_groove_roughness:{type:"f",value:.2},wood_diffuse_lobe_weight:{type:"f",value:.85},wood_curly_distortion_enable:{type:"i",value:!1},wood_curly_distortion_scale:{type:"f",value:.25},wood_ring_fraction:{type:"v4",value:new t.Vector4(.918,.2295,.066584,.984584)},wood_fall_rise:{type:"v2",value:new t.Vector2(.6885,.015416)},permutationMap:{type:"t",value:Vp.permutationTex},gradientMap:{type:"t",value:Vp.gradientTex},perm2DMap:{type:"t",value:Vp.perm2DTex},permGradMap:{type:"t",value:Vp.permGradTex}},vertexShader:Ip,fragmentShader:"varying vec3 vViewPosition;\nvarying vec3 vNormal;\nvarying vec2 vUv;\nvarying vec3 vTangent;\nvarying vec3 vBitangent;\nvarying vec3 vUvw;\nvarying vec3 vtNormal;\nvarying mat3 vNormalMatrix;\nuniform vec3 surface_albedo;\nuniform float surface_roughness;\nuniform float surface_anisotropy;\nuniform float surface_rotation;\nuniform bool wood_fiber_cosine_enable;\nuniform int wood_fiber_cosine_bands;\nuniform vec4 wood_fiber_cosine_weights;\nuniform vec4 wood_fiber_cosine_frequencies;\nuniform bool wood_fiber_perlin_enable;\nuniform int wood_fiber_perlin_bands;\nuniform vec4 wood_fiber_perlin_weights;\nuniform vec4 wood_fiber_perlin_frequencies;\nuniform float wood_fiber_perlin_scale_z;\nuniform bool wood_growth_perlin_enable;\nuniform int wood_growth_perlin_bands;\nuniform vec4 wood_growth_perlin_weights;\nuniform vec4 wood_growth_perlin_frequencies;\nuniform float wood_latewood_ratio;\nuniform float wood_earlywood_sharpness;\nuniform float wood_latewood_sharpness;\nuniform float wood_ring_thickness;\nuniform bool wood_earlycolor_perlin_enable;\nuniform int wood_earlycolor_perlin_bands;\nuniform vec4 wood_earlycolor_perlin_weights;\nuniform vec4 wood_earlycolor_perlin_frequencies;\nuniform vec3 wood_early_color;\nuniform bool wood_use_manual_late_color;\nuniform vec3 wood_manual_late_color;\nuniform bool wood_latecolor_perlin_enable;\nuniform int wood_latecolor_perlin_bands;\nuniform vec4 wood_latecolor_perlin_weights;\nuniform vec4 wood_latecolor_perlin_frequencies;\nuniform float wood_late_color_power;\nuniform bool wood_diffuse_perlin_enable;\nuniform int wood_diffuse_perlin_bands;\nuniform vec4 wood_diffuse_perlin_weights;\nuniform vec4 wood_diffuse_perlin_frequencies;\nuniform float wood_diffuse_perlin_scale_z;\nuniform bool wood_use_pores;\nuniform int wood_pore_type;\nuniform float wood_pore_radius;\nuniform float wood_pore_cell_dim;\nuniform float wood_pore_color_power;\nuniform float wood_pore_depth;\nuniform bool wood_use_rays;\nuniform float wood_ray_color_power;\nuniform float wood_ray_seg_length_z;\nuniform float wood_ray_num_slices;\nuniform float wood_ray_ellipse_z2x;\nuniform float wood_ray_ellipse_radius_x;\nuniform bool wood_use_latewood_bump;\nuniform float wood_latewood_bump_depth;\nuniform bool wood_use_groove_roughness;\nuniform float wood_groove_roughness;\nuniform float wood_diffuse_lobe_weight;\nuniform vec4 wood_ring_fraction;\nuniform vec2 wood_fall_rise;\nuniform bool wood_curly_distortion_enable;\nuniform float wood_curly_distortion_scale;\nuniform sampler2D permutationMap;\nuniform sampler2D gradientMap;\nuniform sampler2D perm2DMap;\nuniform sampler2D permGradMap;\nuniform float uEnvExp;\n#include <common>\n#include <bsdfs>\n#include <lights_pars>\n#include <envmap_pars_fragment>\n#include <prism_common>\n#include <prism_math>\n#include <prism_env_opaque>\n#include <prism_brdf_opaque>\n#include <prism_wood>\n#if (NUM_DIR_LIGHTS > 0) || (NUM_POINT_LIGHTS > 0) || (NUM_SPOT_LIGHTS > 0)\nvec3 getDiscreteLightRadiance(\n    GeometricContext geometry,\n    float NdotV, vec3 Tu, vec3 Tv,\n    vec3 surfaceAlbedo,\n    float surfaceRoughness,\n    float surfaceAnisotropy,\n    float surfaceRotation,\n    float opaqueF0,\n    vec3 opaqueAlbedo\n) {\n    vec3 N = geometry.normal;\n    vec3 V = geometry.viewDir;\n    IncidentLight directLight;\n    vec3 accumLight = vec3(0.0);\n#define ACCUM_LIGHT { vec3 L = directLight.direction; float NdotL = max(EPSILON, dot(N, L)); vec3 H = normalize(L + V); float NdotH = dot(N, H); float VdotH = dot(V, H); float Hu = dot(H, Tu); float Hv = dot(H, Tv); vec3 Hlocal = vec3(Hu, Hv, NdotH); accumLight += directLight.color * PrismOpaqueBRDF(Hlocal, NdotL, NdotH, NdotV, VdotH, surfaceAlbedo, surfaceRoughness, surfaceAnisotropy, surfaceRotation, opaqueF0, opaqueAlbedo ); }\n#if NUM_DIR_LIGHTS > 0\n    for (int i = 0; i < NUM_DIR_LIGHTS; i++) {\n        DirectionalLight directionalLight = directionalLights[i];\n        getDirectionalDirectLightIrradiance(directionalLight, geometry, directLight);\n        ACCUM_LIGHT\n    }\n#endif\n#if NUM_POINT_LIGHTS > 0\n    for (int i = 0; i < NUM_POINT_LIGHTS; i++) {\n        PointLight pointLight = pointLights[i];\n        getPointDirectLightIrradiance(pointLight, geometry, directLight);\n        ACCUM_LIGHT\n    }\n#endif\n#if NUM_SPOT_LIGHTS > 0\n    for (int i = 0; i < NUM_SPOT_LIGHTS; i++) {\n        SpotLight spotLight = spotLights[i];\n        getSpotDirectLightIrradiance(spotLight, geometry, directLight);\n        ACCUM_LIGHT\n    }\n#endif\n    return accumLight;\n}\n#endif\nvoid main() {\n    vec3 N;\n    vec3 V;\n    vec3 Tu;\n    vec3 Tv;\n    getGeoContext(\n        vViewPosition, vNormal, vUv,\n        vTangent, vBitangent,\n        N, V, Tu, Tv\n    );\n#if defined(PRISMWOODBUMP)\n    getFinalWoodContext(\n        N, V, Tu, Tv, vUvw,\n        vNormal, vtNormal, vNormalMatrix\n    );\n#endif\n    float NdotV = clamp(dot(N, V), EPSILON, 1.0);\n    float woodRoughness = surface_roughness;\n    vec3 woodDiffuse = NoiseWood(vUvw, woodRoughness);\n    vec3 outRadiance = vec3(0.0);\n#if (NUM_DIR_LIGHTS > 0) || (NUM_POINT_LIGHTS > 0) || (NUM_SPOT_LIGHTS > 0)\n    GeometricContext geometry;\n    geometry.position = -vViewPosition;\n    geometry.normal = N;\n    geometry.viewDir = V;\n    outRadiance += getDiscreteLightRadiance(\n        geometry,\n        NdotV, Tu, Tv,\n        surface_albedo,\n        woodRoughness,\n        surface_anisotropy,\n        surface_rotation,\n        0.04,\n        woodDiffuse\n    );\n#endif\n#if defined(USE_ENVMAP)\n    outRadiance += PrismOpaqueIBL(\n        N, V, NdotV, Tu, Tv,\n        surface_albedo,\n        woodRoughness,\n        surface_anisotropy,\n        surface_rotation,\n        0.04,\n        woodDiffuse,\n        0.0,\n        vec3(0.0)\n    );\n#endif\n    outRadiance *= uEnvExp;\n    outRadiance = toneMapping(outRadiance);\n    gl_FragColor = LinearToGamma(vec4(outRadiance, 1.0), float(GAMMA_FACTOR));\n}\n"})};var Wp=function(e,t){var n=[6.0014,-2.7008,-1.7996,-1.332,3.1029,-5.7721,.3008,-1.0882,5.6268],r=255*e[2]+e[3],a=Math.pow(2,(r-127)/2),i=a/e[1],o=e[0]*i,s=n[0]*o+n[3]*a+n[6]*i,l=n[1]*o+n[4]*a+n[7]*i,u=n[2]*o+n[5]*a+n[8]*i;s<0&&(s=0),l<0&&(l=0),u<0&&(u=0),t[0]=s,t[1]=l,t[2]=u},qp=function(e,t,n){var r=Math.sqrt(e[0]*n)*(1/16),a=Math.sqrt(e[1]*n)*(1/16),i=Math.sqrt(e[2]*n)*(1/16),o=Math.min(Math.max(Math.max(r,a),Math.max(i,1e-6)),1);o=Math.ceil(255*o)/255,t[0]=r/o,t[1]=a/o,t[2]=i/o,t[3]=o},jp=function(e,t){for(var n=new Float32Array(4),r=new Float32Array(4),a=0;a<e.image.length;a++)for(var i=e.image[a],o=0;o<i.mipmaps.length;o++)for(var s=i.mipmaps[o].data,l=0;l<s.length;l+=4)n[0]=s[l]/255,n[1]=s[l+1]/255,n[2]=s[l+2]/255,n[3]=s[l+3]/255,Wp(n,r),qp(r,n,t),s[l]=Math.round(255*n[0]),s[l+1]=Math.round(255*n[1]),s[l+2]=Math.round(255*n[2]),s[l+3]=Math.round(255*n[3])},Xp=function(e,n){return new Promise(function(r,a){var i=new t.DDSLoader,o=new t.CubeTexture;o.format=t.RGBAFormat,o.encoding=t.LinearEncoding,o.mapping=t.CubeReflectionMapping,o.isCompressedTexture=!0,o.generateMipmaps=!1;var s=Math.pow(2,n);i.load(e,function(e){jp(e,s);for(var n=0;n<e.image.length;n++)o.image[n]=e.image[n];o.minFilter=o.image[0].mipmaps.length>1?o.minFilter:t.LinearFilter,o.needsUpdate=!0,r(o)},function(){},function(e){a(new Error("environment map load failed"))})})},Yp=function(){function e(){sd(this,e),this._specMap=null,this._irrMap=null,this._exposure=0}return ld(e,[{key:"load",value:function(e,t,n){var r=this;return Promise.all([Xp(e,n),Xp(t,n)]).then(function(e){var t=cd(e,2),a=t[0],i=t[1];return r._specMap=a,r._irrMap=i,r._exposure=n,r})}},{key:"setToScene",value:function(t){e.registerSceneShader(!0),t.background=this._specMap}},{key:"setToMaterial",value:function(e){e.envMap=this._specMap,e.uniforms.envMap={value:this._specMap},e.uniforms.irrMap={value:this._irrMap},e.uniforms.uEnvExp={value:Math.pow(2,this._exposure)},e.needsUpdate=!0}}],[{key:"load",value:function(t,n,r){return(new e).load(t,n,r)}},{key:"registerSceneShader",value:function(e){e?(t.ShaderLib.cube_orig||(t.ShaderLib.cube_orig={fragmentShader:t.ShaderLib.cube.fragmentShader}),t.ShaderLib.cube.fragmentShader="uniform samplerCube tCube;\nuniform float tFlip;\nuniform float opacity;\nvarying vec3 vWorldPosition;\n#include <common>\nvec3 decodeRGBM(in vec4 vRGBM) {\n    vec3 ret = vRGBM.rgb * (vRGBM.a * 16.0);\n    ret *= ret;\n    return ret;\n}\nvoid main() {\n    vec4 texel = textureCube(tCube, vWorldPosition.xyz);\n    vec3 color = toneMapping(decodeRGBM(texel));\n    gl_FragColor = vec4(color, opacity);\n    gl_FragColor = LinearToGamma(gl_FragColor, float(GAMMA_FACTOR));\n}\n"):t.ShaderLib.cube_orig&&(t.ShaderLib.cube.fragmentShader=t.ShaderLib.cube_orig.fragmentShader)}}]),e}(),Kp=Symbol("Riverbank"),Zp=Symbol("Contrast"),Qp=Symbol("Rim Highlights"),Jp=Symbol("Cool Light"),$p=Symbol("Warm Light"),eh=Symbol("Soft Light"),th=Symbol("Grid Light"),nh=Symbol("Plaza"),rh=Symbol("Snow Field"),ah=Symbol("Field"),ih=Symbol("Boardwalk"),oh=Symbol("Crossroads"),sh=Symbol("Seaport"),lh=Symbol("Glacier"),uh=Symbol("RaaS Test Env"),fh={};fh[Kp]={name:"Riverbank",path:"riverbank",exposure:-5.7},fh[Zp]={name:"Contrast",path:"IDViz",exposure:0},fh[Qp]={name:"Rim Highlights",path:"RimHighlights",exposure:-9},fh[Jp]={name:"Cool Light",path:"CoolLight",exposure:-9},fh[$p]={name:"Warm Light",path:"WarmLight",exposure:-9},fh[eh]={name:"Soft Light",path:"SoftLight",exposure:-9},fh[th]={name:"Grid Light",path:"GridLight",exposure:-9},fh[nh]={name:"Plaza",path:"Plaza",exposure:-14},fh[rh]={name:"Snow Field",path:"SnowField",exposure:-10.461343},fh[ah]={name:"Field",path:"field",exposure:-2.9},fh[ih]={name:"Boardwalk",path:"boardwalk",exposure:-7},fh[oh]={name:"Crossroads",path:"crossroads",exposure:-5.5},fh[sh]={name:"Seaport",path:"seaport",exposure:-6.5},fh[lh]={name:"Glacier",path:"glacier",exposure:0},fh[uh]={name:"RaaS Test Env",path:"Reflection",exposure:-1.5};var dh="https://autodeskviewer.com/viewers/latest/res/environments/",ch=function(e){return fh[e]},ph=Object.freeze({RIVERBANK:Kp,CONTRAST:Zp,RIM_HIGHLIGHTS:Qp,COOL_LIGHT:Jp,WARM_LIGHT:$p,SOFT_LIGHT:eh,GRID_LIGHT:th,PLAZA:nh,SNOW_FIELD:rh,FIELD:ah,BOARDWALK:ih,CROSSROADS:oh,SEAPORT:sh,GLACIER:lh,RAAS_TEST:uh,get:ch,load:function(e){var t=ch(e);return t?Yp.load(dh+t.path+"_mipdrop.logluv.dds",dh+t.path+"_irr.logluv.dds",t.exposure):Promise.reject(new Error("Preset does not exist: "+e))}}),hh={vertexShader:"varying vec3 vNormal;\nvarying float depth;\n#include <pack_normals>\nvoid main() {\n#ifdef UNPACK_NORMALS\n    vec3 objectNormal = decodeNormal(normal);\n#else\n    vec3 objectNormal = normal;\n#endif\n#ifdef FLIP_SIDED\n    objectNormal = -objectNormal;\n#endif\n    objectNormal = objectNormal;\n    vec3 instPos = position;\n    vec3 transformedNormal = normalMatrix * objectNormal;\n    vNormal = normalize( transformedNormal );\n    vec4 mvPosition = modelViewMatrix * vec4( instPos, 1.0 );\n    depth = mvPosition.z;\n    vec4 p_Position = projectionMatrix * mvPosition;\n    gl_Position = p_Position;\n}",fragmentShader:"varying highp vec3 vNormal;\nvarying highp float depth;\nvoid main() {\n    vec3 n = vNormal;\n    n = n * ( -1.0 + 2.0 * float( gl_FrontFacing ) );\n    n = normalize( n );\n    gl_FragColor = vec4(n.x, n.y, depth, 1.0);\n}\n"},mh="varying vec2 vUv;\nvoid main() {\n    vUv = uv;\n    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}\n",_h={extensions:{derivatives:!0},uniforms:{tDepth:{type:"t",value:null},projInfo:{type:"v4",value:new t.Vector4},isOrtho:{type:"f",value:0},worldMatrix_mainPass:{type:"m4",value:new t.Matrix4},size:{type:"v2",value:new t.Vector2(512,512)},resolution:{type:"v2",value:new t.Vector2(1/512,1/512)},cameraNear:{type:"f",value:1},cameraFar:{type:"f",value:100},radius:{type:"f",value:10},bias:{type:"f",value:.1},projScale:{type:"f",value:500},intensity:{type:"f",value:.4},tDepth_mip1:{type:"t",value:null},tDepth_mip2:{type:"t",value:null},tDepth_mip3:{type:"t",value:null},tDepth_mip4:{type:"t",value:null},tDepth_mip5:{type:"t",value:null}},vertexShader:mh,fragmentShader:Cl},vh={uniforms:{tDiffuse:{type:"t",value:null},tAO:{type:"t",value:null},aoOpacity:{type:"f",value:1}},vertexShader:mh,fragmentShader:"uniform sampler2D tDiffuse;\nuniform sampler2D tAO;\nuniform float aoOpacity;\nvarying vec2 vUv;\nvec4 sampleColor() {\n    return texture2D(tDiffuse, vUv);\n}\nfloat sampleAO() {\n    return sqrt(texture2D(tAO, vUv).r);\n}\nvoid main() {\n    vec4 texel = sampleColor();\n    float ao = sampleAO();\n    ao = 1.0 - (1.0 - ao) * aoOpacity;\n    texel.rgb *= ao;\n    gl_FragColor = texel;\n}\n"};t.ShaderChunk.pack_depth="\nvec4 packDepth( const in float depth ) {\n    vec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n    enc = fract(enc);\n    enc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n    return enc;\n}\nfloat unpackDepth( const in vec4 rgba_depth ) {\n    return dot( rgba_depth, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );\n}\n",t.ShaderChunk.pack_normals="\n#define kPI 3.14159265358979\nvec2 encodeNormal (vec3 n) {\n    return (vec2(atan(n.y,n.x)/kPI, n.z)+1.0)*0.5;\n}\nvec3 decodeNormal (vec2 enc) {\n    vec2 ang = enc * 2.0 - 1.0;\n    vec2 scth = vec2(sin(ang.x * kPI), cos(ang.x * kPI));\n    vec2 scphi = vec2(sqrt(1.0 - ang.y * ang.y), ang.y);\n    return vec3(scth.y * scphi.x, scth.x * scphi.x, scphi.y);\n}\n",t.ShaderChunk.depth_texture="\nuniform sampler2D tDepth;\nuniform vec4 projInfo;\nuniform float isOrtho;\nuniform mat4 worldMatrix_mainPass;\nvec3 reconstructCSPosition(vec2 fragCoords, float z) {\n    return vec3((fragCoords * projInfo.xy + projInfo.zw) * mix(z, -1.0, isOrtho), z);\n}\nvec3 reconstructWorldPosition(vec2 fragCoords, vec2 screenUv) {\n    float zCam = texture2D(tDepth, screenUv).z;\n    vec3 csPos = reconstructCSPosition(fragCoords, zCam);\n    return (worldMatrix_mainPass * vec4(csPos, 1.0)).xyz;\n}\n";var gh=function(){function e(){sd(this,e),this.isMobile=!1,this.radius=10,this.bias=1,this.intensity=.4,this.depthTarget=null,this.depthMipMap=null,this.saoTarget=null,this.postTarget1=null,this.depthMaterial=new t.ShaderMaterial(hh),this.saoMipFirstPass=new kl(Fd),this.saoMipPass=new kl(Vd),this.saoMainPass=new kl(_h),this.saoBlurPass=new kl(Il),this.blendPass=new kl(vh)}return ld(e,[{key:"_allocTargets",value:function(e,n){var r=1/e,a=1/n;this.depthTarget=new t.WebGLRenderTarget(e,n,{minFilter:t.NearestFilter,magFilter:t.NearestFilter,format:t.RGBFormat,type:this.isMobile?t.HalfFloatType:t.FloatType,stencilBuffer:!1}),this.postTarget1=new t.WebGLRenderTarget(e,n,{minFilter:t.LinearFilter,magFilter:t.LinearFilter,format:t.RGBAFormat,stencilBuffer:!1,depthBuffer:!1}),this.postTarget1.texture.generateMipmaps=!1,this.saoTarget=this.postTarget1.clone();this.depthMipMap=[];for(var i=0;i<5;i++){var o=0|e/(2<<i),s=0|n/(2<<i),l=new t.WebGLRenderTarget(o,s,{minFilter:t.NearestFilter,magFilter:t.NearestFilter,format:t.RGBAFormat,depthBuffer:!1,stencilBuffer:!1});l.texture.generateMipmaps=!1,this.depthMipMap.push(l),this.saoMainPass.uniforms["tDepth_mip"+(i+1)].value=l.texture}this.saoMainPass.uniforms.size.value.set(e,n),this.saoMainPass.uniforms.resolution.value.set(r,a),this.saoMainPass.uniforms.tDepth.value=this.depthTarget.texture,this.saoBlurPass.uniforms.size.value.set(e,n),this.saoBlurPass.uniforms.resolution.value.set(r,a),this.blendPass.uniforms.tAO.value=this.saoTarget.texture,this.blendPass.uniforms.aoOpacity.value=1}},{key:"_updateUniforms",value:function(e,n,r){this.saoMainPass.uniforms.radius.value=this.radius,this.saoMainPass.uniforms.bias.value=this.bias*this.radius*(this.isMobile?.1:.01),this.saoMainPass.uniforms.intensity.value=this.intensity,this.saoBlurPass.uniforms.radius.value=this.radius;var a=r.near,i=r.far;this.saoMainPass.uniforms.cameraNear.value=a,this.saoMainPass.uniforms.cameraFar.value=i,this.saoMipFirstPass.uniforms.cameraNear.value=a,this.saoMipFirstPass.uniforms.cameraInvNearFar.value=1/(a-i);var o=r instanceof t.PerspectiveCamera,s=r.projectionMatrix.elements;o?this.saoMainPass.uniforms.projInfo.value.set(-2/(e*s[0]),-2/(n*s[5]),(1-s[8])/s[0],(1+s[9])/s[5]):this.saoMainPass.uniforms.projInfo.value.set(-2/(e*s[0]),-2/(n*s[5]),(1-s[12])/s[0],(1-s[13])/s[5]),this.saoMainPass.uniforms.isOrtho.value=o?0:1,this.saoMainPass.uniforms.projScale.value=n*s[5]*.125}},{key:"render",value:function(e,t,n,r,a){var i=r.width,o=r.height;this.depthTarget&&this.depthTarget.width===i&&this.depthTarget.height===o||this._allocTargets(i,o),this._updateUniforms(i,o,n);var s=e.getClearColor().getHex(),l=e.getClearAlpha(),u=e.autoClear;e.autoClear=!1,e.setClearColor(0,1),e.clearTarget(this.depthTarget,!0,!0,!1),e.setClearColor(s,l);var f=t.overrideMaterial;t.overrideMaterial=this.depthMaterial,e.render(t,n,this.depthTarget,!1),t.overrideMaterial=f;var d=this.depthMipMap[0];this.saoMipFirstPass.uniforms.resolution.value.set(1/d.width,1/d.height),this.saoMipFirstPass.render(e,d,this.depthTarget);for(var c=1;c<this.depthMipMap.length;++c){var p=this.depthMipMap[c];this.saoMipPass.uniforms.resolution.value.set(1/p.width,1/p.height),this.saoMipPass.render(e,p,d),d=p}this.saoMainPass.render(e,this.saoTarget),this.saoBlurPass.uniforms.axis.value.set(1,0),this.saoBlurPass.render(e,this.postTarget1,this.saoTarget),this.saoBlurPass.uniforms.axis.value.set(0,1),this.saoBlurPass.render(e,this.saoTarget,this.postTarget1),this.blendPass.render(e,a,r),e.autoClear=u}}]),e}(),yh="varying vec2 vUv;\nvarying vec2 vGaussianUVs[14];\nvoid main() {\n    vUv = vec2(uv.x, uv.y);\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n    vGaussianUVs[ 0] = vUv + vec2(-7.0 * KERNEL_SCALE, 0.0)UV_SWIZZLE;\n    vGaussianUVs[ 1] = vUv + vec2(-6.0 * KERNEL_SCALE, 0.0)UV_SWIZZLE;\n    vGaussianUVs[ 2] = vUv + vec2(-5.0 * KERNEL_SCALE, 0.0)UV_SWIZZLE;\n    vGaussianUVs[ 3] = vUv + vec2(-4.0 * KERNEL_SCALE, 0.0)UV_SWIZZLE;\n    vGaussianUVs[ 4] = vUv + vec2(-3.0 * KERNEL_SCALE, 0.0)UV_SWIZZLE;\n    vGaussianUVs[ 5] = vUv + vec2(-2.0 * KERNEL_SCALE, 0.0)UV_SWIZZLE;\n    vGaussianUVs[ 6] = vUv + vec2(-1.0 * KERNEL_SCALE, 0.0)UV_SWIZZLE;\n    vGaussianUVs[ 7] = vUv + vec2( 1.0 * KERNEL_SCALE, 0.0)UV_SWIZZLE;\n    vGaussianUVs[ 8] = vUv + vec2( 2.0 * KERNEL_SCALE, 0.0)UV_SWIZZLE;\n    vGaussianUVs[ 9] = vUv + vec2( 3.0 * KERNEL_SCALE, 0.0)UV_SWIZZLE;\n    vGaussianUVs[10] = vUv + vec2( 4.0 * KERNEL_SCALE, 0.0)UV_SWIZZLE;\n    vGaussianUVs[11] = vUv + vec2( 5.0 * KERNEL_SCALE, 0.0)UV_SWIZZLE;\n    vGaussianUVs[12] = vUv + vec2( 6.0 * KERNEL_SCALE, 0.0)UV_SWIZZLE;\n    vGaussianUVs[13] = vUv + vec2( 7.0 * KERNEL_SCALE, 0.0)UV_SWIZZLE;\n}",xh="uniform sampler2D tDiffuse;\nvarying vec2 vUv;\nvarying vec2 vGaussianUVs[14];\nvoid main() {\n    gl_FragColor = vec4(0.0);\n    gl_FragColor += texture2D(tDiffuse, vGaussianUVs[ 0]) * 0.0044299121055113265;\n    gl_FragColor += texture2D(tDiffuse, vGaussianUVs[ 1]) * 0.00895781211794;\n    gl_FragColor += texture2D(tDiffuse, vGaussianUVs[ 2]) * 0.0215963866053;\n    gl_FragColor += texture2D(tDiffuse, vGaussianUVs[ 3]) * 0.0443683338718;\n    gl_FragColor += texture2D(tDiffuse, vGaussianUVs[ 4]) * 0.0776744219933;\n    gl_FragColor += texture2D(tDiffuse, vGaussianUVs[ 5]) * 0.115876621105;\n    gl_FragColor += texture2D(tDiffuse, vGaussianUVs[ 6]) * 0.147308056121;\n    gl_FragColor += texture2D(tDiffuse, vUv             ) * 0.159576912161;\n    gl_FragColor += texture2D(tDiffuse, vGaussianUVs[ 7]) * 0.147308056121;\n    gl_FragColor += texture2D(tDiffuse, vGaussianUVs[ 8]) * 0.115876621105;\n    gl_FragColor += texture2D(tDiffuse, vGaussianUVs[ 9]) * 0.0776744219933;\n    gl_FragColor += texture2D(tDiffuse, vGaussianUVs[10]) * 0.0443683338718;\n    gl_FragColor += texture2D(tDiffuse, vGaussianUVs[11]) * 0.0215963866053;\n    gl_FragColor += texture2D(tDiffuse, vGaussianUVs[12]) * 0.00895781211794;\n    gl_FragColor += texture2D(tDiffuse, vGaussianUVs[13]) * 0.0044299121055113265;\n}\n",bh={defines:{UV_SWIZZLE:".xy",KERNEL_SCALE:"1.0"},uniforms:{tDiffuse:{type:"t",value:null}},vertexShader:yh,fragmentShader:xh},wh={defines:{UV_SWIZZLE:".yx",KERNEL_SCALE:"1.0"},uniforms:{tDiffuse:{type:"t",value:null}},vertexShader:yh,fragmentShader:xh},Mh=function(){function e(t,n){sd(this,e),this.passH=new kl(bh),this.passV=new kl(wh),this.setSize(t,n)}return ld(e,[{key:"setSize",value:function(e,t){this.passH.material.defines.KERNEL_SCALE=(1/e).toFixed(8),this.passV.material.defines.KERNEL_SCALE=(1/t).toFixed(8),this.passH.material.needsUpdate=!0,this.passV.material.needsUpdate=!0}},{key:"render",value:function(e,t,n,r){this.passH.render(e,n,t),this.passV.render(e,r,n)}}]),e}(),Sh={uniforms:{tDiffuse:{type:"t",value:null},color:{type:"v4",value:new t.Vector4(1,1,1,1)}},vertexShader:mh,fragmentShader:"uniform sampler2D tDiffuse;\nuniform vec4 color;\nvarying vec2 vUv;\nvoid main() {\n    float shadow = 1.0 - texture2D(tDiffuse, vUv).r;\n    gl_FragColor = vec4(color.rgb, color.a * shadow);\n}\n"},Th=function(e){function n(e){sd(this,n);var r=dd(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return r.params=Object.assign({resolution:128,blurLevel:1,color:new t.Color(0,0,0),alpha:1,debug:!1},e),r.geometry.addAttribute("position",new t.BufferAttribute(new Float32Array([-.5,-.5,-.5,-.5,-.5,.5,.5,-.5,.5,.5,-.5,-.5]),3)),r.geometry.addAttribute("uv",new t.BufferAttribute(new Float32Array([0,0,0,1,1,1,1,0]),2)),r.geometry.setIndex(new t.BufferAttribute(new Uint16Array([0,1,2,2,3,0]),1)),r._target1=new t.WebGLRenderTarget(r.params.resolution,r.params.resolution,{format:t.RGBFormat,stencilBuffer:!1}),r._target2=r._target1.clone(),r._matDepth=new t.ShaderMaterial({vertexShader:t.ShaderLib.depth.vertexShader,fragmentShader:t.ShaderLib.depth.fragmentShader.replace(/DEPTH_PACKING/g,"3200")}),r._matDepth.blending=t.NoBlending,r._blurPass=new Mh(r.params.resolution,r.params.resolution),r.material=new t.ShaderMaterial(Sh),r.material.uniforms.tDiffuse.value=r._target1.texture,r.material.uniforms.color.value.set(r.params.color.r,r.params.color.g,r.params.color.b,r.params.alpha),r.material.transparent=!0,r.material.depthWrite=!1,r._camera=new t.OrthographicCamera(-.5,.5,.5,-.5,.01,.99),r._camera.position.y=-.5,r._camera.rotation.x=Math.PI/2,r.add(r._camera),r.params.debug&&(r._debugBox=new t.Mesh(new t.BoxGeometry(1,1,1),new t.MeshBasicMaterial({color:65280,wireframe:!0})),r.add(r._debugBox)),r}return fd(n,e),ld(n,[{key:"render",value:function(e,t){this.updateParams(),this.clear(e),this.renderShadow(e,t),this.postprocess(e)}},{key:"updateParams",value:function(){this.params.resolution!==this._target1.width&&(this._target1.setSize(this.params.resolution,this.params.resolution),this._target2.setSize(this.params.resolution,this.params.resolution),this._blurPass.setSize(this.params.resolution,this.params.resolution)),this.material.uniforms.color.value.set(this.params.color.r,this.params.color.g,this.params.color.b,this.params.alpha)}},{key:"clear",value:function(e){var t=e.getRenderTarget(),n=e.getClearColor().getHex(),r=e.getClearAlpha();e.setClearColor(16777215,1),e.clearTarget(this._target1,!0,!0,!1),e.setRenderTarget(t),e.setClearColor(n,r)}},{key:"renderShadow",value:function(e,t){this.visible=!1;var n=t.overrideMaterial;t.overrideMaterial=this._matDepth;var r=e.getRenderTarget(),a=e.autoClear;e.autoClear=!1,e.render(t,this._camera,this._target1),e.setRenderTarget(r),e.autoClear=a,t.overrideMaterial=n,this.visible=!0}},{key:"postprocess",value:function(e){for(var t=0;t<this.params.blurLevel;++t)this._blurPass.render(e,this._target1,this._target2,this._target1)}}]),n}(t.Mesh);return e.PrismMaterial=Hp,e.Environment=Yp,e.EnvPresets=ph,e.SAOEffect=gh,e.ShadowPlane=Th,e.GaussianBlurPass=Mh,e.WebWorkerCreator=Tp,e.VERSION=Sp,e.BackgroundShader=Vs,e.BasicShader=Ml,e.BlendShader=Tl,e.CelShader=Al,e.CopyShader=El,e.ClearShader=Rl,e.HighlightShader=Ll,e.FXAAShader=Pl,e.SAOBlurShader=Il,e.SAOShader=Dl,e.NormalsShader=Nl,e.EdgeShader=Ol,e.LineShader=Ul,e.OcclusionShader=Fl,e.ShaderPass=kl,e.GaussianPass=Wl,e.GroundReflection=function(e,n,r,a){var i,o,s,l,u,f,d=e,c=d.getContext(),p=n||512,h=r||512,m=!1,_=new t.Color(0,0,0),v=!1,g=!1;this.inTarget=void 0,this.outTarget=void 0;var y=!0,x=0,b={color:new t.Color(1,1,1),alpha:.3,texScale:.5,blurRadius:2,blurTexScale:.5,fadeAngle:Math.PI/18},w=function(e){var n=e.normal,r=e.constant;return(new t.Matrix4).set(1-2*n.x*n.x,-2*n.y*n.x,-2*n.x*n.z,-2*r*n.x,-2*n.x*n.y,1-2*n.y*n.y,-2*n.y*n.z,-2*r*n.y,-2*n.x*n.z,-2*n.y*n.z,1-2*n.z*n.z,-2*r*n.z,0,0,0,1)};if(this.setTransform=function(e,t,n){l=e,s.normal=t,s.constant=-e.dot(t)},this.cleanup=function(){i&&i.cleanup(),this.inTarget&&this.inTarget.dispose(),this.outTarget&&this.outTarget.dispose()},this.setSize=function(e,n){p=e,h=n,this.cleanup(),this.inTarget=new t.WebGLRenderTarget(p*b.texScale,h*b.texScale,{magFilter:t.LinearFilter,minFilter:t.LinearFilter,format:t.RGBAFormat,stencilBuffer:!1}),this.inTarget.generateMipmaps=!1,this.outTarget=new t.WebGLRenderTarget(p*b.texScale,h*b.texScale,{magFilter:t.LinearFilter,minFilter:t.LinearFilter,format:t.RGBAFormat,stencilBuffer:!1}),this.outTarget.generateMipmaps=!1,i?i.setSize(p*b.texScale*b.blurTexScale,h*b.texScale*b.blurTexScale):i=new Wl(p*b.texScale*b.blurTexScale,h*b.texScale*b.blurTexScale,b.blurRadius,1,{hasAlpha:!0,blending:!0,flipUV:!0})},this.updateCamera=function(e){var n;n=e.isPerspective?l.clone():e.target.clone();var r=e.position.clone().sub(n).normalize(),a=Math.PI/2-r.angleTo(s.normal);if(!(m=a<0)){if(b.fadeAngle>0){var o=Math.min(b.fadeAngle,a)/b.fadeAngle;i.setAlpha(o*b.alpha)}var f=w(s);(u=e.clone()).applyMatrix(f),u.projectionMatrix.elements[5]*=-1,u.matrixWorldNeedsUpdate=!0,e.worldUpTransform?u.worldUpTransform=e.worldUpTransform.clone():u.worldUpTransform=new t.Matrix4}},this.renderIntoReflection=function(e){m||d.render(e,u,this.inTarget)},this.prepareGroundReflection=function(){var e,t=0,n=0,r=0;return function(a,i,o,s,l,u){var f=i.modelQueue();if(0!==x||f.isEmpty())return x=1,l;if(e!=f.getGeomScenes()&&(y=!0),y){if(y=!1,this.updateCamera(i.camera),this.isGroundCulled())return x=1,l;this.clear(),e=f.getGeomScenes(),t=e.length,n=0,r=s?Math.max(Math.ceil(t/100),s):t,x=0}else{if(0!==x)return x=1,l;0===s&&(r=t)}var d,c;l&&(d=performance.now(),c=(u=void 0===u?1:u)*l);for(var p,h=0;h<r&&n<t;){var m=e[n++];if(m&&(h++,m.forceVisible=!0,this.renderIntoReflection(m),m.forceVisible=!1,l)){var _=performance.now()-d;if(c<_&&n<t){x=0,p=l-_;break}}}return n<t&&(x=0,p=l?l-performance.now()+d:1),void 0===p||o?(this.postprocess(i.camera,i.matman()),a&&a.enabled&&i.renderGroundShadow(this.outTarget),this.renderReflection(i.camera,i.renderer().getColorTarget()),void 0===p&&(x=2),l?l-performance.now()+d:1):p}}(),this.renderReflection=function(e,t){m||(c.depthRange(.999999,1),o.render(d,t,this.outTarget),c.depthRange(0,1))},this.toggleEnvMapBackground=function(e){g=e,f.uniforms.envMapBackground.value=e},this.postprocess=function(e){m||(v||g?(f.uniforms.uCamDir.value=e.worldUpTransform?e.getWorldDirection().clone().applyMatrix4(e.worldUpTransform):e.getWorldDirection(),f.uniforms.uCamUp.value=e.worldUpTransform?e.up.clone().applyMatrix4(e.worldUpTransform):e.up,f.uniforms.uResolution.value.set(p,h),f.uniforms.uHalfFovTan.value=Math.tan(t.Math.degToRad(.5*e.fov)),f.render(d,this.outTarget),d.clearTarget(this.outTarget,!1,!0,!1)):(d.setClearColor(_,1),d.clearTarget(this.outTarget,!0,!0,!1)),i.render(d,this.outTarget,this.inTarget))},this.clear=function(){d.setClearColor(_,0),d.clearTarget(this.inTarget,!0,!0,!1),d.clearBlend()},this.setClearColors=function(e,t,n){t?(_.setRGB(.5*(e.x+t.x),.5*(e.y+t.y),.5*(e.z+t.z)),v=!e.equals(t)&&!n):(_.copy(e),v=!1),v&&(f.uniforms.color1.value.copy(e),f.uniforms.color2.value.copy(t))},this.setEnvRotation=function(e){f.material.envRotationSin=Math.sin(e),f.material.envRotationCos=Math.cos(e)},this.isGroundCulled=function(){return m},this.getStatus=function(){return x},this.setDirty=function(){y=!0,x=0},this.setColor=function(e){i.setColor(b.color),b.color.set(e)},this.setAlpha=function(e){i.setAlpha(b.alpha),b.alpha=e},a)for(var M in b)b[M]=void 0!==a[M]?a[M]:b[M];(o=new kl(xu)).material.blending=t.NoBlending,o.material.depthTest=!0,o.material.depthWrite=!1,o.scene.position.z=-.999999,a.clearPass?f=a.clearPass:((f=new kl(Vs)).material.blending=t.NoBlending,f.material.depthWrite=!1,f.material.depthTest=!1),this.setSize(p,h),i.setAlpha(b.color),i.setAlpha(b.alpha),s=new t.Plane(new t.Vector3(0,1,0),0),l=new t.Vector3(0,0,0)},e.PhongShader=wu,e.VertexEnumerator=Du,e.DeriveTopology=Wu,e.VBIntersector=ju,e.GeometryList=h,e.RenderBatch=_,e.InstanceBufferBuilder=$e,e.WebGLRenderer=function(e){function n(e){e.__webglVertexBuffer=Ge.createBuffer(),e.__webglColorBuffer=Ge.createBuffer(),e.__webglLineDistanceBuffer=Ge.createBuffer(),qe.info.memory.geometries++}function r(e){e.__webglVertexBuffer=Ge.createBuffer(),e.__webglColorBuffer=Ge.createBuffer(),qe.info.memory.geometries++}function a(e){e.__webglVertexBuffer=Ge.createBuffer(),e.__webglNormalBuffer=Ge.createBuffer(),e.__webglTangentBuffer=Ge.createBuffer(),e.__webglColorBuffer=Ge.createBuffer(),e.__webglUVBuffer=Ge.createBuffer(),e.__webglUV2Buffer=Ge.createBuffer(),e.__webglSkinIndicesBuffer=Ge.createBuffer(),e.__webglSkinWeightsBuffer=Ge.createBuffer(),e.__webglFaceBuffer=Ge.createBuffer(),e.__webglLineBuffer=Ge.createBuffer(),qe.info.memory.geometries++}function i(e,t){var n=e.vertices.length,r=t.material;if(r.attributes){void 0===e.__webglCustomAttributesList&&(e.__webglCustomAttributesList=[]);for(var a in r.attributes){var i=r.attributes[a];if(!i.__webglInitialized||i.createUniqueBuffers){i.__webglInitialized=!0;var o=1;"v2"===i.type?o=2:"v3"===i.type?o=3:"v4"===i.type?o=4:"c"===i.type&&(o=3),i.size=o,i.array=new Float32Array(n*o),i.buffer=Ge.createBuffer(),i.buffer.belongsToAttribute=a,i.needsUpdate=!0}e.__webglCustomAttributesList.push(i)}}}function o(e,t){var n=e.vertices.length;e.__vertexArray=new Float32Array(3*n),e.__colorArray=new Float32Array(3*n),e.__lineDistanceArray=new Float32Array(1*n),e.__webglLineCount=n,i(e,t)}function s(e,t){var n=e.vertices.length;e.__vertexArray=new Float32Array(3*n),e.__colorArray=new Float32Array(3*n),e.__webglPointCount=n,i(e,t)}function l(e,t){var n=t.geometry,r=e.faces3,a=3*r.length,i=1*r.length,o=3*r.length,s=u(t,e),l=p(s),f=d(s),h=c(s);e.__vertexArray=new Float32Array(3*a),f&&(e.__normalArray=new Float32Array(3*a)),n.hasTangents&&(e.__tangentArray=new Float32Array(4*a)),h&&(e.__colorArray=new Float32Array(3*a)),l&&(n.faceVertexUvs.length>0&&(e.__uvArray=new Float32Array(2*a)),n.faceVertexUvs.length>1&&(e.__uv2Array=new Float32Array(2*a))),t.geometry.skinWeights.length&&t.geometry.skinIndices.length&&(e.__skinIndexArray=new Float32Array(4*a),e.__skinWeightArray=new Float32Array(4*a));var m=null!==_t.get("OES_element_index_uint")&&i>21845?Uint32Array:Uint16Array;if(e.__typeArray=m,e.__faceArray=new m(3*i),e.__lineArray=new m(2*o),e.__webglFaceCount=3*i,e.__webglLineCount=2*o,s.attributes){void 0===e.__webglCustomAttributesList&&(e.__webglCustomAttributesList=[]);for(var _ in s.attributes){var v=s.attributes[_],g={};for(var y in v)g[y]=v[y];if(!g.__webglInitialized||g.createUniqueBuffers){g.__webglInitialized=!0;var x=1;"v2"===g.type?x=2:"v3"===g.type?x=3:"v4"===g.type?x=4:"c"===g.type&&(x=3),g.size=x,g.array=new Float32Array(a*x),g.buffer=Ge.createBuffer(),g.buffer.belongsToAttribute=_,v.needsUpdate=!0,g.__original=v}e.__webglCustomAttributesList.push(g)}}e.__inittedArrays=!0}function u(e,n){return e.material instanceof t.MeshFaceMaterial?e.material.materials[n.materialIndex]:e.material}function f(e){return e&&void 0!==e.shading&&e.shading===t.SmoothShading}function d(e){return!(e instanceof t.MeshBasicMaterial&&!e.envMap||e instanceof t.MeshDepthMaterial)&&(f(e)?t.SmoothShading:t.FlatShading)}function c(e){return!!e.vertexColors&&e.vertexColors}function p(e){return!!(e.map||e.lightMap||e.bumpMap||e.normalMap||e.specularMap||e.alphaMap||e instanceof t.ShaderMaterial)}function h(e,t){var n,r,a,i,o,s,l,u,f,d,c,p,h=e.vertices,m=e.colors,_=e.lineDistances,v=h.length,g=m.length,y=_.length,x=e.__vertexArray,b=e.__colorArray,w=e.__lineDistanceArray,M=e.verticesNeedUpdate,S=e.colorsNeedUpdate,T=e.lineDistancesNeedUpdate,A=e.__webglCustomAttributesList;if(M){for(n=0;n<v;n++)i=h[n],x[o=3*n]=i.x,x[o+1]=i.y,x[o+2]=i.z;Ge.bindBuffer(Ge.ARRAY_BUFFER,e.__webglVertexBuffer),Ge.bufferData(Ge.ARRAY_BUFFER,x,t)}if(S){for(r=0;r<g;r++)s=m[r],b[o=3*r]=s.r,b[o+1]=s.g,b[o+2]=s.b;Ge.bindBuffer(Ge.ARRAY_BUFFER,e.__webglColorBuffer),Ge.bufferData(Ge.ARRAY_BUFFER,b,t)}if(T){for(a=0;a<y;a++)w[a]=_[a];Ge.bindBuffer(Ge.ARRAY_BUFFER,e.__webglLineDistanceBuffer),Ge.bufferData(Ge.ARRAY_BUFFER,w,t)}if(A)for(l=0,u=A.length;l<u;l++)if((p=A[l]).needsUpdate&&(void 0===p.boundTo||"vertices"===p.boundTo)){if(o=0,d=p.value.length,1===p.size)for(f=0;f<d;f++)p.array[f]=p.value[f];else if(2===p.size)for(f=0;f<d;f++)c=p.value[f],p.array[o]=c.x,p.array[o+1]=c.y,o+=2;else if(3===p.size)if("c"===p.type)for(f=0;f<d;f++)c=p.value[f],p.array[o]=c.r,p.array[o+1]=c.g,p.array[o+2]=c.b,o+=3;else for(f=0;f<d;f++)c=p.value[f],p.array[o]=c.x,p.array[o+1]=c.y,p.array[o+2]=c.z,o+=3;else if(4===p.size)for(f=0;f<d;f++)c=p.value[f],p.array[o]=c.x,p.array[o+1]=c.y,p.array[o+2]=c.z,p.array[o+3]=c.w,o+=4;Ge.bindBuffer(Ge.ARRAY_BUFFER,p.buffer),Ge.bufferData(Ge.ARRAY_BUFFER,p.array,t)}}function m(e,t){var n,r,a,i,o,s,l,u,f,d,c,p=e.vertices,h=e.colors,m=p.length,_=h.length,v=e.__vertexArray,g=e.__colorArray,y=e.verticesNeedUpdate,x=e.colorsNeedUpdate,b=e.__webglCustomAttributesList;if(y){for(n=0;n<m;n++)a=p[n],v[i=3*n]=a.x,v[i+1]=a.y,v[i+2]=a.z;Ge.bindBuffer(Ge.ARRAY_BUFFER,e.__webglVertexBuffer),Ge.bufferData(Ge.ARRAY_BUFFER,v,t)}if(x){for(r=0;r<_;r++)o=h[r],g[i=3*r]=o.r,g[i+1]=o.g,g[i+2]=o.b;Ge.bindBuffer(Ge.ARRAY_BUFFER,e.__webglColorBuffer),Ge.bufferData(Ge.ARRAY_BUFFER,g,t)}if(b)for(s=0,l=b.length;s<l;s++)if((c=b[s]).needsUpdate&&(void 0===c.boundTo||"vertices"===c.boundTo)){if(i=0,f=c.value.length,1===c.size)for(u=0;u<f;u++)c.array[u]=c.value[u];else if(2===c.size)for(u=0;u<f;u++)d=c.value[u],c.array[i]=d.x,c.array[i+1]=d.y,i+=2;else if(3===c.size)if("c"===c.type)for(u=0;u<f;u++)d=c.value[u],c.array[i]=d.r,c.array[i+1]=d.g,c.array[i+2]=d.b,i+=3;else for(u=0;u<f;u++)d=c.value[u],c.array[i]=d.x,c.array[i+1]=d.y,c.array[i+2]=d.z,i+=3;else if(4===c.size)for(u=0;u<f;u++)d=c.value[u],c.array[i]=d.x,c.array[i+1]=d.y,c.array[i+2]=d.z,c.array[i+3]=d.w,i+=4;Ge.bindBuffer(Ge.ARRAY_BUFFER,c.buffer),Ge.bufferData(Ge.ARRAY_BUFFER,c.array,t)}}function v(e,n,r,a,i){if(e.__inittedArrays){var o,s,l,u,f,h,m,_,v,g,y,x,b,w,M,S,T,A,E,R,L,P,I,C,D,N,O,U=d(i),F=c(i),V=p(i),B=U===t.SmoothShading,z=0,G=0,k=0,H=0,W=0,q=0,j=0,X=0,Y=0,K=0,Z=e.__vertexArray,Q=e.__uvArray,J=e.__uv2Array,$=e.__normalArray,ee=e.__tangentArray,te=e.__colorArray,ne=e.__webglCustomAttributesList,re=e.__faceArray,ae=e.__lineArray,ie=n.geometry,oe=ie.verticesNeedUpdate,se=ie.elementsNeedUpdate,le=ie.uvsNeedUpdate,ue=ie.normalsNeedUpdate,fe=ie.tangentsNeedUpdate,de=ie.colorsNeedUpdate,ce=ie.vertices,pe=e.faces3,he=ie.faces,me=ie.faceVertexUvs[0],_e=ie.faceVertexUvs[1];if(oe){for(o=0,s=pe.length;o<s;o++)x=ce[(u=he[pe[o]]).a],b=ce[u.b],w=ce[u.c],Z[G]=x.x,Z[G+1]=x.y,Z[G+2]=x.z,Z[G+3]=b.x,Z[G+4]=b.y,Z[G+5]=b.z,Z[G+6]=w.x,Z[G+7]=w.y,Z[G+8]=w.z,G+=9;Ge.bindBuffer(Ge.ARRAY_BUFFER,e.__webglVertexBuffer),Ge.bufferData(Ge.ARRAY_BUFFER,Z,r)}if(de&&F){for(o=0,s=pe.length;o<s;o++)m=(u=he[pe[o]]).vertexColors,_=u.color,3===m.length&&F===t.VertexColors?(A=m[0],E=m[1],R=m[2]):(A=_,E=_,R=_),te[Y]=A.r,te[Y+1]=A.g,te[Y+2]=A.b,te[Y+3]=E.r,te[Y+4]=E.g,te[Y+5]=E.b,te[Y+6]=R.r,te[Y+7]=R.g,te[Y+8]=R.b,Y+=9;Y>0&&(Ge.bindBuffer(Ge.ARRAY_BUFFER,e.__webglColorBuffer),Ge.bufferData(Ge.ARRAY_BUFFER,te,r))}if(fe&&ie.hasTangents){for(o=0,s=pe.length;o<s;o++)M=(v=(u=he[pe[o]]).vertexTangents)[0],S=v[1],T=v[2],ee[j]=M.x,ee[j+1]=M.y,ee[j+2]=M.z,ee[j+3]=M.w,ee[j+4]=S.x,ee[j+5]=S.y,ee[j+6]=S.z,ee[j+7]=S.w,ee[j+8]=T.x,ee[j+9]=T.y,ee[j+10]=T.z,ee[j+11]=T.w,j+=12;Ge.bindBuffer(Ge.ARRAY_BUFFER,e.__webglTangentBuffer),Ge.bufferData(Ge.ARRAY_BUFFER,ee,r)}if(ue&&U){for(o=0,s=pe.length;o<s;o++)if(u=he[pe[o]],f=u.vertexNormals,h=u.normal,3===f.length&&B)for(L=0;L<3;L++)I=f[L],$[q]=I.x,$[q+1]=I.y,$[q+2]=I.z,q+=3;else for(L=0;L<3;L++)$[q]=h.x,$[q+1]=h.y,$[q+2]=h.z,q+=3;Ge.bindBuffer(Ge.ARRAY_BUFFER,e.__webglNormalBuffer),Ge.bufferData(Ge.ARRAY_BUFFER,$,r)}if(le&&me&&V){for(o=0,s=pe.length;o<s;o++)if(l=pe[o],void 0!==(g=me[l]))for(L=0;L<3;L++)C=g[L],Q[k]=C.x,Q[k+1]=C.y,k+=2;k>0&&(Ge.bindBuffer(Ge.ARRAY_BUFFER,e.__webglUVBuffer),Ge.bufferData(Ge.ARRAY_BUFFER,Q,r))}if(le&&_e&&V){for(o=0,s=pe.length;o<s;o++)if(l=pe[o],void 0!==(y=_e[l]))for(L=0;L<3;L++)D=y[L],J[H]=D.x,J[H+1]=D.y,H+=2;H>0&&(Ge.bindBuffer(Ge.ARRAY_BUFFER,e.__webglUV2Buffer),Ge.bufferData(Ge.ARRAY_BUFFER,J,r))}if(se){for(o=0,s=pe.length;o<s;o++)re[W]=z,re[W+1]=z+1,re[W+2]=z+2,W+=3,ae[X]=z,ae[X+1]=z+1,ae[X+2]=z,ae[X+3]=z+2,ae[X+4]=z+1,ae[X+5]=z+2,X+=6,z+=3;Ge.bindBuffer(Ge.ELEMENT_ARRAY_BUFFER,e.__webglFaceBuffer),Ge.bufferData(Ge.ELEMENT_ARRAY_BUFFER,re,r),Ge.bindBuffer(Ge.ELEMENT_ARRAY_BUFFER,e.__webglLineBuffer),Ge.bufferData(Ge.ELEMENT_ARRAY_BUFFER,ae,r)}if(ne)for(L=0,P=ne.length;L<P;L++)if((O=ne[L]).__original.needsUpdate){if(K=0,1===O.size){if(void 0===O.boundTo||"vertices"===O.boundTo)for(o=0,s=pe.length;o<s;o++)u=he[pe[o]],O.array[K]=O.value[u.a],O.array[K+1]=O.value[u.b],O.array[K+2]=O.value[u.c],K+=3;else if("faces"===O.boundTo)for(o=0,s=pe.length;o<s;o++)N=O.value[pe[o]],O.array[K]=N,O.array[K+1]=N,O.array[K+2]=N,K+=3}else if(2===O.size){if(void 0===O.boundTo||"vertices"===O.boundTo)for(o=0,s=pe.length;o<s;o++)u=he[pe[o]],x=O.value[u.a],b=O.value[u.b],w=O.value[u.c],O.array[K]=x.x,O.array[K+1]=x.y,O.array[K+2]=b.x,O.array[K+3]=b.y,O.array[K+4]=w.x,O.array[K+5]=w.y,K+=6;else if("faces"===O.boundTo)for(o=0,s=pe.length;o<s;o++)x=N=O.value[pe[o]],b=N,w=N,O.array[K]=x.x,O.array[K+1]=x.y,O.array[K+2]=b.x,O.array[K+3]=b.y,O.array[K+4]=w.x,O.array[K+5]=w.y,K+=6}else if(3===O.size){var ve;if(ve="c"===O.type?["r","g","b"]:["x","y","z"],void 0===O.boundTo||"vertices"===O.boundTo)for(o=0,s=pe.length;o<s;o++)u=he[pe[o]],x=O.value[u.a],b=O.value[u.b],w=O.value[u.c],O.array[K]=x[ve[0]],O.array[K+1]=x[ve[1]],O.array[K+2]=x[ve[2]],O.array[K+3]=b[ve[0]],O.array[K+4]=b[ve[1]],O.array[K+5]=b[ve[2]],O.array[K+6]=w[ve[0]],O.array[K+7]=w[ve[1]],O.array[K+8]=w[ve[2]],K+=9;else if("faces"===O.boundTo)for(o=0,s=pe.length;o<s;o++)x=N=O.value[pe[o]],b=N,w=N,O.array[K]=x[ve[0]],O.array[K+1]=x[ve[1]],O.array[K+2]=x[ve[2]],O.array[K+3]=b[ve[0]],O.array[K+4]=b[ve[1]],O.array[K+5]=b[ve[2]],O.array[K+6]=w[ve[0]],O.array[K+7]=w[ve[1]],O.array[K+8]=w[ve[2]],K+=9;else if("faceVertices"===O.boundTo)for(o=0,s=pe.length;o<s;o++)x=(N=O.value[pe[o]])[0],b=N[1],w=N[2],O.array[K]=x[ve[0]],O.array[K+1]=x[ve[1]],O.array[K+2]=x[ve[2]],O.array[K+3]=b[ve[0]],O.array[K+4]=b[ve[1]],O.array[K+5]=b[ve[2]],O.array[K+6]=w[ve[0]],O.array[K+7]=w[ve[1]],O.array[K+8]=w[ve[2]],K+=9}else if(4===O.size)if(void 0===O.boundTo||"vertices"===O.boundTo)for(o=0,s=pe.length;o<s;o++)u=he[pe[o]],x=O.value[u.a],b=O.value[u.b],w=O.value[u.c],O.array[K]=x.x,O.array[K+1]=x.y,O.array[K+2]=x.z,O.array[K+3]=x.w,O.array[K+4]=b.x,O.array[K+5]=b.y,O.array[K+6]=b.z,O.array[K+7]=b.w,O.array[K+8]=w.x,O.array[K+9]=w.y,O.array[K+10]=w.z,O.array[K+11]=w.w,K+=12;else if("faces"===O.boundTo)for(o=0,s=pe.length;o<s;o++)x=N=O.value[pe[o]],b=N,w=N,O.array[K]=x.x,O.array[K+1]=x.y,O.array[K+2]=x.z,O.array[K+3]=x.w,O.array[K+4]=b.x,O.array[K+5]=b.y,O.array[K+6]=b.z,O.array[K+7]=b.w,O.array[K+8]=w.x,O.array[K+9]=w.y,O.array[K+10]=w.z,O.array[K+11]=w.w,K+=12;else if("faceVertices"===O.boundTo)for(o=0,s=pe.length;o<s;o++)x=(N=O.value[pe[o]])[0],b=N[1],w=N[2],O.array[K]=x.x,O.array[K+1]=x.y,O.array[K+2]=x.z,O.array[K+3]=x.w,O.array[K+4]=b.x,O.array[K+5]=b.y,O.array[K+6]=b.z,O.array[K+7]=b.w,O.array[K+8]=w.x,O.array[K+9]=w.y,O.array[K+10]=w.z,O.array[K+11]=w.w,K+=12;Ge.bindBuffer(Ge.ARRAY_BUFFER,O.buffer),Ge.bufferData(Ge.ARRAY_BUFFER,O.array,r)}a&&(delete e.__inittedArrays,delete e.__colorArray,delete e.__normalArray,delete e.__tangentArray,delete e.__uvArray,delete e.__uv2Array,delete e.__faceArray,delete e.__vertexArray,delete e.__lineArray,delete e.__skinIndexArray,delete e.__skinWeightArray)}}function g(e){if(e.streamingDraw){if(!e.streamingIndex){var t=e.attributes.index;t&&(t.buffer=Ge.createBuffer(),Ge.bindBuffer(Ge.ELEMENT_ARRAY_BUFFER,t.buffer),Ge.bufferData(Ge.ELEMENT_ARRAY_BUFFER,t.array||e.ib,Ge.STATIC_DRAW))}}else{e.vb&&void 0===e.vbbuffer&&(e.vbbuffer=Ge.createBuffer(),e.vbNeedsUpdate=!0),e.ib&&void 0===e.ibbuffer&&(e.ibbuffer=Ge.createBuffer(),Ge.bindBuffer(Ge.ELEMENT_ARRAY_BUFFER,e.ibbuffer),Ge.bufferData(Ge.ELEMENT_ARRAY_BUFFER,e.ib,Ge.STATIC_DRAW)),e.iblines&&void 0===e.iblinesbuffer&&(e.iblinesbuffer=Ge.createBuffer(),Ge.bindBuffer(Ge.ELEMENT_ARRAY_BUFFER,e.iblinesbuffer),Ge.bufferData(Ge.ELEMENT_ARRAY_BUFFER,e.iblines,Ge.STATIC_DRAW));for(var n=e.attributes,r=e.attributesKeys,a=0,i=r.length;a<i;a++){var o=r[a],s=n[o],l="index"===o;if(s.array&&void 0===s.buffer&&(s.buffer=Ge.createBuffer(),s.needsUpdate=!0),!0===s.needsUpdate){var u=l?Ge.ELEMENT_ARRAY_BUFFER:Ge.ARRAY_BUFFER;Ge.bindBuffer(u,s.buffer),Ge.bufferData(u,s.array,Ge.STATIC_DRAW),s.needsUpdate=!1}}e.vbNeedsUpdate&&(Ge.bindBuffer(Ge.ARRAY_BUFFER,e.vbbuffer),Ge.bufferData(Ge.ARRAY_BUFFER,e.vb,Ge.STATIC_DRAW),e.vbNeedsUpdate=!1,e.discardAfterUpload&&(e.vb=null))}}function y(e,t,n,r){var a;if(n.streamingDraw)return n.vaos=null,!1;if(n.offsets&&n.offsets.length>1)return n.vaos=null,!1;if(!We)return n.vaos=null,!1;if(void 0===n.vaos&&(n.vaos=[]),a=We.createVertexArrayOES(),n.vaos.push({geomhash:t.id,uv:r,vao:a}),We.bindVertexArrayOES(a),e.isEdgeMaterial)Ge.bindBuffer(Ge.ELEMENT_ARRAY_BUFFER,n.iblinesbuffer);else{var i=n.attributes.index;i&&Ge.bindBuffer(Ge.ELEMENT_ARRAY_BUFFER,n.ibbuffer||i.buffer)}for(var o=null,s=t.attributes,l=t.attributesKeys,u=n.vbstride,f=n.offsets&&n.offsets.length?n.offsets[0].index:0,d=0,c=l.length;d<c;d++){var p=l[d],h=s[p];if(h>=0){var m=n.attributes[p];if("uv"===p&&r&&(m=n.attributes["uv"+(r+1)]),!m){We.bindVertexArrayOES(null);for(var _=0;_<n.vaos.length;_++)We.deleteVertexArrayOES(n.vaos[_].vao);return n.vaos=null,!1}var v=Ge.FLOAT,g=m.bytesPerItem||4;1===g?v=Ge.UNSIGNED_BYTE:2===g&&(v=Ge.UNSIGNED_SHORT),Ge.enableVertexAttribArray(h),void 0!==m.itemOffset?(o!=n.vbbuffer&&(Ge.bindBuffer(Ge.ARRAY_BUFFER,n.vbbuffer),o=n.vbbuffer),Ge.vertexAttribPointer(h,m.itemSize,v,!!m.normalize,4*u,4*(m.itemOffset+f*u))):(Ge.bindBuffer(Ge.ARRAY_BUFFER,m.buffer),o=m.buffer,Ge.vertexAttribPointer(h,m.itemSize,v,!!m.normalize,0,f*m.itemSize*g)),He&&He.vertexAttribDivisorANGLE(h,n.numInstances?m.divisor||0:0)}}return!0}function x(e,t,n,r){var a=n.vaos;if(a)for(var i=0,o=a.length;i<o;i++){var s=a[i];if(s.geomhash===t.id&&s.uv===r)return We.bindVertexArrayOES(s.vao),!0}else if(null===a)return!1;return y(e,t,n,r)}function b(e,t){var n=ot[e];return n||(n=Ge.createBuffer(),ot[e]=n),Ge.bindBuffer(Ge.ARRAY_BUFFER,n),Ge.bufferData(Ge.ARRAY_BUFFER,t,Ge.DYNAMIC_DRAW),n}function w(e,t,n,r,a,i){var o,s=t.attributes,l=t.attributesKeys,u=0;if(a)if(!a.buffer&&n.streamingDraw){var f=ot.index;f||(f=Ge.createBuffer(),ot.index=f),Ge.bindBuffer(Ge.ELEMENT_ARRAY_BUFFER,f),e.isEdgeMaterial?Ge.bufferData(Ge.ELEMENT_ARRAY_BUFFER,n.iblines,Ge.DYNAMIC_DRAW):Ge.bufferData(Ge.ELEMENT_ARRAY_BUFFER,a.array||n.ib,Ge.DYNAMIC_DRAW)}else e.isEdgeMaterial?Ge.bindBuffer(Ge.ELEMENT_ARRAY_BUFFER,n.iblinesbuffer):Ge.bindBuffer(Ge.ELEMENT_ARRAY_BUFFER,n.ibbuffer||a.buffer);for(var d=0,c=l.length;d<c;d++){var p=l[d],h=s[p];if(h>=0){var m=n.attributes[p];if("uv"===p&&i&&(m=n.attributes["uv"+(i+1)]),m){var _,v,g=void 0!==m.itemOffset;g?(_=n.vbstride,v=m.itemOffset,u!==o&&(n.streamingDraw?u=b("interleavedVB",n.vb):(u=n.vbbuffer,Ge.bindBuffer(Ge.ARRAY_BUFFER,u)),o=u)):(_=m.itemSize,v=0,n.streamingDraw?u=b(p,m.array):(u=m.buffer,Ge.bindBuffer(Ge.ARRAY_BUFFER,u)));var y=Ge.FLOAT,x=m.bytesPerItem||4;1===x?y=Ge.UNSIGNED_BYTE:2===x&&(y=Ge.UNSIGNED_SHORT),g&&(x=4),mt.enableAttribute(h),Ge.vertexAttribPointer(h,m.itemSize,y,m.normalize,_*x,(v+r*_)*x),He&&He.vertexAttribDivisorANGLE(h,n.numInstances?m.divisor||0:0)}else if(e.defaultAttributeValues){var w=e.defaultAttributeValues[p];w&&2===w.length?Ge.vertexAttrib2fv(h,e.defaultAttributeValues[p]):w&&3===w.length?Ge.vertexAttrib3fv(h,e.defaultAttributeValues[p]):w&&4===w.length&&Ge.vertexAttrib4fv(h,e.defaultAttributeValues[p])}}}mt.disableUnusedAttributes()}function M(e,t){return e.object.renderOrder!==t.object.renderOrder?e.object.renderOrder-t.object.renderOrder:e.z!==t.z?e.z-t.z:e.id-t.id}function S(e,t){return e.object.renderOrder!==t.object.renderOrder?e.object.renderOrder-t.object.renderOrder:e.material.id!==t.material.id?e.material.id-t.material.id:e.z!==t.z?t.z-e.z:e.id-t.id}function T(e){E(e,!0)}function A(e){E(e,!1)}function E(e,n,r){var a,i;if(r||!1!==e.visible){if(e instanceof t.Scene||e instanceof t.Group);else if(e instanceof _)e.forEach(n?T:A);else if(O(e),e instanceof t.Light)Ne.push(e);else{var o=Oe[e.id];if(o&&(!1===e.frustumCulled||!0===st.intersectsObject(e)))for(a=0,i=o.length;a<i;a++){var s=o[a];N(s),s.render=!0,!0===n&&(ft.setFromMatrixPosition(e.matrixWorld),ft.applyProjection(lt),s.z=ft.z)}}if(e.children)for(a=0,i=e.children.length;a<i;a++)E(e.children[a],n,r)}}function R(e,t){if(!t.getCustomOverrideMaterial)return t;var n=t.getCustomOverrideMaterial(e);return n||t}function L(e,n,r,a,i){for(var o,s=0,l=e.length;s<l;s++){var u=e[s],f=u.object,d=u.buffer;if(i)o=R(u.material,i);else{if(!(o=u.material))continue;X(o)}if(o.twoPassTransparency){var c=o.side;o.side=t.BackSide,P(o,n,r,a,d,0,f),o.side=t.FrontSide,P(o,n,r,a,d,0,f),o.side=c}else P(o,n,r,a,d,0,f)}}function P(e,n,r,a,i,o,s){if(qe.setMaterialFaces(e),i instanceof t.BufferGeometry?qe.renderBufferDirect(n,r,a,e,i,s):qe.renderBuffer(n,r,a,e,i,s),e.decals)for(var l=e.decals,u=0,f=l.length;u<f;u++){var d=l[u];X(e=d.material),qe.setMaterialFaces(e),i instanceof t.BufferGeometry&&qe.renderBufferDirect(n,r,a,e,i,s,d.uv)}}function I(e,n){if(e.visible&&!e.hide){var r;if(Kt)r=R(e.material,Kt);else{if(!(r=e.material))return;X(r)}if(r.twoPassTransparency){var a=r.side;r.side=t.BackSide,C(e,r),r.side=t.FrontSide,C(e,r),r.side=a}else C(e,r)}}function C(e,t){if(qe.setMaterialFaces(t),qe.renderBufferDirect(jt,Xt,Yt,t,e.geometry,e),t.decals)for(var n=t.decals,r=0,a=n.length;r<a;r++){var i=n[r];X(t=i.material),qe.setMaterialFaces(t),qe.renderBufferDirect(jt,Xt,Yt,t,e.geometry,e,i.uv)}}function D(e,t,n,r,a,i){jt=n,Xt=r,Yt=a,Kt=i||null,e.forEach(I,e.forceVisible?1:128,!1)}function N(e){var n=e.object,r=e.buffer,a=n.geometry,i=n.material;if(i instanceof t.MeshFaceMaterial){var o=a instanceof t.BufferGeometry?0:r.materialIndex;i=i.materials[o],e.material=i,i.transparent?ze.push(e):Be.push(e)}else i&&(e.material=i,i.transparent?ze.push(e):Be.push(e))}function O(e){void 0===e.__webglInit&&(e.__webglInit=!0,e.addEventListener("removed",Ut));var a=e.geometry;if(void 0===a||void 0===a.__webglInit&&(a.__webglInit=!0,a.addEventListener("dispose",Ft),a instanceof t.BufferGeometry||(e instanceof t.Mesh?F(e,a):e instanceof t.Line?void 0===a.__webglVertexBuffer&&(n(a),o(a,e),a.verticesNeedUpdate=!0,a.colorsNeedUpdate=!0,a.lineDistancesNeedUpdate=!0):e instanceof t.PointCloud&&void 0===a.__webglVertexBuffer&&(r(a),s(a,e),a.verticesNeedUpdate=!0,a.colorsNeedUpdate=!0))),void 0===e.__webglActive)if(e.__webglActive=!0,e instanceof t.Mesh){if(a instanceof t.BufferGeometry)V(Oe,a,e);else if(a instanceof t.Geometry)for(var i=Zt[a.id],l=0,u=i.length;l<u;l++)V(Oe,i[l],e)}else e instanceof t.Line||e instanceof t.PointCloud?V(Oe,a,e):(e instanceof t.ImmediateRenderObject||e.immediateRenderCallback)&&B(Ue,e)}function U(e,t){for(var n,r,a=_t.get("OES_element_index_uint")?4294967296:65535,i={},o=e.morphTargets?e.morphTargets.length:0,s=e.morphNormals?e.morphNormals.length:0,l={},u=[],f=0,d=e.faces.length;f<d;f++){var c=e.faces[f],p=t?c.materialIndex:0;p in i||(i[p]={hash:p,counter:0}),(n=i[p].hash+"_"+i[p].counter)in l||(r={id:Qt++,faces3:[],materialIndex:p,vertices:0,numMorphTargets:o,numMorphNormals:s},l[n]=r,u.push(r)),l[n].vertices+3>a&&(i[p].counter+=1,(n=i[p].hash+"_"+i[p].counter)in l||(r={id:Qt++,faces3:[],materialIndex:p,vertices:0,numMorphTargets:o,numMorphNormals:s},l[n]=r,u.push(r))),l[n].faces3.push(f),l[n].vertices+=3}return u}function F(e,n){var r=e.material,i=!1;void 0!==Zt[n.id]&&!0!==n.groupsNeedUpdate||(delete Oe[e.id],Zt[n.id]=U(n,r instanceof t.MeshFaceMaterial),n.groupsNeedUpdate=!1);for(var o=Zt[n.id],s=0,u=o.length;s<u;s++){var f=o[s];void 0===f.__webglVertexBuffer?(a(f),l(f,e),n.verticesNeedUpdate=!0,n.morphTargetsNeedUpdate=!0,n.elementsNeedUpdate=!0,n.uvsNeedUpdate=!0,n.normalsNeedUpdate=!0,n.tangentsNeedUpdate=!0,n.colorsNeedUpdate=!0,i=!0):i=!1,(i||void 0===e.__webglActive)&&V(Oe,f,e)}e.__webglActive=!0}function V(e,t,n){var r=n.id;e[r]=e[r]||[],e[r].push({id:r,buffer:t,object:n,material:null,z:0})}function B(e,t){e.push({id:null,object:t,opaque:null,transparent:null,z:0})}function z(e){var n,r,a=e.geometry;if(a instanceof t.BufferGeometry)g(a);else if(e instanceof t.Mesh){!0===a.groupsNeedUpdate&&F(e,a);for(var i=Zt[a.id],o=0,s=i.length;o<s;o++){var l=i[o];n=(r=u(e,l)).attributes&&G(r),(a.verticesNeedUpdate||a.morphTargetsNeedUpdate||a.elementsNeedUpdate||a.uvsNeedUpdate||a.normalsNeedUpdate||a.colorsNeedUpdate||a.tangentsNeedUpdate||n)&&v(l,e,Ge.DYNAMIC_DRAW,!a.dynamic,r)}a.verticesNeedUpdate=!1,a.morphTargetsNeedUpdate=!1,a.elementsNeedUpdate=!1,a.uvsNeedUpdate=!1,a.normalsNeedUpdate=!1,a.colorsNeedUpdate=!1,a.tangentsNeedUpdate=!1,r.attributes&&k(r)}else e instanceof t.Line?(n=(r=u(e,a)).attributes&&G(r),(a.verticesNeedUpdate||a.colorsNeedUpdate||a.lineDistancesNeedUpdate||n)&&h(a,Ge.DYNAMIC_DRAW),a.verticesNeedUpdate=!1,a.colorsNeedUpdate=!1,a.lineDistancesNeedUpdate=!1,r.attributes&&k(r)):e instanceof t.PointCloud&&(n=(r=u(e,a)).attributes&&G(r),(a.verticesNeedUpdate||a.colorsNeedUpdate||n)&&m(a,Ge.DYNAMIC_DRAW),a.verticesNeedUpdate=!1,a.colorsNeedUpdate=!1,r.attributes&&k(r))}function G(e){for(var t in e.attributes)if(e.attributes[t].needsUpdate)return!0;return!1}function k(e){for(var t in e.attributes)e.attributes[t].needsUpdate=!1}function H(e){e instanceof t.Mesh||e instanceof t.PointCloud||e instanceof t.Line?delete Oe[e.id]:(e instanceof t.ImmediateRenderObject||e.immediateRenderCallback)&&W(Ue,e),delete e.__webglInit,delete e.__webglActive}function W(e,t){for(var n=e.length-1;n>=0;n--)e[n].object===t&&e.splice(n,1)}function q(e,t){if(t.textureMaps)for(var n=0;n<kf.PrismMaps.length;n++){var r=kf.PrismMaps[n],a=t.textureMaps[r+"_map"];if(a){var i=a.textureObj.properties.booleans;e[r]={S:!i.texture_URepeat.values[0],T:!i.texture_VRepeat.values[0]}}}}function j(e,n,r,a){e.addEventListener("dispose",zt);var i=Jt[e.type];if(i){var o=t.ShaderLib[i];e.__webglShader={uniforms:t.UniformsUtils.clone(o.uniforms),vertexShader:o.vertexShader,fragmentShader:o.fragmentShader}}else e.__webglShader={uniforms:e.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader};var s=ye(n),l={precision:we,precisionFragment:Me,supportsVertexTextures:St,haveTextureLod:!!_t.get("EXT_shader_texture_lod"),map:!!e.map,envMap:!!e.envMap,irradianceMap:!!e.irradianceMap,envIsSpherical:e.envMap&&e.envMap.mapping==t.SphericalReflectionMapping,envGammaEncoded:e.envMap&&e.envMap.GammaEncoded,irrGammaEncoded:e.irradianceMap&&e.irradianceMap.GammaEncoded,envRGBM:e.envMap&&e.envMap.RGBM,irrRGBM:e.irradianceMap&&e.irradianceMap.RGBM,lightMap:!!e.lightMap,bumpMap:_t.get("OES_standard_derivatives")&&!!e.bumpMap,normalMap:_t.get("OES_standard_derivatives")&&!!e.normalMap,specularMap:!!e.specularMap,alphaMap:!!e.alphaMap,vertexColors:e.vertexColors,vertexIds:e.vertexIds,useInstancing:e.useInstancing,wideLines:e.wideLines,fog:r,useFog:e.fog,fogExp:r instanceof t.FogExp2,sizeAttenuation:e.sizeAttenuation,logarithmicDepthBuffer:Le,maxDirLights:s.directional,maxPointLights:s.point,maxSpotLights:s.spot,maxHemiLights:s.hemi,alphaTest:e.alphaTest,metal:e.metal,clearcoat:e.clearcoat,wrapAround:e.wrapAround,doubleSided:e.side===t.DoubleSide,flipSided:e.side===t.BackSide,mrtNormals:e.mrtNormals,mrtIdBuffer:e.mrtIdBuffer,vertexPrefix:$e,fragmentPrefix:et,tonemapOutput:e.tonemapOutput,packedNormals:e.packedNormals,hatchPattern:!!e.hatchParams,numCutplanes:e.cutplanes?e.cutplanes.length:0,useTiling:e.useTiling,tilingRepeatRange:e.useTiling&&e.tilingRepeatRange,hasRoundCorner:e.hasRoundCorner,useRandomOffset:e.useRandomOffset,mapInvert:e.map&&e.map.invert,mapClampS:e.map&&e.map.clampS,mapClampT:e.map&&e.map.clampT,bumpMapClampS:e.bumpMap&&e.bumpMap.clampS,bumpMapClampT:e.bumpMap&&e.bumpMap.clampT,normalMapClampS:e.normalMap&&e.normalMap.clampS,normalMapClampT:e.normalMap&&e.normalMap.clampT,specularMapClampS:e.specularMap&&e.specularMap.clampS,specularMapClampT:e.specularMap&&e.specularMap.clampT,alphaMapInvert:e.alphaMap&&e.alphaMap.invert,alphaMapClampS:e.alphaMap&&e.alphaMap.clampS,alphaMapClampT:e.alphaMap&&e.alphaMap.clampT};e.isPrismMaterial&&(q(l,e),l.isPrism=!0);var u=[];i?u.push(i):(u.push(e.fragmentShader),u.push(e.vertexShader));for(var f in e.defines)u.push(f),u.push(e.defines[f]);var d,c;for(d in l)u.push(d),u.push(l[d]);var p,h=u.join();for(d=0,c=je.length;d<c;d++){var m=je[d];if(m.code===h){(p=m).usedTimes++;break}}void 0===p&&(p=new kf.WebGLProgram(qe,h,e,l),je.push(p),qe.info.memory.programs=je.length),e.programs||(e.programs=[]),e.programs[Je]=p,e.uniformsLists||(e.uniformsLists=[]),e.uniformsList=e.uniformsLists[Je]=[];for(var _ in e.__webglShader.uniforms){var v=p.uniforms[_];v&&e.uniformsList.push([e.__webglShader.uniforms[_],v])}}function X(e){!0===e.transparent?mt.setBlending(e.blending,e.blendEquation,e.blendSrc,e.blendDst,e.blendEquationAlpha,e.blendSrcAlpha,e.blendDstAlpha):mt.setBlending(t.NoBlending),mt.setDepthTest(e.depthTest),mt.setDepthWrite(e.depthWrite),mt.setPolygonOffset(e.polygonOffset,e.polygonOffsetFactor,e.polygonOffsetUnits)}function Y(e,n,r,a,i){tt=0,a.needsUpdate?(a.program&&qt(a),j(a,n,r,i),a.needsUpdate=!1):a.programs[Je]||j(a,n,r,i);var o=!1,s=!1,l=!1;a.uniformsList=a.uniformsLists[Je];var u=a.program=a.programs[Je],f=u.uniforms,d=a.__webglShader.uniforms;if(u.id!==Xe&&(Ge.useProgram(u.program),Xe=u.id,o=!0,s=!0,l=!0),a.id!==Ke&&(-1===Ke&&(l=!0),Ke=a.id,s=!0),(o||e!==Ze)&&(Ge.uniformMatrix4fv(f.projectionMatrix,!1,e.projectionMatrix.elements),Le&&Ge.uniform1f(f.logDepthBufFC,2/(Math.log(e.far+1)/Math.LN2)),e!==Ze&&(Ze=e),(a instanceof t.ShaderMaterial||a instanceof t.MeshPhongMaterial||a.isPrismMaterial||a.envMap)&&null!==f.cameraPosition&&(ft.setFromMatrixPosition(e.matrixWorld),Ge.uniform3f(f.cameraPosition,ft.x,ft.y,ft.z)),(a instanceof t.MeshPhongMaterial||a instanceof t.MeshLambertMaterial||a instanceof t.ShaderMaterial||a.isPrismMaterial||a.skinning)&&(null!==f.viewMatrix&&Ge.uniformMatrix4fv(f.viewMatrix,!1,e.matrixWorldInverse.elements),null!==f.viewMatrixInverse&&Ge.uniformMatrix4fv(f.viewMatrixInverse,!1,ut.elements),f.mvpMatrix&&Ge.uniformMatrix4fv(f.mvpMatrix,!1,lt.elements),l?(ee(d,a),te(d,!0)):te(d,!1))),s){r&&a.fog&&$(d,r),(a instanceof t.MeshPhongMaterial||a instanceof t.MeshLambertMaterial||a.isPrismMaterial||a.lights)&&(ct&&(l=!0,de(n),ct=!1),l?(ie(d,pt),oe(d,!0)):oe(d,!1)),(a instanceof t.MeshBasicMaterial||a instanceof t.MeshLambertMaterial||a instanceof t.MeshPhongMaterial)&&(K(d,a),ee(d,a)),a instanceof t.PointCloudMaterial?Z(d,a):a instanceof t.LineBasicMaterial?Q(d,a):a instanceof t.LineDashedMaterial?(Q(d,a),J(d,a)):a instanceof t.MeshPhongMaterial?ne(d,a):a instanceof t.MeshLambertMaterial?ae(d,a):a instanceof t.MeshDepthMaterial?(d.mNear.value=e.near,d.mFar.value=e.far,d.opacity.value=a.opacity):a instanceof t.MeshNormalMaterial?d.opacity.value=a.opacity:a.isPrismMaterial&&(re(d,a),ee(d,a)),a.wideLines&&(d.view_size.value=new t.Vector2(window.innerWidth,window.innerHeight)),id.ShadowRender&&a.shadowMap&&id.ShadowRender.RefreshUniformsShadow(d,a);var c=d.cutplanes;a.cutplanes&&a.cutplanes.length>0&&c&&(c.value=a.cutplanes,c._array&&c._array.length!=4*a.cutplanes&&(c._array=void 0)),a.hatchParams&&d.hatchParams&&(d.hatchParams.value.copy(a.hatchParams),d.hatchTintColor.value.copy(a.hatchTintColor),d.hatchTintIntensity.value=a.hatchTintIntensity),ue(a.uniformsList)}se(f,i,e),null!==f.modelMatrix&&Ge.uniformMatrix4fv(f.modelMatrix,!1,i.matrixWorld.elements);var p;if(f.modelId){f.dbId&&(p=i.dbId||i.fragId||0,Ge.uniform3f(f.dbId,(255&p)/255,(p>>8&255)/255,(p>>16&255)/255));var h=i.modelId;Ge.uniform3f(f.modelId,(255&h)/255,(h>>8&255)/255,(p>>24&255)/255)}else null!==f.dbId&&(p=!Pe&&i.dbId||i.fragId||0,Ge.uniform3f(f.dbId,(255&p)/255,(p>>8&255)/255,(p>>16&255)/255));if(f.themingColor){var m=i.themingColor;m instanceof t.Vector4?Ge.uniform4f(f.themingColor,m.x,m.y,m.z,m.w):Ge.uniform4f(f.themingColor,0,0,0,0)}return u}function K(e,t){function n(e,t,n){var r=n.offset,a=n.repeat;if(t){var i=t.value;n.matrix?i.copy(n.matrix):i.identity(),i.elements[6]+=r.x,i.elements[7]+=r.y,i.elements[0]*=a.x,i.elements[3]*=a.x,i.elements[1]*=a.y,i.elements[4]*=a.y}else e.offsetRepeat.value.set(r.x,r.y,a.x,a.y)}e.opacity.value=t.opacity,e.diffuse.value.copy(t.color),e.map.value=t.map,e.lightMap.value=t.lightMap,e.specularMap.value=t.specularMap,e.alphaMap.value=t.alphaMap,t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale)),t.alphaMap&&n(e,e.texMatrixAlpha,t.alphaMap);var r;t.normalMap?r=t.normalMap:t.bumpMap&&(r=t.bumpMap),void 0!==r&&n(e,e.texMatrixBump,r);var a;t.map?a=t.map:t.specularMap&&(a=t.specularMap),void 0!==a&&n(e,e.texMatrix,a),e.envMap.value=t.envMap,e.irradianceMap&&(e.irradianceMap.value=t.irradianceMap),e.reflectivity.value=t.reflectivity,e.refractionRatio.value=t.refractionRatio}function Z(e,t){Q(e,t),e.point_size.value=t.size}function Q(e,t){e.diffuse.value=t.color,e.opacity.value=t.opacity}function J(e,t){e.dashSize.value=t.dashSize,e.totalSize.value=t.dashSize+t.gapSize,e.scale.value=t.scale}function $(e,n){e.fogColor.value=n.color,n instanceof t.Fog?(e.fogNear.value=n.near,e.fogFar.value=n.far):n instanceof t.FogExp2&&(e.fogDensity.value=n.density)}function ee(e,t){e.envMap&&(e.envMap.value=t.envMap),e.irradianceMap&&(e.irradianceMap.value=t.irradianceMap),e.envMapExposure&&(e.envMapExposure.value=t.envMapExposure),e.envRotationSin&&e.envRotationCos&&(e.envRotationSin.value=t.envRotationSin,e.envRotationCos.value=t.envRotationCos)}function te(e,t){e.envMap&&(e.envMap.needsUpdate=t),e.irradianceMap&&(e.irradianceMap.needsUpdate=t),e.envMapExposure&&(e.envMapExposure.needsUpdate=t)}function ne(e,t){if(e.shininess.value=t.shininess,e.reflMipIndex){var n=Math.log(Math.max(1+1e-10,t.shininess));e.reflMipIndex.value=Math.max(0,-.72134752*n+5.5)}e.emissive&&e.emissive.value.copy(t.emissive),e.specular.value.copy(t.specular),e.exposureBias&&(e.exposureBias.value=t.exposureBias)}function re(e,n){function r(e,t,n){e[n].value=t[n],null!=t[n]&&(e[n+"_texMatrix"].value=t[n].matrix,e[n+"_invert"].value=t[n].invert)}function a(e,t,n){e[n].value=t[n],null!=t[n]&&(e[n+"_texMatrix"].value=t[n].matrix,e[n+"_bumpScale"].value=t[n].bumpScale,e[n+"_bumpmapType"].value=t[n].bumpmapType)}switch(e.exposureBias.value=n.exposureBias,e.opacity.value=n.opacity,e.surface_albedo.value=n.surface_albedo,e.surface_roughness.value=n.surface_roughness,e.surface_anisotropy.value=n.surface_anisotropy,e.surface_rotation.value=n.surface_rotation,r(e,n,"surface_albedo_map"),r(e,n,"surface_roughness_map"),r(e,n,"surface_cutout_map"),r(e,n,"surface_anisotropy_map"),r(e,n,"surface_rotation_map"),a(e,n,"surface_normal_map"),n.prismType){case"PrismOpaque":e.opaque_albedo.value=n.opaque_albedo,e.opaque_luminance_modifier.value=n.opaque_luminance_modifier,e.opaque_f0.value=n.opaque_f0,e.opaque_luminance.value=n.opaque_luminance,r(e,n,"opaque_albedo_map"),r(e,n,"opaque_luminance_modifier_map"),r(e,n,"opaque_f0_map");break;case"PrismMetal":e.metal_f0.value=n.metal_f0,r(e,n,"metal_f0_map");break;case"PrismLayered":e.layered_f0.value=n.layered_f0,e.layered_diffuse.value=n.layered_diffuse,e.layered_fraction.value=n.layered_fraction,e.layered_bottom_f0.value=n.layered_bottom_f0,e.layered_roughness.value=n.layered_roughness,e.layered_anisotropy.value=n.layered_anisotropy,e.layered_rotation.value=n.layered_rotation,r(e,n,"layered_bottom_f0_map"),r(e,n,"layered_f0_map"),r(e,n,"layered_diffuse_map"),r(e,n,"layered_fraction_map"),r(e,n,"layered_roughness_map"),r(e,n,"layered_anisotropy_map"),r(e,n,"layered_rotation_map"),a(e,n,"layered_normal_map");break;case"PrismTransparent":e.transparent_color.value=n.transparent_color,e.transparent_distance.value=n.transparent_distance,e.transparent_ior.value=n.transparent_ior;break;case"PrismGlazing":e.glazing_f0.value=n.glazing_f0,e.glazing_transmission_color.value=n.glazing_transmission_color,e.glazing_transmission_roughness.value=n.glazing_transmission_roughness,r(e,n,"glazing_f0_map"),r(e,n,"glazing_transmission_color_map"),r(e,n,"glazing_transmission_roughness_map");break;case"PrismWood":e.wood_fiber_cosine_enable.value=n.wood_fiber_cosine_enable,e.wood_fiber_cosine_bands.value=n.wood_fiber_cosine_bands,e.wood_fiber_cosine_weights.value=n.wood_fiber_cosine_weights,e.wood_fiber_cosine_frequencies.value=n.wood_fiber_cosine_frequencies,e.wood_fiber_perlin_enable.value=n.wood_fiber_perlin_enable,e.wood_fiber_perlin_bands.value=n.wood_fiber_perlin_bands,e.wood_fiber_perlin_weights.value=n.wood_fiber_perlin_weights,e.wood_fiber_perlin_frequencies.value=n.wood_fiber_perlin_frequencies,e.wood_fiber_perlin_scale_z.value=n.wood_fiber_perlin_scale_z,e.wood_growth_perlin_enable.value=n.wood_growth_perlin_enable,e.wood_growth_perlin_bands.value=n.wood_growth_perlin_bands,e.wood_growth_perlin_weights.value=n.wood_growth_perlin_weights,e.wood_growth_perlin_frequencies.value=n.wood_growth_perlin_frequencies,e.wood_latewood_ratio.value=n.wood_latewood_ratio,e.wood_earlywood_sharpness.value=n.wood_earlywood_sharpness,e.wood_latewood_sharpness.value=n.wood_latewood_sharpness,e.wood_ring_thickness.value=n.wood_ring_thickness,e.wood_earlycolor_perlin_enable.value=n.wood_earlycolor_perlin_enable,e.wood_earlycolor_perlin_bands.value=n.wood_earlycolor_perlin_bands,e.wood_earlycolor_perlin_weights.value=n.wood_earlycolor_perlin_weights,e.wood_earlycolor_perlin_frequencies.value=n.wood_earlycolor_perlin_frequencies,e.wood_early_color.value=n.wood_early_color,e.wood_use_manual_late_color.value=n.wood_use_manual_late_color,e.wood_manual_late_color.value=n.wood_manual_late_color,e.wood_latecolor_perlin_enable.value=n.wood_latecolor_perlin_enable,e.wood_latecolor_perlin_bands.value=n.wood_latecolor_perlin_bands,e.wood_latecolor_perlin_weights.value=n.wood_latecolor_perlin_weights,e.wood_latecolor_perlin_frequencies.value=n.wood_latecolor_perlin_frequencies,e.wood_late_color_power.value=n.wood_late_color_power,e.wood_diffuse_perlin_enable.value=n.wood_diffuse_perlin_enable,e.wood_diffuse_perlin_bands.value=n.wood_diffuse_perlin_bands,e.wood_diffuse_perlin_weights.value=n.wood_diffuse_perlin_weights,e.wood_diffuse_perlin_frequencies.value=n.wood_diffuse_perlin_frequencies,e.wood_diffuse_perlin_scale_z.value=n.wood_diffuse_perlin_scale_z,e.wood_use_pores.value=n.wood_use_pores,e.wood_pore_type.value=n.wood_pore_type,e.wood_pore_radius.value=n.wood_pore_radius,e.wood_pore_cell_dim.value=n.wood_pore_cell_dim,e.wood_pore_color_power.value=n.wood_pore_color_power,e.wood_pore_depth.value=n.wood_pore_depth,e.wood_use_rays.value=n.wood_use_rays,e.wood_ray_color_power.value=n.wood_ray_color_power,e.wood_ray_seg_length_z.value=n.wood_ray_seg_length_z,e.wood_ray_num_slices.value=n.wood_ray_num_slices,e.wood_ray_ellipse_z2x.value=n.wood_ray_ellipse_z2x,e.wood_ray_ellipse_radius_x.value=n.wood_ray_ellipse_radius_x,e.wood_use_latewood_bump.value=n.wood_use_latewood_bump,e.wood_latewood_bump_depth.value=n.wood_latewood_bump_depth,e.wood_use_groove_roughness.value=n.wood_use_groove_roughness,e.wood_groove_roughness.value=n.wood_groove_roughness,e.wood_diffuse_lobe_weight.value=n.wood_diffuse_lobe_weight,r(e,n,"wood_curly_distortion_map"),null!=e.wood_curly_distortion_map.value&&(e.wood_curly_distortion_map.value.minFilter=t.NearestFilter,e.wood_curly_distortion_map.value.magFilter=t.NearestFilter,e.wood_curly_distortion_enable.value=n.wood_curly_distortion_enable,e.wood_curly_distortion_scale.value=n.wood_curly_distortion_scale);var i=1-n.wood_latewood_ratio,o=n.wood_earlywood_sharpness*i,s=n.wood_latewood_sharpness*n.wood_latewood_ratio,l=i+s;e.wood_ring_fraction.value=new t.Vector4(i,o,s,l),e.wood_fall_rise.value=new t.Vector2(i-o,n.wood_latewood_ratio-s);break;default:t.warn("Unknown prism type: "+n.prismType)}n.useTiling&&(e.tilingOverallTransform.value=n.tilingOverallTransform,e.TilingMap.value=n.TilingMap,e.TilingMap_texMatrix.value=n.TilingMap_texMatrix,n.hasRoundCorner&&(e.TilingNormalMap.value=n.TilingNormalMap,e.TilingNormalMap_texMatrix.value=n.TilingNormalMap_texMatrix),n.useRandomOffset&&(e.TilingRandomMap.value=n.TilingRandomMap,e.TilingRandomMap_texMatrix.value=n.TilingRandomMap_texMatrix,e.tilingRandomAxisS.value=n.tilingRandomAxisS,e.tilingRandomAxisT.value=n.tilingRandomAxisT,e.tilingRandomAlignmentOffset.value=n.tilingRandomAlignmentOffset),e.uv2tile.value=n.uv2tile,e.tile2uv.value=n.tile2uv,e.tileAlignOffset.value=n.tileAlignOffset,e.tilingUVTransform.value=n.tilingUVTransform),e.envExponentMin.value=n.envExponentMin,e.envExponentMax.value=n.envExponentMax,e.envExponentCount.value=n.envExponentCount}function ae(e,t){e.emissive.value.copy(t.emissive),t.wrapAround&&e.wrapRGB.value.copy(t.wrapRGB)}function ie(e,t){e.ambientLightColor.value=t.ambient,e.directionalLightColor.value=t.directional.colors,e.directionalLightDirection.value=t.directional.positions,e.pointLightColor.value=t.point.colors,e.pointLightPosition.value=t.point.positions,e.pointLightDistance.value=t.point.distances,e.spotLightColor.value=t.spot.colors,e.spotLightPosition.value=t.spot.positions,e.spotLightDistance.value=t.spot.distances,e.spotLightDirection.value=t.spot.directions,e.spotLightAngleCos.value=t.spot.anglesCos,e.spotLightExponent.value=t.spot.exponents,e.hemisphereLightSkyColor.value=t.hemi.skyColors,e.hemisphereLightGroundColor.value=t.hemi.groundColors,e.hemisphereLightDirection.value=t.hemi.positions}function oe(e,t){e.ambientLightColor.needsUpdate=t,e.directionalLightColor.needsUpdate=t,e.directionalLightDirection.needsUpdate=t,e.pointLightColor.needsUpdate=t,e.pointLightPosition.needsUpdate=t,e.pointLightDistance.needsUpdate=t,e.spotLightColor.needsUpdate=t,e.spotLightPosition.needsUpdate=t,e.spotLightDistance.needsUpdate=t,e.spotLightDirection.needsUpdate=t,e.spotLightAngleCos.needsUpdate=t,e.spotLightExponent.needsUpdate=t,e.hemisphereLightSkyColor.needsUpdate=t,e.hemisphereLightGroundColor.needsUpdate=t,e.hemisphereLightDirection.needsUpdate=t}function se(e,t,n){Fe.multiplyMatrices(n.matrixWorldInverse,t.matrixWorld),Ge.uniformMatrix4fv(e.modelViewMatrix,!1,Fe.elements),e.normalMatrix&&(Ve.getNormalMatrix(Fe),Ge.uniformMatrix3fv(e.normalMatrix,!1,Ve.elements))}function le(){var e=tt;return e>=xt&&t.warn("WebGLRenderer: trying to use "+e+" texture units while this GPU supports only "+xt),tt+=1,e}function ue(e){for(var n,r,a,i=0,o=e.length;i<o;i++){var s=e[i][0];if(!1!==s.needsUpdate){var l,u,f=s.type,d=s.value,c=e[i][1];switch(f){case"1i":Ge.uniform1i(c,d);break;case"1f":Ge.uniform1f(c,d);break;case"2f":Ge.uniform2f(c,d[0],d[1]);break;case"3f":Ge.uniform3f(c,d[0],d[1],d[2]);break;case"4f":Ge.uniform4f(c,d[0],d[1],d[2],d[3]);break;case"1iv":Ge.uniform1iv(c,d);break;case"3iv":Ge.uniform3iv(c,d);break;case"1fv":Ge.uniform1fv(c,d);break;case"2fv":Ge.uniform2fv(c,d);break;case"3fv":Ge.uniform3fv(c,d);break;case"4fv":Ge.uniform4fv(c,d);break;case"Matrix3fv":Ge.uniformMatrix3fv(c,!1,d);break;case"Matrix4fv":Ge.uniformMatrix4fv(c,!1,d);break;case"i":Ge.uniform1i(c,d);break;case"f":Ge.uniform1f(c,d);break;case"v2":Ge.uniform2f(c,d.x,d.y);break;case"v3":Ge.uniform3f(c,d.x,d.y,d.z);break;case"v4":Ge.uniform4f(c,d.x,d.y,d.z,d.w);break;case"c":Ge.uniform3f(c,d.r,d.g,d.b);break;case"iv1":Ge.uniform1iv(c,d);break;case"iv":Ge.uniform3iv(c,d);break;case"fv1":Ge.uniform1fv(c,d);break;case"fv":Ge.uniform3fv(c,d);break;case"v2v":for(void 0===s._array&&(s._array=new Float32Array(2*d.length)),l=0,u=d.length;l<u;l++)a=2*l,s._array[a]=d[l].x,s._array[a+1]=d[l].y;Ge.uniform2fv(c,s._array);break;case"v3v":for(void 0===s._array&&(s._array=new Float32Array(3*d.length)),l=0,u=d.length;l<u;l++)a=3*l,s._array[a]=d[l].x,s._array[a+1]=d[l].y,s._array[a+2]=d[l].z;Ge.uniform3fv(c,s._array);break;case"v4v":for(void 0===s._array&&(s._array=new Float32Array(4*d.length)),l=0,u=d.length;l<u;l++)a=4*l,s._array[a]=d[l].x,s._array[a+1]=d[l].y,s._array[a+2]=d[l].z,s._array[a+3]=d[l].w;Ge.uniform4fv(c,s._array);break;case"m3":Ge.uniformMatrix3fv(c,!1,d.elements);break;case"m3v":for(void 0===s._array&&(s._array=new Float32Array(9*d.length)),l=0,u=d.length;l<u;l++)d[l].flattenToArrayOffset(s._array,9*l);Ge.uniformMatrix3fv(c,!1,s._array);break;case"m4":Ge.uniformMatrix4fv(c,!1,d.elements);break;case"m4v":for(void 0===s._array&&(s._array=new Float32Array(16*d.length)),l=0,u=d.length;l<u;l++)d[l].flattenToArrayOffset(s._array,16*l);Ge.uniformMatrix4fv(c,!1,s._array);break;case"t":if(n=d,r=le(),Ge.uniform1i(c,r),!n){Ge.activeTexture(Ge.TEXTURE0+r),Ge.bindTexture(Ge.TEXTURE_2D,It.__webglTexture);continue}Array.isArray(n.image)&&6===n.image.length||n instanceof t.CubeTexture?n.needsUpdate?he(n,r):(Ge.activeTexture(Ge.TEXTURE0+r),Ge.bindTexture(Ge.TEXTURE_CUBE_MAP,n.__webglTextureCube)):n instanceof t.WebGLRenderTargetCube?me(n,r):qe.setTexture(n,r);break;case"tv":for(void 0===s._array&&(s._array=[]),l=0,u=s.value.length;l<u;l++)s._array[l]=le();for(Ge.uniform1iv(c,s._array),l=0,u=s.value.length;l<u;l++)n=s.value[l],r=s._array[l],n&&qe.setTexture(n,r);break;default:t.warn("THREE.WebGLRenderer: Unknown uniform type: "+f)}}}}function fe(e,t,n,r){e[t]=n.r*r,e[t+1]=n.g*r,e[t+2]=n.b*r}function de(e){var n,r,a,i,o,s,l,u,f=0,d=0,c=0,p=pt,h=p.directional.colors,m=p.directional.positions,_=p.point.colors,v=p.point.positions,g=p.point.distances,y=p.spot.colors,x=p.spot.positions,b=p.spot.distances,w=p.spot.directions,M=p.spot.anglesCos,S=p.spot.exponents,T=p.hemi.skyColors,A=p.hemi.groundColors,E=p.hemi.positions,R=0,L=0,P=0,I=0,C=0,D=0,N=0,O=0,U=0,F=0,V=0,B=0;for(n=0,r=e.length;n<r;n++)if(!(a=e[n]).onlyShadow)if(i=a.color,l=a.intensity,u=a.distance,a instanceof t.AmbientLight){if(!a.visible)continue;f+=i.r,d+=i.g,c+=i.b}else if(a instanceof t.DirectionalLight){if(C+=1,!a.visible)continue;dt.setFromMatrixPosition(a.matrixWorld),ft.setFromMatrixPosition(a.target.matrixWorld),dt.sub(ft),dt.normalize(),m[U=3*R]=dt.x,m[U+1]=dt.y,m[U+2]=dt.z,fe(h,U,i,l),R+=1}else if(a instanceof t.PointLight){if(D+=1,!a.visible)continue;fe(_,F=3*L,i,l),ft.setFromMatrixPosition(a.matrixWorld),v[F]=ft.x,v[F+1]=ft.y,v[F+2]=ft.z,g[L]=u,L+=1}else if(a instanceof t.SpotLight){if(N+=1,!a.visible)continue;fe(y,V=3*P,i,l),ft.setFromMatrixPosition(a.matrixWorld),x[V]=ft.x,x[V+1]=ft.y,x[V+2]=ft.z,b[P]=u,dt.copy(ft),ft.setFromMatrixPosition(a.target.matrixWorld),dt.sub(ft),dt.normalize(),w[V]=dt.x,w[V+1]=dt.y,w[V+2]=dt.z,M[P]=Math.cos(a.angle),S[P]=a.exponent,P+=1}else if(a instanceof t.HemisphereLight){if(O+=1,!a.visible)continue;dt.setFromMatrixPosition(a.matrixWorld),dt.normalize(),E[B=3*I]=dt.x,E[B+1]=dt.y,E[B+2]=dt.z,o=a.color,s=a.groundColor,fe(T,B,o,l),fe(A,B,s,l),I+=1}for(n=3*R,r=Math.max(h.length,3*C);n<r;n++)h[n]=0;for(n=3*L,r=Math.max(_.length,3*D);n<r;n++)_[n]=0;for(n=3*P,r=Math.max(y.length,3*N);n<r;n++)y[n]=0;for(n=3*I,r=Math.max(T.length,3*O);n<r;n++)T[n]=0;for(n=3*I,r=Math.max(A.length,3*O);n<r;n++)A[n]=0;p.directional.length=R,p.point.length=L,p.spot.length=P,p.hemi.length=I,p.ambient[0]=f,p.ambient[1]=d,p.ambient[2]=c}function ce(e,n,r){var a;r?(Ge.texParameteri(e,Ge.TEXTURE_WRAP_S,ge(n.wrapS)),Ge.texParameteri(e,Ge.TEXTURE_WRAP_T,ge(n.wrapT)),Ge.texParameteri(e,Ge.TEXTURE_MAG_FILTER,ge(n.magFilter)),Ge.texParameteri(e,Ge.TEXTURE_MIN_FILTER,ge(n.minFilter))):(Ge.texParameteri(e,Ge.TEXTURE_WRAP_S,Ge.CLAMP_TO_EDGE),Ge.texParameteri(e,Ge.TEXTURE_WRAP_T,Ge.CLAMP_TO_EDGE),n.wrapS===t.ClampToEdgeWrapping&&n.wrapT===t.ClampToEdgeWrapping||t.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to THREE.ClampToEdgeWrapping. ( "+n.sourceFile+" )"),Ge.texParameteri(e,Ge.TEXTURE_MAG_FILTER,ve(n.magFilter)),Ge.texParameteri(e,Ge.TEXTURE_MIN_FILTER,ve(n.minFilter)),n.minFilter!==t.NearestFilter&&n.minFilter!==t.LinearFilter&&t.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to THREE.NearestFilter or THREE.LinearFilter. ( "+n.sourceFile+" )")),(a=_t.get("EXT_texture_filter_anisotropic"))&&n.type!==t.FloatType&&n.type!==t.HalfFloatType&&(n.anisotropy>1||n.__oldAnisotropy)&&(Ge.texParameterf(e,a.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(n.anisotropy,qe.getMaxAnisotropy())),n.__oldAnisotropy=n.anisotropy)}function pe(e,t){if(e.width<=t&&e.height<=t)return e;var n=Math.max(e.width,e.height),r=Math.floor(e.width*t/n),a=Math.floor(e.height*t/n),i=document.createElement("canvas");return i.width=r,i.height=a,i.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,r,a),i}function he(e,n){if(6===e.image.length)if(e.needsUpdate){e.__webglTextureCube||(e.addEventListener("dispose",Vt),e.__webglTextureCube=Ge.createTexture(),qe.info.memory.textures++),Ge.activeTexture(Ge.TEXTURE0+n),Ge.bindTexture(Ge.TEXTURE_CUBE_MAP,e.__webglTextureCube),Ge.pixelStorei(Ge.UNPACK_FLIP_Y_WEBGL,e.flipY);var r,a=e instanceof t.CompressedTexture,i=e.image[0]instanceof t.DataTexture,o=[];for(r=0;r<6;r++)!qe.autoScaleCubemaps||a||i?o[r]=i?e.image[r].image:e.image[r]:o[r]=pe(e.image[r],Mt);var s=o[0],l=t.Math.isPowerOfTwo(s.width)&&t.Math.isPowerOfTwo(s.height),u=ge(e.format),f=ge(e.type);for(ce(Ge.TEXTURE_CUBE_MAP,e,l),r=0;r<6;r++)if(a)for(var d,c=o[r].mipmaps,p=0,h=c.length;p<h;p++)d=c[p],e.format!==t.RGBAFormat&&e.format!==t.RGBFormat?Ct().indexOf(u)>-1?Ge.compressedTexImage2D(Ge.TEXTURE_CUBE_MAP_POSITIVE_X+r,p,u,d.width,d.height,0,d.data):t.warn("Attempt to load unsupported compressed texture format"):Ge.texImage2D(Ge.TEXTURE_CUBE_MAP_POSITIVE_X+r,p,u,d.width,d.height,0,u,f,d.data);else i?Ge.texImage2D(Ge.TEXTURE_CUBE_MAP_POSITIVE_X+r,0,u,o[r].width,o[r].height,0,u,f,o[r].data):Ge.texImage2D(Ge.TEXTURE_CUBE_MAP_POSITIVE_X+r,0,u,u,f,o[r]);e.generateMipmaps&&l&&Ge.generateMipmap(Ge.TEXTURE_CUBE_MAP),e.needsUpdate=!1,e.onUpdate&&e.onUpdate()}else Ge.activeTexture(Ge.TEXTURE0+n),Ge.bindTexture(Ge.TEXTURE_CUBE_MAP,e.__webglTextureCube)}function me(e,t){Ge.activeTexture(Ge.TEXTURE0+t),Ge.bindTexture(Ge.TEXTURE_CUBE_MAP,e.__webglTexture)}function _e(e){Ge.bindTexture(Ge.TEXTURE_2D,e.__webglTexture),Ge.generateMipmap(Ge.TEXTURE_2D),Ge.bindTexture(Ge.TEXTURE_2D,null)}function ve(e){return e===t.NearestFilter||e===t.NearestMipMapNearestFilter||e===t.NearestMipMapLinearFilter?Ge.NEAREST:Ge.LINEAR}function ge(e){var n;if(e===t.RepeatWrapping)return Ge.REPEAT;if(e===t.ClampToEdgeWrapping)return Ge.CLAMP_TO_EDGE;if(e===t.MirroredRepeatWrapping)return Ge.MIRRORED_REPEAT;if(e===t.NearestFilter)return Ge.NEAREST;if(e===t.NearestMipMapNearestFilter)return Ge.NEAREST_MIPMAP_NEAREST;if(e===t.NearestMipMapLinearFilter)return Ge.NEAREST_MIPMAP_LINEAR;if(e===t.LinearFilter)return Ge.LINEAR;if(e===t.LinearMipMapNearestFilter)return Ge.LINEAR_MIPMAP_NEAREST;if(e===t.LinearMipMapLinearFilter)return Ge.LINEAR_MIPMAP_LINEAR;if(e===t.UnsignedByteType)return Ge.UNSIGNED_BYTE;if(e===t.UnsignedShort4444Type)return Ge.UNSIGNED_SHORT_4_4_4_4;if(e===t.UnsignedShort5551Type)return Ge.UNSIGNED_SHORT_5_5_5_1;if(e===t.UnsignedShort565Type)return Ge.UNSIGNED_SHORT_5_6_5;if(e===t.ByteType)return Ge.BYTE;if(e===t.ShortType)return Ge.SHORT;if(e===t.UnsignedShortType)return Ge.UNSIGNED_SHORT;if(e===t.IntType)return Ge.INT;if(e===t.UnsignedIntType)return Ge.UNSIGNED_INT;if(e===t.FloatType)return Ge.FLOAT;if(e===t.HalfFloatType)return 36193;if(e===t.AlphaFormat)return Ge.ALPHA;if(e===t.RGBFormat)return Ge.RGB;if(e===t.RGBAFormat)return Ge.RGBA;if(e===t.LuminanceFormat)return Ge.LUMINANCE;if(e===t.LuminanceAlphaFormat)return Ge.LUMINANCE_ALPHA;if(e===t.AddEquation)return Ge.FUNC_ADD;if(e===t.SubtractEquation)return Ge.FUNC_SUBTRACT;if(e===t.ReverseSubtractEquation)return Ge.FUNC_REVERSE_SUBTRACT;if(e===t.ZeroFactor)return Ge.ZERO;if(e===t.OneFactor)return Ge.ONE;if(e===t.SrcColorFactor)return Ge.SRC_COLOR;if(e===t.OneMinusSrcColorFactor)return Ge.ONE_MINUS_SRC_COLOR;if(e===t.SrcAlphaFactor)return Ge.SRC_ALPHA;if(e===t.OneMinusSrcAlphaFactor)return Ge.ONE_MINUS_SRC_ALPHA;if(e===t.DstAlphaFactor)return Ge.DST_ALPHA;if(e===t.OneMinusDstAlphaFactor)return Ge.ONE_MINUS_DST_ALPHA;if(e===t.DstColorFactor)return Ge.DST_COLOR;if(e===t.OneMinusDstColorFactor)return Ge.ONE_MINUS_DST_COLOR;if(e===t.SrcAlphaSaturateFactor)return Ge.SRC_ALPHA_SATURATE;if(null!==(n=_t.get("WEBGL_compressed_texture_s3tc"))){if(e===t.RGB_S3TC_DXT1_Format)return n.COMPRESSED_RGB_S3TC_DXT1_EXT;if(e===t.RGBA_S3TC_DXT1_Format)return n.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(e===t.RGBA_S3TC_DXT3_Format)return n.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(e===t.RGBA_S3TC_DXT5_Format)return n.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(null!==(n=_t.get("WEBGL_compressed_texture_pvrtc"))){if(e===t.RGB_PVRTC_4BPPV1_Format)return n.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(e===t.RGB_PVRTC_2BPPV1_Format)return n.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(e===t.RGBA_PVRTC_4BPPV1_Format)return n.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(e===t.RGBA_PVRTC_2BPPV1_Format)return n.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(null!==(n=_t.get("EXT_blend_minmax"))){if(e===t.MinEquation)return n.MIN_EXT;if(e===t.MaxEquation)return n.MAX_EXT}return 0}function ye(e){for(var n=0,r=0,a=0,i=0,o=0,s=e.length;o<s;o++){var l=e[o];l.onlyShadow||(l instanceof t.DirectionalLight&&n++,l instanceof t.PointLight&&r++,l instanceof t.SpotLight&&a++,l instanceof t.HemisphereLight&&i++)}return{directional:n,point:r,spot:a,hemi:i}}t.log("THREE.WebGLRenderer",t.REVISION);var xe=void 0!==(e=e||{}).canvas?e.canvas:document.createElement("canvas"),be=window.devicePixelRatio||1,we=void 0!==e.precision?e.precision:"highp",Me=we,Se=void 0!==e.alpha&&e.alpha,Te=void 0===e.premultipliedAlpha||e.premultipliedAlpha,Ae=void 0!==e.antialias&&e.antialias,Ee=void 0===e.stencil||e.stencil,Re=void 0===e.preserveDrawingBuffer||e.preserveDrawingBuffer,Le=void 0!==e.logarithmicDepthBuffer&&e.logarithmicDepthBuffer,Pe=!1,Ie=new t.Color(0),Ce=0,De=-1!=window.navigator.userAgent.indexOf("Firefox")&&-1!=window.navigator.userAgent.indexOf("Mac OS"),Ne=[],Oe={},Ue=[],Fe=new t.Matrix4,Ve=new t.Matrix3,Be=[],ze=[];this.domElement=xe,this.context=null,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.gammaInput=!1,this.gammaOutput=!1,this.maxMorphTargets=8,this.maxMorphNormals=4,this.autoScaleCubemaps=!0,this.info={memory:{programs:0,geometries:0,textures:0},render:{calls:0,vertices:0,faces:0,points:0}};var Ge,ke,He,We,qe=this,je=[],Xe=null,Ye=null,Ke=-1,Ze=null,Qe="",Je=0,$e="",et="",tt=0,nt=0,rt=0,at=xe.width,it=xe.height,ot={},st=new t.Frustum,lt=new t.Matrix4,ut=new t.Matrix4,ft=new t.Vector3,dt=new t.Vector3,ct=!0,pt={ambient:[0,0,0],directional:{length:0,colors:[],positions:[]},point:{length:0,colors:[],positions:[],distances:[]},spot:{length:0,colors:[],positions:[],distances:[],directions:[],anglesCos:[],exponents:[]},hemi:{length:0,skyColors:[],groundColors:[],positions:[]}};try{var ht={alpha:Se,premultipliedAlpha:Te,antialias:Ae,stencil:Ee,preserveDrawingBuffer:Re};if(null===(Ge=xe.getContext("webgl",ht)||xe.getContext("experimental-webgl",ht)))throw null!==xe.getContext("webgl")?"Error creating WebGL context with your selected attributes.":"Error creating WebGL context.";0==Ge.getShaderPrecisionFormat(Ge.FRAGMENT_SHADER,Ge.HIGH_FLOAT).precision&&(Me="mediump"),Ge=$l(Ge),xe.addEventListener("webglcontextlost",function(e){e.preventDefault(),yt(),gt(),Oe={}},!1)}catch(e){return void t.error(e)}var mt=new pd(Ge,ge);void 0===Ge.getShaderPrecisionFormat&&(Ge.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}});var _t=new t.WebGLExtensions(Ge);_t.get("OES_texture_float"),_t.get("OES_texture_float_linear"),_t.get("OES_texture_half_float"),_t.get("OES_texture_half_float_linear"),_t.get("OES_standard_derivatives"),_t.get("EXT_shader_texture_lod"),_t.get("EXT_texture_filter_anisotropic"),_t.get("WEBGL_compressed_texture_s3tc"),ke=_t.get("WEBGL_draw_buffers"),He=_t.get("ANGLE_instanced_arrays"),We=_t.get("OES_vertex_array_object"),Le&&_t.get("EXT_frag_depth");var vt=function(e,t,n,r){!0===Te&&(e*=r,t*=r,n*=r),Ge.clearColor(e,t,n,r)},gt=function(){Ge.clearColor(0,0,0,1),Ge.clearDepth(1),Ge.clearStencil(0),Ge.enable(Ge.DEPTH_TEST),Ge.depthFunc(Ge.LEQUAL),Ge.frontFace(Ge.CCW),Ge.cullFace(Ge.BACK),Ge.enable(Ge.CULL_FACE),Ge.enable(Ge.BLEND),Ge.blendEquation(Ge.FUNC_ADD),Ge.blendFunc(Ge.SRC_ALPHA,Ge.ONE_MINUS_SRC_ALPHA),Ge.viewport(nt,rt,at,it),vt(Ie.r,Ie.g,Ie.b,Ce)},yt=function(){Xe=null,Ze=null,Qe="",Ke=-1,ct=!0,mt.reset(),mt.disableUnusedAttributes()};gt(),this.context=Ge,this.state=mt;for(var xt=Ge.getParameter(Ge.MAX_TEXTURE_IMAGE_UNITS),bt=Ge.getParameter(Ge.MAX_VERTEX_TEXTURE_IMAGE_UNITS),wt=Ge.getParameter(Ge.MAX_TEXTURE_SIZE),Mt=Ge.getParameter(Ge.MAX_CUBE_MAP_TEXTURE_SIZE),St=bt>0,Tt=Ge.getShaderPrecisionFormat(Ge.VERTEX_SHADER,Ge.HIGH_FLOAT),At=Ge.getShaderPrecisionFormat(Ge.VERTEX_SHADER,Ge.MEDIUM_FLOAT),Et=Ge.getShaderPrecisionFormat(Ge.FRAGMENT_SHADER,Ge.HIGH_FLOAT),Rt=Ge.getShaderPrecisionFormat(Ge.FRAGMENT_SHADER,Ge.MEDIUM_FLOAT),Lt=new Uint8Array(16),Pt=0;Pt<4;Pt++)Lt[4*Pt]=Lt[4*Pt+1]=Lt[4*Pt+2]=0,Lt[4*Pt+3]=255;var It=new t.DataTexture(Lt,2,2,t.RGBAFormat,t.UnsignedByteType,t.UVMapping,t.RepeatWrapping,t.RepeatWrapping,t.NearestFilter,t.NearestFilter);It.needsUpdate=!0;var Ct=function(){var e;return function(){if(void 0!==e)return e;if(e=[],_t.get("WEBGL_compressed_texture_pvrtc")||_t.get("WEBGL_compressed_texture_s3tc"))for(var t=Ge.getParameter(Ge.COMPRESSED_TEXTURE_FORMATS),n=0;n<t.length;n++)e.push(t[n]);return e}}(),Dt=Tt.precision>0,Nt=At.precision>0;"highp"!==we||Dt||(Nt?(we="mediump",t.warn("WebGLRenderer: highp not supported, using mediump")):(we="lowp",t.warn("WebGLRenderer: highp and mediump not supported, using lowp"))),"mediump"!==we||Nt||(we="lowp",t.warn("WebGLRenderer: mediump not supported, using lowp")),Dt=Et.precision>0,Nt=Rt.precision>0,"highp"!==Me||Dt||(Nt?(Me="mediump",t.warn("WebGLRenderer: highp not supported, using mediump")):(Me="lowp",t.warn("WebGLRenderer: highp and mediump not supported, using lowp"))),"mediump"!==Me||Nt||(Me="lowp",t.warn("WebGLRenderer: mediump not supported, using lowp")),this.getContext=function(){return Ge},this.forceContextLoss=function(){_t.get("WEBGL_lose_context").loseContext()},this.supportsVertexTextures=function(){return St},this.supportsFloatTextures=function(){return _t.get("OES_texture_float")},this.supportsHalfFloatTextures=function(){return _t.get("OES_texture_half_float_linear")},this.supportsStandardDerivatives=function(){return _t.get("OES_standard_derivatives")},this.supportsCompressedTextureS3TC=function(){return _t.get("WEBGL_compressed_texture_s3tc")},this.supportsMRT=function(){return!De&&ke},this.supportsInstancedArrays=function(){return!!He},this.supportsBlendMinMax=function(){return _t.get("EXT_blend_minmax")},this.getMaxAnisotropy=function(){var e;return function(){if(void 0!==e)return e;var t=_t.get("EXT_texture_filter_anisotropic");return e=null!==t?Ge.getParameter(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0}}(),this.getPixelRatio=function(){return be},this.setPixelRatio=function(e){be=e},this.getCurrentFramebuffer=function(){return Ye},this.setIdBufferSource=function(e){switch(e){case 0:Pe=!1;break;case 1:Pe=!0;break;default:return!1}return!0},this.setSize=function(e,t,n){xe.width=e*be,xe.height=t*be,!1!==n&&(xe.style.width=e+"px",xe.style.height=t+"px"),this.setViewport(0,0,e,t)},this.setViewport=function(e,t,n,r){nt=e*be,rt=t*be,at=n*be,it=r*be,Ge.viewport(nt,rt,at,it)};var Ot=[];this.pushViewport=function(){Ot.push(nt),Ot.push(rt),Ot.push(at),Ot.push(it)},this.popViewport=function(){var e=Ot.length-4;nt=Ot[e],rt=Ot[e+1],at=Ot[e+2],it=Ot[e+3],Ge.viewport(nt,rt,at,it),Ot.length=e},this.setScissor=function(e,t,n,r){Ge.scissor(e*be,t*be,n*be,r*be)},this.enableScissorTest=function(e){e?Ge.enable(Ge.SCISSOR_TEST):Ge.disable(Ge.SCISSOR_TEST)},this.getClearColor=function(){return Ie},this.setClearColor=function(e,t){Ie.set(e),Ce=void 0!==t?t:1,vt(Ie.r,Ie.g,Ie.b,Ce)},this.getClearAlpha=function(){return Ce},this.setClearAlpha=function(e){Ce=e,vt(Ie.r,Ie.g,Ie.b,Ce)},this.clear=function(e,t,n){var r=0;(void 0===e||e)&&(r|=Ge.COLOR_BUFFER_BIT),(void 0===t||t)&&(r|=Ge.DEPTH_BUFFER_BIT),(void 0===n||n)&&(r|=Ge.STENCIL_BUFFER_BIT),Ge.clear(r)},this.clearColor=function(){Ge.clear(Ge.COLOR_BUFFER_BIT)},this.clearDepth=function(){Ge.clear(Ge.DEPTH_BUFFER_BIT)},this.clearStencil=function(){Ge.clear(Ge.STENCIL_BUFFER_BIT)},this.clearTarget=function(e,t,n,r){this.setRenderTarget(e),this.clear(t,n,r)},this.resetGLState=yt;var Ut=function e(t){t.target.traverse(function(t){t.removeEventListener("remove",e),H(t)})},Ft=function e(t){var n=t.target;n.removeEventListener("dispose",e),kt(n)},Vt=function e(t){var n=t.target;n.removeEventListener("dispose",e),Ht(n),qe.info.memory.textures--},Bt=function e(t){var n=t.target;n.removeEventListener("dispose",e),Wt(n),qe.info.memory.textures--},zt=function e(t){var n=t.target;n.removeEventListener("dispose",e),qt(n)},Gt=function(e){if(void 0!==e.__webglVertexBuffer&&(Ge.deleteBuffer(e.__webglVertexBuffer),e.__webglVertexBuffer=void 0),void 0!==e.__webglNormalBuffer&&(Ge.deleteBuffer(e.__webglNormalBuffer),e.__webglNormalBuffer=void 0),void 0!==e.__webglTangentBuffer&&(Ge.deleteBuffer(e.__webglTangentBuffer),e.__webglTangentBuffer=void 0),void 0!==e.__webglColorBuffer&&(Ge.deleteBuffer(e.__webglColorBuffer),e.__webglColorBuffer=void 0),void 0!==e.__webglUVBuffer&&(Ge.deleteBuffer(e.__webglUVBuffer),e.__webglUVBuffer=void 0),void 0!==e.__webglUV2Buffer&&(Ge.deleteBuffer(e.__webglUV2Buffer),e.__webglUV2Buffer=void 0),void 0!==e.__webglSkinIndicesBuffer&&(Ge.deleteBuffer(e.__webglSkinIndicesBuffer),e.__webglSkinIndicesBuffer=void 0),void 0!==e.__webglSkinWeightsBuffer&&(Ge.deleteBuffer(e.__webglSkinWeightsBuffer),e.__webglSkinWeightsBuffer=void 0),void 0!==e.__webglFaceBuffer&&(Ge.deleteBuffer(e.__webglFaceBuffer),e.__webglFaceBuffer=void 0),void 0!==e.__webglLineBuffer&&(Ge.deleteBuffer(e.__webglLineBuffer),e.__webglLineBuffer=void 0),void 0!==e.__webglLineDistanceBuffer&&(Ge.deleteBuffer(e.__webglLineDistanceBuffer),e.__webglLineDistanceBuffer=void 0),void 0!==e.__webglCustomAttributesList){for(var t in e.__webglCustomAttributesList)Ge.deleteBuffer(e.__webglCustomAttributesList[t].buffer);e.__webglCustomAttributesList=void 0}qe.info.memory.geometries--},kt=function(e){e.__webglInit=void 0;var n,r,a,i;if(e instanceof t.BufferGeometry){if(void 0!==e.vbbuffer&&(Ge.deleteBuffer(e.vbbuffer),e.vbbuffer=void 0),void 0!==e.ibbuffer&&(Ge.deleteBuffer(e.ibbuffer),e.ibbuffer=void 0),void 0!==e.iblinesbuffer&&(Ge.deleteBuffer(e.iblinesbuffer),e.iblinesbuffer=void 0),e.vaos){for(n=0;n<e.vaos.length;n++)We.deleteVertexArrayOES(e.vaos[n].vao);e.vaos=void 0}var o=e.attributes;for(var s in o)void 0!==o[s].buffer&&(Ge.deleteBuffer(o[s].buffer),o[s].buffer=void 0);qe.info.memory.geometries--}else{var l=Zt[e.id];if(void 0!==l){for(n=0,r=l.length;n<r;n++){var u=l[n];if(void 0!==u.numMorphTargets){for(a=0,i=u.numMorphTargets;a<i;a++)Ge.deleteBuffer(u.__webglMorphTargetsBuffers[a]);delete u.__webglMorphTargetsBuffers}if(void 0!==u.numMorphNormals){for(a=0,i=u.numMorphNormals;a<i;a++)Ge.deleteBuffer(u.__webglMorphNormalsBuffers[a]);delete u.__webglMorphNormalsBuffers}Gt(u)}delete Zt[e.id]}else Gt(e)}};this.deallocateGeometry=kt;var Ht=function(e){if(e.__webglTextureCube)Ge.deleteTexture(e.__webglTextureCube),e.__webglTextureCube=void 0;else{if(!e.__webglInit)return;Ge.deleteTexture(e.__webglTexture),e.__webglInit=void 0,e.__webglTexture=void 0}},Wt=function(e){e&&e.__webglTexture&&(Ge.deleteTexture(e.__webglTexture),Ge.deleteFramebuffer(e.__webglFramebuffer),void 0!==e.__webglRenderbuffer&&Ge.deleteRenderbuffer(e.__webglRenderbuffer))},qt=function(e){var t=!1;e.program=void 0,e.programs.forEach(function(e){var n;if(void 0!==e&&void 0!=(n=e.program)){var r,a,i;for(r=0,a=je.length;r<a;r++)if((i=je[r])&&i.program===n){i.usedTimes--,0===i.usedTimes&&(je[r]=void 0,Ge.deleteProgram(n),qe.info.memory.programs--,t=!0);break}}},!1),e.programs.length=0,t&&(je=je.filter(function(e){return void 0!==e}))};this.renderBufferDirect=function(e,n,r,a,i,o,s){if(!1!==a.visible&&(!a.isEdgeMaterial||i.iblines)){g(o.geometry);var l=Y(e,n,r,a,o),u=i.attributes,f=!1,d=a.wireframe?1:0,c="direct_"+i.id+(s?"/"+s:"")+"_"+l.id+"_"+d;c!==Qe&&(Qe=c,f=!0);var p=x(a,l,i,s||0);if((f=f&&!p)&&mt.initAttributes(),o instanceof t.Mesh){var h,m=u.index;if(m){var _,v,y=m.array?m.array:i.ib;a.isEdgeMaterial&&(m=u.indexlines,y=i.iblines),m.bytesPerItem?4===(v=m.bytesPerItem)&&_t.get("OES_element_index_uint"):v=y instanceof Uint32Array&&_t.get("OES_element_index_uint")?4:2,_=4===v?Ge.UNSIGNED_INT:Ge.UNSIGNED_SHORT;var b=a.isEdgeMaterial?null:i.offsets;b&&b.length>1&&(f=!0);var M=0;do{var S,T,A;b&&b.length?(S=b[M].index,T=b[M].start,A=b[M].count):(S=0,T=0,A=y.length),f&&w(a,l,i,S,m,s),h=Ge.TRIANGLES,i.isPoints?h=Ge.POINTS:(i.isLines||a.isEdgeMaterial)&&(h=Ge.LINES),i.numInstances?He.drawElementsInstancedANGLE(h,A,_,T*v,i.numInstances):Ge.drawElements(h,A,_,T*v)}while(b&&++M<b.length)}else{f&&w(a,l,i,0,void 0,s);var E=i.attributes.position;h=Ge.TRIANGLES,i.isPoints?h=Ge.POINTS:(i.isLines||a.isEdgeMaterial)&&(h=Ge.LINES),i.numInstances?He.drawArraysInstancedANGLE(h,0,E.array.length/3,i.numInstances):Ge.drawArrays(h,0,E.array.length/E.itemSize)}}else t.log("Only THREE.Mesh can be rendered by the Firefly renderer. Use THREE.Mesh to draw lines.");p&&We.bindVertexArrayOES(null)}},this.renderBuffer=function(e,n,r,a,i,o){if(!1!==a.visible){z(o);var s=Y(e,n,r,a,o),l=s.attributes,u=!1,f=a.wireframe?1:0,d=i.id+"_"+s.id+"_"+f;if(d!==Qe&&(Qe=d,u=!0),u&&mt.initAttributes(),!a.morphTargets&&l.position>=0&&u&&(Ge.bindBuffer(Ge.ARRAY_BUFFER,i.__webglVertexBuffer),mt.enableAttribute(l.position),Ge.vertexAttribPointer(l.position,3,Ge.FLOAT,!1,0,0)),u){if(i.__webglCustomAttributesList)for(var c=0,p=i.__webglCustomAttributesList.length;c<p;c++){var h=i.__webglCustomAttributesList[c];l[h.buffer.belongsToAttribute]>=0&&(Ge.bindBuffer(Ge.ARRAY_BUFFER,h.buffer),mt.enableAttribute(l[h.buffer.belongsToAttribute]),Ge.vertexAttribPointer(l[h.buffer.belongsToAttribute],h.size,Ge.FLOAT,!1,0,0))}l.color>=0&&(o.geometry.colors.length>0||o.geometry.faces.length>0?(Ge.bindBuffer(Ge.ARRAY_BUFFER,i.__webglColorBuffer),mt.enableAttribute(l.color),Ge.vertexAttribPointer(l.color,3,Ge.FLOAT,!1,0,0)):a.defaultAttributeValues&&Ge.vertexAttrib3fv(l.color,a.defaultAttributeValues.color)),l.normal>=0&&(Ge.bindBuffer(Ge.ARRAY_BUFFER,i.__webglNormalBuffer),mt.enableAttribute(l.normal),Ge.vertexAttribPointer(l.normal,3,Ge.FLOAT,!1,0,0)),l.tangent>=0&&(Ge.bindBuffer(Ge.ARRAY_BUFFER,i.__webglTangentBuffer),mt.enableAttribute(l.tangent),Ge.vertexAttribPointer(l.tangent,4,Ge.FLOAT,!1,0,0)),l.uv>=0&&(o.geometry.faceVertexUvs[0]?(Ge.bindBuffer(Ge.ARRAY_BUFFER,i.__webglUVBuffer),mt.enableAttribute(l.uv),Ge.vertexAttribPointer(l.uv,2,Ge.FLOAT,!1,0,0)):a.defaultAttributeValues&&Ge.vertexAttrib2fv(l.uv,a.defaultAttributeValues.uv)),l.uv2>=0&&(o.geometry.faceVertexUvs[1]?(Ge.bindBuffer(Ge.ARRAY_BUFFER,i.__webglUV2Buffer),mt.enableAttribute(l.uv2),Ge.vertexAttribPointer(l.uv2,2,Ge.FLOAT,!1,0,0)):a.defaultAttributeValues&&Ge.vertexAttrib2fv(l.uv2,a.defaultAttributeValues.uv2)),l.lineDistance>=0&&(Ge.bindBuffer(Ge.ARRAY_BUFFER,i.__webglLineDistanceBuffer),mt.enableAttribute(l.lineDistance),Ge.vertexAttribPointer(l.lineDistance,1,Ge.FLOAT,!1,0,0))}if(mt.disableUnusedAttributes(),o instanceof t.Mesh){var m=i.__typeArray===Uint32Array?Ge.UNSIGNED_INT:Ge.UNSIGNED_SHORT;a.wireframe?(mt.setLineWidth(a.wireframeLinewidth*be),u&&Ge.bindBuffer(Ge.ELEMENT_ARRAY_BUFFER,i.__webglLineBuffer),Ge.drawElements(Ge.LINES,i.__webglLineCount,m,0)):(u&&Ge.bindBuffer(Ge.ELEMENT_ARRAY_BUFFER,i.__webglFaceBuffer),Ge.drawElements(Ge.TRIANGLES,i.__webglFaceCount,m,0))}else if(o instanceof t.Line){var _=o.mode===t.LineStrip?Ge.LINE_STRIP:Ge.LINES;mt.setLineWidth(a.linewidth*be),Ge.drawArrays(_,0,i.__webglLineCount)}else o instanceof t.PointCloud&&Ge.drawArrays(Ge.POINTS,0,i.__webglPointCount)}},this.render=function(e,n,r,a,i){if(n instanceof t.Camera!=0){Qe="",Ke=-1,Ze=null,void 0!==i&&(Ne.length=0,ct=!0);var o=e.fog;!0===e.autoUpdate&&e.updateMatrixWorld(),void 0===n.parent&&n.updateMatrixWorld(),n.matrixWorldInverse.getInverse(n.matrixWorld),n.worldUpTransform?ut.multiplyMatrices(n.worldUpTransform,n.matrixWorld):ut.copy(n.matrixWorld),lt.multiplyMatrices(n.projectionMatrix,n.matrixWorldInverse),st.setFromMatrix(lt);var s=e instanceof _&&e.renderImmediate;if(s||(Be.length=0,ze.length=0,E(e,!0===qe.sortObjects,!0===e.forceVisible),!0===qe.sortObjects&&(Be.sort(S),ze.sort(M))),ct&&(i&&i.length&&(Ne=i.slice()),de(Ne)),this.setRenderTarget(r),this.resetGLState(),(this.autoClear||a)&&this.clear(this.autoClearColor,this.autoClearDepth,this.autoClearStencil),e.overrideMaterial){var l=e.overrideMaterial;X(l),s?D(e,0,n,Ne,o,l):(L(Be,n,Ne,o,l),L(ze,n,Ne,o,l))}else s?D(e,0,n,Ne,o,null):(mt.setBlending(t.NoBlending),L(Be,n,Ne,o,null),L(ze,n,Ne,o,null));r&&r.generateMipmaps&&r.minFilter!==t.NearestFilter&&r.minFilter!==t.LinearFilter&&_e(r),this.resetGLState(),mt.setDepthTest(!0),mt.setDepthWrite(!0)}else t.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.")},this.clearBlend=function(){mt.setBlending(t.NoBlending)},this.setProgramPrefix=function(e,t,n){Je=e,$e=t,et=n},this.getProgramPrefix=function(){return{programPrefix:Je,vertexPrefix:$e,fragmentPrefix:et}};var jt,Xt,Yt,Kt,Zt={},Qt=0,Jt={MeshDepthMaterial:"depth",MeshNormalMaterial:"normal",MeshBasicMaterial:"firefly_basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"firefly_phong",LineBasicMaterial:"firefly_basic",LineDashedMaterial:"dashed",PointCloudMaterial:"firefly_basic"};this.setFaceCulling=function(e,n){e===t.CullFaceNone?Ge.disable(Ge.CULL_FACE):(n===t.FrontFaceDirectionCW?Ge.frontFace(Ge.CW):Ge.frontFace(Ge.CCW),e===t.CullFaceBack?Ge.cullFace(Ge.BACK):e===t.CullFaceFront?Ge.cullFace(Ge.FRONT):Ge.cullFace(Ge.FRONT_AND_BACK),Ge.enable(Ge.CULL_FACE))},this.setMaterialFaces=function(e){mt.setDoubleSided(e.side===t.DoubleSide),mt.setFlipSided(e.side===t.BackSide)},this.uploadTexture=function(e){void 0===e.__webglInit&&(e.__webglInit=!0,e.addEventListener("dispose",Vt),e.__webglTexture=Ge.createTexture(),qe.info.memory.textures++),Ge.bindTexture(Ge.TEXTURE_2D,e.__webglTexture),Ge.pixelStorei(Ge.UNPACK_FLIP_Y_WEBGL,e.flipY),Ge.pixelStorei(Ge.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e.premultiplyAlpha),Ge.pixelStorei(Ge.UNPACK_ALIGNMENT,e.unpackAlignment),e.image=pe(e.image,wt);var n=e.image,r=t.Math.isPowerOfTwo(n.width)&&t.Math.isPowerOfTwo(n.height),a=ge(e.format),i=ge(e.type);ce(Ge.TEXTURE_2D,e,r);var o,s,l,u=e.mipmaps;if(e instanceof t.DataTexture)if(u.length>0&&r){for(s=0,l=u.length;s<l;s++)o=u[s],Ge.texImage2D(Ge.TEXTURE_2D,s,a,o.width,o.height,0,a,i,o.data);e.generateMipmaps=!1}else Ge.texImage2D(Ge.TEXTURE_2D,0,a,n.width,n.height,0,a,i,n.data);else if(e instanceof t.CompressedTexture){for(s=0,l=u.length;s<l;s++)o=u[s],e.format!==t.RGBAFormat&&e.format!==t.RGBFormat?Ct().indexOf(a)>-1?Ge.compressedTexImage2D(Ge.TEXTURE_2D,s,a,o.width,o.height,0,o.data):t.warn("Attempt to load unsupported compressed texture format"):Ge.texImage2D(Ge.TEXTURE_2D,s,a,o.width,o.height,0,a,i,o.data);if(u.length>1&&Ct().indexOf(a)>-1)for(var f,d=o.width>>1,c=o.height>>1,p=u.length;d>=1||c>=1;)f=4==o.width&&4==o.height?o.data:new DataView(o.data.buffer,o.data.byteOffset,o.data.byteLength*(Math.max(d,4)*Math.max(c,4))/(o.width*o.height)),Ge.compressedTexImage2D(Ge.TEXTURE_2D,p,a,Math.max(d,1),Math.max(c,1),0,f),d>>=1,c>>=1,++p}else if(u.length>0&&r){for(s=0,l=u.length;s<l;s++)o=$l(u[s]),Ge.texImage2D(Ge.TEXTURE_2D,s,a,a,i,o);e.generateMipmaps=!1}else Ge.texImage2D(Ge.TEXTURE_2D,0,a,a,i,$l(e.image));e.generateMipmaps&&r&&Ge.generateMipmap(Ge.TEXTURE_2D),e.needsUpdate=!1,e.onUpdate&&e.onUpdate()},this.setTexture=function(e,t){Ge.activeTexture(Ge.TEXTURE0+t),e.needsUpdate?qe.uploadTexture(e):e.__webglTexture?Ge.bindTexture(Ge.TEXTURE_2D,e.__webglTexture):Ge.bindTexture(Ge.TEXTURE_2D,It.__webglTexture)},qe.uploadTexture(It),this.initFrameBufferMRT=function(e,n){var r=e[0],a=!1;if(r&&!r.__webglFramebuffer){void 0===r.depthBuffer&&(r.depthBuffer=!0),void 0===r.stencilBuffer&&(r.stencilBuffer=!0),r.__webglFramebuffer=Ge.createFramebuffer(),Ge.bindFramebuffer(Ge.FRAMEBUFFER,r.__webglFramebuffer);var i;r.shareDepthFrom?i=r.__webglRenderbuffer=r.shareDepthFrom.__webglRenderbuffer:(i=r.__webglRenderbuffer,r.depthBuffer&&!r.stencilBuffer?(i||(i=r.__webglRenderbuffer=Ge.createRenderbuffer()),Ge.bindRenderbuffer(Ge.RENDERBUFFER,i),Ge.renderbufferStorage(Ge.RENDERBUFFER,Ge.DEPTH_COMPONENT16,r.width,r.height)):r.depthBuffer&&r.stencilBuffer&&(i||(i=r.__webglRenderbuffer=Ge.createRenderbuffer()),Ge.bindRenderbuffer(Ge.RENDERBUFFER,i),Ge.renderbufferStorage(Ge.RENDERBUFFER,Ge.DEPTH_STENCIL,r.width,r.height))),r.depthBuffer&&!r.stencilBuffer?Ge.framebufferRenderbuffer(Ge.FRAMEBUFFER,Ge.DEPTH_ATTACHMENT,Ge.RENDERBUFFER,i):r.depthBuffer&&r.stencilBuffer&&Ge.framebufferRenderbuffer(Ge.FRAMEBUFFER,Ge.DEPTH_STENCIL_ATTACHMENT,Ge.RENDERBUFFER,i),a=!0}var o=Ye;Ge.bindFramebuffer(Ge.FRAMEBUFFER,r.__webglFramebuffer);var s;for(s=0;s<e.length;s++){var l=e[s];if(l&&!l.__webglTexture){var u=t.Math.isPowerOfTwo(l.width)&&t.Math.isPowerOfTwo(l.height),f=ge(l.format),d=ge(l.type);l.addEventListener("dispose",Bt),l.__webglTexture=Ge.createTexture(),qe.info.memory.textures++,Ge.bindTexture(Ge.TEXTURE_2D,l.__webglTexture),ce(Ge.TEXTURE_2D,l,u),Ge.texImage2D(Ge.TEXTURE_2D,0,f,l.width,l.height,0,f,d,null),u&&l.generateMipmaps&&Ge.generateMipmap(Ge.TEXTURE_2D)}Ge.framebufferTexture2D(Ge.FRAMEBUFFER,Ge.COLOR_ATTACHMENT0+s,Ge.TEXTURE_2D,l&&l.__webglTexture,0)}if(this.supportsMRT()){for(var c=Ge.getParameter(ke.MAX_COLOR_ATTACHMENTS_WEBGL);s<c;)Ge.framebufferTexture2D(Ge.FRAMEBUFFER,Ge.COLOR_ATTACHMENT0+s,Ge.TEXTURE_2D,null,0),s++;var p=[ke.COLOR_ATTACHMENT0_WEBGL];for(s=1;s<e.length;s++)p.push(ke.COLOR_ATTACHMENT0_WEBGL+s);ke.drawBuffersWEBGL(p)}if(n){var h=Ge.checkFramebufferStatus(Ge.FRAMEBUFFER);h!==Ge.FRAMEBUFFER_COMPLETE&&(t.log("Can't use multiple render targets. Falling back to two passes. "+h),o===r.__webglFramebuffer&&(o=Ye=null),Ge.bindFramebuffer(Ge.FRAMEBUFFER,o),Ge.deleteFramebuffer(r.__webglFramebuffer),delete r.__webglFramebuffer,n=!1)}return Ge.bindFramebuffer(Ge.FRAMEBUFFER,o),a&&(Ge.bindTexture(Ge.TEXTURE_2D,null),Ge.bindRenderbuffer(Ge.RENDERBUFFER,null),Ge.bindFramebuffer(Ge.FRAMEBUFFER,null)),n},this.setRenderTarget=function(e){var t;if(Array.isArray(e))this.initFrameBufferMRT(e),t=e[0];else if(e){var n=e.__webglFramebuffer;n&&Ye===n||this.initFrameBufferMRT([e]),t=e}var r,a,i,o,s;t?(r=t.__webglFramebuffer,a=t.width,i=t.height,o=0,s=0):(r=null,a=at,i=it,o=nt,s=rt),r!==Ye&&(Ge.bindFramebuffer(Ge.FRAMEBUFFER,r),Ge.viewport(o,s,a,i),Ye=r)},this.verifyMRTWorks=function(e){return!!this.supportsMRT()&&this.initFrameBufferMRT(e,!0)},this.readRenderTargetPixels=function(e,n,r,a,i,o){if(e instanceof t.WebGLRenderTarget){if(e.__webglFramebuffer){var s=!1;if(e.__webglFramebuffer!==Ye&&(Ge.bindFramebuffer(Ge.FRAMEBUFFER,e.__webglFramebuffer),s=!0),e.canReadPixels||Ge.checkFramebufferStatus(Ge.FRAMEBUFFER)===Ge.FRAMEBUFFER_COMPLETE){var l={};if(o=function(e,n,r,a,i){n.format=Ge.RGBA,n.type=Ge.UNSIGNED_BYTE;var o={format:t.RGBAFormat,type:t.UnsignedByteType,align:Ge.getParameter(Ge.PACK_ALIGNMENT)},s=Uint8Array,l=4,u=1;if(e.type!=t.UnsignedByteType||e.format!==t.RGBAFormat&&e.format!==t.RGBFormat){if(Ge.getError(),n.format=Ge.getParameter(Ge.IMPLEMENTATION_COLOR_READ_FORMAT),Ge.getError()!=Ge.NO_ERROR)return null;if(n.type=Ge.getParameter(Ge.IMPLEMENTATION_COLOR_READ_TYPE),Ge.getError()!=Ge.NO_ERROR)return null;switch(n.type){case Ge.FLOAT:s=Float32Array,o.type=t.FloatType,u=4;break;case Ge.UNSIGNED_SHORT_5_6_5:s=Uint16Array,o.type=t.UnsignedShort565Type,u=2;break;case Ge.UNSIGNED_SHORT_4_4_4_4:s=Uint16Array,o.type=t.UnsignedShort4444Type,u=2;break;case Ge.UNSIGNED_SHORT_5_5_5_1:s=Uint16Array,o.type=t.UnsignedShort5551Type,u=2;break;case Ge.UNSIGNED_BYTE:s=Uint8Array,o.type=t.UnsignedByteType,u=1;break;default:var f=_t.get("OES_texture_half_float");if(!f||n.type!=f.HALF_FLOAT_OES)return null;s=Uint16Array,o.type=t.HalfFloatType,u=2}switch(n.format){case Ge.LUMINANCE:l=1,o.format=t.LuminanceFormat;break;case Ge.LUMINANCE_ALPHA:l=2,o.format=t.LuminanceAlphaFormat;break;case Ge.ALPHA:l=1,o.format=t.AlphaFormat;break;case Ge.RGB:o.format=t.RGBFormat,l=3;break;case Ge.RGBA:o.format=t.RGBAFormat,l=4;break;default:return null}}var d=l*r*u;return d=(d+o.align-1&~(o.align-1))/u,d*=a,i?i instanceof s&&i.length>=d?i:null:(i=new s(d),i.lmv__format=o,i)}(e,l,a,i,o)){Ge.readPixels(n,r,a,i,l.format,l.type,o);var u;(u=Ge.getError())!=Ge.NO_ERROR&&(o=null,t.error("THREE.WebGLRenderer.readRenderTargetPixels: readPixels from renderTarget failed. readPixels error "+u))}else t.error("THREE.WebGLRenderer.readRenderTargetPixels: readPixels from renderTarget failed. Buffer format is invalid.")}else t.error("THREE.WebGLRenderer.readRenderTargetPixels: readPixels from renderTarget failed. Framebuffer not complete.");return s&&Ge.bindFramebuffer(Ge.FRAMEBUFFER,Ye),o}return null}t.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.")}},e.ModelIteratorLinear=_d,e.ConsolidationIterator=dt,e.ModelIteratorBVH=ct,e.BufferGeometryUtils=nf,e.RenderScene=function(){function e(e,t){void 0===e.avgFrameTime?e.avgFrameTime=t:e.avgFrameTime=.8*e.avgFrameTime+.2*t}function n(t,n,r){var a,i;for(a=0;a<t.length;a++)(i=t[a]).cameraDistance=i.boundingBox.distanceToPoint(n.position);t.sort(function(e,t){return t.cameraDistance-e.cameraDistance});var o=performance.now();for(a=0;a<t.length;a++){r(i=t[a]);var s=performance.now(),l=s-o;o=s,e(i,l)}}function r(e,t){for(var n=0;n<e.length;n++){var r=e[n];if(r&&r.id===t)return r}return null}var a=!1,i=!1,o=0,s=[],l=[],u=[],f=new t.Box3,d=[],c=new Yu,p=new t.Raycaster,h=performance,m=lu;this.enableNonResumableFrames=!1,this.budgetForTransparent=.1;var _=!1,v=[],g=null;this.frustum=function(){return c},this.addModel=function(e){s.push(e),l.length=s.length,u.length=s.length},this.removeModel=function(e){var t=s.indexOf(e);return t>=0&&s.splice(t,1),l.length=s.length,u.length=s.length,t>=0},this.addHiddenModel=function(e){var t=d.indexOf(e);return t<0&&d.push(e),t<0},this.removeHiddenModel=function(e){var t=d.indexOf(e);return t>=0&&d.splice(t,1),t>=0},this.isEmpty=function(){return 0===s.length},this.needsRender=function(){return a},this.resetNeedsRender=function(){a=!1},this.frameResumePossible=function(){return!_},this.renderSome=function(t,r,f){for(var d,c,p=h.now(),y=0===o,x=this.budgetForTransparent*r;;){for(var b=0,w=null,M=0;M<l.length;M++){var S=l[M];c=s[M],S||(l[M]=S=c.nextBatch()),_&&r<x&&S&&!S.sortObjects&&(c.skipOpaqueShapes(),S=c.nextBatch()),null!==S&&(w||(b=M,w=S),S.renderImportance>w.renderImportance&&(b=M,w=S))}if(!w){i=!0;for(var T=0;T<s.length;++T)if((c=s[T])&&c.is2d()&&!c.isLoadDone()&&!c.getFragmentList().onDemandLoadingEnabled()){i=!1;break}break}if(s[b].is2d()&&s[b].getFragmentList()&&s[b].getFragmentList().onDemandLoadingEnabled()){var A=u[b];w.drawOrderRender=A&&A.drawOrderRender<A.lastItem?w.start:w.lastItem,u[b]=w}if(l[b]=s[b].nextBatch(),o++,w.sortObjects&&_)v.push(w),r-=void 0===w.avgFrameTime?.05:w.avgFrameTime;else{t(w),w.hasOwnProperty("drawEnd")&&(w.drawEnd=w.lastItem);var E=(d=h.now())-p;p=d,e(w,E),r-=w.avgFrameTime}if(s[b].getFragmentList()&&s[b].getFragmentList().onDemandLoadingEnabled())for(var R,L=w.start,P=w.lastItem,I=s[b].getFragmentList().vizflags,C=w.getIndices();L<P;)I[R=C?C[L]:L]&mu&&(I[R]=(I[R]|hu)&~mu),++L;if(r<=0)break}var D=s[0].frameUpdatePaging(y,f);return(m!=D||s[0].needResumeNextFrame())&&(a=!0,m=D),v.length>0&&(n(v,g,t),v.length=0),r},this.reset=function(e,t,n,r){if(i=!1,o=0,this.resetNeedsRender(),c.reset(e),c.areaCullThreshold=ou,s.length){_=this.enableNonResumableFrames&&n==yu&&t===uu,g=e;for(var a=0;a<s.length;a++)s[a].resetIterator(e,c,t,n,r),l[a]=s[a].nextBatch(),u[a]=null}},this.isDone=function(){return i||this.isEmpty()},this.setAllVisibility=function(e){for(var t=0;t<s.length;t++)s[t].setAllVisibility(e)},this.hideLines=function(e){for(var t=0;t<s.length;t++)s[t].hideLines(e)},this.hidePoints=function(e){for(var t=0;t<s.length;t++)s[t].hidePoints(e)},this.hasHighlighted=function(){for(var e=0;e<s.length;e++)if(s[e].hasHighlighted())return!0;return!1},this.areAllVisible=function(){for(var e=0;e<s.length;e++)if(!s[e].areAllVisible())return!1;return!0},this.invalidateVisibleBounds=function(){for(var e=0;e<s.length;e++)s[e].visibleBoundsDirty=!0},this.getVisibleBounds=function(e){if(1===s.length)return s[0].getVisibleBounds(e);f.makeEmpty();for(var t=0;t<s.length;t++)f.union(s[t].getVisibleBounds(e));return f},this.findModel=function(e){return r(s,e)},this.findHiddenModel=function(e){return r(d,e)},this.rayIntersect=function(e,t,n,r,a,i){p.set(e,t);var o;if(s.length>1){var l=[];if(a)for(o=0;o<a.length;o++){var u=this.findModel(a[o]);u&&u.rayIntersect(p,n,[r[o]])}else for(o=0;o<s.length;o++)if(!s[o].is2d()){var f=s[o].rayIntersect(p,n,r,i);f&&l.push(f)}return l.length?(l.sort(function(e,t){return e.distance-t.distance}),l[0]):null}return!s.length||s[0].is2d()?null:s[0].rayIntersect(p,n,r,i)},this.getRenderProgress=function(){return s[0].getRenderProgress()},this.getModels=function(){return s},this.getHiddenModels=function(){return d},this.getFragmentList=function(){return s[0].getFragmentList()},this.getGeometryList=function(){return s[0].getGeometryList()},this.getSceneCount=function(){return s[0].getSceneCount()},this.getGeomScenes=function(){return s[0].getGeomScenes()},this.geomPacksMissingLastFrame=function(){return s[0].geomPacksMissingLastFrame()},this.explode=function(e){if(s.length){for(var n=new t.Vector3,r=0;r<s.length;r++){var a=s[r],i=a.getData().instanceTree,o=a.getFragmentList(),l=a.getVisibleBounds(!0).center();if(e*=2,i&&i.nodeAccess.nodeBoxes&&0!==e){var u=e*(i.maxDepth-1)+1,f=0|u,d=u-f,c=new Float32Array(6);!function t(r,a,s,l,u,p,h,m){var _=2*e;a==f&&(_*=d),i.getNodeBox(r,c);var v=.5*(c[0]+c[3]),g=.5*(c[1]+c[4]),y=.5*(c[2]+c[5]);a>0&&a<=f&&(p+=(v-s)*_,h+=(g-l)*_,m+=(y-u)*_),i.enumNodeChildren(r,function(e){t(e,a+1,v,g,y,p,h,m)},!1),n.x=p,n.y=h,n.z=m,i.enumNodeFragments(r,function(e){o.updateAnimTransform(e,null,null,n)},!1)}(i.getRootId(),0,l.x,l.y,l.x,0,0,0)}else for(var p=o.fragments.boxes,h=0,m=o.getCount();h<m;h++)if(0==e)o.updateAnimTransform(h);else{var _=6*h,v=.5*(p[_]+p[_+3]),g=.5*(p[_+1]+p[_+4]),y=.5*(p[_+2]+p[_+5]);n.x=e*(v-l.x),n.y=e*(g-l.y),n.z=e*(y-l.z),o.updateAnimTransform(h,null,null,n)}}this.invalidateVisibleBounds()}},this.update=function(e){for(var t=!1,n=0;n<s.length;n++){var r=s[n];t=t||r.update(e)}return t},this.hideModel=function(e){for(var t=0;t<s.length;t++){var n=s[t];if(n&&n.id===e)return this.removeModel(n),d.push(n),!0}return!1},this.showModel=function(e){for(var t=0;t<d.length;++t){var n=d[t];if(n&&n.id===e)return this.addModel(n),d.splice(t,1),!0}return!1},this.getMemoryInfo=function(){function e(e){for(var r=0;r<e.length;++r){var a=e[r].getMemoryInfo();a&&(t=a,n.limit+=a.limit,n.effectiveLimit+=a.effectiveLimit,n.loaded+=a.loaded)}}var t,n={limit:0,effectiveLimit:0,loaded:0};return e(s),e(d),t?n:null}},e.SortedList=xd,e.RenderModel=At,e.MaterialConverter=Ef,e.MaterialManager=Pf,e.SvfLoader=Zc,e.TextureLoader=Hc,e.OtgLoader=sp,e.OtgGeomCache=An,e.DEBUG_SHADERS=!1,e.WebGLShader=bu,e.consolidateFragmentList=ft,e.copyVertexFormat=ke,e.copyPrimitiveProps=He,e.mergeGeometries=je,e.Consolidation=Ye,e.ConsolidationBuilder=Ke,e.registerWorkerSupport=Qe,e.multithreadingSupported=Je,e.ConsolidationUtils=Uf,e.isIOSDevice=jl,e.isAndroidDevice=Xl,e.isMobileDevice=Yl,e.isChrome=Kl,e.isSafari=Zl,e.isFirefox=function(){return-1!==ql.indexOf("firefox")},e.isMac=function(){return-1!==ql.indexOf("mac os")},e.isWindows=Ql,e.isNodeJS=Jl,e.rescueFromPolymer=$l,e.pathToURL=eu,e.clearAssets=tu,e.MODEL_ROOT_LOADED_EVENT="svfLoaded",e.MODEL_UNLOADED_EVENT=nu,e.LOAD_MISSING_GEOMETRY="loadMissingGeometry",e.FRAGMENTS_LOADED_EVENT="fragmentLoaded",e.FILE_LOAD_STARTED="fileLoadStarted",e.GEOMETRY_DOWNLOAD_COMPLETE="geometryDownloadComplete",e.OBJECT_TREE_CREATED_EVENT="propertyDbLoaded",e.OBJECT_TREE_UNAVAILABLE_EVENT="propertyDbUnavailable",e.TEXTURES_LOADED_EVENT="texturesLoaded",e.setMemoryOptimizedLoading=ru,e.GPU_MEMORY_LIMIT=au,e.GPU_OBJECT_LIMIT=iu,e.GEOMETRY_OVERHEAD=464,e.PIXEL_CULLING_THRESHOLD=ou,e.PAGEOUT_SUCCESS=0,e.PAGEOUT_FAIL=su,e.PAGEOUT_NONE=lu,e.RENDER_NORMAL=uu,e.RENDER_HIGHLIGHTED1=1,e.RENDER_HIGHLIGHTED2=2,e.RENDER_HIDDEN=3,e.RENDER_SHADOWMAP=4,e.RENDER_FINISHED=5,e.GROUND_UNFINISHED=0,e.GROUND_FINISHED=1,e.GROUND_RENDERED=2,e.MESH_VISIBLE=fu,e.MESH_HIGHLIGHTED=du,e.MESH_HIDE=cu,e.MESH_ISLINE=8,e.MESH_MOVED=pu,e.MESH_TRAVERSED=hu,e.MESH_DRAWN=mu,e.MESH_RENDERFLAG=_u,e.MESH_ISPOINT=256,e.MESH_ISWIDELINE=512,e.DB_ID=0,e.FRAGMENT_ID=1,e.RESET_NORMAL=vu,e.RESET_REDRAW=gu,e.RESET_RELOAD=yu,e.POSTPROC_STYLE_OFF=0,e.POSTPROC_STYLE_EDGING=1,e.POSTPROC_STYLE_CEL=2,e.POSTPROC_STYLE_GRAPHITE=3,e.POSTPROC_STYLE_PENCIL=4,e.CreateCubeMapFromColors=function(e,n){for(var r=255*e.x,a=255*e.y,i=255*e.z,o=255*n.x,s=255*n.y,l=255*n.z,u=new Uint8Array(16),f=new Uint8Array(16),d=new Uint8Array(16),c=0;c<4;c++)u[4*c]=r,u[4*c+1]=a,u[4*c+2]=i,u[4*c+3]=255,f[4*c]=o,f[4*c+1]=s,f[4*c+2]=l,f[4*c+3]=255,c>1?(d[4*c]=r,d[4*c+1]=a,d[4*c+2]=i,d[4*c+3]=255):(d[4*c]=o,d[4*c+1]=s,d[4*c+2]=l,d[4*c+3]=255);var p=new t.DataTexture(d,2,2,t.RGBAFormat),h=new t.DataTexture(d,2,2,t.RGBAFormat),m=new t.DataTexture(f,2,2,t.RGBAFormat),_=new t.DataTexture(u,2,2,t.RGBAFormat),v=new t.DataTexture(d,2,2,t.RGBAFormat),g=new t.DataTexture(d,2,2,t.RGBAFormat),y=new t.Texture(null,t.CubeReflectionMapping,t.RepeatWrapping,t.RepeatWrapping,t.LinearFilter,t.LinearFilter,t.RGBAFormat);return y.image=[h,p,_,m,g,v],y.needsUpdate=!0,y},e.CutPlanesUniforms=ks,e.IdUniforms=Hs,e.ThemingUniform=Ws,e.ShadowMapCommonUniforms=qs,e.ShadowMapUniforms=js,e.PointSizeUniforms=Xs,e.WideLinesUniforms=Ys,e.DepthTextureUniforms=Ks,e.GetPrismMapSampleChunk=a,e.GetPrismMapUniformChunk=i,e.resolve=el,e.PackDepthShaderChunk=tl,e.TonemapShaderChunk=nl,e.OrderedDitheringShaderChunk=rl,e.CutPlanesShaderChunk=al,e.PackNormalsShaderChunk=il,e.HatchPatternShaderChunk=ol,e.EnvSamplingShaderChunk=sl,e.IdVertexDeclaration=ll,e.IdVertexShaderChunk=ul,e.IdFragmentDeclaration=fl,e.IdOutputShaderChunk=dl,e.FinalOutputShaderChunk=cl,e.ThemingFragmentDeclaration=pl,e.ThemingFragmentShaderChunk=hl,e.InstancingVertexDeclaration=ml,e.ShadowMapDeclareCommonUniforms=_l,e.ShadowMapVertexDeclaration=vl,e.ShadowMapVertexShaderChunk=gl,e.ShadowMapFragmentDeclaration=yl,e.PointSizeDeclaration=xl,e.PointSizeShaderChunk=bl,e.ShaderChunks=wl,e.SAOMinifyFirstShader=Fd,e.SAOMinifyShader=Vd,e.LineStyleDefs=lf,e.CreateLinePatternTexture=uf,e.LineStyleDef=ff,e.FloatToHalf=Hd,e.HalfToFloat=Wd,e.HALF_INT_MAX=59390,e.IntToHalf=qd,e.HalfToInt=jd,e.HalfTest=Xd,e.HalfFloat=Yd,e.createShaderMaterial=Vl,e.setMacro=Bl,e.removeMacro=zl,e.ShaderUtils=Gl,e.createGroundShape=et,e.setGroundShapeTransform=Xf,e.GroundShadow=Yf,e.GroundShadowUtils=Kf,e.PrismMaps=Bf,e.GetPrismMapChunk=zf,e.WebGLProgram=Gf,e.WebGLProgramUtils=kf,e.GetPrismMapUniforms=D,e.PrismShader=df,e.createPrismMaterial=cf,e.clonePrismMaterial=pf,e.PrismShaderUtils=hf,e.ShadowMapShader=Zf,e.GroundShadowShader=Qf,e.ShadowMapOverrideMaterials=Jf,e.ShadowConfig=$f,e.SHADOWMAP_NEEDS_UPDATE=ed,e.SHADOWMAP_INCOMPLETE=td,e.SHADOWMAP_VALID=nd,e.ShadowMaps=nt,e.ShadowRender=ad,e.ShadowMapUtils=id,e.FrustumIntersector=Yu,e.OUTSIDE=0,e.INTERSECTS=1,e.CONTAINS=2,e.CONTAINMENT_UNKNOWN=-1,e.FragmentList=pt,e.FragmentPointer=vt,e.FragmentListUtils=wd,e.TileCoords=gt,e.tile2Index=Md,e.index2Tile=Sd,e.TileUtils=Td,e.TexQuadConfig=Mt,e.ModelIteratorTexQuad=St,e.ModelIteratorTexQuadUtils=Cd,e.LeafletDiffModes=Qd,e.LeafletDiffIterator=function(e,n){function r(){return 0!==w.x||0!==w.y}function a(e,t,n){n.position[e](w),n.target[e](w),n.updateMatrixWorld(!0),n.matrixWorldInverse.getInverse(n.matrixWorld),t.reset(n)}function i(e,t,n){var r=e.clone();r.position.z=t;var a={texture1:{type:"t",value:e.material.map},model:{type:"i",value:n},splitPosition:{type:"f",value:M*window.innerWidth*E}},i=L===Qd.SPLIT_VIEW,o=b.acquireShaderMaterial(a,"nonintersect"+(i?"split":""));return o.defines.SINGLE_MODEL=1,i&&(o.defines.SPLIT_VIEW=1),r.material=o,_.add(r),r}function o(e,t,n,r){e.offsetX=t.offsetX+(r.l-n.l)/n.width()*t.scaleX,e.offsetY=t.offsetY+(r.b-n.b)/n.height()*t.scaleY,e.scaleX=t.scaleX*r.width()/n.width(),e.scaleY=t.scaleY*r.height()/n.height()}function s(e,n,r,a,i){var s=e.rect,l=r.getIntersection(s);if(l){e.intersecStatus=I,e.intersec.union(l);var u=e.material.map,f=n.clone(),d=new yt,c=f.geometry.uvTransform;l.equals(r)?(c.copyTo(d),l.equals(s)&&(e.intersecStatus=C)):(o(d,c,r,l),f.geometry=x.acquireQuadGeom(d));var p=new yt;o(p,e.geometry.uvTransform,s,l),f.position.set(l.l,l.b,0),f.scale.set(l.width(),l.height(),1);var h=new t.Vector2,m=new t.Vector2;S&&(h.x=1/(1|a.image.width*E),h.y=1/(1|a.image.height*E),m.x=1/(1|u.image.width*E),m.y=1/(1|u.image.height*E));var v={texture1:{type:"t",value:a},texture2:{type:"t",value:u},uvTFa:{type:"v4",value:d.toVec4()},uvTFb:{type:"v4",value:p.toVec4()},highlight:{type:"i",value:i?T:A},splitPosition:{type:"f",value:M*window.innerWidth*E},resolution1:{type:"v2",value:h},resolution2:{type:"v2",value:m}},g=L===Qd.SPLIT_VIEW,y=b.acquireShaderMaterial(v,"intersection"+(g?"split":""));return g&&(y.defines.SPLIT_VIEW=1),S&&(y.defines.ADD_THICKENING=1),f.material=y,_.add(f),l}return null}function l(e){for(var n=0;n<e.children.length;n++){var r=e.children[n];r.intersecStatus=P,r.intersec=new Et;var a=new t.Vector3;a.addVectors(r.position,w);var i=r.scale;r.rect=new Et(a.x,a.y,a.x+i.x,a.y+i.y)}}function u(e,t){var n=r();R=.5*(t.far-t.near);var i=h.reset(e,t);n&&a("sub",e,t);var o=m.reset(e,t);return n&&a("add",e,t),f(!i||!o),i&&o}function f(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=h.getScene(),n=m.getScene();l(n);for(var r=0;r<t.children.length;r++){for(var a=P,o=t.children[r],u=o.tile,f=o.material.map,d=o.material.tile,c=o.position,p=o.scale,_=new Et(c.x,c.y,c.x+p.x,c.y+p.y),v=new Et,g=r<n.children.length?r:0,y=n.children.length,x=g;x<y;x++){var b=(A=n.children[x]).tile,M=A.material.tile,S=s(A,o,_,f,e&&(M.level!==d.level||u.level!==b.level||d.level<u.level||M.level<b.level));if(S&&(a=A.intersecStatus,v.union(S),a===C))break;g>0&&x===y-1&&(y=g,g=0,x=-1)}(a===P||a===I&&!_.equals(v))&&i(o,-.2*R,1)}for(var T=0;T<n.children.length;T++){var A=n.children[T];(A.intersecStatus===P||A.intersecStatus===I&&!A.rect.equals(A.intersec))&&i(A,-.1*R,2).position.add(w)}}function d(e,t){h.reset(e,t),_=h.getScene().clone()}function c(e,t){var n=r();n&&a("sub",e,t),m.reset(e,t),(_=m.getScene().clone()).position.copy(w),n&&a("add",e,t)}function p(e,t){u(e,t)}var h=e,m=n,_=new t.Scene,v=!0,g=!1,y=!0,x=new xt,b=new Rt,w=new t.Vector3,M=.5,S=!1,T=0,A=3,E=window.devicePixelRatio||1,R=0,L=Qd.NORMAL_DIFF,P=0,I=1,C=2;this.setDiffMode=function(e){L=e,g=!0},this.getDiffMode=function(){return L},this.getOffset=function(){return w},this.setOffset=function(e){w=e},this.setSplitPosition=function(e){M=e},this.rayCast=function(e,t){return null},this.getVisibleBounds=function(e,n){var r=new t.Box3,a=new t.Box3;h.getVisibleBounds(r,a),m.getVisibleBounds(e,n),e.union(r),n.union(a)};var D=0,N=0,O=!0;this.updateProgress=function(e){if(e)this.onProgress(100),D=0,O=!0;else{if(O)N=Date.now(),D=10,O=!1;else{var t=Date.now();D+=(D>60?10:5)*(t-N)/250,D=Math.min(95,D),N=t}this.onProgress(D)}},this.reset=function(e,t){v=!1;for(var n=0;n<_.children.length;n++)_.children[n].dispatchEvent({type:"removed"});_.children.length=0,_.position.set(0,0,0),x.reset(),b.reset();var r=!0;switch(L){case Qd.NORMAL_DIFF:A=3,r=u(e,t);break;case Qd.MODEL_A_ONLY:d(e,t);break;case Qd.MODEL_B_ONLY:c(e,t);break;case Qd.SPLIT_VIEW:p(e,t);break;case Qd.HIGHLIGHT_A:A=1,r=u(e,t);break;case Qd.HIGHLIGHT_B:A=2,r=u(e,t)}y?r&&(this.onFirstSceneComplete&&this.onFirstSceneComplete(),y=!1):this.onProgress&&this.updateProgress(r)},this.nextBatch=function(){return v?null:(v=!0,_)},this.getScene=function(){return _},this.getSceneCount=function(){return 1},this.done=function(){return v},this.update=function(){return g?(g=!1,!0):h.update()||m.update()},this.dispose=function(){b.dispose(),x.dispose()},this.dtor=function(){this.dispose()}},e.SelectionMode=Jd,e.InstanceTree=Lt,e.DbidFragmentMap=Pt,e.InstanceTreeStorage=It,e.InstanceTreeAccess=Dt,e.NodeArray=Nt,e.BVHModule=uc,e.BVHBuilder=Ut,e.workerScript=fc,e.loadWorker=function(e,t,n){var r=e&&fc.webWorkerClass||!fc.mainThreadClass?fc.webWorkerClass:fc.mainThreadClass;return r?new r(t,!!n):null},e.setLogger=function(t){e.logger=t},e.errorCodeString=Ft,e.getErrorCode=function(t){return 403===t||401===t?e.ErrorCodes.NETWORK_ACCESS_DENIED:404===t?e.ErrorCodes.NETWORK_FILE_NOT_FOUND:t>=500?e.ErrorCodes.NETWORK_SERVER_ERROR:e.ErrorCodes.NETWORK_UNHANDLED_RESPONSE_CODE},e.LmvVector3=Nu,e.LmvMatrix4=Ad,e.LmvBox3=Ou,e.ViewingService=mc,e.textToArrayBuffer=kt,e.FileLoader=gc,e.clearPropertyWorkerCache=function(){vc&&vc.doOperation({operation:wc,clearCaches:!0})},e.PropDbLoader=Tc,e.DecodeEnvMap=Lc,e.getTransferables=Zt,e.DecodeEnvMapAsync=function(n,r,a,i,o){if(r.LogLuv){Pc||(Pc=n.createWorker());var s=Ic++;Pc.addEventListener("message",function e(n){if(n.data.id===s){Pc.removeEventListener("message",e);var a=n.data.map;r.image=a.image,r.LogLuv=!1,i?(r.type=t.HalfFloatType,r.format=t.RGBFormat,r.RGBM=!1,r.GammaEncoded=!0):r.RGBM=!0,o(r)}}),Pc.doOperation({operation:"DECODE_ENVMAP",map:r,exposure:a,useHalfFloat:i,id:s},Zt(r))}else e.logger.warn("Environment map expected to be in LogLuv format.")},e.ModelEditor=Mp,e}({},THREE);